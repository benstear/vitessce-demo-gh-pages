function require(x) { throw new Error('Cannot require ' + x) }
(()=>{var bU=Object.create;var Zu=Object.defineProperty;var Ak=Object.getOwnPropertyDescriptor;var xU=Object.getOwnPropertyNames;var CU=Object.getPrototypeOf,wU=Object.prototype.hasOwnProperty;var Ik=n=>Zu(n,"__esModule",{value:!0});var $t=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),oc=(n,e)=>{Ik(n);for(var t in e)Zu(n,t,{get:e[t],enumerable:!0})},TU=(n,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of xU(e))!wU.call(n,r)&&r!=="default"&&Zu(n,r,{get:()=>e[r],enumerable:!(t=Ak(e,r))||t.enumerable});return n},at=n=>TU(Ik(Zu(n!=null?bU(CU(n)):{},"default",n&&n.__esModule&&"default"in n?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n),Lt=(n,e,t,r)=>{for(var i=r>1?void 0:r?Ak(e,t):e,a=n.length-1,o;a>=0;a--)(o=n[a])&&(i=(r?o(e,t,i):o(i))||i);return r&&i&&Zu(e,t,i),i};var Nf=$t((IJ,Fk)=>{function kU(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}Fk.exports=kU});var Wk=$t((MJ,Gk)=>{var LU=typeof window=="object"&&window&&window.Object===Object&&window;Gk.exports=LU});var pv=$t((RJ,zk)=>{var EU=Wk(),PU=typeof self=="object"&&self&&self.Object===Object&&self,DU=EU||PU||Function("return this")();zk.exports=DU});var $k=$t((_J,Hk)=>{var AU=pv(),IU=function(){return AU.Date.now()};Hk.exports=IU});var qk=$t((VJ,jk)=>{var MU=/\s/;function RU(n){for(var e=n.length;e--&&MU.test(n.charAt(e)););return e}jk.exports=RU});var Kk=$t((OJ,Jk)=>{var _U=qk(),VU=/^\s+/;function OU(n){return n&&n.slice(0,_U(n)+1).replace(VU,"")}Jk.exports=OU});var fv=$t((NJ,Yk)=>{var NU=pv(),BU=NU.Symbol;Yk.exports=BU});var eL=$t((BJ,Zk)=>{var Xk=fv(),Qk=Object.prototype,UU=Qk.hasOwnProperty,FU=Qk.toString,nd=Xk?Xk.toStringTag:void 0;function GU(n){var e=UU.call(n,nd),t=n[nd];try{n[nd]=void 0;var r=!0}catch(a){}var i=FU.call(n);return r&&(e?n[nd]=t:delete n[nd]),i}Zk.exports=GU});var nL=$t((UJ,tL)=>{var WU=Object.prototype,zU=WU.toString;function HU(n){return zU.call(n)}tL.exports=HU});var oL=$t((FJ,aL)=>{var rL=fv(),$U=eL(),jU=nL(),qU="[object Null]",JU="[object Undefined]",iL=rL?rL.toStringTag:void 0;function KU(n){return n==null?n===void 0?JU:qU:iL&&iL in Object(n)?$U(n):jU(n)}aL.exports=KU});var lL=$t((GJ,sL)=>{function YU(n){return n!=null&&typeof n=="object"}sL.exports=YU});var uL=$t((WJ,cL)=>{var XU=oL(),QU=lL(),ZU="[object Symbol]";function eF(n){return typeof n=="symbol"||QU(n)&&XU(n)==ZU}cL.exports=eF});var hL=$t((zJ,fL)=>{var tF=Kk(),dL=Nf(),nF=uL(),pL=0/0,rF=/^[-+]0x[0-9a-f]+$/i,iF=/^0b[01]+$/i,aF=/^0o[0-7]+$/i,oF=parseInt;function sF(n){if(typeof n=="number")return n;if(nF(n))return pL;if(dL(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=dL(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=tF(n);var t=iF.test(n);return t||aF.test(n)?oF(n.slice(2),t?2:8):rF.test(n)?pL:+n}fL.exports=sF});var It=$t((HJ,gL)=>{var lF=Nf(),hv=$k(),mL=hL(),cF="Expected a function",uF=Math.max,dF=Math.min;function pF(n,e,t){var r,i,a,o,l,c,d=0,p=!1,m=!1,y=!0;if(typeof n!="function")throw new TypeError(cF);e=mL(e)||0,lF(t)&&(p=!!t.leading,m="maxWait"in t,a=m?uF(mL(t.maxWait)||0,e):a,y="trailing"in t?!!t.trailing:y);function v(E){var _=r,O=i;return r=i=void 0,d=E,o=n.apply(O,_),o}function b(E){return d=E,l=setTimeout(k,e),p?v(E):o}function x(E){var _=E-c,O=E-d,B=e-_;return m?dF(B,a-O):B}function C(E){var _=E-c,O=E-d;return c===void 0||_>=e||_<0||m&&O>=a}function k(){var E=hv();if(C(E))return D(E);l=setTimeout(k,x(E))}function D(E){return l=void 0,y&&r?v(E):(r=i=void 0,o)}function P(){l!==void 0&&clearTimeout(l),d=0,r=c=i=l=void 0}function M(){return l===void 0?o:D(hv())}function I(){var E=hv(),_=C(E);if(r=arguments,i=this,c=E,_){if(l===void 0)return b(c);if(m)return clearTimeout(l),l=setTimeout(k,e),v(c)}return l===void 0&&(l=setTimeout(k,e)),o}return I.cancel=P,I.flush=M,I}gL.exports=pF});var Cp=$t((Hme,jM)=>{var Aj=It(),Ij=Nf(),Mj="Expected a function";function Rj(n,e,t){var r=!0,i=!0;if(typeof n!="function")throw new TypeError(Mj);return Ij(t)&&(r="leading"in t?!!t.leading:r,i="trailing"in t?!!t.trailing:i),Aj(n,e,{leading:r,maxWait:e,trailing:i})}jM.exports=Rj});var ms=$t((YC,XC)=>{(function(n,e){typeof YC=="object"&&typeof XC!="undefined"?XC.exports=e():typeof define=="function"&&define.amd?define(e):(n=n||self,n.CodeMirror=e())})(YC,function(){"use strict";var n=navigator.userAgent,e=navigator.platform,t=/gecko\/\d/i.test(n),r=/MSIE \d/.test(n),i=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(n),a=/Edge\/(\d+)/.exec(n),o=r||i||a,l=o&&(r?document.documentMode||6:+(a||i)[1]),c=!a&&/WebKit\//.test(n),d=c&&/Qt\/\d+\.\d+/.test(n),p=!a&&/Chrome\//.test(n),m=/Opera\//.test(n),y=/Apple Computer/.test(navigator.vendor),v=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(n),b=/PhantomJS/.test(n),x=y&&(/Mobile\/\w+/.test(n)||navigator.maxTouchPoints>2),C=/Android/.test(n),k=x||C||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(n),D=x||/Mac/.test(e),P=/\bCrOS\b/.test(n),M=/win/i.test(e),I=m&&n.match(/Version\/(\d*\.\d*)/);I&&(I=Number(I[1])),I&&I>=15&&(m=!1,c=!0);var E=D&&(d||m&&(I==null||I<12.11)),_=t||o&&l>=9;function O(s){return new RegExp("(^|\\s)"+s+"(?:$|\\s)\\s*")}var B=function(s,u){var h=s.className,f=O(u).exec(h);if(f){var g=h.slice(f.index+f[0].length);s.className=h.slice(0,f.index)+(g?f[1]+g:"")}};function W(s){for(var u=s.childNodes.length;u>0;--u)s.removeChild(s.firstChild);return s}function V(s,u){return W(s).appendChild(u)}function U(s,u,h,f){var g=document.createElement(s);if(h&&(g.className=h),f&&(g.style.cssText=f),typeof u=="string")g.appendChild(document.createTextNode(u));else if(u)for(var S=0;S<u.length;++S)g.appendChild(u[S]);return g}function N(s,u,h,f){var g=U(s,u,h,f);return g.setAttribute("role","presentation"),g}var q;document.createRange?q=function(s,u,h,f){var g=document.createRange();return g.setEnd(f||s,h),g.setStart(s,u),g}:q=function(s,u,h){var f=document.body.createTextRange();try{f.moveToElementText(s.parentNode)}catch(g){return f}return f.collapse(!0),f.moveEnd("character",h),f.moveStart("character",u),f};function ne(s,u){if(u.nodeType==3&&(u=u.parentNode),s.contains)return s.contains(u);do if(u.nodeType==11&&(u=u.host),u==s)return!0;while(u=u.parentNode)}function pe(){var s;try{s=document.activeElement}catch(u){s=document.body||null}for(;s&&s.shadowRoot&&s.shadowRoot.activeElement;)s=s.shadowRoot.activeElement;return s}function me(s,u){var h=s.className;O(u).test(h)||(s.className+=(h?" ":"")+u)}function Pe(s,u){for(var h=s.split(" "),f=0;f<h.length;f++)h[f]&&!O(h[f]).test(u)&&(u+=" "+h[f]);return u}var se=function(s){s.select()};x?se=function(s){s.selectionStart=0,s.selectionEnd=s.value.length}:o&&(se=function(s){try{s.select()}catch(u){}});function Te(s){var u=Array.prototype.slice.call(arguments,1);return function(){return s.apply(null,u)}}function Ae(s,u,h){u||(u={});for(var f in s)s.hasOwnProperty(f)&&(h!==!1||!u.hasOwnProperty(f))&&(u[f]=s[f]);return u}function Be(s,u,h,f,g){u==null&&(u=s.search(/[^\s\u00a0]/),u==-1&&(u=s.length));for(var S=f||0,w=g||0;;){var T=s.indexOf("	",S);if(T<0||T>=u)return w+(u-S);w+=T-S,w+=h-w%h,S=T+1}}var Ze=function(){this.id=null,this.f=null,this.time=0,this.handler=Te(this.onTimeout,this)};Ze.prototype.onTimeout=function(s){s.id=0,s.time<=+new Date?s.f():setTimeout(s.handler,s.time-+new Date)},Ze.prototype.set=function(s,u){this.f=u;var h=+new Date+s;(!this.id||h<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,s),this.time=h)};function ge(s,u){for(var h=0;h<s.length;++h)if(s[h]==u)return h;return-1}var Le=50,We={toString:function(){return"CodeMirror.Pass"}},je={scroll:!1},et={origin:"*mouse"},Ie={origin:"+move"};function lt(s,u,h){for(var f=0,g=0;;){var S=s.indexOf("	",f);S==-1&&(S=s.length);var w=S-f;if(S==s.length||g+w>=u)return f+Math.min(w,u-g);if(g+=S-f,g+=h-g%h,f=S+1,g>=u)return f}}var Zn=[""];function ea(s){for(;Zn.length<=s;)Zn.push(tt(Zn)+" ");return Zn[s]}function tt(s){return s[s.length-1]}function Er(s,u){for(var h=[],f=0;f<s.length;f++)h[f]=u(s[f],f);return h}function ta(s,u,h){for(var f=0,g=h(u);f<s.length&&h(s[f])<=g;)f++;s.splice(f,0,u)}function na(){}function ra(s,u){var h;return Object.create?h=Object.create(s):(na.prototype=s,h=new na),u&&Ae(u,h),h}var ia=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function ai(s){return/\w/.test(s)||s>"\x80"&&(s.toUpperCase()!=s.toLowerCase()||ia.test(s))}function ki(s,u){return u?u.source.indexOf("\\w")>-1&&ai(s)?!0:u.test(s):ai(s)}function za(s){for(var u in s)if(s.hasOwnProperty(u)&&s[u])return!1;return!0}var Eo=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function _l(s){return s.charCodeAt(0)>=768&&Eo.test(s)}function Po(s,u,h){for(;(h<0?u>0:u<s.length)&&_l(s.charAt(u));)u+=h;return u}function Bn(s,u,h){for(var f=u>h?-1:1;;){if(u==h)return u;var g=(u+h)/2,S=f<0?Math.ceil(g):Math.floor(g);if(S==u)return s(S)?u:h;s(S)?h=S:u=S+f}}function yu(s,u,h,f){if(!s)return f(u,h,"ltr",0);for(var g=!1,S=0;S<s.length;++S){var w=s[S];(w.from<h&&w.to>u||u==h&&w.to==u)&&(f(Math.max(w.from,u),Math.min(w.to,h),w.level==1?"rtl":"ltr",S),g=!0)}g||f(u,h,"ltr")}var ur=null;function kt(s,u,h){var f;ur=null;for(var g=0;g<s.length;++g){var S=s[g];if(S.from<u&&S.to>u)return g;S.to==u&&(S.from!=S.to&&h=="before"?f=g:ur=g),S.from==u&&(S.from!=S.to&&h!="before"?f=g:ur=g)}return f!=null?f:ur}var Ls=function(){var s="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",u="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";function h(A){return A<=247?s.charAt(A):1424<=A&&A<=1524?"R":1536<=A&&A<=1785?u.charAt(A-1536):1774<=A&&A<=2220?"r":8192<=A&&A<=8203?"w":A==8204?"b":"L"}var f=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,g=/[stwN]/,S=/[LRr]/,w=/[Lb1n]/,T=/[1n]/;function L(A,F,z){this.level=A,this.from=F,this.to=z}return function(A,F){var z=F=="ltr"?"L":"R";if(A.length==0||F=="ltr"&&!f.test(A))return!1;for(var Y=A.length,K=[],Z=0;Z<Y;++Z)K.push(h(A.charCodeAt(Z)));for(var ie=0,de=z;ie<Y;++ie){var fe=K[ie];fe=="m"?K[ie]=de:de=fe}for(var Se=0,he=z;Se<Y;++Se){var xe=K[Se];xe=="1"&&he=="r"?K[Se]="n":S.test(xe)&&(he=xe,xe=="r"&&(K[Se]="R"))}for(var De=1,Ee=K[0];De<Y-1;++De){var Ke=K[De];Ke=="+"&&Ee=="1"&&K[De+1]=="1"?K[De]="1":Ke==","&&Ee==K[De+1]&&(Ee=="1"||Ee=="n")&&(K[De]=Ee),Ee=Ke}for(var Ct=0;Ct<Y;++Ct){var pn=K[Ct];if(pn==",")K[Ct]="N";else if(pn=="%"){var Ot=void 0;for(Ot=Ct+1;Ot<Y&&K[Ot]=="%";++Ot);for(var Ir=Ct&&K[Ct-1]=="!"||Ot<Y&&K[Ot]=="1"?"1":"N",mr=Ct;mr<Ot;++mr)K[mr]=Ir;Ct=Ot-1}}for(var Yt=0,gr=z;Yt<Y;++Yt){var Ln=K[Yt];gr=="L"&&Ln=="1"?K[Yt]="L":S.test(Ln)&&(gr=Ln)}for(var tn=0;tn<Y;++tn)if(g.test(K[tn])){var Xt=void 0;for(Xt=tn+1;Xt<Y&&g.test(K[Xt]);++Xt);for(var Ut=(tn?K[tn-1]:z)=="L",yr=(Xt<Y?K[Xt]:z)=="L",ic=Ut==yr?Ut?"L":"R":z,Uo=tn;Uo<Xt;++Uo)K[Uo]=ic;tn=Xt-1}for(var Wn=[],fa,fn=0;fn<Y;)if(w.test(K[fn])){var cv=fn;for(++fn;fn<Y&&w.test(K[fn]);++fn);Wn.push(new L(0,cv,fn))}else{var Ya=fn,Ns=Wn.length,Bs=F=="rtl"?1:0;for(++fn;fn<Y&&K[fn]!="L";++fn);for(var tr=Ya;tr<fn;)if(T.test(K[tr])){Ya<tr&&(Wn.splice(Ns,0,new L(1,Ya,tr)),Ns+=Bs);var ac=tr;for(++tr;tr<fn&&T.test(K[tr]);++tr);Wn.splice(Ns,0,new L(2,ac,tr)),Ns+=Bs,Ya=tr}else++tr;Ya<fn&&Wn.splice(Ns,0,new L(1,Ya,fn))}return F=="ltr"&&(Wn[0].level==1&&(fa=A.match(/^\s+/))&&(Wn[0].from=fa[0].length,Wn.unshift(new L(0,0,fa[0].length))),tt(Wn).level==1&&(fa=A.match(/\s+$/))&&(tt(Wn).to-=fa[0].length,Wn.push(new L(0,Y-fa[0].length,Y)))),F=="rtl"?Wn.reverse():Wn}}();function Pr(s,u){var h=s.order;return h==null&&(h=s.order=Ls(s.text,u)),h}var Ha=[],Ve=function(s,u,h){if(s.addEventListener)s.addEventListener(u,h,!1);else if(s.attachEvent)s.attachEvent("on"+u,h);else{var f=s._handlers||(s._handlers={});f[u]=(f[u]||Ha).concat(h)}};function Vl(s,u){return s._handlers&&s._handlers[u]||Ha}function dr(s,u,h){if(s.removeEventListener)s.removeEventListener(u,h,!1);else if(s.detachEvent)s.detachEvent("on"+u,h);else{var f=s._handlers,g=f&&f[u];if(g){var S=ge(g,h);S>-1&&(f[u]=g.slice(0,S).concat(g.slice(S+1)))}}}function Ue(s,u){var h=Vl(s,u);if(!!h.length)for(var f=Array.prototype.slice.call(arguments,2),g=0;g<h.length;++g)h[g].apply(null,f)}function Kt(s,u,h){return typeof u=="string"&&(u={type:u,preventDefault:function(){this.defaultPrevented=!0}}),Ue(s,h||u.type,s,u),Gr(u)||u.codemirrorIgnore}function Ol(s){var u=s._handlers&&s._handlers.cursorActivity;if(!!u)for(var h=s.curOp.cursorActivityHandlers||(s.curOp.cursorActivityHandlers=[]),f=0;f<u.length;++f)ge(h,u[f])==-1&&h.push(u[f])}function kn(s,u){return Vl(s,u).length>0}function aa(s){s.prototype.on=function(u,h){Ve(this,u,h)},s.prototype.off=function(u,h){dr(this,u,h)}}function Un(s){s.preventDefault?s.preventDefault():s.returnValue=!1}function Nl(s){s.stopPropagation?s.stopPropagation():s.cancelBubble=!0}function Gr(s){return s.defaultPrevented!=null?s.defaultPrevented:s.returnValue==!1}function Es(s){Un(s),Nl(s)}function Do(s){return s.target||s.srcElement}function nf(s){var u=s.which;return u==null&&(s.button&1?u=1:s.button&2?u=3:s.button&4&&(u=2)),D&&s.ctrlKey&&u==1&&(u=3),u}var vu=function(){if(o&&l<9)return!1;var s=U("div");return"draggable"in s||"dragDrop"in s}(),pr;function rf(s){if(pr==null){var u=U("span","\u200B");V(s,U("span",[u,document.createTextNode("x")])),s.firstChild.offsetHeight!=0&&(pr=u.offsetWidth<=1&&u.offsetHeight>2&&!(o&&l<8))}var h=pr?U("span","\u200B"):U("span","\xA0",null,"display: inline-block; width: 1px; margin-right: -1px");return h.setAttribute("cm-text",""),h}var Su;function oa(s){if(Su!=null)return Su;var u=V(s,document.createTextNode("A\u062EA")),h=q(u,0,1).getBoundingClientRect(),f=q(u,1,2).getBoundingClientRect();return W(s),!h||h.left==h.right?!1:Su=f.right-h.right<3}var bu=`

b`.split(/\n/).length!=3?function(s){for(var u=0,h=[],f=s.length;u<=f;){var g=s.indexOf(`
`,u);g==-1&&(g=s.length);var S=s.slice(u,s.charAt(g-1)=="\r"?g-1:g),w=S.indexOf("\r");w!=-1?(h.push(S.slice(0,w)),u+=w+1):(h.push(S),u=g+1)}return h}:function(s){return s.split(/\r\n?|\n/)},af=window.getSelection?function(s){try{return s.selectionStart!=s.selectionEnd}catch(u){return!1}}:function(s){var u;try{u=s.ownerDocument.selection.createRange()}catch(h){}return!u||u.parentElement()!=s?!1:u.compareEndPoints("StartToEnd",u)!=0},of=function(){var s=U("div");return"oncopy"in s?!0:(s.setAttribute("oncopy","return;"),typeof s.oncopy=="function")}(),xu=null;function Ao(s){if(xu!=null)return xu;var u=V(s,U("span","x")),h=u.getBoundingClientRect(),f=q(u,0,1).getBoundingClientRect();return xu=Math.abs(h.left-f.left)>1}var oi={},Wr={};function sf(s,u){arguments.length>2&&(u.dependencies=Array.prototype.slice.call(arguments,2)),oi[s]=u}function $a(s,u){Wr[s]=u}function Bl(s){if(typeof s=="string"&&Wr.hasOwnProperty(s))s=Wr[s];else if(s&&typeof s.name=="string"&&Wr.hasOwnProperty(s.name)){var u=Wr[s.name];typeof u=="string"&&(u={name:u}),s=ra(u,s),s.name=u.name}else{if(typeof s=="string"&&/^[\w\-]+\/[\w\-]+\+xml$/.test(s))return Bl("application/xml");if(typeof s=="string"&&/^[\w\-]+\/[\w\-]+\+json$/.test(s))return Bl("application/json")}return typeof s=="string"?{name:s}:s||{name:"null"}}function Ul(s,u){u=Bl(u);var h=oi[u.name];if(!h)return Ul(s,"text/plain");var f=h(s,u);if(Li.hasOwnProperty(u.name)){var g=Li[u.name];for(var S in g)!g.hasOwnProperty(S)||(f.hasOwnProperty(S)&&(f["_"+S]=f[S]),f[S]=g[S])}if(f.name=u.name,u.helperType&&(f.helperType=u.helperType),u.modeProps)for(var w in u.modeProps)f[w]=u.modeProps[w];return f}var Li={};function Ei(s,u){var h=Li.hasOwnProperty(s)?Li[s]:Li[s]={};Ae(u,h)}function zr(s,u){if(u===!0)return u;if(s.copyState)return s.copyState(u);var h={};for(var f in u){var g=u[f];g instanceof Array&&(g=g.concat([])),h[f]=g}return h}function Cu(s,u){for(var h;s.innerMode&&(h=s.innerMode(u),!(!h||h.mode==s));)u=h.state,s=h.mode;return h||{mode:s,state:u}}function wu(s,u,h){return s.startState?s.startState(u,h):!0}var Bt=function(s,u,h){this.pos=this.start=0,this.string=s,this.tabSize=u||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=h};Bt.prototype.eol=function(){return this.pos>=this.string.length},Bt.prototype.sol=function(){return this.pos==this.lineStart},Bt.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},Bt.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},Bt.prototype.eat=function(s){var u=this.string.charAt(this.pos),h;if(typeof s=="string"?h=u==s:h=u&&(s.test?s.test(u):s(u)),h)return++this.pos,u},Bt.prototype.eatWhile=function(s){for(var u=this.pos;this.eat(s););return this.pos>u},Bt.prototype.eatSpace=function(){for(var s=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>s},Bt.prototype.skipToEnd=function(){this.pos=this.string.length},Bt.prototype.skipTo=function(s){var u=this.string.indexOf(s,this.pos);if(u>-1)return this.pos=u,!0},Bt.prototype.backUp=function(s){this.pos-=s},Bt.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=Be(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?Be(this.string,this.lineStart,this.tabSize):0)},Bt.prototype.indentation=function(){return Be(this.string,null,this.tabSize)-(this.lineStart?Be(this.string,this.lineStart,this.tabSize):0)},Bt.prototype.match=function(s,u,h){if(typeof s=="string"){var f=function(w){return h?w.toLowerCase():w},g=this.string.substr(this.pos,s.length);if(f(g)==f(s))return u!==!1&&(this.pos+=s.length),!0}else{var S=this.string.slice(this.pos).match(s);return S&&S.index>0?null:(S&&u!==!1&&(this.pos+=S[0].length),S)}},Bt.prototype.current=function(){return this.string.slice(this.start,this.pos)},Bt.prototype.hideFirstChars=function(s,u){this.lineStart+=s;try{return u()}finally{this.lineStart-=s}},Bt.prototype.lookAhead=function(s){var u=this.lineOracle;return u&&u.lookAhead(s)},Bt.prototype.baseToken=function(){var s=this.lineOracle;return s&&s.baseToken(this.pos)};function ke(s,u){if(u-=s.first,u<0||u>=s.size)throw new Error("There is no line "+(u+s.first)+" in the document.");for(var h=s;!h.lines;)for(var f=0;;++f){var g=h.children[f],S=g.chunkSize();if(u<S){h=g;break}u-=S}return h.lines[u]}function sa(s,u,h){var f=[],g=u.line;return s.iter(u.line,h.line+1,function(S){var w=S.text;g==h.line&&(w=w.slice(0,h.ch)),g==u.line&&(w=w.slice(u.ch)),f.push(w),++g}),f}function Tu(s,u,h){var f=[];return s.iter(u,h,function(g){f.push(g.text)}),f}function Dr(s,u){var h=u-s.height;if(h)for(var f=s;f;f=f.parent)f.height+=h}function pt(s){if(s.parent==null)return null;for(var u=s.parent,h=ge(u.lines,s),f=u.parent;f;u=f,f=f.parent)for(var g=0;f.children[g]!=u;++g)h+=f.children[g].chunkSize();return h+u.first}function la(s,u){var h=s.first;e:do{for(var f=0;f<s.children.length;++f){var g=s.children[f],S=g.height;if(u<S){s=g;continue e}u-=S,h+=g.chunkSize()}return h}while(!s.lines);for(var w=0;w<s.lines.length;++w){var T=s.lines[w],L=T.height;if(u<L)break;u-=L}return h+w}function Ps(s,u){return u>=s.first&&u<s.first+s.size}function ku(s,u){return String(s.lineNumberFormatter(u+s.firstLineNumber))}function oe(s,u,h){if(h===void 0&&(h=null),!(this instanceof oe))return new oe(s,u,h);this.line=s,this.ch=u,this.sticky=h}function R(s,u){return s.line-u.line||s.ch-u.ch}function $(s,u){return s.sticky==u.sticky&&R(s,u)==0}function te(s){return oe(s.line,s.ch)}function ue(s,u){return R(s,u)<0?u:s}function Fe(s,u){return R(s,u)<0?s:u}function it(s,u){return Math.max(s.first,Math.min(u,s.first+s.size-1))}function ve(s,u){if(u.line<s.first)return oe(s.first,0);var h=s.first+s.size-1;return u.line>h?oe(h,ke(s,h).text.length):Fn(u,ke(s,u.line).text.length)}function Fn(s,u){var h=s.ch;return h==null||h>u?oe(s.line,u):h<0?oe(s.line,0):s}function Hr(s,u){for(var h=[],f=0;f<u.length;f++)h[f]=ve(s,u[f]);return h}var Fl=function(s,u){this.state=s,this.lookAhead=u},ca=function(s,u,h,f){this.state=u,this.doc=s,this.line=h,this.maxLookAhead=f||0,this.baseTokens=null,this.baseTokenPos=1};ca.prototype.lookAhead=function(s){var u=this.doc.getLine(this.line+s);return u!=null&&s>this.maxLookAhead&&(this.maxLookAhead=s),u},ca.prototype.baseToken=function(s){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=s;)this.baseTokenPos+=2;var u=this.baseTokens[this.baseTokenPos+1];return{type:u&&u.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-s}},ca.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},ca.fromSaved=function(s,u,h){return u instanceof Fl?new ca(s,zr(s.mode,u.state),h,u.lookAhead):new ca(s,zr(s.mode,u),h)},ca.prototype.save=function(s){var u=s!==!1?zr(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new Fl(u,this.maxLookAhead):u};function I0(s,u,h,f){var g=[s.state.modeGen],S={};N0(s,u.text,s.doc.mode,h,function(A,F){return g.push(A,F)},S,f);for(var w=h.state,T=function(A){h.baseTokens=g;var F=s.state.overlays[A],z=1,Y=0;h.state=!0,N0(s,u.text,F.mode,h,function(K,Z){for(var ie=z;Y<K;){var de=g[z];de>K&&g.splice(z,1,K,g[z+1],de),z+=2,Y=Math.min(K,de)}if(!!Z)if(F.opaque)g.splice(ie,z-ie,K,"overlay "+Z),z=ie+2;else for(;ie<z;ie+=2){var fe=g[ie+1];g[ie+1]=(fe?fe+" ":"")+"overlay "+Z}},S),h.state=w,h.baseTokens=null,h.baseTokenPos=1},L=0;L<s.state.overlays.length;++L)T(L);return{styles:g,classes:S.bgClass||S.textClass?S:null}}function M0(s,u,h){if(!u.styles||u.styles[0]!=s.state.modeGen){var f=Lu(s,pt(u)),g=u.text.length>s.options.maxHighlightLength&&zr(s.doc.mode,f.state),S=I0(s,u,f);g&&(f.state=g),u.stateAfter=f.save(!g),u.styles=S.styles,S.classes?u.styleClasses=S.classes:u.styleClasses&&(u.styleClasses=null),h===s.doc.highlightFrontier&&(s.doc.modeFrontier=Math.max(s.doc.modeFrontier,++s.doc.highlightFrontier))}return u.styles}function Lu(s,u,h){var f=s.doc,g=s.display;if(!f.mode.startState)return new ca(f,!0,u);var S=CN(s,u,h),w=S>f.first&&ke(f,S-1).stateAfter,T=w?ca.fromSaved(f,w,S):new ca(f,wu(f.mode),S);return f.iter(S,u,function(L){Sy(s,L.text,T);var A=T.line;L.stateAfter=A==u-1||A%5==0||A>=g.viewFrom&&A<g.viewTo?T.save():null,T.nextLine()}),h&&(f.modeFrontier=T.line),T}function Sy(s,u,h,f){var g=s.doc.mode,S=new Bt(u,s.options.tabSize,h);for(S.start=S.pos=f||0,u==""&&R0(g,h.state);!S.eol();)by(g,S,h.state),S.start=S.pos}function R0(s,u){if(s.blankLine)return s.blankLine(u);if(!!s.innerMode){var h=Cu(s,u);if(h.mode.blankLine)return h.mode.blankLine(h.state)}}function by(s,u,h,f){for(var g=0;g<10;g++){f&&(f[0]=Cu(s,h).mode);var S=s.token(u,h);if(u.pos>u.start)return S}throw new Error("Mode "+s.name+" failed to advance stream.")}var _0=function(s,u,h){this.start=s.start,this.end=s.pos,this.string=s.current(),this.type=u||null,this.state=h};function V0(s,u,h,f){var g=s.doc,S=g.mode,w;u=ve(g,u);var T=ke(g,u.line),L=Lu(s,u.line,h),A=new Bt(T.text,s.options.tabSize,L),F;for(f&&(F=[]);(f||A.pos<u.ch)&&!A.eol();)A.start=A.pos,w=by(S,A,L.state),f&&F.push(new _0(A,w,zr(g.mode,L.state)));return f?F:new _0(A,w,L.state)}function O0(s,u){if(s)for(;;){var h=s.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!h)break;s=s.slice(0,h.index)+s.slice(h.index+h[0].length);var f=h[1]?"bgClass":"textClass";u[f]==null?u[f]=h[2]:new RegExp("(?:^|\\s)"+h[2]+"(?:$|\\s)").test(u[f])||(u[f]+=" "+h[2])}return s}function N0(s,u,h,f,g,S,w){var T=h.flattenSpans;T==null&&(T=s.options.flattenSpans);var L=0,A=null,F=new Bt(u,s.options.tabSize,f),z,Y=s.options.addModeClass&&[null];for(u==""&&O0(R0(h,f.state),S);!F.eol();){if(F.pos>s.options.maxHighlightLength?(T=!1,w&&Sy(s,u,f,F.pos),F.pos=u.length,z=null):z=O0(by(h,F,f.state,Y),S),Y){var K=Y[0].name;K&&(z="m-"+(z?K+" "+z:K))}if(!T||A!=z){for(;L<F.start;)L=Math.min(F.start,L+5e3),g(L,A);A=z}F.start=F.pos}for(;L<F.pos;){var Z=Math.min(F.pos,L+5e3);g(Z,A),L=Z}}function CN(s,u,h){for(var f,g,S=s.doc,w=h?-1:u-(s.doc.mode.innerMode?1e3:100),T=u;T>w;--T){if(T<=S.first)return S.first;var L=ke(S,T-1),A=L.stateAfter;if(A&&(!h||T+(A instanceof Fl?A.lookAhead:0)<=S.modeFrontier))return T;var F=Be(L.text,null,s.options.tabSize);(g==null||f>F)&&(g=T-1,f=F)}return g}function wN(s,u){if(s.modeFrontier=Math.min(s.modeFrontier,u),!(s.highlightFrontier<u-10)){for(var h=s.first,f=u-1;f>h;f--){var g=ke(s,f).stateAfter;if(g&&(!(g instanceof Fl)||f+g.lookAhead<u)){h=f+1;break}}s.highlightFrontier=Math.min(s.highlightFrontier,h)}}var B0=!1,ja=!1;function TN(){B0=!0}function kN(){ja=!0}function lf(s,u,h){this.marker=s,this.from=u,this.to=h}function Eu(s,u){if(s)for(var h=0;h<s.length;++h){var f=s[h];if(f.marker==u)return f}}function LN(s,u){for(var h,f=0;f<s.length;++f)s[f]!=u&&(h||(h=[])).push(s[f]);return h}function EN(s,u,h){var f=h&&window.WeakSet&&(h.markedSpans||(h.markedSpans=new WeakSet));f&&f.has(s.markedSpans)?s.markedSpans.push(u):(s.markedSpans=s.markedSpans?s.markedSpans.concat([u]):[u],f&&f.add(s.markedSpans)),u.marker.attachLine(s)}function PN(s,u,h){var f;if(s)for(var g=0;g<s.length;++g){var S=s[g],w=S.marker,T=S.from==null||(w.inclusiveLeft?S.from<=u:S.from<u);if(T||S.from==u&&w.type=="bookmark"&&(!h||!S.marker.insertLeft)){var L=S.to==null||(w.inclusiveRight?S.to>=u:S.to>u);(f||(f=[])).push(new lf(w,S.from,L?null:S.to))}}return f}function DN(s,u,h){var f;if(s)for(var g=0;g<s.length;++g){var S=s[g],w=S.marker,T=S.to==null||(w.inclusiveRight?S.to>=u:S.to>u);if(T||S.from==u&&w.type=="bookmark"&&(!h||S.marker.insertLeft)){var L=S.from==null||(w.inclusiveLeft?S.from<=u:S.from<u);(f||(f=[])).push(new lf(w,L?null:S.from-u,S.to==null?null:S.to-u))}}return f}function xy(s,u){if(u.full)return null;var h=Ps(s,u.from.line)&&ke(s,u.from.line).markedSpans,f=Ps(s,u.to.line)&&ke(s,u.to.line).markedSpans;if(!h&&!f)return null;var g=u.from.ch,S=u.to.ch,w=R(u.from,u.to)==0,T=PN(h,g,w),L=DN(f,S,w),A=u.text.length==1,F=tt(u.text).length+(A?g:0);if(T)for(var z=0;z<T.length;++z){var Y=T[z];if(Y.to==null){var K=Eu(L,Y.marker);K?A&&(Y.to=K.to==null?null:K.to+F):Y.to=g}}if(L)for(var Z=0;Z<L.length;++Z){var ie=L[Z];if(ie.to!=null&&(ie.to+=F),ie.from==null){var de=Eu(T,ie.marker);de||(ie.from=F,A&&(T||(T=[])).push(ie))}else ie.from+=F,A&&(T||(T=[])).push(ie)}T&&(T=U0(T)),L&&L!=T&&(L=U0(L));var fe=[T];if(!A){var Se=u.text.length-2,he;if(Se>0&&T)for(var xe=0;xe<T.length;++xe)T[xe].to==null&&(he||(he=[])).push(new lf(T[xe].marker,null,null));for(var De=0;De<Se;++De)fe.push(he);fe.push(L)}return fe}function U0(s){for(var u=0;u<s.length;++u){var h=s[u];h.from!=null&&h.from==h.to&&h.marker.clearWhenEmpty!==!1&&s.splice(u--,1)}return s.length?s:null}function AN(s,u,h){var f=null;if(s.iter(u.line,h.line+1,function(K){if(K.markedSpans)for(var Z=0;Z<K.markedSpans.length;++Z){var ie=K.markedSpans[Z].marker;ie.readOnly&&(!f||ge(f,ie)==-1)&&(f||(f=[])).push(ie)}}),!f)return null;for(var g=[{from:u,to:h}],S=0;S<f.length;++S)for(var w=f[S],T=w.find(0),L=0;L<g.length;++L){var A=g[L];if(!(R(A.to,T.from)<0||R(A.from,T.to)>0)){var F=[L,1],z=R(A.from,T.from),Y=R(A.to,T.to);(z<0||!w.inclusiveLeft&&!z)&&F.push({from:A.from,to:T.from}),(Y>0||!w.inclusiveRight&&!Y)&&F.push({from:T.to,to:A.to}),g.splice.apply(g,F),L+=F.length-3}}return g}function F0(s){var u=s.markedSpans;if(!!u){for(var h=0;h<u.length;++h)u[h].marker.detachLine(s);s.markedSpans=null}}function G0(s,u){if(!!u){for(var h=0;h<u.length;++h)u[h].marker.attachLine(s);s.markedSpans=u}}function cf(s){return s.inclusiveLeft?-1:0}function uf(s){return s.inclusiveRight?1:0}function Cy(s,u){var h=s.lines.length-u.lines.length;if(h!=0)return h;var f=s.find(),g=u.find(),S=R(f.from,g.from)||cf(s)-cf(u);if(S)return-S;var w=R(f.to,g.to)||uf(s)-uf(u);return w||u.id-s.id}function W0(s,u){var h=ja&&s.markedSpans,f;if(h)for(var g=void 0,S=0;S<h.length;++S)g=h[S],g.marker.collapsed&&(u?g.from:g.to)==null&&(!f||Cy(f,g.marker)<0)&&(f=g.marker);return f}function z0(s){return W0(s,!0)}function df(s){return W0(s,!1)}function IN(s,u){var h=ja&&s.markedSpans,f;if(h)for(var g=0;g<h.length;++g){var S=h[g];S.marker.collapsed&&(S.from==null||S.from<u)&&(S.to==null||S.to>u)&&(!f||Cy(f,S.marker)<0)&&(f=S.marker)}return f}function H0(s,u,h,f,g){var S=ke(s,u),w=ja&&S.markedSpans;if(w)for(var T=0;T<w.length;++T){var L=w[T];if(!!L.marker.collapsed){var A=L.marker.find(0),F=R(A.from,h)||cf(L.marker)-cf(g),z=R(A.to,f)||uf(L.marker)-uf(g);if(!(F>=0&&z<=0||F<=0&&z>=0)&&(F<=0&&(L.marker.inclusiveRight&&g.inclusiveLeft?R(A.to,h)>=0:R(A.to,h)>0)||F>=0&&(L.marker.inclusiveRight&&g.inclusiveLeft?R(A.from,f)<=0:R(A.from,f)<0)))return!0}}}function ua(s){for(var u;u=z0(s);)s=u.find(-1,!0).line;return s}function MN(s){for(var u;u=df(s);)s=u.find(1,!0).line;return s}function RN(s){for(var u,h;u=df(s);)s=u.find(1,!0).line,(h||(h=[])).push(s);return h}function wy(s,u){var h=ke(s,u),f=ua(h);return h==f?u:pt(f)}function $0(s,u){if(u>s.lastLine())return u;var h=ke(s,u),f;if(!Io(s,h))return u;for(;f=df(h);)h=f.find(1,!0).line;return pt(h)+1}function Io(s,u){var h=ja&&u.markedSpans;if(h){for(var f=void 0,g=0;g<h.length;++g)if(f=h[g],!!f.marker.collapsed){if(f.from==null)return!0;if(!f.marker.widgetNode&&f.from==0&&f.marker.inclusiveLeft&&Ty(s,u,f))return!0}}}function Ty(s,u,h){if(h.to==null){var f=h.marker.find(1,!0);return Ty(s,f.line,Eu(f.line.markedSpans,h.marker))}if(h.marker.inclusiveRight&&h.to==u.text.length)return!0;for(var g=void 0,S=0;S<u.markedSpans.length;++S)if(g=u.markedSpans[S],g.marker.collapsed&&!g.marker.widgetNode&&g.from==h.to&&(g.to==null||g.to!=h.from)&&(g.marker.inclusiveLeft||h.marker.inclusiveRight)&&Ty(s,u,g))return!0}function qa(s){s=ua(s);for(var u=0,h=s.parent,f=0;f<h.lines.length;++f){var g=h.lines[f];if(g==s)break;u+=g.height}for(var S=h.parent;S;h=S,S=h.parent)for(var w=0;w<S.children.length;++w){var T=S.children[w];if(T==h)break;u+=T.height}return u}function pf(s){if(s.height==0)return 0;for(var u=s.text.length,h,f=s;h=z0(f);){var g=h.find(0,!0);f=g.from.line,u+=g.from.ch-g.to.ch}for(f=s;h=df(f);){var S=h.find(0,!0);u-=f.text.length-S.from.ch,f=S.to.line,u+=f.text.length-S.to.ch}return u}function ky(s){var u=s.display,h=s.doc;u.maxLine=ke(h,h.first),u.maxLineLength=pf(u.maxLine),u.maxLineChanged=!0,h.iter(function(f){var g=pf(f);g>u.maxLineLength&&(u.maxLineLength=g,u.maxLine=f)})}var Gl=function(s,u,h){this.text=s,G0(this,u),this.height=h?h(this):1};Gl.prototype.lineNo=function(){return pt(this)},aa(Gl);function _N(s,u,h,f){s.text=u,s.stateAfter&&(s.stateAfter=null),s.styles&&(s.styles=null),s.order!=null&&(s.order=null),F0(s),G0(s,h);var g=f?f(s):1;g!=s.height&&Dr(s,g)}function VN(s){s.parent=null,F0(s)}var ON={},NN={};function j0(s,u){if(!s||/^\s*$/.test(s))return null;var h=u.addModeClass?NN:ON;return h[s]||(h[s]=s.replace(/\S+/g,"cm-$&"))}function q0(s,u){var h=N("span",null,null,c?"padding-right: .1px":null),f={pre:N("pre",[h],"CodeMirror-line"),content:h,col:0,pos:0,cm:s,trailingSpace:!1,splitSpaces:s.getOption("lineWrapping")};u.measure={};for(var g=0;g<=(u.rest?u.rest.length:0);g++){var S=g?u.rest[g-1]:u.line,w=void 0;f.pos=0,f.addToken=UN,oa(s.display.measure)&&(w=Pr(S,s.doc.direction))&&(f.addToken=GN(f.addToken,w)),f.map=[];var T=u!=s.display.externalMeasured&&pt(S);WN(S,f,M0(s,S,T)),S.styleClasses&&(S.styleClasses.bgClass&&(f.bgClass=Pe(S.styleClasses.bgClass,f.bgClass||"")),S.styleClasses.textClass&&(f.textClass=Pe(S.styleClasses.textClass,f.textClass||""))),f.map.length==0&&f.map.push(0,0,f.content.appendChild(rf(s.display.measure))),g==0?(u.measure.map=f.map,u.measure.cache={}):((u.measure.maps||(u.measure.maps=[])).push(f.map),(u.measure.caches||(u.measure.caches=[])).push({}))}if(c){var L=f.content.lastChild;(/\bcm-tab\b/.test(L.className)||L.querySelector&&L.querySelector(".cm-tab"))&&(f.content.className="cm-tab-wrap-hack")}return Ue(s,"renderLine",s,u.line,f.pre),f.pre.className&&(f.textClass=Pe(f.pre.className,f.textClass||"")),f}function BN(s){var u=U("span","\u2022","cm-invalidchar");return u.title="\\u"+s.charCodeAt(0).toString(16),u.setAttribute("aria-label",u.title),u}function UN(s,u,h,f,g,S,w){if(!!u){var T=s.splitSpaces?FN(u,s.trailingSpace):u,L=s.cm.state.specialChars,A=!1,F;if(!L.test(u))s.col+=u.length,F=document.createTextNode(T),s.map.push(s.pos,s.pos+u.length,F),o&&l<9&&(A=!0),s.pos+=u.length;else{F=document.createDocumentFragment();for(var z=0;;){L.lastIndex=z;var Y=L.exec(u),K=Y?Y.index-z:u.length-z;if(K){var Z=document.createTextNode(T.slice(z,z+K));o&&l<9?F.appendChild(U("span",[Z])):F.appendChild(Z),s.map.push(s.pos,s.pos+K,Z),s.col+=K,s.pos+=K}if(!Y)break;z+=K+1;var ie=void 0;if(Y[0]=="	"){var de=s.cm.options.tabSize,fe=de-s.col%de;ie=F.appendChild(U("span",ea(fe),"cm-tab")),ie.setAttribute("role","presentation"),ie.setAttribute("cm-text","	"),s.col+=fe}else Y[0]=="\r"||Y[0]==`
`?(ie=F.appendChild(U("span",Y[0]=="\r"?"\u240D":"\u2424","cm-invalidchar")),ie.setAttribute("cm-text",Y[0]),s.col+=1):(ie=s.cm.options.specialCharPlaceholder(Y[0]),ie.setAttribute("cm-text",Y[0]),o&&l<9?F.appendChild(U("span",[ie])):F.appendChild(ie),s.col+=1);s.map.push(s.pos,s.pos+1,ie),s.pos++}}if(s.trailingSpace=T.charCodeAt(u.length-1)==32,h||f||g||A||S||w){var Se=h||"";f&&(Se+=f),g&&(Se+=g);var he=U("span",[F],Se,S);if(w)for(var xe in w)w.hasOwnProperty(xe)&&xe!="style"&&xe!="class"&&he.setAttribute(xe,w[xe]);return s.content.appendChild(he)}s.content.appendChild(F)}}function FN(s,u){if(s.length>1&&!/  /.test(s))return s;for(var h=u,f="",g=0;g<s.length;g++){var S=s.charAt(g);S==" "&&h&&(g==s.length-1||s.charCodeAt(g+1)==32)&&(S="\xA0"),f+=S,h=S==" "}return f}function GN(s,u){return function(h,f,g,S,w,T,L){g=g?g+" cm-force-border":"cm-force-border";for(var A=h.pos,F=A+f.length;;){for(var z=void 0,Y=0;Y<u.length&&(z=u[Y],!(z.to>A&&z.from<=A));Y++);if(z.to>=F)return s(h,f,g,S,w,T,L);s(h,f.slice(0,z.to-A),g,S,null,T,L),S=null,f=f.slice(z.to-A),A=z.to}}}function J0(s,u,h,f){var g=!f&&h.widgetNode;g&&s.map.push(s.pos,s.pos+u,g),!f&&s.cm.display.input.needsContentAttribute&&(g||(g=s.content.appendChild(document.createElement("span"))),g.setAttribute("cm-marker",h.id)),g&&(s.cm.display.input.setUneditable(g),s.content.appendChild(g)),s.pos+=u,s.trailingSpace=!1}function WN(s,u,h){var f=s.markedSpans,g=s.text,S=0;if(!f){for(var w=1;w<h.length;w+=2)u.addToken(u,g.slice(S,S=h[w]),j0(h[w+1],u.cm.options));return}for(var T=g.length,L=0,A=1,F="",z,Y,K=0,Z,ie,de,fe,Se;;){if(K==L){Z=ie=de=Y="",Se=null,fe=null,K=Infinity;for(var he=[],xe=void 0,De=0;De<f.length;++De){var Ee=f[De],Ke=Ee.marker;if(Ke.type=="bookmark"&&Ee.from==L&&Ke.widgetNode)he.push(Ke);else if(Ee.from<=L&&(Ee.to==null||Ee.to>L||Ke.collapsed&&Ee.to==L&&Ee.from==L)){if(Ee.to!=null&&Ee.to!=L&&K>Ee.to&&(K=Ee.to,ie=""),Ke.className&&(Z+=" "+Ke.className),Ke.css&&(Y=(Y?Y+";":"")+Ke.css),Ke.startStyle&&Ee.from==L&&(de+=" "+Ke.startStyle),Ke.endStyle&&Ee.to==K&&(xe||(xe=[])).push(Ke.endStyle,Ee.to),Ke.title&&((Se||(Se={})).title=Ke.title),Ke.attributes)for(var Ct in Ke.attributes)(Se||(Se={}))[Ct]=Ke.attributes[Ct];Ke.collapsed&&(!fe||Cy(fe.marker,Ke)<0)&&(fe=Ee)}else Ee.from>L&&K>Ee.from&&(K=Ee.from)}if(xe)for(var pn=0;pn<xe.length;pn+=2)xe[pn+1]==K&&(ie+=" "+xe[pn]);if(!fe||fe.from==L)for(var Ot=0;Ot<he.length;++Ot)J0(u,0,he[Ot]);if(fe&&(fe.from||0)==L){if(J0(u,(fe.to==null?T+1:fe.to)-L,fe.marker,fe.from==null),fe.to==null)return;fe.to==L&&(fe=!1)}}if(L>=T)break;for(var Ir=Math.min(T,K);;){if(F){var mr=L+F.length;if(!fe){var Yt=mr>Ir?F.slice(0,Ir-L):F;u.addToken(u,Yt,z?z+Z:Z,de,L+Yt.length==K?ie:"",Y,Se)}if(mr>=Ir){F=F.slice(Ir-L),L=Ir;break}L=mr,de=""}F=g.slice(S,S=h[A++]),z=j0(h[A++],u.cm.options)}}}function K0(s,u,h){this.line=u,this.rest=RN(u),this.size=this.rest?pt(tt(this.rest))-h+1:1,this.node=this.text=null,this.hidden=Io(s,u)}function ff(s,u,h){for(var f=[],g,S=u;S<h;S=g){var w=new K0(s.doc,ke(s.doc,S),S);g=S+w.size,f.push(w)}return f}var Wl=null;function zN(s){Wl?Wl.ops.push(s):s.ownsGroup=Wl={ops:[s],delayedCallbacks:[]}}function HN(s){var u=s.delayedCallbacks,h=0;do{for(;h<u.length;h++)u[h].call(null);for(var f=0;f<s.ops.length;f++){var g=s.ops[f];if(g.cursorActivityHandlers)for(;g.cursorActivityCalled<g.cursorActivityHandlers.length;)g.cursorActivityHandlers[g.cursorActivityCalled++].call(null,g.cm)}}while(h<u.length)}function $N(s,u){var h=s.ownsGroup;if(!!h)try{HN(h)}finally{Wl=null,u(h)}}var Pu=null;function cn(s,u){var h=Vl(s,u);if(!!h.length){var f=Array.prototype.slice.call(arguments,2),g;Wl?g=Wl.delayedCallbacks:Pu?g=Pu:(g=Pu=[],setTimeout(jN,0));for(var S=function(T){g.push(function(){return h[T].apply(null,f)})},w=0;w<h.length;++w)S(w)}}function jN(){var s=Pu;Pu=null;for(var u=0;u<s.length;++u)s[u]()}function Y0(s,u,h,f){for(var g=0;g<u.changes.length;g++){var S=u.changes[g];S=="text"?JN(s,u):S=="gutter"?Q0(s,u,h,f):S=="class"?Ly(s,u):S=="widget"&&KN(s,u,f)}u.changes=null}function Du(s){return s.node==s.text&&(s.node=U("div",null,null,"position: relative"),s.text.parentNode&&s.text.parentNode.replaceChild(s.node,s.text),s.node.appendChild(s.text),o&&l<8&&(s.node.style.zIndex=2)),s.node}function qN(s,u){var h=u.bgClass?u.bgClass+" "+(u.line.bgClass||""):u.line.bgClass;if(h&&(h+=" CodeMirror-linebackground"),u.background)h?u.background.className=h:(u.background.parentNode.removeChild(u.background),u.background=null);else if(h){var f=Du(u);u.background=f.insertBefore(U("div",null,h),f.firstChild),s.display.input.setUneditable(u.background)}}function X0(s,u){var h=s.display.externalMeasured;return h&&h.line==u.line?(s.display.externalMeasured=null,u.measure=h.measure,h.built):q0(s,u)}function JN(s,u){var h=u.text.className,f=X0(s,u);u.text==u.node&&(u.node=f.pre),u.text.parentNode.replaceChild(f.pre,u.text),u.text=f.pre,f.bgClass!=u.bgClass||f.textClass!=u.textClass?(u.bgClass=f.bgClass,u.textClass=f.textClass,Ly(s,u)):h&&(u.text.className=h)}function Ly(s,u){qN(s,u),u.line.wrapClass?Du(u).className=u.line.wrapClass:u.node!=u.text&&(u.node.className="");var h=u.textClass?u.textClass+" "+(u.line.textClass||""):u.line.textClass;u.text.className=h||""}function Q0(s,u,h,f){if(u.gutter&&(u.node.removeChild(u.gutter),u.gutter=null),u.gutterBackground&&(u.node.removeChild(u.gutterBackground),u.gutterBackground=null),u.line.gutterClass){var g=Du(u);u.gutterBackground=U("div",null,"CodeMirror-gutter-background "+u.line.gutterClass,"left: "+(s.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px; width: "+f.gutterTotalWidth+"px"),s.display.input.setUneditable(u.gutterBackground),g.insertBefore(u.gutterBackground,u.text)}var S=u.line.gutterMarkers;if(s.options.lineNumbers||S){var w=Du(u),T=u.gutter=U("div",null,"CodeMirror-gutter-wrapper","left: "+(s.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px");if(T.setAttribute("aria-hidden","true"),s.display.input.setUneditable(T),w.insertBefore(T,u.text),u.line.gutterClass&&(T.className+=" "+u.line.gutterClass),s.options.lineNumbers&&(!S||!S["CodeMirror-linenumbers"])&&(u.lineNumber=T.appendChild(U("div",ku(s.options,h),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+f.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+s.display.lineNumInnerWidth+"px"))),S)for(var L=0;L<s.display.gutterSpecs.length;++L){var A=s.display.gutterSpecs[L].className,F=S.hasOwnProperty(A)&&S[A];F&&T.appendChild(U("div",[F],"CodeMirror-gutter-elt","left: "+f.gutterLeft[A]+"px; width: "+f.gutterWidth[A]+"px"))}}}function KN(s,u,h){u.alignable&&(u.alignable=null);for(var f=O("CodeMirror-linewidget"),g=u.node.firstChild,S=void 0;g;g=S)S=g.nextSibling,f.test(g.className)&&u.node.removeChild(g);Z0(s,u,h)}function YN(s,u,h,f){var g=X0(s,u);return u.text=u.node=g.pre,g.bgClass&&(u.bgClass=g.bgClass),g.textClass&&(u.textClass=g.textClass),Ly(s,u),Q0(s,u,h,f),Z0(s,u,f),u.node}function Z0(s,u,h){if(eT(s,u.line,u,h,!0),u.rest)for(var f=0;f<u.rest.length;f++)eT(s,u.rest[f],u,h,!1)}function eT(s,u,h,f,g){if(!!u.widgets)for(var S=Du(h),w=0,T=u.widgets;w<T.length;++w){var L=T[w],A=U("div",[L.node],"CodeMirror-linewidget"+(L.className?" "+L.className:""));L.handleMouseEvents||A.setAttribute("cm-ignore-events","true"),XN(L,A,h,f),s.display.input.setUneditable(A),g&&L.above?S.insertBefore(A,h.gutter||h.text):S.appendChild(A),cn(L,"redraw")}}function XN(s,u,h,f){if(s.noHScroll){(h.alignable||(h.alignable=[])).push(u);var g=f.wrapperWidth;u.style.left=f.fixedPos+"px",s.coverGutter||(g-=f.gutterTotalWidth,u.style.paddingLeft=f.gutterTotalWidth+"px"),u.style.width=g+"px"}s.coverGutter&&(u.style.zIndex=5,u.style.position="relative",s.noHScroll||(u.style.marginLeft=-f.gutterTotalWidth+"px"))}function Au(s){if(s.height!=null)return s.height;var u=s.doc.cm;if(!u)return 0;if(!ne(document.body,s.node)){var h="position: relative;";s.coverGutter&&(h+="margin-left: -"+u.display.gutters.offsetWidth+"px;"),s.noHScroll&&(h+="width: "+u.display.wrapper.clientWidth+"px;"),V(u.display.measure,U("div",[s.node],null,h))}return s.height=s.node.parentNode.offsetHeight}function Ja(s,u){for(var h=Do(u);h!=s.wrapper;h=h.parentNode)if(!h||h.nodeType==1&&h.getAttribute("cm-ignore-events")=="true"||h.parentNode==s.sizer&&h!=s.mover)return!0}function hf(s){return s.lineSpace.offsetTop}function Ey(s){return s.mover.offsetHeight-s.lineSpace.offsetHeight}function tT(s){if(s.cachedPaddingH)return s.cachedPaddingH;var u=V(s.measure,U("pre","x","CodeMirror-line-like")),h=window.getComputedStyle?window.getComputedStyle(u):u.currentStyle,f={left:parseInt(h.paddingLeft),right:parseInt(h.paddingRight)};return!isNaN(f.left)&&!isNaN(f.right)&&(s.cachedPaddingH=f),f}function da(s){return Le-s.display.nativeBarWidth}function Ds(s){return s.display.scroller.clientWidth-da(s)-s.display.barWidth}function Py(s){return s.display.scroller.clientHeight-da(s)-s.display.barHeight}function QN(s,u,h){var f=s.options.lineWrapping,g=f&&Ds(s);if(!u.measure.heights||f&&u.measure.width!=g){var S=u.measure.heights=[];if(f){u.measure.width=g;for(var w=u.text.firstChild.getClientRects(),T=0;T<w.length-1;T++){var L=w[T],A=w[T+1];Math.abs(L.bottom-A.bottom)>2&&S.push((L.bottom+A.top)/2-h.top)}}S.push(h.bottom-h.top)}}function nT(s,u,h){if(s.line==u)return{map:s.measure.map,cache:s.measure.cache};for(var f=0;f<s.rest.length;f++)if(s.rest[f]==u)return{map:s.measure.maps[f],cache:s.measure.caches[f]};for(var g=0;g<s.rest.length;g++)if(pt(s.rest[g])>h)return{map:s.measure.maps[g],cache:s.measure.caches[g],before:!0}}function ZN(s,u){u=ua(u);var h=pt(u),f=s.display.externalMeasured=new K0(s.doc,u,h);f.lineN=h;var g=f.built=q0(s,f);return f.text=g.pre,V(s.display.lineMeasure,g.pre),f}function rT(s,u,h,f){return pa(s,zl(s,u),h,f)}function Dy(s,u){if(u>=s.display.viewFrom&&u<s.display.viewTo)return s.display.view[Ms(s,u)];var h=s.display.externalMeasured;if(h&&u>=h.lineN&&u<h.lineN+h.size)return h}function zl(s,u){var h=pt(u),f=Dy(s,h);f&&!f.text?f=null:f&&f.changes&&(Y0(s,f,h,Vy(s)),s.curOp.forceUpdate=!0),f||(f=ZN(s,u));var g=nT(f,u,h);return{line:u,view:f,rect:null,map:g.map,cache:g.cache,before:g.before,hasHeights:!1}}function pa(s,u,h,f,g){u.before&&(h=-1);var S=h+(f||""),w;return u.cache.hasOwnProperty(S)?w=u.cache[S]:(u.rect||(u.rect=u.view.text.getBoundingClientRect()),u.hasHeights||(QN(s,u.view,u.rect),u.hasHeights=!0),w=tB(s,u,h,f),w.bogus||(u.cache[S]=w)),{left:w.left,right:w.right,top:g?w.rtop:w.top,bottom:g?w.rbottom:w.bottom}}var iT={left:0,right:0,top:0,bottom:0};function aT(s,u,h){for(var f,g,S,w,T,L,A=0;A<s.length;A+=3)if(T=s[A],L=s[A+1],u<T?(g=0,S=1,w="left"):u<L?(g=u-T,S=g+1):(A==s.length-3||u==L&&s[A+3]>u)&&(S=L-T,g=S-1,u>=L&&(w="right")),g!=null){if(f=s[A+2],T==L&&h==(f.insertLeft?"left":"right")&&(w=h),h=="left"&&g==0)for(;A&&s[A-2]==s[A-3]&&s[A-1].insertLeft;)f=s[(A-=3)+2],w="left";if(h=="right"&&g==L-T)for(;A<s.length-3&&s[A+3]==s[A+4]&&!s[A+5].insertLeft;)f=s[(A+=3)+2],w="right";break}return{node:f,start:g,end:S,collapse:w,coverStart:T,coverEnd:L}}function eB(s,u){var h=iT;if(u=="left")for(var f=0;f<s.length&&(h=s[f]).left==h.right;f++);else for(var g=s.length-1;g>=0&&(h=s[g]).left==h.right;g--);return h}function tB(s,u,h,f){var g=aT(u.map,h,f),S=g.node,w=g.start,T=g.end,L=g.collapse,A;if(S.nodeType==3){for(var F=0;F<4;F++){for(;w&&_l(u.line.text.charAt(g.coverStart+w));)--w;for(;g.coverStart+T<g.coverEnd&&_l(u.line.text.charAt(g.coverStart+T));)++T;if(o&&l<9&&w==0&&T==g.coverEnd-g.coverStart?A=S.parentNode.getBoundingClientRect():A=eB(q(S,w,T).getClientRects(),f),A.left||A.right||w==0)break;T=w,w=w-1,L="right"}o&&l<11&&(A=nB(s.display.measure,A))}else{w>0&&(L=f="right");var z;s.options.lineWrapping&&(z=S.getClientRects()).length>1?A=z[f=="right"?z.length-1:0]:A=S.getBoundingClientRect()}if(o&&l<9&&!w&&(!A||!A.left&&!A.right)){var Y=S.parentNode.getClientRects()[0];Y?A={left:Y.left,right:Y.left+$l(s.display),top:Y.top,bottom:Y.bottom}:A=iT}for(var K=A.top-u.rect.top,Z=A.bottom-u.rect.top,ie=(K+Z)/2,de=u.view.measure.heights,fe=0;fe<de.length-1&&!(ie<de[fe]);fe++);var Se=fe?de[fe-1]:0,he=de[fe],xe={left:(L=="right"?A.right:A.left)-u.rect.left,right:(L=="left"?A.left:A.right)-u.rect.left,top:Se,bottom:he};return!A.left&&!A.right&&(xe.bogus=!0),s.options.singleCursorHeightPerLine||(xe.rtop=K,xe.rbottom=Z),xe}function nB(s,u){if(!window.screen||screen.logicalXDPI==null||screen.logicalXDPI==screen.deviceXDPI||!Ao(s))return u;var h=screen.logicalXDPI/screen.deviceXDPI,f=screen.logicalYDPI/screen.deviceYDPI;return{left:u.left*h,right:u.right*h,top:u.top*f,bottom:u.bottom*f}}function oT(s){if(s.measure&&(s.measure.cache={},s.measure.heights=null,s.rest))for(var u=0;u<s.rest.length;u++)s.measure.caches[u]={}}function sT(s){s.display.externalMeasure=null,W(s.display.lineMeasure);for(var u=0;u<s.display.view.length;u++)oT(s.display.view[u])}function Iu(s){sT(s),s.display.cachedCharWidth=s.display.cachedTextHeight=s.display.cachedPaddingH=null,s.options.lineWrapping||(s.display.maxLineChanged=!0),s.display.lineNumChars=null}function lT(){return p&&C?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function cT(){return p&&C?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function Ay(s){var u=0;if(s.widgets)for(var h=0;h<s.widgets.length;++h)s.widgets[h].above&&(u+=Au(s.widgets[h]));return u}function mf(s,u,h,f,g){if(!g){var S=Ay(u);h.top+=S,h.bottom+=S}if(f=="line")return h;f||(f="local");var w=qa(u);if(f=="local"?w+=hf(s.display):w-=s.display.viewOffset,f=="page"||f=="window"){var T=s.display.lineSpace.getBoundingClientRect();w+=T.top+(f=="window"?0:cT());var L=T.left+(f=="window"?0:lT());h.left+=L,h.right+=L}return h.top+=w,h.bottom+=w,h}function uT(s,u,h){if(h=="div")return u;var f=u.left,g=u.top;if(h=="page")f-=lT(),g-=cT();else if(h=="local"||!h){var S=s.display.sizer.getBoundingClientRect();f+=S.left,g+=S.top}var w=s.display.lineSpace.getBoundingClientRect();return{left:f-w.left,top:g-w.top}}function Iy(s,u,h,f,g){return f||(f=ke(s.doc,u.line)),mf(s,f,rT(s,f,u.ch,g),h)}function Pi(s,u,h,f,g,S){f=f||ke(s.doc,u.line),g||(g=zl(s,f));function w(Z,ie){var de=pa(s,g,Z,ie?"right":"left",S);return ie?de.left=de.right:de.right=de.left,mf(s,f,de,h)}var T=Pr(f,s.doc.direction),L=u.ch,A=u.sticky;if(L>=f.text.length?(L=f.text.length,A="before"):L<=0&&(L=0,A="after"),!T)return w(A=="before"?L-1:L,A=="before");function F(Z,ie,de){var fe=T[ie],Se=fe.level==1;return w(de?Z-1:Z,Se!=de)}var z=kt(T,L,A),Y=ur,K=F(L,z,A=="before");return Y!=null&&(K.other=F(L,Y,A!="before")),K}function dT(s,u){var h=0;u=ve(s.doc,u),s.options.lineWrapping||(h=$l(s.display)*u.ch);var f=ke(s.doc,u.line),g=qa(f)+hf(s.display);return{left:h,right:h,top:g,bottom:g+f.height}}function My(s,u,h,f,g){var S=oe(s,u,h);return S.xRel=g,f&&(S.outside=f),S}function Ry(s,u,h){var f=s.doc;if(h+=s.display.viewOffset,h<0)return My(f.first,0,null,-1,-1);var g=la(f,h),S=f.first+f.size-1;if(g>S)return My(f.first+f.size-1,ke(f,S).text.length,null,1,1);u<0&&(u=0);for(var w=ke(f,g);;){var T=rB(s,w,g,u,h),L=IN(w,T.ch+(T.xRel>0||T.outside>0?1:0));if(!L)return T;var A=L.find(1);if(A.line==g)return A;w=ke(f,g=A.line)}}function pT(s,u,h,f){f-=Ay(u);var g=u.text.length,S=Bn(function(w){return pa(s,h,w-1).bottom<=f},g,0);return g=Bn(function(w){return pa(s,h,w).top>f},S,g),{begin:S,end:g}}function fT(s,u,h,f){h||(h=zl(s,u));var g=mf(s,u,pa(s,h,f),"line").top;return pT(s,u,h,g)}function _y(s,u,h,f){return s.bottom<=h?!1:s.top>h?!0:(f?s.left:s.right)>u}function rB(s,u,h,f,g){g-=qa(u);var S=zl(s,u),w=Ay(u),T=0,L=u.text.length,A=!0,F=Pr(u,s.doc.direction);if(F){var z=(s.options.lineWrapping?aB:iB)(s,u,h,S,F,f,g);A=z.level!=1,T=A?z.from:z.to-1,L=A?z.to:z.from-1}var Y=null,K=null,Z=Bn(function(De){var Ee=pa(s,S,De);return Ee.top+=w,Ee.bottom+=w,_y(Ee,f,g,!1)?(Ee.top<=g&&Ee.left<=f&&(Y=De,K=Ee),!0):!1},T,L),ie,de,fe=!1;if(K){var Se=f-K.left<K.right-f,he=Se==A;Z=Y+(he?0:1),de=he?"after":"before",ie=Se?K.left:K.right}else{!A&&(Z==L||Z==T)&&Z++,de=Z==0?"after":Z==u.text.length?"before":pa(s,S,Z-(A?1:0)).bottom+w<=g==A?"after":"before";var xe=Pi(s,oe(h,Z,de),"line",u,S);ie=xe.left,fe=g<xe.top?-1:g>=xe.bottom?1:0}return Z=Po(u.text,Z,1),My(h,Z,de,fe,f-ie)}function iB(s,u,h,f,g,S,w){var T=Bn(function(z){var Y=g[z],K=Y.level!=1;return _y(Pi(s,oe(h,K?Y.to:Y.from,K?"before":"after"),"line",u,f),S,w,!0)},0,g.length-1),L=g[T];if(T>0){var A=L.level!=1,F=Pi(s,oe(h,A?L.from:L.to,A?"after":"before"),"line",u,f);_y(F,S,w,!0)&&F.top>w&&(L=g[T-1])}return L}function aB(s,u,h,f,g,S,w){var T=pT(s,u,f,w),L=T.begin,A=T.end;/\s/.test(u.text.charAt(A-1))&&A--;for(var F=null,z=null,Y=0;Y<g.length;Y++){var K=g[Y];if(!(K.from>=A||K.to<=L)){var Z=K.level!=1,ie=pa(s,f,Z?Math.min(A,K.to)-1:Math.max(L,K.from)).right,de=ie<S?S-ie+1e9:ie-S;(!F||z>de)&&(F=K,z=de)}}return F||(F=g[g.length-1]),F.from<L&&(F={from:L,to:F.to,level:F.level}),F.to>A&&(F={from:F.from,to:A,level:F.level}),F}var As;function Hl(s){if(s.cachedTextHeight!=null)return s.cachedTextHeight;if(As==null){As=U("pre",null,"CodeMirror-line-like");for(var u=0;u<49;++u)As.appendChild(document.createTextNode("x")),As.appendChild(U("br"));As.appendChild(document.createTextNode("x"))}V(s.measure,As);var h=As.offsetHeight/50;return h>3&&(s.cachedTextHeight=h),W(s.measure),h||1}function $l(s){if(s.cachedCharWidth!=null)return s.cachedCharWidth;var u=U("span","xxxxxxxxxx"),h=U("pre",[u],"CodeMirror-line-like");V(s.measure,h);var f=u.getBoundingClientRect(),g=(f.right-f.left)/10;return g>2&&(s.cachedCharWidth=g),g||10}function Vy(s){for(var u=s.display,h={},f={},g=u.gutters.clientLeft,S=u.gutters.firstChild,w=0;S;S=S.nextSibling,++w){var T=s.display.gutterSpecs[w].className;h[T]=S.offsetLeft+S.clientLeft+g,f[T]=S.clientWidth}return{fixedPos:Oy(u),gutterTotalWidth:u.gutters.offsetWidth,gutterLeft:h,gutterWidth:f,wrapperWidth:u.wrapper.clientWidth}}function Oy(s){return s.scroller.getBoundingClientRect().left-s.sizer.getBoundingClientRect().left}function hT(s){var u=Hl(s.display),h=s.options.lineWrapping,f=h&&Math.max(5,s.display.scroller.clientWidth/$l(s.display)-3);return function(g){if(Io(s.doc,g))return 0;var S=0;if(g.widgets)for(var w=0;w<g.widgets.length;w++)g.widgets[w].height&&(S+=g.widgets[w].height);return h?S+(Math.ceil(g.text.length/f)||1)*u:S+u}}function Ny(s){var u=s.doc,h=hT(s);u.iter(function(f){var g=h(f);g!=f.height&&Dr(f,g)})}function Is(s,u,h,f){var g=s.display;if(!h&&Do(u).getAttribute("cm-not-content")=="true")return null;var S,w,T=g.lineSpace.getBoundingClientRect();try{S=u.clientX-T.left,w=u.clientY-T.top}catch(z){return null}var L=Ry(s,S,w),A;if(f&&L.xRel>0&&(A=ke(s.doc,L.line).text).length==L.ch){var F=Be(A,A.length,s.options.tabSize)-A.length;L=oe(L.line,Math.max(0,Math.round((S-tT(s.display).left)/$l(s.display))-F))}return L}function Ms(s,u){if(u>=s.display.viewTo||(u-=s.display.viewFrom,u<0))return null;for(var h=s.display.view,f=0;f<h.length;f++)if(u-=h[f].size,u<0)return f}function fr(s,u,h,f){u==null&&(u=s.doc.first),h==null&&(h=s.doc.first+s.doc.size),f||(f=0);var g=s.display;if(f&&h<g.viewTo&&(g.updateLineNumbers==null||g.updateLineNumbers>u)&&(g.updateLineNumbers=u),s.curOp.viewChanged=!0,u>=g.viewTo)ja&&wy(s.doc,u)<g.viewTo&&Ro(s);else if(h<=g.viewFrom)ja&&$0(s.doc,h+f)>g.viewFrom?Ro(s):(g.viewFrom+=f,g.viewTo+=f);else if(u<=g.viewFrom&&h>=g.viewTo)Ro(s);else if(u<=g.viewFrom){var S=gf(s,h,h+f,1);S?(g.view=g.view.slice(S.index),g.viewFrom=S.lineN,g.viewTo+=f):Ro(s)}else if(h>=g.viewTo){var w=gf(s,u,u,-1);w?(g.view=g.view.slice(0,w.index),g.viewTo=w.lineN):Ro(s)}else{var T=gf(s,u,u,-1),L=gf(s,h,h+f,1);T&&L?(g.view=g.view.slice(0,T.index).concat(ff(s,T.lineN,L.lineN)).concat(g.view.slice(L.index)),g.viewTo+=f):Ro(s)}var A=g.externalMeasured;A&&(h<A.lineN?A.lineN+=f:u<A.lineN+A.size&&(g.externalMeasured=null))}function Mo(s,u,h){s.curOp.viewChanged=!0;var f=s.display,g=s.display.externalMeasured;if(g&&u>=g.lineN&&u<g.lineN+g.size&&(f.externalMeasured=null),!(u<f.viewFrom||u>=f.viewTo)){var S=f.view[Ms(s,u)];if(S.node!=null){var w=S.changes||(S.changes=[]);ge(w,h)==-1&&w.push(h)}}}function Ro(s){s.display.viewFrom=s.display.viewTo=s.doc.first,s.display.view=[],s.display.viewOffset=0}function gf(s,u,h,f){var g=Ms(s,u),S,w=s.display.view;if(!ja||h==s.doc.first+s.doc.size)return{index:g,lineN:h};for(var T=s.display.viewFrom,L=0;L<g;L++)T+=w[L].size;if(T!=u){if(f>0){if(g==w.length-1)return null;S=T+w[g].size-u,g++}else S=T-u;u+=S,h+=S}for(;wy(s.doc,h)!=h;){if(g==(f<0?0:w.length-1))return null;h+=f*w[g-(f<0?1:0)].size,g+=f}return{index:g,lineN:h}}function oB(s,u,h){var f=s.display,g=f.view;g.length==0||u>=f.viewTo||h<=f.viewFrom?(f.view=ff(s,u,h),f.viewFrom=u):(f.viewFrom>u?f.view=ff(s,u,f.viewFrom).concat(f.view):f.viewFrom<u&&(f.view=f.view.slice(Ms(s,u))),f.viewFrom=u,f.viewTo<h?f.view=f.view.concat(ff(s,f.viewTo,h)):f.viewTo>h&&(f.view=f.view.slice(0,Ms(s,h)))),f.viewTo=h}function mT(s){for(var u=s.display.view,h=0,f=0;f<u.length;f++){var g=u[f];!g.hidden&&(!g.node||g.changes)&&++h}return h}function Mu(s){s.display.input.showSelection(s.display.input.prepareSelection())}function gT(s,u){u===void 0&&(u=!0);for(var h=s.doc,f={},g=f.cursors=document.createDocumentFragment(),S=f.selection=document.createDocumentFragment(),w=0;w<h.sel.ranges.length;w++)if(!(!u&&w==h.sel.primIndex)){var T=h.sel.ranges[w];if(!(T.from().line>=s.display.viewTo||T.to().line<s.display.viewFrom)){var L=T.empty();(L||s.options.showCursorWhenSelecting)&&yT(s,T.head,g),L||sB(s,T,S)}}return f}function yT(s,u,h){var f=Pi(s,u,"div",null,null,!s.options.singleCursorHeightPerLine),g=h.appendChild(U("div","\xA0","CodeMirror-cursor"));if(g.style.left=f.left+"px",g.style.top=f.top+"px",g.style.height=Math.max(0,f.bottom-f.top)*s.options.cursorHeight+"px",f.other){var S=h.appendChild(U("div","\xA0","CodeMirror-cursor CodeMirror-secondarycursor"));S.style.display="",S.style.left=f.other.left+"px",S.style.top=f.other.top+"px",S.style.height=(f.other.bottom-f.other.top)*.85+"px"}}function yf(s,u){return s.top-u.top||s.left-u.left}function sB(s,u,h){var f=s.display,g=s.doc,S=document.createDocumentFragment(),w=tT(s.display),T=w.left,L=Math.max(f.sizerWidth,Ds(s)-f.sizer.offsetLeft)-w.right,A=g.direction=="ltr";function F(he,xe,De,Ee){xe<0&&(xe=0),xe=Math.round(xe),Ee=Math.round(Ee),S.appendChild(U("div",null,"CodeMirror-selected","position: absolute; left: "+he+`px;
                             top: `+xe+"px; width: "+(De==null?L-he:De)+`px;
                             height: `+(Ee-xe)+"px"))}function z(he,xe,De){var Ee=ke(g,he),Ke=Ee.text.length,Ct,pn;function Ot(Yt,gr){return Iy(s,oe(he,Yt),"div",Ee,gr)}function Ir(Yt,gr,Ln){var tn=fT(s,Ee,null,Yt),Xt=gr=="ltr"==(Ln=="after")?"left":"right",Ut=Ln=="after"?tn.begin:tn.end-(/\s/.test(Ee.text.charAt(tn.end-1))?2:1);return Ot(Ut,Xt)[Xt]}var mr=Pr(Ee,g.direction);return yu(mr,xe||0,De==null?Ke:De,function(Yt,gr,Ln,tn){var Xt=Ln=="ltr",Ut=Ot(Yt,Xt?"left":"right"),yr=Ot(gr-1,Xt?"right":"left"),ic=xe==null&&Yt==0,Uo=De==null&&gr==Ke,Wn=tn==0,fa=!mr||tn==mr.length-1;if(yr.top-Ut.top<=3){var fn=(A?ic:Uo)&&Wn,cv=(A?Uo:ic)&&fa,Ya=fn?T:(Xt?Ut:yr).left,Ns=cv?L:(Xt?yr:Ut).right;F(Ya,Ut.top,Ns-Ya,Ut.bottom)}else{var Bs,tr,ac,uv;Xt?(Bs=A&&ic&&Wn?T:Ut.left,tr=A?L:Ir(Yt,Ln,"before"),ac=A?T:Ir(gr,Ln,"after"),uv=A&&Uo&&fa?L:yr.right):(Bs=A?Ir(Yt,Ln,"before"):T,tr=!A&&ic&&Wn?L:Ut.right,ac=!A&&Uo&&fa?T:yr.left,uv=A?Ir(gr,Ln,"after"):L),F(Bs,Ut.top,tr-Bs,Ut.bottom),Ut.bottom<yr.top&&F(T,Ut.bottom,null,yr.top),F(ac,yr.top,uv-ac,yr.bottom)}(!Ct||yf(Ut,Ct)<0)&&(Ct=Ut),yf(yr,Ct)<0&&(Ct=yr),(!pn||yf(Ut,pn)<0)&&(pn=Ut),yf(yr,pn)<0&&(pn=yr)}),{start:Ct,end:pn}}var Y=u.from(),K=u.to();if(Y.line==K.line)z(Y.line,Y.ch,K.ch);else{var Z=ke(g,Y.line),ie=ke(g,K.line),de=ua(Z)==ua(ie),fe=z(Y.line,Y.ch,de?Z.text.length+1:null).end,Se=z(K.line,de?0:null,K.ch).start;de&&(fe.top<Se.top-2?(F(fe.right,fe.top,null,fe.bottom),F(T,Se.top,Se.left,Se.bottom)):F(fe.right,fe.top,Se.left-fe.right,fe.bottom)),fe.bottom<Se.top&&F(T,fe.bottom,null,Se.top)}h.appendChild(S)}function By(s){if(!!s.state.focused){var u=s.display;clearInterval(u.blinker);var h=!0;u.cursorDiv.style.visibility="",s.options.cursorBlinkRate>0?u.blinker=setInterval(function(){s.hasFocus()||jl(s),u.cursorDiv.style.visibility=(h=!h)?"":"hidden"},s.options.cursorBlinkRate):s.options.cursorBlinkRate<0&&(u.cursorDiv.style.visibility="hidden")}}function vT(s){s.hasFocus()||(s.display.input.focus(),s.state.focused||Fy(s))}function Uy(s){s.state.delayingBlurEvent=!0,setTimeout(function(){s.state.delayingBlurEvent&&(s.state.delayingBlurEvent=!1,s.state.focused&&jl(s))},100)}function Fy(s,u){s.state.delayingBlurEvent&&!s.state.draggingText&&(s.state.delayingBlurEvent=!1),s.options.readOnly!="nocursor"&&(s.state.focused||(Ue(s,"focus",s,u),s.state.focused=!0,me(s.display.wrapper,"CodeMirror-focused"),!s.curOp&&s.display.selForContextMenu!=s.doc.sel&&(s.display.input.reset(),c&&setTimeout(function(){return s.display.input.reset(!0)},20)),s.display.input.receivedFocus()),By(s))}function jl(s,u){s.state.delayingBlurEvent||(s.state.focused&&(Ue(s,"blur",s,u),s.state.focused=!1,B(s.display.wrapper,"CodeMirror-focused")),clearInterval(s.display.blinker),setTimeout(function(){s.state.focused||(s.display.shift=!1)},150))}function vf(s){for(var u=s.display,h=u.lineDiv.offsetTop,f=0;f<u.view.length;f++){var g=u.view[f],S=s.options.lineWrapping,w=void 0,T=0;if(!g.hidden){if(o&&l<8){var L=g.node.offsetTop+g.node.offsetHeight;w=L-h,h=L}else{var A=g.node.getBoundingClientRect();w=A.bottom-A.top,!S&&g.text.firstChild&&(T=g.text.firstChild.getBoundingClientRect().right-A.left-1)}var F=g.line.height-w;if((F>.005||F<-.005)&&(Dr(g.line,w),ST(g.line),g.rest))for(var z=0;z<g.rest.length;z++)ST(g.rest[z]);if(T>s.display.sizerWidth){var Y=Math.ceil(T/$l(s.display));Y>s.display.maxLineLength&&(s.display.maxLineLength=Y,s.display.maxLine=g.line,s.display.maxLineChanged=!0)}}}}function ST(s){if(s.widgets)for(var u=0;u<s.widgets.length;++u){var h=s.widgets[u],f=h.node.parentNode;f&&(h.height=f.offsetHeight)}}function Sf(s,u,h){var f=h&&h.top!=null?Math.max(0,h.top):s.scroller.scrollTop;f=Math.floor(f-hf(s));var g=h&&h.bottom!=null?h.bottom:f+s.wrapper.clientHeight,S=la(u,f),w=la(u,g);if(h&&h.ensure){var T=h.ensure.from.line,L=h.ensure.to.line;T<S?(S=T,w=la(u,qa(ke(u,T))+s.wrapper.clientHeight)):Math.min(L,u.lastLine())>=w&&(S=la(u,qa(ke(u,L))-s.wrapper.clientHeight),w=L)}return{from:S,to:Math.max(w,S+1)}}function lB(s,u){if(!Kt(s,"scrollCursorIntoView")){var h=s.display,f=h.sizer.getBoundingClientRect(),g=null;if(u.top+f.top<0?g=!0:u.bottom+f.top>(window.innerHeight||document.documentElement.clientHeight)&&(g=!1),g!=null&&!b){var S=U("div","\u200B",null,`position: absolute;
                         top: `+(u.top-h.viewOffset-hf(s.display))+`px;
                         height: `+(u.bottom-u.top+da(s)+h.barHeight)+`px;
                         left: `+u.left+"px; width: "+Math.max(2,u.right-u.left)+"px;");s.display.lineSpace.appendChild(S),S.scrollIntoView(g),s.display.lineSpace.removeChild(S)}}}function cB(s,u,h,f){f==null&&(f=0);var g;!s.options.lineWrapping&&u==h&&(h=u.sticky=="before"?oe(u.line,u.ch+1,"before"):u,u=u.ch?oe(u.line,u.sticky=="before"?u.ch-1:u.ch,"after"):u);for(var S=0;S<5;S++){var w=!1,T=Pi(s,u),L=!h||h==u?T:Pi(s,h);g={left:Math.min(T.left,L.left),top:Math.min(T.top,L.top)-f,right:Math.max(T.left,L.left),bottom:Math.max(T.bottom,L.bottom)+f};var A=Gy(s,g),F=s.doc.scrollTop,z=s.doc.scrollLeft;if(A.scrollTop!=null&&(_u(s,A.scrollTop),Math.abs(s.doc.scrollTop-F)>1&&(w=!0)),A.scrollLeft!=null&&(Rs(s,A.scrollLeft),Math.abs(s.doc.scrollLeft-z)>1&&(w=!0)),!w)break}return g}function uB(s,u){var h=Gy(s,u);h.scrollTop!=null&&_u(s,h.scrollTop),h.scrollLeft!=null&&Rs(s,h.scrollLeft)}function Gy(s,u){var h=s.display,f=Hl(s.display);u.top<0&&(u.top=0);var g=s.curOp&&s.curOp.scrollTop!=null?s.curOp.scrollTop:h.scroller.scrollTop,S=Py(s),w={};u.bottom-u.top>S&&(u.bottom=u.top+S);var T=s.doc.height+Ey(h),L=u.top<f,A=u.bottom>T-f;if(u.top<g)w.scrollTop=L?0:u.top;else if(u.bottom>g+S){var F=Math.min(u.top,(A?T:u.bottom)-S);F!=g&&(w.scrollTop=F)}var z=s.options.fixedGutter?0:h.gutters.offsetWidth,Y=s.curOp&&s.curOp.scrollLeft!=null?s.curOp.scrollLeft:h.scroller.scrollLeft-z,K=Ds(s)-h.gutters.offsetWidth,Z=u.right-u.left>K;return Z&&(u.right=u.left+K),u.left<10?w.scrollLeft=0:u.left<Y?w.scrollLeft=Math.max(0,u.left+z-(Z?0:10)):u.right>K+Y-3&&(w.scrollLeft=u.right+(Z?0:10)-K),w}function Wy(s,u){u!=null&&(bf(s),s.curOp.scrollTop=(s.curOp.scrollTop==null?s.doc.scrollTop:s.curOp.scrollTop)+u)}function ql(s){bf(s);var u=s.getCursor();s.curOp.scrollToPos={from:u,to:u,margin:s.options.cursorScrollMargin}}function Ru(s,u,h){(u!=null||h!=null)&&bf(s),u!=null&&(s.curOp.scrollLeft=u),h!=null&&(s.curOp.scrollTop=h)}function dB(s,u){bf(s),s.curOp.scrollToPos=u}function bf(s){var u=s.curOp.scrollToPos;if(u){s.curOp.scrollToPos=null;var h=dT(s,u.from),f=dT(s,u.to);bT(s,h,f,u.margin)}}function bT(s,u,h,f){var g=Gy(s,{left:Math.min(u.left,h.left),top:Math.min(u.top,h.top)-f,right:Math.max(u.right,h.right),bottom:Math.max(u.bottom,h.bottom)+f});Ru(s,g.scrollLeft,g.scrollTop)}function _u(s,u){Math.abs(s.doc.scrollTop-u)<2||(t||Hy(s,{top:u}),xT(s,u,!0),t&&Hy(s),Nu(s,100))}function xT(s,u,h){u=Math.max(0,Math.min(s.display.scroller.scrollHeight-s.display.scroller.clientHeight,u)),!(s.display.scroller.scrollTop==u&&!h)&&(s.doc.scrollTop=u,s.display.scrollbars.setScrollTop(u),s.display.scroller.scrollTop!=u&&(s.display.scroller.scrollTop=u))}function Rs(s,u,h,f){u=Math.max(0,Math.min(u,s.display.scroller.scrollWidth-s.display.scroller.clientWidth)),!((h?u==s.doc.scrollLeft:Math.abs(s.doc.scrollLeft-u)<2)&&!f)&&(s.doc.scrollLeft=u,LT(s),s.display.scroller.scrollLeft!=u&&(s.display.scroller.scrollLeft=u),s.display.scrollbars.setScrollLeft(u))}function Vu(s){var u=s.display,h=u.gutters.offsetWidth,f=Math.round(s.doc.height+Ey(s.display));return{clientHeight:u.scroller.clientHeight,viewHeight:u.wrapper.clientHeight,scrollWidth:u.scroller.scrollWidth,clientWidth:u.scroller.clientWidth,viewWidth:u.wrapper.clientWidth,barLeft:s.options.fixedGutter?h:0,docHeight:f,scrollHeight:f+da(s)+u.barHeight,nativeBarWidth:u.nativeBarWidth,gutterWidth:h}}var _s=function(s,u,h){this.cm=h;var f=this.vert=U("div",[U("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),g=this.horiz=U("div",[U("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");f.tabIndex=g.tabIndex=-1,s(f),s(g),Ve(f,"scroll",function(){f.clientHeight&&u(f.scrollTop,"vertical")}),Ve(g,"scroll",function(){g.clientWidth&&u(g.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,o&&l<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};_s.prototype.update=function(s){var u=s.scrollWidth>s.clientWidth+1,h=s.scrollHeight>s.clientHeight+1,f=s.nativeBarWidth;if(h){this.vert.style.display="block",this.vert.style.bottom=u?f+"px":"0";var g=s.viewHeight-(u?f:0);this.vert.firstChild.style.height=Math.max(0,s.scrollHeight-s.clientHeight+g)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(u){this.horiz.style.display="block",this.horiz.style.right=h?f+"px":"0",this.horiz.style.left=s.barLeft+"px";var S=s.viewWidth-s.barLeft-(h?f:0);this.horiz.firstChild.style.width=Math.max(0,s.scrollWidth-s.clientWidth+S)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&s.clientHeight>0&&(f==0&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:h?f:0,bottom:u?f:0}},_s.prototype.setScrollLeft=function(s){this.horiz.scrollLeft!=s&&(this.horiz.scrollLeft=s),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},_s.prototype.setScrollTop=function(s){this.vert.scrollTop!=s&&(this.vert.scrollTop=s),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},_s.prototype.zeroWidthHack=function(){var s=D&&!v?"12px":"18px";this.horiz.style.height=this.vert.style.width=s,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new Ze,this.disableVert=new Ze},_s.prototype.enableZeroWidthBar=function(s,u,h){s.style.pointerEvents="auto";function f(){var g=s.getBoundingClientRect(),S=h=="vert"?document.elementFromPoint(g.right-1,(g.top+g.bottom)/2):document.elementFromPoint((g.right+g.left)/2,g.bottom-1);S!=s?s.style.pointerEvents="none":u.set(1e3,f)}u.set(1e3,f)},_s.prototype.clear=function(){var s=this.horiz.parentNode;s.removeChild(this.horiz),s.removeChild(this.vert)};var Ou=function(){};Ou.prototype.update=function(){return{bottom:0,right:0}},Ou.prototype.setScrollLeft=function(){},Ou.prototype.setScrollTop=function(){},Ou.prototype.clear=function(){};function Jl(s,u){u||(u=Vu(s));var h=s.display.barWidth,f=s.display.barHeight;CT(s,u);for(var g=0;g<4&&h!=s.display.barWidth||f!=s.display.barHeight;g++)h!=s.display.barWidth&&s.options.lineWrapping&&vf(s),CT(s,Vu(s)),h=s.display.barWidth,f=s.display.barHeight}function CT(s,u){var h=s.display,f=h.scrollbars.update(u);h.sizer.style.paddingRight=(h.barWidth=f.right)+"px",h.sizer.style.paddingBottom=(h.barHeight=f.bottom)+"px",h.heightForcer.style.borderBottom=f.bottom+"px solid transparent",f.right&&f.bottom?(h.scrollbarFiller.style.display="block",h.scrollbarFiller.style.height=f.bottom+"px",h.scrollbarFiller.style.width=f.right+"px"):h.scrollbarFiller.style.display="",f.bottom&&s.options.coverGutterNextToScrollbar&&s.options.fixedGutter?(h.gutterFiller.style.display="block",h.gutterFiller.style.height=f.bottom+"px",h.gutterFiller.style.width=u.gutterWidth+"px"):h.gutterFiller.style.display=""}var wT={native:_s,null:Ou};function TT(s){s.display.scrollbars&&(s.display.scrollbars.clear(),s.display.scrollbars.addClass&&B(s.display.wrapper,s.display.scrollbars.addClass)),s.display.scrollbars=new wT[s.options.scrollbarStyle](function(u){s.display.wrapper.insertBefore(u,s.display.scrollbarFiller),Ve(u,"mousedown",function(){s.state.focused&&setTimeout(function(){return s.display.input.focus()},0)}),u.setAttribute("cm-not-content","true")},function(u,h){h=="horizontal"?Rs(s,u):_u(s,u)},s),s.display.scrollbars.addClass&&me(s.display.wrapper,s.display.scrollbars.addClass)}var pB=0;function Vs(s){s.curOp={cm:s,viewChanged:!1,startHeight:s.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++pB,markArrays:null},zN(s.curOp)}function Os(s){var u=s.curOp;u&&$N(u,function(h){for(var f=0;f<h.ops.length;f++)h.ops[f].cm.curOp=null;fB(h)})}function fB(s){for(var u=s.ops,h=0;h<u.length;h++)hB(u[h]);for(var f=0;f<u.length;f++)mB(u[f]);for(var g=0;g<u.length;g++)gB(u[g]);for(var S=0;S<u.length;S++)yB(u[S]);for(var w=0;w<u.length;w++)vB(u[w])}function hB(s){var u=s.cm,h=u.display;bB(u),s.updateMaxLine&&ky(u),s.mustUpdate=s.viewChanged||s.forceUpdate||s.scrollTop!=null||s.scrollToPos&&(s.scrollToPos.from.line<h.viewFrom||s.scrollToPos.to.line>=h.viewTo)||h.maxLineChanged&&u.options.lineWrapping,s.update=s.mustUpdate&&new xf(u,s.mustUpdate&&{top:s.scrollTop,ensure:s.scrollToPos},s.forceUpdate)}function mB(s){s.updatedDisplay=s.mustUpdate&&zy(s.cm,s.update)}function gB(s){var u=s.cm,h=u.display;s.updatedDisplay&&vf(u),s.barMeasure=Vu(u),h.maxLineChanged&&!u.options.lineWrapping&&(s.adjustWidthTo=rT(u,h.maxLine,h.maxLine.text.length).left+3,u.display.sizerWidth=s.adjustWidthTo,s.barMeasure.scrollWidth=Math.max(h.scroller.clientWidth,h.sizer.offsetLeft+s.adjustWidthTo+da(u)+u.display.barWidth),s.maxScrollLeft=Math.max(0,h.sizer.offsetLeft+s.adjustWidthTo-Ds(u))),(s.updatedDisplay||s.selectionChanged)&&(s.preparedSelection=h.input.prepareSelection())}function yB(s){var u=s.cm;s.adjustWidthTo!=null&&(u.display.sizer.style.minWidth=s.adjustWidthTo+"px",s.maxScrollLeft<u.doc.scrollLeft&&Rs(u,Math.min(u.display.scroller.scrollLeft,s.maxScrollLeft),!0),u.display.maxLineChanged=!1);var h=s.focus&&s.focus==pe();s.preparedSelection&&u.display.input.showSelection(s.preparedSelection,h),(s.updatedDisplay||s.startHeight!=u.doc.height)&&Jl(u,s.barMeasure),s.updatedDisplay&&jy(u,s.barMeasure),s.selectionChanged&&By(u),u.state.focused&&s.updateInput&&u.display.input.reset(s.typing),h&&vT(s.cm)}function vB(s){var u=s.cm,h=u.display,f=u.doc;if(s.updatedDisplay&&kT(u,s.update),h.wheelStartX!=null&&(s.scrollTop!=null||s.scrollLeft!=null||s.scrollToPos)&&(h.wheelStartX=h.wheelStartY=null),s.scrollTop!=null&&xT(u,s.scrollTop,s.forceScroll),s.scrollLeft!=null&&Rs(u,s.scrollLeft,!0,!0),s.scrollToPos){var g=cB(u,ve(f,s.scrollToPos.from),ve(f,s.scrollToPos.to),s.scrollToPos.margin);lB(u,g)}var S=s.maybeHiddenMarkers,w=s.maybeUnhiddenMarkers;if(S)for(var T=0;T<S.length;++T)S[T].lines.length||Ue(S[T],"hide");if(w)for(var L=0;L<w.length;++L)w[L].lines.length&&Ue(w[L],"unhide");h.wrapper.offsetHeight&&(f.scrollTop=u.display.scroller.scrollTop),s.changeObjs&&Ue(u,"changes",u,s.changeObjs),s.update&&s.update.finish()}function Ar(s,u){if(s.curOp)return u();Vs(s);try{return u()}finally{Os(s)}}function un(s,u){return function(){if(s.curOp)return u.apply(s,arguments);Vs(s);try{return u.apply(s,arguments)}finally{Os(s)}}}function er(s){return function(){if(this.curOp)return s.apply(this,arguments);Vs(this);try{return s.apply(this,arguments)}finally{Os(this)}}}function dn(s){return function(){var u=this.cm;if(!u||u.curOp)return s.apply(this,arguments);Vs(u);try{return s.apply(this,arguments)}finally{Os(u)}}}function Nu(s,u){s.doc.highlightFrontier<s.display.viewTo&&s.state.highlight.set(u,Te(SB,s))}function SB(s){var u=s.doc;if(!(u.highlightFrontier>=s.display.viewTo)){var h=+new Date+s.options.workTime,f=Lu(s,u.highlightFrontier),g=[];u.iter(f.line,Math.min(u.first+u.size,s.display.viewTo+500),function(S){if(f.line>=s.display.viewFrom){var w=S.styles,T=S.text.length>s.options.maxHighlightLength?zr(u.mode,f.state):null,L=I0(s,S,f,!0);T&&(f.state=T),S.styles=L.styles;var A=S.styleClasses,F=L.classes;F?S.styleClasses=F:A&&(S.styleClasses=null);for(var z=!w||w.length!=S.styles.length||A!=F&&(!A||!F||A.bgClass!=F.bgClass||A.textClass!=F.textClass),Y=0;!z&&Y<w.length;++Y)z=w[Y]!=S.styles[Y];z&&g.push(f.line),S.stateAfter=f.save(),f.nextLine()}else S.text.length<=s.options.maxHighlightLength&&Sy(s,S.text,f),S.stateAfter=f.line%5==0?f.save():null,f.nextLine();if(+new Date>h)return Nu(s,s.options.workDelay),!0}),u.highlightFrontier=f.line,u.modeFrontier=Math.max(u.modeFrontier,f.line),g.length&&Ar(s,function(){for(var S=0;S<g.length;S++)Mo(s,g[S],"text")})}}var xf=function(s,u,h){var f=s.display;this.viewport=u,this.visible=Sf(f,s.doc,u),this.editorIsHidden=!f.wrapper.offsetWidth,this.wrapperHeight=f.wrapper.clientHeight,this.wrapperWidth=f.wrapper.clientWidth,this.oldDisplayWidth=Ds(s),this.force=h,this.dims=Vy(s),this.events=[]};xf.prototype.signal=function(s,u){kn(s,u)&&this.events.push(arguments)},xf.prototype.finish=function(){for(var s=0;s<this.events.length;s++)Ue.apply(null,this.events[s])};function bB(s){var u=s.display;!u.scrollbarsClipped&&u.scroller.offsetWidth&&(u.nativeBarWidth=u.scroller.offsetWidth-u.scroller.clientWidth,u.heightForcer.style.height=da(s)+"px",u.sizer.style.marginBottom=-u.nativeBarWidth+"px",u.sizer.style.borderRightWidth=da(s)+"px",u.scrollbarsClipped=!0)}function xB(s){if(s.hasFocus())return null;var u=pe();if(!u||!ne(s.display.lineDiv,u))return null;var h={activeElt:u};if(window.getSelection){var f=window.getSelection();f.anchorNode&&f.extend&&ne(s.display.lineDiv,f.anchorNode)&&(h.anchorNode=f.anchorNode,h.anchorOffset=f.anchorOffset,h.focusNode=f.focusNode,h.focusOffset=f.focusOffset)}return h}function CB(s){if(!(!s||!s.activeElt||s.activeElt==pe())&&(s.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(s.activeElt.nodeName)&&s.anchorNode&&ne(document.body,s.anchorNode)&&ne(document.body,s.focusNode))){var u=window.getSelection(),h=document.createRange();h.setEnd(s.anchorNode,s.anchorOffset),h.collapse(!1),u.removeAllRanges(),u.addRange(h),u.extend(s.focusNode,s.focusOffset)}}function zy(s,u){var h=s.display,f=s.doc;if(u.editorIsHidden)return Ro(s),!1;if(!u.force&&u.visible.from>=h.viewFrom&&u.visible.to<=h.viewTo&&(h.updateLineNumbers==null||h.updateLineNumbers>=h.viewTo)&&h.renderedView==h.view&&mT(s)==0)return!1;ET(s)&&(Ro(s),u.dims=Vy(s));var g=f.first+f.size,S=Math.max(u.visible.from-s.options.viewportMargin,f.first),w=Math.min(g,u.visible.to+s.options.viewportMargin);h.viewFrom<S&&S-h.viewFrom<20&&(S=Math.max(f.first,h.viewFrom)),h.viewTo>w&&h.viewTo-w<20&&(w=Math.min(g,h.viewTo)),ja&&(S=wy(s.doc,S),w=$0(s.doc,w));var T=S!=h.viewFrom||w!=h.viewTo||h.lastWrapHeight!=u.wrapperHeight||h.lastWrapWidth!=u.wrapperWidth;oB(s,S,w),h.viewOffset=qa(ke(s.doc,h.viewFrom)),s.display.mover.style.top=h.viewOffset+"px";var L=mT(s);if(!T&&L==0&&!u.force&&h.renderedView==h.view&&(h.updateLineNumbers==null||h.updateLineNumbers>=h.viewTo))return!1;var A=xB(s);return L>4&&(h.lineDiv.style.display="none"),wB(s,h.updateLineNumbers,u.dims),L>4&&(h.lineDiv.style.display=""),h.renderedView=h.view,CB(A),W(h.cursorDiv),W(h.selectionDiv),h.gutters.style.height=h.sizer.style.minHeight=0,T&&(h.lastWrapHeight=u.wrapperHeight,h.lastWrapWidth=u.wrapperWidth,Nu(s,400)),h.updateLineNumbers=null,!0}function kT(s,u){for(var h=u.viewport,f=!0;;f=!1){if(!f||!s.options.lineWrapping||u.oldDisplayWidth==Ds(s)){if(h&&h.top!=null&&(h={top:Math.min(s.doc.height+Ey(s.display)-Py(s),h.top)}),u.visible=Sf(s.display,s.doc,h),u.visible.from>=s.display.viewFrom&&u.visible.to<=s.display.viewTo)break}else f&&(u.visible=Sf(s.display,s.doc,h));if(!zy(s,u))break;vf(s);var g=Vu(s);Mu(s),Jl(s,g),jy(s,g),u.force=!1}u.signal(s,"update",s),(s.display.viewFrom!=s.display.reportedViewFrom||s.display.viewTo!=s.display.reportedViewTo)&&(u.signal(s,"viewportChange",s,s.display.viewFrom,s.display.viewTo),s.display.reportedViewFrom=s.display.viewFrom,s.display.reportedViewTo=s.display.viewTo)}function Hy(s,u){var h=new xf(s,u);if(zy(s,h)){vf(s),kT(s,h);var f=Vu(s);Mu(s),Jl(s,f),jy(s,f),h.finish()}}function wB(s,u,h){var f=s.display,g=s.options.lineNumbers,S=f.lineDiv,w=S.firstChild;function T(Z){var ie=Z.nextSibling;return c&&D&&s.display.currentWheelTarget==Z?Z.style.display="none":Z.parentNode.removeChild(Z),ie}for(var L=f.view,A=f.viewFrom,F=0;F<L.length;F++){var z=L[F];if(!z.hidden)if(!z.node||z.node.parentNode!=S){var Y=YN(s,z,A,h);S.insertBefore(Y,w)}else{for(;w!=z.node;)w=T(w);var K=g&&u!=null&&u<=A&&z.lineNumber;z.changes&&(ge(z.changes,"gutter")>-1&&(K=!1),Y0(s,z,A,h)),K&&(W(z.lineNumber),z.lineNumber.appendChild(document.createTextNode(ku(s.options,A)))),w=z.node.nextSibling}A+=z.size}for(;w;)w=T(w)}function $y(s){var u=s.gutters.offsetWidth;s.sizer.style.marginLeft=u+"px",cn(s,"gutterChanged",s)}function jy(s,u){s.display.sizer.style.minHeight=u.docHeight+"px",s.display.heightForcer.style.top=u.docHeight+"px",s.display.gutters.style.height=u.docHeight+s.display.barHeight+da(s)+"px"}function LT(s){var u=s.display,h=u.view;if(!(!u.alignWidgets&&(!u.gutters.firstChild||!s.options.fixedGutter))){for(var f=Oy(u)-u.scroller.scrollLeft+s.doc.scrollLeft,g=u.gutters.offsetWidth,S=f+"px",w=0;w<h.length;w++)if(!h[w].hidden){s.options.fixedGutter&&(h[w].gutter&&(h[w].gutter.style.left=S),h[w].gutterBackground&&(h[w].gutterBackground.style.left=S));var T=h[w].alignable;if(T)for(var L=0;L<T.length;L++)T[L].style.left=S}s.options.fixedGutter&&(u.gutters.style.left=f+g+"px")}}function ET(s){if(!s.options.lineNumbers)return!1;var u=s.doc,h=ku(s.options,u.first+u.size-1),f=s.display;if(h.length!=f.lineNumChars){var g=f.measure.appendChild(U("div",[U("div",h)],"CodeMirror-linenumber CodeMirror-gutter-elt")),S=g.firstChild.offsetWidth,w=g.offsetWidth-S;return f.lineGutter.style.width="",f.lineNumInnerWidth=Math.max(S,f.lineGutter.offsetWidth-w)+1,f.lineNumWidth=f.lineNumInnerWidth+w,f.lineNumChars=f.lineNumInnerWidth?h.length:-1,f.lineGutter.style.width=f.lineNumWidth+"px",$y(s.display),!0}return!1}function qy(s,u){for(var h=[],f=!1,g=0;g<s.length;g++){var S=s[g],w=null;if(typeof S!="string"&&(w=S.style,S=S.className),S=="CodeMirror-linenumbers")if(u)f=!0;else continue;h.push({className:S,style:w})}return u&&!f&&h.push({className:"CodeMirror-linenumbers",style:null}),h}function PT(s){var u=s.gutters,h=s.gutterSpecs;W(u),s.lineGutter=null;for(var f=0;f<h.length;++f){var g=h[f],S=g.className,w=g.style,T=u.appendChild(U("div",null,"CodeMirror-gutter "+S));w&&(T.style.cssText=w),S=="CodeMirror-linenumbers"&&(s.lineGutter=T,T.style.width=(s.lineNumWidth||1)+"px")}u.style.display=h.length?"":"none",$y(s)}function Bu(s){PT(s.display),fr(s),LT(s)}function TB(s,u,h,f){var g=this;this.input=h,g.scrollbarFiller=U("div",null,"CodeMirror-scrollbar-filler"),g.scrollbarFiller.setAttribute("cm-not-content","true"),g.gutterFiller=U("div",null,"CodeMirror-gutter-filler"),g.gutterFiller.setAttribute("cm-not-content","true"),g.lineDiv=N("div",null,"CodeMirror-code"),g.selectionDiv=U("div",null,null,"position: relative; z-index: 1"),g.cursorDiv=U("div",null,"CodeMirror-cursors"),g.measure=U("div",null,"CodeMirror-measure"),g.lineMeasure=U("div",null,"CodeMirror-measure"),g.lineSpace=N("div",[g.measure,g.lineMeasure,g.selectionDiv,g.cursorDiv,g.lineDiv],null,"position: relative; outline: none");var S=N("div",[g.lineSpace],"CodeMirror-lines");g.mover=U("div",[S],null,"position: relative"),g.sizer=U("div",[g.mover],"CodeMirror-sizer"),g.sizerWidth=null,g.heightForcer=U("div",null,null,"position: absolute; height: "+Le+"px; width: 1px;"),g.gutters=U("div",null,"CodeMirror-gutters"),g.lineGutter=null,g.scroller=U("div",[g.sizer,g.heightForcer,g.gutters],"CodeMirror-scroll"),g.scroller.setAttribute("tabIndex","-1"),g.wrapper=U("div",[g.scrollbarFiller,g.gutterFiller,g.scroller],"CodeMirror"),o&&l<8&&(g.gutters.style.zIndex=-1,g.scroller.style.paddingRight=0),!c&&!(t&&k)&&(g.scroller.draggable=!0),s&&(s.appendChild?s.appendChild(g.wrapper):s(g.wrapper)),g.viewFrom=g.viewTo=u.first,g.reportedViewFrom=g.reportedViewTo=u.first,g.view=[],g.renderedView=null,g.externalMeasured=null,g.viewOffset=0,g.lastWrapHeight=g.lastWrapWidth=0,g.updateLineNumbers=null,g.nativeBarWidth=g.barHeight=g.barWidth=0,g.scrollbarsClipped=!1,g.lineNumWidth=g.lineNumInnerWidth=g.lineNumChars=null,g.alignWidgets=!1,g.cachedCharWidth=g.cachedTextHeight=g.cachedPaddingH=null,g.maxLine=null,g.maxLineLength=0,g.maxLineChanged=!1,g.wheelDX=g.wheelDY=g.wheelStartX=g.wheelStartY=null,g.shift=!1,g.selForContextMenu=null,g.activeTouch=null,g.gutterSpecs=qy(f.gutters,f.lineNumbers),PT(g),h.init(g)}var Cf=0,$r=null;o?$r=-.53:t?$r=15:p?$r=-.7:y&&($r=-1/3);function DT(s){var u=s.wheelDeltaX,h=s.wheelDeltaY;return u==null&&s.detail&&s.axis==s.HORIZONTAL_AXIS&&(u=s.detail),h==null&&s.detail&&s.axis==s.VERTICAL_AXIS?h=s.detail:h==null&&(h=s.wheelDelta),{x:u,y:h}}function kB(s){var u=DT(s);return u.x*=$r,u.y*=$r,u}function AT(s,u){var h=DT(u),f=h.x,g=h.y,S=s.display,w=S.scroller,T=w.scrollWidth>w.clientWidth,L=w.scrollHeight>w.clientHeight;if(!!(f&&T||g&&L)){if(g&&D&&c){e:for(var A=u.target,F=S.view;A!=w;A=A.parentNode)for(var z=0;z<F.length;z++)if(F[z].node==A){s.display.currentWheelTarget=A;break e}}if(f&&!t&&!m&&$r!=null){g&&L&&_u(s,Math.max(0,w.scrollTop+g*$r)),Rs(s,Math.max(0,w.scrollLeft+f*$r)),(!g||g&&L)&&Un(u),S.wheelStartX=null;return}if(g&&$r!=null){var Y=g*$r,K=s.doc.scrollTop,Z=K+S.wrapper.clientHeight;Y<0?K=Math.max(0,K+Y-50):Z=Math.min(s.doc.height,Z+Y+50),Hy(s,{top:K,bottom:Z})}Cf<20&&(S.wheelStartX==null?(S.wheelStartX=w.scrollLeft,S.wheelStartY=w.scrollTop,S.wheelDX=f,S.wheelDY=g,setTimeout(function(){if(S.wheelStartX!=null){var ie=w.scrollLeft-S.wheelStartX,de=w.scrollTop-S.wheelStartY,fe=de&&S.wheelDY&&de/S.wheelDY||ie&&S.wheelDX&&ie/S.wheelDX;S.wheelStartX=S.wheelStartY=null,!!fe&&($r=($r*Cf+fe)/(Cf+1),++Cf)}},200)):(S.wheelDX+=f,S.wheelDY+=g))}}var jr=function(s,u){this.ranges=s,this.primIndex=u};jr.prototype.primary=function(){return this.ranges[this.primIndex]},jr.prototype.equals=function(s){if(s==this)return!0;if(s.primIndex!=this.primIndex||s.ranges.length!=this.ranges.length)return!1;for(var u=0;u<this.ranges.length;u++){var h=this.ranges[u],f=s.ranges[u];if(!$(h.anchor,f.anchor)||!$(h.head,f.head))return!1}return!0},jr.prototype.deepCopy=function(){for(var s=[],u=0;u<this.ranges.length;u++)s[u]=new ft(te(this.ranges[u].anchor),te(this.ranges[u].head));return new jr(s,this.primIndex)},jr.prototype.somethingSelected=function(){for(var s=0;s<this.ranges.length;s++)if(!this.ranges[s].empty())return!0;return!1},jr.prototype.contains=function(s,u){u||(u=s);for(var h=0;h<this.ranges.length;h++){var f=this.ranges[h];if(R(u,f.from())>=0&&R(s,f.to())<=0)return h}return-1};var ft=function(s,u){this.anchor=s,this.head=u};ft.prototype.from=function(){return Fe(this.anchor,this.head)},ft.prototype.to=function(){return ue(this.anchor,this.head)},ft.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};function Di(s,u,h){var f=s&&s.options.selectionsMayTouch,g=u[h];u.sort(function(Y,K){return R(Y.from(),K.from())}),h=ge(u,g);for(var S=1;S<u.length;S++){var w=u[S],T=u[S-1],L=R(T.to(),w.from());if(f&&!w.empty()?L>0:L>=0){var A=Fe(T.from(),w.from()),F=ue(T.to(),w.to()),z=T.empty()?w.from()==w.head:T.from()==T.head;S<=h&&--h,u.splice(--S,2,new ft(z?F:A,z?A:F))}}return new jr(u,h)}function _o(s,u){return new jr([new ft(s,u||s)],0)}function Vo(s){return s.text?oe(s.from.line+s.text.length-1,tt(s.text).length+(s.text.length==1?s.from.ch:0)):s.to}function IT(s,u){if(R(s,u.from)<0)return s;if(R(s,u.to)<=0)return Vo(u);var h=s.line+u.text.length-(u.to.line-u.from.line)-1,f=s.ch;return s.line==u.to.line&&(f+=Vo(u).ch-u.to.ch),oe(h,f)}function Jy(s,u){for(var h=[],f=0;f<s.sel.ranges.length;f++){var g=s.sel.ranges[f];h.push(new ft(IT(g.anchor,u),IT(g.head,u)))}return Di(s.cm,h,s.sel.primIndex)}function MT(s,u,h){return s.line==u.line?oe(h.line,s.ch-u.ch+h.ch):oe(h.line+(s.line-u.line),s.ch)}function LB(s,u,h){for(var f=[],g=oe(s.first,0),S=g,w=0;w<u.length;w++){var T=u[w],L=MT(T.from,g,S),A=MT(Vo(T),g,S);if(g=T.to,S=A,h=="around"){var F=s.sel.ranges[w],z=R(F.head,F.anchor)<0;f[w]=new ft(z?A:L,z?L:A)}else f[w]=new ft(L,L)}return new jr(f,s.sel.primIndex)}function Ky(s){s.doc.mode=Ul(s.options,s.doc.modeOption),Uu(s)}function Uu(s){s.doc.iter(function(u){u.stateAfter&&(u.stateAfter=null),u.styles&&(u.styles=null)}),s.doc.modeFrontier=s.doc.highlightFrontier=s.doc.first,Nu(s,100),s.state.modeGen++,s.curOp&&fr(s)}function RT(s,u){return u.from.ch==0&&u.to.ch==0&&tt(u.text)==""&&(!s.cm||s.cm.options.wholeLineUpdateBefore)}function Yy(s,u,h,f){function g(Se){return h?h[Se]:null}function S(Se,he,xe){_N(Se,he,xe,f),cn(Se,"change",Se,u)}function w(Se,he){for(var xe=[],De=Se;De<he;++De)xe.push(new Gl(A[De],g(De),f));return xe}var T=u.from,L=u.to,A=u.text,F=ke(s,T.line),z=ke(s,L.line),Y=tt(A),K=g(A.length-1),Z=L.line-T.line;if(u.full)s.insert(0,w(0,A.length)),s.remove(A.length,s.size-A.length);else if(RT(s,u)){var ie=w(0,A.length-1);S(z,z.text,K),Z&&s.remove(T.line,Z),ie.length&&s.insert(T.line,ie)}else if(F==z)if(A.length==1)S(F,F.text.slice(0,T.ch)+Y+F.text.slice(L.ch),K);else{var de=w(1,A.length-1);de.push(new Gl(Y+F.text.slice(L.ch),K,f)),S(F,F.text.slice(0,T.ch)+A[0],g(0)),s.insert(T.line+1,de)}else if(A.length==1)S(F,F.text.slice(0,T.ch)+A[0]+z.text.slice(L.ch),g(0)),s.remove(T.line+1,Z);else{S(F,F.text.slice(0,T.ch)+A[0],g(0)),S(z,Y+z.text.slice(L.ch),K);var fe=w(1,A.length-1);Z>1&&s.remove(T.line+1,Z-1),s.insert(T.line+1,fe)}cn(s,"change",s,u)}function Oo(s,u,h){function f(g,S,w){if(g.linked)for(var T=0;T<g.linked.length;++T){var L=g.linked[T];if(L.doc!=S){var A=w&&L.sharedHist;h&&!A||(u(L.doc,A),f(L.doc,g,A))}}}f(s,null,!0)}function _T(s,u){if(u.cm)throw new Error("This document is already in use.");s.doc=u,u.cm=s,Ny(s),Ky(s),VT(s),s.options.direction=u.direction,s.options.lineWrapping||ky(s),s.options.mode=u.modeOption,fr(s)}function VT(s){(s.doc.direction=="rtl"?me:B)(s.display.lineDiv,"CodeMirror-rtl")}function EB(s){Ar(s,function(){VT(s),fr(s)})}function wf(s){this.done=[],this.undone=[],this.undoDepth=s?s.undoDepth:Infinity,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=s?s.maxGeneration:1}function Xy(s,u){var h={from:te(u.from),to:Vo(u),text:sa(s,u.from,u.to)};return BT(s,h,u.from.line,u.to.line+1),Oo(s,function(f){return BT(f,h,u.from.line,u.to.line+1)},!0),h}function OT(s){for(;s.length;){var u=tt(s);if(u.ranges)s.pop();else break}}function PB(s,u){if(u)return OT(s.done),tt(s.done);if(s.done.length&&!tt(s.done).ranges)return tt(s.done);if(s.done.length>1&&!s.done[s.done.length-2].ranges)return s.done.pop(),tt(s.done)}function NT(s,u,h,f){var g=s.history;g.undone.length=0;var S=+new Date,w,T;if((g.lastOp==f||g.lastOrigin==u.origin&&u.origin&&(u.origin.charAt(0)=="+"&&g.lastModTime>S-(s.cm?s.cm.options.historyEventDelay:500)||u.origin.charAt(0)=="*"))&&(w=PB(g,g.lastOp==f)))T=tt(w.changes),R(u.from,u.to)==0&&R(u.from,T.to)==0?T.to=Vo(u):w.changes.push(Xy(s,u));else{var L=tt(g.done);for((!L||!L.ranges)&&Tf(s.sel,g.done),w={changes:[Xy(s,u)],generation:g.generation},g.done.push(w);g.done.length>g.undoDepth;)g.done.shift(),g.done[0].ranges||g.done.shift()}g.done.push(h),g.generation=++g.maxGeneration,g.lastModTime=g.lastSelTime=S,g.lastOp=g.lastSelOp=f,g.lastOrigin=g.lastSelOrigin=u.origin,T||Ue(s,"historyAdded")}function DB(s,u,h,f){var g=u.charAt(0);return g=="*"||g=="+"&&h.ranges.length==f.ranges.length&&h.somethingSelected()==f.somethingSelected()&&new Date-s.history.lastSelTime<=(s.cm?s.cm.options.historyEventDelay:500)}function AB(s,u,h,f){var g=s.history,S=f&&f.origin;h==g.lastSelOp||S&&g.lastSelOrigin==S&&(g.lastModTime==g.lastSelTime&&g.lastOrigin==S||DB(s,S,tt(g.done),u))?g.done[g.done.length-1]=u:Tf(u,g.done),g.lastSelTime=+new Date,g.lastSelOrigin=S,g.lastSelOp=h,f&&f.clearRedo!==!1&&OT(g.undone)}function Tf(s,u){var h=tt(u);h&&h.ranges&&h.equals(s)||u.push(s)}function BT(s,u,h,f){var g=u["spans_"+s.id],S=0;s.iter(Math.max(s.first,h),Math.min(s.first+s.size,f),function(w){w.markedSpans&&((g||(g=u["spans_"+s.id]={}))[S]=w.markedSpans),++S})}function IB(s){if(!s)return null;for(var u,h=0;h<s.length;++h)s[h].marker.explicitlyCleared?u||(u=s.slice(0,h)):u&&u.push(s[h]);return u?u.length?u:null:s}function MB(s,u){var h=u["spans_"+s.id];if(!h)return null;for(var f=[],g=0;g<u.text.length;++g)f.push(IB(h[g]));return f}function UT(s,u){var h=MB(s,u),f=xy(s,u);if(!h)return f;if(!f)return h;for(var g=0;g<h.length;++g){var S=h[g],w=f[g];if(S&&w){e:for(var T=0;T<w.length;++T){for(var L=w[T],A=0;A<S.length;++A)if(S[A].marker==L.marker)continue e;S.push(L)}}else w&&(h[g]=w)}return h}function Kl(s,u,h){for(var f=[],g=0;g<s.length;++g){var S=s[g];if(S.ranges){f.push(h?jr.prototype.deepCopy.call(S):S);continue}var w=S.changes,T=[];f.push({changes:T});for(var L=0;L<w.length;++L){var A=w[L],F=void 0;if(T.push({from:A.from,to:A.to,text:A.text}),u)for(var z in A)(F=z.match(/^spans_(\d+)$/))&&ge(u,Number(F[1]))>-1&&(tt(T)[z]=A[z],delete A[z])}}return f}function Qy(s,u,h,f){if(f){var g=s.anchor;if(h){var S=R(u,g)<0;S!=R(h,g)<0?(g=u,u=h):S!=R(u,h)<0&&(u=h)}return new ft(g,u)}else return new ft(h||u,u)}function kf(s,u,h,f,g){g==null&&(g=s.cm&&(s.cm.display.shift||s.extend)),Gn(s,new jr([Qy(s.sel.primary(),u,h,g)],0),f)}function FT(s,u,h){for(var f=[],g=s.cm&&(s.cm.display.shift||s.extend),S=0;S<s.sel.ranges.length;S++)f[S]=Qy(s.sel.ranges[S],u[S],null,g);var w=Di(s.cm,f,s.sel.primIndex);Gn(s,w,h)}function Zy(s,u,h,f){var g=s.sel.ranges.slice(0);g[u]=h,Gn(s,Di(s.cm,g,s.sel.primIndex),f)}function GT(s,u,h,f){Gn(s,_o(u,h),f)}function RB(s,u,h){var f={ranges:u.ranges,update:function(g){this.ranges=[];for(var S=0;S<g.length;S++)this.ranges[S]=new ft(ve(s,g[S].anchor),ve(s,g[S].head))},origin:h&&h.origin};return Ue(s,"beforeSelectionChange",s,f),s.cm&&Ue(s.cm,"beforeSelectionChange",s.cm,f),f.ranges!=u.ranges?Di(s.cm,f.ranges,f.ranges.length-1):u}function WT(s,u,h){var f=s.history.done,g=tt(f);g&&g.ranges?(f[f.length-1]=u,Lf(s,u,h)):Gn(s,u,h)}function Gn(s,u,h){Lf(s,u,h),AB(s,s.sel,s.cm?s.cm.curOp.id:NaN,h)}function Lf(s,u,h){(kn(s,"beforeSelectionChange")||s.cm&&kn(s.cm,"beforeSelectionChange"))&&(u=RB(s,u,h));var f=h&&h.bias||(R(u.primary().head,s.sel.primary().head)<0?-1:1);zT(s,$T(s,u,f,!0)),!(h&&h.scroll===!1)&&s.cm&&s.cm.getOption("readOnly")!="nocursor"&&ql(s.cm)}function zT(s,u){u.equals(s.sel)||(s.sel=u,s.cm&&(s.cm.curOp.updateInput=1,s.cm.curOp.selectionChanged=!0,Ol(s.cm)),cn(s,"cursorActivity",s))}function HT(s){zT(s,$T(s,s.sel,null,!1))}function $T(s,u,h,f){for(var g,S=0;S<u.ranges.length;S++){var w=u.ranges[S],T=u.ranges.length==s.sel.ranges.length&&s.sel.ranges[S],L=Ef(s,w.anchor,T&&T.anchor,h,f),A=Ef(s,w.head,T&&T.head,h,f);(g||L!=w.anchor||A!=w.head)&&(g||(g=u.ranges.slice(0,S)),g[S]=new ft(L,A))}return g?Di(s.cm,g,u.primIndex):u}function Yl(s,u,h,f,g){var S=ke(s,u.line);if(S.markedSpans)for(var w=0;w<S.markedSpans.length;++w){var T=S.markedSpans[w],L=T.marker,A="selectLeft"in L?!L.selectLeft:L.inclusiveLeft,F="selectRight"in L?!L.selectRight:L.inclusiveRight;if((T.from==null||(A?T.from<=u.ch:T.from<u.ch))&&(T.to==null||(F?T.to>=u.ch:T.to>u.ch))){if(g&&(Ue(L,"beforeCursorEnter"),L.explicitlyCleared))if(S.markedSpans){--w;continue}else break;if(!L.atomic)continue;if(h){var z=L.find(f<0?1:-1),Y=void 0;if((f<0?F:A)&&(z=jT(s,z,-f,z&&z.line==u.line?S:null)),z&&z.line==u.line&&(Y=R(z,h))&&(f<0?Y<0:Y>0))return Yl(s,z,u,f,g)}var K=L.find(f<0?-1:1);return(f<0?A:F)&&(K=jT(s,K,f,K.line==u.line?S:null)),K?Yl(s,K,u,f,g):null}}return u}function Ef(s,u,h,f,g){var S=f||1,w=Yl(s,u,h,S,g)||!g&&Yl(s,u,h,S,!0)||Yl(s,u,h,-S,g)||!g&&Yl(s,u,h,-S,!0);return w||(s.cantEdit=!0,oe(s.first,0))}function jT(s,u,h,f){return h<0&&u.ch==0?u.line>s.first?ve(s,oe(u.line-1)):null:h>0&&u.ch==(f||ke(s,u.line)).text.length?u.line<s.first+s.size-1?oe(u.line+1,0):null:new oe(u.line,u.ch+h)}function qT(s){s.setSelection(oe(s.firstLine(),0),oe(s.lastLine()),je)}function JT(s,u,h){var f={canceled:!1,from:u.from,to:u.to,text:u.text,origin:u.origin,cancel:function(){return f.canceled=!0}};return h&&(f.update=function(g,S,w,T){g&&(f.from=ve(s,g)),S&&(f.to=ve(s,S)),w&&(f.text=w),T!==void 0&&(f.origin=T)}),Ue(s,"beforeChange",s,f),s.cm&&Ue(s.cm,"beforeChange",s.cm,f),f.canceled?(s.cm&&(s.cm.curOp.updateInput=2),null):{from:f.from,to:f.to,text:f.text,origin:f.origin}}function Xl(s,u,h){if(s.cm){if(!s.cm.curOp)return un(s.cm,Xl)(s,u,h);if(s.cm.state.suppressEdits)return}if(!((kn(s,"beforeChange")||s.cm&&kn(s.cm,"beforeChange"))&&(u=JT(s,u,!0),!u))){var f=B0&&!h&&AN(s,u.from,u.to);if(f)for(var g=f.length-1;g>=0;--g)KT(s,{from:f[g].from,to:f[g].to,text:g?[""]:u.text,origin:u.origin});else KT(s,u)}}function KT(s,u){if(!(u.text.length==1&&u.text[0]==""&&R(u.from,u.to)==0)){var h=Jy(s,u);NT(s,u,h,s.cm?s.cm.curOp.id:NaN),Fu(s,u,h,xy(s,u));var f=[];Oo(s,function(g,S){!S&&ge(f,g.history)==-1&&(ZT(g.history,u),f.push(g.history)),Fu(g,u,null,xy(g,u))})}}function Pf(s,u,h){var f=s.cm&&s.cm.state.suppressEdits;if(!(f&&!h)){for(var g=s.history,S,w=s.sel,T=u=="undo"?g.done:g.undone,L=u=="undo"?g.undone:g.done,A=0;A<T.length&&(S=T[A],!(h?S.ranges&&!S.equals(s.sel):!S.ranges));A++);if(A!=T.length){for(g.lastOrigin=g.lastSelOrigin=null;;)if(S=T.pop(),S.ranges){if(Tf(S,L),h&&!S.equals(s.sel)){Gn(s,S,{clearRedo:!1});return}w=S}else if(f){T.push(S);return}else break;var F=[];Tf(w,L),L.push({changes:F,generation:g.generation}),g.generation=S.generation||++g.maxGeneration;for(var z=kn(s,"beforeChange")||s.cm&&kn(s.cm,"beforeChange"),Y=function(ie){var de=S.changes[ie];if(de.origin=u,z&&!JT(s,de,!1))return T.length=0,{};F.push(Xy(s,de));var fe=ie?Jy(s,de):tt(T);Fu(s,de,fe,UT(s,de)),!ie&&s.cm&&s.cm.scrollIntoView({from:de.from,to:Vo(de)});var Se=[];Oo(s,function(he,xe){!xe&&ge(Se,he.history)==-1&&(ZT(he.history,de),Se.push(he.history)),Fu(he,de,null,UT(he,de))})},K=S.changes.length-1;K>=0;--K){var Z=Y(K);if(Z)return Z.v}}}}function YT(s,u){if(u!=0&&(s.first+=u,s.sel=new jr(Er(s.sel.ranges,function(g){return new ft(oe(g.anchor.line+u,g.anchor.ch),oe(g.head.line+u,g.head.ch))}),s.sel.primIndex),s.cm)){fr(s.cm,s.first,s.first-u,u);for(var h=s.cm.display,f=h.viewFrom;f<h.viewTo;f++)Mo(s.cm,f,"gutter")}}function Fu(s,u,h,f){if(s.cm&&!s.cm.curOp)return un(s.cm,Fu)(s,u,h,f);if(u.to.line<s.first){YT(s,u.text.length-1-(u.to.line-u.from.line));return}if(!(u.from.line>s.lastLine())){if(u.from.line<s.first){var g=u.text.length-1-(s.first-u.from.line);YT(s,g),u={from:oe(s.first,0),to:oe(u.to.line+g,u.to.ch),text:[tt(u.text)],origin:u.origin}}var S=s.lastLine();u.to.line>S&&(u={from:u.from,to:oe(S,ke(s,S).text.length),text:[u.text[0]],origin:u.origin}),u.removed=sa(s,u.from,u.to),h||(h=Jy(s,u)),s.cm?_B(s.cm,u,f):Yy(s,u,f),Lf(s,h,je),s.cantEdit&&Ef(s,oe(s.firstLine(),0))&&(s.cantEdit=!1)}}function _B(s,u,h){var f=s.doc,g=s.display,S=u.from,w=u.to,T=!1,L=S.line;s.options.lineWrapping||(L=pt(ua(ke(f,S.line))),f.iter(L,w.line+1,function(K){if(K==g.maxLine)return T=!0,!0})),f.sel.contains(u.from,u.to)>-1&&Ol(s),Yy(f,u,h,hT(s)),s.options.lineWrapping||(f.iter(L,S.line+u.text.length,function(K){var Z=pf(K);Z>g.maxLineLength&&(g.maxLine=K,g.maxLineLength=Z,g.maxLineChanged=!0,T=!1)}),T&&(s.curOp.updateMaxLine=!0)),wN(f,S.line),Nu(s,400);var A=u.text.length-(w.line-S.line)-1;u.full?fr(s):S.line==w.line&&u.text.length==1&&!RT(s.doc,u)?Mo(s,S.line,"text"):fr(s,S.line,w.line+1,A);var F=kn(s,"changes"),z=kn(s,"change");if(z||F){var Y={from:S,to:w,text:u.text,removed:u.removed,origin:u.origin};z&&cn(s,"change",s,Y),F&&(s.curOp.changeObjs||(s.curOp.changeObjs=[])).push(Y)}s.display.selForContextMenu=null}function Ql(s,u,h,f,g){var S;f||(f=h),R(f,h)<0&&(S=[f,h],h=S[0],f=S[1]),typeof u=="string"&&(u=s.splitLines(u)),Xl(s,{from:h,to:f,text:u,origin:g})}function XT(s,u,h,f){h<s.line?s.line+=f:u<s.line&&(s.line=u,s.ch=0)}function QT(s,u,h,f){for(var g=0;g<s.length;++g){var S=s[g],w=!0;if(S.ranges){S.copied||(S=s[g]=S.deepCopy(),S.copied=!0);for(var T=0;T<S.ranges.length;T++)XT(S.ranges[T].anchor,u,h,f),XT(S.ranges[T].head,u,h,f);continue}for(var L=0;L<S.changes.length;++L){var A=S.changes[L];if(h<A.from.line)A.from=oe(A.from.line+f,A.from.ch),A.to=oe(A.to.line+f,A.to.ch);else if(u<=A.to.line){w=!1;break}}w||(s.splice(0,g+1),g=0)}}function ZT(s,u){var h=u.from.line,f=u.to.line,g=u.text.length-(f-h)-1;QT(s.done,h,f,g),QT(s.undone,h,f,g)}function Gu(s,u,h,f){var g=u,S=u;return typeof u=="number"?S=ke(s,it(s,u)):g=pt(u),g==null?null:(f(S,g)&&s.cm&&Mo(s.cm,g,h),S)}function Wu(s){this.lines=s,this.parent=null;for(var u=0,h=0;h<s.length;++h)s[h].parent=this,u+=s[h].height;this.height=u}Wu.prototype={chunkSize:function(){return this.lines.length},removeInner:function(s,u){for(var h=s,f=s+u;h<f;++h){var g=this.lines[h];this.height-=g.height,VN(g),cn(g,"delete")}this.lines.splice(s,u)},collapse:function(s){s.push.apply(s,this.lines)},insertInner:function(s,u,h){this.height+=h,this.lines=this.lines.slice(0,s).concat(u).concat(this.lines.slice(s));for(var f=0;f<u.length;++f)u[f].parent=this},iterN:function(s,u,h){for(var f=s+u;s<f;++s)if(h(this.lines[s]))return!0}};function zu(s){this.children=s;for(var u=0,h=0,f=0;f<s.length;++f){var g=s[f];u+=g.chunkSize(),h+=g.height,g.parent=this}this.size=u,this.height=h,this.parent=null}zu.prototype={chunkSize:function(){return this.size},removeInner:function(s,u){this.size-=u;for(var h=0;h<this.children.length;++h){var f=this.children[h],g=f.chunkSize();if(s<g){var S=Math.min(u,g-s),w=f.height;if(f.removeInner(s,S),this.height-=w-f.height,g==S&&(this.children.splice(h--,1),f.parent=null),(u-=S)==0)break;s=0}else s-=g}if(this.size-u<25&&(this.children.length>1||!(this.children[0]instanceof Wu))){var T=[];this.collapse(T),this.children=[new Wu(T)],this.children[0].parent=this}},collapse:function(s){for(var u=0;u<this.children.length;++u)this.children[u].collapse(s)},insertInner:function(s,u,h){this.size+=u.length,this.height+=h;for(var f=0;f<this.children.length;++f){var g=this.children[f],S=g.chunkSize();if(s<=S){if(g.insertInner(s,u,h),g.lines&&g.lines.length>50){for(var w=g.lines.length%25+25,T=w;T<g.lines.length;){var L=new Wu(g.lines.slice(T,T+=25));g.height-=L.height,this.children.splice(++f,0,L),L.parent=this}g.lines=g.lines.slice(0,w),this.maybeSpill()}break}s-=S}},maybeSpill:function(){if(!(this.children.length<=10)){var s=this;do{var u=s.children.splice(s.children.length-5,5),h=new zu(u);if(s.parent){s.size-=h.size,s.height-=h.height;var g=ge(s.parent.children,s);s.parent.children.splice(g+1,0,h)}else{var f=new zu(s.children);f.parent=s,s.children=[f,h],s=f}h.parent=s.parent}while(s.children.length>10);s.parent.maybeSpill()}},iterN:function(s,u,h){for(var f=0;f<this.children.length;++f){var g=this.children[f],S=g.chunkSize();if(s<S){var w=Math.min(u,S-s);if(g.iterN(s,w,h))return!0;if((u-=w)==0)break;s=0}else s-=S}}};var Hu=function(s,u,h){if(h)for(var f in h)h.hasOwnProperty(f)&&(this[f]=h[f]);this.doc=s,this.node=u};Hu.prototype.clear=function(){var s=this.doc.cm,u=this.line.widgets,h=this.line,f=pt(h);if(!(f==null||!u)){for(var g=0;g<u.length;++g)u[g]==this&&u.splice(g--,1);u.length||(h.widgets=null);var S=Au(this);Dr(h,Math.max(0,h.height-S)),s&&(Ar(s,function(){ek(s,h,-S),Mo(s,f,"widget")}),cn(s,"lineWidgetCleared",s,this,f))}},Hu.prototype.changed=function(){var s=this,u=this.height,h=this.doc.cm,f=this.line;this.height=null;var g=Au(this)-u;!g||(Io(this.doc,f)||Dr(f,f.height+g),h&&Ar(h,function(){h.curOp.forceUpdate=!0,ek(h,f,g),cn(h,"lineWidgetChanged",h,s,pt(f))}))},aa(Hu);function ek(s,u,h){qa(u)<(s.curOp&&s.curOp.scrollTop||s.doc.scrollTop)&&Wy(s,h)}function VB(s,u,h,f){var g=new Hu(s,h,f),S=s.cm;return S&&g.noHScroll&&(S.display.alignWidgets=!0),Gu(s,u,"widget",function(w){var T=w.widgets||(w.widgets=[]);if(g.insertAt==null?T.push(g):T.splice(Math.min(T.length,Math.max(0,g.insertAt)),0,g),g.line=w,S&&!Io(s,w)){var L=qa(w)<s.scrollTop;Dr(w,w.height+Au(g)),L&&Wy(S,g.height),S.curOp.forceUpdate=!0}return!0}),S&&cn(S,"lineWidgetAdded",S,g,typeof u=="number"?u:pt(u)),g}var tk=0,No=function(s,u){this.lines=[],this.type=u,this.doc=s,this.id=++tk};No.prototype.clear=function(){if(!this.explicitlyCleared){var s=this.doc.cm,u=s&&!s.curOp;if(u&&Vs(s),kn(this,"clear")){var h=this.find();h&&cn(this,"clear",h.from,h.to)}for(var f=null,g=null,S=0;S<this.lines.length;++S){var w=this.lines[S],T=Eu(w.markedSpans,this);s&&!this.collapsed?Mo(s,pt(w),"text"):s&&(T.to!=null&&(g=pt(w)),T.from!=null&&(f=pt(w))),w.markedSpans=LN(w.markedSpans,T),T.from==null&&this.collapsed&&!Io(this.doc,w)&&s&&Dr(w,Hl(s.display))}if(s&&this.collapsed&&!s.options.lineWrapping)for(var L=0;L<this.lines.length;++L){var A=ua(this.lines[L]),F=pf(A);F>s.display.maxLineLength&&(s.display.maxLine=A,s.display.maxLineLength=F,s.display.maxLineChanged=!0)}f!=null&&s&&this.collapsed&&fr(s,f,g+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,s&&HT(s.doc)),s&&cn(s,"markerCleared",s,this,f,g),u&&Os(s),this.parent&&this.parent.clear()}},No.prototype.find=function(s,u){s==null&&this.type=="bookmark"&&(s=1);for(var h,f,g=0;g<this.lines.length;++g){var S=this.lines[g],w=Eu(S.markedSpans,this);if(w.from!=null&&(h=oe(u?S:pt(S),w.from),s==-1))return h;if(w.to!=null&&(f=oe(u?S:pt(S),w.to),s==1))return f}return h&&{from:h,to:f}},No.prototype.changed=function(){var s=this,u=this.find(-1,!0),h=this,f=this.doc.cm;!u||!f||Ar(f,function(){var g=u.line,S=pt(u.line),w=Dy(f,S);if(w&&(oT(w),f.curOp.selectionChanged=f.curOp.forceUpdate=!0),f.curOp.updateMaxLine=!0,!Io(h.doc,g)&&h.height!=null){var T=h.height;h.height=null;var L=Au(h)-T;L&&Dr(g,g.height+L)}cn(f,"markerChanged",f,s)})},No.prototype.attachLine=function(s){if(!this.lines.length&&this.doc.cm){var u=this.doc.cm.curOp;(!u.maybeHiddenMarkers||ge(u.maybeHiddenMarkers,this)==-1)&&(u.maybeUnhiddenMarkers||(u.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(s)},No.prototype.detachLine=function(s){if(this.lines.splice(ge(this.lines,s),1),!this.lines.length&&this.doc.cm){var u=this.doc.cm.curOp;(u.maybeHiddenMarkers||(u.maybeHiddenMarkers=[])).push(this)}},aa(No);function Zl(s,u,h,f,g){if(f&&f.shared)return OB(s,u,h,f,g);if(s.cm&&!s.cm.curOp)return un(s.cm,Zl)(s,u,h,f,g);var S=new No(s,g),w=R(u,h);if(f&&Ae(f,S,!1),w>0||w==0&&S.clearWhenEmpty!==!1)return S;if(S.replacedWith&&(S.collapsed=!0,S.widgetNode=N("span",[S.replacedWith],"CodeMirror-widget"),f.handleMouseEvents||S.widgetNode.setAttribute("cm-ignore-events","true"),f.insertLeft&&(S.widgetNode.insertLeft=!0)),S.collapsed){if(H0(s,u.line,u,h,S)||u.line!=h.line&&H0(s,h.line,u,h,S))throw new Error("Inserting collapsed marker partially overlapping an existing one");kN()}S.addToHistory&&NT(s,{from:u,to:h,origin:"markText"},s.sel,NaN);var T=u.line,L=s.cm,A;if(s.iter(T,h.line+1,function(z){L&&S.collapsed&&!L.options.lineWrapping&&ua(z)==L.display.maxLine&&(A=!0),S.collapsed&&T!=u.line&&Dr(z,0),EN(z,new lf(S,T==u.line?u.ch:null,T==h.line?h.ch:null),s.cm&&s.cm.curOp),++T}),S.collapsed&&s.iter(u.line,h.line+1,function(z){Io(s,z)&&Dr(z,0)}),S.clearOnEnter&&Ve(S,"beforeCursorEnter",function(){return S.clear()}),S.readOnly&&(TN(),(s.history.done.length||s.history.undone.length)&&s.clearHistory()),S.collapsed&&(S.id=++tk,S.atomic=!0),L){if(A&&(L.curOp.updateMaxLine=!0),S.collapsed)fr(L,u.line,h.line+1);else if(S.className||S.startStyle||S.endStyle||S.css||S.attributes||S.title)for(var F=u.line;F<=h.line;F++)Mo(L,F,"text");S.atomic&&HT(L.doc),cn(L,"markerAdded",L,S)}return S}var $u=function(s,u){this.markers=s,this.primary=u;for(var h=0;h<s.length;++h)s[h].parent=this};$u.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var s=0;s<this.markers.length;++s)this.markers[s].clear();cn(this,"clear")}},$u.prototype.find=function(s,u){return this.primary.find(s,u)},aa($u);function OB(s,u,h,f,g){f=Ae(f),f.shared=!1;var S=[Zl(s,u,h,f,g)],w=S[0],T=f.widgetNode;return Oo(s,function(L){T&&(f.widgetNode=T.cloneNode(!0)),S.push(Zl(L,ve(L,u),ve(L,h),f,g));for(var A=0;A<L.linked.length;++A)if(L.linked[A].isParent)return;w=tt(S)}),new $u(S,w)}function nk(s){return s.findMarks(oe(s.first,0),s.clipPos(oe(s.lastLine())),function(u){return u.parent})}function NB(s,u){for(var h=0;h<u.length;h++){var f=u[h],g=f.find(),S=s.clipPos(g.from),w=s.clipPos(g.to);if(R(S,w)){var T=Zl(s,S,w,f.primary,f.primary.type);f.markers.push(T),T.parent=f}}}function BB(s){for(var u=function(f){var g=s[f],S=[g.primary.doc];Oo(g.primary.doc,function(L){return S.push(L)});for(var w=0;w<g.markers.length;w++){var T=g.markers[w];ge(S,T.doc)==-1&&(T.parent=null,g.markers.splice(w--,1))}},h=0;h<s.length;h++)u(h)}var UB=0,hr=function(s,u,h,f,g){if(!(this instanceof hr))return new hr(s,u,h,f,g);h==null&&(h=0),zu.call(this,[new Wu([new Gl("",null)])]),this.first=h,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=h;var S=oe(h,0);this.sel=_o(S),this.history=new wf(null),this.id=++UB,this.modeOption=u,this.lineSep=f,this.direction=g=="rtl"?"rtl":"ltr",this.extend=!1,typeof s=="string"&&(s=this.splitLines(s)),Yy(this,{from:S,to:S,text:s}),Gn(this,_o(S),je)};hr.prototype=ra(zu.prototype,{constructor:hr,iter:function(s,u,h){h?this.iterN(s-this.first,u-s,h):this.iterN(this.first,this.first+this.size,s)},insert:function(s,u){for(var h=0,f=0;f<u.length;++f)h+=u[f].height;this.insertInner(s-this.first,u,h)},remove:function(s,u){this.removeInner(s-this.first,u)},getValue:function(s){var u=Tu(this,this.first,this.first+this.size);return s===!1?u:u.join(s||this.lineSeparator())},setValue:dn(function(s){var u=oe(this.first,0),h=this.first+this.size-1;Xl(this,{from:u,to:oe(h,ke(this,h).text.length),text:this.splitLines(s),origin:"setValue",full:!0},!0),this.cm&&Ru(this.cm,0,0),Gn(this,_o(u),je)}),replaceRange:function(s,u,h,f){u=ve(this,u),h=h?ve(this,h):u,Ql(this,s,u,h,f)},getRange:function(s,u,h){var f=sa(this,ve(this,s),ve(this,u));return h===!1?f:f.join(h||this.lineSeparator())},getLine:function(s){var u=this.getLineHandle(s);return u&&u.text},getLineHandle:function(s){if(Ps(this,s))return ke(this,s)},getLineNumber:function(s){return pt(s)},getLineHandleVisualStart:function(s){return typeof s=="number"&&(s=ke(this,s)),ua(s)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(s){return ve(this,s)},getCursor:function(s){var u=this.sel.primary(),h;return s==null||s=="head"?h=u.head:s=="anchor"?h=u.anchor:s=="end"||s=="to"||s===!1?h=u.to():h=u.from(),h},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:dn(function(s,u,h){GT(this,ve(this,typeof s=="number"?oe(s,u||0):s),null,h)}),setSelection:dn(function(s,u,h){GT(this,ve(this,s),ve(this,u||s),h)}),extendSelection:dn(function(s,u,h){kf(this,ve(this,s),u&&ve(this,u),h)}),extendSelections:dn(function(s,u){FT(this,Hr(this,s),u)}),extendSelectionsBy:dn(function(s,u){var h=Er(this.sel.ranges,s);FT(this,Hr(this,h),u)}),setSelections:dn(function(s,u,h){if(!!s.length){for(var f=[],g=0;g<s.length;g++)f[g]=new ft(ve(this,s[g].anchor),ve(this,s[g].head||s[g].anchor));u==null&&(u=Math.min(s.length-1,this.sel.primIndex)),Gn(this,Di(this.cm,f,u),h)}}),addSelection:dn(function(s,u,h){var f=this.sel.ranges.slice(0);f.push(new ft(ve(this,s),ve(this,u||s))),Gn(this,Di(this.cm,f,f.length-1),h)}),getSelection:function(s){for(var u=this.sel.ranges,h,f=0;f<u.length;f++){var g=sa(this,u[f].from(),u[f].to());h=h?h.concat(g):g}return s===!1?h:h.join(s||this.lineSeparator())},getSelections:function(s){for(var u=[],h=this.sel.ranges,f=0;f<h.length;f++){var g=sa(this,h[f].from(),h[f].to());s!==!1&&(g=g.join(s||this.lineSeparator())),u[f]=g}return u},replaceSelection:function(s,u,h){for(var f=[],g=0;g<this.sel.ranges.length;g++)f[g]=s;this.replaceSelections(f,u,h||"+input")},replaceSelections:dn(function(s,u,h){for(var f=[],g=this.sel,S=0;S<g.ranges.length;S++){var w=g.ranges[S];f[S]={from:w.from(),to:w.to(),text:this.splitLines(s[S]),origin:h}}for(var T=u&&u!="end"&&LB(this,f,u),L=f.length-1;L>=0;L--)Xl(this,f[L]);T?WT(this,T):this.cm&&ql(this.cm)}),undo:dn(function(){Pf(this,"undo")}),redo:dn(function(){Pf(this,"redo")}),undoSelection:dn(function(){Pf(this,"undo",!0)}),redoSelection:dn(function(){Pf(this,"redo",!0)}),setExtending:function(s){this.extend=s},getExtending:function(){return this.extend},historySize:function(){for(var s=this.history,u=0,h=0,f=0;f<s.done.length;f++)s.done[f].ranges||++u;for(var g=0;g<s.undone.length;g++)s.undone[g].ranges||++h;return{undo:u,redo:h}},clearHistory:function(){var s=this;this.history=new wf(this.history),Oo(this,function(u){return u.history=s.history},!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(s){return s&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(s){return this.history.generation==(s||this.cleanGeneration)},getHistory:function(){return{done:Kl(this.history.done),undone:Kl(this.history.undone)}},setHistory:function(s){var u=this.history=new wf(this.history);u.done=Kl(s.done.slice(0),null,!0),u.undone=Kl(s.undone.slice(0),null,!0)},setGutterMarker:dn(function(s,u,h){return Gu(this,s,"gutter",function(f){var g=f.gutterMarkers||(f.gutterMarkers={});return g[u]=h,!h&&za(g)&&(f.gutterMarkers=null),!0})}),clearGutter:dn(function(s){var u=this;this.iter(function(h){h.gutterMarkers&&h.gutterMarkers[s]&&Gu(u,h,"gutter",function(){return h.gutterMarkers[s]=null,za(h.gutterMarkers)&&(h.gutterMarkers=null),!0})})}),lineInfo:function(s){var u;if(typeof s=="number"){if(!Ps(this,s)||(u=s,s=ke(this,s),!s))return null}else if(u=pt(s),u==null)return null;return{line:u,handle:s,text:s.text,gutterMarkers:s.gutterMarkers,textClass:s.textClass,bgClass:s.bgClass,wrapClass:s.wrapClass,widgets:s.widgets}},addLineClass:dn(function(s,u,h){return Gu(this,s,u=="gutter"?"gutter":"class",function(f){var g=u=="text"?"textClass":u=="background"?"bgClass":u=="gutter"?"gutterClass":"wrapClass";if(!f[g])f[g]=h;else{if(O(h).test(f[g]))return!1;f[g]+=" "+h}return!0})}),removeLineClass:dn(function(s,u,h){return Gu(this,s,u=="gutter"?"gutter":"class",function(f){var g=u=="text"?"textClass":u=="background"?"bgClass":u=="gutter"?"gutterClass":"wrapClass",S=f[g];if(S)if(h==null)f[g]=null;else{var w=S.match(O(h));if(!w)return!1;var T=w.index+w[0].length;f[g]=S.slice(0,w.index)+(!w.index||T==S.length?"":" ")+S.slice(T)||null}else return!1;return!0})}),addLineWidget:dn(function(s,u,h){return VB(this,s,u,h)}),removeLineWidget:function(s){s.clear()},markText:function(s,u,h){return Zl(this,ve(this,s),ve(this,u),h,h&&h.type||"range")},setBookmark:function(s,u){var h={replacedWith:u&&(u.nodeType==null?u.widget:u),insertLeft:u&&u.insertLeft,clearWhenEmpty:!1,shared:u&&u.shared,handleMouseEvents:u&&u.handleMouseEvents};return s=ve(this,s),Zl(this,s,s,h,"bookmark")},findMarksAt:function(s){s=ve(this,s);var u=[],h=ke(this,s.line).markedSpans;if(h)for(var f=0;f<h.length;++f){var g=h[f];(g.from==null||g.from<=s.ch)&&(g.to==null||g.to>=s.ch)&&u.push(g.marker.parent||g.marker)}return u},findMarks:function(s,u,h){s=ve(this,s),u=ve(this,u);var f=[],g=s.line;return this.iter(s.line,u.line+1,function(S){var w=S.markedSpans;if(w)for(var T=0;T<w.length;T++){var L=w[T];!(L.to!=null&&g==s.line&&s.ch>=L.to||L.from==null&&g!=s.line||L.from!=null&&g==u.line&&L.from>=u.ch)&&(!h||h(L.marker))&&f.push(L.marker.parent||L.marker)}++g}),f},getAllMarks:function(){var s=[];return this.iter(function(u){var h=u.markedSpans;if(h)for(var f=0;f<h.length;++f)h[f].from!=null&&s.push(h[f].marker)}),s},posFromIndex:function(s){var u,h=this.first,f=this.lineSeparator().length;return this.iter(function(g){var S=g.text.length+f;if(S>s)return u=s,!0;s-=S,++h}),ve(this,oe(h,u))},indexFromPos:function(s){s=ve(this,s);var u=s.ch;if(s.line<this.first||s.ch<0)return 0;var h=this.lineSeparator().length;return this.iter(this.first,s.line,function(f){u+=f.text.length+h}),u},copy:function(s){var u=new hr(Tu(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return u.scrollTop=this.scrollTop,u.scrollLeft=this.scrollLeft,u.sel=this.sel,u.extend=!1,s&&(u.history.undoDepth=this.history.undoDepth,u.setHistory(this.getHistory())),u},linkedDoc:function(s){s||(s={});var u=this.first,h=this.first+this.size;s.from!=null&&s.from>u&&(u=s.from),s.to!=null&&s.to<h&&(h=s.to);var f=new hr(Tu(this,u,h),s.mode||this.modeOption,u,this.lineSep,this.direction);return s.sharedHist&&(f.history=this.history),(this.linked||(this.linked=[])).push({doc:f,sharedHist:s.sharedHist}),f.linked=[{doc:this,isParent:!0,sharedHist:s.sharedHist}],NB(f,nk(this)),f},unlinkDoc:function(s){if(s instanceof _t&&(s=s.doc),this.linked)for(var u=0;u<this.linked.length;++u){var h=this.linked[u];if(h.doc==s){this.linked.splice(u,1),s.unlinkDoc(this),BB(nk(this));break}}if(s.history==this.history){var f=[s.id];Oo(s,function(g){return f.push(g.id)},!0),s.history=new wf(null),s.history.done=Kl(this.history.done,f),s.history.undone=Kl(this.history.undone,f)}},iterLinkedDocs:function(s){Oo(this,s)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(s){return this.lineSep?s.split(this.lineSep):bu(s)},lineSeparator:function(){return this.lineSep||`
`},setDirection:dn(function(s){s!="rtl"&&(s="ltr"),s!=this.direction&&(this.direction=s,this.iter(function(u){return u.order=null}),this.cm&&EB(this.cm))})}),hr.prototype.eachLine=hr.prototype.iter;var rk=0;function FB(s){var u=this;if(ik(u),!(Kt(u,s)||Ja(u.display,s))){Un(s),o&&(rk=+new Date);var h=Is(u,s,!0),f=s.dataTransfer.files;if(!(!h||u.isReadOnly()))if(f&&f.length&&window.FileReader&&window.File)for(var g=f.length,S=Array(g),w=0,T=function(){++w==g&&un(u,function(){h=ve(u.doc,h);var K={from:h,to:h,text:u.doc.splitLines(S.filter(function(Z){return Z!=null}).join(u.doc.lineSeparator())),origin:"paste"};Xl(u.doc,K),WT(u.doc,_o(ve(u.doc,h),ve(u.doc,Vo(K))))})()},L=function(K,Z){if(u.options.allowDropFileTypes&&ge(u.options.allowDropFileTypes,K.type)==-1){T();return}var ie=new FileReader;ie.onerror=function(){return T()},ie.onload=function(){var de=ie.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(de)){T();return}S[Z]=de,T()},ie.readAsText(K)},A=0;A<f.length;A++)L(f[A],A);else{if(u.state.draggingText&&u.doc.sel.contains(h)>-1){u.state.draggingText(s),setTimeout(function(){return u.display.input.focus()},20);return}try{var F=s.dataTransfer.getData("Text");if(F){var z;if(u.state.draggingText&&!u.state.draggingText.copy&&(z=u.listSelections()),Lf(u.doc,_o(h,h)),z)for(var Y=0;Y<z.length;++Y)Ql(u.doc,"",z[Y].anchor,z[Y].head,"drag");u.replaceSelection(F,"around","paste"),u.display.input.focus()}}catch(K){}}}}function GB(s,u){if(o&&(!s.state.draggingText||+new Date-rk<100)){Es(u);return}if(!(Kt(s,u)||Ja(s.display,u))&&(u.dataTransfer.setData("Text",s.getSelection()),u.dataTransfer.effectAllowed="copyMove",u.dataTransfer.setDragImage&&!y)){var h=U("img",null,null,"position: fixed; left: 0; top: 0;");h.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",m&&(h.width=h.height=1,s.display.wrapper.appendChild(h),h._top=h.offsetTop),u.dataTransfer.setDragImage(h,0,0),m&&h.parentNode.removeChild(h)}}function WB(s,u){var h=Is(s,u);if(!!h){var f=document.createDocumentFragment();yT(s,h,f),s.display.dragCursor||(s.display.dragCursor=U("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),s.display.lineSpace.insertBefore(s.display.dragCursor,s.display.cursorDiv)),V(s.display.dragCursor,f)}}function ik(s){s.display.dragCursor&&(s.display.lineSpace.removeChild(s.display.dragCursor),s.display.dragCursor=null)}function ak(s){if(!!document.getElementsByClassName){for(var u=document.getElementsByClassName("CodeMirror"),h=[],f=0;f<u.length;f++){var g=u[f].CodeMirror;g&&h.push(g)}h.length&&h[0].operation(function(){for(var S=0;S<h.length;S++)s(h[S])})}}var ok=!1;function zB(){ok||(HB(),ok=!0)}function HB(){var s;Ve(window,"resize",function(){s==null&&(s=setTimeout(function(){s=null,ak($B)},100))}),Ve(window,"blur",function(){return ak(jl)})}function $B(s){var u=s.display;u.cachedCharWidth=u.cachedTextHeight=u.cachedPaddingH=null,u.scrollbarsClipped=!1,s.setSize()}for(var Bo={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},ju=0;ju<10;ju++)Bo[ju+48]=Bo[ju+96]=String(ju);for(var Df=65;Df<=90;Df++)Bo[Df]=String.fromCharCode(Df);for(var qu=1;qu<=12;qu++)Bo[qu+111]=Bo[qu+63235]="F"+qu;var Ka={};Ka.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Ka.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Ka.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Ka.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Ka.default=D?Ka.macDefault:Ka.pcDefault;function jB(s){var u=s.split(/-(?!$)/);s=u[u.length-1];for(var h,f,g,S,w=0;w<u.length-1;w++){var T=u[w];if(/^(cmd|meta|m)$/i.test(T))S=!0;else if(/^a(lt)?$/i.test(T))h=!0;else if(/^(c|ctrl|control)$/i.test(T))f=!0;else if(/^s(hift)?$/i.test(T))g=!0;else throw new Error("Unrecognized modifier name: "+T)}return h&&(s="Alt-"+s),f&&(s="Ctrl-"+s),S&&(s="Cmd-"+s),g&&(s="Shift-"+s),s}function qB(s){var u={};for(var h in s)if(s.hasOwnProperty(h)){var f=s[h];if(/^(name|fallthrough|(de|at)tach)$/.test(h))continue;if(f=="..."){delete s[h];continue}for(var g=Er(h.split(" "),jB),S=0;S<g.length;S++){var w=void 0,T=void 0;S==g.length-1?(T=g.join(" "),w=f):(T=g.slice(0,S+1).join(" "),w="...");var L=u[T];if(!L)u[T]=w;else if(L!=w)throw new Error("Inconsistent bindings for "+T)}delete s[h]}for(var A in u)s[A]=u[A];return s}function ec(s,u,h,f){u=Af(u);var g=u.call?u.call(s,f):u[s];if(g===!1)return"nothing";if(g==="...")return"multi";if(g!=null&&h(g))return"handled";if(u.fallthrough){if(Object.prototype.toString.call(u.fallthrough)!="[object Array]")return ec(s,u.fallthrough,h,f);for(var S=0;S<u.fallthrough.length;S++){var w=ec(s,u.fallthrough[S],h,f);if(w)return w}}}function sk(s){var u=typeof s=="string"?s:Bo[s.keyCode];return u=="Ctrl"||u=="Alt"||u=="Shift"||u=="Mod"}function lk(s,u,h){var f=s;return u.altKey&&f!="Alt"&&(s="Alt-"+s),(E?u.metaKey:u.ctrlKey)&&f!="Ctrl"&&(s="Ctrl-"+s),(E?u.ctrlKey:u.metaKey)&&f!="Mod"&&(s="Cmd-"+s),!h&&u.shiftKey&&f!="Shift"&&(s="Shift-"+s),s}function ck(s,u){if(m&&s.keyCode==34&&s.char)return!1;var h=Bo[s.keyCode];return h==null||s.altGraphKey?!1:(s.keyCode==3&&s.code&&(h=s.code),lk(h,s,u))}function Af(s){return typeof s=="string"?Ka[s]:s}function tc(s,u){for(var h=s.doc.sel.ranges,f=[],g=0;g<h.length;g++){for(var S=u(h[g]);f.length&&R(S.from,tt(f).to)<=0;){var w=f.pop();if(R(w.from,S.from)<0){S.from=w.from;break}}f.push(S)}Ar(s,function(){for(var T=f.length-1;T>=0;T--)Ql(s.doc,"",f[T].from,f[T].to,"+delete");ql(s)})}function ev(s,u,h){var f=Po(s.text,u+h,h);return f<0||f>s.text.length?null:f}function tv(s,u,h){var f=ev(s,u.ch,h);return f==null?null:new oe(u.line,f,h<0?"after":"before")}function nv(s,u,h,f,g){if(s){u.doc.direction=="rtl"&&(g=-g);var S=Pr(h,u.doc.direction);if(S){var w=g<0?tt(S):S[0],T=g<0==(w.level==1),L=T?"after":"before",A;if(w.level>0||u.doc.direction=="rtl"){var F=zl(u,h);A=g<0?h.text.length-1:0;var z=pa(u,F,A).top;A=Bn(function(Y){return pa(u,F,Y).top==z},g<0==(w.level==1)?w.from:w.to-1,A),L=="before"&&(A=ev(h,A,1))}else A=g<0?w.to:w.from;return new oe(f,A,L)}}return new oe(f,g<0?h.text.length:0,g<0?"before":"after")}function JB(s,u,h,f){var g=Pr(u,s.doc.direction);if(!g)return tv(u,h,f);h.ch>=u.text.length?(h.ch=u.text.length,h.sticky="before"):h.ch<=0&&(h.ch=0,h.sticky="after");var S=kt(g,h.ch,h.sticky),w=g[S];if(s.doc.direction=="ltr"&&w.level%2==0&&(f>0?w.to>h.ch:w.from<h.ch))return tv(u,h,f);var T=function(fe,Se){return ev(u,fe instanceof oe?fe.ch:fe,Se)},L,A=function(fe){return s.options.lineWrapping?(L=L||zl(s,u),fT(s,u,L,fe)):{begin:0,end:u.text.length}},F=A(h.sticky=="before"?T(h,-1):h.ch);if(s.doc.direction=="rtl"||w.level==1){var z=w.level==1==f<0,Y=T(h,z?1:-1);if(Y!=null&&(z?Y<=w.to&&Y<=F.end:Y>=w.from&&Y>=F.begin)){var K=z?"before":"after";return new oe(h.line,Y,K)}}var Z=function(fe,Se,he){for(var xe=function(Ct,pn){return pn?new oe(h.line,T(Ct,1),"before"):new oe(h.line,Ct,"after")};fe>=0&&fe<g.length;fe+=Se){var De=g[fe],Ee=Se>0==(De.level!=1),Ke=Ee?he.begin:T(he.end,-1);if(De.from<=Ke&&Ke<De.to||(Ke=Ee?De.from:T(De.to,-1),he.begin<=Ke&&Ke<he.end))return xe(Ke,Ee)}},ie=Z(S+f,f,F);if(ie)return ie;var de=f>0?F.end:T(F.begin,-1);return de!=null&&!(f>0&&de==u.text.length)&&(ie=Z(f>0?0:g.length-1,f,A(de)),ie)?ie:null}var Ju={selectAll:qT,singleSelection:function(s){return s.setSelection(s.getCursor("anchor"),s.getCursor("head"),je)},killLine:function(s){return tc(s,function(u){if(u.empty()){var h=ke(s.doc,u.head.line).text.length;return u.head.ch==h&&u.head.line<s.lastLine()?{from:u.head,to:oe(u.head.line+1,0)}:{from:u.head,to:oe(u.head.line,h)}}else return{from:u.from(),to:u.to()}})},deleteLine:function(s){return tc(s,function(u){return{from:oe(u.from().line,0),to:ve(s.doc,oe(u.to().line+1,0))}})},delLineLeft:function(s){return tc(s,function(u){return{from:oe(u.from().line,0),to:u.from()}})},delWrappedLineLeft:function(s){return tc(s,function(u){var h=s.charCoords(u.head,"div").top+5,f=s.coordsChar({left:0,top:h},"div");return{from:f,to:u.from()}})},delWrappedLineRight:function(s){return tc(s,function(u){var h=s.charCoords(u.head,"div").top+5,f=s.coordsChar({left:s.display.lineDiv.offsetWidth+100,top:h},"div");return{from:u.from(),to:f}})},undo:function(s){return s.undo()},redo:function(s){return s.redo()},undoSelection:function(s){return s.undoSelection()},redoSelection:function(s){return s.redoSelection()},goDocStart:function(s){return s.extendSelection(oe(s.firstLine(),0))},goDocEnd:function(s){return s.extendSelection(oe(s.lastLine()))},goLineStart:function(s){return s.extendSelectionsBy(function(u){return uk(s,u.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(s){return s.extendSelectionsBy(function(u){return dk(s,u.head)},{origin:"+move",bias:1})},goLineEnd:function(s){return s.extendSelectionsBy(function(u){return KB(s,u.head.line)},{origin:"+move",bias:-1})},goLineRight:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5;return s.coordsChar({left:s.display.lineDiv.offsetWidth+100,top:h},"div")},Ie)},goLineLeft:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5;return s.coordsChar({left:0,top:h},"div")},Ie)},goLineLeftSmart:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5,f=s.coordsChar({left:0,top:h},"div");return f.ch<s.getLine(f.line).search(/\S/)?dk(s,u.head):f},Ie)},goLineUp:function(s){return s.moveV(-1,"line")},goLineDown:function(s){return s.moveV(1,"line")},goPageUp:function(s){return s.moveV(-1,"page")},goPageDown:function(s){return s.moveV(1,"page")},goCharLeft:function(s){return s.moveH(-1,"char")},goCharRight:function(s){return s.moveH(1,"char")},goColumnLeft:function(s){return s.moveH(-1,"column")},goColumnRight:function(s){return s.moveH(1,"column")},goWordLeft:function(s){return s.moveH(-1,"word")},goGroupRight:function(s){return s.moveH(1,"group")},goGroupLeft:function(s){return s.moveH(-1,"group")},goWordRight:function(s){return s.moveH(1,"word")},delCharBefore:function(s){return s.deleteH(-1,"codepoint")},delCharAfter:function(s){return s.deleteH(1,"char")},delWordBefore:function(s){return s.deleteH(-1,"word")},delWordAfter:function(s){return s.deleteH(1,"word")},delGroupBefore:function(s){return s.deleteH(-1,"group")},delGroupAfter:function(s){return s.deleteH(1,"group")},indentAuto:function(s){return s.indentSelection("smart")},indentMore:function(s){return s.indentSelection("add")},indentLess:function(s){return s.indentSelection("subtract")},insertTab:function(s){return s.replaceSelection("	")},insertSoftTab:function(s){for(var u=[],h=s.listSelections(),f=s.options.tabSize,g=0;g<h.length;g++){var S=h[g].from(),w=Be(s.getLine(S.line),S.ch,f);u.push(ea(f-w%f))}s.replaceSelections(u)},defaultTab:function(s){s.somethingSelected()?s.indentSelection("add"):s.execCommand("insertTab")},transposeChars:function(s){return Ar(s,function(){for(var u=s.listSelections(),h=[],f=0;f<u.length;f++)if(!!u[f].empty()){var g=u[f].head,S=ke(s.doc,g.line).text;if(S){if(g.ch==S.length&&(g=new oe(g.line,g.ch-1)),g.ch>0)g=new oe(g.line,g.ch+1),s.replaceRange(S.charAt(g.ch-1)+S.charAt(g.ch-2),oe(g.line,g.ch-2),g,"+transpose");else if(g.line>s.doc.first){var w=ke(s.doc,g.line-1).text;w&&(g=new oe(g.line,1),s.replaceRange(S.charAt(0)+s.doc.lineSeparator()+w.charAt(w.length-1),oe(g.line-1,w.length-1),g,"+transpose"))}}h.push(new ft(g,g))}s.setSelections(h)})},newlineAndIndent:function(s){return Ar(s,function(){for(var u=s.listSelections(),h=u.length-1;h>=0;h--)s.replaceRange(s.doc.lineSeparator(),u[h].anchor,u[h].head,"+input");u=s.listSelections();for(var f=0;f<u.length;f++)s.indentLine(u[f].from().line,null,!0);ql(s)})},openLine:function(s){return s.replaceSelection(`
`,"start")},toggleOverwrite:function(s){return s.toggleOverwrite()}};function uk(s,u){var h=ke(s.doc,u),f=ua(h);return f!=h&&(u=pt(f)),nv(!0,s,f,u,1)}function KB(s,u){var h=ke(s.doc,u),f=MN(h);return f!=h&&(u=pt(f)),nv(!0,s,h,u,-1)}function dk(s,u){var h=uk(s,u.line),f=ke(s.doc,h.line),g=Pr(f,s.doc.direction);if(!g||g[0].level==0){var S=Math.max(h.ch,f.text.search(/\S/)),w=u.line==h.line&&u.ch<=S&&u.ch;return oe(h.line,w?0:S,h.sticky)}return h}function If(s,u,h){if(typeof u=="string"&&(u=Ju[u],!u))return!1;s.display.input.ensurePolled();var f=s.display.shift,g=!1;try{s.isReadOnly()&&(s.state.suppressEdits=!0),h&&(s.display.shift=!1),g=u(s)!=We}finally{s.display.shift=f,s.state.suppressEdits=!1}return g}function YB(s,u,h){for(var f=0;f<s.state.keyMaps.length;f++){var g=ec(u,s.state.keyMaps[f],h,s);if(g)return g}return s.options.extraKeys&&ec(u,s.options.extraKeys,h,s)||ec(u,s.options.keyMap,h,s)}var XB=new Ze;function Ku(s,u,h,f){var g=s.state.keySeq;if(g){if(sk(u))return"handled";if(/\'$/.test(u)?s.state.keySeq=null:XB.set(50,function(){s.state.keySeq==g&&(s.state.keySeq=null,s.display.input.reset())}),pk(s,g+" "+u,h,f))return!0}return pk(s,u,h,f)}function pk(s,u,h,f){var g=YB(s,u,f);return g=="multi"&&(s.state.keySeq=u),g=="handled"&&cn(s,"keyHandled",s,u,h),(g=="handled"||g=="multi")&&(Un(h),By(s)),!!g}function fk(s,u){var h=ck(u,!0);return h?u.shiftKey&&!s.state.keySeq?Ku(s,"Shift-"+h,u,function(f){return If(s,f,!0)})||Ku(s,h,u,function(f){if(typeof f=="string"?/^go[A-Z]/.test(f):f.motion)return If(s,f)}):Ku(s,h,u,function(f){return If(s,f)}):!1}function QB(s,u,h){return Ku(s,"'"+h+"'",u,function(f){return If(s,f,!0)})}var rv=null;function hk(s){var u=this;if(!(s.target&&s.target!=u.display.input.getField())&&(u.curOp.focus=pe(),!Kt(u,s))){o&&l<11&&s.keyCode==27&&(s.returnValue=!1);var h=s.keyCode;u.display.shift=h==16||s.shiftKey;var f=fk(u,s);m&&(rv=f?h:null,!f&&h==88&&!of&&(D?s.metaKey:s.ctrlKey)&&u.replaceSelection("",null,"cut")),t&&!D&&!f&&h==46&&s.shiftKey&&!s.ctrlKey&&document.execCommand&&document.execCommand("cut"),h==18&&!/\bCodeMirror-crosshair\b/.test(u.display.lineDiv.className)&&ZB(u)}}function ZB(s){var u=s.display.lineDiv;me(u,"CodeMirror-crosshair");function h(f){(f.keyCode==18||!f.altKey)&&(B(u,"CodeMirror-crosshair"),dr(document,"keyup",h),dr(document,"mouseover",h))}Ve(document,"keyup",h),Ve(document,"mouseover",h)}function mk(s){s.keyCode==16&&(this.doc.sel.shift=!1),Kt(this,s)}function gk(s){var u=this;if(!(s.target&&s.target!=u.display.input.getField())&&!(Ja(u.display,s)||Kt(u,s)||s.ctrlKey&&!s.altKey||D&&s.metaKey)){var h=s.keyCode,f=s.charCode;if(m&&h==rv){rv=null,Un(s);return}if(!(m&&(!s.which||s.which<10)&&fk(u,s))){var g=String.fromCharCode(f==null?h:f);g!="\b"&&(QB(u,s,g)||u.display.input.onKeyPress(s))}}}var eU=400,iv=function(s,u,h){this.time=s,this.pos=u,this.button=h};iv.prototype.compare=function(s,u,h){return this.time+eU>s&&R(u,this.pos)==0&&h==this.button};var Yu,Xu;function tU(s,u){var h=+new Date;return Xu&&Xu.compare(h,s,u)?(Yu=Xu=null,"triple"):Yu&&Yu.compare(h,s,u)?(Xu=new iv(h,s,u),Yu=null,"double"):(Yu=new iv(h,s,u),Xu=null,"single")}function yk(s){var u=this,h=u.display;if(!(Kt(u,s)||h.activeTouch&&h.input.supportsTouch())){if(h.input.ensurePolled(),h.shift=s.shiftKey,Ja(h,s)){c||(h.scroller.draggable=!1,setTimeout(function(){return h.scroller.draggable=!0},100));return}if(!av(u,s)){var f=Is(u,s),g=nf(s),S=f?tU(f,g):"single";window.focus(),g==1&&u.state.selectingText&&u.state.selectingText(s),!(f&&nU(u,g,f,S,s))&&(g==1?f?iU(u,f,S,s):Do(s)==h.scroller&&Un(s):g==2?(f&&kf(u.doc,f),setTimeout(function(){return h.input.focus()},20)):g==3&&(_?u.display.input.onContextMenu(s):Uy(u)))}}}function nU(s,u,h,f,g){var S="Click";return f=="double"?S="Double"+S:f=="triple"&&(S="Triple"+S),S=(u==1?"Left":u==2?"Middle":"Right")+S,Ku(s,lk(S,g),g,function(w){if(typeof w=="string"&&(w=Ju[w]),!w)return!1;var T=!1;try{s.isReadOnly()&&(s.state.suppressEdits=!0),T=w(s,h)!=We}finally{s.state.suppressEdits=!1}return T})}function rU(s,u,h){var f=s.getOption("configureMouse"),g=f?f(s,u,h):{};if(g.unit==null){var S=P?h.shiftKey&&h.metaKey:h.altKey;g.unit=S?"rectangle":u=="single"?"char":u=="double"?"word":"line"}return(g.extend==null||s.doc.extend)&&(g.extend=s.doc.extend||h.shiftKey),g.addNew==null&&(g.addNew=D?h.metaKey:h.ctrlKey),g.moveOnDrag==null&&(g.moveOnDrag=!(D?h.altKey:h.ctrlKey)),g}function iU(s,u,h,f){o?setTimeout(Te(vT,s),0):s.curOp.focus=pe();var g=rU(s,h,f),S=s.doc.sel,w;s.options.dragDrop&&vu&&!s.isReadOnly()&&h=="single"&&(w=S.contains(u))>-1&&(R((w=S.ranges[w]).from(),u)<0||u.xRel>0)&&(R(w.to(),u)>0||u.xRel<0)?aU(s,f,u,g):oU(s,f,u,g)}function aU(s,u,h,f){var g=s.display,S=!1,w=un(s,function(A){c&&(g.scroller.draggable=!1),s.state.draggingText=!1,s.state.delayingBlurEvent&&(s.hasFocus()?s.state.delayingBlurEvent=!1:Uy(s)),dr(g.wrapper.ownerDocument,"mouseup",w),dr(g.wrapper.ownerDocument,"mousemove",T),dr(g.scroller,"dragstart",L),dr(g.scroller,"drop",w),S||(Un(A),f.addNew||kf(s.doc,h,null,null,f.extend),c&&!y||o&&l==9?setTimeout(function(){g.wrapper.ownerDocument.body.focus({preventScroll:!0}),g.input.focus()},20):g.input.focus())}),T=function(A){S=S||Math.abs(u.clientX-A.clientX)+Math.abs(u.clientY-A.clientY)>=10},L=function(){return S=!0};c&&(g.scroller.draggable=!0),s.state.draggingText=w,w.copy=!f.moveOnDrag,Ve(g.wrapper.ownerDocument,"mouseup",w),Ve(g.wrapper.ownerDocument,"mousemove",T),Ve(g.scroller,"dragstart",L),Ve(g.scroller,"drop",w),s.state.delayingBlurEvent=!0,setTimeout(function(){return g.input.focus()},20),g.scroller.dragDrop&&g.scroller.dragDrop()}function vk(s,u,h){if(h=="char")return new ft(u,u);if(h=="word")return s.findWordAt(u);if(h=="line")return new ft(oe(u.line,0),ve(s.doc,oe(u.line+1,0)));var f=h(s,u);return new ft(f.from,f.to)}function oU(s,u,h,f){o&&Uy(s);var g=s.display,S=s.doc;Un(u);var w,T,L=S.sel,A=L.ranges;if(f.addNew&&!f.extend?(T=S.sel.contains(h),T>-1?w=A[T]:w=new ft(h,h)):(w=S.sel.primary(),T=S.sel.primIndex),f.unit=="rectangle")f.addNew||(w=new ft(h,h)),h=Is(s,u,!0,!0),T=-1;else{var F=vk(s,h,f.unit);f.extend?w=Qy(w,F.anchor,F.head,f.extend):w=F}f.addNew?T==-1?(T=A.length,Gn(S,Di(s,A.concat([w]),T),{scroll:!1,origin:"*mouse"})):A.length>1&&A[T].empty()&&f.unit=="char"&&!f.extend?(Gn(S,Di(s,A.slice(0,T).concat(A.slice(T+1)),0),{scroll:!1,origin:"*mouse"}),L=S.sel):Zy(S,T,w,et):(T=0,Gn(S,new jr([w],0),et),L=S.sel);var z=h;function Y(he){if(R(z,he)!=0)if(z=he,f.unit=="rectangle"){for(var xe=[],De=s.options.tabSize,Ee=Be(ke(S,h.line).text,h.ch,De),Ke=Be(ke(S,he.line).text,he.ch,De),Ct=Math.min(Ee,Ke),pn=Math.max(Ee,Ke),Ot=Math.min(h.line,he.line),Ir=Math.min(s.lastLine(),Math.max(h.line,he.line));Ot<=Ir;Ot++){var mr=ke(S,Ot).text,Yt=lt(mr,Ct,De);Ct==pn?xe.push(new ft(oe(Ot,Yt),oe(Ot,Yt))):mr.length>Yt&&xe.push(new ft(oe(Ot,Yt),oe(Ot,lt(mr,pn,De))))}xe.length||xe.push(new ft(h,h)),Gn(S,Di(s,L.ranges.slice(0,T).concat(xe),T),{origin:"*mouse",scroll:!1}),s.scrollIntoView(he)}else{var gr=w,Ln=vk(s,he,f.unit),tn=gr.anchor,Xt;R(Ln.anchor,tn)>0?(Xt=Ln.head,tn=Fe(gr.from(),Ln.anchor)):(Xt=Ln.anchor,tn=ue(gr.to(),Ln.head));var Ut=L.ranges.slice(0);Ut[T]=sU(s,new ft(ve(S,tn),Xt)),Gn(S,Di(s,Ut,T),et)}}var K=g.wrapper.getBoundingClientRect(),Z=0;function ie(he){var xe=++Z,De=Is(s,he,!0,f.unit=="rectangle");if(!!De)if(R(De,z)!=0){s.curOp.focus=pe(),Y(De);var Ee=Sf(g,S);(De.line>=Ee.to||De.line<Ee.from)&&setTimeout(un(s,function(){Z==xe&&ie(he)}),150)}else{var Ke=he.clientY<K.top?-20:he.clientY>K.bottom?20:0;Ke&&setTimeout(un(s,function(){Z==xe&&(g.scroller.scrollTop+=Ke,ie(he))}),50)}}function de(he){s.state.selectingText=!1,Z=Infinity,he&&(Un(he),g.input.focus()),dr(g.wrapper.ownerDocument,"mousemove",fe),dr(g.wrapper.ownerDocument,"mouseup",Se),S.history.lastSelOrigin=null}var fe=un(s,function(he){he.buttons===0||!nf(he)?de(he):ie(he)}),Se=un(s,de);s.state.selectingText=Se,Ve(g.wrapper.ownerDocument,"mousemove",fe),Ve(g.wrapper.ownerDocument,"mouseup",Se)}function sU(s,u){var h=u.anchor,f=u.head,g=ke(s.doc,h.line);if(R(h,f)==0&&h.sticky==f.sticky)return u;var S=Pr(g);if(!S)return u;var w=kt(S,h.ch,h.sticky),T=S[w];if(T.from!=h.ch&&T.to!=h.ch)return u;var L=w+(T.from==h.ch==(T.level!=1)?0:1);if(L==0||L==S.length)return u;var A;if(f.line!=h.line)A=(f.line-h.line)*(s.doc.direction=="ltr"?1:-1)>0;else{var F=kt(S,f.ch,f.sticky),z=F-w||(f.ch-h.ch)*(T.level==1?-1:1);F==L-1||F==L?A=z<0:A=z>0}var Y=S[L+(A?-1:0)],K=A==(Y.level==1),Z=K?Y.from:Y.to,ie=K?"after":"before";return h.ch==Z&&h.sticky==ie?u:new ft(new oe(h.line,Z,ie),f)}function Sk(s,u,h,f){var g,S;if(u.touches)g=u.touches[0].clientX,S=u.touches[0].clientY;else try{g=u.clientX,S=u.clientY}catch(Y){return!1}if(g>=Math.floor(s.display.gutters.getBoundingClientRect().right))return!1;f&&Un(u);var w=s.display,T=w.lineDiv.getBoundingClientRect();if(S>T.bottom||!kn(s,h))return Gr(u);S-=T.top-w.viewOffset;for(var L=0;L<s.display.gutterSpecs.length;++L){var A=w.gutters.childNodes[L];if(A&&A.getBoundingClientRect().right>=g){var F=la(s.doc,S),z=s.display.gutterSpecs[L];return Ue(s,h,s,F,z.className,u),Gr(u)}}}function av(s,u){return Sk(s,u,"gutterClick",!0)}function bk(s,u){Ja(s.display,u)||lU(s,u)||Kt(s,u,"contextmenu")||_||s.display.input.onContextMenu(u)}function lU(s,u){return kn(s,"gutterContextMenu")?Sk(s,u,"gutterContextMenu",!1):!1}function xk(s){s.display.wrapper.className=s.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+s.options.theme.replace(/(^|\s)\s*/g," cm-s-"),Iu(s)}var nc={toString:function(){return"CodeMirror.Init"}},Ck={},Mf={};function cU(s){var u=s.optionHandlers;function h(f,g,S,w){s.defaults[f]=g,S&&(u[f]=w?function(T,L,A){A!=nc&&S(T,L,A)}:S)}s.defineOption=h,s.Init=nc,h("value","",function(f,g){return f.setValue(g)},!0),h("mode",null,function(f,g){f.doc.modeOption=g,Ky(f)},!0),h("indentUnit",2,Ky,!0),h("indentWithTabs",!1),h("smartIndent",!0),h("tabSize",4,function(f){Uu(f),Iu(f),fr(f)},!0),h("lineSeparator",null,function(f,g){if(f.doc.lineSep=g,!!g){var S=[],w=f.doc.first;f.doc.iter(function(L){for(var A=0;;){var F=L.text.indexOf(g,A);if(F==-1)break;A=F+g.length,S.push(oe(w,F))}w++});for(var T=S.length-1;T>=0;T--)Ql(f.doc,g,S[T],oe(S[T].line,S[T].ch+g.length))}}),h("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\ufeff\ufff9-\ufffc]/g,function(f,g,S){f.state.specialChars=new RegExp(g.source+(g.test("	")?"":"|	"),"g"),S!=nc&&f.refresh()}),h("specialCharPlaceholder",BN,function(f){return f.refresh()},!0),h("electricChars",!0),h("inputStyle",k?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),h("spellcheck",!1,function(f,g){return f.getInputField().spellcheck=g},!0),h("autocorrect",!1,function(f,g){return f.getInputField().autocorrect=g},!0),h("autocapitalize",!1,function(f,g){return f.getInputField().autocapitalize=g},!0),h("rtlMoveVisually",!M),h("wholeLineUpdateBefore",!0),h("theme","default",function(f){xk(f),Bu(f)},!0),h("keyMap","default",function(f,g,S){var w=Af(g),T=S!=nc&&Af(S);T&&T.detach&&T.detach(f,w),w.attach&&w.attach(f,T||null)}),h("extraKeys",null),h("configureMouse",null),h("lineWrapping",!1,dU,!0),h("gutters",[],function(f,g){f.display.gutterSpecs=qy(g,f.options.lineNumbers),Bu(f)},!0),h("fixedGutter",!0,function(f,g){f.display.gutters.style.left=g?Oy(f.display)+"px":"0",f.refresh()},!0),h("coverGutterNextToScrollbar",!1,function(f){return Jl(f)},!0),h("scrollbarStyle","native",function(f){TT(f),Jl(f),f.display.scrollbars.setScrollTop(f.doc.scrollTop),f.display.scrollbars.setScrollLeft(f.doc.scrollLeft)},!0),h("lineNumbers",!1,function(f,g){f.display.gutterSpecs=qy(f.options.gutters,g),Bu(f)},!0),h("firstLineNumber",1,Bu,!0),h("lineNumberFormatter",function(f){return f},Bu,!0),h("showCursorWhenSelecting",!1,Mu,!0),h("resetSelectionOnContextMenu",!0),h("lineWiseCopyCut",!0),h("pasteLinesPerSelection",!0),h("selectionsMayTouch",!1),h("readOnly",!1,function(f,g){g=="nocursor"&&(jl(f),f.display.input.blur()),f.display.input.readOnlyChanged(g)}),h("screenReaderLabel",null,function(f,g){g=g===""?null:g,f.display.input.screenReaderLabelChanged(g)}),h("disableInput",!1,function(f,g){g||f.display.input.reset()},!0),h("dragDrop",!0,uU),h("allowDropFileTypes",null),h("cursorBlinkRate",530),h("cursorScrollMargin",0),h("cursorHeight",1,Mu,!0),h("singleCursorHeightPerLine",!0,Mu,!0),h("workTime",100),h("workDelay",100),h("flattenSpans",!0,Uu,!0),h("addModeClass",!1,Uu,!0),h("pollInterval",100),h("undoDepth",200,function(f,g){return f.doc.history.undoDepth=g}),h("historyEventDelay",1250),h("viewportMargin",10,function(f){return f.refresh()},!0),h("maxHighlightLength",1e4,Uu,!0),h("moveInputWithCursor",!0,function(f,g){g||f.display.input.resetPosition()}),h("tabindex",null,function(f,g){return f.display.input.getField().tabIndex=g||""}),h("autofocus",null),h("direction","ltr",function(f,g){return f.doc.setDirection(g)},!0),h("phrases",null)}function uU(s,u,h){var f=h&&h!=nc;if(!u!=!f){var g=s.display.dragFunctions,S=u?Ve:dr;S(s.display.scroller,"dragstart",g.start),S(s.display.scroller,"dragenter",g.enter),S(s.display.scroller,"dragover",g.over),S(s.display.scroller,"dragleave",g.leave),S(s.display.scroller,"drop",g.drop)}}function dU(s){s.options.lineWrapping?(me(s.display.wrapper,"CodeMirror-wrap"),s.display.sizer.style.minWidth="",s.display.sizerWidth=null):(B(s.display.wrapper,"CodeMirror-wrap"),ky(s)),Ny(s),fr(s),Iu(s),setTimeout(function(){return Jl(s)},100)}function _t(s,u){var h=this;if(!(this instanceof _t))return new _t(s,u);this.options=u=u?Ae(u):{},Ae(Ck,u,!1);var f=u.value;typeof f=="string"?f=new hr(f,u.mode,null,u.lineSeparator,u.direction):u.mode&&(f.modeOption=u.mode),this.doc=f;var g=new _t.inputStyles[u.inputStyle](this),S=this.display=new TB(s,f,g,u);S.wrapper.CodeMirror=this,xk(this),u.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),TT(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new Ze,keySeq:null,specialChars:null},u.autofocus&&!k&&S.input.focus(),o&&l<11&&setTimeout(function(){return h.display.input.reset(!0)},20),pU(this),zB(),Vs(this),this.curOp.forceUpdate=!0,_T(this,f),u.autofocus&&!k||this.hasFocus()?setTimeout(function(){h.hasFocus()&&!h.state.focused&&Fy(h)},20):jl(this);for(var w in Mf)Mf.hasOwnProperty(w)&&Mf[w](this,u[w],nc);ET(this),u.finishInit&&u.finishInit(this);for(var T=0;T<ov.length;++T)ov[T](this);Os(this),c&&u.lineWrapping&&getComputedStyle(S.lineDiv).textRendering=="optimizelegibility"&&(S.lineDiv.style.textRendering="auto")}_t.defaults=Ck,_t.optionHandlers=Mf;function pU(s){var u=s.display;Ve(u.scroller,"mousedown",un(s,yk)),o&&l<11?Ve(u.scroller,"dblclick",un(s,function(L){if(!Kt(s,L)){var A=Is(s,L);if(!(!A||av(s,L)||Ja(s.display,L))){Un(L);var F=s.findWordAt(A);kf(s.doc,F.anchor,F.head)}}})):Ve(u.scroller,"dblclick",function(L){return Kt(s,L)||Un(L)}),Ve(u.scroller,"contextmenu",function(L){return bk(s,L)}),Ve(u.input.getField(),"contextmenu",function(L){u.scroller.contains(L.target)||bk(s,L)});var h,f={end:0};function g(){u.activeTouch&&(h=setTimeout(function(){return u.activeTouch=null},1e3),f=u.activeTouch,f.end=+new Date)}function S(L){if(L.touches.length!=1)return!1;var A=L.touches[0];return A.radiusX<=1&&A.radiusY<=1}function w(L,A){if(A.left==null)return!0;var F=A.left-L.left,z=A.top-L.top;return F*F+z*z>20*20}Ve(u.scroller,"touchstart",function(L){if(!Kt(s,L)&&!S(L)&&!av(s,L)){u.input.ensurePolled(),clearTimeout(h);var A=+new Date;u.activeTouch={start:A,moved:!1,prev:A-f.end<=300?f:null},L.touches.length==1&&(u.activeTouch.left=L.touches[0].pageX,u.activeTouch.top=L.touches[0].pageY)}}),Ve(u.scroller,"touchmove",function(){u.activeTouch&&(u.activeTouch.moved=!0)}),Ve(u.scroller,"touchend",function(L){var A=u.activeTouch;if(A&&!Ja(u,L)&&A.left!=null&&!A.moved&&new Date-A.start<300){var F=s.coordsChar(u.activeTouch,"page"),z;!A.prev||w(A,A.prev)?z=new ft(F,F):!A.prev.prev||w(A,A.prev.prev)?z=s.findWordAt(F):z=new ft(oe(F.line,0),ve(s.doc,oe(F.line+1,0))),s.setSelection(z.anchor,z.head),s.focus(),Un(L)}g()}),Ve(u.scroller,"touchcancel",g),Ve(u.scroller,"scroll",function(){u.scroller.clientHeight&&(_u(s,u.scroller.scrollTop),Rs(s,u.scroller.scrollLeft,!0),Ue(s,"scroll",s))}),Ve(u.scroller,"mousewheel",function(L){return AT(s,L)}),Ve(u.scroller,"DOMMouseScroll",function(L){return AT(s,L)}),Ve(u.wrapper,"scroll",function(){return u.wrapper.scrollTop=u.wrapper.scrollLeft=0}),u.dragFunctions={enter:function(L){Kt(s,L)||Es(L)},over:function(L){Kt(s,L)||(WB(s,L),Es(L))},start:function(L){return GB(s,L)},drop:un(s,FB),leave:function(L){Kt(s,L)||ik(s)}};var T=u.input.getField();Ve(T,"keyup",function(L){return mk.call(s,L)}),Ve(T,"keydown",un(s,hk)),Ve(T,"keypress",un(s,gk)),Ve(T,"focus",function(L){return Fy(s,L)}),Ve(T,"blur",function(L){return jl(s,L)})}var ov=[];_t.defineInitHook=function(s){return ov.push(s)};function Qu(s,u,h,f){var g=s.doc,S;h==null&&(h="add"),h=="smart"&&(g.mode.indent?S=Lu(s,u).state:h="prev");var w=s.options.tabSize,T=ke(g,u),L=Be(T.text,null,w);T.stateAfter&&(T.stateAfter=null);var A=T.text.match(/^\s*/)[0],F;if(!f&&!/\S/.test(T.text))F=0,h="not";else if(h=="smart"&&(F=g.mode.indent(S,T.text.slice(A.length),T.text),F==We||F>150)){if(!f)return;h="prev"}h=="prev"?u>g.first?F=Be(ke(g,u-1).text,null,w):F=0:h=="add"?F=L+s.options.indentUnit:h=="subtract"?F=L-s.options.indentUnit:typeof h=="number"&&(F=L+h),F=Math.max(0,F);var z="",Y=0;if(s.options.indentWithTabs)for(var K=Math.floor(F/w);K;--K)Y+=w,z+="	";if(Y<F&&(z+=ea(F-Y)),z!=A)return Ql(g,z,oe(u,0),oe(u,A.length),"+input"),T.stateAfter=null,!0;for(var Z=0;Z<g.sel.ranges.length;Z++){var ie=g.sel.ranges[Z];if(ie.head.line==u&&ie.head.ch<A.length){var de=oe(u,A.length);Zy(g,Z,new ft(de,de));break}}}var Ai=null;function Rf(s){Ai=s}function sv(s,u,h,f,g){var S=s.doc;s.display.shift=!1,f||(f=S.sel);var w=+new Date-200,T=g=="paste"||s.state.pasteIncoming>w,L=bu(u),A=null;if(T&&f.ranges.length>1)if(Ai&&Ai.text.join(`
`)==u){if(f.ranges.length%Ai.text.length==0){A=[];for(var F=0;F<Ai.text.length;F++)A.push(S.splitLines(Ai.text[F]))}}else L.length==f.ranges.length&&s.options.pasteLinesPerSelection&&(A=Er(L,function(fe){return[fe]}));for(var z=s.curOp.updateInput,Y=f.ranges.length-1;Y>=0;Y--){var K=f.ranges[Y],Z=K.from(),ie=K.to();K.empty()&&(h&&h>0?Z=oe(Z.line,Z.ch-h):s.state.overwrite&&!T?ie=oe(ie.line,Math.min(ke(S,ie.line).text.length,ie.ch+tt(L).length)):T&&Ai&&Ai.lineWise&&Ai.text.join(`
`)==L.join(`
`)&&(Z=ie=oe(Z.line,0)));var de={from:Z,to:ie,text:A?A[Y%A.length]:L,origin:g||(T?"paste":s.state.cutIncoming>w?"cut":"+input")};Xl(s.doc,de),cn(s,"inputRead",s,de)}u&&!T&&Tk(s,u),ql(s),s.curOp.updateInput<2&&(s.curOp.updateInput=z),s.curOp.typing=!0,s.state.pasteIncoming=s.state.cutIncoming=-1}function wk(s,u){var h=s.clipboardData&&s.clipboardData.getData("Text");if(h)return s.preventDefault(),!u.isReadOnly()&&!u.options.disableInput&&Ar(u,function(){return sv(u,h,0,null,"paste")}),!0}function Tk(s,u){if(!(!s.options.electricChars||!s.options.smartIndent))for(var h=s.doc.sel,f=h.ranges.length-1;f>=0;f--){var g=h.ranges[f];if(!(g.head.ch>100||f&&h.ranges[f-1].head.line==g.head.line)){var S=s.getModeAt(g.head),w=!1;if(S.electricChars){for(var T=0;T<S.electricChars.length;T++)if(u.indexOf(S.electricChars.charAt(T))>-1){w=Qu(s,g.head.line,"smart");break}}else S.electricInput&&S.electricInput.test(ke(s.doc,g.head.line).text.slice(0,g.head.ch))&&(w=Qu(s,g.head.line,"smart"));w&&cn(s,"electricInput",s,g.head.line)}}}function kk(s){for(var u=[],h=[],f=0;f<s.doc.sel.ranges.length;f++){var g=s.doc.sel.ranges[f].head.line,S={anchor:oe(g,0),head:oe(g+1,0)};h.push(S),u.push(s.getRange(S.anchor,S.head))}return{text:u,ranges:h}}function Lk(s,u,h,f){s.setAttribute("autocorrect",h?"":"off"),s.setAttribute("autocapitalize",f?"":"off"),s.setAttribute("spellcheck",!!u)}function Ek(){var s=U("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),u=U("div",[s],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return c?s.style.width="1000px":s.setAttribute("wrap","off"),x&&(s.style.border="1px solid black"),Lk(s),u}function fU(s){var u=s.optionHandlers,h=s.helpers={};s.prototype={constructor:s,focus:function(){window.focus(),this.display.input.focus()},setOption:function(f,g){var S=this.options,w=S[f];S[f]==g&&f!="mode"||(S[f]=g,u.hasOwnProperty(f)&&un(this,u[f])(this,g,w),Ue(this,"optionChange",this,f))},getOption:function(f){return this.options[f]},getDoc:function(){return this.doc},addKeyMap:function(f,g){this.state.keyMaps[g?"push":"unshift"](Af(f))},removeKeyMap:function(f){for(var g=this.state.keyMaps,S=0;S<g.length;++S)if(g[S]==f||g[S].name==f)return g.splice(S,1),!0},addOverlay:er(function(f,g){var S=f.token?f:s.getMode(this.options,f);if(S.startState)throw new Error("Overlays may not be stateful.");ta(this.state.overlays,{mode:S,modeSpec:f,opaque:g&&g.opaque,priority:g&&g.priority||0},function(w){return w.priority}),this.state.modeGen++,fr(this)}),removeOverlay:er(function(f){for(var g=this.state.overlays,S=0;S<g.length;++S){var w=g[S].modeSpec;if(w==f||typeof f=="string"&&w.name==f){g.splice(S,1),this.state.modeGen++,fr(this);return}}}),indentLine:er(function(f,g,S){typeof g!="string"&&typeof g!="number"&&(g==null?g=this.options.smartIndent?"smart":"prev":g=g?"add":"subtract"),Ps(this.doc,f)&&Qu(this,f,g,S)}),indentSelection:er(function(f){for(var g=this.doc.sel.ranges,S=-1,w=0;w<g.length;w++){var T=g[w];if(T.empty())T.head.line>S&&(Qu(this,T.head.line,f,!0),S=T.head.line,w==this.doc.sel.primIndex&&ql(this));else{var L=T.from(),A=T.to(),F=Math.max(S,L.line);S=Math.min(this.lastLine(),A.line-(A.ch?0:1))+1;for(var z=F;z<S;++z)Qu(this,z,f);var Y=this.doc.sel.ranges;L.ch==0&&g.length==Y.length&&Y[w].from().ch>0&&Zy(this.doc,w,new ft(L,Y[w].to()),je)}}}),getTokenAt:function(f,g){return V0(this,f,g)},getLineTokens:function(f,g){return V0(this,oe(f),g,!0)},getTokenTypeAt:function(f){f=ve(this.doc,f);var g=M0(this,ke(this.doc,f.line)),S=0,w=(g.length-1)/2,T=f.ch,L;if(T==0)L=g[2];else for(;;){var A=S+w>>1;if((A?g[A*2-1]:0)>=T)w=A;else if(g[A*2+1]<T)S=A+1;else{L=g[A*2+2];break}}var F=L?L.indexOf("overlay "):-1;return F<0?L:F==0?null:L.slice(0,F-1)},getModeAt:function(f){var g=this.doc.mode;return g.innerMode?s.innerMode(g,this.getTokenAt(f).state).mode:g},getHelper:function(f,g){return this.getHelpers(f,g)[0]},getHelpers:function(f,g){var S=[];if(!h.hasOwnProperty(g))return S;var w=h[g],T=this.getModeAt(f);if(typeof T[g]=="string")w[T[g]]&&S.push(w[T[g]]);else if(T[g])for(var L=0;L<T[g].length;L++){var A=w[T[g][L]];A&&S.push(A)}else T.helperType&&w[T.helperType]?S.push(w[T.helperType]):w[T.name]&&S.push(w[T.name]);for(var F=0;F<w._global.length;F++){var z=w._global[F];z.pred(T,this)&&ge(S,z.val)==-1&&S.push(z.val)}return S},getStateAfter:function(f,g){var S=this.doc;return f=it(S,f==null?S.first+S.size-1:f),Lu(this,f+1,g).state},cursorCoords:function(f,g){var S,w=this.doc.sel.primary();return f==null?S=w.head:typeof f=="object"?S=ve(this.doc,f):S=f?w.from():w.to(),Pi(this,S,g||"page")},charCoords:function(f,g){return Iy(this,ve(this.doc,f),g||"page")},coordsChar:function(f,g){return f=uT(this,f,g||"page"),Ry(this,f.left,f.top)},lineAtHeight:function(f,g){return f=uT(this,{top:f,left:0},g||"page").top,la(this.doc,f+this.display.viewOffset)},heightAtLine:function(f,g,S){var w=!1,T;if(typeof f=="number"){var L=this.doc.first+this.doc.size-1;f<this.doc.first?f=this.doc.first:f>L&&(f=L,w=!0),T=ke(this.doc,f)}else T=f;return mf(this,T,{top:0,left:0},g||"page",S||w).top+(w?this.doc.height-qa(T):0)},defaultTextHeight:function(){return Hl(this.display)},defaultCharWidth:function(){return $l(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(f,g,S,w,T){var L=this.display;f=Pi(this,ve(this.doc,f));var A=f.bottom,F=f.left;if(g.style.position="absolute",g.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(g),L.sizer.appendChild(g),w=="over")A=f.top;else if(w=="above"||w=="near"){var z=Math.max(L.wrapper.clientHeight,this.doc.height),Y=Math.max(L.sizer.clientWidth,L.lineSpace.clientWidth);(w=="above"||f.bottom+g.offsetHeight>z)&&f.top>g.offsetHeight?A=f.top-g.offsetHeight:f.bottom+g.offsetHeight<=z&&(A=f.bottom),F+g.offsetWidth>Y&&(F=Y-g.offsetWidth)}g.style.top=A+"px",g.style.left=g.style.right="",T=="right"?(F=L.sizer.clientWidth-g.offsetWidth,g.style.right="0px"):(T=="left"?F=0:T=="middle"&&(F=(L.sizer.clientWidth-g.offsetWidth)/2),g.style.left=F+"px"),S&&uB(this,{left:F,top:A,right:F+g.offsetWidth,bottom:A+g.offsetHeight})},triggerOnKeyDown:er(hk),triggerOnKeyPress:er(gk),triggerOnKeyUp:mk,triggerOnMouseDown:er(yk),execCommand:function(f){if(Ju.hasOwnProperty(f))return Ju[f].call(null,this)},triggerElectric:er(function(f){Tk(this,f)}),findPosH:function(f,g,S,w){var T=1;g<0&&(T=-1,g=-g);for(var L=ve(this.doc,f),A=0;A<g&&(L=lv(this.doc,L,T,S,w),!L.hitSide);++A);return L},moveH:er(function(f,g){var S=this;this.extendSelectionsBy(function(w){return S.display.shift||S.doc.extend||w.empty()?lv(S.doc,w.head,f,g,S.options.rtlMoveVisually):f<0?w.from():w.to()},Ie)}),deleteH:er(function(f,g){var S=this.doc.sel,w=this.doc;S.somethingSelected()?w.replaceSelection("",null,"+delete"):tc(this,function(T){var L=lv(w,T.head,f,g,!1);return f<0?{from:L,to:T.head}:{from:T.head,to:L}})}),findPosV:function(f,g,S,w){var T=1,L=w;g<0&&(T=-1,g=-g);for(var A=ve(this.doc,f),F=0;F<g;++F){var z=Pi(this,A,"div");if(L==null?L=z.left:z.left=L,A=Pk(this,z,T,S),A.hitSide)break}return A},moveV:er(function(f,g){var S=this,w=this.doc,T=[],L=!this.display.shift&&!w.extend&&w.sel.somethingSelected();if(w.extendSelectionsBy(function(F){if(L)return f<0?F.from():F.to();var z=Pi(S,F.head,"div");F.goalColumn!=null&&(z.left=F.goalColumn),T.push(z.left);var Y=Pk(S,z,f,g);return g=="page"&&F==w.sel.primary()&&Wy(S,Iy(S,Y,"div").top-z.top),Y},Ie),T.length)for(var A=0;A<w.sel.ranges.length;A++)w.sel.ranges[A].goalColumn=T[A]}),findWordAt:function(f){var g=this.doc,S=ke(g,f.line).text,w=f.ch,T=f.ch;if(S){var L=this.getHelper(f,"wordChars");(f.sticky=="before"||T==S.length)&&w?--w:++T;for(var A=S.charAt(w),F=ki(A,L)?function(z){return ki(z,L)}:/\s/.test(A)?function(z){return/\s/.test(z)}:function(z){return!/\s/.test(z)&&!ki(z)};w>0&&F(S.charAt(w-1));)--w;for(;T<S.length&&F(S.charAt(T));)++T}return new ft(oe(f.line,w),oe(f.line,T))},toggleOverwrite:function(f){f!=null&&f==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?me(this.display.cursorDiv,"CodeMirror-overwrite"):B(this.display.cursorDiv,"CodeMirror-overwrite"),Ue(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==pe()},isReadOnly:function(){return!!(this.options.readOnly||this.doc.cantEdit)},scrollTo:er(function(f,g){Ru(this,f,g)}),getScrollInfo:function(){var f=this.display.scroller;return{left:f.scrollLeft,top:f.scrollTop,height:f.scrollHeight-da(this)-this.display.barHeight,width:f.scrollWidth-da(this)-this.display.barWidth,clientHeight:Py(this),clientWidth:Ds(this)}},scrollIntoView:er(function(f,g){f==null?(f={from:this.doc.sel.primary().head,to:null},g==null&&(g=this.options.cursorScrollMargin)):typeof f=="number"?f={from:oe(f,0),to:null}:f.from==null&&(f={from:f,to:null}),f.to||(f.to=f.from),f.margin=g||0,f.from.line!=null?dB(this,f):bT(this,f.from,f.to,f.margin)}),setSize:er(function(f,g){var S=this,w=function(L){return typeof L=="number"||/^\d+$/.test(String(L))?L+"px":L};f!=null&&(this.display.wrapper.style.width=w(f)),g!=null&&(this.display.wrapper.style.height=w(g)),this.options.lineWrapping&&sT(this);var T=this.display.viewFrom;this.doc.iter(T,this.display.viewTo,function(L){if(L.widgets){for(var A=0;A<L.widgets.length;A++)if(L.widgets[A].noHScroll){Mo(S,T,"widget");break}}++T}),this.curOp.forceUpdate=!0,Ue(this,"refresh",this)}),operation:function(f){return Ar(this,f)},startOperation:function(){return Vs(this)},endOperation:function(){return Os(this)},refresh:er(function(){var f=this.display.cachedTextHeight;fr(this),this.curOp.forceUpdate=!0,Iu(this),Ru(this,this.doc.scrollLeft,this.doc.scrollTop),$y(this.display),(f==null||Math.abs(f-Hl(this.display))>.5||this.options.lineWrapping)&&Ny(this),Ue(this,"refresh",this)}),swapDoc:er(function(f){var g=this.doc;return g.cm=null,this.state.selectingText&&this.state.selectingText(),_T(this,f),Iu(this),this.display.input.reset(),Ru(this,f.scrollLeft,f.scrollTop),this.curOp.forceScroll=!0,cn(this,"swapDoc",this,g),g}),phrase:function(f){var g=this.options.phrases;return g&&Object.prototype.hasOwnProperty.call(g,f)?g[f]:f},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},aa(s),s.registerHelper=function(f,g,S){h.hasOwnProperty(f)||(h[f]=s[f]={_global:[]}),h[f][g]=S},s.registerGlobalHelper=function(f,g,S,w){s.registerHelper(f,g,w),h[f]._global.push({pred:S,val:w})}}function lv(s,u,h,f,g){var S=u,w=h,T=ke(s,u.line),L=g&&s.direction=="rtl"?-h:h;function A(){var Se=u.line+L;return Se<s.first||Se>=s.first+s.size?!1:(u=new oe(Se,u.ch,u.sticky),T=ke(s,Se))}function F(Se){var he;if(f=="codepoint"){var xe=T.text.charCodeAt(u.ch+(h>0?0:-1));if(isNaN(xe))he=null;else{var De=h>0?xe>=55296&&xe<56320:xe>=56320&&xe<57343;he=new oe(u.line,Math.max(0,Math.min(T.text.length,u.ch+h*(De?2:1))),-h)}}else g?he=JB(s.cm,T,u,h):he=tv(T,u,h);if(he==null)if(!Se&&A())u=nv(g,s.cm,T,u.line,L);else return!1;else u=he;return!0}if(f=="char"||f=="codepoint")F();else if(f=="column")F(!0);else if(f=="word"||f=="group")for(var z=null,Y=f=="group",K=s.cm&&s.cm.getHelper(u,"wordChars"),Z=!0;!(h<0&&!F(!Z));Z=!1){var ie=T.text.charAt(u.ch)||`
`,de=ki(ie,K)?"w":Y&&ie==`
`?"n":!Y||/\s/.test(ie)?null:"p";if(Y&&!Z&&!de&&(de="s"),z&&z!=de){h<0&&(h=1,F(),u.sticky="after");break}if(de&&(z=de),h>0&&!F(!Z))break}var fe=Ef(s,u,S,w,!0);return $(S,fe)&&(fe.hitSide=!0),fe}function Pk(s,u,h,f){var g=s.doc,S=u.left,w;if(f=="page"){var T=Math.min(s.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),L=Math.max(T-.5*Hl(s.display),3);w=(h>0?u.bottom:u.top)+h*L}else f=="line"&&(w=h>0?u.bottom+3:u.top-3);for(var A;A=Ry(s,S,w),!!A.outside;){if(h<0?w<=0:w>=g.height){A.hitSide=!0;break}w+=h*5}return A}var yt=function(s){this.cm=s,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Ze,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};yt.prototype.init=function(s){var u=this,h=this,f=h.cm,g=h.div=s.lineDiv;g.contentEditable=!0,Lk(g,f.options.spellcheck,f.options.autocorrect,f.options.autocapitalize);function S(T){for(var L=T.target;L;L=L.parentNode){if(L==g)return!0;if(/\bCodeMirror-(?:line)?widget\b/.test(L.className))break}return!1}Ve(g,"paste",function(T){!S(T)||Kt(f,T)||wk(T,f)||l<=11&&setTimeout(un(f,function(){return u.updateFromDOM()}),20)}),Ve(g,"compositionstart",function(T){u.composing={data:T.data,done:!1}}),Ve(g,"compositionupdate",function(T){u.composing||(u.composing={data:T.data,done:!1})}),Ve(g,"compositionend",function(T){u.composing&&(T.data!=u.composing.data&&u.readFromDOMSoon(),u.composing.done=!0)}),Ve(g,"touchstart",function(){return h.forceCompositionEnd()}),Ve(g,"input",function(){u.composing||u.readFromDOMSoon()});function w(T){if(!(!S(T)||Kt(f,T))){if(f.somethingSelected())Rf({lineWise:!1,text:f.getSelections()}),T.type=="cut"&&f.replaceSelection("",null,"cut");else if(f.options.lineWiseCopyCut){var L=kk(f);Rf({lineWise:!0,text:L.text}),T.type=="cut"&&f.operation(function(){f.setSelections(L.ranges,0,je),f.replaceSelection("",null,"cut")})}else return;if(T.clipboardData){T.clipboardData.clearData();var A=Ai.text.join(`
`);if(T.clipboardData.setData("Text",A),T.clipboardData.getData("Text")==A){T.preventDefault();return}}var F=Ek(),z=F.firstChild;f.display.lineSpace.insertBefore(F,f.display.lineSpace.firstChild),z.value=Ai.text.join(`
`);var Y=pe();se(z),setTimeout(function(){f.display.lineSpace.removeChild(F),Y.focus(),Y==g&&h.showPrimarySelection()},50)}}Ve(g,"copy",w),Ve(g,"cut",w)},yt.prototype.screenReaderLabelChanged=function(s){s?this.div.setAttribute("aria-label",s):this.div.removeAttribute("aria-label")},yt.prototype.prepareSelection=function(){var s=gT(this.cm,!1);return s.focus=pe()==this.div,s},yt.prototype.showSelection=function(s,u){!s||!this.cm.display.view.length||((s.focus||u)&&this.showPrimarySelection(),this.showMultipleSelections(s))},yt.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},yt.prototype.showPrimarySelection=function(){var s=this.getSelection(),u=this.cm,h=u.doc.sel.primary(),f=h.from(),g=h.to();if(u.display.viewTo==u.display.viewFrom||f.line>=u.display.viewTo||g.line<u.display.viewFrom){s.removeAllRanges();return}var S=_f(u,s.anchorNode,s.anchorOffset),w=_f(u,s.focusNode,s.focusOffset);if(!(S&&!S.bad&&w&&!w.bad&&R(Fe(S,w),f)==0&&R(ue(S,w),g)==0)){var T=u.display.view,L=f.line>=u.display.viewFrom&&Dk(u,f)||{node:T[0].measure.map[2],offset:0},A=g.line<u.display.viewTo&&Dk(u,g);if(!A){var F=T[T.length-1].measure,z=F.maps?F.maps[F.maps.length-1]:F.map;A={node:z[z.length-1],offset:z[z.length-2]-z[z.length-3]}}if(!L||!A){s.removeAllRanges();return}var Y=s.rangeCount&&s.getRangeAt(0),K;try{K=q(L.node,L.offset,A.offset,A.node)}catch(Z){}K&&(!t&&u.state.focused?(s.collapse(L.node,L.offset),K.collapsed||(s.removeAllRanges(),s.addRange(K))):(s.removeAllRanges(),s.addRange(K)),Y&&s.anchorNode==null?s.addRange(Y):t&&this.startGracePeriod()),this.rememberSelection()}},yt.prototype.startGracePeriod=function(){var s=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){s.gracePeriod=!1,s.selectionChanged()&&s.cm.operation(function(){return s.cm.curOp.selectionChanged=!0})},20)},yt.prototype.showMultipleSelections=function(s){V(this.cm.display.cursorDiv,s.cursors),V(this.cm.display.selectionDiv,s.selection)},yt.prototype.rememberSelection=function(){var s=this.getSelection();this.lastAnchorNode=s.anchorNode,this.lastAnchorOffset=s.anchorOffset,this.lastFocusNode=s.focusNode,this.lastFocusOffset=s.focusOffset},yt.prototype.selectionInEditor=function(){var s=this.getSelection();if(!s.rangeCount)return!1;var u=s.getRangeAt(0).commonAncestorContainer;return ne(this.div,u)},yt.prototype.focus=function(){this.cm.options.readOnly!="nocursor"&&((!this.selectionInEditor()||pe()!=this.div)&&this.showSelection(this.prepareSelection(),!0),this.div.focus())},yt.prototype.blur=function(){this.div.blur()},yt.prototype.getField=function(){return this.div},yt.prototype.supportsTouch=function(){return!0},yt.prototype.receivedFocus=function(){var s=this;this.selectionInEditor()?this.pollSelection():Ar(this.cm,function(){return s.cm.curOp.selectionChanged=!0});function u(){s.cm.state.focused&&(s.pollSelection(),s.polling.set(s.cm.options.pollInterval,u))}this.polling.set(this.cm.options.pollInterval,u)},yt.prototype.selectionChanged=function(){var s=this.getSelection();return s.anchorNode!=this.lastAnchorNode||s.anchorOffset!=this.lastAnchorOffset||s.focusNode!=this.lastFocusNode||s.focusOffset!=this.lastFocusOffset},yt.prototype.pollSelection=function(){if(!(this.readDOMTimeout!=null||this.gracePeriod||!this.selectionChanged())){var s=this.getSelection(),u=this.cm;if(C&&p&&this.cm.display.gutterSpecs.length&&hU(s.anchorNode)){this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),this.focus();return}if(!this.composing){this.rememberSelection();var h=_f(u,s.anchorNode,s.anchorOffset),f=_f(u,s.focusNode,s.focusOffset);h&&f&&Ar(u,function(){Gn(u.doc,_o(h,f),je),(h.bad||f.bad)&&(u.curOp.selectionChanged=!0)})}}},yt.prototype.pollContent=function(){this.readDOMTimeout!=null&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var s=this.cm,u=s.display,h=s.doc.sel.primary(),f=h.from(),g=h.to();if(f.ch==0&&f.line>s.firstLine()&&(f=oe(f.line-1,ke(s.doc,f.line-1).length)),g.ch==ke(s.doc,g.line).text.length&&g.line<s.lastLine()&&(g=oe(g.line+1,0)),f.line<u.viewFrom||g.line>u.viewTo-1)return!1;var S,w,T;f.line==u.viewFrom||(S=Ms(s,f.line))==0?(w=pt(u.view[0].line),T=u.view[0].node):(w=pt(u.view[S].line),T=u.view[S-1].node.nextSibling);var L=Ms(s,g.line),A,F;if(L==u.view.length-1?(A=u.viewTo-1,F=u.lineDiv.lastChild):(A=pt(u.view[L+1].line)-1,F=u.view[L+1].node.previousSibling),!T)return!1;for(var z=s.doc.splitLines(mU(s,T,F,w,A)),Y=sa(s.doc,oe(w,0),oe(A,ke(s.doc,A).text.length));z.length>1&&Y.length>1;)if(tt(z)==tt(Y))z.pop(),Y.pop(),A--;else if(z[0]==Y[0])z.shift(),Y.shift(),w++;else break;for(var K=0,Z=0,ie=z[0],de=Y[0],fe=Math.min(ie.length,de.length);K<fe&&ie.charCodeAt(K)==de.charCodeAt(K);)++K;for(var Se=tt(z),he=tt(Y),xe=Math.min(Se.length-(z.length==1?K:0),he.length-(Y.length==1?K:0));Z<xe&&Se.charCodeAt(Se.length-Z-1)==he.charCodeAt(he.length-Z-1);)++Z;if(z.length==1&&Y.length==1&&w==f.line)for(;K&&K>f.ch&&Se.charCodeAt(Se.length-Z-1)==he.charCodeAt(he.length-Z-1);)K--,Z++;z[z.length-1]=Se.slice(0,Se.length-Z).replace(/^\u200b+/,""),z[0]=z[0].slice(K).replace(/\u200b+$/,"");var De=oe(w,K),Ee=oe(A,Y.length?tt(Y).length-Z:0);if(z.length>1||z[0]||R(De,Ee))return Ql(s.doc,z,De,Ee,"+input"),!0},yt.prototype.ensurePolled=function(){this.forceCompositionEnd()},yt.prototype.reset=function(){this.forceCompositionEnd()},yt.prototype.forceCompositionEnd=function(){!this.composing||(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},yt.prototype.readFromDOMSoon=function(){var s=this;this.readDOMTimeout==null&&(this.readDOMTimeout=setTimeout(function(){if(s.readDOMTimeout=null,s.composing)if(s.composing.done)s.composing=null;else return;s.updateFromDOM()},80))},yt.prototype.updateFromDOM=function(){var s=this;(this.cm.isReadOnly()||!this.pollContent())&&Ar(this.cm,function(){return fr(s.cm)})},yt.prototype.setUneditable=function(s){s.contentEditable="false"},yt.prototype.onKeyPress=function(s){s.charCode==0||this.composing||(s.preventDefault(),this.cm.isReadOnly()||un(this.cm,sv)(this.cm,String.fromCharCode(s.charCode==null?s.keyCode:s.charCode),0))},yt.prototype.readOnlyChanged=function(s){this.div.contentEditable=String(s!="nocursor")},yt.prototype.onContextMenu=function(){},yt.prototype.resetPosition=function(){},yt.prototype.needsContentAttribute=!0;function Dk(s,u){var h=Dy(s,u.line);if(!h||h.hidden)return null;var f=ke(s.doc,u.line),g=nT(h,f,u.line),S=Pr(f,s.doc.direction),w="left";if(S){var T=kt(S,u.ch);w=T%2?"right":"left"}var L=aT(g.map,u.ch,w);return L.offset=L.collapse=="right"?L.end:L.start,L}function hU(s){for(var u=s;u;u=u.parentNode)if(/CodeMirror-gutter-wrapper/.test(u.className))return!0;return!1}function rc(s,u){return u&&(s.bad=!0),s}function mU(s,u,h,f,g){var S="",w=!1,T=s.doc.lineSeparator(),L=!1;function A(K){return function(Z){return Z.id==K}}function F(){w&&(S+=T,L&&(S+=T),w=L=!1)}function z(K){K&&(F(),S+=K)}function Y(K){if(K.nodeType==1){var Z=K.getAttribute("cm-text");if(Z){z(Z);return}var ie=K.getAttribute("cm-marker"),de;if(ie){var fe=s.findMarks(oe(f,0),oe(g+1,0),A(+ie));fe.length&&(de=fe[0].find(0))&&z(sa(s.doc,de.from,de.to).join(T));return}if(K.getAttribute("contenteditable")=="false")return;var Se=/^(pre|div|p|li|table|br)$/i.test(K.nodeName);if(!/^br$/i.test(K.nodeName)&&K.textContent.length==0)return;Se&&F();for(var he=0;he<K.childNodes.length;he++)Y(K.childNodes[he]);/^(pre|p)$/i.test(K.nodeName)&&(L=!0),Se&&(w=!0)}else K.nodeType==3&&z(K.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "))}for(;Y(u),u!=h;)u=u.nextSibling,L=!1;return S}function _f(s,u,h){var f;if(u==s.display.lineDiv){if(f=s.display.lineDiv.childNodes[h],!f)return rc(s.clipPos(oe(s.display.viewTo-1)),!0);u=null,h=0}else for(f=u;;f=f.parentNode){if(!f||f==s.display.lineDiv)return null;if(f.parentNode&&f.parentNode==s.display.lineDiv)break}for(var g=0;g<s.display.view.length;g++){var S=s.display.view[g];if(S.node==f)return gU(S,u,h)}}function gU(s,u,h){var f=s.text.firstChild,g=!1;if(!u||!ne(f,u))return rc(oe(pt(s.line),0),!0);if(u==f&&(g=!0,u=f.childNodes[h],h=0,!u)){var S=s.rest?tt(s.rest):s.line;return rc(oe(pt(S),S.text.length),g)}var w=u.nodeType==3?u:null,T=u;for(!w&&u.childNodes.length==1&&u.firstChild.nodeType==3&&(w=u.firstChild,h&&(h=w.nodeValue.length));T.parentNode!=f;)T=T.parentNode;var L=s.measure,A=L.maps;function F(de,fe,Se){for(var he=-1;he<(A?A.length:0);he++)for(var xe=he<0?L.map:A[he],De=0;De<xe.length;De+=3){var Ee=xe[De+2];if(Ee==de||Ee==fe){var Ke=pt(he<0?s.line:s.rest[he]),Ct=xe[De]+Se;return(Se<0||Ee!=de)&&(Ct=xe[De+(Se?1:0)]),oe(Ke,Ct)}}}var z=F(w,T,h);if(z)return rc(z,g);for(var Y=T.nextSibling,K=w?w.nodeValue.length-h:0;Y;Y=Y.nextSibling){if(z=F(Y,Y.firstChild,0),z)return rc(oe(z.line,z.ch-K),g);K+=Y.textContent.length}for(var Z=T.previousSibling,ie=h;Z;Z=Z.previousSibling){if(z=F(Z,Z.firstChild,-1),z)return rc(oe(z.line,z.ch+ie),g);ie+=Z.textContent.length}}var Ht=function(s){this.cm=s,this.prevInput="",this.pollingFast=!1,this.polling=new Ze,this.hasSelection=!1,this.composing=null};Ht.prototype.init=function(s){var u=this,h=this,f=this.cm;this.createField(s);var g=this.textarea;s.wrapper.insertBefore(this.wrapper,s.wrapper.firstChild),x&&(g.style.width="0px"),Ve(g,"input",function(){o&&l>=9&&u.hasSelection&&(u.hasSelection=null),h.poll()}),Ve(g,"paste",function(w){Kt(f,w)||wk(w,f)||(f.state.pasteIncoming=+new Date,h.fastPoll())});function S(w){if(!Kt(f,w)){if(f.somethingSelected())Rf({lineWise:!1,text:f.getSelections()});else if(f.options.lineWiseCopyCut){var T=kk(f);Rf({lineWise:!0,text:T.text}),w.type=="cut"?f.setSelections(T.ranges,null,je):(h.prevInput="",g.value=T.text.join(`
`),se(g))}else return;w.type=="cut"&&(f.state.cutIncoming=+new Date)}}Ve(g,"cut",S),Ve(g,"copy",S),Ve(s.scroller,"paste",function(w){if(!(Ja(s,w)||Kt(f,w))){if(!g.dispatchEvent){f.state.pasteIncoming=+new Date,h.focus();return}var T=new Event("paste");T.clipboardData=w.clipboardData,g.dispatchEvent(T)}}),Ve(s.lineSpace,"selectstart",function(w){Ja(s,w)||Un(w)}),Ve(g,"compositionstart",function(){var w=f.getCursor("from");h.composing&&h.composing.range.clear(),h.composing={start:w,range:f.markText(w,f.getCursor("to"),{className:"CodeMirror-composing"})}}),Ve(g,"compositionend",function(){h.composing&&(h.poll(),h.composing.range.clear(),h.composing=null)})},Ht.prototype.createField=function(s){this.wrapper=Ek(),this.textarea=this.wrapper.firstChild},Ht.prototype.screenReaderLabelChanged=function(s){s?this.textarea.setAttribute("aria-label",s):this.textarea.removeAttribute("aria-label")},Ht.prototype.prepareSelection=function(){var s=this.cm,u=s.display,h=s.doc,f=gT(s);if(s.options.moveInputWithCursor){var g=Pi(s,h.sel.primary().head,"div"),S=u.wrapper.getBoundingClientRect(),w=u.lineDiv.getBoundingClientRect();f.teTop=Math.max(0,Math.min(u.wrapper.clientHeight-10,g.top+w.top-S.top)),f.teLeft=Math.max(0,Math.min(u.wrapper.clientWidth-10,g.left+w.left-S.left))}return f},Ht.prototype.showSelection=function(s){var u=this.cm,h=u.display;V(h.cursorDiv,s.cursors),V(h.selectionDiv,s.selection),s.teTop!=null&&(this.wrapper.style.top=s.teTop+"px",this.wrapper.style.left=s.teLeft+"px")},Ht.prototype.reset=function(s){if(!(this.contextMenuPending||this.composing)){var u=this.cm;if(u.somethingSelected()){this.prevInput="";var h=u.getSelection();this.textarea.value=h,u.state.focused&&se(this.textarea),o&&l>=9&&(this.hasSelection=h)}else s||(this.prevInput=this.textarea.value="",o&&l>=9&&(this.hasSelection=null))}},Ht.prototype.getField=function(){return this.textarea},Ht.prototype.supportsTouch=function(){return!1},Ht.prototype.focus=function(){if(this.cm.options.readOnly!="nocursor"&&(!k||pe()!=this.textarea))try{this.textarea.focus()}catch(s){}},Ht.prototype.blur=function(){this.textarea.blur()},Ht.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Ht.prototype.receivedFocus=function(){this.slowPoll()},Ht.prototype.slowPoll=function(){var s=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){s.poll(),s.cm.state.focused&&s.slowPoll()})},Ht.prototype.fastPoll=function(){var s=!1,u=this;u.pollingFast=!0;function h(){var f=u.poll();!f&&!s?(s=!0,u.polling.set(60,h)):(u.pollingFast=!1,u.slowPoll())}u.polling.set(20,h)},Ht.prototype.poll=function(){var s=this,u=this.cm,h=this.textarea,f=this.prevInput;if(this.contextMenuPending||!u.state.focused||af(h)&&!f&&!this.composing||u.isReadOnly()||u.options.disableInput||u.state.keySeq)return!1;var g=h.value;if(g==f&&!u.somethingSelected())return!1;if(o&&l>=9&&this.hasSelection===g||D&&/[\uf700-\uf7ff]/.test(g))return u.display.input.reset(),!1;if(u.doc.sel==u.display.selForContextMenu){var S=g.charCodeAt(0);if(S==8203&&!f&&(f="\u200B"),S==8666)return this.reset(),this.cm.execCommand("undo")}for(var w=0,T=Math.min(f.length,g.length);w<T&&f.charCodeAt(w)==g.charCodeAt(w);)++w;return Ar(u,function(){sv(u,g.slice(w),f.length-w,null,s.composing?"*compose":null),g.length>1e3||g.indexOf(`
`)>-1?h.value=s.prevInput="":s.prevInput=g,s.composing&&(s.composing.range.clear(),s.composing.range=u.markText(s.composing.start,u.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Ht.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Ht.prototype.onKeyPress=function(){o&&l>=9&&(this.hasSelection=null),this.fastPoll()},Ht.prototype.onContextMenu=function(s){var u=this,h=u.cm,f=h.display,g=u.textarea;u.contextMenuPending&&u.contextMenuPending();var S=Is(h,s),w=f.scroller.scrollTop;if(!S||m)return;var T=h.options.resetSelectionOnContextMenu;T&&h.doc.sel.contains(S)==-1&&un(h,Gn)(h.doc,_o(S),je);var L=g.style.cssText,A=u.wrapper.style.cssText,F=u.wrapper.offsetParent.getBoundingClientRect();u.wrapper.style.cssText="position: static",g.style.cssText=`position: absolute; width: 30px; height: 30px;
      top: `+(s.clientY-F.top-5)+"px; left: "+(s.clientX-F.left-5)+`px;
      z-index: 1000; background: `+(o?"rgba(255, 255, 255, .05)":"transparent")+`;
      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);`;var z;c&&(z=window.scrollY),f.input.focus(),c&&window.scrollTo(null,z),f.input.reset(),h.somethingSelected()||(g.value=u.prevInput=" "),u.contextMenuPending=K,f.selForContextMenu=h.doc.sel,clearTimeout(f.detectingSelectAll);function Y(){if(g.selectionStart!=null){var ie=h.somethingSelected(),de="\u200B"+(ie?g.value:"");g.value="\u21DA",g.value=de,u.prevInput=ie?"":"\u200B",g.selectionStart=1,g.selectionEnd=de.length,f.selForContextMenu=h.doc.sel}}function K(){if(u.contextMenuPending==K&&(u.contextMenuPending=!1,u.wrapper.style.cssText=A,g.style.cssText=L,o&&l<9&&f.scrollbars.setScrollTop(f.scroller.scrollTop=w),g.selectionStart!=null)){(!o||o&&l<9)&&Y();var ie=0,de=function(){f.selForContextMenu==h.doc.sel&&g.selectionStart==0&&g.selectionEnd>0&&u.prevInput=="\u200B"?un(h,qT)(h):ie++<10?f.detectingSelectAll=setTimeout(de,500):(f.selForContextMenu=null,f.input.reset())};f.detectingSelectAll=setTimeout(de,200)}}if(o&&l>=9&&Y(),_){Es(s);var Z=function(){dr(window,"mouseup",Z),setTimeout(K,20)};Ve(window,"mouseup",Z)}else setTimeout(K,50)},Ht.prototype.readOnlyChanged=function(s){s||this.reset(),this.textarea.disabled=s=="nocursor",this.textarea.readOnly=!!s},Ht.prototype.setUneditable=function(){},Ht.prototype.needsContentAttribute=!1;function yU(s,u){if(u=u?Ae(u):{},u.value=s.value,!u.tabindex&&s.tabIndex&&(u.tabindex=s.tabIndex),!u.placeholder&&s.placeholder&&(u.placeholder=s.placeholder),u.autofocus==null){var h=pe();u.autofocus=h==s||s.getAttribute("autofocus")!=null&&h==document.body}function f(){s.value=T.getValue()}var g;if(s.form&&(Ve(s.form,"submit",f),!u.leaveSubmitMethodAlone)){var S=s.form;g=S.submit;try{var w=S.submit=function(){f(),S.submit=g,S.submit(),S.submit=w}}catch(L){}}u.finishInit=function(L){L.save=f,L.getTextArea=function(){return s},L.toTextArea=function(){L.toTextArea=isNaN,f(),s.parentNode.removeChild(L.getWrapperElement()),s.style.display="",s.form&&(dr(s.form,"submit",f),!u.leaveSubmitMethodAlone&&typeof s.form.submit=="function"&&(s.form.submit=g))}},s.style.display="none";var T=_t(function(L){return s.parentNode.insertBefore(L,s.nextSibling)},u);return T}function vU(s){s.off=dr,s.on=Ve,s.wheelEventPixels=kB,s.Doc=hr,s.splitLines=bu,s.countColumn=Be,s.findColumn=lt,s.isWordChar=ai,s.Pass=We,s.signal=Ue,s.Line=Gl,s.changeEnd=Vo,s.scrollbarModel=wT,s.Pos=oe,s.cmpPos=R,s.modes=oi,s.mimeModes=Wr,s.resolveMode=Bl,s.getMode=Ul,s.modeExtensions=Li,s.extendMode=Ei,s.copyState=zr,s.startState=wu,s.innerMode=Cu,s.commands=Ju,s.keyMap=Ka,s.keyName=ck,s.isModifierKey=sk,s.lookupKey=ec,s.normalizeKeyMap=qB,s.StringStream=Bt,s.SharedTextMarker=$u,s.TextMarker=No,s.LineWidget=Hu,s.e_preventDefault=Un,s.e_stopPropagation=Nl,s.e_stop=Es,s.addClass=me,s.contains=ne,s.rmClass=B,s.keyNames=Bo}cU(_t),fU(_t);var SU="iter insert remove copy getEditor constructor".split(" ");for(var Vf in hr.prototype)hr.prototype.hasOwnProperty(Vf)&&ge(SU,Vf)<0&&(_t.prototype[Vf]=function(s){return function(){return s.apply(this.doc,arguments)}}(hr.prototype[Vf]));return aa(hr),_t.inputStyles={textarea:Ht,contenteditable:yt},_t.defineMode=function(s){!_t.defaults.mode&&s!="null"&&(_t.defaults.mode=s),sf.apply(this,arguments)},_t.defineMIME=$a,_t.defineMode("null",function(){return{token:function(s){return s.skipToEnd()}}}),_t.defineMIME("text/plain","null"),_t.defineExtension=function(s,u){_t.prototype[s]=u},_t.defineDocExtension=function(s,u){hr.prototype[s]=u},_t.fromTextArea=yU,vU(_t),_t.version="5.61.1",_t})});var N_=$t((V_,O_)=>{(function(n){typeof V_=="object"&&typeof O_=="object"?n(ms()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";n.defineMode("javascript",function(e,t){var r=e.indentUnit,i=t.statementIndent,a=t.jsonld,o=t.json||a,l=t.trackScope!==!1,c=t.typescript,d=t.wordCharacters||/[\w$\xa1-\uffff]/,p=function(){function R(Fn){return{type:Fn,style:"keyword"}}var $=R("keyword a"),te=R("keyword b"),ue=R("keyword c"),Fe=R("keyword d"),it=R("operator"),ve={type:"atom",style:"atom"};return{if:R("if"),while:$,with:$,else:te,do:te,try:te,finally:te,return:Fe,break:Fe,continue:Fe,new:R("new"),delete:ue,void:ue,throw:ue,debugger:R("debugger"),var:R("var"),const:R("var"),let:R("var"),function:R("function"),catch:R("catch"),for:R("for"),switch:R("switch"),case:R("case"),default:R("default"),in:it,typeof:it,instanceof:it,true:ve,false:ve,null:ve,undefined:ve,NaN:ve,Infinity:ve,this:R("this"),class:R("class"),super:R("atom"),yield:ue,export:R("export"),import:R("import"),extends:ue,await:ue}}(),m=/[+\-*&%=<>!?|~^@]/,y=/^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;function v(R){for(var $=!1,te,ue=!1;(te=R.next())!=null;){if(!$){if(te=="/"&&!ue)return;te=="["?ue=!0:ue&&te=="]"&&(ue=!1)}$=!$&&te=="\\"}}var b,x;function C(R,$,te){return b=R,x=te,$}function k(R,$){var te=R.next();if(te=='"'||te=="'")return $.tokenize=D(te),$.tokenize(R,$);if(te=="."&&R.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/))return C("number","number");if(te=="."&&R.match(".."))return C("spread","meta");if(/[\[\]{}\(\),;\:\.]/.test(te))return C(te);if(te=="="&&R.eat(">"))return C("=>","operator");if(te=="0"&&R.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return C("number","number");if(/\d/.test(te))return R.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),C("number","number");if(te=="/")return R.eat("*")?($.tokenize=P,P(R,$)):R.eat("/")?(R.skipToEnd(),C("comment","comment")):oe(R,$,1)?(v(R),R.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/),C("regexp","string-2")):(R.eat("="),C("operator","operator",R.current()));if(te=="`")return $.tokenize=M,M(R,$);if(te=="#"&&R.peek()=="!")return R.skipToEnd(),C("meta","meta");if(te=="#"&&R.eatWhile(d))return C("variable","property");if(te=="<"&&R.match("!--")||te=="-"&&R.match("->")&&!/\S/.test(R.string.slice(0,R.start)))return R.skipToEnd(),C("comment","comment");if(m.test(te))return(te!=">"||!$.lexical||$.lexical.type!=">")&&(R.eat("=")?(te=="!"||te=="=")&&R.eat("="):/[<>*+\-|&?]/.test(te)&&(R.eat(te),te==">"&&R.eat(te))),te=="?"&&R.eat(".")?C("."):C("operator","operator",R.current());if(d.test(te)){R.eatWhile(d);var ue=R.current();if($.lastType!="."){if(p.propertyIsEnumerable(ue)){var Fe=p[ue];return C(Fe.type,Fe.style,ue)}if(ue=="async"&&R.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/,!1))return C("async","keyword",ue)}return C("variable","variable",ue)}}function D(R){return function($,te){var ue=!1,Fe;if(a&&$.peek()=="@"&&$.match(y))return te.tokenize=k,C("jsonld-keyword","meta");for(;(Fe=$.next())!=null&&!(Fe==R&&!ue);)ue=!ue&&Fe=="\\";return ue||(te.tokenize=k),C("string","string")}}function P(R,$){for(var te=!1,ue;ue=R.next();){if(ue=="/"&&te){$.tokenize=k;break}te=ue=="*"}return C("comment","comment")}function M(R,$){for(var te=!1,ue;(ue=R.next())!=null;){if(!te&&(ue=="`"||ue=="$"&&R.eat("{"))){$.tokenize=k;break}te=!te&&ue=="\\"}return C("quasi","string-2",R.current())}var I="([{}])";function E(R,$){$.fatArrowAt&&($.fatArrowAt=null);var te=R.string.indexOf("=>",R.start);if(!(te<0)){if(c){var ue=/:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(R.string.slice(R.start,te));ue&&(te=ue.index)}for(var Fe=0,it=!1,ve=te-1;ve>=0;--ve){var Fn=R.string.charAt(ve),Hr=I.indexOf(Fn);if(Hr>=0&&Hr<3){if(!Fe){++ve;break}if(--Fe==0){Fn=="("&&(it=!0);break}}else if(Hr>=3&&Hr<6)++Fe;else if(d.test(Fn))it=!0;else if(/["'\/`]/.test(Fn))for(;;--ve){if(ve==0)return;var Fl=R.string.charAt(ve-1);if(Fl==Fn&&R.string.charAt(ve-2)!="\\"){ve--;break}}else if(it&&!Fe){++ve;break}}it&&!Fe&&($.fatArrowAt=ve)}}var _={atom:!0,number:!0,variable:!0,string:!0,regexp:!0,this:!0,import:!0,"jsonld-keyword":!0};function O(R,$,te,ue,Fe,it){this.indented=R,this.column=$,this.type=te,this.prev=Fe,this.info=it,ue!=null&&(this.align=ue)}function B(R,$){if(!l)return!1;for(var te=R.localVars;te;te=te.next)if(te.name==$)return!0;for(var ue=R.context;ue;ue=ue.prev)for(var te=ue.vars;te;te=te.next)if(te.name==$)return!0}function W(R,$,te,ue,Fe){var it=R.cc;for(V.state=R,V.stream=Fe,V.marked=null,V.cc=it,V.style=$,R.lexical.hasOwnProperty("align")||(R.lexical.align=!0);;){var ve=it.length?it.pop():o?Ie:je;if(ve(te,ue)){for(;it.length&&it[it.length-1].lex;)it.pop()();return V.marked?V.marked:te=="variable"&&B(R,ue)?"variable-2":$}}}var V={state:null,column:null,marked:null,cc:null};function U(){for(var R=arguments.length-1;R>=0;R--)V.cc.push(arguments[R])}function N(){return U.apply(null,arguments),!0}function q(R,$){for(var te=$;te;te=te.next)if(te.name==R)return!0;return!1}function ne(R){var $=V.state;if(V.marked="def",!!l){if($.context){if($.lexical.info=="var"&&$.context&&$.context.block){var te=pe(R,$.context);if(te!=null){$.context=te;return}}else if(!q(R,$.localVars)){$.localVars=new se(R,$.localVars);return}}t.globalVars&&!q(R,$.globalVars)&&($.globalVars=new se(R,$.globalVars))}}function pe(R,$){if($)if($.block){var te=pe(R,$.prev);return te?te==$.prev?$:new Pe(te,$.vars,!0):null}else return q(R,$.vars)?$:new Pe($.prev,new se(R,$.vars),!1);else return null}function me(R){return R=="public"||R=="private"||R=="protected"||R=="abstract"||R=="readonly"}function Pe(R,$,te){this.prev=R,this.vars=$,this.block=te}function se(R,$){this.name=R,this.next=$}var Te=new se("this",new se("arguments",null));function Ae(){V.state.context=new Pe(V.state.context,V.state.localVars,!1),V.state.localVars=Te}function Be(){V.state.context=new Pe(V.state.context,V.state.localVars,!0),V.state.localVars=null}function Ze(){V.state.localVars=V.state.context.vars,V.state.context=V.state.context.prev}Ze.lex=!0;function ge(R,$){var te=function(){var ue=V.state,Fe=ue.indented;if(ue.lexical.type=="stat")Fe=ue.lexical.indented;else for(var it=ue.lexical;it&&it.type==")"&&it.align;it=it.prev)Fe=it.indented;ue.lexical=new O(Fe,V.stream.column(),R,null,ue.lexical,$)};return te.lex=!0,te}function Le(){var R=V.state;R.lexical.prev&&(R.lexical.type==")"&&(R.indented=R.lexical.indented),R.lexical=R.lexical.prev)}Le.lex=!0;function We(R){function $(te){return te==R?N():R==";"||te=="}"||te==")"||te=="]"?U():N($)}return $}function je(R,$){return R=="var"?N(ge("vardef",$),vu,We(";"),Le):R=="keyword a"?N(ge("form"),Zn,je,Le):R=="keyword b"?N(ge("form"),je,Le):R=="keyword d"?V.stream.match(/^\s*$/,!1)?N():N(ge("stat"),tt,We(";"),Le):R=="debugger"?N(We(";")):R=="{"?N(ge("}"),Be,Pr,Le,Ze):R==";"?N():R=="if"?(V.state.lexical.info=="else"&&V.state.cc[V.state.cc.length-1]==Le&&V.state.cc.pop()(),N(ge("form"),Zn,je,Le,af)):R=="function"?N(oi):R=="for"?N(ge("form"),Be,of,je,Ze,Le):R=="class"||c&&$=="interface"?(V.marked="keyword",N(ge("form",R=="class"?R:$),Ul,Le)):R=="variable"?c&&$=="declare"?(V.marked="keyword",N(je)):c&&($=="module"||$=="enum"||$=="type")&&V.stream.match(/^\s*\w/,!1)?(V.marked="keyword",$=="enum"?N(la):$=="type"?N(sf,We("operator"),Ue,We(";")):N(ge("form"),pr,We("{"),ge("}"),Pr,Le,Le)):c&&$=="namespace"?(V.marked="keyword",N(ge("form"),Ie,je,Le)):c&&$=="abstract"?(V.marked="keyword",N(je)):N(ge("stat"),_l):R=="switch"?N(ge("form"),Zn,We("{"),ge("}","switch"),Be,Pr,Le,Le,Ze):R=="case"?N(Ie,We(":")):R=="default"?N(We(":")):R=="catch"?N(ge("form"),Ae,et,je,Le,Ze):R=="export"?N(ge("stat"),Cu,Le):R=="import"?N(ge("stat"),Bt,Le):R=="async"?N(je):$=="@"?N(Ie,je):U(ge("stat"),Ie,We(";"),Le)}function et(R){if(R=="(")return N($a,We(")"))}function Ie(R,$){return ea(R,$,!1)}function lt(R,$){return ea(R,$,!0)}function Zn(R){return R!="("?U():N(ge(")"),tt,We(")"),Le)}function ea(R,$,te){if(V.state.fatArrowAt==V.stream.start){var ue=te?ai:ia;if(R=="(")return N(Ae,ge(")"),kt($a,")"),Le,We("=>"),ue,Ze);if(R=="variable")return U(Ae,pr,We("=>"),ue,Ze)}var Fe=te?ta:Er;return _.hasOwnProperty(R)?N(Fe):R=="function"?N(oi,Fe):R=="class"||c&&$=="interface"?(V.marked="keyword",N(ge("form"),Bl,Le)):R=="keyword c"||R=="async"?N(te?lt:Ie):R=="("?N(ge(")"),tt,We(")"),Le,Fe):R=="operator"||R=="spread"?N(te?lt:Ie):R=="["?N(ge("]"),pt,Le,Fe):R=="{"?Ls(Bn,"}",null,Fe):R=="quasi"?U(na,Fe):R=="new"?N(ki(te)):N()}function tt(R){return R.match(/[;\}\)\],]/)?U():U(Ie)}function Er(R,$){return R==","?N(tt):ta(R,$,!1)}function ta(R,$,te){var ue=te==!1?Er:ta,Fe=te==!1?Ie:lt;if(R=="=>")return N(Ae,te?ai:ia,Ze);if(R=="operator")return/\+\+|--/.test($)||c&&$=="!"?N(ue):c&&$=="<"&&V.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/,!1)?N(ge(">"),kt(Ue,">"),Le,ue):$=="?"?N(Ie,We(":"),Fe):N(Fe);if(R=="quasi")return U(na,ue);if(R!=";"){if(R=="(")return Ls(lt,")","call",ue);if(R==".")return N(Po,ue);if(R=="[")return N(ge("]"),tt,We("]"),Le,ue);if(c&&$=="as")return V.marked="keyword",N(Ue,ue);if(R=="regexp")return V.state.lastType=V.marked="operator",V.stream.backUp(V.stream.pos-V.stream.start-1),N(Fe)}}function na(R,$){return R!="quasi"?U():$.slice($.length-2)!="${"?N(na):N(Ie,ra)}function ra(R){if(R=="}")return V.marked="string-2",V.state.tokenize=M,N(na)}function ia(R){return E(V.stream,V.state),U(R=="{"?je:Ie)}function ai(R){return E(V.stream,V.state),U(R=="{"?je:lt)}function ki(R){return function($){return $=="."?N(R?Eo:za):$=="variable"&&c?N(Es,R?ta:Er):U(R?lt:Ie)}}function za(R,$){if($=="target")return V.marked="keyword",N(Er)}function Eo(R,$){if($=="target")return V.marked="keyword",N(ta)}function _l(R){return R==":"?N(Le,je):U(Er,We(";"),Le)}function Po(R){if(R=="variable")return V.marked="property",N()}function Bn(R,$){if(R=="async")return V.marked="property",N(Bn);if(R=="variable"||V.style=="keyword"){if(V.marked="property",$=="get"||$=="set")return N(yu);var te;return c&&V.state.fatArrowAt==V.stream.start&&(te=V.stream.match(/^\s*:\s*/,!1))&&(V.state.fatArrowAt=V.stream.pos+te[0].length),N(ur)}else{if(R=="number"||R=="string")return V.marked=a?"property":V.style+" property",N(ur);if(R=="jsonld-keyword")return N(ur);if(c&&me($))return V.marked="keyword",N(Bn);if(R=="[")return N(Ie,Ha,We("]"),ur);if(R=="spread")return N(lt,ur);if($=="*")return V.marked="keyword",N(Bn);if(R==":")return U(ur)}}function yu(R){return R!="variable"?U(ur):(V.marked="property",N(oi))}function ur(R){if(R==":")return N(lt);if(R=="(")return U(oi)}function kt(R,$,te){function ue(Fe,it){if(te?te.indexOf(Fe)>-1:Fe==","){var ve=V.state.lexical;return ve.info=="call"&&(ve.pos=(ve.pos||0)+1),N(function(Fn,Hr){return Fn==$||Hr==$?U():U(R)},ue)}return Fe==$||it==$?N():te&&te.indexOf(";")>-1?U(R):N(We($))}return function(Fe,it){return Fe==$||it==$?N():U(R,ue)}}function Ls(R,$,te){for(var ue=3;ue<arguments.length;ue++)V.cc.push(arguments[ue]);return N(ge($,te),kt(R,$),Le)}function Pr(R){return R=="}"?N():U(je,Pr)}function Ha(R,$){if(c){if(R==":")return N(Ue);if($=="?")return N(Ha)}}function Ve(R,$){if(c&&(R==":"||$=="in"))return N(Ue)}function Vl(R){if(c&&R==":")return V.stream.match(/^\s*\w+\s+is\b/,!1)?N(Ie,dr,Ue):N(Ue)}function dr(R,$){if($=="is")return V.marked="keyword",N()}function Ue(R,$){if($=="keyof"||$=="typeof"||$=="infer"||$=="readonly")return V.marked="keyword",N($=="typeof"?lt:Ue);if(R=="variable"||$=="void")return V.marked="type",N(Gr);if($=="|"||$=="&")return N(Ue);if(R=="string"||R=="number"||R=="atom")return N(Gr);if(R=="[")return N(ge("]"),kt(Ue,"]",","),Le,Gr);if(R=="{")return N(ge("}"),Ol,Le,Gr);if(R=="(")return N(kt(Nl,")"),Kt,Gr);if(R=="<")return N(kt(Ue,">"),Ue);if(R=="quasi")return U(aa,Gr)}function Kt(R){if(R=="=>")return N(Ue)}function Ol(R){return R.match(/[\}\)\]]/)?N():R==","||R==";"?N(Ol):U(kn,Ol)}function kn(R,$){if(R=="variable"||V.style=="keyword")return V.marked="property",N(kn);if($=="?"||R=="number"||R=="string")return N(kn);if(R==":")return N(Ue);if(R=="[")return N(We("variable"),Ve,We("]"),kn);if(R=="(")return U(Wr,kn);if(!R.match(/[;\}\)\],]/))return N()}function aa(R,$){return R!="quasi"?U():$.slice($.length-2)!="${"?N(aa):N(Ue,Un)}function Un(R){if(R=="}")return V.marked="string-2",V.state.tokenize=M,N(aa)}function Nl(R,$){return R=="variable"&&V.stream.match(/^\s*[?:]/,!1)||$=="?"?N(Nl):R==":"?N(Ue):R=="spread"?N(Nl):U(Ue)}function Gr(R,$){if($=="<")return N(ge(">"),kt(Ue,">"),Le,Gr);if($=="|"||R=="."||$=="&")return N(Ue);if(R=="[")return N(Ue,We("]"),Gr);if($=="extends"||$=="implements")return V.marked="keyword",N(Ue);if($=="?")return N(Ue,We(":"),Ue)}function Es(R,$){if($=="<")return N(ge(">"),kt(Ue,">"),Le,Gr)}function Do(){return U(Ue,nf)}function nf(R,$){if($=="=")return N(Ue)}function vu(R,$){return $=="enum"?(V.marked="keyword",N(la)):U(pr,Ha,oa,bu)}function pr(R,$){if(c&&me($))return V.marked="keyword",N(pr);if(R=="variable")return ne($),N();if(R=="spread")return N(pr);if(R=="[")return Ls(Su,"]");if(R=="{")return Ls(rf,"}")}function rf(R,$){return R=="variable"&&!V.stream.match(/^\s*:/,!1)?(ne($),N(oa)):(R=="variable"&&(V.marked="property"),R=="spread"?N(pr):R=="}"?U():R=="["?N(Ie,We("]"),We(":"),rf):N(We(":"),pr,oa))}function Su(){return U(pr,oa)}function oa(R,$){if($=="=")return N(lt)}function bu(R){if(R==",")return N(vu)}function af(R,$){if(R=="keyword b"&&$=="else")return N(ge("form","else"),je,Le)}function of(R,$){if($=="await")return N(of);if(R=="(")return N(ge(")"),xu,Le)}function xu(R){return R=="var"?N(vu,Ao):R=="variable"?N(Ao):U(Ao)}function Ao(R,$){return R==")"?N():R==";"?N(Ao):$=="in"||$=="of"?(V.marked="keyword",N(Ie,Ao)):U(Ie,Ao)}function oi(R,$){if($=="*")return V.marked="keyword",N(oi);if(R=="variable")return ne($),N(oi);if(R=="(")return N(Ae,ge(")"),kt($a,")"),Le,Vl,je,Ze);if(c&&$=="<")return N(ge(">"),kt(Do,">"),Le,oi)}function Wr(R,$){if($=="*")return V.marked="keyword",N(Wr);if(R=="variable")return ne($),N(Wr);if(R=="(")return N(Ae,ge(")"),kt($a,")"),Le,Vl,Ze);if(c&&$=="<")return N(ge(">"),kt(Do,">"),Le,Wr)}function sf(R,$){if(R=="keyword"||R=="variable")return V.marked="type",N(sf);if($=="<")return N(ge(">"),kt(Do,">"),Le)}function $a(R,$){return $=="@"&&N(Ie,$a),R=="spread"?N($a):c&&me($)?(V.marked="keyword",N($a)):c&&R=="this"?N(Ha,oa):U(pr,Ha,oa)}function Bl(R,$){return R=="variable"?Ul(R,$):Li(R,$)}function Ul(R,$){if(R=="variable")return ne($),N(Li)}function Li(R,$){if($=="<")return N(ge(">"),kt(Do,">"),Le,Li);if($=="extends"||$=="implements"||c&&R==",")return $=="implements"&&(V.marked="keyword"),N(c?Ue:Ie,Li);if(R=="{")return N(ge("}"),Ei,Le)}function Ei(R,$){if(R=="async"||R=="variable"&&($=="static"||$=="get"||$=="set"||c&&me($))&&V.stream.match(/^\s+[\w$\xa1-\uffff]/,!1))return V.marked="keyword",N(Ei);if(R=="variable"||V.style=="keyword")return V.marked="property",N(zr,Ei);if(R=="number"||R=="string")return N(zr,Ei);if(R=="[")return N(Ie,Ha,We("]"),zr,Ei);if($=="*")return V.marked="keyword",N(Ei);if(c&&R=="(")return U(Wr,Ei);if(R==";"||R==",")return N(Ei);if(R=="}")return N();if($=="@")return N(Ie,Ei)}function zr(R,$){if($=="!"||$=="?")return N(zr);if(R==":")return N(Ue,oa);if($=="=")return N(lt);var te=V.state.lexical.prev,ue=te&&te.info=="interface";return U(ue?Wr:oi)}function Cu(R,$){return $=="*"?(V.marked="keyword",N(Dr,We(";"))):$=="default"?(V.marked="keyword",N(Ie,We(";"))):R=="{"?N(kt(wu,"}"),Dr,We(";")):U(je)}function wu(R,$){if($=="as")return V.marked="keyword",N(We("variable"));if(R=="variable")return U(lt,wu)}function Bt(R){return R=="string"?N():R=="("?U(Ie):R=="."?U(Er):U(ke,sa,Dr)}function ke(R,$){return R=="{"?Ls(ke,"}"):(R=="variable"&&ne($),$=="*"&&(V.marked="keyword"),N(Tu))}function sa(R){if(R==",")return N(ke,sa)}function Tu(R,$){if($=="as")return V.marked="keyword",N(ke)}function Dr(R,$){if($=="from")return V.marked="keyword",N(Ie)}function pt(R){return R=="]"?N():U(kt(lt,"]"))}function la(){return U(ge("form"),pr,We("{"),ge("}"),kt(Ps,"}"),Le,Le)}function Ps(){return U(pr,oa)}function ku(R,$){return R.lastType=="operator"||R.lastType==","||m.test($.charAt(0))||/[,.]/.test($.charAt(0))}function oe(R,$,te){return $.tokenize==k&&/^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test($.lastType)||$.lastType=="quasi"&&/\{\s*$/.test(R.string.slice(0,R.pos-(te||0)))}return{startState:function(R){var $={tokenize:k,lastType:"sof",cc:[],lexical:new O((R||0)-r,0,"block",!1),localVars:t.localVars,context:t.localVars&&new Pe(null,null,!1),indented:R||0};return t.globalVars&&typeof t.globalVars=="object"&&($.globalVars=t.globalVars),$},token:function(R,$){if(R.sol()&&($.lexical.hasOwnProperty("align")||($.lexical.align=!1),$.indented=R.indentation(),E(R,$)),$.tokenize!=P&&R.eatSpace())return null;var te=$.tokenize(R,$);return b=="comment"?te:($.lastType=b=="operator"&&(x=="++"||x=="--")?"incdec":b,W($,te,b,x,R))},indent:function(R,$){if(R.tokenize==P||R.tokenize==M)return n.Pass;if(R.tokenize!=k)return 0;var te=$&&$.charAt(0),ue=R.lexical,Fe;if(!/^\s*else\b/.test($))for(var it=R.cc.length-1;it>=0;--it){var ve=R.cc[it];if(ve==Le)ue=ue.prev;else if(ve!=af&&ve!=Ze)break}for(;(ue.type=="stat"||ue.type=="form")&&(te=="}"||(Fe=R.cc[R.cc.length-1])&&(Fe==Er||Fe==ta)&&!/^[,\.=+\-*:?[\(]/.test($));)ue=ue.prev;i&&ue.type==")"&&ue.prev.type=="stat"&&(ue=ue.prev);var Fn=ue.type,Hr=te==Fn;return Fn=="vardef"?ue.indented+(R.lastType=="operator"||R.lastType==","?ue.info.length+1:0):Fn=="form"&&te=="{"?ue.indented:Fn=="form"?ue.indented+r:Fn=="stat"?ue.indented+(ku(R,$)?i||r:0):ue.info=="switch"&&!Hr&&t.doubleIndentSwitch!=!1?ue.indented+(/^(?:case|default)\b/.test($)?r:2*r):ue.align?ue.column+(Hr?0:1):ue.indented+(Hr?0:r)},electricInput:/^\s*(?:case .*?:|default:|\{|\})$/,blockCommentStart:o?null:"/*",blockCommentEnd:o?null:"*/",blockCommentContinue:o?null:" * ",lineComment:o?null:"//",fold:"brace",closeBrackets:"()[]{}''\"\"``",helperType:o?"json":"javascript",jsonldMode:a,jsonMode:o,expressionAllowed:oe,skipExpression:function(R){W(R,"atom","atom","true",new n.StringStream("",2,null))}}}),n.registerHelper("wordChars","javascript",/[\w$]/),n.defineMIME("text/javascript","javascript"),n.defineMIME("text/ecmascript","javascript"),n.defineMIME("application/javascript","javascript"),n.defineMIME("application/x-javascript","javascript"),n.defineMIME("application/ecmascript","javascript"),n.defineMIME("application/json",{name:"javascript",json:!0}),n.defineMIME("application/x-json",{name:"javascript",json:!0}),n.defineMIME("application/manifest+json",{name:"javascript",json:!0}),n.defineMIME("application/ld+json",{name:"javascript",jsonld:!0}),n.defineMIME("text/typescript",{name:"javascript",typescript:!0}),n.defineMIME("application/typescript",{name:"javascript",typescript:!0})})});var QC=$t((B_,U_)=>{(function(n){typeof B_=="object"&&typeof U_=="object"?n(ms()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";function e(a,o,l,c){if(l&&l.call){var d=l;l=null}else var d=i(a,l,"rangeFinder");typeof o=="number"&&(o=n.Pos(o,0));var p=i(a,l,"minFoldSize");function m(x){var C=d(a,o);if(!C||C.to.line-C.from.line<p)return null;for(var k=a.findMarksAt(C.from),D=0;D<k.length;++D)if(k[D].__isFold&&c!=="fold"){if(!x)return null;C.cleared=!0,k[D].clear()}return C}var y=m(!0);if(i(a,l,"scanUp"))for(;!y&&o.line>a.firstLine();)o=n.Pos(o.line-1,0),y=m(!1);if(!(!y||y.cleared||c==="unfold")){var v=t(a,l,y);n.on(v,"mousedown",function(x){b.clear(),n.e_preventDefault(x)});var b=a.markText(y.from,y.to,{replacedWith:v,clearOnEnter:i(a,l,"clearOnEnter"),__isFold:!0});b.on("clear",function(x,C){n.signal(a,"unfold",a,x,C)}),n.signal(a,"fold",a,y.from,y.to)}}function t(a,o,l){var c=i(a,o,"widget");if(typeof c=="function"&&(c=c(l.from,l.to)),typeof c=="string"){var d=document.createTextNode(c);c=document.createElement("span"),c.appendChild(d),c.className="CodeMirror-foldmarker"}else c&&(c=c.cloneNode(!0));return c}n.newFoldFunction=function(a,o){return function(l,c){e(l,c,{rangeFinder:a,widget:o})}},n.defineExtension("foldCode",function(a,o,l){e(this,a,o,l)}),n.defineExtension("isFolded",function(a){for(var o=this.findMarksAt(a),l=0;l<o.length;++l)if(o[l].__isFold)return!0}),n.commands.toggleFold=function(a){a.foldCode(a.getCursor())},n.commands.fold=function(a){a.foldCode(a.getCursor(),null,"fold")},n.commands.unfold=function(a){a.foldCode(a.getCursor(),null,"unfold")},n.commands.foldAll=function(a){a.operation(function(){for(var o=a.firstLine(),l=a.lastLine();o<=l;o++)a.foldCode(n.Pos(o,0),null,"fold")})},n.commands.unfoldAll=function(a){a.operation(function(){for(var o=a.firstLine(),l=a.lastLine();o<=l;o++)a.foldCode(n.Pos(o,0),null,"unfold")})},n.registerHelper("fold","combine",function(){var a=Array.prototype.slice.call(arguments,0);return function(o,l){for(var c=0;c<a.length;++c){var d=a[c](o,l);if(d)return d}}}),n.registerHelper("fold","auto",function(a,o){for(var l=a.getHelpers(o,"fold"),c=0;c<l.length;c++){var d=l[c](a,o);if(d)return d}});var r={rangeFinder:n.fold.auto,widget:"\u2194",minFoldSize:0,scanUp:!1,clearOnEnter:!0};n.defineOption("foldOptions",null);function i(a,o,l){if(o&&o[l]!==void 0)return o[l];var c=a.options.foldOptions;return c&&c[l]!==void 0?c[l]:r[l]}n.defineExtension("foldOption",function(a,o){return i(this,a,o)})})});var W_=$t((F_,G_)=>{(function(n){typeof F_=="object"&&typeof G_=="object"?n(ms(),QC()):typeof define=="function"&&define.amd?define(["../../lib/codemirror","./foldcode"],n):n(CodeMirror)})(function(n){"use strict";n.defineOption("foldGutter",!1,function(v,b,x){x&&x!=n.Init&&(v.clearGutter(v.state.foldGutter.options.gutter),v.state.foldGutter=null,v.off("gutterClick",d),v.off("changes",p),v.off("viewportChange",m),v.off("fold",y),v.off("unfold",y),v.off("swapDoc",p)),b&&(v.state.foldGutter=new t(r(b)),c(v),v.on("gutterClick",d),v.on("changes",p),v.on("viewportChange",m),v.on("fold",y),v.on("unfold",y),v.on("swapDoc",p))});var e=n.Pos;function t(v){this.options=v,this.from=this.to=0}function r(v){return v===!0&&(v={}),v.gutter==null&&(v.gutter="CodeMirror-foldgutter"),v.indicatorOpen==null&&(v.indicatorOpen="CodeMirror-foldgutter-open"),v.indicatorFolded==null&&(v.indicatorFolded="CodeMirror-foldgutter-folded"),v}function i(v,b){for(var x=v.findMarks(e(b,0),e(b+1,0)),C=0;C<x.length;++C)if(x[C].__isFold){var k=x[C].find(-1);if(k&&k.line===b)return x[C]}}function a(v){if(typeof v=="string"){var b=document.createElement("div");return b.className=v+" CodeMirror-guttermarker-subtle",b}else return v.cloneNode(!0)}function o(v,b,x){var C=v.state.foldGutter.options,k=b-1,D=v.foldOption(C,"minFoldSize"),P=v.foldOption(C,"rangeFinder"),M=typeof C.indicatorFolded=="string"&&l(C.indicatorFolded),I=typeof C.indicatorOpen=="string"&&l(C.indicatorOpen);v.eachLine(b,x,function(E){++k;var _=null,O=E.gutterMarkers;if(O&&(O=O[C.gutter]),i(v,k)){if(M&&O&&M.test(O.className))return;_=a(C.indicatorFolded)}else{var B=e(k,0),W=P&&P(v,B);if(W&&W.to.line-W.from.line>=D){if(I&&O&&I.test(O.className))return;_=a(C.indicatorOpen)}}!_&&!O||v.setGutterMarker(E,C.gutter,_)})}function l(v){return new RegExp("(^|\\s)"+v+"(?:$|\\s)\\s*")}function c(v){var b=v.getViewport(),x=v.state.foldGutter;!x||(v.operation(function(){o(v,b.from,b.to)}),x.from=b.from,x.to=b.to)}function d(v,b,x){var C=v.state.foldGutter;if(!!C){var k=C.options;if(x==k.gutter){var D=i(v,b);D?D.clear():v.foldCode(e(b,0),k)}}}function p(v){var b=v.state.foldGutter;if(!!b){var x=b.options;b.from=b.to=0,clearTimeout(b.changeUpdate),b.changeUpdate=setTimeout(function(){c(v)},x.foldOnChangeTimeSpan||600)}}function m(v){var b=v.state.foldGutter;if(!!b){var x=b.options;clearTimeout(b.changeUpdate),b.changeUpdate=setTimeout(function(){var C=v.getViewport();b.from==b.to||C.from-b.to>20||b.from-C.to>20?c(v):v.operation(function(){C.from<b.from&&(o(v,C.from,b.from),b.from=C.from),C.to>b.to&&(o(v,b.to,C.to),b.to=C.to)})},x.updateViewportTimeSpan||400)}}function y(v,b){var x=v.state.foldGutter;if(!!x){var C=b.line;C>=x.from&&C<x.to&&o(v,C,C+1)}}})});var $_=$t((z_,H_)=>{(function(n){typeof z_=="object"&&typeof H_=="object"?n(ms()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";n.registerHelper("fold","brace",function(e,t){var r=t.line,i=e.getLine(r),a;function o(I){for(var E=t.ch,_=0;;){var O=E<=0?-1:i.lastIndexOf(I,E-1);if(O==-1){if(_==1)break;_=1,E=i.length;continue}if(_==1&&O<t.ch)break;if(a=e.getTokenTypeAt(n.Pos(r,O+1)),!/^(comment|string)/.test(a))return O+1;E=O-1}}var l=o("{"),c=o("["),d,p,m;if(l!=null&&(c==null||c>l))m=l,d="{",p="}";else if(c!=null)m=c,d="[",p="]";else return;var y=1,v=e.lastLine(),b,x;e:for(var C=r;C<=v;++C)for(var k=e.getLine(C),D=C==r?m:0;;){var P=k.indexOf(d,D),M=k.indexOf(p,D);if(P<0&&(P=k.length),M<0&&(M=k.length),D=Math.min(P,M),D==k.length)break;if(e.getTokenTypeAt(n.Pos(C,D+1))==a){if(D==P)++y;else if(!--y){b=C,x=D;break e}}++D}if(!(b==null||r==b))return{from:n.Pos(r,m),to:n.Pos(b,x)}}),n.registerHelper("fold","import",function(e,t){function r(d){if(d<e.firstLine()||d>e.lastLine())return null;var p=e.getTokenAt(n.Pos(d,1));if(/\S/.test(p.string)||(p=e.getTokenAt(n.Pos(d,p.end+1))),p.type!="keyword"||p.string!="import")return null;for(var m=d,y=Math.min(e.lastLine(),d+10);m<=y;++m){var v=e.getLine(m),b=v.indexOf(";");if(b!=-1)return{startCh:p.end,end:n.Pos(m,b)}}}var i=t.line,a=r(i),o;if(!a||r(i-1)||(o=r(i-2))&&o.end.line==i-1)return null;for(var l=a.end;;){var c=r(l.line+1);if(c==null)break;l=c.end}return{from:e.clipPos(n.Pos(i,a.startCh+1)),to:l}}),n.registerHelper("fold","include",function(e,t){function r(c){if(c<e.firstLine()||c>e.lastLine())return null;var d=e.getTokenAt(n.Pos(c,1));if(/\S/.test(d.string)||(d=e.getTokenAt(n.Pos(c,d.end+1))),d.type=="meta"&&d.string.slice(0,8)=="#include")return d.start+8}var i=t.line,a=r(i);if(a==null||r(i-1)!=null)return null;for(var o=i;;){var l=r(o+1);if(l==null)break;++o}return{from:n.Pos(i,a+1),to:e.clipPos(n.Pos(o))}})})});var A2=$t((P2,D2)=>{(function(n){typeof P2=="object"&&typeof D2=="object"?n(ms()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";var e="CodeMirror-lint-markers";function t(P,M,I){var E=document.createElement("div");E.className="CodeMirror-lint-tooltip cm-s-"+P.options.theme,E.appendChild(I.cloneNode(!0)),P.state.lint.options.selfContain?P.getWrapperElement().appendChild(E):document.body.appendChild(E);function _(O){if(!E.parentNode)return n.off(document,"mousemove",_);E.style.top=Math.max(0,O.clientY-E.offsetHeight-5)+"px",E.style.left=O.clientX+5+"px"}return n.on(document,"mousemove",_),_(M),E.style.opacity!=null&&(E.style.opacity=1),E}function r(P){P.parentNode&&P.parentNode.removeChild(P)}function i(P){!P.parentNode||(P.style.opacity==null&&r(P),P.style.opacity=0,setTimeout(function(){r(P)},600))}function a(P,M,I,E){var _=t(P,M,I);function O(){n.off(E,"mouseout",O),_&&(i(_),_=null)}var B=setInterval(function(){if(_)for(var W=E;;W=W.parentNode){if(W&&W.nodeType==11&&(W=W.host),W==document.body)return;if(!W){O();break}}if(!_)return clearInterval(B)},400);n.on(E,"mouseout",O)}function o(P,M,I){this.marked=[],this.options=M,this.timeout=null,this.hasGutter=I,this.onMouseOver=function(E){D(P,E)},this.waitingFor=0}function l(P,M){return M instanceof Function?{getAnnotations:M}:((!M||M===!0)&&(M={}),M)}function c(P){var M=P.state.lint;M.hasGutter&&P.clearGutter(e);for(var I=0;I<M.marked.length;++I)M.marked[I].clear();M.marked.length=0}function d(P,M,I,E,_){var O=document.createElement("div"),B=O;return O.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+I,E&&(B=O.appendChild(document.createElement("div")),B.className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),_!=!1&&n.on(B,"mouseover",function(W){a(P,W,M,B)}),O}function p(P,M){return P=="error"?P:M}function m(P){for(var M=[],I=0;I<P.length;++I){var E=P[I],_=E.from.line;(M[_]||(M[_]=[])).push(E)}return M}function y(P){var M=P.severity;M||(M="error");var I=document.createElement("div");return I.className="CodeMirror-lint-message CodeMirror-lint-message-"+M,typeof P.messageHTML!="undefined"?I.innerHTML=P.messageHTML:I.appendChild(document.createTextNode(P.message)),I}function v(P,M,I){var E=P.state.lint,_=++E.waitingFor;function O(){_=-1,P.off("change",O)}P.on("change",O),M(P.getValue(),function(B,W){P.off("change",O),E.waitingFor==_&&(W&&B instanceof n&&(B=W),P.operation(function(){x(P,B)}))},I,P)}function b(P){var M=P.state.lint,I=M.options,E=I.options||I,_=I.getAnnotations||P.getHelper(n.Pos(0,0),"lint");if(!!_)if(I.async||_.async)v(P,_,E);else{var O=_(P.getValue(),E,P);if(!O)return;O.then?O.then(function(B){P.operation(function(){x(P,B)})}):P.operation(function(){x(P,O)})}}function x(P,M){c(P);for(var I=P.state.lint,E=I.options,_=m(M),O=0;O<_.length;++O){var B=_[O];if(!!B){var W=[];B=B.filter(function(pe){return W.indexOf(pe.message)>-1?!1:W.push(pe.message)});for(var V=null,U=I.hasGutter&&document.createDocumentFragment(),N=0;N<B.length;++N){var q=B[N],ne=q.severity;ne||(ne="error"),V=p(V,ne),E.formatAnnotation&&(q=E.formatAnnotation(q)),I.hasGutter&&U.appendChild(y(q)),q.to&&I.marked.push(P.markText(q.from,q.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+ne,__annotation:q}))}I.hasGutter&&P.setGutterMarker(O,e,d(P,U,V,_[O].length>1,I.options.tooltips))}}E.onUpdateLinting&&E.onUpdateLinting(M,_,P)}function C(P){var M=P.state.lint;!M||(clearTimeout(M.timeout),M.timeout=setTimeout(function(){b(P)},M.options.delay||500))}function k(P,M,I){for(var E=I.target||I.srcElement,_=document.createDocumentFragment(),O=0;O<M.length;O++){var B=M[O];_.appendChild(y(B))}a(P,I,_,E)}function D(P,M){var I=M.target||M.srcElement;if(!!/\bCodeMirror-lint-mark-/.test(I.className)){for(var E=I.getBoundingClientRect(),_=(E.left+E.right)/2,O=(E.top+E.bottom)/2,B=P.findMarksAt(P.coordsChar({left:_,top:O},"client")),W=[],V=0;V<B.length;++V){var U=B[V].__annotation;U&&W.push(U)}W.length&&k(P,W,M)}}n.defineOption("lint",!1,function(P,M,I){if(I&&I!=n.Init&&(c(P),P.state.lint.options.lintOnChange!==!1&&P.off("change",C),n.off(P.getWrapperElement(),"mouseover",P.state.lint.onMouseOver),clearTimeout(P.state.lint.timeout),delete P.state.lint),M){for(var E=P.getOption("gutters"),_=!1,O=0;O<E.length;++O)E[O]==e&&(_=!0);var B=P.state.lint=new o(P,l(P,M),_);B.options.lintOnChange!==!1&&P.on("change",C),B.options.tooltips!=!1&&B.options.tooltips!="gutter"&&n.on(P.getWrapperElement(),"mouseover",B.onMouseOver),b(P)}}),n.defineExtension("performLint",function(){this.state.lint&&b(this)})})});var M2=$t((UMe,I2)=>{I2.exports=function(n){n.defineMode("glsl",function(a,o){var l=a.indentUnit,c=o.keywords||e(t),d=o.builtins||e(r),p=o.blockKeywords||e("case do else for if switch while struct"),m=o.atoms||e("null"),y=o.hooks||{},v=o.multiLineStrings,b=/[+\-*&%=<>!?|\/]/,x;function C(E,_){var O=E.next();if(y[O]){var B=y[O](E,_);if(B!==!1)return B}if(O=='"'||O=="'")return _.tokenize=k(O),_.tokenize(E,_);if(/[\[\]{}\(\),;\:\.]/.test(O))return x=O,"bracket";if(/\d/.test(O))return E.eatWhile(/[\w\.]/),"number";if(O=="/"){if(E.eat("*"))return _.tokenize=D,D(E,_);if(E.eat("/"))return E.skipToEnd(),"comment"}if(O=="#")return E.eatWhile(/[\S]+/),E.eatWhile(/[\s]+/),E.eatWhile(/[\S]+/),E.eatWhile(/[\s]+/),"comment";if(b.test(O))return E.eatWhile(b),"operator";E.eatWhile(/[\w\$_]/);var W=E.current();return c.propertyIsEnumerable(W)?(p.propertyIsEnumerable(W)&&(x="newstatement"),"keyword"):d.propertyIsEnumerable(W)?"builtin":m.propertyIsEnumerable(W)?"atom":"word"}function k(E){return function(_,O){for(var B=!1,W,V=!1;(W=_.next())!=null;){if(W==E&&!B){V=!0;break}B=!B&&W=="\\"}return(V||!(B||v))&&(O.tokenize=C),"string"}}function D(E,_){for(var O=!1,B;B=E.next();){if(B=="/"&&O){_.tokenize=C;break}O=B=="*"}return"comment"}function P(E,_,O,B,W){this.indented=E,this.column=_,this.type=O,this.align=B,this.prev=W}function M(E,_,O){return E.context=new P(E.indented,_,O,null,E.context)}function I(E){var _=E.context.type;return(_==")"||_=="]"||_=="}")&&(E.indented=E.context.indented),E.context=E.context.prev}return{startState:function(E){return{tokenize:null,context:new P((E||0)-l,0,"top",!1),indented:0,startOfLine:!0}},token:function(E,_){var O=_.context;if(E.sol()&&(O.align==null&&(O.align=!1),_.indented=E.indentation(),_.startOfLine=!0),E.eatSpace())return null;x=null;var B=(_.tokenize||C)(E,_);if(B=="comment"||B=="meta")return B;if(O.align==null&&(O.align=!0),(x==";"||x==":")&&O.type=="statement")I(_);else if(x=="{")M(_,E.column(),"}");else if(x=="[")M(_,E.column(),"]");else if(x=="(")M(_,E.column(),")");else if(x=="}"){for(;O.type=="statement";)O=I(_);for(O.type=="}"&&(O=I(_));O.type=="statement";)O=I(_)}else x==O.type?I(_):(O.type=="}"||O.type=="top"||O.type=="statement"&&x=="newstatement")&&M(_,E.column(),"statement");return _.startOfLine=!1,B},indent:function(E,_){if(E.tokenize!=C&&E.tokenize!=null)return 0;var O=_&&_.charAt(0),B=E.context,W=O==B.type;return B.type=="statement"?B.indented+(O=="{"?0:l):B.align?B.column+(W?0:1):B.indented+(W?0:l)},electricChars:"{}"}});function e(a){for(var o={},l=a.split(" "),c=0;c<l.length;++c)o[l[c]]=!0;return o}var t="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",r="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function i(a,o){return o.startOfLine?(a.skipToEnd(),"meta"):!1}(function(){function a(o,l){for(var c;(c=o.next())!=null;)if(c=='"'&&!o.eat('"')){l.tokenize=null;break}return"string"}n.defineMIME("text/x-glsl",{name:"glsl",keywords:e(t),builtins:e(r),blockKeywords:e("case do else for if switch while struct"),atoms:e("null"),hooks:{"#":i}})})()}});function Of(n,e){let t=n.length,r=0;for(let i=0;i<t;++i)e(n[i],i,n)&&(n[r]=n[i],++r);n.length=r}function Mk(n,e){if(n.length===e)return n;let t=new n.constructor(e);return t.set(n),t}function ed(n,e,t,r){let i=n.length/e,a=n.length*t*r,o=new n.constructor(a),l=n.length*r,c=e,d=e*r;for(let p=0;p<i;++p)for(let m=0;m<e;++m){let y=n[p*e+m],v=p*d+m;for(let b=0;b<t;++b)for(let x=0;x<r;++x)o[b*l+x*c+v]=y}return o}function Rk(n,e,t,r=0,i=n.length){for(;r<i;){let a=r+i-1>>1,o=t(e,n[a]);if(o>0)r=a+1;else if(o<0)i=a;else return a}return~r}function _k(n,e,t){let r=e-n;for(;r>0;){let i=Math.floor(r/2),a=n+i;t(a)?r=i:(n=a+1,r-=i+1)}return n}function Vk(n,e){let t=[];for(let r=0,i=n.length;r<i;++r)n[r]===e&&t.push(r);return t}function we(n,e){let t=n.length;if(e.length!==t)return!1;for(let r=0;r<t;++r)if(n[r]!==e[r])return!1;return!0}function td(n,e,t=(r,i)=>r===i){let r=n.length;if(e.length!==r)return!1;for(let i=0;i<r;++i)if(!t(n[i],e[i]))return!1;return!0}function Ok(n,e,t){let r=[];if(t===e){for(let i=0;i<n;++i)r[i]=i;return r}r[t]=e;for(let i=0,a=0;i<n;){if(i===e){++i;continue}a===t&&++a,r[a++]=i++}return r}function dv(n,e,t){for(let r=0,i=t.length;r<i;++r){let a=t[r];a!==-1&&(n[r]=e[a])}return n}function Mr(n){let e=[];for(let t=0,r=n.length;t<r;++t){let i=n[t];for(let a=0,o=i.length;a<o;++a){let l=e[a];l===void 0&&(l=e[a]=[]),l.push(i[a])}}return e}function Nk(n,e){let t=[],r=0;for(let a=0,o=e.length;a<o;++a){let{retainCount:l,deleteCount:c,insertCount:d}=e[a];l!==0&&(t.push(n.slice(r,r+l)),r+=l),r+=c,d!==0&&t.push(new Array(d))}let i=n.length;return r!==i&&t.push(n.slice(r)),new Array(0).concat(...t)}function Bk(n,e,t){let r=[],i=0,a=0,o=n.length,l=e.length;for(;i<o&&a<l;){let c,d=n[i],p=e[a];if(c=t(d,p),c===0){let m=1;for(++i,++a;i<o&&a<l&&(c=t(n[i],e[a]))===0;)++m,++i,++a;r.push({retainCount:m,deleteCount:0,insertCount:0});continue}if(c<0){let m=1;for(;++i<o&&(c=t(n[i],p))<0;)++m;r.push({retainCount:0,deleteCount:m,insertCount:0});continue}if(c>0){let m=1;for(;++a<l&&(c=t(d,e[a]))>0;)++m;r.push({retainCount:0,deleteCount:0,insertCount:m});continue}}return(i<o||a<l)&&r.push({retainCount:0,deleteCount:o-i,insertCount:l-a}),r}function Uk(n,e,t,r,i,a){let o=0,l=0;if(n!==0&&e!==0)for(;;){let c=t(o,l);if(c<0){if(r(o),++o===n)break}else if(c>0){if(i(l),++l===e)break}else if(a(o,l),++o,++l,o===n||l===e)break}for(;o<n;)r(o),++o;for(;l<e;)i(l),++l}var vL=at(It());var fF=!1;function yL(n){typeof n=="object"?n.dispose():n()}function Xa(n){for(let e=n.length;e>0;--e)yL(n[e-1])}function En(n,e,t,r){return n.addEventListener(e,t,r),()=>n.removeEventListener(e,t,r)}var j=class{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){if(fF){if(this.refCount===0)debugger;(this.disposedStacks=this.disposedStacks||[]).push(new Error().stack)}--this.refCount==0&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();let{disposers:e}=this;e!==void 0&&(Xa(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let{disposers:t}=this;return t==null?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let{disposers:t}=this;if(t!=null){let r=t.indexOf(e);r!==-1&&t.splice(r,1)}return e}registerEventListener(e,t,r,i){this.registerDisposer(En(e,t,r,i))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}},rd=class extends j{constructor(e){super();this.value=e}};function Bf(n){return()=>{if(n!==void 0){let e=n;n=void 0,yL(e)}}}var Me=class{constructor(){this.handlers=new Set;this.count=0;let e=this;this.dispatch=function(){++e.count,e.handlers.forEach(t=>{t.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}remove(e){return this.handlers.delete(e)}dispose(){this.handlers=void 0}};var ae=class extends Me{},Uf={count:0,add(n){return()=>{}},remove(n){return!1}};var Re=class{constructor(e){this.value_=e;this.changed=new ae}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}},ht=class extends Re{constructor(e,t,r=e){super(e);this.validator=t;this.defaultValue=r}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(e!==void 0){let{validator:t}=this;try{this.value=t(e);return}catch(r){}}this.value=this.defaultValue}},mv=class extends j{constructor(e,t){super();this.changed=new ae;this.f=e,this.ws=t;for(let r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map(e=>e.value))}};function gv(n,...e){return new mv(n,e)}var SL=class extends j{constructor(e,t){super();this.changed=new ae;this.valueGeneration=-1;this.f=e,this.ws=t;for(let r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){let e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(t=>t.value)),this.valueGeneration=e),this.value_}};function Pn(n,...e){return new SL(n,e)}var Ff=class extends j{constructor(e,t=(r,i)=>r===i){super();this.changed=new Me;this.value=e.value,this.registerDisposer(e.changed.add(()=>{let r=e.value;t(this.value,r)||(this.value=r,this.changed.dispatch())}))}};function Qt(n,e,t){let r=new mv(n,e),i=new Ff(r,t);return i.registerDisposer(r),i}var id=class extends j{constructor(e){super();this.changed=new ae;let t=e(this),r=Object.keys(t),i=()=>{let a=Array.isArray(t)?[]:{};for(let o of r)a[o]=t[o].value;this.value=a,this.changed.dispatch()};i();for(let a of r){let o=t[a];this.registerDisposer(o.changed.add(()=>i()))}}};var yv=class{constructor(e){this.changed=new ae;e===void 0?this.values=new Set:this.values=new Set(e)}add(e){let{values:t}=this;return t.has(e)||(t.add(e),this.changed.dispatch()),this}delete(e){let{values:t}=this;return t.delete(e)?(this.changed.dispatch(),!0):!1}has(e){return this.values.has(e)}get size(){return this.values.size}[Symbol.iterator](){return this.values[Symbol.iterator]()}clear(){let{values:e}=this;e.size>0&&(e.clear(),this.changed.dispatch())}};function Dn(n,...e){let t=e.map(c=>c.value),r=e.length,i=new j,a=n(i,...t),o=(0,vL.default)(()=>{let c=!1;for(let d=0;d<r;++d){let m=e[d].value;t[d]!==m&&(t[d]=m,c=!0)}!c||(i.dispose(),i=new j,a=n(i,...t))},0),l=e.map(c=>c.changed.add(o));return{flush(){o.flush()},dispose(){o.cancel(),Xa(l),i.dispose()},get value(){return o.flush(),a}}}function Qa(n,...e){let t=e.map(c=>c.value),r=e.length,i=new j,a=n(i,...t),o=()=>{let c=!1;for(let d=0;d<r;++d){let m=e[d].value;t[d]!==m&&(t[d]=m,c=!0)}!c||(i.dispose(),i=new j,a=n(i,...t))},l=e.map(c=>c.changed.add(o));return{dispose(){Xa(l),i.dispose()},get value(){return a}}}function qr(n){return{changed:Uf,value:n}}function Rr(n,e){return n(e.value),e.changed.add(()=>n(e.value))}var sc=class{constructor(e,t){this.outer=e;this.getInner=t;this.changed=new ae;this.update=()=>{let{disposer:e,outer:t}=this;e!==void 0&&e();let r=this.inner=this.getInner(t.value);this.disposer=r.changed.add(this.changed.dispatch),this.changed.dispatch()};e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}},ad=class extends sc{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}};var Gf=new Float32Array(1);function bL(n){Gf[0]=n,n=Gf[0];for(let e=1;e<21;++e){let t=n.toPrecision(e);if(Gf[0]=parseFloat(t),Gf[0]===n)return t}return n.toString()}var ze=1e-6,vt=typeof Float32Array!="undefined"?Float32Array:Array,_r=Math.random;var t8=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var n=0,e=arguments.length;e--;)n+=arguments[e]*arguments[e];return Math.sqrt(n)});var Et={};oc(Et,{add:()=>OF,adjoint:()=>CF,clone:()=>mF,copy:()=>gF,create:()=>vv,determinant:()=>wF,equals:()=>FF,exactEquals:()=>UF,frob:()=>VF,fromMat2d:()=>AF,fromMat4:()=>hF,fromQuat:()=>IF,fromRotation:()=>PF,fromScaling:()=>DF,fromTranslation:()=>EF,fromValues:()=>yF,identity:()=>SF,invert:()=>xF,mul:()=>GF,multiply:()=>xL,multiplyScalar:()=>NF,multiplyScalarAndAdd:()=>BF,normalFromMat4:()=>MF,projection:()=>RF,rotate:()=>kF,scale:()=>LF,set:()=>vF,str:()=>_F,sub:()=>WF,subtract:()=>CL,translate:()=>TF,transpose:()=>bF});function vv(){var n=new vt(9);return vt!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function hF(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[4],n[4]=e[5],n[5]=e[6],n[6]=e[8],n[7]=e[9],n[8]=e[10],n}function mF(n){var e=new vt(9);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e}function gF(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n}function yF(n,e,t,r,i,a,o,l,c){var d=new vt(9);return d[0]=n,d[1]=e,d[2]=t,d[3]=r,d[4]=i,d[5]=a,d[6]=o,d[7]=l,d[8]=c,d}function vF(n,e,t,r,i,a,o,l,c,d){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n[4]=a,n[5]=o,n[6]=l,n[7]=c,n[8]=d,n}function SF(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function bF(n,e){if(n===e){var t=e[1],r=e[2],i=e[5];n[1]=e[3],n[2]=e[6],n[3]=t,n[5]=e[7],n[6]=r,n[7]=i}else n[0]=e[0],n[1]=e[3],n[2]=e[6],n[3]=e[1],n[4]=e[4],n[5]=e[7],n[6]=e[2],n[7]=e[5],n[8]=e[8];return n}function xF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=p*o-l*d,y=-p*a+l*c,v=d*a-o*c,b=t*m+r*y+i*v;return b?(b=1/b,n[0]=m*b,n[1]=(-p*r+i*d)*b,n[2]=(l*r-i*o)*b,n[3]=y*b,n[4]=(p*t-i*c)*b,n[5]=(-l*t+i*a)*b,n[6]=v*b,n[7]=(-d*t+r*c)*b,n[8]=(o*t-r*a)*b,n):null}function CF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8];return n[0]=o*p-l*d,n[1]=i*d-r*p,n[2]=r*l-i*o,n[3]=l*c-a*p,n[4]=t*p-i*c,n[5]=i*a-t*l,n[6]=a*d-o*c,n[7]=r*c-t*d,n[8]=t*o-r*a,n}function wF(n){var e=n[0],t=n[1],r=n[2],i=n[3],a=n[4],o=n[5],l=n[6],c=n[7],d=n[8];return e*(d*a-o*c)+t*(-d*i+o*l)+r*(c*i-a*l)}function xL(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=t[0],v=t[1],b=t[2],x=t[3],C=t[4],k=t[5],D=t[6],P=t[7],M=t[8];return n[0]=y*r+v*o+b*d,n[1]=y*i+v*l+b*p,n[2]=y*a+v*c+b*m,n[3]=x*r+C*o+k*d,n[4]=x*i+C*l+k*p,n[5]=x*a+C*c+k*m,n[6]=D*r+P*o+M*d,n[7]=D*i+P*l+M*p,n[8]=D*a+P*c+M*m,n}function TF(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=t[0],v=t[1];return n[0]=r,n[1]=i,n[2]=a,n[3]=o,n[4]=l,n[5]=c,n[6]=y*r+v*o+d,n[7]=y*i+v*l+p,n[8]=y*a+v*c+m,n}function kF(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=Math.sin(t),v=Math.cos(t);return n[0]=v*r+y*o,n[1]=v*i+y*l,n[2]=v*a+y*c,n[3]=v*o-y*r,n[4]=v*l-y*i,n[5]=v*c-y*a,n[6]=d,n[7]=p,n[8]=m,n}function LF(n,e,t){var r=t[0],i=t[1];return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=i*e[3],n[4]=i*e[4],n[5]=i*e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n}function EF(n,e){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e[0],n[7]=e[1],n[8]=1,n}function PF(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=t,n[2]=0,n[3]=-t,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function DF(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=e[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function AF(n,e){return n[0]=e[0],n[1]=e[1],n[2]=0,n[3]=e[2],n[4]=e[3],n[5]=0,n[6]=e[4],n[7]=e[5],n[8]=1,n}function IF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t+t,l=r+r,c=i+i,d=t*o,p=r*o,m=r*l,y=i*o,v=i*l,b=i*c,x=a*o,C=a*l,k=a*c;return n[0]=1-m-b,n[3]=p-k,n[6]=y+C,n[1]=p+k,n[4]=1-d-b,n[7]=v-x,n[2]=y-C,n[5]=v+x,n[8]=1-d-m,n}function MF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],k=e[15],D=t*l-r*o,P=t*c-i*o,M=t*d-a*o,I=r*c-i*l,E=r*d-a*l,_=i*d-a*c,O=p*x-m*b,B=p*C-y*b,W=p*k-v*b,V=m*C-y*x,U=m*k-v*x,N=y*k-v*C,q=D*N-P*U+M*V+I*W-E*B+_*O;return q?(q=1/q,n[0]=(l*N-c*U+d*V)*q,n[1]=(c*W-o*N-d*B)*q,n[2]=(o*U-l*W+d*O)*q,n[3]=(i*U-r*N-a*V)*q,n[4]=(t*N-i*W+a*B)*q,n[5]=(r*W-t*U-a*O)*q,n[6]=(x*_-C*E+k*I)*q,n[7]=(C*M-b*_-k*P)*q,n[8]=(b*E-x*M+k*D)*q,n):null}function RF(n,e,t){return n[0]=2/e,n[1]=0,n[2]=0,n[3]=0,n[4]=-2/t,n[5]=0,n[6]=-1,n[7]=1,n[8]=1,n}function _F(n){return"mat3("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+")"}function VF(n){return Math.hypot(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])}function OF(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n[4]=e[4]+t[4],n[5]=e[5]+t[5],n[6]=e[6]+t[6],n[7]=e[7]+t[7],n[8]=e[8]+t[8],n}function CL(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n[4]=e[4]-t[4],n[5]=e[5]-t[5],n[6]=e[6]-t[6],n[7]=e[7]-t[7],n[8]=e[8]-t[8],n}function NF(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n[4]=e[4]*t,n[5]=e[5]*t,n[6]=e[6]*t,n[7]=e[7]*t,n[8]=e[8]*t,n}function BF(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n[4]=e[4]+t[4]*r,n[5]=e[5]+t[5]*r,n[6]=e[6]+t[6]*r,n[7]=e[7]+t[7]*r,n[8]=e[8]+t[8]*r,n}function UF(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]}function FF(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=n[4],l=n[5],c=n[6],d=n[7],p=n[8],m=e[0],y=e[1],v=e[2],b=e[3],x=e[4],C=e[5],k=e[6],D=e[7],P=e[8];return Math.abs(t-m)<=ze*Math.max(1,Math.abs(t),Math.abs(m))&&Math.abs(r-y)<=ze*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(i-v)<=ze*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(a-b)<=ze*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(o-x)<=ze*Math.max(1,Math.abs(o),Math.abs(x))&&Math.abs(l-C)<=ze*Math.max(1,Math.abs(l),Math.abs(C))&&Math.abs(c-k)<=ze*Math.max(1,Math.abs(c),Math.abs(k))&&Math.abs(d-D)<=ze*Math.max(1,Math.abs(d),Math.abs(D))&&Math.abs(p-P)<=ze*Math.max(1,Math.abs(p),Math.abs(P))}var GF=xL,WF=CL;var re={};oc(re,{add:()=>T3,adjoint:()=>YF,clone:()=>HF,copy:()=>$F,create:()=>zF,determinant:()=>XF,equals:()=>P3,exactEquals:()=>E3,frob:()=>w3,fromQuat:()=>m3,fromQuat2:()=>u3,fromRotation:()=>o3,fromRotationTranslation:()=>kL,fromRotationTranslationScale:()=>f3,fromRotationTranslationScaleOrigin:()=>h3,fromScaling:()=>a3,fromTranslation:()=>i3,fromValues:()=>jF,fromXRotation:()=>s3,fromYRotation:()=>l3,fromZRotation:()=>c3,frustum:()=>g3,getRotation:()=>p3,getScaling:()=>LL,getTranslation:()=>d3,identity:()=>wL,invert:()=>KF,lookAt:()=>b3,mul:()=>D3,multiply:()=>TL,multiplyScalar:()=>k3,multiplyScalarAndAdd:()=>L3,ortho:()=>S3,perspective:()=>y3,perspectiveFromFieldOfView:()=>v3,rotate:()=>e3,rotateX:()=>t3,rotateY:()=>n3,rotateZ:()=>r3,scale:()=>ZF,set:()=>qF,str:()=>C3,sub:()=>A3,subtract:()=>EL,targetTo:()=>x3,translate:()=>QF,transpose:()=>JF});function zF(){var n=new vt(16);return vt!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function HF(n){var e=new vt(16);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],e}function $F(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function jF(n,e,t,r,i,a,o,l,c,d,p,m,y,v,b,x){var C=new vt(16);return C[0]=n,C[1]=e,C[2]=t,C[3]=r,C[4]=i,C[5]=a,C[6]=o,C[7]=l,C[8]=c,C[9]=d,C[10]=p,C[11]=m,C[12]=y,C[13]=v,C[14]=b,C[15]=x,C}function qF(n,e,t,r,i,a,o,l,c,d,p,m,y,v,b,x,C){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n[4]=a,n[5]=o,n[6]=l,n[7]=c,n[8]=d,n[9]=p,n[10]=m,n[11]=y,n[12]=v,n[13]=b,n[14]=x,n[15]=C,n}function wL(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function JF(n,e){if(n===e){var t=e[1],r=e[2],i=e[3],a=e[6],o=e[7],l=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=t,n[6]=e[9],n[7]=e[13],n[8]=r,n[9]=a,n[11]=e[14],n[12]=i,n[13]=o,n[14]=l}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n}function KF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],k=e[15],D=t*l-r*o,P=t*c-i*o,M=t*d-a*o,I=r*c-i*l,E=r*d-a*l,_=i*d-a*c,O=p*x-m*b,B=p*C-y*b,W=p*k-v*b,V=m*C-y*x,U=m*k-v*x,N=y*k-v*C,q=D*N-P*U+M*V+I*W-E*B+_*O;return q?(q=1/q,n[0]=(l*N-c*U+d*V)*q,n[1]=(i*U-r*N-a*V)*q,n[2]=(x*_-C*E+k*I)*q,n[3]=(y*E-m*_-v*I)*q,n[4]=(c*W-o*N-d*B)*q,n[5]=(t*N-i*W+a*B)*q,n[6]=(C*M-b*_-k*P)*q,n[7]=(p*_-y*M+v*P)*q,n[8]=(o*U-l*W+d*O)*q,n[9]=(r*W-t*U-a*O)*q,n[10]=(b*E-x*M+k*D)*q,n[11]=(m*M-p*E-v*D)*q,n[12]=(l*B-o*V-c*O)*q,n[13]=(t*V-r*B+i*O)*q,n[14]=(x*P-b*I-C*D)*q,n[15]=(p*I-m*P+y*D)*q,n):null}function YF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],k=e[15];return n[0]=l*(y*k-v*C)-m*(c*k-d*C)+x*(c*v-d*y),n[1]=-(r*(y*k-v*C)-m*(i*k-a*C)+x*(i*v-a*y)),n[2]=r*(c*k-d*C)-l*(i*k-a*C)+x*(i*d-a*c),n[3]=-(r*(c*v-d*y)-l*(i*v-a*y)+m*(i*d-a*c)),n[4]=-(o*(y*k-v*C)-p*(c*k-d*C)+b*(c*v-d*y)),n[5]=t*(y*k-v*C)-p*(i*k-a*C)+b*(i*v-a*y),n[6]=-(t*(c*k-d*C)-o*(i*k-a*C)+b*(i*d-a*c)),n[7]=t*(c*v-d*y)-o*(i*v-a*y)+p*(i*d-a*c),n[8]=o*(m*k-v*x)-p*(l*k-d*x)+b*(l*v-d*m),n[9]=-(t*(m*k-v*x)-p*(r*k-a*x)+b*(r*v-a*m)),n[10]=t*(l*k-d*x)-o*(r*k-a*x)+b*(r*d-a*l),n[11]=-(t*(l*v-d*m)-o*(r*v-a*m)+p*(r*d-a*l)),n[12]=-(o*(m*C-y*x)-p*(l*C-c*x)+b*(l*y-c*m)),n[13]=t*(m*C-y*x)-p*(r*C-i*x)+b*(r*y-i*m),n[14]=-(t*(l*C-c*x)-o*(r*C-i*x)+b*(r*c-i*l)),n[15]=t*(l*y-c*m)-o*(r*y-i*m)+p*(r*c-i*l),n}function XF(n){var e=n[0],t=n[1],r=n[2],i=n[3],a=n[4],o=n[5],l=n[6],c=n[7],d=n[8],p=n[9],m=n[10],y=n[11],v=n[12],b=n[13],x=n[14],C=n[15],k=e*o-t*a,D=e*l-r*a,P=e*c-i*a,M=t*l-r*o,I=t*c-i*o,E=r*c-i*l,_=d*b-p*v,O=d*x-m*v,B=d*C-y*v,W=p*x-m*b,V=p*C-y*b,U=m*C-y*x;return k*U-D*V+P*W+M*B-I*O+E*_}function TL(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=e[9],v=e[10],b=e[11],x=e[12],C=e[13],k=e[14],D=e[15],P=t[0],M=t[1],I=t[2],E=t[3];return n[0]=P*r+M*l+I*m+E*x,n[1]=P*i+M*c+I*y+E*C,n[2]=P*a+M*d+I*v+E*k,n[3]=P*o+M*p+I*b+E*D,P=t[4],M=t[5],I=t[6],E=t[7],n[4]=P*r+M*l+I*m+E*x,n[5]=P*i+M*c+I*y+E*C,n[6]=P*a+M*d+I*v+E*k,n[7]=P*o+M*p+I*b+E*D,P=t[8],M=t[9],I=t[10],E=t[11],n[8]=P*r+M*l+I*m+E*x,n[9]=P*i+M*c+I*y+E*C,n[10]=P*a+M*d+I*v+E*k,n[11]=P*o+M*p+I*b+E*D,P=t[12],M=t[13],I=t[14],E=t[15],n[12]=P*r+M*l+I*m+E*x,n[13]=P*i+M*c+I*y+E*C,n[14]=P*a+M*d+I*v+E*k,n[15]=P*o+M*p+I*b+E*D,n}function QF(n,e,t){var r=t[0],i=t[1],a=t[2],o,l,c,d,p,m,y,v,b,x,C,k;return e===n?(n[12]=e[0]*r+e[4]*i+e[8]*a+e[12],n[13]=e[1]*r+e[5]*i+e[9]*a+e[13],n[14]=e[2]*r+e[6]*i+e[10]*a+e[14],n[15]=e[3]*r+e[7]*i+e[11]*a+e[15]):(o=e[0],l=e[1],c=e[2],d=e[3],p=e[4],m=e[5],y=e[6],v=e[7],b=e[8],x=e[9],C=e[10],k=e[11],n[0]=o,n[1]=l,n[2]=c,n[3]=d,n[4]=p,n[5]=m,n[6]=y,n[7]=v,n[8]=b,n[9]=x,n[10]=C,n[11]=k,n[12]=o*r+p*i+b*a+e[12],n[13]=l*r+m*i+x*a+e[13],n[14]=c*r+y*i+C*a+e[14],n[15]=d*r+v*i+k*a+e[15]),n}function ZF(n,e,t){var r=t[0],i=t[1],a=t[2];return n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*i,n[5]=e[5]*i,n[6]=e[6]*i,n[7]=e[7]*i,n[8]=e[8]*a,n[9]=e[9]*a,n[10]=e[10]*a,n[11]=e[11]*a,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function e3(n,e,t,r){var i=r[0],a=r[1],o=r[2],l=Math.hypot(i,a,o),c,d,p,m,y,v,b,x,C,k,D,P,M,I,E,_,O,B,W,V,U,N,q,ne;return l<ze?null:(l=1/l,i*=l,a*=l,o*=l,c=Math.sin(t),d=Math.cos(t),p=1-d,m=e[0],y=e[1],v=e[2],b=e[3],x=e[4],C=e[5],k=e[6],D=e[7],P=e[8],M=e[9],I=e[10],E=e[11],_=i*i*p+d,O=a*i*p+o*c,B=o*i*p-a*c,W=i*a*p-o*c,V=a*a*p+d,U=o*a*p+i*c,N=i*o*p+a*c,q=a*o*p-i*c,ne=o*o*p+d,n[0]=m*_+x*O+P*B,n[1]=y*_+C*O+M*B,n[2]=v*_+k*O+I*B,n[3]=b*_+D*O+E*B,n[4]=m*W+x*V+P*U,n[5]=y*W+C*V+M*U,n[6]=v*W+k*V+I*U,n[7]=b*W+D*V+E*U,n[8]=m*N+x*q+P*ne,n[9]=y*N+C*q+M*ne,n[10]=v*N+k*q+I*ne,n[11]=b*N+D*q+E*ne,e!==n&&(n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n)}function t3(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[4],o=e[5],l=e[6],c=e[7],d=e[8],p=e[9],m=e[10],y=e[11];return e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[4]=a*i+d*r,n[5]=o*i+p*r,n[6]=l*i+m*r,n[7]=c*i+y*r,n[8]=d*i-a*r,n[9]=p*i-o*r,n[10]=m*i-l*r,n[11]=y*i-c*r,n}function n3(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[0],o=e[1],l=e[2],c=e[3],d=e[8],p=e[9],m=e[10],y=e[11];return e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=a*i-d*r,n[1]=o*i-p*r,n[2]=l*i-m*r,n[3]=c*i-y*r,n[8]=a*r+d*i,n[9]=o*r+p*i,n[10]=l*r+m*i,n[11]=c*r+y*i,n}function r3(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[0],o=e[1],l=e[2],c=e[3],d=e[4],p=e[5],m=e[6],y=e[7];return e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=a*i+d*r,n[1]=o*i+p*r,n[2]=l*i+m*r,n[3]=c*i+y*r,n[4]=d*i-a*r,n[5]=p*i-o*r,n[6]=m*i-l*r,n[7]=y*i-c*r,n}function i3(n,e){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}function a3(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function o3(n,e,t){var r=t[0],i=t[1],a=t[2],o=Math.hypot(r,i,a),l,c,d;return o<ze?null:(o=1/o,r*=o,i*=o,a*=o,l=Math.sin(e),c=Math.cos(e),d=1-c,n[0]=r*r*d+c,n[1]=i*r*d+a*l,n[2]=a*r*d-i*l,n[3]=0,n[4]=r*i*d-a*l,n[5]=i*i*d+c,n[6]=a*i*d+r*l,n[7]=0,n[8]=r*a*d+i*l,n[9]=i*a*d-r*l,n[10]=a*a*d+c,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)}function s3(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=r,n[6]=t,n[7]=0,n[8]=0,n[9]=-t,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function l3(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=0,n[2]=-t,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=t,n[9]=0,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function c3(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=t,n[2]=0,n[3]=0,n[4]=-t,n[5]=r,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function kL(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=r+r,c=i+i,d=a+a,p=r*l,m=r*c,y=r*d,v=i*c,b=i*d,x=a*d,C=o*l,k=o*c,D=o*d;return n[0]=1-(v+x),n[1]=m+D,n[2]=y-k,n[3]=0,n[4]=m-D,n[5]=1-(p+x),n[6]=b+C,n[7]=0,n[8]=y+k,n[9]=b-C,n[10]=1-(p+v),n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function u3(n,e){var t=new vt(3),r=-e[0],i=-e[1],a=-e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=r*r+i*i+a*a+o*o;return m>0?(t[0]=(l*o+p*r+c*a-d*i)*2/m,t[1]=(c*o+p*i+d*r-l*a)*2/m,t[2]=(d*o+p*a+l*i-c*r)*2/m):(t[0]=(l*o+p*r+c*a-d*i)*2,t[1]=(c*o+p*i+d*r-l*a)*2,t[2]=(d*o+p*a+l*i-c*r)*2),kL(n,e,t),n}function d3(n,e){return n[0]=e[12],n[1]=e[13],n[2]=e[14],n}function LL(n,e){var t=e[0],r=e[1],i=e[2],a=e[4],o=e[5],l=e[6],c=e[8],d=e[9],p=e[10];return n[0]=Math.hypot(t,r,i),n[1]=Math.hypot(a,o,l),n[2]=Math.hypot(c,d,p),n}function p3(n,e){var t=new vt(3);LL(t,e);var r=1/t[0],i=1/t[1],a=1/t[2],o=e[0]*r,l=e[1]*i,c=e[2]*a,d=e[4]*r,p=e[5]*i,m=e[6]*a,y=e[8]*r,v=e[9]*i,b=e[10]*a,x=o+p+b,C=0;return x>0?(C=Math.sqrt(x+1)*2,n[3]=.25*C,n[0]=(m-v)/C,n[1]=(y-c)/C,n[2]=(l-d)/C):o>p&&o>b?(C=Math.sqrt(1+o-p-b)*2,n[3]=(m-v)/C,n[0]=.25*C,n[1]=(l+d)/C,n[2]=(y+c)/C):p>b?(C=Math.sqrt(1+p-o-b)*2,n[3]=(y-c)/C,n[0]=(l+d)/C,n[1]=.25*C,n[2]=(m+v)/C):(C=Math.sqrt(1+b-o-p)*2,n[3]=(l-d)/C,n[0]=(y+c)/C,n[1]=(m+v)/C,n[2]=.25*C),n}function f3(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3],c=i+i,d=a+a,p=o+o,m=i*c,y=i*d,v=i*p,b=a*d,x=a*p,C=o*p,k=l*c,D=l*d,P=l*p,M=r[0],I=r[1],E=r[2];return n[0]=(1-(b+C))*M,n[1]=(y+P)*M,n[2]=(v-D)*M,n[3]=0,n[4]=(y-P)*I,n[5]=(1-(m+C))*I,n[6]=(x+k)*I,n[7]=0,n[8]=(v+D)*E,n[9]=(x-k)*E,n[10]=(1-(m+b))*E,n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function h3(n,e,t,r,i){var a=e[0],o=e[1],l=e[2],c=e[3],d=a+a,p=o+o,m=l+l,y=a*d,v=a*p,b=a*m,x=o*p,C=o*m,k=l*m,D=c*d,P=c*p,M=c*m,I=r[0],E=r[1],_=r[2],O=i[0],B=i[1],W=i[2],V=(1-(x+k))*I,U=(v+M)*I,N=(b-P)*I,q=(v-M)*E,ne=(1-(y+k))*E,pe=(C+D)*E,me=(b+P)*_,Pe=(C-D)*_,se=(1-(y+x))*_;return n[0]=V,n[1]=U,n[2]=N,n[3]=0,n[4]=q,n[5]=ne,n[6]=pe,n[7]=0,n[8]=me,n[9]=Pe,n[10]=se,n[11]=0,n[12]=t[0]+O-(V*O+q*B+me*W),n[13]=t[1]+B-(U*O+ne*B+Pe*W),n[14]=t[2]+W-(N*O+pe*B+se*W),n[15]=1,n}function m3(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t+t,l=r+r,c=i+i,d=t*o,p=r*o,m=r*l,y=i*o,v=i*l,b=i*c,x=a*o,C=a*l,k=a*c;return n[0]=1-m-b,n[1]=p+k,n[2]=y-C,n[3]=0,n[4]=p-k,n[5]=1-d-b,n[6]=v+x,n[7]=0,n[8]=y+C,n[9]=v-x,n[10]=1-d-m,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function g3(n,e,t,r,i,a,o){var l=1/(t-e),c=1/(i-r),d=1/(a-o);return n[0]=a*2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a*2*c,n[6]=0,n[7]=0,n[8]=(t+e)*l,n[9]=(i+r)*c,n[10]=(o+a)*d,n[11]=-1,n[12]=0,n[13]=0,n[14]=o*a*2*d,n[15]=0,n}function y3(n,e,t,r,i){var a=1/Math.tan(e/2),o;return n[0]=a/t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,i!=null&&i!==Infinity?(o=1/(r-i),n[10]=(i+r)*o,n[14]=2*i*r*o):(n[10]=-1,n[14]=-2*r),n}function v3(n,e,t,r){var i=Math.tan(e.upDegrees*Math.PI/180),a=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),l=Math.tan(e.rightDegrees*Math.PI/180),c=2/(o+l),d=2/(i+a);return n[0]=c,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=d,n[6]=0,n[7]=0,n[8]=-((o-l)*c*.5),n[9]=(i-a)*d*.5,n[10]=r/(t-r),n[11]=-1,n[12]=0,n[13]=0,n[14]=r*t/(t-r),n[15]=0,n}function S3(n,e,t,r,i,a,o){var l=1/(e-t),c=1/(r-i),d=1/(a-o);return n[0]=-2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*c,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*d,n[11]=0,n[12]=(e+t)*l,n[13]=(i+r)*c,n[14]=(o+a)*d,n[15]=1,n}function b3(n,e,t,r){var i,a,o,l,c,d,p,m,y,v,b=e[0],x=e[1],C=e[2],k=r[0],D=r[1],P=r[2],M=t[0],I=t[1],E=t[2];return Math.abs(b-M)<ze&&Math.abs(x-I)<ze&&Math.abs(C-E)<ze?wL(n):(p=b-M,m=x-I,y=C-E,v=1/Math.hypot(p,m,y),p*=v,m*=v,y*=v,i=D*y-P*m,a=P*p-k*y,o=k*m-D*p,v=Math.hypot(i,a,o),v?(v=1/v,i*=v,a*=v,o*=v):(i=0,a=0,o=0),l=m*o-y*a,c=y*i-p*o,d=p*a-m*i,v=Math.hypot(l,c,d),v?(v=1/v,l*=v,c*=v,d*=v):(l=0,c=0,d=0),n[0]=i,n[1]=l,n[2]=p,n[3]=0,n[4]=a,n[5]=c,n[6]=m,n[7]=0,n[8]=o,n[9]=d,n[10]=y,n[11]=0,n[12]=-(i*b+a*x+o*C),n[13]=-(l*b+c*x+d*C),n[14]=-(p*b+m*x+y*C),n[15]=1,n)}function x3(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=r[0],c=r[1],d=r[2],p=i-t[0],m=a-t[1],y=o-t[2],v=p*p+m*m+y*y;v>0&&(v=1/Math.sqrt(v),p*=v,m*=v,y*=v);var b=c*y-d*m,x=d*p-l*y,C=l*m-c*p;return v=b*b+x*x+C*C,v>0&&(v=1/Math.sqrt(v),b*=v,x*=v,C*=v),n[0]=b,n[1]=x,n[2]=C,n[3]=0,n[4]=m*C-y*x,n[5]=y*b-p*C,n[6]=p*x-m*b,n[7]=0,n[8]=p,n[9]=m,n[10]=y,n[11]=0,n[12]=i,n[13]=a,n[14]=o,n[15]=1,n}function C3(n){return"mat4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+", "+n[9]+", "+n[10]+", "+n[11]+", "+n[12]+", "+n[13]+", "+n[14]+", "+n[15]+")"}function w3(n){return Math.hypot(n[0],n[1],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])}function T3(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n[4]=e[4]+t[4],n[5]=e[5]+t[5],n[6]=e[6]+t[6],n[7]=e[7]+t[7],n[8]=e[8]+t[8],n[9]=e[9]+t[9],n[10]=e[10]+t[10],n[11]=e[11]+t[11],n[12]=e[12]+t[12],n[13]=e[13]+t[13],n[14]=e[14]+t[14],n[15]=e[15]+t[15],n}function EL(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n[4]=e[4]-t[4],n[5]=e[5]-t[5],n[6]=e[6]-t[6],n[7]=e[7]-t[7],n[8]=e[8]-t[8],n[9]=e[9]-t[9],n[10]=e[10]-t[10],n[11]=e[11]-t[11],n[12]=e[12]-t[12],n[13]=e[13]-t[13],n[14]=e[14]-t[14],n[15]=e[15]-t[15],n}function k3(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n[4]=e[4]*t,n[5]=e[5]*t,n[6]=e[6]*t,n[7]=e[7]*t,n[8]=e[8]*t,n[9]=e[9]*t,n[10]=e[10]*t,n[11]=e[11]*t,n[12]=e[12]*t,n[13]=e[13]*t,n[14]=e[14]*t,n[15]=e[15]*t,n}function L3(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n[4]=e[4]+t[4]*r,n[5]=e[5]+t[5]*r,n[6]=e[6]+t[6]*r,n[7]=e[7]+t[7]*r,n[8]=e[8]+t[8]*r,n[9]=e[9]+t[9]*r,n[10]=e[10]+t[10]*r,n[11]=e[11]+t[11]*r,n[12]=e[12]+t[12]*r,n[13]=e[13]+t[13]*r,n[14]=e[14]+t[14]*r,n[15]=e[15]+t[15]*r,n}function E3(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]&&n[9]===e[9]&&n[10]===e[10]&&n[11]===e[11]&&n[12]===e[12]&&n[13]===e[13]&&n[14]===e[14]&&n[15]===e[15]}function P3(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=n[4],l=n[5],c=n[6],d=n[7],p=n[8],m=n[9],y=n[10],v=n[11],b=n[12],x=n[13],C=n[14],k=n[15],D=e[0],P=e[1],M=e[2],I=e[3],E=e[4],_=e[5],O=e[6],B=e[7],W=e[8],V=e[9],U=e[10],N=e[11],q=e[12],ne=e[13],pe=e[14],me=e[15];return Math.abs(t-D)<=ze*Math.max(1,Math.abs(t),Math.abs(D))&&Math.abs(r-P)<=ze*Math.max(1,Math.abs(r),Math.abs(P))&&Math.abs(i-M)<=ze*Math.max(1,Math.abs(i),Math.abs(M))&&Math.abs(a-I)<=ze*Math.max(1,Math.abs(a),Math.abs(I))&&Math.abs(o-E)<=ze*Math.max(1,Math.abs(o),Math.abs(E))&&Math.abs(l-_)<=ze*Math.max(1,Math.abs(l),Math.abs(_))&&Math.abs(c-O)<=ze*Math.max(1,Math.abs(c),Math.abs(O))&&Math.abs(d-B)<=ze*Math.max(1,Math.abs(d),Math.abs(B))&&Math.abs(p-W)<=ze*Math.max(1,Math.abs(p),Math.abs(W))&&Math.abs(m-V)<=ze*Math.max(1,Math.abs(m),Math.abs(V))&&Math.abs(y-U)<=ze*Math.max(1,Math.abs(y),Math.abs(U))&&Math.abs(v-N)<=ze*Math.max(1,Math.abs(v),Math.abs(N))&&Math.abs(b-q)<=ze*Math.max(1,Math.abs(b),Math.abs(q))&&Math.abs(x-ne)<=ze*Math.max(1,Math.abs(x),Math.abs(ne))&&Math.abs(C-pe)<=ze*Math.max(1,Math.abs(C),Math.abs(pe))&&Math.abs(k-me)<=ze*Math.max(1,Math.abs(k),Math.abs(me))}var D3=TL,A3=EL;var qe={};oc(qe,{add:()=>X4,calculateW:()=>F4,clone:()=>q4,conjugate:()=>H4,copy:()=>K4,create:()=>Iv,dot:()=>qL,equals:()=>rG,exactEquals:()=>nG,exp:()=>zL,fromEuler:()=>$4,fromMat3:()=>$L,fromValues:()=>J4,getAngle:()=>O4,getAxisAngle:()=>V4,identity:()=>_4,invert:()=>z4,len:()=>eG,length:()=>JL,lerp:()=>Z4,ln:()=>HL,mul:()=>Q4,multiply:()=>WL,normalize:()=>Mv,pow:()=>G4,random:()=>W4,rotateX:()=>N4,rotateY:()=>B4,rotateZ:()=>U4,rotationTo:()=>iG,scale:()=>jL,set:()=>Y4,setAxes:()=>oG,setAxisAngle:()=>GL,slerp:()=>jf,sqlerp:()=>aG,sqrLen:()=>tG,squaredLength:()=>KL,str:()=>j4});var J={};oc(J,{add:()=>_3,angle:()=>e4,bezier:()=>j3,ceil:()=>V3,clone:()=>I3,copy:()=>M3,create:()=>Wf,cross:()=>sd,dist:()=>l4,distance:()=>ML,div:()=>s4,divide:()=>IL,dot:()=>zf,equals:()=>i4,exactEquals:()=>r4,floor:()=>O3,forEach:()=>d4,fromValues:()=>lc,hermite:()=>$3,inverse:()=>z3,len:()=>Sv,length:()=>PL,lerp:()=>H3,max:()=>B3,min:()=>N3,mul:()=>o4,multiply:()=>AL,negate:()=>W3,normalize:()=>od,random:()=>q3,rotateX:()=>X3,rotateY:()=>Q3,rotateZ:()=>Z3,round:()=>U3,scale:()=>F3,scaleAndAdd:()=>G3,set:()=>R3,sqrDist:()=>c4,sqrLen:()=>u4,squaredDistance:()=>RL,squaredLength:()=>_L,str:()=>n4,sub:()=>a4,subtract:()=>DL,transformMat3:()=>K3,transformMat4:()=>J3,transformQuat:()=>Y3,zero:()=>t4});function Wf(){var n=new vt(3);return vt!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function I3(n){var e=new vt(3);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e}function PL(n){var e=n[0],t=n[1],r=n[2];return Math.hypot(e,t,r)}function lc(n,e,t){var r=new vt(3);return r[0]=n,r[1]=e,r[2]=t,r}function M3(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n}function R3(n,e,t,r){return n[0]=e,n[1]=t,n[2]=r,n}function _3(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n}function DL(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n}function AL(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n}function IL(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n}function V3(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n}function O3(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n[2]=Math.floor(e[2]),n}function N3(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n}function B3(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n}function U3(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n[2]=Math.round(e[2]),n}function F3(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n}function G3(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n}function ML(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2];return Math.hypot(t,r,i)}function RL(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2];return t*t+r*r+i*i}function _L(n){var e=n[0],t=n[1],r=n[2];return e*e+t*t+r*r}function W3(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n}function z3(n,e){return n[0]=1/e[0],n[1]=1/e[1],n[2]=1/e[2],n}function od(n,e){var t=e[0],r=e[1],i=e[2],a=t*t+r*r+i*i;return a>0&&(a=1/Math.sqrt(a)),n[0]=e[0]*a,n[1]=e[1]*a,n[2]=e[2]*a,n}function zf(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function sd(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[0],l=t[1],c=t[2];return n[0]=i*c-a*l,n[1]=a*o-r*c,n[2]=r*l-i*o,n}function H3(n,e,t,r){var i=e[0],a=e[1],o=e[2];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=o+r*(t[2]-o),n}function $3(n,e,t,r,i,a){var o=a*a,l=o*(2*a-3)+1,c=o*(a-2)+a,d=o*(a-1),p=o*(3-2*a);return n[0]=e[0]*l+t[0]*c+r[0]*d+i[0]*p,n[1]=e[1]*l+t[1]*c+r[1]*d+i[1]*p,n[2]=e[2]*l+t[2]*c+r[2]*d+i[2]*p,n}function j3(n,e,t,r,i,a){var o=1-a,l=o*o,c=a*a,d=l*o,p=3*a*l,m=3*c*o,y=c*a;return n[0]=e[0]*d+t[0]*p+r[0]*m+i[0]*y,n[1]=e[1]*d+t[1]*p+r[1]*m+i[1]*y,n[2]=e[2]*d+t[2]*p+r[2]*m+i[2]*y,n}function q3(n,e){e=e||1;var t=_r()*2*Math.PI,r=_r()*2-1,i=Math.sqrt(1-r*r)*e;return n[0]=Math.cos(t)*i,n[1]=Math.sin(t)*i,n[2]=r*e,n}function J3(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[3]*r+t[7]*i+t[11]*a+t[15];return o=o||1,n[0]=(t[0]*r+t[4]*i+t[8]*a+t[12])/o,n[1]=(t[1]*r+t[5]*i+t[9]*a+t[13])/o,n[2]=(t[2]*r+t[6]*i+t[10]*a+t[14])/o,n}function K3(n,e,t){var r=e[0],i=e[1],a=e[2];return n[0]=r*t[0]+i*t[3]+a*t[6],n[1]=r*t[1]+i*t[4]+a*t[7],n[2]=r*t[2]+i*t[5]+a*t[8],n}function Y3(n,e,t){var r=t[0],i=t[1],a=t[2],o=t[3],l=e[0],c=e[1],d=e[2],p=i*d-a*c,m=a*l-r*d,y=r*c-i*l,v=i*y-a*m,b=a*p-r*y,x=r*m-i*p,C=o*2;return p*=C,m*=C,y*=C,v*=2,b*=2,x*=2,n[0]=l+p+v,n[1]=c+m+b,n[2]=d+y+x,n}function X3(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[0],a[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),a[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function Q3(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),a[1]=i[1],a[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function Z3(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),a[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),a[2]=i[2],n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function e4(n,e){var t=lc(n[0],n[1],n[2]),r=lc(e[0],e[1],e[2]);od(t,t),od(r,r);var i=zf(t,r);return i>1?0:i<-1?Math.PI:Math.acos(i)}function t4(n){return n[0]=0,n[1]=0,n[2]=0,n}function n4(n){return"vec3("+n[0]+", "+n[1]+", "+n[2]+")"}function r4(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]}function i4(n,e){var t=n[0],r=n[1],i=n[2],a=e[0],o=e[1],l=e[2];return Math.abs(t-a)<=ze*Math.max(1,Math.abs(t),Math.abs(a))&&Math.abs(r-o)<=ze*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-l)<=ze*Math.max(1,Math.abs(i),Math.abs(l))}var a4=DL,o4=AL,s4=IL,l4=ML,c4=RL,Sv=PL,u4=_L,d4=function(){var n=Wf();return function(e,t,r,i,a,o){var l,c;for(t||(t=3),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],a(n,n,o),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2];return e}}();var nr={};oc(nr,{add:()=>Tv,ceil:()=>p4,clone:()=>bv,copy:()=>Cv,create:()=>VL,cross:()=>b4,dist:()=>D4,distance:()=>UL,div:()=>P4,divide:()=>BL,dot:()=>Ev,equals:()=>Av,exactEquals:()=>Dv,floor:()=>f4,forEach:()=>R4,fromValues:()=>xv,inverse:()=>S4,len:()=>I4,length:()=>Hf,lerp:()=>Pv,max:()=>m4,min:()=>h4,mul:()=>E4,multiply:()=>NL,negate:()=>v4,normalize:()=>Lv,random:()=>x4,round:()=>g4,scale:()=>kv,scaleAndAdd:()=>y4,set:()=>wv,sqrDist:()=>A4,sqrLen:()=>M4,squaredDistance:()=>FL,squaredLength:()=>$f,str:()=>k4,sub:()=>L4,subtract:()=>OL,transformMat4:()=>C4,transformQuat:()=>w4,zero:()=>T4});function VL(){var n=new vt(4);return vt!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function bv(n){var e=new vt(4);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e}function xv(n,e,t,r){var i=new vt(4);return i[0]=n,i[1]=e,i[2]=t,i[3]=r,i}function Cv(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n}function wv(n,e,t,r,i){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n}function Tv(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n}function OL(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n}function NL(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n[3]=e[3]*t[3],n}function BL(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n[3]=e[3]/t[3],n}function p4(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n[3]=Math.ceil(e[3]),n}function f4(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n[2]=Math.floor(e[2]),n[3]=Math.floor(e[3]),n}function h4(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n[3]=Math.min(e[3],t[3]),n}function m4(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n[3]=Math.max(e[3],t[3]),n}function g4(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n[2]=Math.round(e[2]),n[3]=Math.round(e[3]),n}function kv(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n}function y4(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n}function UL(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2],a=e[3]-n[3];return Math.hypot(t,r,i,a)}function FL(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2],a=e[3]-n[3];return t*t+r*r+i*i+a*a}function Hf(n){var e=n[0],t=n[1],r=n[2],i=n[3];return Math.hypot(e,t,r,i)}function $f(n){var e=n[0],t=n[1],r=n[2],i=n[3];return e*e+t*t+r*r+i*i}function v4(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=-e[3],n}function S4(n,e){return n[0]=1/e[0],n[1]=1/e[1],n[2]=1/e[2],n[3]=1/e[3],n}function Lv(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t*t+r*r+i*i+a*a;return o>0&&(o=1/Math.sqrt(o)),n[0]=t*o,n[1]=r*o,n[2]=i*o,n[3]=a*o,n}function Ev(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]+n[3]*e[3]}function b4(n,e,t,r){var i=t[0]*r[1]-t[1]*r[0],a=t[0]*r[2]-t[2]*r[0],o=t[0]*r[3]-t[3]*r[0],l=t[1]*r[2]-t[2]*r[1],c=t[1]*r[3]-t[3]*r[1],d=t[2]*r[3]-t[3]*r[2],p=e[0],m=e[1],y=e[2],v=e[3];return n[0]=m*d-y*c+v*l,n[1]=-(p*d)+y*o-v*a,n[2]=p*c-m*o+v*i,n[3]=-(p*l)+m*a-y*i,n}function Pv(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=o+r*(t[2]-o),n[3]=l+r*(t[3]-l),n}function x4(n,e){e=e||1;var t,r,i,a,o,l;do t=_r()*2-1,r=_r()*2-1,o=t*t+r*r;while(o>=1);do i=_r()*2-1,a=_r()*2-1,l=i*i+a*a;while(l>=1);var c=Math.sqrt((1-o)/l);return n[0]=e*t,n[1]=e*r,n[2]=e*i*c,n[3]=e*a*c,n}function C4(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3];return n[0]=t[0]*r+t[4]*i+t[8]*a+t[12]*o,n[1]=t[1]*r+t[5]*i+t[9]*a+t[13]*o,n[2]=t[2]*r+t[6]*i+t[10]*a+t[14]*o,n[3]=t[3]*r+t[7]*i+t[11]*a+t[15]*o,n}function w4(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[0],l=t[1],c=t[2],d=t[3],p=d*r+l*a-c*i,m=d*i+c*r-o*a,y=d*a+o*i-l*r,v=-o*r-l*i-c*a;return n[0]=p*d+v*-o+m*-c-y*-l,n[1]=m*d+v*-l+y*-o-p*-c,n[2]=y*d+v*-c+p*-l-m*-o,n[3]=e[3],n}function T4(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=0,n}function k4(n){return"vec4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"}function Dv(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]}function Av(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=e[0],l=e[1],c=e[2],d=e[3];return Math.abs(t-o)<=ze*Math.max(1,Math.abs(t),Math.abs(o))&&Math.abs(r-l)<=ze*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-c)<=ze*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(a-d)<=ze*Math.max(1,Math.abs(a),Math.abs(d))}var L4=OL,E4=NL,P4=BL,D4=UL,A4=FL,I4=Hf,M4=$f,R4=function(){var n=VL();return function(e,t,r,i,a,o){var l,c;for(t||(t=4),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],n[3]=e[l+3],a(n,n,o),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2],e[l+3]=n[3];return e}}();function Iv(){var n=new vt(4);return vt!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function _4(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function GL(n,e,t){t=t*.5;var r=Math.sin(t);return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=Math.cos(t),n}function V4(n,e){var t=Math.acos(e[3])*2,r=Math.sin(t/2);return r>ze?(n[0]=e[0]/r,n[1]=e[1]/r,n[2]=e[2]/r):(n[0]=1,n[1]=0,n[2]=0),t}function O4(n,e){var t=qL(n,e);return Math.acos(2*t*t-1)}function WL(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=t[0],c=t[1],d=t[2],p=t[3];return n[0]=r*p+o*l+i*d-a*c,n[1]=i*p+o*c+a*l-r*d,n[2]=a*p+o*d+r*c-i*l,n[3]=o*p-r*l-i*c-a*d,n}function N4(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+o*l,n[1]=i*c+a*l,n[2]=a*c-i*l,n[3]=o*c-r*l,n}function B4(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c-a*l,n[1]=i*c+o*l,n[2]=a*c+r*l,n[3]=o*c-i*l,n}function U4(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+i*l,n[1]=i*c-r*l,n[2]=a*c+o*l,n[3]=o*c-a*l,n}function F4(n,e){var t=e[0],r=e[1],i=e[2];return n[0]=t,n[1]=r,n[2]=i,n[3]=Math.sqrt(Math.abs(1-t*t-r*r-i*i)),n}function zL(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=Math.sqrt(t*t+r*r+i*i),l=Math.exp(a),c=o>0?l*Math.sin(o)/o:0;return n[0]=t*c,n[1]=r*c,n[2]=i*c,n[3]=l*Math.cos(o),n}function HL(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=Math.sqrt(t*t+r*r+i*i),l=o>0?Math.atan2(o,a)/o:0;return n[0]=t*l,n[1]=r*l,n[2]=i*l,n[3]=.5*Math.log(t*t+r*r+i*i+a*a),n}function G4(n,e,t){return HL(n,e),jL(n,n,t),zL(n,n),n}function jf(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3],c=t[0],d=t[1],p=t[2],m=t[3],y,v,b,x,C;return v=i*c+a*d+o*p+l*m,v<0&&(v=-v,c=-c,d=-d,p=-p,m=-m),1-v>ze?(y=Math.acos(v),b=Math.sin(y),x=Math.sin((1-r)*y)/b,C=Math.sin(r*y)/b):(x=1-r,C=r),n[0]=x*i+C*c,n[1]=x*a+C*d,n[2]=x*o+C*p,n[3]=x*l+C*m,n}function W4(n){var e=_r(),t=_r(),r=_r(),i=Math.sqrt(1-e),a=Math.sqrt(e);return n[0]=i*Math.sin(2*Math.PI*t),n[1]=i*Math.cos(2*Math.PI*t),n[2]=a*Math.sin(2*Math.PI*r),n[3]=a*Math.cos(2*Math.PI*r),n}function z4(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t*t+r*r+i*i+a*a,l=o?1/o:0;return n[0]=-t*l,n[1]=-r*l,n[2]=-i*l,n[3]=a*l,n}function H4(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=e[3],n}function $L(n,e){var t=e[0]+e[4]+e[8],r;if(t>0)r=Math.sqrt(t+1),n[3]=.5*r,r=.5/r,n[0]=(e[5]-e[7])*r,n[1]=(e[6]-e[2])*r,n[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[i*3+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3;r=Math.sqrt(e[i*3+i]-e[a*3+a]-e[o*3+o]+1),n[i]=.5*r,r=.5/r,n[3]=(e[a*3+o]-e[o*3+a])*r,n[a]=(e[a*3+i]+e[i*3+a])*r,n[o]=(e[o*3+i]+e[i*3+o])*r}return n}function $4(n,e,t,r){var i=.5*Math.PI/180;e*=i,t*=i,r*=i;var a=Math.sin(e),o=Math.cos(e),l=Math.sin(t),c=Math.cos(t),d=Math.sin(r),p=Math.cos(r);return n[0]=a*c*p-o*l*d,n[1]=o*l*p+a*c*d,n[2]=o*c*d-a*l*p,n[3]=o*c*p+a*l*d,n}function j4(n){return"quat("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"}var q4=bv,J4=xv,K4=Cv,Y4=wv,X4=Tv,Q4=WL,jL=kv,qL=Ev,Z4=Pv,JL=Hf,eG=JL,KL=$f,tG=KL,Mv=Lv,nG=Dv,rG=Av,iG=function(){var n=Wf(),e=lc(1,0,0),t=lc(0,1,0);return function(r,i,a){var o=zf(i,a);return o<-.999999?(sd(n,e,i),Sv(n)<1e-6&&sd(n,t,i),od(n,n),GL(r,n,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(sd(n,i,a),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=1+o,Mv(r,r))}}(),aG=function(){var n=Iv(),e=Iv();return function(t,r,i,a,o,l){return jf(n,r,o,l),jf(e,i,a,l),jf(t,n,e,2*l*(1-l)),t}}(),oG=function(){var n=vv();return function(e,t,r,i){return n[0]=r[0],n[3]=r[1],n[6]=r[2],n[1]=i[0],n[4]=i[1],n[7]=i[2],n[2]=-t[0],n[5]=-t[1],n[8]=-t[2],Mv(e,$L(e,n))}}();var vr={};oc(vr,{add:()=>dG,angle:()=>IG,ceil:()=>pG,clone:()=>sG,copy:()=>cG,create:()=>YL,cross:()=>wG,dist:()=>FG,distance:()=>eE,div:()=>UG,divide:()=>ZL,dot:()=>CG,equals:()=>VG,exactEquals:()=>_G,floor:()=>fG,forEach:()=>zG,fromValues:()=>lG,inverse:()=>bG,len:()=>OG,length:()=>nE,lerp:()=>TG,max:()=>mG,min:()=>hG,mul:()=>BG,multiply:()=>QL,negate:()=>SG,normalize:()=>xG,random:()=>kG,rotate:()=>AG,round:()=>gG,scale:()=>yG,scaleAndAdd:()=>vG,set:()=>uG,sqrDist:()=>GG,sqrLen:()=>WG,squaredDistance:()=>tE,squaredLength:()=>rE,str:()=>RG,sub:()=>NG,subtract:()=>XL,transformMat2:()=>LG,transformMat2d:()=>EG,transformMat3:()=>PG,transformMat4:()=>DG,zero:()=>MG});function YL(){var n=new vt(2);return vt!=Float32Array&&(n[0]=0,n[1]=0),n}function sG(n){var e=new vt(2);return e[0]=n[0],e[1]=n[1],e}function lG(n,e){var t=new vt(2);return t[0]=n,t[1]=e,t}function cG(n,e){return n[0]=e[0],n[1]=e[1],n}function uG(n,e,t){return n[0]=e,n[1]=t,n}function dG(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n}function XL(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n}function QL(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n}function ZL(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n}function pG(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n}function fG(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n}function hG(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n}function mG(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n}function gG(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n}function yG(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n}function vG(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n}function eE(n,e){var t=e[0]-n[0],r=e[1]-n[1];return Math.hypot(t,r)}function tE(n,e){var t=e[0]-n[0],r=e[1]-n[1];return t*t+r*r}function nE(n){var e=n[0],t=n[1];return Math.hypot(e,t)}function rE(n){var e=n[0],t=n[1];return e*e+t*t}function SG(n,e){return n[0]=-e[0],n[1]=-e[1],n}function bG(n,e){return n[0]=1/e[0],n[1]=1/e[1],n}function xG(n,e){var t=e[0],r=e[1],i=t*t+r*r;return i>0&&(i=1/Math.sqrt(i)),n[0]=e[0]*i,n[1]=e[1]*i,n}function CG(n,e){return n[0]*e[0]+n[1]*e[1]}function wG(n,e,t){var r=e[0]*t[1]-e[1]*t[0];return n[0]=n[1]=0,n[2]=r,n}function TG(n,e,t,r){var i=e[0],a=e[1];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n}function kG(n,e){e=e||1;var t=_r()*2*Math.PI;return n[0]=Math.cos(t)*e,n[1]=Math.sin(t)*e,n}function LG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[2]*i,n[1]=t[1]*r+t[3]*i,n}function EG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[2]*i+t[4],n[1]=t[1]*r+t[3]*i+t[5],n}function PG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[3]*i+t[6],n[1]=t[1]*r+t[4]*i+t[7],n}function DG(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[4]*i+t[12],n[1]=t[1]*r+t[5]*i+t[13],n}function AG(n,e,t,r){var i=e[0]-t[0],a=e[1]-t[1],o=Math.sin(r),l=Math.cos(r);return n[0]=i*l-a*o+t[0],n[1]=i*o+a*l+t[1],n}function IG(n,e){var t=n[0],r=n[1],i=e[0],a=e[1],o=t*t+r*r;o>0&&(o=1/Math.sqrt(o));var l=i*i+a*a;l>0&&(l=1/Math.sqrt(l));var c=(t*i+r*a)*o*l;return c>1?0:c<-1?Math.PI:Math.acos(c)}function MG(n){return n[0]=0,n[1]=0,n}function RG(n){return"vec2("+n[0]+", "+n[1]+")"}function _G(n,e){return n[0]===e[0]&&n[1]===e[1]}function VG(n,e){var t=n[0],r=n[1],i=e[0],a=e[1];return Math.abs(t-i)<=ze*Math.max(1,Math.abs(t),Math.abs(i))&&Math.abs(r-a)<=ze*Math.max(1,Math.abs(r),Math.abs(a))}var OG=nE,NG=XL,BG=QL,UG=ZL,FG=eE,GG=tE,WG=rE,zG=function(){var n=YL();return function(e,t,r,i,a,o){var l,c;for(t||(t=2),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],a(n,n,o),e[l]=n[0],e[l+1]=n[1];return e}}();var qf=re.create(),iE=["x","y","z"],Jr=[J.fromValues(1,0,0),J.fromValues(0,1,0),J.fromValues(0,0,1)],v8=J.fromValues(0,0,0),ld=nr.fromValues(0,0,0,0),Jf=J.fromValues(1,1,1),S8=J.fromValues(Infinity,Infinity,Infinity),b8=qe.create();function cd(n){return n[0]*n[1]*n[2]}function Fo(n){return`${n[0]},${n[1]},${n[2]}`}function aE(n,e,t){let r=e[0],i=e[1],a=e[2];return n[0]=t[0]*r+t[4]*i+t[8]*a,n[1]=t[1]*r+t[5]*i+t[9]*a,n[2]=t[2]*r+t[6]*i+t[10]*a,n}function Kf(n,e,t){let r=e[0],i=e[1],a=e[2];return n[0]=t[0]*r+t[1]*i+t[2]*a,n[1]=t[4]*r+t[5]*i+t[6]*a,n[2]=t[8]*r+t[9]*i+t[10]*a,n}function HG(n,e,t){let r=t.length,i=0;for(let o=0;o<r;++o)i+=(n[o]-e[o])**2;let a=0;for(let o=0;o<r;++o){let l=n[o];a-=(l-t[o])*(e[o]-l)}return a/Math.max(i,1e-6)}function Yf(n,e,t,r){let i=n.length,a=HG(e,t,r);a=Math.max(0,Math.min(1,a));for(let o=0;o<i;++o){let l=e[o];n[o]=l+a*(t[o]-l)}return n}function Us(n,e){let t=e[0],r=e[1],i=e[2],a=e[4],o=e[5],l=e[6],c=e[8],d=e[9],p=e[10];return n[0]=t,n[1]=r,n[2]=i,n[3]=a,n[4]=o,n[5]=l,n[6]=c,n[7]=d,n[8]=p,n}function Fs(n,e){let t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],k=e[15];n[0]=a+t,n[1]=d+o,n[2]=v+p,n[3]=k+b,n[4]=a-t,n[5]=d-o,n[6]=v-p,n[7]=k-b,n[8]=a+r,n[9]=d+l,n[10]=v+m,n[11]=k+x,n[12]=a-r,n[13]=d-l,n[14]=v-m,n[15]=k-x;let D=a+i,P=d+c,M=v+y,I=k+C,E=a-i,_=d-c,O=v-y,B=k-C,W=Math.sqrt(D**2+P**2+M**2);n[16]=D/W,n[17]=P/W,n[18]=M/W,n[19]=I/W;let V=Math.sqrt(E**2+_**2+O**2);return n[20]=E/V,n[21]=_/V,n[22]=O/V,n[23]=B/V,n}function Xf(n,e,t,r,i,a,o){for(let l=0;l<6;++l){let c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3];if(Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a)+m<0)return!1}return!0}function oE(n,e,t,r,i,a,o){for(let l=0;l<4;++l){let c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3];if(Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a)+m<0)return!1}{let l=5,c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3],y=Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a),v=Math.min(c*n,c*r)+Math.min(d*e,d*i)+Math.min(p*t,p*a),b=Math.abs(m)*1e-6;if(v>-m+b||y<-m-b)return!1}return!0}function Gs(n,e,t,r=!1){let i=t.length,a=[],o=r?1:e+1,l=r?e+1:1;for(let c=0;c<i;++c){let d=t[c];for(let p=0;p<e;++p)n[p*o+d*l]!==0&&(a[p]=!0)}return Vk(a,!0)}function Rv(n,e,t){for(let r=0;r<3;++r){let i=t[r];for(let a=0;a<3;++a)n[r+a*3]=i*e[r+a*3]}return n}function sE(n){if(n[15]===1){let o=2/Math.abs(n[10]),l=2/Math.abs(n[0]),c=2/Math.abs(n[5]);return l*c*o}let e=n[10],t=n[14],r=2*t/(2*e-2),i=(e-1)*r/(e+1);return 4/(n[0]*n[5])/3*(Math.abs(i)**3-Math.abs(r)**3)}function Qf(n){if(n[15]===1)return 2/Math.abs(n[10]);let e=n[10],t=n[14],r=2*t/(2*e-2),i=(e-1)*r/(e+1);return Math.abs(i-r)}function lE(n){return n[2]=0,n[6]=0,n[10]=0,n[14]=0,n}var cc=J.create();function cE(n,e){e[0]=e[1]=e[2]=Number.POSITIVE_INFINITY,e[3]=e[4]=e[5]=Number.NEGATIVE_INFINITY;for(let t=0;t<8;++t){cc[0]=2*(t&1)-1,cc[1]=2*(t>>>1&1)-1,cc[2]=2*(t>>>2&1)-1,J.transformMat4(cc,cc,n);for(let r=0;r<3;++r){let i=cc[r];e[r]=Math.min(e[r],i),e[r+3]=Math.max(e[r+3],i)}}}function _v(n){return("0"+n.toString(16)).slice(-2)}function uE(n){return Array.prototype.map.call(n,_v).join("")}function dE(n){if(!/^(?:[0-9a-fA-F]{2})*$/.test(n))throw new Error("Invalid hex-encoded string");let e=n.length/2,t=new Uint8Array(e);for(let r=0;r<e;++r)t[r]=parseInt(n.substr(r*2,2),16);return t}function $G(n){let e=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{let r=n.match(e);if(r!==null)return[parseInt(r[1],10),parseInt(r[2],10),parseInt(r[3],10),parseFloat(r[4])]}let t=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{let r=n.match(t);if(r!==null)return[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16),1]}throw new Error(`Invalid serialized color: ${JSON.stringify(n)}.`)}function Vv(n){try{if(typeof n!="string")throw new Error(`Expected string, but received ${JSON.stringify(n)}.`);let e=document.createElement("canvas").getContext("2d");e.fillStyle=n;let t=$G(e.fillStyle);return nr.fromValues(t[0]/255,t[1]/255,t[2]/255,t[3])}catch(e){throw new Error(`Failed to parse color specification: ${e.message}`)}}function ha(n){return Vv(n).subarray(0,3)}function ud(n){let e=n[3]===void 0?3:4,t=0;for(let r=0;r<e;r++)t=(t<<8>>>0)+Math.min(255,Math.max(0,Math.round(n[e-1-r]*255)));return t}function Za(n){return J.fromValues((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255)}function dd(n){return nr.fromValues((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255,(n>>>24&255)/255)}function hn(n){if(n[3]===void 0||n[3]===1){let e="#";for(let t=0;t<3;++t)e+=_v(Math.min(255,Math.max(0,Math.round(n[t]*255))));return e}else{let e="rgba(";for(let t=0;t<3;++t)t!==0&&(e+=", "),e+=Math.min(255,Math.max(0,Math.round(n[t]*255)));return e+=`, ${bL(n[3])})`,e}}function Ov(n){return n<=.03928?n/12.92:((n+.055)/1.055)**2.4}function jG(n){let[e,t,r]=n;return .2126*Ov(e)+.7152*Ov(t)+.0722*Ov(r)}function pd(n){return jG(n)<=.179}var Go=class extends Re{constructor(e){super(J.clone(e));this.defaultValue=e}toString(){return hn(this.value)}toJSON(){if(!J.equals(this.value,this.defaultValue))return hn(this.value)}reset(){this.value=J.clone(this.defaultValue)}restoreState(e){if(e===void 0){this.reset();return}let{value:t}=this,r=ha(e);J.equals(t,r)||(this.value=r)}},Nv=class extends Re{constructor(){super(void 0)}toJSON(){let{value:e}=this;if(e!==void 0)return hn(e)}reset(){this.value=void 0}restoreState(e){if(e===void 0){this.reset();return}let{value:t}=this,r=ha(e);(t===void 0||!J.equals(t,r))&&(this.value=r)}};var H;(function(c){c[c.UINT8=0]="UINT8",c[c.INT8=1]="INT8",c[c.UINT16=2]="UINT16",c[c.INT16=3]="INT16",c[c.UINT32=4]="UINT32",c[c.INT32=5]="INT32",c[c.UINT64=6]="UINT64",c[c.FLOAT32=7]="FLOAT32"})(H||(H={}));var Zf={[0]:!1,[1]:!0,[2]:!1,[3]:!0,[4]:!1,[5]:!0,[6]:!1,[7]:void 0},eh={[0]:1,[1]:1,[2]:2,[3]:2,[4]:4,[5]:4,[6]:8,[7]:4},pE={[0]:Uint8Array,[1]:Int8Array,[2]:Uint16Array,[3]:Int16Array,[4]:Uint32Array,[5]:Int32Array,[6]:Uint32Array,[7]:Float32Array},D8={[0]:1,[1]:1,[2]:1,[3]:1,[4]:1,[5]:1,[6]:2,[7]:1};var mn;(function(t){t[t.LITTLE=0]="LITTLE",t[t.BIG=1]="BIG"})(mn||(mn={}));function qG(){let n=Uint16Array.of(4386);return new Uint8Array(n.buffer)[0]===17?1:0}var ma=qG();function zn(n){let e=typeof n;if(e==="number"||e==="string"){let t=parseFloat(""+n);if(!Number.isNaN(t))return t}throw new Error(`Expected floating-point number, but received: ${JSON.stringify(n)}.`)}function Ye(n){let e=zn(n);if(Number.isFinite(e))return e;throw new Error(`Expected finite floating-point number, but received: ${e}.`)}function th(n){let e=zn(n);if(Number.isFinite(e)&&e>=0)return e;throw new Error(`Expected finite non-negative floating-point number, but received: ${e}.`)}function St(n){let e=Ye(n);if(e>0)return e;throw new Error(`Expected positive finite floating-point number, but received: ${e}.`)}function fd(n,e,t=zn){Q(e),n[0]=n[1]=n[2]=0;for(let r of Object.keys(e))switch(r){case"x":n[0]=t(e[r]);break;case"y":n[1]=t(e[r]);break;case"z":n[2]=t(e[r]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${JSON.stringify(e)}.`)}return n}function Wo(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes");for(let r=0;r<t;++r)if(!Number.isFinite(parseFloat(e[r])))throw new Error("Non-finite value.");for(let r=0;r<t;++r)n[r]=parseFloat(e[r]);return n}function zo(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes.");for(let r=0;r<t;++r){let i=parseInt(e[r],void 0);if(!Number.isInteger(i))throw new Error("Non-integer value.")}for(let r=0;r<t;++r)n[r]=parseInt(e[r],void 0);return n}function Hn(n){if(typeof n=="object"){if(n===null)return"null";if(Array.isArray(n)){let a="[",o=n.length,l=0;if(l<o)for(a+=Hn(n[l]);++l<o;)a+=",",a+=Hn(n[l]);return a+="]",a}let e="{",t=Object.keys(n).sort(),r=0,i=t.length;if(r<i){let a=t[r];for(e+=JSON.stringify(a),e+=":",e+=Hn(n[a]);++r<i;)e+=",",a=t[r],e+=JSON.stringify(a),e+=":",e+=Hn(n[a])}return e+="}",e}return JSON.stringify(n)}var fE=/('(?:[^'\\]|(?:\\.))*')/,hE=/("(?:[^"\\]|(?:\\.))*")/,JG=new RegExp(`${fE.source}|${hE.source}`),KG=new RegExp(`${hE.source}|${fE.source}`),YG=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/,XG=/^((?:[^"'\\]|(?:\\.))*)'/;function QG(n,e,t,r){if(n.length>=2&&n.charAt(0)===e&&n.charAt(n.length-1)===e){let i=n.substr(1,n.length-2),a=t;for(;i.length>0;){let o=i.match(r);if(o===null){a+=i;break}a+=o[1],o[2]===t?(a+="\\",a+=t):a+=e,i=i.substr(o.index+o[0].length)}return a+=t,a}return n}function ZG(n,e,t){let r=/[&_,]/g,i,a,o;t==='"'?(i="'",a=YG,o=JG):(i='"',a=XG,o=KG);let l="";for(;n.length>0;){let c=n.match(o),d,p;if(c===null)d=n,n="",p="";else{d=n.substr(0,c.index),n=n.substr(c.index+c[0].length);let m=c[1];m!==void 0?p=QG(m,i,t,a):p=c[2]}l+=d.replace(r,e),l+=p}return l}function eW(n){return ZG(n,",",'"')}function nh(n){return JSON.parse(eW(n))}function Kr(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${JSON.stringify(n)}.`);if(e!==void 0&&n.length!==e)throw new Error(`Expected array of length ${e}, but received: ${JSON.stringify(n)}.`);return n}function ye(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${JSON.stringify(n)}.`);return n.map(e)}function He(n,e,t){let r=n.length;if(!Array.isArray(e)||e.length!==r)throw new Error(`Expected length ${r} array, but received: ${JSON.stringify(e)}.`);for(let i=0;i<r;++i)n[i]=t(e[i],i);return n}function Q(n){if(typeof n!="object"||n==null||Array.isArray(n))throw new Error(`Expected JSON object, but received: ${JSON.stringify(n)}.`);return n}function ot(n){let e=parseInt(n,10);if(!Number.isInteger(e))throw new Error(`Expected integer, but received: ${JSON.stringify(n)}.`);return e}function wt(n){let e=ot(n);if(e<=0)throw new Error(`Expected positive integer, but received: ${e}.`);return e}function rh(n){let e=ot(n);if(e<0)throw new Error(`Expected non-negative integer, but received: ${e}.`);return e}function ih(n,e){let t=e.get(n);if(t===void 0)throw new Error(`Expected one of ${JSON.stringify(Array.from(e.keys()))}, but received: ${JSON.stringify(n)}.`);return t}function ee(n){if(typeof n!="string")throw new Error(`Expected string, but received: ${JSON.stringify(n)}.`);return n}function Ft(n){if(n!==void 0)return ee(n)}function si(n){if(n!==void 0)return ot(n)}function mE(n){if(n!==void 0){if(typeof n=="boolean")return n;if(n==="true")return!0;if(n==="false")return!1;throw new Error(`Expected string or boolean but received: ${JSON.stringify(n)}`)}}function G(n,e,t){let r=Object.prototype.hasOwnProperty.call(n,e)?n[e]:void 0;try{return t(r)}catch(i){throw new Error(`Error parsing ${JSON.stringify(e)} property: ${i.message}`)}}function le(n,e,t,r){return G(n,e,i=>i===void 0?r:t(i))}function eo(n,e){Q(n);let t=new Map;for(let r of Object.keys(n))try{t.set(r,e(n[r]))}catch(i){throw new Error(`Error parsing value associated with key ${JSON.stringify(r)}: ${i.message}`)}return t}function ah(n){if(typeof n!="number"||!Number.isFinite(n)||n<0||n>1)throw new Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(n)}.`);return n}function Vr(n){if(n==="")return{};if(n.startsWith("{"))return nh(n);{let e={},t=n.split(/[&;]/);for(let r of t){let i=r.match(/^([^=&;]+)=([^&;]*)$/);if(i===null)throw new Error(`Invalid query string part: ${JSON.stringify(r)}.`);e[i[1]]=decodeURIComponent(i[2])}return e}}function gE(n){if(n===void 0)return"";let e=Object.keys(n);return e.length===0?"":e.some(t=>typeof n[t]!="string")?JSON.stringify(n):e.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(n[t])}`).join("&")}function Mt(n,e){if(typeof n=="string"&&n.match(/^[a-zA-Z]/)!==null&&(n=n.toUpperCase(),e.hasOwnProperty(n)))return e[n];throw new Error(`Invalid enum value: ${JSON.stringify(n)}.`)}function yE(n){return He(J.create(),n,Ye)}function vE(n){return He(J.create(),n,St)}function SE(n){return He(J.create(),n,wt)}function jt(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${JSON.stringify(n)}.`);for(let e of n)if(typeof e!="string")throw new Error(`Expected string, received: ${JSON.stringify(e)}.`);return n}function bE(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${JSON.stringify(n)}.`);for(let e of n)if(!Number.isInteger(e))throw new Error(`Expected integer, received: ${JSON.stringify(e)}.`);return n}function Ii(n){if(typeof n!="boolean")throw new Error(`Expected boolean, received: ${JSON.stringify(n)}`);return n}function Mi(n){for(let e in n)return n}var xE=2**-1074,Bv=new Float64Array(1),Ho=new Uint32Array(Bv.buffer);function CE(n,e){if(isNaN(n)||isNaN(e))return NaN;if(n===e)return e;if(n===0)return e<0?-xE:xE;Bv[0]=n;let t=ma===mn.LITTLE?0:1,r=1-t;return e>n==n>0?Ho[t]===4294967295?(Ho[t]=0,Ho[r]+=1):Ho[t]+=1:Ho[t]===0?(Ho[t]=4294967295,Ho[r]-=1):Ho[t]-=1,Bv[0]}var Uv=new Uint32Array(2),hd=4294967296,Fv=[];for(let n=2;n<=36;++n){let e=Math.floor(32/Math.log2(n)),t=Math.pow(n,e),r=`^[0-${String.fromCharCode("0".charCodeAt(0)+Math.min(9,n-1))}`;n>10&&(r+=`a-${String.fromCharCode("a".charCodeAt(0)+n-11)}`,r+=`A-${String.fromCharCode("A".charCodeAt(0)+n-11)}`),r+=`]{1,${Math.ceil(64/Math.log2(n))}}$`;let a=new RegExp(r);Fv[n]={lowDigits:e,lowBase:t,pattern:a}}function wE(n,e){n>>>=0,e>>>=0;let t=n&65535,r=n>>>16,i=e&65535,a=e>>>16,l=(t*i>>>16)+r*i,c=l>>>16;l=(l&65535)+t*a,c+=l>>>16;let d=c>>>16;return c=(c&65535)+r*a,d+=c>>>16,((d&65535)<<16|c&65535)>>>0}var li=class{constructor(e=0,t=0){this.low=e;this.high=t}clone(){return new li(this.low,this.high)}assign(e){this.low=e.low,this.high=e.high}toString(e=10){let t=this.low,r=this.high;if(r===0)return t.toString(e);r*=hd;let{lowBase:i,lowDigits:a}=Fv[e],o=r%i;r=Math.floor(r/i),t+=o,r+=Math.floor(t/i),t=t%i;let l=t.toString(e);return r.toString(e)+"0".repeat(a-l.length)+l}static less(e,t){return e.high<t.high||e.high===t.high&&e.low<t.low}static compare(e,t){return e.high-t.high||e.low-t.low}static equal(e,t){return e.low===t.low&&e.high===t.high}static min(e,t){return li.less(e,t)?e:t}static max(e,t){return li.less(e,t)?t:e}static random(){return crypto.getRandomValues(Uv),new li(Uv[0],Uv[1])}tryParseString(e,t=10){let{lowDigits:r,lowBase:i,pattern:a}=Fv[t];if(!a.test(e))return!1;if(e.length<=r)return this.low=parseInt(e,t),this.high=0,!0;let o=e.length-r,l=parseInt(e.substr(o),t),c=parseInt(e.substr(0,o),t),d,p;if(i===hd)d=c,p=l;else{let m=Math.imul(c,i)>>>0;d=wE(c,i)+(Math.imul(Math.floor(c/hd),i)>>>0),p=l+m,p>=hd&&(++d,p-=hd)}return p>>>0!==p||d>>>0!==d?!1:(this.low=p,this.high=d,!0)}parseString(e,t=10){if(!this.tryParseString(e,t))throw new Error(`Failed to parse string as uint64 value: ${JSON.stringify(e)}.`);return this}static parseString(e,t=10){return new li().parseString(e,t)}valid(){let{low:e,high:t}=this;return e>>>0===e&&t>>>0===t}toJSON(){return this.toString()}static lshift(e,t,r){let{low:i,high:a}=t;return r===0?(e.low=i,e.high=a):r<32?(e.low=i<<r,e.high=a<<r|i>>>32-r):(e.low=0,e.high=i<<r-32),e}static rshift(e,t,r){let{low:i,high:a}=t;return r===0?(e.low=i,e.high=a):r<32?(e.low=i>>>r|a<<32-r,e.high=a>>>r):(e.low=a>>>r-32,e.high=0),e}static or(e,t,r){return e.low=t.low|r.low,e.high=t.high|r.high,e}static xor(e,t,r){return e.low=t.low^r.low,e.high=t.high^r.high,e}static and(e,t,r){return e.low=t.low&r.low,e.high=t.high&r.high,e}static add(e,t,r){let i=t.low+r.low,a=t.high+r.high,o=i>>>0;return o!==i&&(a+=1),e.low=o,e.high=a>>>0,e}static addUint32(e,t,r){let i=t.low+r,a=t.high,o=i>>>0;return o!==i&&(a+=1),e.low=o,e.high=a>>>0,e}static decrement(e,t){let{low:r,high:i}=t;return r===0&&(i-=1),e.low=r-1>>>0,e.high=i>>>0,e}static increment(e,t){let{low:r,high:i}=t;return r===4294967295&&(i+=1),e.low=r+1>>>0,e.high=i>>>0,e}static subtract(e,t,r){let i=t.low-r.low,a=t.high-r.high,o=i>>>0;return o!==i&&(a-=1),e.low=o,e.high=a>>>0,e}static absDifference(e,t,r){return li.less(t,r)?li.subtract(e,r,t):li.subtract(e,t,r)}static multiplyUint32(e,t,r){let{low:i,high:a}=t;return e.low=Math.imul(i,r)>>>0,e.high=Math.imul(a,r)+wE(i,r)>>>0,e}static lowMask(e,t){return t===0?e.high=e.low=0:t<=32?(e.high=0,e.low=4294967295>>>32-t):(e.high=4294967295>>>t-32,e.low=4294967295),e}toNumber(){return this.low+this.high*4294967296}setFromNumber(e){e=Math.round(e),e<0?this.low=this.high=0:e>=18446744073709552e3?this.low=this.high=4294967295:(this.low=e%4294967296,this.high=Math.floor(e/4294967296))}},X=li;X.ZERO=new li(0,0),X.ONE=new li(1,0);var uc={[H.UINT8]:[0,255],[H.INT8]:[-128,127],[H.UINT16]:[0,65535],[H.INT16]:[-32768,32767],[H.UINT32]:[0,4294967295],[H.INT32]:[-2147483648,2147483647],[H.UINT64]:[X.ZERO,new X(4294967295,4294967295)],[H.FLOAT32]:[0,1]};function Or(n,e){if(typeof e=="number"){let t=n[0],r=n[1];return(e-t)/(r-t)}else{let t=n[0],r=n[1],i;X.compare(e,t)<0?i=-X.subtract(Yr,t,e).toNumber():i=X.subtract(Yr,e,t).toNumber();let a=X.absDifference(Yr,r,t).toNumber();return X.compare(t,r)>0&&(a*=-1),i/a}}function ga(n,e,t){if(typeof n[0]=="number"){let r=n[0],i=n[1],a=r*(1-t)+i*t;if(e!==H.FLOAT32){let o=uc[e];a=Math.round(a),a=Math.max(o[0],a),a=Math.min(o[1],a)}return a}else{let r=n[0],i=n[1];X.compare(r,i)>0&&([r,i]=[i,r],t=1-t);let a=X.subtract(Yr,i,r).toNumber(),o=new X;return t<=0?(Yr.setFromNumber(a*-t),X.subtract(o,r,X.min(Yr,r))):t>=1?(Yr.setFromNumber(a*(t-1)),X.add(o,i,Yr),X.less(o,i)&&(o.low=o.high=4294967295)):(Yr.setFromNumber(a*t),X.add(o,r,Yr),X.less(o,r)&&(o.low=o.high=4294967295)),o}}function Ws(n,e){return typeof e=="number"?Math.min(Math.max(n[0],e),n[1]):X.min(X.max(n[0],e),n[1])}function zs(n,e){return[Ws(n,e[0]),Ws(n,e[1])]}function Gv(n){if(Sr(n[0],n[1])<=0)return n;throw new Error(`Invalid interval: [${n[0]}, ${n[1]}]`)}function TE(n){return Sr(n[0],n[1])<=0?n:[n[1],n[0]]}function Sr(n,e){return typeof n=="number"?n-e:X.compare(n,e)}var Yr=new X,tW=new X;function kE(n,e){return typeof e=="number"?Math.abs(e-n[0])<Math.abs(e-n[1])?0:1:X.less(X.absDifference(Yr,n[0],e),X.absDifference(tW,n[1],e))?0:1}function to(n,e){let t;switch(typeof e!="string"?t=""+e:t=e,n){case H.UINT64:return X.parseString(t);case H.FLOAT32:{let r=parseFloat(t);if(!Number.isFinite(r))throw new Error(`Invalid float32 value: ${JSON.stringify(t)}`);return r}default:{let r=parseInt(t),i=uc[n];if(!Number.isInteger(r)||r<i[0]||r>i[1])throw new Error(`Invalid ${H[n].toLowerCase()} value: ${JSON.stringify(t)}`);return r}}}function md(n,e){return He(new Array(2),n,t=>to(e,t))}function ci(n,e,t){return n===H.UINT64?X.equal(e[0],t[0])&&X.equal(e[1],t[1]):e[0]===t[0]&&e[1]===t[1]}function Wv(n,e,t=uc[e]){if(!ci(e,n,t))return e===H.UINT64?[n[0].toString(),n[1].toString()]:n}function gd(n,e,t){switch(n){case H.FLOAT32:return CE(e,t*Infinity);case H.UINT64:let r=e;return t===-1?r.low===0&&r.high===0?r:X.decrement(new X,r):r.low===4294967295&&r.high===4294967295?r:X.increment(new X,r);default:{let i=uc[n];return Math.max(i[0],Math.min(i[1],e+t))}}}function LE(n,e){switch(n){case H.FLOAT32:return 0;case H.UINT64:return .5/X.absDifference(Yr,e[0],e[1]).toNumber();default:return .5/Math.abs(e[0]-e[1])}}function dc(n,e){switch(n){case H.FLOAT32:return 1;case H.UINT64:{let t=X.absDifference(Yr,e[0],e[1]).toNumber();return t/(t+1)}default:{let t=Math.abs(e[0]-e[1]);return t/(t+1)}}}function no(n=128){let e=Math.ceil(n/32),t=new Uint32Array(e);crypto.getRandomValues(t);let r="";for(let i=0;i<e;++i)r+=("00000000"+t[i].toString(16)).slice(-8);return r}function EE(n){let e=new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t=65536;for(let r=0,i=e.length;r<i;r+=t)crypto.getRandomValues(e.subarray(r,Math.min(i,r+t)));return n}function zv(){let n=new Uint32Array(1);return crypto.getRandomValues(n),n[0]}var PE=!1,pc=class extends j{constructor(e){super();this.id=e;this.changed=new ae}addRef(){return PE&&console.log("INC ref",this),super.addRef()}dispose(){PE&&(console.log("DEC ref",this),this.refCount===1&&console.log("Deleting",this)),super.dispose()}},be;(function(a){a[a.POINT=0]="POINT",a[a.LINE=1]="LINE",a[a.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",a[a.ELLIPSOID=3]="ELLIPSOID",a[a.SPHERE=4]="SPHERE"})(be||(be={}));var Ri=[0,1,2,3,4],$o={rgb:{serializedBytes(){return 3},alignment(){return 1},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, true);dv.setUint8(${e} + 2, ${n} >>> 16);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, true) | (dv.getUint8(${e} + 2) << 16);`},deserializeJson(n){return ud(ha(n))},serializeJson(n){return hn(Za(n))}},rgba:{serializedBytes(){return 4},alignment(){return 1},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, true);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, true);`},deserializeJson(n){return ud(Vv(n))},serializeJson(n){return hn(dd(n))}},float32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setFloat32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getFloat32(${e}, isLittleEndian);`},deserializeJson(n){return zn(n)},serializeJson(n){return n}},uint32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, isLittleEndian);`},deserializeJson(n){return ot(n)},serializeJson(n){return n}},int32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setInt32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt32(${e}, isLittleEndian);`},deserializeJson(n){return ot(n)},serializeJson(n){return n}},uint16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, isLittleEndian);`},deserializeJson(n){return ot(n)},serializeJson(n){return n}},int16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setInt16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt16(${e}, isLittleEndian);`},deserializeJson(n){return ot(n)},serializeJson(n){return n}},uint8:{serializedBytes(){return 1},alignment(){return 1},serializeCode(n,e){return`dv.setUint8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getUint8(${e});`},deserializeJson(n){return ot(n)},serializeJson(n){return n}},int8:{serializedBytes(){return 2},alignment(){return 1},serializeCode(n,e){return`dv.setInt8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getInt8(${e});`},deserializeJson(n){return ot(n)},serializeJson(n){return n}}},nW=255;function Hv(n,e,t){let r=0,i=t.length,a=new Array(i),o=[];for(let y=0;y<i;++y)a[y]=y;let l=y=>$o[t[y].type].alignment(n);a.sort((y,v)=>l(v)-l(y));let c=0,d=new Array(i),p=e,m=()=>{p+=(4-p%4)%4,r+=p,o[c]=p,p=0,++c};for(let y=0;y<i;++y){let v=a[y],b=t[v],x=$o[b.type],C=x.serializedBytes(n),k=x.alignment(n),D=(k-p%k)%k,M=p+D+C;M+(4-M%4)%4<=nW?p+=D:m(),d[v]={offset:p,group:c},p+=C}return m(),{serializedBytes:r,offsets:d,propertyGroupBytes:o}}var oh=class{constructor(e,t,r){this.rank=e;this.firstGroupInitialOffset=t;this.propertySpecs=r;if(r.length===0){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}let{serializedBytes:i,offsets:a,propertyGroupBytes:o}=Hv(e,t,r);this.propertyGroupBytes=o;let l="let groupOffset0 = offset;";for(let m=1;m<o.length;++m)l+=`let groupOffset${m} = groupOffset${m-1} + ${o[m-1]}*annotationCount;`;for(let m=0;m<o.length;++m)l+=`groupOffset${m} += ${o[m]}*annotationIndex;`;let c=l,d=l,p=r.length;for(let m=0;m<p;++m){let{group:y,offset:v}=a[m],b=r[m],x=$o[b.type],C=`properties[${m}]`,k=`groupOffset${y} + ${v}`;c+=x.serializeCode(C,k,e),d+=x.deserializeCode(C,k,e)}this.serializedBytes=i,this.serialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",c),this.deserialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",d)}};function sh(n,e){let t=[];for(let r of Ri){let i=An[r];t[r]=new oh(n,i.serializedBytes(n),e)}return t}function $v(n,e){let t=n.type==="float32"?e.toPrecision(6):e.toString(),{enumValues:r,enumLabels:i}=n;if(r!==void 0){let a=r.indexOf(e);if(a!==-1)return`${i[a]} (${t})`}return t}function DE(n,e){switch(n.type){case"rgb":return hn(Za(e));case"rgba":return hn(dd(e));default:return $v(n,e)}}function rW(n){let e=ee(n);if(e.match(/^[a-z][a-zA-Z0-9_]*$/)===null)throw new Error(`Invalid property identifier: ${JSON.stringify(n)}`);return e}function iW(n){if(ee(n),!Object.prototype.hasOwnProperty.call($o,n))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return n}function aW(n){let e=new Set;for(let t of n){if(e.has(t.identifier))throw new Error(`Duplicate property identifier: ${t.identifier}`);e.add(t.identifier)}}function oW(n){Q(n);let e=G(n,"id",rW),t=G(n,"type",iW),r=le(n,"description",ee),i=le(n,"default",l=>$o[t].deserializeJson(l),0),a,o;switch(t){case"rgb":case"rgba":break;default:{let l=H[t.toUpperCase()];a=le(n,"enum_values",c=>ye(c,d=>to(l,d))),a!==void 0&&(o=G(n,"enum_labels",c=>He(new Array(a.length),c,ee)))}}return{type:t,identifier:e,description:r,default:i,enumValues:a,enumLabels:o}}function sW(n){let e=n.default;return{id:n.identifier,description:n.description,type:n.type,default:e===0?void 0:$o[n.type].serializeJson(e)}}function AE(n){if(!(n===void 0||n.length===0))return n.map(sW)}function lh(n){if(n===void 0)return[];let e=ye(n,oW);return aW(e),e}function jv(n,e,t,r,i){for(let a=0;a<r;++a)n.setFloat32(e,i[a],t),e+=4;return e}function ch(n,e,t,r,i,a){return e=jv(n,e,t,r,i),e=jv(n,e,t,r,a),e}function qv(n,e,t,r,i){for(let a=0;a<r;++a)i[a]=n.getFloat32(e,t),e+=4;return e}function uh(n,e,t,r,i,a){return e=qv(n,e,t,r,i),e=qv(n,e,t,r,a),e}var An={[1]:{icon:"\uA579",description:"Line",toJSON(n){return{pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}},restoreState(n,e,t){n.pointA=G(e,"pointA",r=>He(new Float32Array(t),r,Ye)),n.pointB=G(e,"pointB",r=>He(new Float32Array(t),r,Ye))},serializedBytes(n){return 2*4*n},serialize(n,e,t,r,i){ch(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return uh(n,e,t,r,a,o),{type:1,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[4]:{icon:"\u2296",description:"Sphere",toJSON(n){return{pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}},restoreState(n,e,t){n.pointA=G(e,"pointA",r=>He(new Float32Array(t),r,Ye)),n.pointB=G(e,"pointB",r=>He(new Float32Array(t),r,Ye))},serializedBytes(n){return 2*4*n},serialize(n,e,t,r,i){ch(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return uh(n,e,t,r,a,o),{type:4,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[0]:{icon:"\u26AC",description:"Point",toJSON:n=>({point:Array.from(n.point)}),restoreState:(n,e,t)=>{n.point=G(e,"point",r=>He(new Float32Array(t),r,Ye))},serializedBytes:n=>n*4,serialize:(n,e,t,r,i)=>{jv(n,e,t,r,i.point)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r);return qv(n,e,t,r,a),{type:0,point:a,id:i,properties:[]}},visitGeometry(n,e){e(n.point,!1)}},[2]:{icon:"\u2751",description:"Bounding Box",toJSON:n=>({pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}),restoreState:(n,e,t)=>{n.pointA=G(e,"pointA",r=>He(new Float32Array(t),r,Ye)),n.pointB=G(e,"pointB",r=>He(new Float32Array(t),r,Ye))},serializedBytes:n=>2*4*n,serialize(n,e,t,r,i){ch(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return uh(n,e,t,r,a,o),{type:2,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[3]:{icon:"\u25CE",description:"Ellipsoid",toJSON:n=>({center:Array.from(n.center),radii:Array.from(n.radii)}),restoreState:(n,e,t)=>{n.center=G(e,"center",r=>He(new Float32Array(t),r,Ye)),n.radii=G(e,"radii",r=>He(new Float32Array(t),r,th))},serializedBytes:n=>2*4*n,serialize(n,e,t,r,i){ch(n,e,t,r,i.center,i.radii)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return uh(n,e,t,r,a,o),{type:3,center:a,radii:o,id:i,properties:[]}},visitGeometry(n,e){e(n.center,!1),e(n.radii,!0)}}};function dh(n,e){let t=An[n.type].toJSON(n,e.rank);t.type=be[n.type].toLowerCase(),t.id=n.id,t.description=n.description||void 0;let{relatedSegments:r}=n;if(r!==void 0&&r.some(i=>i.length!==0)&&(t.segments=r.map(i=>i.map(a=>a.toString()))),e.properties.length!==0){let i=e.properties;t.props=n.properties.map((a,o)=>$o[i[o].type].serializeJson(a))}return t}function lW(n,e,t=!1){Q(n);let r=G(n,"type",c=>Mt(c,be)),i=G(n,"id",t?Ft:ee)||ph(),a=G(n,"segments",c=>{if(c===void 0)return e.relationships.map(()=>[]);let d=Kr(c);return d.length===0?e.relationships.map(()=>[]):e.relationships.length===1&&!Array.isArray(d[0])?[ye(d,p=>X.parseString(p))]:ye(Kr(c,e.relationships.length),p=>ye(p,m=>X.parseString(m)))}),o=G(n,"props",c=>{let d=e.properties;return c===void 0?d.map(p=>p.default):ye(Kr(c,e.properties.length),(p,m)=>$o[d[m].type].deserializeJson(p))}),l={id:i,description:G(n,"description",Ft),relatedSegments:a,properties:o,type:r};return An[r].restoreState(l,n,e.rank),l}var ro=class extends j{constructor(e,t=[],r=[]){super();this.relationships=t;this.properties=r;this.annotationMap=new Map;this.changed=new ae;this.readonly=!1;this.childAdded=new Me;this.childUpdated=new Me;this.childDeleted=new Me;this.childRefreshed=new ae;this.pending=new Set;this.references=new Map;this.rank_=e,this.annotationPropertySerializers=sh(e,r)}get rank(){return this.rank_}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),!e.id)e.id=ph();else if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${JSON.stringify(e.id)}.`);return this.annotationMap.set(e.id,e),this.changed.dispatch(),this.childAdded.dispatch(e),t||this.pending.add(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();let t=e.id;this.pending.delete(t),this.changed.dispatch()}update(e,t){if(this.ensureUpdated(),e.value===null)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Symbol.iterator](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){e.value!==null&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return t!==void 0?t.addRef():(t=new pc(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();let e=[],{pending:t}=this;for(let r of this)t.has(r.id)||e.push(dh(r,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();let{annotationMap:t}=this;t.clear(),this.pending.clear(),e!==void 0&&ye(e,r=>{let i=lW(r,this);t.set(i.id,i)});for(let r of this.references.values()){let{id:i}=r,a=t.get(i);r.value=a||null,r.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}},Jv=class extends ro{constructor(e,t,r){super(e.value.sourceRank,r,t);this.watchableTransform=e;this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated()))}get rank(){return this.ensureUpdated(),this.rank_}ensureUpdated(){let e=this.watchableTransform.value,{curCoordinateTransform:t}=this;if(e===t)return;this.curCoordinateTransform=e;let r=e.sourceRank,i=t.sourceRank;if(i===r&&(t.inputSpace===e.inputSpace||we(t.inputSpace.ids.slice(0,r),e.inputSpace.ids.slice(0,r))))return;let{ids:a}=e.inputSpace,o=t.inputSpace.ids,l=[];for(let d=0;d<r;++d){let p=o.indexOf(a[d]);p>=i&&(p=-1),l.push(p)}let c=d=>{let p=new Float32Array(r);for(let m=0;m<r;++m){let y=l[m];p[m]=y===-1?0:d[m]}return p};for(let d of this.annotationMap.values())switch(d.type){case 0:d.point=c(d.point);break;case 1:case 4:case 2:d.pointA=c(d.pointA),d.pointB=c(d.pointB);break;case 3:d.center=c(d.center),d.radii=c(d.radii);break}this.rank_!==r&&(this.rank_=r,this.annotationPropertySerializers=sh(this.rank_,this.properties)),this.changed.dispatch()}},cW="Data Bounds";function ph(){return no(160)}function uW(n){return{type:2,id:"data-bounds",description:cW,pointA:new Float32Array(n.lowerBounds),pointB:new Float32Array(n.upperBounds),properties:[]}}function In(n){let e=new ro(n.lowerBounds.length);return e.readonly=!0,e.add(uW(n)),e}function dW(n,e){let t=0,r=[];for(let d of Ri){let m=e[d].serializedBytes;r[d]=t;let v=n[d].length;t+=m*v}let i=[],a=[],o=new ArrayBuffer(t),l=new DataView(o),c=ma===mn.LITTLE;for(let d of Ri){let p=e[d],{rank:m}=p,y=p.serialize,v=n[d];i[d]=v.map(D=>D.id),a[d]=new Map(v.map((D,P)=>[D.id,P]));let x=An[d].serialize,C=r[d],k=p.propertyGroupBytes[0];for(let D=0,P=v.length;D<P;++D){let M=v[D];x(l,C+D*k,c,m,M),y(l,C,D,P,c,M.properties)}}return{data:new Uint8Array(o),typeToIds:i,typeToOffset:r,typeToIdMaps:a}}var Kv=class{constructor(e){this.propertySerializers=e;this.annotations=[[],[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return dW(this.annotations,this.propertySerializers)}};function yd(n){if(n==null)return n;let{relatedSegments:e}=n;if(e!==void 0)for(let t=0,r=e.length;t<r;++t){let i=e[t];i!==void 0&&(e[t]=i.map(a=>new X(a.low,a.high)))}return n}function Ge(n){let e=-1;return Object.assign(()=>{e===-1&&(e=requestAnimationFrame(()=>{e=-1,n()}))},{flush:()=>{e!==-1&&(e=-1,n())},cancel:()=>{e!==-1&&(cancelAnimationFrame(e),e=-1)}})}var fh=class{constructor(){this.map=new Map}get(e,t){let{map:r}=this,i=r.get(e);return i===void 0?(i=t(),i.registerDisposer(()=>{r.delete(e)}),r.set(e,i)):i.addRef(),i}},vd=class extends fh{get(e,t){return typeof e!="string"&&(e=Hn(e)),super.get(e,t)}getUncounted(e,t){return this.get(e,()=>new rd(t())).value}};var pW=!1;function IE(n){let e={antialias:!1,stencil:!0};pW&&(console.log("DEBUGGING via preserveDrawingBuffer"),e.preserveDrawingBuffer=!0);let t=n.getContext("webgl2",e);if(t==null)throw new Error("WebGL not supported.");t.memoize=new fh,t.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t.max3dTextureSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.maxTextureImageUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.tempTextureUnit=t.maxTextureImageUnits-1;for(let r of["EXT_color_buffer_float"])if(!t.getExtension(r))throw new Error(`${r} extension not available`);for(let r of["EXT_float_blend"])t.getExtension(r);return t}var fc=class{constructor(){this.width=0;this.height=0;this.logicalWidth=0;this.logicalHeight=0;this.visibleLeftFraction=0;this.visibleTopFraction=0;this.visibleWidthFraction=0;this.visibleHeightFraction=0}};function hh(n,e){let t=1/n.visibleWidthFraction,r=1/n.visibleHeightFraction,i=-1-(-1+2*n.visibleLeftFraction)*t,a=-1-(-1+2*n.visibleTopFraction)*r;a=-a,e[0]=e[0]*t+e[3]*i,e[4]=e[4]*t+e[7]*i,e[8]=e[8]*t+e[11]*i,e[12]=e[12]*t+e[15]*i,e[1]=e[1]*r+e[3]*a,e[5]=e[5]*r+e[7]*a,e[9]=e[9]*r+e[11]*a,e[13]=e[13]*r+e[15]*a}function mh(n,e){return n.width===e.width&&n.height===e.height&&n.logicalWidth===e.logicalWidth&&n.logicalHeight===e.logicalHeight&&n.visibleLeftFraction===e.visibleLeftFraction&&n.visibleTopFraction===e.visibleTopFraction}var gh=class extends j{constructor(e,t,r){super();this.context=e;this.element=t;this.visibility=r;this.boundsGeneration=-1;this.canvasRelativeClippedLeft=0;this.canvasRelativeClippedTop=0;this.canvasRelativeLogicalLeft=0;this.canvasRelativeLogicalTop=0;this.renderViewport=new fc;this.boundsObserversRegistered=!1;this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){let{context:e}=this;e.ensureBoundsUpdated();let{boundsGeneration:t}=e;if(t===this.boundsGeneration)return;this.boundsGeneration=t;let{element:r}=this;!this.boundsObserversRegistered&&e.monitorPanel(r)&&(this.boundsObserversRegistered=!0);let i=r.getBoundingClientRect(),a=e.container,o=e.canvasRect,{canvas:l}=e,{width:c,height:d}=l,p=c/o.width,m=d/o.height,y=o.left,v=o.top,b=this.canvasRelativeLogicalLeft=Math.round((i.left-y)*p+r.clientLeft),x=this.canvasRelativeLogicalTop=Math.round((i.top-v)*m+r.clientTop),C=r.clientWidth,k=r.clientHeight,D=b+C,P=x+k,M=x,I=b,E=D,_=P;for(let V=r.parentElement;V!==null&&V!==a;V=V.parentElement){let U=V.getBoundingClientRect();U.x===0&&U.y===0&&U.width===0&&U.height===0||(I=Math.max(I,(U.left-y)*p),M=Math.max(M,(U.top-v)*m),E=Math.min(E,(U.right-y)*p),_=Math.min(_,(U.bottom-v)*m))}M=this.canvasRelativeClippedTop=Math.round(Math.max(M,0)),I=this.canvasRelativeClippedLeft=Math.round(Math.max(I,0)),E=Math.round(Math.min(E,c)),_=Math.round(Math.min(_,d));let O=this.renderViewport,B=O.width=Math.max(0,E-I),W=O.height=Math.max(0,_-M);O.logicalWidth=C,O.logicalHeight=k,O.visibleLeftFraction=(I-b)/C,O.visibleTopFraction=(M-x)/k,O.visibleWidthFraction=B/C,O.visibleHeightFraction=W/k}setGLClippedViewport(){let{gl:e,canvasRelativeClippedTop:t,canvasRelativeClippedLeft:r,renderViewport:{width:i,height:a}}=this,o=t+a;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let l=this.context.canvas.height-o;e.viewport(r,l,i,a),e.scissor(r,l,i,a)}setGLLogicalViewport(){let{gl:e,renderViewport:{width:t,height:r,logicalWidth:i,logicalHeight:a}}=this,o=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,o-(this.canvasRelativeLogicalTop+a),i,a),e.scissor(this.canvasRelativeClippedLeft,o-(this.canvasRelativeClippedTop+r),t,r)}disposed(){this.boundsObserversRegistered&&this.context.unmonitorPanel(this.element),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;let{element:e}=this;return!(e.clientWidth===0||e.clientHeight===0||e.offsetWidth===0||e.offsetHeight===0)}get drawOrder(){return 0}},yh=class extends gh{constructor(e,t,r){super(e,t,r);this.canvas=document.createElement("canvas");this.canvasRenderingContext=this.canvas.getContext("2d");let{canvas:i}=this;t.appendChild(i),t.style.position="relative",i.style.position="absolute",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0"}draw(){this.drawIndirect();let{renderViewport:e,canvas:t}=this,{logicalWidth:r,logicalHeight:i}=e;t.width=r,t.height=i;let{canvasRenderingContext:a}=this;a==null||a.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,r,i,0,0,r,i)}},Yv=class extends ht{constructor(){super(Float64Array.of(0,0,1,1),e=>He(new Float64Array(4),e,ah))}toJSON(){let{value:e}=this,[t,r,i,a]=e;if(!(t===0&&r==0&&i===1&&a===1))return Array.from(e)}},Xv=class extends j{constructor(e){super();this.container=e;this.canvas=document.createElement("canvas");this.updateStarted=new ae;this.updateFinished=new ae;this.changed=this.updateFinished;this.panels=new Set;this.resizeGeneration=0;this.boundsGeneration=-1;this.orderedPanels=[];this.frameNumber=0;this.panelAncestors=new Map;this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()};this.resizeObserver=new ResizeObserver(this.resizeCallback);this.scheduleRedraw=this.registerCancellable(Ge(()=>this.draw()));let{canvas:t,resizeObserver:r}=this;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",r.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",i=>{console.log(`Lost WebGL context: ${i.statusMessage}`),i.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=IE(t)}monitorPanel(e){let{panelAncestors:t,container:r}=this;if(!r.contains(e))return!1;for(;e!==r;){let i=t.get(e);if(i!==void 0){++i.count;break}let a=e.parentElement;i={parent:a,count:1},t.set(e,i),e.addEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.observe(e),e=a}return!0}unmonitorPanel(e){let{panelAncestors:t,container:r}=this;for(;e!==r;){let i=t.get(e);if(i.count!==1){--i.count;break}e.removeEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.unobserve(e),t.delete(e),e=i.parent}}applyWindowedViewportToElement(e,t){let[r,i,a,o]=t,l=1/a,c=1/o;e.style.position="absolute",e.style.top=`${-c*i*100}%`,e.style.left=`${-l*r*100}%`,e.style.width=`${l*100}%`,e.style.height=`${c*100}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(let e of this.panels)if(!!e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){let e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){let{resizeGeneration:e}=this;if(this.boundsGeneration===e)return;let{canvas:t}=this;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl;this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);let{orderedPanels:t,panels:r}=this;t.length!==r.size&&(t.push(...r),t.sort((i,a)=>i.drawOrder-a.drawOrder));for(let i of t){if(!i.shouldDraw)continue;i.ensureBoundsUpdated();let{renderViewport:a}=i;a.width===0||a.height===0||i.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch()}getDepthArray(){let{width:e,height:t}=this.canvas,r=new Float32Array(e*t);for(let i of this.panels){if(!i.shouldDraw)continue;let a=i.getDepthArray();if(a===void 0)continue;let{canvasRelativeClippedTop:o,canvasRelativeClippedLeft:l,renderViewport:{width:c,height:d}}=i;for(let p=0;p<d;++p){let m=(d-1-p)*c;r.set(a.subarray(m,m+c),(o+p)*c+l)}}return r}};function vh(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]+t[i];return n}function Sh(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]-t[i];return n}function ME(n,e,t,r){let i=n.length;for(let a=0;a<i;++a)n[a]=e[a]+t[a]*r;return n}function RE(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]*t;return n}function hc(n){let e=1;for(let t=0,r=n.length;t<r;++t)e*=n[t];return e}function _E(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=Math.min(e[i],t[i]);return n}var io=new Float32Array(0),Qv=new Float64Array(0),yK=Float64Array.of(1,1,1);var Sd=class extends fc{constructor(){super(...arguments);this.globalPosition=io;this.projectionMat=re.create();this.viewMatrix=re.create();this.invViewMatrix=re.create();this.viewProjectionMat=re.create();this.invViewProjectionMat=re.create()}};function VE(n,e){return n.displayDimensionRenderInfo===e.displayDimensionRenderInfo&&mh(n,e)&&we(n.globalPosition,e.globalPosition)&&we(n.projectionMat,e.projectionMat)&&we(n.viewMatrix,e.viewMatrix)}function bh(n){let{viewMatrix:e,viewProjectionMat:t}=n;re.invert(e,n.invViewMatrix),re.multiply(t,n.projectionMat,e),re.invert(n.invViewProjectionMat,t)}function Hs(n,e,t,r,i,a,o,l,c){for(let d=0;d<o;++d)for(let p=0;p<c;++p){let m=0;for(let y=0;y<l;++y)m+=t[d+r*y]*i[y+a*p];n[d+e*p]=m}return n}function fW(n,e,t){for(let r=0;r<t;++r){let i=e*r;n.fill(0,i,i+t),n[i+r]=1}return n}function rr(n,e,t=e){return fW(new n(e*t),e,Math.min(e,t))}function Zv(n,e,t=!0){let r=e.length,i=t?r+1:r,a=new n(i*(r+1));t&&(a[a.length-1]=1);for(let o=0;o<r;++o)a[(i+1)*o]=e[o];return a}function OE(n,e,t){for(let r=0;r<t;++r)for(let i=0;i<t;++i)if(n[r*e+i]!=(r===i?1:0))return!1;return!0}function xh(n,e,t,r,i,a){for(let o=0;o<a;++o){let l=o*r,c=o*e;for(let d=0;d<i;++d)n[c+d]=t[l+d]}return n}function bd(n,e,t,r){xh(n,e+1,t,r+1,r,r);for(let i=0;i<r;++i)n[(e+1)*e+i]=t[(r+1)*r+i];n[n.length-1]=1;for(let i=r;i<e;++i)n[(e+1)*i+i]=1;return n}var ui;function hW(n,e,t){let r=1;(ui===void 0||ui.length<t)&&(ui=new Uint32Array(t));for(let i=0;i<t;++i)ui[i]=i;for(let i=0;i<t;++i){let a=e*i,o=i;{let d=Math.abs(n[a+i]);for(let p=i+1;p<t;++p){let m=Math.abs(n[a+p]);m>d&&(d=m,o=p)}}if(i!==o){r*=-1;for(let d=0;d<t;++d){let p=e*d,m=n[p+i];n[p+i]=n[p+o],n[p+o]=m}{let d=ui[i];ui[i]=ui[o],ui[o]=d}}let l=n[a+i],c=1/l;r*=l;for(let d=0;d<t;++d)n[e*d+i]*=c;n[a+i]=c;for(let d=0;d<t;++d){if(d===i)continue;let p=-n[e*i+d];for(let m=0;m<t;++m){let y=e*m;n[y+d]+=p*n[y+i]}n[e*i+d]=p*c}}for(let i=0;i<t;++i){let a=ui[i];for(;a!==i;){let o=e*i,l=e*a;for(let d=0;d<t;++d){let p=o+d,m=l+d,y=n[p];n[p]=n[m],n[m]=y}let c=ui[i]=ui[a];ui[a]=a,a=c}}return r}function mc(n,e,t,r,i){return xh(n,e,t,r,i,i),hW(n,e,i)}function NE(n,e,t,r,i,a){for(let o=0;o<a;++o){let l=e*o,c=r*o;for(let d=0;d<i;++d)if(n[l+d]!==t[c+d])return!1}return!0}function Xr(n,e,t,r,i){for(let a=0;a<i;++a){let o=e[t*i+a];for(let l=0;l<i;++l)o+=e[t*l+a]*r[l];n[a]=o}return n}function Ch(n,e,t,r,i){for(let a=0;a<i;++a){let o=0;for(let l=0;l<i;++l)o+=e[t*l+a]*r[l];n[a]=o}return n}var wh=[{prefix:"Y",exponent:24},{prefix:"Z",exponent:21},{prefix:"E",exponent:18},{prefix:"P",exponent:15},{prefix:"T",exponent:12},{prefix:"G",exponent:9},{prefix:"M",exponent:6},{prefix:"k",exponent:3},{prefix:"",exponent:0},{prefix:"m",exponent:-3},{prefix:"\xB5",exponent:-6},{prefix:"n",exponent:-9},{prefix:"p",exponent:-12},{prefix:"f",exponent:-15},{prefix:"a",exponent:-18},{prefix:"z",exponent:-21},{prefix:"y",exponent:-24}],mW=[{prefix:"c",exponent:-2},{prefix:"u",exponent:-6},...wh],gc=new Map;gc.set("",{unit:"",exponent:0});var gW=new Map;for(let{prefix:n,exponent:e}of mW){gW.set(e,n);for(let t of["m","s","Hz","rad/s"])gc.set(`${n}${t}`,{unit:t,exponent:e})}function eS(n){let e=Math.log10(n),t=wh.length,r=_k(0,t,i=>wh[i].exponent<=e);return wh[Math.min(r,t-1)]}function tS(n,e,t={}){let{precision:r=6,elide1:i=!0}=t,a=n,o="";if(e!==""){let c=eS(n);o=c.prefix,a=xd(n,-c.exponent)}if(i&&a===1)return{scale:"",unit:e,prefix:o};let l;if(r!=0){a<1||a>=1e3?l=a.toPrecision(r):l=a.toFixed(r);let c=l.indexOf("e"),d,p;c!==-1?(d=l.substring(0,c),p=l.substring(c)):(d=l,p="");let m=d.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);m!==null&&(d=d.substring(0,d.length-m[1].length),d.endsWith(".")&&(d=d.substring(0,d.length-1)),l=d+p)}else l=a.toString();return{scale:l,unit:e,prefix:o}}function _i(n,e,t){let{scale:r,unit:i,prefix:a}=tS(n,e,t);return`${r}${a}${i}`}function jo(n){if(n==="")return{scale:1,unit:""};let e=n.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([µa-zA-Z]+)?$/);if(e===null)return;let t=e[1],r=t===void 0?1:Number(t);if(Number.isNaN(r))return;let i="";if(e[2]!==void 0){let a=gc.get(e[2]);if(a===void 0)return;i=a.unit,a.exponent>0?r*=10**a.exponent:r/=10**-a.exponent}if(!(r<=0||!Number.isFinite(r)))return{scale:r,unit:i}}function Th(n){let e=gc.get(n);if(e===void 0)throw new Error(`Invalid unit: ${JSON.stringify(n)}`);return e}function xd(n,e){return e>=0?n*10**e:n/10**-e}var yW=0;function $s(){return++yW}function vW(n,e){return we(n.lowerBounds,e.lowerBounds)&&we(n.upperBounds,e.upperBounds)}function SW(n,e){return n===void 0?e===void 0:e===void 0?!1:n.explicit===e.explicit&&we(n.coordinates,e.coordinates)&&we(n.labels,e.labels)}function bW(n,e){let t=new Map;for(let r=0,i=n.length;r<i;++r)t.set(n[r],e[r]);return n=Array.from(t.keys()),n.sort((r,i)=>r-i),e=Array.from(n,r=>t.get(r)),{coordinates:n,labels:e}}function BE(n){if(n.length===1)return n[0];let e=new Map,t=!1;for(let a of n){a.explicit&&(t=!0);let{coordinates:o,labels:l}=a;for(let c=0,d=o.length;c<d;++c)e.set(o[c],l[c])}let r=Array.from(e.keys());r.sort((a,o)=>a-o);let i=Array.from(r,a=>e.get(a));return{explicit:t,coordinates:r,labels:i}}function UE(n){if(n=n.filter(e=>e!==void 0),n.length!==0)return BE(n)}function xW(n,e){return we(n.transform,e.transform)&&vW(n.box,e.box)}function kh(n,e){return n.valid===e.valid&&n.rank===e.rank&&we(n.names,e.names)&&we(n.ids,e.ids)&&we(n.timestamps,e.timestamps)&&we(n.units,e.units)&&we(n.scales,e.scales)&&td(n.boundingBoxes,e.boundingBoxes,xW)&&td(n.coordinateArrays,e.coordinateArrays,SW)}function Ne(n){let{names:e,units:t,scales:r}=n,{valid:i=!0,rank:a=e.length,timestamps:o=e.map(()=>Number.NEGATIVE_INFINITY),ids:l=e.map((m,y)=>-y),boundingBoxes:c=[]}=n,{coordinateArrays:d=new Array(a)}=n,{bounds:p=wW(c,a)}=n;return{valid:i,rank:a,names:e,timestamps:o,ids:l,units:t,scales:r,boundingBoxes:c,bounds:p,coordinateArrays:d}}var Qr=Ne({valid:!1,names:[],units:[],scales:Qv,boundingBoxes:[]}),Vi=Ne({valid:!0,names:[],units:[],scales:Qv,boundingBoxes:[]});function CW(n){let[e,t]=Kr(n,2),r=St(e),i=ee(t),a=gc.get(i);if(a===void 0)throw new Error(`Invalid unit: ${JSON.stringify(i)}`);return{unit:a.unit,scale:xd(r,a.exponent)}}function Cd(n,e=!1){if(n===void 0)return Qr;Q(n);let t=Td(Object.keys(n),e),r=t.length,i=new Array(r),a=new Float64Array(r),o=new Array(r);for(let l=0;l<r;++l)G(n,t[l],c=>{if(Array.isArray(c)){let{unit:d,scale:p}=CW(c);i[l]=d,a[l]=p}else{Q(c);let d=G(c,"coordinates",bE),p=G(c,"labels",jt),m=d.length;if(m!==p.length)throw new Error(`Length of coordinates array (${m}) does not match length of labels array (${p.length})`);i[l]="",a[l]=1,o[l]={explicit:!0,...bW(d,p)}}});return Ne({valid:!1,names:t,units:i,scales:a,coordinateArrays:o})}function nS(n){let{rank:e}=n;if(e===0)return;let{names:t,units:r,scales:i,coordinateArrays:a}=n,o={};for(let l=0;l<e;++l){let c=t[l],d=a[l];(d==null?void 0:d.explicit)?o[c]={coordinates:Array.from(d.coordinates),labels:d.labels}:o[c]=[i[l],r[l]]}return o}var js=class extends Re{constructor(){super(Qr)}toJSON(){return nS(this.value)}reset(){this.value=Qr}restoreState(e){this.value=Cd(e)}};function rS(n,e){let t=(n+e)/2;return Number.isFinite(t)||(t=Math.min(Math.max(0,n),e)),t}function FE(n,e){let{lowerBounds:t,upperBounds:r}=e,i=n.length;for(let a=0;a<i;++a)n[a]=rS(t[a],r[a]);return n}function Mn(n){let e=n.lowerBounds.length;return{box:n,transform:rr(Float64Array,e,e+1)}}function iS(n,e,t){let{box:{lowerBounds:r,upperBounds:i},transform:a}=n,o=r.length,l=t,c=a[l*o+e],d=c,p=c,m=!1;for(let y=0;y<o;++y){let v=a[l*y+e];if(v===0)continue;let b=v*r[y],x=v*i[y];d+=Math.min(b,x),p+=Math.max(b,x),m=!0}if(!!m)return{lower:d,upper:p}}function wW(n,e){let t=new Float64Array(e),r=new Float64Array(e);t.fill(Number.NEGATIVE_INFINITY),r.fill(Number.POSITIVE_INFINITY);for(let i of n)for(let a=0;a<e;++a){let o=iS(i,a,e);if(o===void 0)continue;let{lower:l,upper:c}=o;t[a]=t[a]===Number.NEGATIVE_INFINITY?l:Math.min(t[a],l),r[a]=r[a]===Number.POSITIVE_INFINITY?c:Math.max(r[a],c)}return{lowerBounds:t,upperBounds:r}}function TW(n,e,t){let{transform:r,box:i}=n,a=t.length,o=i.lowerBounds.length,l=new Float64Array((o+1)*e);for(let c=0;c<a;++c){let d=t[c];if(d!==-1)for(let p=0;p<=o;++p)l[p*e+d]=r[p*a+c]}return{transform:l,box:i}}function aS(n,e){let t={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},r=new Float64Array(2*n);return r[e]=1,{transform:r,box:t}}function oS(n,e,t){if(e===t)return n;let{box:r}=n,i=r.lowerBounds.length,a=new Float64Array((i+1)*t);return xh(a,t,n.transform,e,e,i+1),{box:r,transform:a}}function GE(n,e){let{rank:t,sourceRank:r}=n;if(t!==e.rank||r!==e.sourceRank)return!1;let{inputSpace:i}=n,{inputSpace:a}=e;return!we(a.scales,i.scales)||!we(a.units,i.units)||!we(e.outputSpace.names,n.outputSpace.names)?!1:$E(n.transform,t,n.outputSpace.scales,e.transform,t,e.outputSpace.scales)}function mt(n){return{rank:n.rank,sourceRank:n.rank,inputSpace:n,outputSpace:n,transform:rr(Float64Array,n.rank+1)}}function kW(n,e,t,r){let{transform:i,box:a}=n,o=n.box.lowerBounds.length,l=r.length,c=new Float64Array((o+1)*l);for(let d=0;d<l;++d){let p=r[d];for(let y=0;y<o;++y){let v=0;for(let b=0;b<l;++b){let x=t[b];v+=e[(l+1)*b+d]*i[l*y+b]*(x/p)}c[l*y+d]=v}let m=e[(l+1)*l+d];for(let y=0;y<l;++y){let v=t[y];m+=e[(l+1)*y+d]*i[l*o+y]*(v/p)}c[o*l+d]=m}return{transform:c,box:a}}function WE(n,e,t){return n.boundingBoxes.map(r=>kW(r,e,n.scales,t))}function sS(n,e,t){let r=Ne({valid:n.valid,rank:t.rank,ids:t.ids,names:t.names,timestamps:t.timestamps,scales:t.scales,units:t.units,boundingBoxes:WE(n,e,t.scales),coordinateArrays:t.coordinateArrays});return kh(r,t)?t:r}function lS(n,e=!1){if(e){let t=Number(n);if(Number.isInteger(t)&&t>=0)return!0}return n.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)!==null}function yc(n,e=!1){let t=new Set;for(let r of n){if(!lS(r,e)||t.has(r))return!1;t.add(r)}return!0}function wd(n){let e=n.length,t=new Array(e);t.fill(!0);for(let r=0;r<e;++r){let i=n[r];if(!lS(i)){t[r]=!1;continue}let a=n.indexOf(i,r+1);a!==-1&&(t[r]=!1,t[a]=!1)}return t}function qo(n){return n.endsWith("'")}function cS(n){return n.endsWith("'")||n.endsWith("^")}function zE(n){return n.endsWith("^")}function HE(n){return!cS(n)}function LW(n,e,t){let r=new Float64Array(n),i=e.length,a=(i+1)*i;for(let o=0;o<i;++o)r[a+o]*=e[o]/t[o];return r}function $E(n,e,t,r,i,a){if(!NE(n,e+1,r,i+1,e,e))return!1;for(let o=0;o<e;++o){let l=n[(e+1)*e+o],c=r[(i+1)*i+o];if(l*(t[o]/a[o])!==c)return!1}for(let o=e;o<i;++o)if(r[(i+1)*i+o]!==0)return!1;for(let o=e;o<i;++o){for(let l=0;l<e;++l)if(r[(i+1)*l+o]!==0)return!1;for(let l=0;l<i;++l){let c=r[(i+1)*o+l];if(o===l){if(c!==1)return!1}else if(c!==0)return!1}}return!0}function EW(n,e){if(!e.includes(n))return n;let[,t,r]=n.match(/^([^']*)('?)$/);for(let i=0;;++i){let a=`${t}${i}${r}`;if(!e.includes(a))return a}}function PW(n,e){let{inputSpace:t,transform:r}=n,{ids:i,rank:a}=t,{rank:o,names:l,units:c,scales:d}=e,p=new Array(a);p.fill(!0);let m=[],y=e.ids.map((q,ne)=>{let pe=i.indexOf(q);return pe!==-1?p[pe]=!1:m.push(ne),pe}),{outputSpace:v}=n,{names:b,units:x,scales:C,ids:k,timestamps:D,coordinateArrays:P}=v,M=p,I=[],E=[],_=new Float64Array(o),O=[],B=[],W=new Array(o),V=0,U=new Float64Array((o+1)**2);U[U.length-1]=1;for(let q=0;q<a;++q)if(!M[q]){I[V]=b[q],O[V]=k[q],E[V]=x[q],_[V]=C[q],B[V]=D[q],W[V]=P[q];for(let ne=0;ne<o;++ne){let pe=y[ne];pe!==-1&&(U[ne*(o+1)+V]=r[pe*(a+1)+q])}U[o*(o+1)+V]=r[a*(a+1)+q],++V}for(let q of m)O[V]=$s(),I[V]=EW(l[q],I),_[V]=d[q],E[V]=c[q],U[q*(o+1)+V]=1,++V;let N=Ne({valid:e.valid,rank:o,names:I,ids:O,timestamps:B,units:E,scales:_,boundingBoxes:WE(e,U,_),coordinateArrays:W});return{rank:o,sourceRank:n.sourceRank,inputSpace:e,outputSpace:N,transform:U}}function jE(n){let e=sS(n.inputSpace,n.transform,n.outputSpace);return e===n.outputSpace?n:{rank:n.rank,sourceRank:n.sourceRank,inputSpace:n.inputSpace,transform:n.transform,outputSpace:e}}var Lh=class{constructor(e,t=!1){this.mutableSourceRank=t;this.value_=void 0;this.changed=new ae;this.inputSpaceChanged=new ae;this.defaultTransform=jE(e);let r=this;this.outputSpace={changed:r.changed,get value(){return r.value.outputSpace},set value(i){let{value:a}=r;if(kh(a.outputSpace,i)||a.rank!==i.rank)return;let o=LW(a.transform,a.outputSpace.scales,i.scales);r.value_={sourceRank:a.sourceRank,rank:a.rank,inputSpace:a.inputSpace,outputSpace:sS(a.inputSpace,o,i),transform:o},r.changed.dispatch()}},this.inputSpace={changed:r.inputSpaceChanged,get value(){return r.value.inputSpace},set value(i){let{value:a}=r;kh(a.inputSpace,i)||(r.value_=PW(a,i),r.inputSpaceChanged.dispatch(),r.changed.dispatch())}}}set value(e){let t=this.value;e!==t&&(this.value_=jE(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let{value_:e}=this;return e===void 0&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){let{value:e}=this,{rank:t,transform:r,inputSpace:i,outputSpace:a,sourceRank:o}=e,{defaultTransform:l,mutableSourceRank:c}=this,{inputSpace:d,rank:p,transform:m,outputSpace:y}=l,{units:v,scales:b}=i,x=o===t&&we(b,c?a.scales:d.scales)&&we(v,c?a.units:d.units),C=$E(m,p,y.scales,r,t,a.scales),k=we(y.names,a.names);if(!(C&&k&&x))return{sourceRank:o,transform:C?void 0:r,outputSpace:e.outputSpace,inputSpace:x?void 0:i}}set transform(e){let{value:t}=this,{inputSpace:r}=t;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:r,transform:e,outputSpace:sS(r,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(e===void 0){this.reset();return}if(this.mutableSourceRank){let V=e.inputSpace||e.outputSpace,U=V.rank,N=Ne({rank:U,names:V.names.map((q,ne)=>`${ne}`),units:V.units,scales:V.scales,coordinateArrays:V.coordinateArrays});this.value={rank:U,transform:e.transform||rr(Float64Array,U+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:N};return}let{inputSpace:t,sourceRank:r,outputSpace:i,transform:a,rank:o}=this.defaultTransform,{inputSpace:l,sourceRank:c,outputSpace:d,transform:p}=e,m=e.outputSpace.rank,y=t.names,v=l!==void 0?l.names:y,b=new Array(r);for(let V=0;V<r;++V){let U=v.indexOf(y[V]);U>=c&&(U=-1),b[V]=U}let x=m-c+r;for(let V=c;V<m;++V)b[r+V-c]=V;let C=new Float64Array(x),k=new Array(x),D=[];for(let V=0;V<r;++V){let U=b[V];U===-1||l===void 0?(C[V]=t.scales[V],D[V]=t.units[V],k[V]=t.coordinateArrays[V]):(C[V]=l.scales[U],D[V]=l.units[U],k[V]=UE([t.coordinateArrays[V],l.coordinateArrays[U]]))}let P=l||d,M=y.slice(0,r),I=i.names.slice(0,r),E=i.coordinateArrays.slice(0,r),_=new Float64Array(x),O=[];for(let V=0;V<x;++V){let U=b[V];U===-1?(_[V]=i.scales[V],O[V]=i.units[V],E[V]=i.coordinateArrays[V]):(I[V]=d.names[U],O[V]=d.units[U],_[V]=d.scales[U],E[V]=d.coordinateArrays[U])}if(!yc(I)){this.reset();return}for(let V=r;V<x;++V){let U=V-r+c;C[V]=P.scales[U],D[V]=P.units[U],M[V]=`${V}`}let B=new Float64Array((x+1)**2);B[B.length-1]=1;for(let V=0;V<x;++V){let U=b[V],N;U===-1||p===void 0?V>=r?N=0:N=a[o*(o+1)+V]*(i.scales[V]/_[V]):N=p[m*(m+1)+U],B[x*(x+1)+V]=N;for(let q=0;q<x;++q){let ne=b[q],pe;U===-1!=(ne===-1)?pe=0:U===-1||p===void 0?U>=r||ne>=r?pe=U===ne?1:0:pe=a[q*(o+1)+V]:pe=p[ne*(m+1)+U],B[q*(x+1)+V]=pe}}let W=t.boundingBoxes.map(V=>oS(V,o,x));for(let V=r;V<x;++V)W.push(aS(x,V));for(let V=0;V<x;++V){if(B[x*(x+1)+V]!==0)continue;let N;for(let ne=0;ne<x;++ne){let pe=B[ne*(x+1)+V];if(pe!==0)if(pe===1)if(N===void 0)N=ne;else{N=null;break}else{N=null;break}}if(N==null)continue;let q=k[N];q!==void 0&&(q.explicit&&(q={...q,explicit:!1}),E[V]=UE([q,E[V]]))}this.value={rank:x,transform:B,sourceRank:r,outputSpace:Ne({rank:x,names:I,scales:_,units:O,coordinateArrays:E}),inputSpace:Ne({rank:x,names:M,scales:C,units:D,coordinateArrays:k,boundingBoxes:W})}}toJSON(){return dS(this.spec)}restoreState(e){this.spec=uS(e)}};function DW(n,e=!1){let t=ee(n);if(!lS(t,e))throw new Error(`Invalid dimension name: ${JSON.stringify(t)}`);return t}function Td(n,e=!1){let t=ye(n,r=>DW(r,e));if(!yc(t,e))throw new Error(`Invalid dimensions: ${JSON.stringify(t)}`);return t}var vc=class{constructor(e,t){this.combined=e;this.bindings=new Set;this.retainCount=0;this.prevCombined=this.combined.value;this.dimensionRefCounts=new Map;this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()};this.includeDimensionPredicate_=t}getRenameValidity(e){let t=this.combined.value.names,r=wd(e),i=e.length;for(let a=0;a<i;++a){if(!r[a])continue;let o=e[a];if(t.includes(o))continue;let l=!0;for(let c of this.bindings)if(c.space.value.names.includes(o)){l=!1;break}r[a]=l}return r}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){let{combined:e,bindings:t}=this,r=this.retainCount>0?1:0;if(t.size===0&&!r){e.value=Qr;return}let i=this.includeDimensionPredicate_,a=e.value,o=Array.from(a.names),l=Array.from(a.units),c=Array.from(a.scales),d=Array.from(a.ids),p=Array.from(a.timestamps),m=a.names.map(()=>r?1:0),y=[],v=!1;for(let I of t){let{space:{value:E},prevValue:_,mappedDimensionIds:O}=I;v=v||E.valid;let{names:B,units:W,scales:V,ids:U,timestamps:N}=E,q=[],ne=[];y.push(ne),I.mappedDimensionIds=q,I.prevValue=E;let pe=B.length;for(let me=0;me<pe;++me){let Pe=B[me];if(!i(Pe))continue;if(_!==void 0){let Ae=U[me],Be=_.ids.indexOf(Ae);if(Be!==-1){let Ze=O[Be];if(Ze!==void 0){let ge=d.indexOf(Ze);if(ge!==-1){q[me]=Ze,++m[ge],ne[me]=ge;let Le=N[me];Le!==void 0&&!(Le<=p[ge])&&(o[ge]=Pe,c[ge]=V[me],l[ge]=W[me],p[ge]=Le);continue}}}}let se=o.indexOf(Pe);if(se!==-1){q[me]=d[se],++m[se],ne[me]=se;continue}se=o.length,ne[me]=se,m[se]=1+r,o[se]=Pe,l[se]=W[me],c[se]=V[me],p[se]=N[me];let Te=$s();d[se]=Te,q[me]=Te}}let{dimensionRefCounts:b}=this;b.clear();let x=0,C=o.length;for(let I of t){let{space:{value:E}}=I,_=y[x++],{rank:O}=E,B=Array.from(E.names),W=Array.from(E.timestamps),V=Float64Array.from(E.scales),U=Array.from(E.units);for(let N=0;N<O;++N){let q=_[N];q!==void 0&&(U[N]=l[q],V[N]=c[q],W[N]=p[q],B[N]=o[q])}for(let N of B){let q=b.get(N);q===void 0?q=1:++q,b.set(N,q)}if(!we(U,E.units)||!we(V,E.scales)||!we(B,E.names)||!we(W,E.timestamps)){let N=Ne({valid:E.valid,ids:E.ids,scales:V,units:U,names:B,timestamps:W,boundingBoxes:E.boundingBoxes,coordinateArrays:E.coordinateArrays});I.prevValue=N,I.space.value=N}}{for(let E=0;E<C;++E)i(o[E])||(m[E]=0);let I=(E,_)=>m[_]!==0;o=o.filter(I),l=l.filter(I),c=c.filter(I),d=d.filter(I),p=p.filter(I),m=m.filter(I),C=o.length}let k=[],D=new Array(C);for(let I=0,E=a.rank;I<E;++I){let _=a.coordinateArrays[I];if(!(_==null?void 0:_.explicit))continue;let O=d.indexOf(a.ids[I]);O!==-1&&(D[O]=[_])}for(let I of t){let{space:{value:E}}=I,{rank:_,boundingBoxes:O,coordinateArrays:B}=E,W=E.names.map(V=>o.indexOf(V));for(let V of O)k.push(TW(V,C,W));for(let V=0;V<_;++V){let U=B[V];if(U===void 0)continue;let N=W[V],q=D[N];q===void 0?D[N]=[U]:q.push(U)}}let P=new Array(C);for(let I=0;I<C;++I){let E=D[I];E!==void 0&&(P[I]=BE(E))}let M=Ne({valid:v,ids:d,names:o,units:l,scales:new Float64Array(c),boundingBoxes:k,coordinateArrays:P});if(r)for(let I=0;I<C;++I)--m[I];kh(a,M)||(this.prevCombined=M,e.value=M)}retain(){return++this.retainCount,()=>{--this.retainCount==0&&this.update()}}bind(e){let t={space:e,mappedDimensionIds:[],prevValue:void 0},{bindings:r}=this;r.size===0&&this.combined.changed.add(this.handleCombinedChanged),r.add(t);let i=e.changed.add(()=>{e.value!==t.prevValue&&this.update()}),a=()=>{i();let{bindings:o}=this;o.delete(t),o.size===0&&this.combined.changed.remove(this.handleCombinedChanged),this.update()};return this.update(),a}};function Eh(n,e,t,r,i){let a=i.length,o=new n((a+1)**2);o[o.length-1]=1;for(let l=0;l<a;++l){let c=r[l];o[(a+1)*a+l]=e[(t+1)*t+c];for(let d=0;d<a;++d){let p=i[d];o[(a+1)*d+l]=e[(t+1)*p+c]}}return o}function qE(n){if(n===void 0)return;let e=new Float64Array(16);if(Array.isArray(n))if(n.length===16)for(let t=0;t<4;++t)for(let r=0;r<4;++r)e[t*4+r]=Ye(n[r*4+t]);else{Kr(n,4);for(let t=0;t<4;++t){let r=Kr(n[t],4);for(let i=0;i<4;++i)e[i*4+t]=Ye(r[i])}}else{Q(n);let t=qe.create(),r=J.create(),i=J.fromValues(1,1,1);le(n,"rotation",o=>{Wo(t,o),qe.normalize(t,t)}),le(n,"translation",o=>{Wo(r,o)}),le(n,"scale",o=>{Wo(i,o)});let a=re.create();re.fromRotationTranslationScale(a,t,r,i),e.set(a)}return{sourceRank:3,transform:e,outputSpace:Ne({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function uS(n){if(n===void 0)return;let e=Q(n),t=G(e,"outputDimensions",Cd),r=t.rank,i=G(e,"sourceRank",l=>{if(l===void 0)return r;if(!Number.isInteger(l)||l<0||l>r)throw new Error(`Expected integer in range [0, ${r}] but received: ${JSON.stringify(l)}`);return l}),a=le(e,"inputDimensions",l=>{let c=Cd(l,!0);if(c.rank!==r)throw new Error(`Expected rank of ${r}, but received rank of: ${c.rank}`);return c});return{transform:le(e,"matrix",l=>{let c=new Float64Array((r+1)**2),d=Kr(l,r);c[c.length-1]=1;for(let p=0;p<r;++p)try{let m=Kr(d[p],r+1);for(let y=0;y<=r;++y)c[(r+1)*y+p]=Ye(m[y])}catch(m){throw new Error(`Error in row ${p}: ${m.message}`)}return c}),outputSpace:t,inputSpace:a,sourceRank:i}}function dS(n){if(n===void 0)return;let{transform:e,outputSpace:t,inputSpace:r,sourceRank:i}=n,a,o=t.rank;if(e!==void 0){a=[];for(let l=0;l<o;++l){let c=[];a[l]=c;for(let d=0;d<=o;++d)c[d]=e[(o+1)*d+l]}}return{sourceRank:i===o?void 0:i,matrix:a,outputDimensions:nS(t),inputDimensions:r===void 0?void 0:nS(r)}}function AW(n,e,t){let{box:r,transform:i}=n,a=n.box.lowerBounds.length,o=e.length,l=new Float64Array((a+1)*o);for(let c=0;c<o;++c)for(let d=0;d<=a;++d){let p=e[c];l[c+d*o]=i[p+d*t]}if(!l.every(c=>c===0))return{transform:l,box:r}}function Ph(n,e){let{ids:t,names:r,scales:i,units:a,timestamps:o,coordinateArrays:l}=n;return Ne({rank:e.length,valid:n.valid,ids:e.map(c=>t[c]),names:e.map(c=>r[c]),timestamps:e.map(c=>o[c]),scales:Float64Array.from(e,c=>i[c]),units:e.map(c=>a[c]),coordinateArrays:e.map(c=>l[c]),boundingBoxes:n.boundingBoxes.map(c=>AW(c,e,n.rank)).filter(c=>c!==void 0)})}function Dh(n,e,t){return e===t?n:Ph(n,Ok(n.rank,t,e))}function pS(n,e){let{transform:t,rank:r}=n,i=Gs(t,r,[e]);if(i.length!==1)return;let[a]=i,o=Math.abs(t[(r+1)*a+e]),{inputSpace:l}=n;return{scale:l.scales[a]*o,unit:l.units[a]}}function fS(n,e){let{scales:t,units:r}=n.defaultInputSpace;return e<t.length?{scale:t[e],unit:r[e]}:void 0}var QK={channelCoordinateSpace:Vi,shape:new Uint32Array(0),numChannels:1,coordinates:new Uint32Array(0)};function JE(n){let{rank:e}=n,{bounds:{lowerBounds:t,upperBounds:r}}=n;if(t.some(l=>l!==0))throw new Error("Lower bounds of channel coordinate space must all be 0");if(r.some(l=>!Number.isInteger(l)||l<=0||l>=2**32))throw new Error("Upper bounds of channel coordinate space must all be positive integers");let i=new Uint32Array(r),a=hc(i),o=new Uint32Array(a*e);for(let l=0;l<a;++l){let c=l;for(let d=0;d<e;++d){let p=c%i[d];c=(c-p)/i[d],o[l*e+d]=p}}return{channelCoordinateSpace:n,shape:i,numChannels:a,coordinates:o}}function hS(n,e,t,r,i,a){let{scales:o}=t,{scales:l,rank:c}=i,d=e+1;for(let p=0;p<c;++p){let m=a[p];if(m===-1)continue;let y=l[p];for(let v=0;v<e;++v){let b=r[v],x=o[b];n[d*v+m]*=x/y}}}function IW(n,e,t,r,i=Vi){let{inputSpace:a,rank:o,sourceRank:l,outputSpace:c,transform:d}=t,{names:p}=a,{names:m}=c,y;if(r!==void 0)y=Array.from(r.modelSubspaceDimensionIndices);else{y=[];for(let W=0;W<l;++W)y[W]=W}let v=y.length;for(let W=l;W<o;++W)y.push(W);let b=Gs(t.transform,o,y,!0),x=y.length,C=y.map(W=>p[W]||`${W}`),k=b.map(W=>m[W]);if(x!==b.length)return{error:"Rank mismatch between model subspace dimensions ("+C.join(", ")+") and corresponding layer/global dimensions ("+k.join(", ")+")"};let D=Eh(Float32Array,d,o,b,y),P=b.map(W=>m[W]),M=e.names.map(W=>P.indexOf(W)),I=n.names.map(W=>P.indexOf(W));hS(D,x,a,y,n,I),hS(D,x,a,y,e,M);let E=i.names.map(W=>P.indexOf(W));hS(D,x,a,y,i,E);let _=[],O=i.rank;if(r!==void 0){let{subsourceToModelSubspaceTransform:W}=r;v!==x&&(W=bd(new Float32Array((x+1)**2),x,W,v)),D=Hs(new Float32Array((x+1)**2),x+1,D,x+1,W,x+1,x+1,x+1,x+1)}let B=new Uint32Array(O);for(let W=0;W<O;++W){let V=i.bounds.lowerBounds[W],U=i.bounds.upperBounds[W];if(V!==0||!Number.isInteger(U)||U<=0||U>=2**32)return{error:`Channel dimension ${i.names[W]} must have lower bound of 0 and positive integer upper bound`};B[W]=U;let N=E[W],q=-1;if(N!==-1)for(let ne=0;ne<x;++ne){let pe=D[N+ne*(x+1)];if(pe!==0){if(pe!==1||q!==-1)return{error:`Channel dimension ${k[N]} must map to a single source dimension`};q=ne}}_[W]=q}return{rank:x,unpaddedRank:v,modelDimensionNames:C,layerDimensionNames:k,localToRenderLayerDimensions:M,globalToRenderLayerDimensions:I,channelToRenderLayerDimensions:E,modelToRenderLayerTransform:D,channelToModelDimensions:_,channelSpaceShape:B}}function MW(n,e){return n===e?!0:n.error!==void 0||e.error!==void 0?!1:we(n.modelDimensionNames,e.modelDimensionNames)&&we(n.layerDimensionNames,e.layerDimensionNames)&&we(n.globalToRenderLayerDimensions,e.globalToRenderLayerDimensions)&&we(n.localToRenderLayerDimensions,e.localToRenderLayerDimensions)&&we(n.channelToRenderLayerDimensions,e.channelToRenderLayerDimensions)&&we(n.modelToRenderLayerTransform,e.modelToRenderLayerTransform)&&we(n.channelSpaceShape,e.channelSpaceShape)}function Ah(n,e,t,r,i){return Qt((a,o,l,c)=>IW(a,o,l,r,c),[n,e,t,i===void 0?qr(void 0):i],MW)}function KE(n,e,t,r){let{globalToRenderLayerDimensions:i}=t;for(let a=0;a<3;++a){let o=0,l=r[a];if(l!==-1){let c=i[l];c!==-1&&(o=e[c])}n[a]=o}}function YE(n,e,t,r){let{globalToRenderLayerDimensions:i}=t;for(let a=0;a<3;++a){let o=r[a];if(o!==-1){let l=i[o];l!==-1&&(n[l]=e[a])}}}function Sc(n,e){let t=n.rank,r=n.unpaddedRank,i;r!==t&&e!==void 0&&(e=bd(new Float32Array((t+1)**2),t,e,r)),e!==void 0?(i=new Float32Array((t+1)*(t+1)),Hs(i,t+1,n.modelToRenderLayerTransform,t+1,e,t+1,t+1,t+1,t+1)):i=n.modelToRenderLayerTransform;let a=new Float32Array((t+1)*(t+1)),o=mc(a,t+1,i,t+1,t+1);if(o===0)throw new Error("Transform is singular");let{globalToRenderLayerDimensions:l,localToRenderLayerDimensions:c,channelToRenderLayerDimensions:d}=n,p=l.length,m=c.length,y=p+m,v=new Float32Array((y+1)*t);for(let I=0;I<t;++I){for(let E=0;E<p;++E){let _=l[E];_!==-1&&(v[I+E*t]=a[I+_*(t+1)])}for(let E=0;E<m;++E){let _=c[E];_!==-1&&(v[I+(p+E)*t]=a[I+_*(t+1)])}v[I+y*t]=a[I+t*(t+1)]}let b=d.length,x=new Array(b),C=[];for(let I=0;I<b;++I){let E=d[I],_=-1;if(E!==-1){for(let O=0;O<t;++O){let B=i[E+O*(t+1)];if(B!==0){if(B!==1||_!==-1)throw new Error(`Channel dimension ${n.layerDimensionNames[E]} must map with stride 1 to a single data chunk dimensions`);_=O}}if(_!==-1){if(i[E+t*(t+1)]!==0)throw new Error(`Channel dimension ${n.layerDimensionNames[E]} must have an offset of 0 in the chunk coordinate space`);C.push(_)}}x[I]=_}let{channelSpaceShape:k}=n,D=hc(k),P=C.length,M=new Uint32Array(D*P);for(let I=0;I<D;++I){let E=I,_=0;for(let O=0;O<b;++O){let B=E%k[O];E=(E-B)/k[O],x[O]!==-1&&(M[I*P+_]=B,++_)}}return{layerRank:t,modelTransform:n,chunkToLayerTransform:i,layerToChunkTransform:a,chunkToLayerTransformDet:o,combinedGlobalLocalRank:y,combinedGlobalLocalToChunkTransform:v,channelToChunkDimensionIndices:x,chunkChannelDimensionIndices:C,numChannels:D,chunkChannelCoordinates:M,channelSpaceShape:k}}function Ih(n,e){let{globalToRenderLayerDimensions:t}=n,r=[],i=[];for(let a=0;a<3;++a){let o=e[a];if(o==-1)continue;let l=t[o];i.push(l),l!==-1&&r.push(l)}for(let a=i.length;a<3;++a)i[a]=-1;return{layerDisplayDimensionIndices:r,displayToLayerDimensionIndices:i}}function Mh(n,e){let{chunkToLayerTransform:t,modelTransform:r}=n,i=r.rank,{layerDisplayDimensionIndices:a,displayToLayerDimensionIndices:o}=e,l=a.length,c=Gs(t,i,a);if(c.length!==l){let{modelDimensionNames:m,layerDimensionNames:y}=r;throw new Error(`Rank mismatch between displayed layer dimensions (${Array.from(a,v=>y[v]).join(",\xA0")}) and corresponding chunk dimensions (${Array.from(c,v=>m[v]).join(",\xA0")})`)}let d=re.create();for(let m=0;m<3;++m){let y=o[m];if(y!==-1){for(let v=0;v<l;++v){let b=c[v];d[v*4+m]=t[b*(i+1)+y]}d[12+m]=t[i*(i+1)+y]}}let p=re.create();re.invert(p,d);for(let m=c.length;m<3;++m)c[m]=-1;return{modelTransform:n.modelTransform,chunkTransform:n,displaySubspaceModelMatrix:d,displaySubspaceInvModelMatrix:p,chunkDisplayDimensionIndices:c,numChunkDisplayDims:l}}function ao(n,e,t,r,i){let a=e.length,o=t.length,l=n.length,c=!0;for(let d=0;d<r;++d){let p=d,m=0;for(let y=0;y<a;++y)m+=i[p+y*r]*e[y];p+=a*r;for(let y=0;y<o;++y)m+=i[p+y*r]*t[y];m+=i[p+o*r],d<l?n[d]=m:(m<0||m>=1)&&(c=!1)}return c}function XE(n,e,t){n.fill(0),n[15]=1;let r=!0,{displayDimensionIndices:i}=e,{globalToRenderLayerDimensions:a,modelToRenderLayerTransform:o}=t,l=t.rank;for(let c=0;c<3;++c){let d=i[c];if(d===-1){r=!1;continue}let p=a[d];if(p===-1){r=!1;continue}n[c+12]=o[p+l*(l+1)];for(let m=0;m<3;++m)n[c+4*m]=o[p+(l+1)*m]}if(!r){let{globalDimensionNames:c}=e,d=Array.from(i.filter(p=>p!==-1),p=>c[p]).join(",\xA0");throw new Error(`Transform from model dimensions (${t.modelDimensionNames.join(",\xA0")}) to display dimensions (${d}) does not have full rank`)}}var qs=class{constructor(e,t,r){this.size=J.clone(e),this.transform=re.clone(t),this.finiteRank=r;let i=re.create(),a=mc(i,4,t,4,4);if(a===0)throw new Error("Transform is singular");this.invTransform=i,this.detTransform=a}toObject(){return{size:this.size,transform:this.transform,finiteRank:this.finiteRank}}static fromObject(e){return new qs(e.size,e.transform,e.finiteRank)}globalToLocalSpatial(e,t){return J.transformMat4(e,t,this.invTransform)}localSpatialVectorToGlobal(e,t){return aE(e,t,this.transform)}globalToLocalNormal(e,t){return Kf(e,t,this.transform)}};var QE=class{constructor(){this.name="CancellationError";this.message="CANCELED"}toString(){return"CANCELED"}},ir=new QE;function ZE(n){if(n.isCanceled===!0)throw ir}var mS=()=>{},Je={isCanceled:!1,add:()=>mS,remove:mS},$n=class{cancel(){let{handlers:e}=this;if(e!==null&&(this.handlers=null,e!==void 0))for(let t of e)t()}get isCanceled(){return this.handlers===null}add(e){let{handlers:t}=this;return t===null?(e(),mS):(t===void 0&&(t=this.handlers=new Set),t.add(e),()=>{this.remove(e)})}remove(e){let{handlers:t}=this;t!=null&&t.delete(e)}},gS=class extends $n{constructor(){super(...arguments);this.consumers=new Set}addConsumer(e=Je){let{consumers:t}=this;t.has(e)||e.isCanceled||(t.add(e),e.add(()=>{t.delete(e),t.size===0&&this.cancel()}))}};function eP(n,e){return new Promise((t,r)=>{if(n===Je){e(t,r,Je);return}let i=new $n,a=n.add(()=>{i.cancel()});e(o=>{a(),t(o)},o=>{a(),r(o)},i)})}var Rh=!(typeof Window!="undefined"&&self instanceof Window),tP=!1,nP=!1,yS="rpc.promise.response",rP="rpc.promise.cancel",iP=new Map;function bt(n,e){iP.set(n,e)}var aP=class extends Error{constructor(e,t){super(t);this.name=e;this.message=t}};function _h(n,e){bt(n,function(t){let r=t.id,i=new $n,a=e.call(this,t,i);this.set(r,{promise:a,cancellationToken:i}),a.then(({value:o,transfers:l})=>{this.delete(r),this.invoke(yS,{id:r,value:o},l)},o=>{this.delete(r),this.invoke(yS,{id:r,error:o.message,errorName:o.name})})})}bt(rP,function(n){let e=n.id,t=this.get(e);if(t!==void 0){let{cancellationToken:r}=t;r.cancel()}});bt(yS,function(n){let e=n.id,{resolve:t,reject:r}=this.get(e);this.delete(e),n.hasOwnProperty("value")?t(n.value):n.errorName===ir.name?r(ir):r(new aP(n.errorName,n.error))});var RW=Rh?-1:0,vS=class{constructor(e){this.target=e;this.objects=new Map;this.nextId=RW;e.onmessage=t=>{let r=t.data;nP&&console.log("Received message",r),iP.get(r.functionName).call(this,r)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}getOptionalRef(e){if(e===void 0)return;let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}invoke(e,t,r){t.functionName=e,nP&&console.trace("Sending message",t),this.target.postMessage(t,r)}promiseInvoke(e,t,r=Je,i){return eP(r,(a,o,l)=>{let c=t.id=this.newId();this.set(c,{resolve:a,reject:o}),this.invoke(e,t,i),l.add(()=>{this.invoke(rP,{id:c})})})}newId(){return Rh?this.nextId--:this.nextId++}},gn=class extends j{constructor(){super(...arguments);this.rpc=null;this.rpcId=null}initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){this.isOwner===!0?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():this.isOwner===!1?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){tP&&console.log(`[${Rh}] #rpc object = ${this.rpc.numObjects}`);let{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,this.refCount===0&&e===this.referencedGeneration&&this.ownerDispose()}};function _W(n,e,t={}){e!=null&&n.initializeSharedObject(e,t.id)}var oo=class extends gn{constructor(e,t={}){super();_W(this,e,t)}};bt("SharedObject.dispose",function(n){let e=this.get(n.id);if(e.refCount!==0)throw new Error("Attempted to dispose object with non-zero reference count.");tP&&console.log(`[${Rh}] #rpc objects: ${this.numObjects}`),e.disposed(),this.delete(e.rpcId),e.rpcId=null,e.rpc=null});var VW="Worker";bt(VW,function(n){let{port:e,path:t}=n;new Worker(t).postMessage({port:e},[e])});bt("SharedObject.refCountReachedZero",function(n){let e=this.get(n.id),t=n.gen;e.counterpartRefCountReachedZero(t)});var oP=new Map;function yn(n){return e=>{e.prototype.RPC_TYPE_ID=n}}function Jo(n){return e=>{if(n!==void 0)e.prototype.RPC_TYPE_ID=n;else if(n=e.prototype.RPC_TYPE_ID,n===void 0)throw new Error("RPC_TYPE_ID should have already been defined");oP.set(n,e)}}bt("SharedObject.new",function(n){let e=this,t=n.type,r=oP.get(t),i=new r(e,n);--i.refCount});var Vh=!1,OW=!1,NW=re.create();function BW(n,e){let t=0,r=Math.abs(n.detTransform),{transform:i,size:a}=n;for(let o=0;o<3;++o){let l=0;for(let d=0;d<3;++d)l+=e[d*4+2]*i[4*o+d];let c=a[o];t+=Math.abs(l)*c,r*=c}return r/t}function sP(n,e,t){let{curPositionInChunks:r,fixedPositionWithinChunk:i}=n,{nonDisplayLowerClipBound:a,nonDisplayUpperClipBound:o}=n,{rank:l,chunkDataSize:c}=n.source.spec;if(!ao(r,e,t,n.layerRank,n.fixedLayerToChunkTransform))return!1;for(let d=0;d<l;++d){let p=r[d];if(p<a[d]||p>=o[d])return Vh&&console.log("excluding source",n,`because of chunkDim=${d}, sum=${p}`,a,o,n.fixedLayerToChunkTransform),!1;let m=c[d],y=r[d]=Math.floor(p/m);i[d]=p-y*m}return!0}function UW(n,e){let t=e.length,r=0;if(Vh&&console.log(e),t>1){let i=0;for(let a=0;a<t;++a){let o=e[a],{chunkLayout:l}=o,c=BW(l,n);Vh&&console.log(`chunksize = ${l.size}, sliceArea = ${c}`),c>i&&(i=c,r=a)}}return r}var bc=new qs(J.create(),re.create(),0),SS=class extends Sd{constructor(){super(...arguments);this.viewportNormalInGlobalCoordinates=J.create();this.viewportNormalInCanonicalCoordinates=J.create();this.centerDataPosition=J.create();this.pixelSize=0}};function FW(n,e){if(n.displayDimensionRenderInfo!==e.displayDimensionRenderInfo||n.pixelSize!==e.pixelSize)return!0;let{viewMatrix:t}=n,{viewMatrix:r}=e;for(let i=0;i<12;++i)if(t[i]!==r[i])return!0;return!1}var bS=class extends gn{constructor(e){super();this.projectionParameters=e;this.visibleLayers=new Map;this.visibleSourcesStale=!0;this.registerDisposer(e.changed.add((t,r)=>{FW(t,r)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;let e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(let[r,{allSources:i,visibleSources:a,displayDimensionRenderInfo:o}]of t){if(a.length=0,o!==e||i.length===0)continue;let l=UW(this.projectionParameters.value.viewMatrix,i.map(d=>d[0])),c=i[l];for(let d of r.filterVisibleSources(this,c))a.push(d);a.reverse(),Vh&&console.log("visible sources chosen",a)}}},GW=18;function kd(n){let{rank:e,upperVoxelBound:t,maxVoxelsPerChunkLog2:r=GW,chunkToViewTransform:i,displayRank:a,minBlockSize:o,maxBlockSize:l}=n,{lowerVoxelBound:c=new Uint32Array(e)}=n,d=new Float32Array(e);for(let v=0;v<e;++v){let b=0;for(let x=0;x<a;++x){let C=i[v*a+x];b+=C*C}d[v]=Math.sqrt(b)}let p=new Uint32Array(e);o!==void 0?p.set(o):p.fill(1);let m=new Array(e);for(let v=0;v<e;++v){let b=Number.POSITIVE_INFINITY;d[v]===0?b=p[v]:(t!==void 0&&(b=Math.pow(2,Math.floor(Math.log2(t[v]-c[v])))),l!==void 0&&(b=Math.min(b,l[v]))),m[v]=b}function y(){let v=Infinity,b=-1;for(let x=0;x<e;++x){if(p[x]>=m[x])continue;let C=p[x]*d[x];C<v&&(v=C,b=x)}return b}r-=Math.log2(hc(p));for(let v=0;v<r;++v){let b=y();if(b===-1)break;p[b]*=2}return p}function WW(n){let e=[],{displayRank:t,chunkToViewTransform:r,rank:i}=n;if(t>3)throw new Error("Unsupported view transform");if(t<3)return[kd(n)];for(let a=0;a<3;++a){let o=(a+2)%3,l=new Float32Array(r);for(let c=0;c<i;++c)l[c*t+o]=0;e[a]=kd({...n,chunkToViewTransform:l})}return e}var Js;(function(t){t[t.ISOTROPIC=0]="ISOTROPIC",t[t.FLAT=1]="FLAT"})(Js||(Js={}));function lP(n){if(n.chunkDataSizes!==void 0)return n.chunkDataSizes;let{chunkLayoutPreference:e=0}=n;switch(e){case 0:return[kd(n)];case 1:return WW(n)}}function di(n){let{rank:e,chunkDataSize:t,upperVoxelBound:r}=n,{lowerVoxelBound:i=new Float32Array(e)}=n,a=new Float32Array(e),o=new Float32Array(e);for(let l=0;l<e;++l)a[l]=Math.floor(i[l]/t[l]),o[l]=Math.floor((r[l]-1)/t[l]+1);return{rank:e,chunkDataSize:t,lowerChunkBound:a,upperChunkBound:o,lowerVoxelBound:i,upperVoxelBound:r}}function*cP(n,e,t){let r=n.projectionParameters.value.pixelSize*1.1,i=t[0].effectiveVoxelSize,a=e.renderScaleTarget.value,o=p=>{let m=r*a;for(let y=0;y<3;++y){let v=p[y];if(v>m&&v>1.01*i[y])return!0}return!1},l=(p,m)=>{let y=r*a;for(let v=0;v<3;++v){let b=p[v],x=m[v];if(Math.abs(y-b)<Math.abs(y-x)&&b<1.01*x)return!0}return!1},c=t.length-1,d;for(;;){let p=t[c];if(d!==void 0&&!l(p.effectiveVoxelSize,d)||(yield p,c===0||!o(p.effectiveVoxelSize)))break;d=p.effectiveVoxelSize,--c}}var uP="SliceView",dP="sliceview/RenderLayer",pP="SliceView.addVisibleLayer",fP="SliceView.removeVisibleLayer",xS=new Float32Array(3),CS=new Float32Array(3),hP=re.create(),mP=new Float32Array(24);function gP(n,e,t,r){let i=xS,a=CS,{lowerChunkDisplayBound:o,upperChunkDisplayBound:l}=e;for(let m=0;m<3;++m)i[m]=Math.max(i[m],o[m]),a[m]=Math.min(a[m],l[m]);let{curPositionInChunks:c,chunkDisplayDimensionIndices:d}=e;function p(){if(!r(i[0],i[1],i[2],a[0],a[1],a[2],n))return;let m=0,y=Math.max(0,a[0]-i[0]),v=y;for(let k=1;k<3;++k){let D=Math.max(0,a[k]-i[k]);v*=D,D>y&&(y=D,m=k)}if(v===0)return;if(v===1){c[d[0]]=i[0],c[d[1]]=i[1],c[d[2]]=i[2],t(i,n);return}let b=i[m],x=a[m],C=Math.floor(.5*(b+x));a[m]=C,p(),a[m]=x,i[m]=C,p(),i[m]=b}p()}function Oh(n,e,t,r){if(!sP(t,n.globalPosition,e))return;let{size:i}=t.chunkLayout,a=re.multiply(hP,n.viewProjectionMat,t.chunkLayout.transform);for(let d=0;d<3;++d){let p=i[d];for(let m=0;m<4;++m)a[4*d+m]*=p}let o=mP;Fs(o,a);let l=xS,c=CS;l.fill(Number.NEGATIVE_INFINITY),c.fill(Number.POSITIVE_INFINITY),gP(o,t,r,Xf)}function yP(n,e,t,r,i){if(!sP(t,n.globalPosition,e))return;let{size:a}=r,o=re.multiply(hP,n.viewProjectionMat,r.transform);for(let y=0;y<3;++y){let v=a[y];for(let b=0;b<4;++b)o[4*y+b]*=v}let l=NW;re.invert(l,o);let c=xS,d=CS,p=.001;for(let y=0;y<3;++y){let v=l[12+y]+p/a[y],b=Math.abs(l[y]),x=Math.abs(l[4+y]);c[y]=Math.floor(v-b-x),d[y]=Math.floor(v+b+x+1)}let m=mP;for(let y=0;y<3;++y){let v=o[4*y],b=o[4*y+1],x=o[4*y+2];m[y]=v,m[4+y]=-v,m[8+y]=+b,m[12+y]=-b,m[16+y]=+x,m[20+y]=-x}{let y=3,v=o[4*y],b=o[4*y+1],x=o[4*y+2];m[y]=1+v,m[4+y]=1-v,m[8+y]=1+b,m[12+y]=1-b,m[16+y]=x,m[20+y]=-x}OW&&(console.log("clippingPlanes",m),console.log("modelViewProjection",o.join(",")),console.log(`lower=${c.join(",")}, upper=${d.join(",")}`)),gP(m,t,i,oE)}function xc(n,e){let{finiteRank:t}=e;if(t===3)return e;bc.finiteRank=t,J.copy(bc.size,e.size);let r=re.copy(bc.transform,e.transform),i=re.copy(bc.invTransform,e.invTransform);bc.detTransform=e.detTransform;let{invViewMatrix:a,width:o,height:l}=n,c=Qf(n.projectionMat);for(let d=t;d<3;++d){let p=a[12+d],m=p,y=p,v=Math.abs(a[d]*o);m-=v,y+=v;let b=Math.abs(a[d+4]*l);m-=b,y+=b;let x=Math.abs(a[d+8]*c);m-=x,y+=x;let C=Math.max(1,y-m);r[12+d]=m,r[5*d]=C}return re.invert(i,r),bc}var vP="annotation.MetadataChunkSource",SP="annotation.GeometryChunkSource",bP="annotation.SubsetGeometryChunkSource",xP="annotation.reference.add",CP="annotation.reference.delete",wP="annotation.commit",TP="annotation.commit",kP="annotation/SpatiallyIndexedRenderLayer",LP="annotation/PerspectiveRenderLayer:updateSources",EP="annotation/RenderLayer",PP="annotation/RenderLayer.updateSegmentation",zW=Et.create();function DP(n,e,t,r,i,a){let{displayDimensionRenderInfo:o,viewMatrix:l,projectionMat:c,width:d,height:p}=n,{voxelPhysicalScales:m}=o,y=Math.abs(Et.determinant(Us(zW,l))),v=cd(m),b=sE(c)/y*v;if(r.length===0)return;let x=r[0],C=Math.abs(x.chunkLayout.detTransform)*v,{lowerClipDisplayBound:k,upperClipDisplayBound:D}=x;for(let O=0;O<3;++O)C*=D[O]-k[O];let P=Math.min(C,b),M=d*p,E=M/t**2/P,_=0;for(let O=r.length-1;O>=0&&_<E;--O){let B=r[O],W=B.source.spec,{chunkLayout:V}=B,U=cd(V.size)*Math.abs(V.detTransform)*v,{limit:N,rank:q}=W,{nonDisplayLowerClipBound:ne,nonDisplayUpperClipBound:pe}=B,me=1;for(let Le=0;Le<q;++Le){let We=pe[Le]-ne[Le];Number.isFinite(We)&&(me/=We)}let Pe=N*me/U,se=!0,Te=_+Pe,Ae=Math.pow(1/Te,1/3),Be=Math.sqrt(M/(Te*P)),Ze=(E-_)*U/me,ge=Math.min(1,Ze/W.limit);Oh(n,e,B,()=>{se&&(i(B,O),se=!1),a(B,O,ge,Ae,Be)}),_=Te}}var Oi=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;var AP=Symbol("objectId"),HW=0;function ct(n){if(n instanceof Object){let e=n[AP];return e===void 0&&(e=n[AP]=HW++),`o${e}`}else return""+JSON.stringify(n)}var wS=!1,TS;(function(t){t[t.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",t[t.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"})(TS||(TS={}));function $W(n){n=n.replace("\0","");let e=[];for(let t of n.split(`
`)){let r=t.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);r!==null?e.push({message:r[3].trim(),file:parseInt(r[1],10),line:parseInt(r[2],10)}):(r=t.match(/^ERROR:\s*(.+)$/),r!==null?e.push({message:r[1]}):(t=t.trim(),t&&e.push({message:t})))}return e}var IP=class extends Error{constructor(e,t,r,i){let a=`Error compiling ${TS[e].toLowerCase()} shader: ${r}`;super(a);this.name="ShaderCompilationError",this.log=r,this.message=a,this.shaderType=e,this.source=t,this.errorMessages=i}},MP=class extends Error{constructor(e,t,r){let i=`Error linking shader: ${r}`;super(i);this.name="ShaderLinkError",this.log=r,this.message=i,this.vertexSource=e,this.fragmentSource=t}};function RP(n,e,t){var r=n.createShader(t);if(n.shaderSource(r,e),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){let i=n.getShaderInfoLog(r)||"";if(wS){let a=e.replace("<","&lt;").replace(">","&gt;").split(`
`),o="<pre>";o+=i.replace("<","&lt;").replace(">","&gt;")+`
`,a.forEach((c,d)=>{o+=`${d+1}: ${c}
`}),o+=`
</pre>`,console.log(o);let l=window.open("about:blank","_blank");if(l!==null)try{l.document.write(o)}catch(c){}}throw new IP(t,e,i,$W(i))}return r}var Ld,_P=class extends j{constructor(e,t,r,i,a,o){super();this.gl=e;this.vertexSource=t;this.fragmentSource=r;this.attributes=new Map;this.uniforms=new Map;this.vertexShaderInputBinders={};let l=this.vertexShader=RP(e,t,e.VERTEX_SHADER),c=this.fragmentShader=RP(e,r,e.FRAGMENT_SHADER),d=e.createProgram();if(e.attachShader(d,l),e.attachShader(d,c),wS&&(o==null?void 0:o.length)&&(e.transformFeedbackVaryings(d,o.map(y=>y.name),WebGL2RenderingContext.INTERLEAVED_ATTRIBS),this.vertexDebugOutputs=o),e.linkProgram(d),!e.getProgramParameter(d,e.LINK_STATUS)){let y=e.getProgramInfoLog(d)||"";throw new MP(t,r,y)}this.program=d;let{uniforms:p,attributes:m}=this;if(i)for(let y of i)p.set(y,e.getUniformLocation(d,y));if(a)for(let y of a)m.set(y,e.getAttribLocation(d,y))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){Ld=this,this.gl.useProgram(this.program)}disposed(){let{gl:e}=this;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0}};function VP(n,e,t,r,i){if(n.drawArraysInstanced(e,t,r,i),!wS||!(Ld==null?void 0:Ld.vertexDebugOutputs))return;let{vertexDebugOutputs:a}=Ld,o=0;for(let y of a)o+=jW[y.typeName];let l=n.createBuffer(),c=o*r*i;n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,l),n.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,c,WebGL2RenderingContext.DYNAMIC_DRAW),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),n.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,l),n.beginTransformFeedback(WebGL2RenderingContext.POINTS),n.enable(WebGL2RenderingContext.RASTERIZER_DISCARD),n.drawArraysInstanced(WebGL2RenderingContext.POINTS,t,r,i),n.disable(WebGL2RenderingContext.RASTERIZER_DISCARD),n.endTransformFeedback(),n.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,null),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,l);let d=new Uint8Array(c);n.getBufferSubData(WebGL2RenderingContext.ARRAY_BUFFER,0,d,0,c),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),n.deleteBuffer(l);let p=0,m=new Float32Array(d.buffer);for(let y=0;y<i;++y)for(let v=0;v<r;++v){let b=`i=${y} v=${v}:`;for(let x of a)switch(b+=` ${x.name}=`,x.typeName){case"float":b+=`${m[p++]}`;break;case"vec2":b+=`${m[p++]},${m[p++]}`;break;case"vec3":b+=`${m[p++]},${m[p++]},${m[p++]}`;break;case"vec4":b+=`${m[p++]},${m[p++]},${m[p++]},${m[p++]}`;break}console.log(b)}}var kS=class{constructor(){this.code="";this.parts=new Set}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(let t of e)this.add(t);else throw console.log("Invalid code type",e),new Error("Invalid code type")}}toString(){return this.code}},Nh={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D},jW={float:4,vec2:8,vec3:12,vec4:16},Zr=class{constructor(e){this.gl=e;this.nextSymbolID=0;this.nextTextureUnit=0;this.uniformsCode="";this.attributesCode="";this.varyingsCodeVS="";this.varyingsCodeFS="";this.fragmentExtensionsSet=new Set;this.fragmentExtensions="";this.vertexCode=new kS;this.vertexMain="";this.fragmentCode=new kS;this.outputBufferCode="";this.fragmentMain="";this.required=new Set;this.uniforms=new Array;this.attributes=new Array;this.initializers=[];this.textureUnits=new Map;this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());let r=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,r),r}addTextureSampler(e,t,r,i){let a=this.allocateTextureUnit(r,i);return this.addUniform(`highp ${e}`,t,i),this.addInitializer(o=>{if(i){let l=new Int32Array(i);for(let c=0;c<i;++c)l[c]=c+a;o.gl.uniform1iv(o.uniform(t),l)}else o.gl.uniform1i(o.uniform(t),a)}),a}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,r){return this.attributes.push(t),r!==void 0&&(this.attributesCode+=`layout(location = ${r})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,r=""){this.varyingsCodeVS+=`${r} out ${e} ${t};
`,this.varyingsCodeFS+=`${r} in ${e} ${t};
`}addOutputBuffer(e,t,r){r!==null&&(this.outputBufferCode+=`layout(location = ${r}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,r){return this.uniforms.push(t),r!=null?this.uniformsCode+=`uniform ${e} ${t}[${r}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){let e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
${this.fragmentCode}
${this.fragmentMain}
`,r=new _P(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);r.textureUnits=this.textureUnits;let{initializers:i}=this;if(i.length>0){r.bind();for(let a of i)a(r)}return r}};function ya(){return new Re(void 0)}function Ko(n){return new ht(n,ee)}function Ed(n,e,t){let r=new Map,{parameters:i,fallbackParameters:a,shaderError:o,encodeParameters:l=C=>C,extraParameters:c=qr(void 0),encodeExtraParameters:d=C=>C,getContextKey:p,defineShader:m}=t;o!==void 0&&(o.value=void 0);let{encodeContext:y=p}=t,v=Hn(t.memoizeKey);function b(C,k,D){let P=JSON.stringify({id:v,context:y(C),parameters:l(k),extraParameters:d(D)});return e.memoize.get(P,()=>{let M=new Zr(e);return m(M,C,k,D),M.build()})}function x(C){let k=p(C),D=r.get(k);D===void 0&&(D={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:i.value,extraParameters:c.value},r.set(k,D));let P=i.changed.count,M=c.changed.count;if(P===D.parametersGeneration&&M===D.extraParametersGeneration)return D;let I=D.parameters=i.value,E=D.extraParameters=c.value,_=D.shader;D.parametersGeneration=P,D.extraParametersGeneration=M;let O=null;try{O=b(C,I,E),D.fallback=!1,a!==void 0&&(a.value=I),o!==void 0&&(o.value=null)}catch(B){if(o!==void 0&&(o.value=B),a!==void 0)try{let W=a.value;O=b(C,W,E),D.parameters=W,D.fallback=!0}catch{}}return _!==null&&_.dispose(),D.shader=O,D}return n.registerDisposer(()=>{for(let C of r.values()){let{shader:k}=C;k!==null&&k.dispose()}}),x}function ei(n,e,t){return Ed(n,e,{...t,getContextKey:r=>r,encodeContext:r=>ct(r),defineShader:(r,i,a,o)=>(r.require(i),t.defineShader(r,a,o))})}function Ni(n,e=1,t=0){return`
#line ${t} ${e}
`+n}var OP=at(It());var xt=class{constructor(e,t=e){this.value_=e;this.defaultValue=t;this.changed=new ae}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}restoreState(e){if(e===!0||e===!1){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}},br=class extends j{constructor(e,t={}){super();this.model=e;this.element=document.createElement("input");let{element:r}=this;r.type="checkbox";let i=()=>{var o;let a=this.model.value;this.element.checked=a,(t.enableTitle!==void 0||t.disableTitle!==void 0)&&(this.element.title=(o=a?t.enableTitle:t.disableTitle)!=null?o:"")};this.registerDisposer(e.changed.add(i)),i(),this.registerEventListener(r,"change",function(a){e.value=this.checked}),r.addEventListener("mousedown",a=>{a.preventDefault()})}disposed(){let{element:e}=this,{parentElement:t}=e;t&&t.removeChild(e),super.disposed()}},ar=class extends j{constructor(e,t){super();this.model=e;this.element=t;this.initialDisplay=this.element.style.display;this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable((0,OP.default)(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}};var NP="SharedWatchableValue.changed",gt=class extends oo{constructor(e,t={}){super(e,t);this.updatingValue_=!1;e!==void 0&&(this.base=new Re(t.value),this.setupChangedHandler())}initializeCounterpart(e,t={}){t.value=this.value,super.initializeCounterpart(e,t)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{let{rpc:e}=this;e!==null&&e.invoke(NP,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(e,t){let r=new gt;return r.base=t,r.setupChangedHandler(),r.initializeCounterpart(e),r}static make(e,t){return gt.makeFromExisting(e,new Re(t))}get value(){return this.base.value}set value(e){this.base.value=e}get changed(){return this.base.changed}};gt=Lt([Jo("SharedWatchableValue")],gt);bt(NP,function(n){let e=this.get(n.id);e.updatingValue_=!0,e.base.value=n.value,e.updatingValue_=!1});var Pt=class extends Re{constructor(e=Number.NEGATIVE_INFINITY){super(e)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}};Pt.VISIBLE=Number.POSITIVE_INFINITY,Pt.IGNORED=Number.NEGATIVE_INFINITY;var so=class extends Pt{constructor(){super(...arguments);this.contributors=new Map}add(e){let{contributors:t}=this,r=e.changed.add(()=>{this.update()}),i=()=>{t.delete(i),r(),this.update()};return t.set(i,e),this.update(),i}update(){let e=Number.NEGATIVE_INFINITY;for(let t of this.contributors.values())e=Math.max(e,t.value);this.value=e}};function va(n){return class extends n{constructor(){super(...arguments);this.visibility=new so}initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(gt.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}var Nt=class{constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e;this.bufferType=t;this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,r=WebGL2RenderingContext.FLOAT,i=!1,a=0,o=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,r,i,a,o)}bindToVertexAttribI(e,t,r=WebGL2RenderingContext.UNSIGNED_INT,i=0,a=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,r,i,a)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){let r=this.gl;this.bind(),r.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,r,i){let a=new Nt(e,r);return a.setData(t,i),a}};function lo(n,e,t,...r){return n.memoize.get(Hn({id:"getMemoizedBuffer",getter:ct(t),args:r}),()=>{let i=new rd(Nt.fromData(n,t(...r),e,WebGL2RenderingContext.STATIC_DRAW));return i.registerDisposer(i.value),i})}function qW(n=-1,e=-1,t=1,r=1,i=1,a=1){return ed(new Float32Array([n,e,n,r,t,r,t,e]),2,i,a)}function Yo(n,e=-1,t=-1,r=1,i=1,a=1,o=1){return lo(n,WebGL2RenderingContext.ARRAY_BUFFER,qW,e,t,r,i,a,o).value}function co(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function BP(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}function UP(n,e,t,r,i=WebGL2RenderingContext.RGBA8,a=WebGL2RenderingContext.RGBA,o=WebGL2RenderingContext.UNSIGNED_BYTE){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),co(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,i,t,r,0,a,o,null),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function FP(n,e,t){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,t),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function LS(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain("v4f_fragColor = getValue0();")}function GP(n,e=LS,t=1){return n.memoize.get(`elementWiseTextureShader:${t}:${ct(e)}`,()=>{let r=new Zr(n);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler",t),r.addInitializer(i=>{let a=[];for(let o=0;o<t;++o)a[o]=o;n.uniform1iv(i.uniform("uSampler"),a)});for(let i=0;i<t;++i)r.addFragmentCode(`
vec4 getValue${i}() {
  return texture(uSampler[${i}], vTexCoord);
}
`);return r.addUniform("mat4","uProjectionMatrix"),r.require(e),r.addAttribute("vec4","aVertexPosition"),r.addAttribute("vec2","aTexCoord"),r.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),r.build()})}function WP(n){return n.memoize.get("trivialColorShader",()=>{let e=new Zr(n);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}var ES=class extends j{constructor(){super(...arguments);this.width=Number.NaN;this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}},zP=class extends ES{constructor(e,t){super();this.gl=e;this.internalformat=t;this.renderbuffer=null;this.renderbuffer=e.createRenderbuffer()}performResize(){let{gl:e}=this;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}},HP=class extends zP{constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16);this.gl=e;this.includeStencilBuffer=t}attachToFramebuffer(){let{gl:e}=this;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}},PS=class extends HP{constructor(e){super(e,!0)}};var $P=class extends j{constructor(e){super();this.gl=e;this.framebuffer=this.gl.createFramebuffer()}disposed(){let{gl:e}=this;e.deleteFramebuffer(this.framebuffer)}bind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null)}},Sa=class extends ES{constructor(e,t,r,i){super();this.gl=e;this.internalFormat=t;this.format=r;this.dataType=i;this.texture=e.createTexture()}performResize(){UP(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}},DS=class extends Sa{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,r=WebGL2RenderingContext.DEPTH_COMPONENT,i=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,r,i)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}};function Ks(n,e,t=WebGL2RenderingContext.RGBA8,r=WebGL2RenderingContext.RGBA,i=WebGL2RenderingContext.UNSIGNED_BYTE){let a=new Array;for(let o=0;o<e;++o)a[o]=new Sa(n,t,r,i);return a}var Bi=class extends j{constructor(e,t){super();this.gl=e;this.width=Number.NaN;this.height=Number.NaN;this.fullAttachmentList=new Array;this.attachmentVerified=!1;this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];let{framebuffer:r=new $P(e),colorBuffers:i,depthBuffer:a}=t;this.framebuffer=this.registerDisposer(r),this.colorBuffers=i,this.depthBuffer=a,a!==void 0&&this.registerDisposer(a);let{fullAttachmentList:o}=this;i.forEach((l,c)=>{this.registerDisposer(l),o[c]=e.COLOR_ATTACHMENT0+c})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let{gl:r,depthBuffer:i}=this;i!==void 0?(i.resize(e,t),i.attachToFramebuffer()):r.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((a,o)=>{a.resize(e,t),a.attachToFramebuffer(r.COLOR_ATTACHMENT0+o)}),r.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),r.viewport(0,0,e,t)}bindSingle(e){let{gl:t}=this;this.framebuffer.bind(),e!==0&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,r,i,a=1,o=1){let{gl:l}=this;try{this.bindSingle(e),l.readPixels(t,r,a,o,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,i)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let{gl:e}=this,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}},ba=class extends j{constructor(e,t){super();this.gl=e;this.shader=t;this.copyVertexPositionsBuffer=Yo(this.gl);this.copyTexCoordsBuffer=Yo(this.gl,0,0,1,1);this.registerDisposer(t)}draw(...e){let{gl:t,shader:r}=this;r.bind();let i=e.length;for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,e[l]);t.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,qf);let a=r.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(a,2);let o=r.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(o,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(a),t.disableVertexAttribArray(o);for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=LS,r=1){return e.memoize.get(`OffscreenCopyHelper:${r}:${ct(t)}`,()=>new ba(e,GP(e,t,r)))}};var jP=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`,qP=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`,Dt=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,JP=[Dt,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],Bh=[Dt,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],Pd=[Dt,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],AS=[Dt,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],JW=[Dt,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],KP=[JW,Pd,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],YP=[AS,Pd,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],IS=[Dt,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],XP=[Dt,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],MS=[Dt,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],RS=[Dt,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],Uh=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,_S=[Dt,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],VS=[Dt,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],Ys=[Dt,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],OS=[Dt,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`],QP=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`,ZP=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,eD=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,tD=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,nD=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,Fh=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,rD=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,iD=[Fh,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],aD=[Fh,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function Vt(n,e=1){switch(n){case H.FLOAT32:if(e===1)return"float";if(e>1&&e<=4)return`vec${e}`;break;case H.UINT8:case H.INT8:case H.UINT16:case H.INT16:case H.UINT32:case H.INT32:case H.UINT64:{let t=Zf[n]?"":"u",r=eh[n]*8;if(e===1)return`${t}int${r}_t`;if(e>1&&e*r<=32)return`${t}int${r}x${e}_t`;break}}throw new Error(`No shader type for ${H[n]}[${e}].`)}var Xs={[H.UINT8]:MS,[H.INT8]:RS,[H.UINT16]:_S,[H.INT16]:VS,[H.UINT32]:Ys,[H.INT32]:OS,[H.UINT64]:Dt,[H.FLOAT32]:Uh};function KW(n,e){return e===1?n:n==="float"?`vec${e}`:`${n[0]}vec${e}`}var YW={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function xa(n,e,t,r,i,a,o=1){let l=0,c=a*o;for(;c>0;){let m=Math.min(4,c),y=KW(e,m);c-=m,n.addAttribute("highp "+y,`a${i}${l}`),++l}c=a*o;let d="";for(let m=0;m<o;++m){d+=`highp ${e}[${a}] get${i}${m}() {
  highp ${e}[${a}] result;
`;for(let y=0;y<a;++y){let v=m*a+y,b=Math.floor(v/4),x=v%4;d+=`  result[${y}] = a${i}${b}`,(x!==0||v!==c-1)&&(d+=`[${x}]`),d+=`;
`}d+=`  return result;
`,d+=`}
`}n.addVertexCode(d);let p=YW[t];n.addInitializer(m=>{let y=[];for(let v=0;v<l;++v)y[v]=m.attribute(`a${i}${v}`);m.vertexShaderInputBinders[i]={enable(v){let{gl:b}=m;for(let x=0;x<l;++x){let C=y[x];b.enableVertexAttribArray(C),b.vertexAttribDivisor(C,v)}},disable(){let{gl:v}=m;for(let b=0;b<l;++b){let x=y[b];v.vertexAttribDivisor(x,0),v.disableVertexAttribArray(x)}},bind(v,b){let{gl:x}=m;for(let C=0;C<l;++C){let k=y[C],D=Math.min(4,c-4*C);e==="float"?x.vertexAttribPointer(k,D,t,r,v,b):x.vertexAttribIPointer(k,Math.min(4,c-4*C),t,v,b),b+=p*D}}}})}var XW=!1,Dd=class extends j{constructor(e,t,r=new so){super();this.channels=e;this.bounds=t;this.visibility=r;this.framebuffers=[];this.producerVisibility=new so;this.frameNumber=-1}getFramebuffers(e){let{framebuffers:t}=this;for(;t.length<this.channels.value.length;){let r=new Bi(e,{colorBuffers:Ks(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(r)}return t}disposed(){for(let e of this.framebuffers)e.dispose();this.framebuffers.length=0}},oD=Symbol("histogramDataSamplerTextureUnit"),sD=Symbol("histogramDepthTextureUnit"),NS=4096,QW=2**14,Ad=class extends j{constructor(e){super();this.gl=e;this.shader=this.registerDisposer((()=>{let e=new Zr(this.gl);return e.addOutputBuffer("vec4","outputValue",0),e.addAttribute("float","aInput1"),e.addTextureSampler("sampler2D","uDataSampler",oD),e.addTextureSampler("sampler2D","uDepthSampler",sD),e.addVertexCode(tD),e.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),e.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),e.build()})());this.inputIndexBuffer=this.registerDisposer(lo(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(NS)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new Ad(e))}compute(e,t,r,i,a){let{gl:o}=this,{shader:l}=this,c=i.getFramebuffers(o);l.bind(),o.enable(WebGL2RenderingContext.BLEND),o.disable(WebGL2RenderingContext.SCISSOR_TEST),o.disable(WebGL2RenderingContext.DEPTH_TEST),o.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(l.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);let d=l.textureUnit(oD),p=l.textureUnit(sD);o.activeTexture(WebGL2RenderingContext.TEXTURE0+p),o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),co(o),o.activeTexture(WebGL2RenderingContext.TEXTURE0+d);let m=i.frameNumber;i.frameNumber=a;for(let y=0;y<e;++y)if(o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r[y].texture),co(o),c[y].bind(256,1),a!==m&&(o.clearColor(0,0,0,0),o.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),o.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,NS,QW/NS),XW){let v=new Float32Array(256*4);o.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,v);let b=new Float32Array(256);for(let x=0;x<256;++x)b[x]=v[x*4];console.log("histogram",b.join(" "))}o.disable(WebGL2RenderingContext.BLEND)}};var BS={[H.UINT8]:"vec2",[H.INT8]:"vec2",[H.UINT16]:"vec2",[H.INT16]:"vec2",[H.FLOAT32]:"vec2",[H.UINT32]:"Uint32LerpParameters",[H.INT32]:"Int32LerpParameters",[H.UINT64]:"Uint64LerpParameters"},Id={[H.UINT8]:"",[H.INT8]:"",[H.UINT16]:"",[H.INT16]:"",[H.FLOAT32]:"",[H.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[H.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[H.UINT64]:[Dt,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]};function Md(n){let t=`
float computeInvlerp(${Vt(n)} inputValue, vec2 p) {
  float outputValue = float(toRaw(inputValue));
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;return[Xs[n],t]}function lD(n){let e=Vt(n),t=n===H.INT32?"int":"uint",r=BS[n];return[Xs[n],Id[n],`
float computeInvlerp(${e} inputValue, ${r} p) {
  ${t} v = toRaw(inputValue);
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
`]}var ZW={[H.UINT8]:Md(H.UINT8),[H.INT8]:Md(H.INT8),[H.UINT16]:Md(H.UINT16),[H.INT16]:Md(H.INT16),[H.FLOAT32]:Md(H.FLOAT32),[H.UINT32]:lD(H.UINT32),[H.INT32]:lD(H.INT32),[H.UINT64]:[Dt,Pd,AS,IS,Id[H.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function Rd(n){let t=`
${Vt(n)} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return n===H.FLOAT32?t+=`return inputValue;
`:t+=`return ${H[n].toLowerCase()}FromFloat(round(inputValue));
`,t+=`
}
`,[Xs[n],t]}function cD(n){let e=Vt(n),t=BS[n];return[Xs[n],Id[n],nD,n===H.UINT32?Fh:iD,n===H.UINT32?rD:aD,`
${e} computeLerp(float inputValue, ${t} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${e}(addSaturate(p.offset, xShifted));
  } else {
    return ${e}(subtractSaturate(p.offset, xShifted));
  }
}
`]}var ez={[H.UINT8]:Rd(H.UINT8),[H.INT8]:Rd(H.INT8),[H.UINT16]:Rd(H.UINT16),[H.INT16]:Rd(H.INT16),[H.FLOAT32]:Rd(H.FLOAT32),[H.UINT32]:cD(H.UINT32),[H.INT32]:cD(H.INT32),[H.UINT64]:[Dt,Pd,Bh,KP,YP,IS,XP,Id[H.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function uD(n,e,t){let r=`uLerpParams_${e}`,i=`uLerpBounds_${e}`,a=`uLerpScalar_${e}`,o="";switch(t){case H.INT8:case H.UINT8:case H.INT16:case H.UINT16:case H.FLOAT32:n.addUniform("vec2",r);break;case H.INT32:case H.UINT32:{let l=BS[t];n.addUniform(`${t===H.INT32?"i":"u"}vec2`,i),n.addUniform("float",a),o+=`
#define ${r} ${l}(${i}[0], int(${i}[1]), ${a})
`;break}case H.UINT64:{n.addUniform("uvec3",i),n.addUniform("float",a),o+=`
#define ${r} Uint64LerpParameters(uint64_t(${i}.xy), int(${i}[2]), ${a})
`;break}}return[Id[t],o]}function Gh(n,e,t,r=!1){return[Xs[t],uD(n,e,t),ZW[t],`
float ${e}(${Vt(t)} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  ${r?"v = clamp(v, 0.0, 1.0);":""}
  return v;
}
`]}function dD(n,e,t){return[Xs[t],uD(n,e,t),ez[t],`
${Vt(t)} ${e}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${e});
}
`]}var Qs=new X;function Cc(n,e,t,r){let{gl:i}=n;switch(t){case H.INT8:case H.UINT8:case H.INT16:case H.UINT16:case H.FLOAT32:i.uniform2f(n.uniform(`uLerpParams_${e}`),r[0],1/(r[1]-r[0]));break;case H.INT32:case H.UINT32:{let a=r[0],o=r[1]-a,l=Math.max(0,Math.ceil(Math.log2(Math.abs(o)))-24),c=Math.pow(2,l)/o,d=n.uniform(`uLerpBounds_${e}`);t===H.UINT32?i.uniform2ui(d,a,l):i.uniform2i(d,a,l),i.uniform1f(n.uniform(`uLerpScalar_${e}`),c);break}case H.UINT64:{let a=r[0],o=r[1];X.absDifference(Qs,o,a);let l=Qs.high>0?32+Math.ceil(Math.log2(Qs.high)):Math.ceil(Math.log2(Qs.low)),c=Math.max(0,l-24);X.rshift(Qs,Qs,c);let d=1/Qs.low;X.compare(a,o)>0&&(d*=-1);let p=n.uniform(`uLerpBounds_${e}`);i.uniform3ui(p,a.low,a.high,c),i.uniform1f(n.uniform(`uLerpScalar_${e}`),d)}}}function tz(n){let e=/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/mg;return n.replace(e,t=>t.startsWith("/")?t.replace(/[^\s]/g," "):t)}function nz(n){let e=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/,t=0,r=n;e:for(;n.length;){let i=n.match(e);if(i===null)break;let a=i[0];switch(a.charAt(0)){case"[":case"{":++t;break;case"]":case"}":if(--t<0)return-1;break;case",":if(t===0)break e;break;default:if(t===0){n=n.substring(a.length);break e}break}n=n.substring(a.length)}return t!==0?-1:r.length-n.length}function rz(n){let e=[],t=new Map;if(n===void 0)return{errors:e,parameters:t};let r=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;n=n.trim(),n.length!=0;){let i=n.match(r);if(i===null){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let a=i[1];n=n.substring(i[0].length);let o=nz(n);if(o<=0){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let l;try{l=JSON.parse(n.substring(0,o))}catch{e.push(`Invalid #uicontrol parameter value for ${a}: ${l}`);break}t.has(a)?e.push(`Duplicate #uicontrol parameter: ${a}`):t.set(a,l),n=n.substring(o),n=n.trim(),n.length>0&&!n.startsWith(",")&&e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),n=n.substring(1)}return{parameters:t,errors:e}}function iz(n,e){let t,r,i,a,o=[];n!=="float"&&n!=="uint"&&n!=="int"&&o.push("type must be float, int, or uint");for(let[l,c]of e){let d=()=>{if(typeof c!="number"){o.push(`Expected ${l} argument to be a number`);return}return(n==="int"||n==="uint")&&(Number.isInteger(c)||o.push(`Expected ${l} argument to be an integer`),n==="uint"&&c<0&&o.push(`Expected ${l} argument to be an unsigned integer`)),c};l==="min"?t=d():l==="max"?r=d():l==="default"?a=d():l==="step"?i=d():o.push(`Invalid parameter: ${l}`)}return t===void 0&&o.push("min must be specified"),r===void 0&&o.push("max must be specified"),t!==void 0&&r!==void 0&&(t>r&&o.push("min must be less than max"),i===void 0&&(n==="float"?i=(r-t)/100:i=1),a!==void 0?(a<t||a>r)&&o.push("default must be within valid range"):n==="float"?a=(t+r)/2:a=t),o.length>0?{errors:o}:{control:{type:"slider",valueType:n,min:t,max:r,step:i,default:a},errors:void 0}}function az(n,e){let t=!1,r=[];n!=="bool"&&r.push("type must be bool");for(let[i,a]of e)if(i==="default"){if(typeof a!="boolean"){r.push(`Expected ${i} argument to be a boolean`);continue}t=a}else r.push(`Invalid parameter: ${i}`);return r.length>0?{errors:r}:{control:{type:"checkbox",valueType:n,default:t},errors:void 0}}function oz(n,e){let t="white",r=[];n!=="vec3"&&r.push("type must be vec3");for(let[i,a]of e)i==="default"?typeof a!="string"?r.push("Expected default argument to be a string"):t=a:r.push(`Invalid parameter: ${i}`);return r.length>0?{errors:r}:{control:{type:"color",valueType:n,defaultString:t,default:ha(t)},errors:void 0}}function pD(n,e){typeof n=="number"&&(n=[n]);let t=new Array(e);return He(t,n,r=>{if(!Number.isInteger(r)||r<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(r)}`);return r}),t}function sz(n,e,t){let r=[],{imageData:i}=t;if(i===void 0)return r.push("invlerp control not supported"),{errors:r};n!=="invlerp"&&r.push("type must be invlerp");let a=new Array(i.channelRank).fill(0),{dataType:o}=i,l=!0,c=uc[o],d;for(let[p,m]of e)try{switch(p){case"range":{c=md(m,o);break}case"window":{d=Gv(md(m,o));break}case"clamp":{typeof m!="boolean"?r.push(`Invalid clamp value: ${JSON.stringify(m)}`):l=m;break}case"channel":{a=pD(m,a.length);break}default:r.push(`Invalid parameter: ${p}`);break}}catch(y){r.push(`Invalid ${p} value: ${y.message}`)}return r.length>0?{errors:r}:{control:{type:"invlerp",dataType:o,clamp:l,default:{range:c,window:d!=null?d:TE(c),channel:a}},errors:void 0}}var lz=new Map([["slider",iz],["color",oz],["invlerp",sz],["checkbox",az]]);function uo(n,e={}){n=tz(n);let t=/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/mg,r=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/,i=[],a=new Map,o=n.replace(t,(l,c,d)=>{var M;let p=c.match(r),m=()=>Math.max(0,n.substring(0,d).split(`
`).length-1);if(p===null)return i.push({line:m(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";let y=p[1],v=p[2],b=(M=p[3])!=null?M:y,x=p[4],{parameters:C,errors:k}=rz(x);for(let I of k)i.push({line:m(),message:I});if(a.has(v)&&i.push({line:m(),message:`Duplicate definition for control ${v}`}),k.length>0)return"";let D=lz.get(b);if(D===void 0)return i.push({line:m(),message:`Invalid control type ${b}`}),"";let P=D(y,C,e);if(P.errors!==void 0){for(let I of P.errors)i.push({line:m(),message:I});return""}return a.set(v,P.control),""});return{source:n,code:o,errors:i,controls:a}}function fD(n){return`u_shaderControl_${n}`}function Ui(n,e){let{builderValues:t}=n;for(let[r,i]of n.parseResult.controls){let a=fD(r),o=t[r];switch(i.type){case"invlerp":{let l=[Gh(e,a,i.dataType,i.clamp),`
float ${a}() {
  return ${a}(getDataValue(${o.channel.join(",")}));
}
`];e.addFragmentCode(l),e.addFragmentCode(`#define ${r} ${a}
`);break}case"checkbox":{let l=`#define ${r} ${o.value}
`;e.addFragmentCode(l),e.addVertexCode(l);break}default:{e.addUniform(`highp ${i.valueType}`,a),e.addVertexCode(`#define ${r} ${a}
`),e.addFragmentCode(`#define ${r} ${a}
`);break}}}}function cz(n){let e={};for(let[t,r]of n)e[t]=r;return e}function hD(n){if(n!==void 0)return JSON.stringify(cz(n))}var mD=class{constructor(){this.changed=new ae;this.controls=void 0}get value(){return this.controls}set value(e){hD(e)!==hD(this.controls)&&(this.controls=e,this.changed.dispatch())}};function uz(n,e,t){return n===void 0?t:(Q(n),{range:le(n,"range",r=>md(r,e),t.range),window:le(n,"window",r=>Gv(md(r,e)),t.window),channel:le(n,"channel",r=>pD(r,t.channel.length),t.channel)})}var gD=class extends ht{constructor(e,t){super(t,r=>uz(r,e,t));this.dataType=e;this.defaultValue=t}toJSON(){let{value:{range:e,window:t,channel:r},dataType:i,defaultValue:a}=this,o=Wv(e,i,a.range),l=Wv(t,i,a.window),c=we(a.channel,r)?void 0:r;if(!(o===void 0&&l===void 0&&c===void 0))return{range:o,window:l,channel:c}}};function yD(n){switch(n.type){case"slider":return{trackable:new ht(n.default,e=>{let t;if(n.valueType==="float"?t=Ye(e):t=ot(e),t<n.min||t>n.max)throw new Error(`${JSON.stringify(e)} is outside valid range [${n.min}, ${n.max}]`);return t}),getBuilderValue:()=>null};case"color":return{trackable:new Go(n.default),getBuilderValue:()=>null};case"invlerp":return{trackable:new gD(n.dataType,n.default),getBuilderValue:e=>({channel:e.channel,dataType:n.dataType})};case"checkbox":return{trackable:new xt(n.default),getBuilderValue:e=>({value:e})}}}function vD(n,e){return JSON.stringify(n)+"\0"+e.source}function Xo(n){let e={};for(let[t,r]of n.controls){let{trackable:i,getBuilderValue:a}=yD(r);e[t]=a(i.value)}return{builderValues:e,parseResult:n,key:vD(e,n)}}var po=class extends j{constructor(e,t=qr({}),r){super();this.fragmentMain=e;this.dataContext=t;this.channelCoordinateSpaceCombiner=r;this.changed=new ae;this.controls=new mD;this.fragmentMainGeneration=-1;this.dataContextGeneration=-1;this.parseErrors_=[];this.processedFragmentMain_="";this.controlsGeneration=-1;this.parseResultChanged=new ae;this.state_=new Map;this.unparsedJson=void 0;this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();let i=this;this.parseErrors={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return i.parseResult_}},this.builderState=Qt((l,c)=>{let d={};for(let[p,{trackable:m,getBuilderValue:y}]of c){let v=y(m.value);d[p]=v}return{key:vD(d,l),parseResult:l,builderValues:d}},[this.parseResult,this],(l,c)=>l.key===c.key);let a=Qt(l=>{let c=[];for(let{control:d,trackable:p}of l.values())d.type==="invlerp"&&c.push({channel:p.value.channel});return c},[this],(l,c)=>td(l,c,(d,p)=>we(d.channel,p.channel))),o=Pn(l=>{let c=[];for(let{control:d,trackable:p}of l.values())d.type==="invlerp"&&c.push(p.value.window);return c},this);this.histogramSpecifications=this.registerDisposer(new Dd(a,o))}handleFragmentMainChanged(){let e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;let r=this.dataContext.value;if(r===null)this.parseResult_={source:"",code:"",controls:new Map,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{let i=this.parseResult_=uo(this.fragmentMain.value,r);this.parseErrors_=i.errors,this.processedFragmentMain_=i.code,i.errors.length===0&&(this.controls.value=i.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){let e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;let t=this.controls.value;if(t===void 0)return;let r=!1,{state_:i,unparsedJson:a}=this;for(let[o,l]of i)if(t.get(o)===void 0){l.trackable.changed.remove(this.changed.dispatch),i.delete(o),r=!0;continue}for(let[o,l]of t){let c=i.get(o);if(c!==void 0&&JSON.stringify(c.control)!==JSON.stringify(l)&&(c.trackable.changed.remove(this.changed.dispatch),c=void 0),c===void 0){let{trackable:d,getBuilderValue:p}=yD(l);c={control:l,trackable:d,getBuilderValue:p},c.trackable.changed.add(this.changed.dispatch),i.set(o,c),r=!0}if(a!==void 0&&a.hasOwnProperty(o)){r=!0;try{c.trackable.restoreState(a[o])}catch{}}}a!==void 0&&(r=!0),this.unparsedJson=void 0,r&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(e===void 0)return;let{state:t}=this;if(Q(e),this.controls.value===void 0){this.unparsedJson=e,this.changed.dispatch();return}for(let[i,a]of t){let{trackable:o}=a;if(o.reset(),e.hasOwnProperty(i))try{o.restoreState(e[i])}catch{}}this.unparsedJson=void 0}reset(){for(let e of this.state.values())e.trackable.reset();this.unparsedJson!==void 0&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){let{state:e}=this,{unparsedJson:t}=this;if(t!==void 0)return t;let r={},i=!0;for(let[a,o]of e){let l=o.trackable.toJSON();l!==void 0&&(r[a]=l,i=!1)}if(!i)return r}};function SD(n,e,t,r,i){let a=fD(t),o=e.uniform(a);switch(r.type){case"slider":switch(r.valueType){case"int":case"uint":n.uniform1i(o,i);break;case"float":n.uniform1f(o,i)}break;case"color":n.uniform3fv(o,i);break;case"invlerp":Cc(e,a,r.dataType,i.range);break;case"checkbox":break}}function ti(n,e,t,r){let{state:i}=t;if(t.controls.value===r)for(let[a,o]of i)SD(n,e,a,o.control,o.trackable.value);else for(let[a,o]of r){let l=i.get(a),c=l!==void 0&&JSON.stringify(l.control)===JSON.stringify(o)?l.trackable.value:o.default;SD(n,e,a,o,c)}}function bD(n,e){return{defineShader(t,r){let i=`prop_${r}`,a=`a_${i}`;t.addAttribute(`${n}`,a),t.addVertexCode(`${n} ${i}() { return ${a}; }`),t.addInitializer(o=>{let l=o.attribute(a),{gl:c}=o;o.vertexShaderInputBinders[i]=l===-1?{enable(){},disable(){},bind(){}}:{enable(d){c.enableVertexAttribArray(l),c.vertexAttribDivisor(l,d)},disable(){c.vertexAttribDivisor(l,0),c.disableVertexAttribArray(l)},bind(d,p){e(c,l,d,p)}}})}}}function US(n,e,t,r){return bD(n,(i,a,o,l)=>{i.vertexAttribPointer(a,e,t,r,o,l)})}function wc(n,e,t){return bD(n,(r,i,a,o)=>{r.vertexAttribIPointer(i,e,t,a,o)})}var dz={rgb:US("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:US("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:US("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:wc("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:wc("highp int",1,WebGL2RenderingContext.INT),uint16:wc("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:wc("highp int",1,WebGL2RenderingContext.SHORT),uint8:wc("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:wc("highp int",1,WebGL2RenderingContext.BYTE)},Fi=class extends j{constructor(e,t,r,i,a,o,l){super();this.gl=e;this.annotationType=t;this.rank=r;this.properties=i;this.shaderControlState=a;this.fallbackShaderParameters=o;this.shaderError=l;let c=this.serializedGeometryBytesPerAnnotation=An[t].serializedBytes(r),{offsets:d,serializedBytes:p,propertyGroupBytes:m}=Hv(r,c,i);this.serializedBytesPerAnnotation=p,this.propertyOffsets=d,this.propertyGroupBytes=m,this.geometryDataStride=m[0]}getDependentShader(e,t){return ei(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(r,i)=>{let{rank:a,properties:o}=this,l=[],c=i.parseResult.code;for(let v=0,b=o.length;v<b;++v){let x=o[v],C=`prop_${x.identifier}`;if(!c.match(new RegExp(`\\b${C}\\b`)))continue;l.push(v),dz[x.type].defineShader(r,x.identifier,a)}let{propertyOffsets:d}=this,{propertyGroupBytes:p}=this,m=new Array(p.length);m[0]=0;for(let v=1;v<p.length;++v)m[v]=m[v-1]+p[v-1];r.addInitializer(v=>{let b=l.map(C=>v.vertexShaderInputBinders[`prop_${o[C].identifier}`]),x=b.length;v.vertexShaderInputBinders.properties={enable(C){for(let k=0;k<x;++k)b[k].enable(C)},bind(C,k){for(let D=0;D<x;++D){let{group:P,offset:M}=d[l[D]];b[D].bind(p[P],k+M+m[P]*C)}},disable(){for(let C=0;C<x;++C)b[C].disable()}}}),r.addUniform("highp vec3","uColor"),r.addUniform("highp uint","uSelectedIndex"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec3","uSubspaceMatrix",a),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp float","uModelClipBounds",a*2),r.addUniform("highp uint","uPickID"),r.addVarying("highp uint","vPickID","flat"),r.addVertexCode(Oi),r.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),r.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);let y=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;r.addVertexCode(y),r.addFragmentCode(y),r.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${a}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),Ui(i,r),r.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setAxisColor(vec4 startColor, vec4 endColor);
void setAxisWidth(float width);
void setSphereColor(vec4 color);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setAxisEndpointMarkerSize(float startSize, float endSize);
void setAxisEndpointMarkerBorderWidth(float startSize, float endSize);

void setAxisPointMarkerColor(vec4 color);
void setAxisPointMarkerBorderColor(vec4 color);
void setAxisPointMarkerSize(float size);
void setAxisPointMarkerBorderWidth(float size);

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setAxisColor(vec4 color) { setAxisColor(color, color); }
void setAxisColor(vec3 color) { setAxisColor(vec4(color, 1.0)); }
void setAxisColor(vec3 startColor, vec3 endColor) { setAxisColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setAxisEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setAxisEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setAxisEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setAxisEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setAxisEndpointMarkerColor(vec3 color) { setAxisEndpointMarkerColor(color, color); }
void setAxisEndpointMarkerColor(vec4 color) { setAxisEndpointMarkerColor(color, color); }
void setAxisEndpointMarkerBorderColor(vec3 color) { setAxisEndpointMarkerBorderColor(color, color); }
void setAxisEndpointMarkerBorderColor(vec4 color) { setAxisEndpointMarkerBorderColor(color, color); }
void setAxisEndpointMarkerSize(float size) { setAxisEndpointMarkerSize(size, size); }
void setAxisEndpointMarkerBorderWidth(float size) { setAxisEndpointMarkerBorderWidth(size, size); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
  setAxisColor(color);
  setAxisEndpointMarkerColor(color);
  setSphereColor(color);
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`);for(let[v,b]of FS)v!==this.annotationType&&b.defineShaderNoOpSetters(r);t(r),r.addVertexCode(`
#define main userMain
`+Ni(i.parseResult.code)+`
#undef main
`)}})}setPartIndex(e,...t){let r=`
void setPartIndex(${t.map((i,a)=>`highp uint partIndex${a}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((i,a)=>`highp uint pickOffset${a} = pickBaseOffset + partIndex${a};`).join(`
`)}
`;return t.length===0&&(r+=`
  highp uint pickOffset0 = pickBaseOffset;
`),r+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((i,a)=>` || selectedIndex == pickOffset${a}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(r),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,r){let{shader:i,parameters:a}=e(t.renderContext.emitter);if(i===null)return;i.bind();let{gl:o}=this,{renderContext:l}=t,{annotationLayer:c}=t;if(ti(o,i,this.shaderControlState,a.parseResult.controls),o.uniform3fv(i.uniform("uSubspaceMatrix"),t.subspaceMatrix),o.uniform1fv(i.uniform("uModelClipBounds"),t.modelClipBounds),o.uniformMatrix4fv(i.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),l.emitPickID&&o.uniform1ui(i.uniform("uPickID"),t.basePickId),l.emitColor){let p=c.state.displayState.color.value;o.uniform3f(i.uniform("uColor"),p[0],p[1],p[2]),o.uniform1ui(i.uniform("uSelectedIndex"),t.selectedIndex)}let d=i.vertexShaderInputBinders.properties;d.enable(1),o.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),d.bind(t.count,t.bufferOffset),r(i),d.disable()}},FS=new Map;function Ca(n,e){FS.set(n,e)}function Qo(n){return FS.get(n)}var nt;(function(c){c[c.GPU_MEMORY=0]="GPU_MEMORY",c[c.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",c[c.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",c[c.DOWNLOADING=3]="DOWNLOADING",c[c.QUEUED=4]="QUEUED",c[c.NEW=5]="NEW",c[c.FAILED=6]="FAILED",c[c.EXPIRED=7]="EXPIRED"})(nt||(nt={}));var Wh=8,wa;(function(l){l[l.FIRST_TIER=0]="FIRST_TIER",l[l.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",l[l.VISIBLE=0]="VISIBLE",l[l.PREFETCH=1]="PREFETCH",l[l.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",l[l.RECENT=2]="RECENT",l[l.LAST_TIER=2]="LAST_TIER"})(wa||(wa={}));var GS=3,_d;(function(t){t[t.totalTime=0]="totalTime",t[t.totalChunks=1]="totalChunks"})(_d||(_d={}));var Ta;(function(r){r[r.numChunks=0]="numChunks",r[r.systemMemoryBytes=1]="systemMemoryBytes",r[r.gpuMemoryBytes=2]="gpuMemoryBytes"})(Ta||(Ta={}));var ka=3,pz=2,o7=Wh*GS*ka+pz;function Zo(n,e){return n*GS+e}function WS(n){return Wh*GS*ka+n}var xD="ChunkQueueManager",CD="ChunkManager",wD="ChunkSource.invalidate",TD="ChunkQueueManager.requestChunkStatistics",kD="ChunkManager.chunkLayerStatistics",fo=class{constructor(){this.numVisibleChunksNeeded=0;this.numVisibleChunksAvailable=0;this.numPrefetchChunksNeeded=0;this.numPrefetchChunksAvailable=0}};var LD=!1,xr=class{constructor(e){this.source=e;this.state=nt.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=nt.GPU_MEMORY}freeGPUMemory(e){this.state=nt.SYSTEM_MEMORY}};function ED(n){if(typeof n!="number"||n<0)throw new Error(`Expected non-negative number as limit, but received: ${JSON.stringify(n)}`);return n}var Tc=class{constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new ht(t,ED),this.itemLimit=new ht(e,ED)}},Vd=class extends gn{constructor(e,t,r,i){super();this.gl=t;this.frameNumberCounter=r;this.capacities=i;this.visibleChunksChanged=new ae;this.pendingChunkUpdates=null;this.pendingChunkUpdatesTail=null;this.chunkUpdateDeadline=null;this.chunkUpdateDelay=30;this.enablePrefetch=new xt(!0,!0);let a=o=>({itemLimit:this.registerDisposer(gt.makeFromExisting(e,o.itemLimit)).rpcId,sizeLimit:this.registerDisposer(gt.makeFromExisting(e,o.sizeLimit)).rpcId});this.initializeCounterpart(e,{gpuMemoryCapacity:a(i.gpuMemory),systemMemoryCapacity:a(i.systemMemory),downloadCapacity:a(i.download),computeCapacity:a(i.compute),enablePrefetch:this.registerDisposer(gt.makeFromExisting(e,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let e=this.chunkUpdateDeadline,t;e===null||Date.now()<e?t=0:t=this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),t)}processPendingChunkUpdates(e=!1){let t=this.chunkUpdateDeadline;!e&&t===null&&(t=Date.now()+30);let r=!1,i=0;for(;;){if(!e&&Date.now()>t){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}let a=this.pendingChunkUpdates;if(a==null)break;if(this.applyChunkUpdate(a)&&(r=!0),++i,(this.pendingChunkUpdates=a.nextUpdate)==null){this.pendingChunkUpdatesTail=null;break}}return r&&this.visibleChunksChanged.dispatch(),i}handleFetch_(e,t){let{resolve:r,reject:i,cancellationToken:a}=t.promise;if(a.isCanceled){i(ir);return}let o=t.key,l=e.chunks.get(o);if(!l){i(new Error(`No chunk found at ${o} for source ${e.constructor.name}`));return}let c=l.data;if(!c){i(new Error(`At ${o} for source ${e.constructor.name}: chunk has no data`));return}r({value:c})}applyChunkUpdate(e){let t=!1,{rpc:r}=this,i=r.get(e.source);if(LD&&console.log(`${Date.now()} Chunk.update processed: ${i.rpcId} ${e.id} ${e.state}`),e.promise!==void 0)this.handleFetch_(i,e);else if(e.id===void 0){for(let a of i.chunks.keys())i.deleteChunk(a);t=!0}else{let a=e.state;if(a===nt.EXPIRED)i.deleteChunk(e.id);else{let o,l=e.id;e.new?(o=i.getChunk(e),i.addChunk(l,o)):o=i.chunks.get(l);let c=o.state;if(a!==c)switch(a){case nt.GPU_MEMORY:o.copyToGPU(this.gl),t=!0;break;case nt.SYSTEM_MEMORY:o.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${nt[a]}`)}}}return t}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){let e=this.rpc,t=await e.promiseInvoke(TD,{queue:this.rpcId}),r=new Map;for(let[i,a]of t){let o=e.get(i);o!==void 0&&r.set(o,a)}return r}};Vd=Lt([yn(xD)],Vd);function PD(n,e){let t=n.get(e.source);LD&&console.log(`${Date.now()} Chunk.update received: ${t.rpcId} ${e.id} ${e.state} with chunkDataSize ${e.chunkDataSize}`);let r=t.chunkManager.chunkQueueManager;if(t.immediateChunkUpdates){r.applyChunkUpdate(e)&&r.visibleChunksChanged.dispatch();return}let i=r.pendingChunkUpdatesTail;i==null?(r.pendingChunkUpdates=e,r.pendingChunkUpdatesTail=e,r.scheduleChunkUpdate()):(i.nextUpdate=e,r.pendingChunkUpdatesTail=e)}bt("Chunk.update",function(n){PD(this,n)});_h("Chunk.retrieve",function(n,e){return new Promise((t,r)=>{n.promise={resolve:t,reject:r,cancellationToken:e},PD(this,n)})});bt(kD,function(n){let e=this.get(n.id);for(let t of e.prevStatisticsLayers)t.numVisibleChunksNeeded=0,t.numVisibleChunksAvailable=0,t.numPrefetchChunksNeeded=0,t.numPrefetchChunksAvailable=0;e.prevStatisticsLayers.length=0;for(let t of n.layers){let r=this.get(t.id);if(r===void 0)continue;let i=r.layerChunkProgressInfo;i.numVisibleChunksAvailable=t.numVisibleChunksAvailable,i.numVisibleChunksNeeded=t.numVisibleChunksNeeded,i.numPrefetchChunksAvailable=t.numPrefetchChunksAvailable,i.numPrefetchChunksNeeded=t.numPrefetchChunksNeeded,e.prevStatisticsLayers.push(i)}e.layerChunkStatisticsUpdated.dispatch()});var Od=class extends gn{constructor(e){super();this.chunkQueueManager=e;this.memoize=new vd;this.prevStatisticsLayers=[];this.layerChunkStatisticsUpdated=new ae;this.registerDisposer(e.addRef()),this.initializeCounterpart(e.rpc,{chunkQueueManager:e.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(e,t){let r=e.encodeOptions(t);r.constructorId=ct(e);let i=Hn(r);return this.memoize.get(i,()=>{let a=new e(this,t);return a.initializeCounterpart(this.rpc,{}),a.key=r,a})}};Od=Lt([yn(CD)],Od);var jn=class extends gn{constructor(e,t={}){super();this.chunkManager=e;this.chunks=new Map;this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){let t=this.chunks.get(e);t.state===nt.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke(wD,{id:this.rpcId})}static encodeOptions(e){return{}}};function Qe(n,e){let t=class extends n{constructor(...i){super(...i);let a=i[1];this.parameters=a.parameters}initializeCounterpart(i,a){a.parameters=this.parameters,super.initializeCounterpart(i,a)}static encodeOptions(i){return Object.assign({parameters:i.parameters},super.encodeOptions(i))}};return t=Lt([yn(e.RPC_ID)],t),t}var La=class extends gn{constructor(e){super();this.layerChunkProgressInfo=e}};var qt;(function(i){i[i.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",i[i.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",i[i.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",i[i.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED"})(qt||(qt={}));var Zs=class{},el=class extends j{constructor(e,t,r){super();this.graph=e;this.segmentsState=t;this.transform=r}createRenderLayers(e,t,r){return[]}};function kc(n){return!(n.high>>>31)}var zS=new X(4294967295,4294967295);var DD=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function AD(n,e,t){n.registerDisposer(e.visibleSegments.changed.add(t)),n.registerDisposer(e.segmentEquivalences.changed.add(t))}function ID(n,e,t){n.registerDisposer(e.temporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.temporarySegmentEquivalences.changed.add(t)),n.registerDisposer(e.useTemporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.useTemporarySegmentEquivalences.changed.add(t))}function Nr(n){return`${n.low},${n.high}`}function fz(n){return!!(n.high>>>31)}function HS(n){return n.useTemporaryVisibleSegments.value?n.temporaryVisibleSegments:n.visibleSegments}function hz(n){return n.useTemporarySegmentEquivalences.value?n.temporarySegmentEquivalences:n.segmentEquivalences}function Ea(n,e){let t=HS(n),r=hz(n);if(r.disjointSets){let i=r.disjointSets.visibleSegmentEquivalencePolicy.value;for(let a of t.unsafeKeys())if(i&qt.NONREPRESENTATIVE_EXCLUDED){let o=r.get(a);e(a,o)}else{if(r.disjointSets===void 0||!r.disjointSets.isMinElement(a))continue;for(let o of r.setElements(a))i&qt.REPRESENTATIVE_EXCLUDED&&i&qt.MAX_REPRESENTATIVE&&fz(o)||e(o,a)}}}var FD=at(It());var $S=at(It());var MD="rendered_view.addLayer",RD="rendered_view.removeLayer",_D="SharedProjectionParameters",VD="SharedProjectionParameters.changed";var Cr;(function(r){r[r.info=0]="info",r[r.warning=1]="warning",r[r.error=2]="error"})(Cr||(Cr={}));var Gi=class{constructor(){this.changed=new ae;this.messages=[];this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){let{messages:e}=this;e.length!==0&&(e.length=0,this.changed.dispatch())}isEmpty(){return this.messages.length===0&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{let{children:t}=this;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[Symbol.iterator](){yield*this.messages;for(let e of this.children)yield*e}};var or;(function(r){r[r.DATA=0]="DATA",r[r.ANNOTATION=1]="ANNOTATION",r[r.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION"})(or||(or={}));function OD(){return new yv([0,1,2])}var zh=class extends j{constructor(){super(...arguments);this.role=0;this.messages=new Gi;this.layerChanged=new ae;this.redrawNeeded=new ae;this.layerChunkProgressInfo=new fo}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,r,i){}},Nd=class extends zh{constructor(){super(...arguments);this.visibility=new so}attach(e){}};function es(n,e,t){let{state:r}=t;if(r===void 0||r.transform!==n||r.displayDimensionRenderInfo!==e){if(t.messages.clearMessages(),r=t.state={transform:n,displayDimensionRenderInfo:e,modelTransform:void 0},n.error!==void 0){t.messages.addMessage({severity:Cr.error,message:n.error});return}try{let i=re.create();XE(i,e,n),r.modelTransform=i}catch(i){t.messages.addMessage({severity:Cr.error,message:i.message})}}return r.modelTransform}var Bd=class extends j{constructor(e){super();this.renderViewport=new fc;this.changed=new Me;let{parametersConstructor:t=Sd,navigationState:r,update:i,isEqual:a=VE}=e;this.oldValue_=new t,this.value_=new t;let o=()=>{let{oldValue_:c,value_:d}=this;c.displayDimensionRenderInfo=r.displayDimensionRenderInfo.value,Object.assign(c,this.renderViewport);let{globalPosition:p}=c,m=r.position.value,y=m.length;p.length!==y&&(c.globalPosition=p=new Float32Array(y)),p.set(m),i(c,r),!a(c,d)&&(this.value_=c,this.oldValue_=d,this.changed.dispatch(d,c))},l=this.update=this.registerCancellable((0,$S.default)(o,0));this.registerDisposer(r.changed.add(l)),o()}setViewport(e){mh(e,this.renderViewport)||(Object.assign(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}},tl=class extends gn{constructor(e,t,r=10){super();this.base=t;this.updateInterval=r;this.prevDisplayDimensionRenderInfo=void 0;this.update=this.registerCancellable((0,$S.default)((e,t)=>{let r;if(t.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo)r=t,this.prevDisplayDimensionRenderInfo=t.displayDimensionRenderInfo;else{let{displayDimensionRenderInfo:i,...a}=t;r=a}this.rpc.invoke(VD,{id:this.rpcId,value:r})},this.updateInterval));this.initializeCounterpart(e,{value:t.value}),this.registerDisposer(t.changed.add(this.update))}flush(){this.update.flush()}};tl=Lt([yn(_D)],tl);var nn=40,ND=.5,BD=-4;function Ud(n){return(Math.log2(n)-BD)/ND}function UD(n){return 2**(n*ND+BD)}function Wi(n){return new ht(n,St)}var Pa=class{constructor(){this.visibility=new so;this.changed=new ae;this.frameNumber=-1;this.spatialScales=new Map;this.numHistogramRows=1;this.value=new Uint32Array(nn*this.numHistogramRows*2)}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.changed.dispatch())}add(e,t,r,i){let{spatialScales:a,numHistogramRows:o,value:l}=this,c=a.get(e);if(c===void 0&&(c=a.size,a.set(e,c)),c>=o){this.numHistogramRows=o*=2;let p=new Uint32Array(o*nn*2);p.set(l),this.value=l=p}let d=c*nn*2+Math.min(Math.max(0,Math.round(Ud(t))),nn-1);l[d]+=r,l[d+nn]+=i}};var Lc=class extends zh{constructor(e,t,r){super();this.chunkManager=e;this.multiscaleSource=t;this.rpcId=null;this.rpcTransfer={};this.visibleSources=new Map;this.visibleSourcesList_=[];var a;let{renderScaleTarget:i=Wi(1)}=r;this.renderScaleTarget=i,this.renderScaleHistogram=r.renderScaleHistogram,this.transform=r.transform,this.localPosition=r.localPosition,this.rpcTransfer=r.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer((a=r.dataHistogramSpecifications)!=null?a:new Dd(qr([]),qr([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){let{dataHistogramSpecifications:e}=this;return e.visibility.visible?e.bounds.value.length:0}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){let{visibleSources:r}=this,i=r.get(e);i!==void 0?(++i.refCount,i.chunkTransform=t):(r.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){let{visibleSources:t}=this,r=t.get(e);r.refCount!==1?--r.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){let{visibleSources:e,visibleSourcesList_:t}=this;if(t.length===0&&e.size!==0){for(let r of e.values())t.push(r);t.sort((r,i)=>r.chunkTransform.chunkToLayerTransformDet-i.chunkTransform.chunkToLayerTransformDet)}return t}initializeCounterpart(){let e=this.registerDisposer(new La(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,{localPosition:this.registerDisposer(gt.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(gt.makeFromExisting(t,this.renderScaleTarget)).rpcId,...this.rpcTransfer}),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return cP(e,this,t)}};Lc.prototype.RPC_TYPE_ID=dP;var pi=class extends Nd{draw(e,t){}isReady(e,t){return!0}};var GD=class extends bS{},mz=va(GD);function gz(n){return{source:n.source.addCounterpartRef(),effectiveVoxelSize:n.effectiveVoxelSize,layerRank:n.layerRank,nonDisplayLowerClipBound:n.nonDisplayLowerClipBound,nonDisplayUpperClipBound:n.nonDisplayUpperClipBound,lowerClipBound:n.lowerClipBound,upperClipBound:n.upperClipBound,lowerClipDisplayBound:n.lowerClipDisplayBound,upperClipDisplayBound:n.upperClipDisplayBound,chunkDisplayDimensionIndices:n.chunkDisplayDimensionIndices,lowerChunkDisplayBound:n.lowerChunkDisplayBound,upperChunkDisplayBound:n.upperChunkDisplayBound,fixedLayerToChunkTransform:n.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:n.combinedGlobalLocalToChunkTransform,chunkLayout:n.chunkLayout.toObject()}}function nl(n){return n.map(e=>e.map(gz))}function jS(n,e){for(let t of e)for(let{source:r}of t)n.removeSource(r),r.dispose()}var Ec=class extends mz{constructor(e,t,r,i){super(new Bd({parametersConstructor:SS,navigationState:r,update:(l,c)=>{let{invViewMatrix:d,centerDataPosition:p}=l;c.toMat4(d);let{canonicalVoxelFactors:m,voxelPhysicalScales:y}=l.displayDimensionRenderInfo;for(let I=0;I<3;++I)p[I]=d[12+I];let{logicalWidth:v,logicalHeight:b,projectionMat:x,viewportNormalInGlobalCoordinates:C,viewportNormalInCanonicalCoordinates:k}=l,{relativeDepthRange:D}=c;re.ortho(x,-v/2,v/2,b/2,-b/2,-D,D),hh(l,x),bh(l);let{viewMatrix:P}=l;for(let I=0;I<3;++I){let E=C[I]=P[I*4+2];k[I]=E/m[I]}J.normalize(C,C),J.normalize(k,k);let M=0;for(let I=0;I<3;++I){let E=y[I],_=d[I];M+=(E*_)**2}M=Math.sqrt(M),l.pixelSize=M}}));this.chunkManager=e;this.layerManager=t;this.navigationState=r;this.wireFrame=i;this.gl=this.chunkManager.gl;this.viewChanged=new ae;this.renderingStale=!0;this.visibleChunksStale=!0;this.visibleLayerList=new Array;this.offscreenFramebuffer=this.registerDisposer(new Bi(this.gl,{colorBuffers:Ks(this.gl,1),depthBuffer:new DS(this.gl)}));this.histogramInputTextures=[];this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer];this.histogramGenerator=Ad.get(this.gl);this.updateVisibleLayers=this.registerCancellable((0,FD.default)(()=>{this.updateVisibleLayersNow()},0));this.registerDisposer(r),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((l,c)=>{l.displayDimensionRenderInfo!==c.displayDimensionRenderInfo&&this.updateVisibleLayers()}));let a=this.chunkManager.rpc,o=this.sharedProjectionParameters=this.registerDisposer(new tl(a,this.projectionParameters));this.initializeCounterpart(a,{chunkManager:e.rpcId,projectionParameters:o.rpcId}),this.registerDisposer(t.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(e.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(e,t){this.histogramGenerator.compute(e,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,t,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(e,t,r){yP(this.projectionParameters.value,e.renderLayer.localPosition.value,e,t,()=>{r(e.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let e=0,t=0;for(let{visibleSources:r}of this.visibleLayers.values())for(let i of r){let a=xc(this.projectionParameters.value,i.chunkLayout),{source:o}=i,{chunks:l}=o;this.forEachVisibleChunk(i,a,c=>{let d=l.get(c);++t,d&&d.state===nt.GPU_MEMORY&&++e})}return e===t}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(e,t){t.push(e.localPosition.changed.add(()=>this.invalidateVisibleChunks())),t.push(e.redrawNeeded.add(this.viewChanged.dispatch)),t.push(e.transform.changed.add(this.updateVisibleLayers)),t.push(e.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));let{renderScaleHistogram:r}=e;r!==void 0&&t.push(r.visibility.add(this.visibility)),t.push(e.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;let e=Date.now(),{visibleLayers:t,visibleLayerList:r}=this,{displayDimensionRenderInfo:i}=this.projectionParameters.value,a=this.rpc,o={id:this.rpcId},l=!1;r.length=0;for(let c of this.layerManager.readyRenderLayers())if(c instanceof Lc){r.push(c);let d=t.get(c);if(d===void 0){let p=[],m=new Gi;d={messages:m,allSources:this.getTransformedSources(c,m),transformGeneration:c.transform.changed.count,visibleSources:[],disposers:p,lastSeenGeneration:e,displayDimensionRenderInfo:i},p.push(c.messages.addChild(d.messages)),t.set(c.addRef(),d),this.bindVisibleRenderLayer(c,p)}else{d.lastSeenGeneration=e;let p=c.transform.changed.count;if(d.transformGeneration===p&&d.displayDimensionRenderInfo===i)continue;let m=d.allSources;d.allSources=this.getTransformedSources(c,d.messages),jS(c,m),d.visibleSources.length=0,d.displayDimensionRenderInfo=i,d.transformGeneration=p}o.layerId=c.rpcId,o.sources=nl(d.allSources),this.flushBackendProjectionParameters(),a.invoke(pP,o),l=!0}for(let[c,d]of t)d.lastSeenGeneration!==e&&(o.layerId=c.rpcId,a.invoke(fP,o),t.delete(c),jS(c,d.allSources),Xa(d.disposers),c.dispose(),l=!0);return l&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),l}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(e){let{offscreenFramebuffersWithHistograms:t}=this,r=t[e];if(r===void 0){let{gl:i,histogramInputTextures:a,offscreenFramebuffer:o}=this;a.length<e&&a.push(...Ks(i,e-a.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let l=[o.colorBuffers[0].addRef()];for(let c=0;c<e;++c)l.push(a[c].addRef());r=this.registerDisposer(new Bi(i,{colorBuffers:l,depthBuffer:o.depthBuffer.addRef()})),t[e]=r}return r}updateRendering(){let e=this.projectionParameters.value,{width:t,height:r}=e;if(!this.renderingStale||!this.valid||t===0||r===0)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let{gl:i,offscreenFramebuffer:a}=this;a.bind(t,r),i.disable(i.SCISSOR_TEST),i.clearColor(0,0,0,0),i.colorMask(!0,!0,!0,!0),i.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let o=0,l=this.wireFrame.value,c={sliceView:this,projectionParameters:e,wireFrame:l};for(let d of this.visibleLayerList){let p=l?0:d.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(p).bind(t,r);for(let y=0;y<p;++y)i.clearBufferfv(WebGL2RenderingContext.COLOR,1+y,ld);i.enable(WebGL2RenderingContext.DEPTH_TEST),i.depthFunc(WebGL2RenderingContext.LESS),i.clearDepth(1),i.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),d.setGLBlendMode(i,o),d.draw(c),++o}i.disable(WebGL2RenderingContext.BLEND),i.disable(WebGL2RenderingContext.DEPTH_TEST),a.unbind()}disposed(){for(let[e,t]of this.visibleLayers)jS(e,t.allSources),Xa(t.disposers),e.dispose();this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(e,t){let r=al(this.projectionParameters.value.displayDimensionRenderInfo,e.transform.value,i=>e.getSources(i),t,e);for(let i of r)for(let a of i)e.addSource(a.source,a.chunkTransform);return r}};Ec=Lt([yn(uP)],Ec);var rl=class extends jn{constructor(e,t){super(e,t);this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Array.from(e.chunkDataSize),lowerVoxelBound:Array.from(e.lowerVoxelBound),upperVoxelBound:Array.from(e.upperVoxelBound)}}static encodeOptions(e){let t=super.encodeOptions(e);return t.spec=this.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}},Fd=class extends xr{constructor(e,t){super(e);this.chunkGridPosition=t.chunkGridPosition,this.state=nt.SYSTEM_MEMORY}},il=class extends j{constructor(e,t){super();this.gl=e;this.copyVertexPositionsBuffer=Yo(this.gl);this.textureCoordinateAdjustment=new Float32Array(4);let r=new Zr(e);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler"),r.addInitializer(i=>{e.uniform1i(i.uniform("uSampler"),0)}),r.addUniform("vec4","uColorFactor"),r.addUniform("vec4","uBackgroundColor"),r.addUniform("mat4","uProjectionMatrix"),r.addUniform("vec4","uTextureCoordinateAdjustment"),r.require(t),r.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),r.addAttribute("vec4","aVertexPosition"),r.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(r.build())}draw(e,t,r,i,a,o,l,c){let{gl:d,shader:p,textureCoordinateAdjustment:m}=this;m[0]=a,m[1]=o,m[2]=l-a,m[3]=c-o,p.bind(),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,e),d.disable(WebGL2RenderingContext.BLEND),d.uniformMatrix4fv(p.uniform("uProjectionMatrix"),!1,t),d.uniform4fv(p.uniform("uColorFactor"),r),d.uniform4fv(p.uniform("uBackgroundColor"),i),d.uniform4fv(p.uniform("uTextureCoordinateAdjustment"),m);let y=p.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(y,2),d.drawArrays(d.TRIANGLE_FAN,0,4),d.disableVertexAttribArray(y),d.bindTexture(d.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${ct(t)}`,()=>new il(e,t))}},qS=class{constructor(e){this.chunkManager=e}};function al(n,e,t,r,i){r.clearMessages();let a=k=>(r.addMessage({severity:Cr.error,message:k}),[]);if(e.error!==void 0)return a(e.error);let o=e.rank,l=e.unpaddedRank,{displayDimensionIndices:c,displayRank:d,canonicalVoxelFactors:p}=n,m=Ih(e,c),{displayToLayerDimensionIndices:y}=m,v=new Float32Array(d*l),{modelToRenderLayerTransform:b}=e;for(let k=0;k<d;++k){let D=y[k];if(D===-1)continue;let P=p[k];for(let M=0;M<l;++M)v[d*M+k]=b[(o+1)*M+D]*P}let x=t({displayRank:d,multiscaleToViewTransform:v,modelChannelDimensionIndices:e.channelToRenderLayerDimensions}),{voxelPhysicalScales:C}=n;try{let k=D=>{let{chunkSource:P}=D,{spec:M}=P,{lowerClipBound:I=M.lowerVoxelBound,upperClipBound:E=M.upperVoxelBound}=D,_=Sc(e,D.chunkToMultiscaleTransform),{chunkDataSize:O}=M,{channelToChunkDimensionIndices:B}=_,W=new Float32Array(l),V=new Float32Array(l);W.set(I),V.set(E);let U=B.length,{channelSpaceShape:N}=e;for(let et=0;et<U;++et){let Ie=B[et];if(Ie===-1)continue;let lt=N[et];if(O[Ie]!==lt)throw new Error("Channel dimension "+e.layerDimensionNames[e.channelToRenderLayerDimensions[et]]+` has extent ${lt} but corresponding chunk dimension has extent ${O[Ie]}`);W[Ie]=Number.NEGATIVE_INFINITY,V[Ie]=Number.POSITIVE_INFINITY}let q=Mh(_,m),ne=J.create(),pe=J.create(),me=J.create(),Pe=J.create(),se=J.create(),{numChunkDisplayDims:Te,chunkDisplayDimensionIndices:Ae}=q,{combinedGlobalLocalToChunkTransform:Be,layerRank:Ze,combinedGlobalLocalRank:ge}=_,Le=new Float32Array(Be);for(let et=0;et<Te;++et){let Ie=Ae[et];for(let lt=0;lt<=ge;++lt)Le[Ie+lt*Ze]=0;Ie<l?(se[et]=M.chunkDataSize[Ie],ne[et]=M.lowerChunkBound[Ie],pe[et]=M.upperChunkBound[Ie],me[et]=I[Ie],Pe[et]=E[Ie],W[Ie]=Number.NEGATIVE_INFINITY,V[Ie]=Number.POSITIVE_INFINITY):(se[et]=1,ne[et]=0,pe[et]=1,me[et]=0,Pe[et]=1)}se.fill(1,Te),ne.fill(0,Te),pe.fill(1,Te),me.fill(0,Te),Pe.fill(1,Te);let We=new qs(se,q.displaySubspaceModelMatrix,Te),je=We.localSpatialVectorToGlobal(J.create(),Jf);for(let et=0;et<d;++et)je[et]=Math.abs(je[et]*C[et]);return je.fill(1,d),{layerRank:Ze,lowerClipBound:I,upperClipBound:E,nonDisplayLowerClipBound:W,nonDisplayUpperClipBound:V,renderLayer:i,source:P,lowerChunkDisplayBound:ne,upperChunkDisplayBound:pe,lowerClipDisplayBound:me,upperClipDisplayBound:Pe,effectiveVoxelSize:je,chunkLayout:We,chunkDisplayDimensionIndices:Ae,fixedLayerToChunkTransform:Le,curPositionInChunks:new Float32Array(l),combinedGlobalLocalToChunkTransform:_.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(l),chunkTransform:_,chunkDisplayTransform:q}};return x.map(D=>D.map(P=>k(P)))}catch(k){for(let I of x)for(let{chunkSource:E}of I)E.dispose();let{globalDimensionNames:D}=n,M=`Cannot render (${Array.from(n.displayDimensionIndices.filter(I=>I!==-1),I=>D[I]).join(",\xA0")}) cross section: ${k.message}`;return a(M)}}var ol=null,yz=200,Ce=class{constructor(e=!1){if(ol===null){ol=document.createElement("ul"),ol.id="statusContainer";let r=document.getElementById("neuroglancer-container");r?r.appendChild(ol):document.body.appendChild(ol)}let t=document.createElement("li");this.element=t,e===!0&&(e=yz),e!==!1?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,ol.appendChild(t)}dispose(){ol.removeChild(this.element),this.element=void 0,this.timer!==null&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){let r=new Ce(t.delay);r.setText(t.initialMessage);let i=r.dispose.bind(r);return e.then(i,a=>{let o;a instanceof Error?o=a.message:o=""+a;let{errorPrefix:l=""}=t;r.setErrorMessage(l+o),r.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){let t=new Ce;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){let r=this.showMessage(e);return window.setTimeout(()=>r.dispose(),t),r}};var WD=!1;function JS(n){let e=0,{typeToIds:t}=n;for(let r of Ri)e+=Qo(r).pickIdsPerInstance*t[r].length;return e}var KS=class{constructor(e){this.bufferValid=!1;this.numPickIds=0;this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){let{buffer:t}=this;t!==void 0&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}},zD=class extends xr{constructor(e,t){super(e);t.data!==void 0&&(this.data=new KS(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}},YS=class extends Fd{constructor(e,t){super(e,t);t.data!==void 0&&(this.data=new KS(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}},zi=class extends rl{constructor(e,t){super(e,t);this.immediateChunkUpdates=!0;(this.parent=t.parent).spatiallyIndexedSources.add(this);let{rank:i,chunkDataSize:a}=this.spec,o=this.multiscaleToChunkTransform=new Float32Array((i+1)**2);mc(o,i+1,this.spec.chunkToMultiscaleTransform,i+1,i+1);for(let l=0;l<i;++l)for(let c=0;c<i+1;++c)o[(i+1)*c+l]/=a[l]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(e,t){t.parent=this.parent.rpcId,super.initializeCounterpart(e,t)}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new YS(this,e)}};zi=Lt([yn(SP)],zi);var Hh=class extends jn{constructor(e,t,r){super(e,{});this.parent=t;this.relationshipIndex=r;this.immediateChunkUpdates=!0}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new zD(this,e)}};Hh=Lt([yn(bP)],Hh);var HD=class extends xr{constructor(e,t){super(e);this.annotation=yd(t.annotation)}},$h=class extends jn{constructor(e,t){super(e);this.parent=t}getChunk(e){return new HD(this,e)}addChunk(e,t){super.addChunk(e,t);let{references:r}=this.parent,i=r.get(e);i!==void 0&&(i.value=t.annotation,i.changed.dispatch())}deleteChunk(e){let{references:t}=this.parent,r=t.get(e);r!==void 0&&(r.value=void 0,r.changed.dispatch())}};$h=Lt([yn(vP)],$h);function $D(n,e,t,r){let i=new Uint8Array(n.data.length+r);for(let a of Ri){if(a===t)continue;let o=n.typeToOffset[a],l=o;a>t&&(l+=r,n.typeToOffset[a]=l),i.set(n.data.subarray(o,o+n.typeToIds[a].length*e[a].serializedBytes),l)}return i}function XS(n,e,t,r,i,a,o,l){let c=n.typeToOffset[t],d=c,p=c,{propertyGroupBytes:m}=e[t],y=m.length,v=n.typeToIds[t].length;for(let b=0;b<y;++b){let x=m[b];r.set(n.data.subarray(d+i*x,d+a*x),p+o*x),d+=x*v,p+=x*l}}function jh(n,e,t){let r=e.type,{rank:i}=t[r],{serializedAnnotations:a}=n,o=a.typeToIds[r],l=a.typeToIdMaps[r],c=An[r],d=t[r].serializedBytes,p=l.get(e.id);if(p===void 0){p=l.size,l.set(e.id,p);let x=$D(a,t,r,d);XS(a,t,r,x,0,p,0,p+1),o.push(e.id),a.data=x}let m=a.typeToOffset[r],y=new DataView(a.data.buffer,a.data.byteOffset,a.data.byteLength),v=ma===mn.LITTLE,b=t[r];c.serialize(y,m+b.propertyGroupBytes[0]*p,v,i,e),b.serialize(y,m,p,o.length,v,e.properties),n.bufferValid=!1}function qh(n,e,t,r){let{serializedAnnotations:i}=n,a=i.typeToIdMaps[e],o=a.get(t);if(o===void 0)return!1;let l=i.typeToIds[e],c=r[e].serializedBytes,d=$D(i,r,e,-c);XS(i,r,e,d,0,o,0,l.length-1),XS(i,r,e,d,o+1,l.length,o,l.length-1),l.splice(o,1),a.delete(t);for(let p=o,m=l.length;p<m;++p)a.set(l[p],p);return i.data=d,n.bufferValid=!1,!0}function vz(){let n=[],e=[],t=[];for(let r of Ri)n[r]=[],e[r]=0,t[r]=new Map;return new YS(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:e,typeToIds:n,typeToIdMaps:t})}var vn=class extends gn{constructor(e,t){super();this.chunkManager=e;this.metadataChunkSource=this.registerDisposer(new $h(this.chunkManager,this));this.spatiallyIndexedSources=new Set;this.temporary=vz();this.references=new Map;this.localUpdates=new Map;this.numCommitsInProgress=0;this.changed=new ae;this.referencesChanged=new Me;this.readonly=!1;this.childRefreshed=new ae;this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializers=sh(this.rank,this.properties);let r=this.segmentFilteredSources=[],{relationships:i}=t;this.relationships=i;for(let a=0,o=i.length;a<o;++a)r.push(this.registerDisposer(new Hh(e,this,a)));WD&&this.referencesChanged.add(a=>{console.log("annotation references changed:",a)})}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(let r of this.segmentFilteredSources)r.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(r=>r.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=ph();let r=new pc(e.id);return r.value=e,this.references.set(r.id,r),this.referencesChanged.dispatch({action:"adding",id:r.id}),r.registerDisposer(()=>{this.references.delete(r.id),this.referencesChanged.dispatch({action:"deref",id:r.id})}),this.applyLocalUpdate(r,!1,t,e),r}applyLocalUpdate(e,t,r,i){let{localUpdates:a}=this,{id:o}=e,l=this.localUpdates.get(o),c=e.value;if(c==null)throw new Error("Cannot create local update from null annotation");if(l===void 0?(l={type:c.type,reference:e.addRef(),existingAnnotation:t?c:void 0,pendingCommit:void 0,commitInProgress:void 0},a.set(o,l),this.forEachPossibleChunk(c,d=>{let{data:p}=d;if(p===void 0)return;let m=c.type;qh(p,m,o,this.annotationPropertySerializers)}),i!==null&&jh(this.temporary.data,i,this.annotationPropertySerializers)):(i===null?qh(this.temporary.data,c.type,c.id,this.annotationPropertySerializers):jh(this.temporary.data,i,this.annotationPropertySerializers),e.value=i),r)if(l.commitInProgress!==void 0)l.pendingCommit=i;else{if(i===null&&l.existingAnnotation===void 0){a.delete(o),l.reference.dispose();return}this.sendCommitRequest(l,i)}this.notifyChanged(e.id,i||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke(wP,{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){let r=this.references.get(e),i=this.metadataChunkSource.chunks.get(e);i!==void 0&&(i.annotation=t||null),r!==void 0&&(r.value=t||null,r.changed.dispatch(),this.referencesChanged.dispatch({action:"changed",id:e})),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}updateReference(e){let t=this.references.get(e.id);if(t!==void 0)t.value=e;else{let r=new pc(e.id);this.references.set(e.id,r),r.value=e,this.referencesChanged.dispatch({action:"update",id:r.id}),r.registerDisposer(()=>{this.references.delete(r.id),this.referencesChanged.dispatch({action:"deref",id:r.id})})}}hasReference(e){return this.references.has(e)}getReference(e){let t=this.references.get(e);if(t!==void 0)return t.addRef();t=new pc(e),this.references.set(e,t),this.referencesChanged.dispatch({action:"get",id:e}),this.rpc.invoke(xP,{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.referencesChanged.dispatch({action:"deref",id:e}),this.rpc.invoke(CP,{id:this.rpcId,annotation:e})});let r=this.metadataChunkSource.chunks.get(e);return r!==void 0&&r.annotation!==null&&(t.value=r.annotation),t}forEachPossibleChunk(e,t){let{relatedSegments:r}=e;if(r!==void 0){let c=r.length,{segmentFilteredSources:d}=this;for(let p=0;p<c;++p){let m=r[p];if(m===void 0)return;let y=d[p];for(let v of m){let b=y.chunks.get(Nr(v));b!==void 0&&t(b)}}}let{rank:i}=this,a=new Float32Array(i),o=new Float32Array(i),l=new Float32Array(i);for(let c of this.spatiallyIndexedSources){switch(e.type){case be.POINT:Xr(a,c.multiscaleToChunkTransform,i+1,e.point,i),o.set(a);break;case be.LINE:case be.SPHERE:case be.AXIS_ALIGNED_BOUNDING_BOX:Xr(a,c.multiscaleToChunkTransform,i+1,e.pointA,i),Xr(o,c.multiscaleToChunkTransform,i+1,e.pointB,i);break;case be.ELLIPSOID:Xr(a,c.multiscaleToChunkTransform,i+1,e.center,i),Ch(o,c.multiscaleToChunkTransform,i+1,e.radii,i);for(let m=0;m<i;++m){let y=a[m],v=o[m];a[m]=y-v,o[m]=y+v}break}let d=1;for(let m=0;m<i;++m){let y=a[m],v=o[m],b=Math.min(y,v),x=Math.max(y,v);a[m]=Math.ceil(b-1),o[m]=Math.floor(x+1),d*=o[m]-a[m]}let{chunks:p}=c;for(let m=0;m<d;++m){let y=m;for(let b=0;b<i;++b){let x=a[b],k=o[b]-x,D=l[b]=y%k;y=(y-D)/k}let v=p.get(l.join());v!==void 0&&t(v)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){let r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),t!==null&&r.reference.id!==t.id){if(r.commitInProgress===null)throw new Error("Received invalid successful update notification");r.reference.id=t.id,this.references.delete(e),this.references.set(t.id,r.reference.addRef()),this.localUpdates.delete(e),this.localUpdates.set(t.id,r),r.reference.value!==null&&(r.reference.value.id=t.id,qh(this.temporary.data,r.type,e,this.annotationPropertySerializers),jh(this.temporary.data,r.reference.value,this.annotationPropertySerializers)),r.reference.changed.dispatch()}let i=r.existingAnnotation===void 0;r.existingAnnotation=t||void 0,r.commitInProgress=void 0;let{pendingCommit:a}=r;r.pendingCommit=void 0,t===null&&(a=void 0),a!==void 0?(a!==null&&(a.id=t.id),this.sendCommitRequest(r,a)):(this.revertLocalUpdate(r),i?(this.childAdded.dispatch(t),this.referencesChanged.dispatch({action:"added",id:t.id})):t===null?(this.references.get(e).dispose(),this.childDeleted.dispatch(e),this.referencesChanged.dispatch({action:"deleted",id:e})):(this.childUpdated.dispatch(t),this.referencesChanged.dispatch({action:"updated",id:t.id})))}disposed(){let{commitStatus:e}=this;e!==void 0&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,this.numCommitsInProgress===0?this.commitStatus!==void 0&&(this.commitStatus.dispose(),this.commitStatus=void 0):this.commitStatus===void 0&&(this.commitStatus=new Ce(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){let r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid update notification");new Ce().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(r),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){qh(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);let{existingAnnotation:t}=e;t!==void 0&&this.forEachPossibleChunk(t,a=>{let{data:o}=a;o!==void 0&&jh(o,t,this.annotationPropertySerializers)});let{reference:r}=e,{id:i}=r;r.value=t||null,r.changed.dispatch(),r.dispose(),this.localUpdates.delete(i),WD&&console.log("#references",this.references.size)}*[Symbol.iterator](){}};bt(TP,function(n){let e=this.get(n.id),t=n.annotationId,r=n.error;if(r!==void 0)e.handleFailedUpdate(t,r);else{let i=yd(n.newAnnotation);e.handleSuccessfulUpdate(t,i)}});var jD="CredentialsProvider",qD="CredentialsProvider.get";var Gd=class extends gn{constructor(e,t){super();this.provider=e;this.registerDisposer(e),this.initializeCounterpart(t)}get(e,t){return this.provider.get(e,t)}};Gd=Lt([yn(jD)],Gd);_h(qD,function(n,e){return this.get(n.providerId).get(n.invalidCredentials,e).then(r=>({value:r}))});function Wd(n,e){if(e===void 0)return;let t=n.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:ct(e)},()=>new Gd(e.addRef(),n.rpc)),r=t.addCounterpartRef();return t.dispose(),r}function rt(){return function(n){class e extends n{constructor(...r){super(...r);var a;let i=r[1];this.credentialsProvider=(a=i.credentialsProvider)==null?void 0:a.addRef()}initializeCounterpart(r,i){let{credentialsProvider:a}=this;i.credentialsProvider=Wd(this.chunkManager,a),super.initializeCounterpart(r,i)}static encodeOptions(r){let i=super.encodeOptions(r),{credentialsProvider:a}=r;return i.credentialsProvider=a===void 0?void 0:ct(a),i}}return e}}function ho(n,e){return n<e?-1:n>e?1:0}var JD={offset:0,completions:[]};function Br(n,e){return e.offset+=n,e}function Jh(n,e){let t=[];for(let r of e)r.startsWith(n)&&t.push({value:r});return t.sort((r,i)=>ho(r.value,i.value)),t}function rn(n,e,t,r){let i=[];for(let a of e){let o=t(a);o.startsWith(n)&&i.push({value:o,description:r(a)})}return i.sort((a,o)=>ho(a.value,o.value)),i}async function Sz(n,e,t){if(n.startsWith("{"))return JD;let i=n.match(/^(?:(.*)[&;])?([^&;]*)$/)[2],a=n.length-i.length,o=i.indexOf("=");if(o===-1){let l=await e(i);return{offset:l.offset+a,completions:l.completions.map(c=>({...c,value:`${c.value}=`}))}}return Br(a+o+1,await t(i.substring(0,o),i.substring(o+1)))}async function Kh(n,e){return Sz(n,async t=>{let r=[];for(let i of e){let a=i.key;a.value.startsWith(t)&&r.push(a)}return{offset:0,completions:r}},async(t,r)=>{for(let i of e)if(i.key.value===t)return{offset:0,completions:i.values.filter(a=>a.value.startsWith(r))};return JD})}var Pc=class extends Error{constructor(e){super(`Redirected to: ${e}`);this.redirectTarget=e}};function KD(n,e){e===void 0&&(n.indexOf("/")===-1?e=":":e="/");let t=n.lastIndexOf(e);return t===-1?0:t+1}function bz(n,e){let t=KD(n,e);return n.substring(t)}var fi;(function(t){t[t.annotations=0]="annotations",t[t.equivalences=1]="equivalences"})(fi||(fi={}));function Yh(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new Map}}var Rt=class extends j{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}},QS="local://annotations",Xh="local://equivalences",YD=class extends Rt{get description(){return"Local in-memory"}async get(e){switch(e.url){case QS:{let{transform:t}=e,r;if(t===void 0){let i=e.globalCoordinateSpace.value,{rank:a,names:o,scales:l,units:c}=i,d=Ne({rank:a,scales:l,units:c,names:o.map((m,y)=>`${y}`)}),p=Ne({rank:a,scales:l,units:c,names:o});r={rank:a,sourceRank:a,inputSpace:d,outputSpace:p,transform:rr(Float64Array,a+1)}}else r=mt(Vi);return{modelTransform:r,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:0}}]}}case Xh:return{modelTransform:mt(Vi),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:1}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:rn(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],t=>t.value,t=>t.description)}}},XD=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/,ZS=class extends j{constructor(e){super();this.credentialsManager=e;this.dataSources=new Map([["local",new YD]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){let t=e.match(XD);if(t===null||t[1]===void 0)throw new Error('Data source URL must have the form "<protocol>://<path>".');let[,r,i]=t,a=this.dataSources.get(r);if(a===void 0)throw new Error(`Unsupported data source: ${JSON.stringify(r)}.`);return[a,i,r]}async get(e){let t=new Set,{cancellationToken:r=Je}=e,i=e.url;for(;;){let[a,o,l]=this.getProvider(e.url);t.add(e.url);try{return a.get({...e,url:i,providerProtocol:l,providerUrl:o,registry:this,cancellationToken:r,credentialsManager:this.credentialsManager})}catch(c){if(c instanceof Pc){let d=c.redirectTarget;if(t.has(d))throw Error(`Layer source redirection contains loop: ${JSON.stringify(Array.from(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${JSON.stringify(Array.from(t))}`);i=d;continue}throw c}}}convertLegacyUrl(e){try{let[t,r,i]=this.getProvider(e.url);return t.convertLegacyUrl({...e,providerUrl:r,providerProtocol:i,registry:this})}catch{return e.url}}normalizeUrl(e){try{let[t,r,i]=this.getProvider(e.url);return t.normalizeUrl({...e,providerUrl:r,providerProtocol:i,registry:this})}catch{return e.url}}async completeUrl(e){let{url:t,cancellationToken:r=Je}=e,i=t.match(XD),a=i[1];if(a===void 0)return Promise.resolve({offset:0,completions:rn(t,this.dataSources,([o])=>`${o}://`,([,o])=>o.description)});{let o=this.dataSources.get(a);if(o!==void 0){let l=await o.completeUrl({registry:this,url:t,providerUrl:i[2],chunkManager:e.chunkManager,cancellationToken:r,credentialsManager:this.credentialsManager});return Br(a.length+3,l)}throw null}}suggestLayerName(e){let[t,r]=this.getProvider(e);r.endsWith("/")&&(r=r.substring(0,r.length-1));let i=t.suggestLayerName;return i!==void 0?i(r):bz(r)}findSourceGroup(e){let[t,r,i]=this.getProvider(e);return(t.findSourceGroup||KD)(r)+i.length+3}};var wr=class extends Error{constructor(e,t,r,i){let a=`Fetching ${JSON.stringify(e)} resulted in HTTP error ${t}`;r&&(a+=`: ${r}`),a+=".",super(a),this.name="HttpError",this.message=a,this.url=e,this.status=t,this.statusText=r,i&&(this.response=i)}static fromResponse(e){return new wr(e.url,e.status,e.statusText,e)}static fromRequestError(e,t){if(t instanceof TypeError){let r;return typeof e=="string"?r=e:r=e.url,new wr(r,0,"Network or CORS error")}return t}};async function Qh(n,e){let t;try{t=await fetch(n,e)}catch(r){throw wr.fromRequestError(n,r)}if(!t.ok)throw wr.fromResponse(t);return t}function sl(n){return n.arrayBuffer()}function ut(n){return n.json()}async function Rn(n,e,t,r=Je){if(r===Je){let o=await Qh(n,e);return await t(o)}let i=new AbortController,a=r.add(()=>i.abort());try{let o=await Qh(n,{...e,signal:i.signal});return await t(o)}finally{a()}}var oZ=new X;function Da(n){let e=/^([^:\/]+):\/\/([^\/]+)((?:\/.*)?)$/,t=n.match(e);if(t===null)throw new Error(`Invalid URL: ${JSON.stringify(n)}`);return{protocol:t[1],host:t[2],path:t[3]}}function Aa(n){return n instanceof wr?n.status===0||n.status===403||n.status===404:!1}var xz=32,Cz=3,wz=500,Tz=1e4;function QD(n){return Math.min(2**n*wz,Tz/2)*(1+Math.random())}async function hi(n,e,t,r,i,a,o=Je){let l;e:for(let c=0;;){ZE(o),c>1&&await new Promise(d=>setTimeout(d,QD(c-2))),l=await n.get(l,o);t:for(let d=0;;)try{return await Rn(typeof e=="function"?e(l.credentials):e,i(l.credentials,t),r,o)}catch(p){if(p instanceof wr){if(a(p,l.credentials)==="refresh"){if(++c===Cz)throw p;continue e}if(++d===xz)throw p;await new Promise(m=>setTimeout(m,QD(d-1)));continue t}throw p}}}function Hi(n,e,t,r,i=Je){return n===void 0?Rn(e,t,r,i):hi(n,e,t,r,(a,o)=>{if(!a.accessToken)return o;let l=new Headers(o.headers);return l.set("Authorization",`${a.tokenType} ${a.accessToken}`),{...o,headers:l}},(a,o)=>{let{status:l}=a;if(l===401)return"refresh";if(l===504||l===503)return"retry";if(l===403&&!o.accessToken)return"refresh";throw a},i)}var zd="google-brainmaps";function ll(n,e,t,r=Je){return Hi(e,`${n.serverUrl}${t.path}`,{method:t.method,body:t.payload},t.responseType==="json"?ut:sl,r)}var Ia;(function(r){r[r.RAW=0]="RAW",r[r.JPEG=1]="JPEG",r[r.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(Ia||(Ia={}));var Zh=class{};Zh.RPC_ID="brainmaps/VolumeChunkSource";var em=class{};em.RPC_ID="brainmaps/MultiscaleMeshSource";var tm=class{};tm.RPC_ID="brainmaps/MeshSource";var nm=class{};nm.RPC_ID="brainmaps/SkeletonSource";var rm=class{};rm.RPC_ID="brainmaps/Annotation";var im=class{};im.RPC_ID="brainmaps/AnnotationSpatialIndex";var ZD="mesh/MeshLayer",e1="mesh/MultiscaleMeshLayer",t1="mesh/FragmentSource",n1="mesh/MultiscaleFragmentSource",mi;(function(r){r[r.float32=0]="float32",r[r.uint10=1]="uint10",r[r.uint16=2]="uint16"})(mi||(mi={}));function r1(n,e,t){return n&1|e<<1&2|t<<2&4}var am=!1;function kz(n,e,t,r,i,a,o){let{octree:l,lodScales:c,chunkGridSpatialOrigin:d,chunkShape:p}=n,m=c.length-1,y=e[0],v=e[4],b=e[8],x=e[1],C=e[5],k=e[9],D=e[3],P=e[7],M=e[11],I=e[15],E=D>0?0:1,_=P>0?0:1,O=M>0?0:1,B=t[4*4],W=t[4*4+1],V=t[4*4+2],U=t[4*4+3];function N(je,et,Ie){return D*je+P*et+M*Ie+I}function q(je,et,Ie,lt,Zn,ea){return N(je+E*(lt-je),et+_*(Zn-et),Ie+O*(ea-Ie))}let ne=N(-U*B,-U*W,-U*V),pe=n.clipLowerBound[0],me=n.clipLowerBound[1],Pe=n.clipLowerBound[2],se=n.clipUpperBound[0],Te=n.clipUpperBound[1],Ae=n.clipUpperBound[2],Be=Math.sqrt((y*i)**2+(x*a)**2),Ze=Math.sqrt((v*i)**2+(C*a)**2),ge=Math.sqrt((b*i)**2+(k*a)**2),Le=Math.max(Be,Ze,ge);function We(je,et,Ie){let lt=1<<je,Zn=et*5,ea=l[Zn],tt=l[Zn+1],Er=l[Zn+2],ta=l[Zn+3],na=l[Zn+4],ra=ea*lt*p[0]+d[0],ia=tt*lt*p[1]+d[1],ai=Er*lt*p[2]+d[2],ki=ra+lt*p[0],za=ia+lt*p[1],Eo=ai+lt*p[2];if(ra=Math.max(ra,pe),ia=Math.max(ia,me),ai=Math.max(ai,Pe),ki=Math.min(ki,se),za=Math.min(za,Te),Eo=Math.min(Eo,Ae),Xf(ra,ia,ai,ki,za,Eo,t)){let Po=Math.max(ne,q(ra,ia,ai,ki,za,Eo))/Le;if(Ie===0||Po*r<Ie){let Bn=c[je];if(Bn!==0&&o(je,et,Bn/Po,na>>>31),je>0&&(Bn===0||Po*r<Bn)){let yu=Bn===0?Ie:Bn,ur=(na&2147483647)>>>0;for(let kt=ta;kt<ur;++kt)We(je-1,kt,yu)}}}}We(m,l.length/5-1,0)}function eb(n,e,t,r,i,a,o,l){let{lodScales:c}=n,d=0;for(;d+1<c.length&&c[d+1]!==0;)++d;let p=3,m=[],y=0,v=0;function b(k,D){for(am&&console.log(`emitChunksUpTo: stackDepth=${y}, targetStackIndex=${k}, subChunkIndex=${D}, priorSubChunkIndex=${v}`);;){if(y===0)return;let P=y-1,M=d-P,I=m[P*p],E=M===0?1:8,_=m[P*p+1],O=m[P*p+2];if(k===y){let B=D&E-1;v!==B&&I!==-1&&(am&&console.log(`  drawing chunk because priorSubChunkIndex (${v}) != endSubChunk (${B})`),l(M,I,v,B,O)),v=B+1;return}v!==E&&I!==-1&&l(M,I,v,E,O),v=_+1,--y}}let x=0;am&&(console.log(""),console.log("Starting to draw"));let{octree:C}=n;kz(n,e,t,r,i,a,(k,D,P,M)=>{if(!M&&!o(k,D,P)){x=Math.max(k,x);return}if(k<x)return;x=0;let I=D*5,E=C[I],_=C[I+1],O=C[I+2],B=r1(E,_,O),W=d-k;b(W,B);let V=W*p;m[V]=M?-1:D,m[V+1]=B,m[V+2]=P,am&&console.log(`Adding to stack: lod=${k}, row=${m[V]}, subChunkIndex=${B}`),v=0,y=W+1}),b(0,0)}function i1(n){if(n.length%5!=0)throw new Error("Invalid length");let e=n.length/5,t=new Set;function r(i){if(t.has(i))throw new Error("Previously seen node");if(t.add(i),i<0||i>=e)throw new Error("Invalid node reference");let a=n[i*5],o=n[i*5+1],l=n[i*5+2],c=n[i*5+3],d=n[i*5+4];if(c<0||d<0||d<c||d>e||c+8<d)throw new Error("Invalid child references");for(let p=c;p<d;++p){let m=n[p*5],y=n[p*5+1],v=n[p*5+2];if(m>>>1!==a||y>>>1!==o||v>>>1!=l)throw new Error("invalid child");r(p)}}if(e!==0&&(r(e-1),t.size!==e))throw new Error("Orphan nodes in octree")}function tb(n,e,t){return`${n}/${e}:${t}`}var Ur=class extends Nd{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}};var Lz=3432918353,Ez=461845907;function Dc(n,e){return e>>>=0,n>>>=0,e=Math.imul(e,Lz)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,Ez)>>>0,n=(n^e)>>>0,n=(n<<13|n>>>19)>>>0,n=n*5+3864292196>>>0,n}var om=3,Pz=.8,ts=!1,Ma=0,Ra=0,a1=0,o1=0,Ac=class{constructor(e=Ac.generateHashSeeds(om)){this.hashSeeds=e;this.loadFactor=Pz;this.size=0;this.emptyLow=4294967295;this.emptyHigh=4294967295;this.maxRehashAttempts=5;this.maxAttempts=5;this.generation=0;this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=Ac.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){let t=this.hashSeeds.length,r=new Array(t);for(let c=0;c<t;++c)r[c]=this.getHash(c,this.emptyLow,this.emptyHigh);let{mungedEmptyKey:i}=this;if(i===-1){e:for(;;){i=Math.random()*16777216>>>0;for(let c=0;c<t;++c){let d=this.getHash(c,i,i);for(let p=0;p<t;++p)if(r[p]===d)continue e}this.mungedEmptyKey=i;break}}let{table:a,emptyLow:o,emptyHigh:l}=this;for(let c=0;c<t;++c){let d=r[c];a[d]===o&&a[d+1]===l&&(a[d]=i,a[d+1]=i)}try{e(a)}finally{for(let c=0;c<t;++c){let d=r[c];a[d]===i&&a[d+1]===i&&(a[d]=o,a[d+1]=l)}}}static generateHashSeeds(e=om){return EE(new Uint32Array(e))}getHash(e,t,r){let i=this.hashSeeds[e];return i=Dc(i,t),i=Dc(i,r),this.entryStride*(i&this.tableSize-1)}*keys(){let{emptyLow:e,emptyHigh:t,entryStride:r}=this,{table:i}=this;for(let a=0,o=i.length;a<o;a+=r){let l=i[a],c=i[a+1];(l!==e||c!==t)&&(yield new X(l,c))}}*unsafeKeys(e=new X){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:a}=this;for(let o=0,l=a.length;o<l;o+=i){let c=a[o],d=a[o+1];(c!==t||d!==r)&&(e.low=c,e.high=d,yield e)}}indexOfPair(e,t){let{table:r,emptyLow:i,emptyHigh:a}=this;if(e===i&&t===a)return-1;for(let o=0,l=this.hashSeeds.length;o<l;++o){let c=this.getHash(o,e,t);if(r[c]===e&&r[c+1]===t)return c}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let{emptyLow:e,emptyHigh:t,table:r,entryStride:i}=this,a,o;for(;a=Math.random()*4294967296>>>0,o=Math.random()*4294967296>>>0,!(!(a===e&&o===t)&&!this.hasPair(a,o)););this.emptyLow=a,this.emptyHigh=o;for(let l=0,c=r.length;l<c;l+=i)r[l]===e&&r[l+1]===t&&(r[l]=a,r[l+1]=o)}has(e){return this.indexOf(e)!==-1}hasPair(e,t){return this.indexOfPair(e,t)!==-1}delete(e){let t=this.indexOf(e);if(t!==-1){let{table:r}=this;return r[t]=this.emptyLow,r[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let{table:e,entryStride:t,emptyLow:r,emptyHigh:i}=this,a=e.length;for(let o=0;o<a;o+=t)e[o]=r,e[o+1]=i}clear(){return this.size===0?!1:(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity?(this.backupPending(),this.grow(e),this.restorePending(),!0):!1}swapPending(e,t){let r=Ma,i=Ra;this.storePending(e,t),e[t]=r,e[t+1]=i}storePending(e,t){Ma=e[t],Ra=e[t+1]}backupPending(){a1=Ma,o1=Ra}restorePending(){Ma=a1,Ra=o1}tryToInsert(){ts&&console.log(`tryToInsert: ${Ma}, ${Ra}`);let e=0,{emptyLow:t,emptyHigh:r,maxAttempts:i,table:a}=this,o=this.hashSeeds.length,l=Math.floor(Math.random()*o);for(;;){let c=this.getHash(l,Ma,Ra);if(this.swapPending(a,c),Ma===t&&Ra===r)return!0;if(++e===i)break;l=(l+Math.floor(Math.random()*(o-1))+1)%o}return!1}allocate(e){this.tableSize=e;let{entryStride:t}=this;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){ts&&console.log("rehash begin"),this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let{emptyLow:r,emptyHigh:i,entryStride:a}=this;for(let o=0,l=e.length;o<l;o+=a){let c=e[o],d=e[o+1];if((c!==r||d!==i)&&(this.storePending(e,o),!this.tryToInsert()))return ts&&console.log("rehash failed"),!1}return ts&&console.log("rehash end"),!0}grow(e){ts&&console.log(`grow: ${e}`);let t=this.table,{tableSize:r}=this;for(;r<e;)r*=2;for(;;){for(let i=0;i<this.maxRehashAttempts;++i)if(this.rehash(t,r)){ts&&console.log("grow end");return}r*=2}}insertInternal(){for(++this.generation,Ma===this.emptyLow&&Ra===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(this.tableSize*2),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}},sm=class extends Ac{add(e){let{low:t,high:r}=e;return this.hasPair(t,r)?!1:(ts&&console.log(`add: ${t},${r}`),Ma=t,Ra=r,this.insertInternal(),!0)}[Symbol.iterator](){return this.unsafeKeys()}};sm.prototype.entryStride=2;var Hd=0,$d=0,s1=0,l1=0,Ic=class extends Ac{set(e,t){let{low:r,high:i}=e;return this.hasPair(r,i)?!1:(ts&&console.log(`add: ${r},${i} -> ${t.low},${t.high}`),Ma=r,Ra=i,Hd=t.low,$d=t.high,this.insertInternal(),!0)}get(e,t){let r=this.indexOf(e);if(r===-1)return!1;let{table:i}=this;return t.low=i[r+2],t.high=i[r+3],!0}swapPending(e,t){let r=Hd,i=$d;super.swapPending(e,t),e[t+2]=r,e[t+3]=i}storePending(e,t){super.storePending(e,t),Hd=e[t+2],$d=e[t+3]}backupPending(){super.backupPending(),s1=Hd,l1=$d}restorePending(){super.restorePending(),Hd=s1,$d=l1}[Symbol.iterator](){return this.unsafeEntries()}*entries(){let{emptyLow:e,emptyHigh:t,entryStride:r}=this,{table:i}=this;for(let a=0,o=i.length;a<o;a+=r){let l=i[a],c=i[a+1];if(l!==e||c!==t){let d=new X(l,c),p=new X(i[a+2],i[a+3]);yield[d,p]}}}*unsafeEntries(e=[new X,new X]){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:a}=this,[o,l]=e;for(let c=0,d=a.length;c<d;c+=i){let p=a[c],m=a[c+1];(p!==t||m!==r)&&(o.low=p,o.high=m,l.low=a[c+2],l.high=a[c+3],yield e)}}};Ic.prototype.entryStride=4;var $i=class{},cl=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],Dz=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],lm=["","r","rg","rgb","rgba"],Az=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],Iz=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],Mz=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],Rz=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],c1=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],_z=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],Vz=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function Mc(n){return n===H.FLOAT32?"":Zf[n]?"i":"u"}function gi(n,e,t=1){switch(e){case H.UINT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=Az[t],n.textureFormat=cl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint8Array,n.samplerPrefix="u",n;case H.INT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=Iz[t],n.textureFormat=cl[t],n.texelType=WebGL2RenderingContext.BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Int8Array,n.samplerPrefix="i",n;case H.UINT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=Mz[t],n.textureFormat=cl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint16Array,n.samplerPrefix="u",n;case H.INT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=Rz[t],n.textureFormat=cl[t],n.texelType=WebGL2RenderingContext.SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Int16Array,n.samplerPrefix="i",n;case H.UINT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=c1[t],n.textureFormat=cl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case H.INT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=_z[t],n.textureFormat=cl[t],n.texelType=WebGL2RenderingContext.INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Int32Array,n.samplerPrefix="i",n;case H.UINT64:if(t<1||t>2)break;return n.texelsPerElement=1,n.textureInternalFormat=c1[t*2],n.textureFormat=cl[t*2],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=2*t,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case H.FLOAT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=Vz[t],n.textureFormat=Dz[t],n.texelType=WebGL2RenderingContext.FLOAT,n.arrayElementsPerTexel=t,n.arrayConstructor=Float32Array,n.samplerPrefix="",n}throw new Error(`No supported texture format for ${H[e]}[${t}].`)}function ns(n,e,t){let{arrayConstructor:r,arrayElementsPerTexel:i,textureInternalFormat:a,textureFormat:o,texelsPerElement:l}=e,{maxTextureSize:c}=n,d=t.length/i;if(d*l>c*c)throw new Error("Number of elements exceeds maximum texture size: "+l+" * "+d);let p=Math.ceil(d/c),m=Math.ceil(Math.log2(p)),y=(1<<m)*l,v=Math.ceil(d/(1<<m)),b=y*v*i;t.constructor!==r&&(t=new r(t.buffer,t.byteOffset,t.byteLength/r.BYTES_PER_ELEMENT));let x=Mk(t,b);n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),co(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,a,y,v,0,o,e.texelType,x)}function u1(n,e,t,r,i){let{arrayConstructor:a,textureInternalFormat:o,textureFormat:l,texelsPerElement:c}=e;t.constructor!==a&&(t=new a(t.buffer,t.byteOffset,t.byteLength/a.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),co(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,o,r*c,i,0,l,e.texelType,t)}function d1(n,e,t,r,i,a){let{arrayConstructor:o,textureInternalFormat:l,textureFormat:c,texelsPerElement:d}=e;t.constructor!==o&&(t=new o(t.buffer,t.byteOffset,t.byteLength/o.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),BP(n),n.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,l,r*d,i,a,0,c,e.texelType,t)}function Oz(n){switch(n){case H.UINT8:return MS;case H.INT8:return RS;case H.UINT16:return _S;case H.INT16:return VS;case H.UINT32:return Ys;case H.INT32:return OS;case H.UINT64:return Dt;case H.FLOAT32:return Uh}}function p1(n,e,t,r,i,a){let o=Vt(i,a),l=[Oz(i)],c=`
${o} ${n}(${r} index) {
`;switch(i){case H.UINT8:case H.UINT16:case H.UINT32:c+=`
  ${o} result;
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${lm[a]};
  return result;
`;break;case H.INT8:case H.INT16:case H.INT32:c+=`
  ${o} result;
  highp ivec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${lm[a]};
  return result;
`;break;case H.UINT64:l.push(JP),c+=`
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  return unpackUint64leFromUint32(temp.${lm[a*2]});
`;break;case H.FLOAT32:l.push(Uh),c+=`
  highp vec4 temp;
  ${e}(${t}, index, temp);
  return temp.${lm[a]};
`;break}return c+=`
}
`,l.push(c),l}var mo=class{constructor(e){this.key=e;this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let r=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let i=0;i<e;++i)r+=`, out ${t}vec4 output${i}`;r+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let i=0;i<e;++i)r+=`
  output${i} = texelFetch(sampler, ivec2(x + ${i}, y), 0);
`;return r+=`
}
`,[ZP,r]}getAccessor(e,t,r,i=1){let a=Mc(r);return[this.getReadTextureValueCode(1,a),...p1(e,this.readTextureValue,t,"highp uint",r,i)]}},nb=class{constructor(e,t){this.key=e;this.textureDims=t;this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){let{textureDims:r}=this,i=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${r} p`;for(let a=0;a<e;++a)i+=`, out ${t}vec4 output${a}`;i+=`) {
`;for(let a=0;a<e;++a)i+=`
  output${a} = texelFetch(sampler, ivec${r}(p.x * ${e} + ${a}, p.y
                                         ${r===3?", p.z":""}), 0);
`;return i+=`
}
`,i}getAccessor(e,t,r,i=1){let a=Mc(r);return[this.getReadTextureValueCode(1,a),...p1(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,r,i)]}};var rb=[Dt,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],Nz=gi(new $i,H.UINT64,1),ul=class extends j{constructor(e,t){super();this.gl=e;this.hashTable=t;this.generation=-1;this.texture=null;this.texture=e.createTexture()}copyToGPU(){let{hashTable:e}=this,{generation:t}=e;if(this.generation===t)return;let{gl:r,texture:i}=this;this.generation=t,r.activeTexture(WebGL2RenderingContext.TEXTURE0+r.tempTextureUnit),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i),e.tableWithMungedEmptyKey(a=>{ns(this.gl,Nz,a)}),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){let{gl:e}=this;e.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new this(e,t))}},cm=class{constructor(e,t=om){this.prefix=e;this.numAlternatives=t;this.textureUnitSymbol=Symbol.for(`gpuhashtable:${this.prefix}`);this.accessHelper=new mo(`gpuhashtable_${this.prefix}`);this.samplerName=this.prefix+"_sampler";this.hashSeedsName=this.prefix+"_seeds";this.hashKeyMask=this.prefix+"_keyMask";this.readTable=this.prefix+"_readTable"}defineShader(e){let{hashSeedsName:t,samplerName:r,numAlternatives:i,hashKeyMask:a}=this;e.addUniform("highp uint",t,i),e.addUniform("highp uint",a),e.addTextureSampler("usampler2D",r,this.textureUnitSymbol),e.addFragmentCode(rb),e.addFragmentCode(Dt),e.addFragmentCode(Bh),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,H.UINT64,1));let o="";o+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let l=0;l<i;++l)o+=`
  {
    uint h = hashCombine(${t}[${l}], x) & ${a};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;o+=`
  return false;
}
`,e.addFragmentCode(o)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,r){r.copyToGPU();let i=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r.texture),e.uniform1ui(t.uniform(this.hashKeyMask),r.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),r.hashTable.hashSeeds)}disable(e,t){let r=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}},jd=class extends cm{defineShader(e){super.defineShader(e);let{numAlternatives:t,hashSeedsName:r,hashKeyMask:i}=this,a=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let o=0;o<t;++o)a+=`
  {
    uint h = hashCombine(${r}[${o}], x) & ${i};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;a+=`
  return false;
}
`,e.addFragmentCode(a)}get getFunctionName(){return`${this.prefix}_get`}};function dl(n,e,t,r){e*=6;let i=Math.floor(e),a=e-i,o=r*(1-t),l=r*(1-t*a),c=r*(1-t*(1-a));switch(i%6){case 0:n[0]=r,n[1]=c,n[2]=o;break;case 1:n[0]=l,n[1]=r,n[2]=o;break;case 2:n[0]=o,n[1]=r,n[2]=c;break;case 3:n[0]=o,n[1]=l,n[2]=r;break;case 4:n[0]=c,n[1]=o,n[2]=r;break;case 5:n[0]=r,n[1]=o,n[2]=l;break}return n}function f1(n,e,t,r){let i=Math.max(Math.max(e,t),r),a=Math.min(Math.min(e,t),r);if(n[2]=i,a===i)n[0]=0,n[1]=0;else{let o=i-a;n[1]=o/i,e===i?n[0]=(t-r)/o:t===i?n[0]=2+(r-e)/o:n[0]=4+(e-t)/o,n[0]/=6,n[0]<0&&(n[0]+=1),n[0]>1&&(n[0]-=1)}return n}var h1=2,ib=class{constructor(e){this.prefix=e;this.seedName=this.prefix+"_seed"}defineShader(e){let{seedName:t}=this;e.addUniform("highp uint",t),e.addFragmentCode(Dt),e.addFragmentCode(rb),e.addFragmentCode(qP);let r=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec${h1} v;
`;for(let i=0;i<h1;++i)r+=`
  v[${i}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;r+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(r)}enable(e,t,r){e.uniform1ui(t.uniform(this.seedName),r)}},m1=new Float32Array(3);function ab(n){return`rgb(${n[0]*100}%,${n[1]*100}%,${n[2]*100}%)`}var qd=class{constructor(e=zv()){this.hashSeed=e;this.changed=new ae}static getDefault(){return new qd(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let r=Dc(this.hashSeed,t.low);r=Dc(r,t.high);let i=(r&255)/255,a=(r>>8&255)/255;return dl(e,i,.5+.5*a,1),e}computeCssColor(e){return this.compute(m1,e),ab(m1)}randomize(){this.hashSeed=zv(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return this.hashSeed===0?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){let t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}},ob=class{constructor(e){this.prefix=e;this.hashMapShaderManager=new jd("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`
bool ${this.getFunctionName}(uint64_t x, out vec3 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,r){this.hashMapShaderManager.enable(e,t,r)}disable(e,t){this.hashMapShaderManager.disable(e,t)}};var um='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowLeftIconTitle"><path d="M9 6l-6 6 6 6"></path><path d="M21 12H4"></path><path stroke-linecap="round" d="M3 12h1"></path></svg>';var dm='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowRightIconTitle"><path d="M15 18l6-6-6-6"></path><path d="M3 12h17"></path><path stroke-linecap="round" d="M21 12h-1"></path></svg>';var sb=class{constructor(e){this.parents=new Array;this.parentPriorities=new Array;this.bindings=new Map;if(e!==void 0){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(let[t,r]of e.bindings)this.bindings.set(t,r)}}addParent(e,t){let{parents:r,parentPriorities:i}=this,a=0,{length:o}=r;for(;a<o&&t<i[a];)++a;return r.splice(a,0,e),i.splice(a,0,t),()=>{this.removeParent(e)}}removeParent(e){let t=this.parents.indexOf(e);if(t===-1)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){let{parents:t,parentPriorities:r}=this,i=r.length,a=0,o;for(;a<i&&r[a]>0;++a)if(o=t[a].get(e),o!==void 0)return o;if(o=this.bindings.get(e),o!==void 0)return o;for(;a<i;++a)if(o=t[a].get(e),o!==void 0)return o}*getAll(e){let{parents:t,parentPriorities:r}=this,i=r.length,a=0,o;for(;a<i&&r[a]>0;)o=t[a].get(e),o!==void 0&&(yield o);for(o=this.bindings.get(e),o!==void 0&&(yield o);a<i;)o=t[a].get(e),o!==void 0&&(yield o)}*entries(){let{parents:e,parentPriorities:t}=this,r=t.length,i=0;for(;i<r&&t[i]>0;++i)yield*e[i].entries();for(yield*this.bindings.entries();i<r;++i)yield*e[i].entries()}};var Tt;(function(i){i[i.CONTROL=1]="CONTROL",i[i.ALT=2]="ALT",i[i.META=4]="META",i[i.SHIFT=8]="SHIFT"})(Tt||(Tt={}));function pm(n){return(n.ctrlKey?1:0)|(n.altKey?2:0)|(n.metaKey?4:0)|(n.shiftKey?8:0)}function lb(n,e){let t="";return e&1&&(t+="control+"),e&2&&(t+="alt+"),e&4&&(t+="meta+"),e&8&&(t+="shift+"),t+=n,t}function Bz(n,e,t){let r="";return e&1&&(r+="control+"),t&1&&(r+="control?+"),e&2&&(r+="alt+"),t&2&&(r+="alt?+"),e&4&&(r+="meta+"),t&4&&(r+="meta?+"),e&8&&(r+="shift+"),t&8&&(r+="shift?+"),r+=n,r}function g1(n){let e=n.indexOf(":"),t;if(e!==-1&&(t=n.substring(0,e),t!=="at"&&t!=="bubble"))throw new Error(`Invalid event phase: ${JSON.stringify(t)}`);let r=n.substring(e+1).split("+"),i,a=0,o=0;e:for(let l of r)switch(l){case"control":a|=1;break;case"control?":o|=1;break;case"alt":a|=2;break;case"alt?":o|=2;break;case"meta":a|=4;break;case"meta?":o|=4;break;case"shift":a|=8;break;case"shift?":o|=8;break;default:if(i===void 0)i=l;else{i=void 0;break e}}if(i===void 0||a&o)throw new Error(`Invalid event identifier: ${JSON.stringify(n)}`);return{phase:t,keyName:i,modifiers:a,optionalModifiers:o}}function*Uz(n,e,t){t===0&&(yield lb(n,e));for(let r=0;r<16;++r)(r&(e|t))===r&&(r&e)===e&&(yield lb(n,r))}function*y1(n){let{phase:e}=n,t=Uz(n.keyName,n.modifiers,n.optionalModifiers);if(e===void 0)for(let r of t)yield`at:${r}`,yield`bubble:${r}`;else for(let r of t)yield`${e}:${r}`}function Fz(n,e){let t=Bz(n.keyName,n.modifiers,n.optionalModifiers);return typeof e=="string"?{action:e,originalEventIdentifier:t}:{...e,originalEventIdentifier:t}}var Oe=class extends sb{static fromObject(e,t={}){let r=new Oe;if(r.label=t.label,t.parents!==void 0)for(let[i,a]of t.parents)r.addParent(i,a);for(let i of Object.keys(e))r.set(i,e[i]);return r}setFromObject(e){for(let t of Object.keys(e))this.set(t,e[t])}set(e,t){let r=g1(e),i=Fz(r,t);for(let a of y1(r))super.set(a,i)}delete(e){for(let t of y1(g1(e)))super.delete(t)}describe(){let e=[],t=new Map;for(let[,r]of this.entries())t.set(r.originalEventIdentifier,r.action);for(let[r,i]of t)e.push(`${r}\u2192${i}`);return e.join(", ")}};function cb(n,e,t){if(t===void 0)return;t.stopPropagation!==!1&&n.stopPropagation();let r=new CustomEvent("action:"+t.action,{bubbles:!0,detail:e,cancelable:!0}),i=!n.target.dispatchEvent(r);(t.preventDefault!==!1||i)&&n.preventDefault()}var fm=[];fm[Event.AT_TARGET]="at";fm[Event.CAPTURING_PHASE]="capture";fm[Event.BUBBLING_PHASE]="bubble";function ub(n,e,t,r,i){let a=fm[t]+":"+n,o=i.get(a);cb(e,r,o)}function hm(n,e,t,r){ub(lb(n,pm(e)),e,e.eventPhase,t,r)}function ce(n,e,t,r){return En(n,`action:${e}`,t,r)}var db;function Gz(){if(db===void 0){let n=new Oe;n.set("keyl","recolor"),n.set("keyx","clear-segments"),n.set("keys","toggle-show-slices"),n.set("keyb","toggle-scale-bar"),n.set("keyv","toggle-default-annotations"),n.set("keya","toggle-axis-lines"),n.set("keyo","toggle-orthographic-projection");for(let e=1;e<=9;++e)n.set("digit"+e,"toggle-layer-"+e),n.set("control+digit"+e,"select-layer-"+e),n.set("alt+digit"+e,"toggle-pick-layer-"+e);for(let e=0;e<26;++e){let t=String.fromCharCode(97+e),r=String.fromCharCode(65+e);n.set(`alt?+control?+shift+key${t}`,`tool-${r}`)}n.set("keyn","add-layer"),n.set("keyh","help"),n.set("space","toggle-layout"),n.set("shift+space","toggle-layout-alternative"),n.set("backslash","toggle-show-statistics"),db=n}return db}var pb;function Rc(){return pb===void 0&&(pb=Oe.fromObject({"control+mousedown2":"select-position"})),pb}var fb;function v1(){return fb===void 0&&(fb=Oe.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[Rc(),0]]})),fb}var hb;function S1(){return hb===void 0&&(hb=Oe.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:alt+mousedown2":"copy-segment-id","at:alt+shift+mousedown2":"add-copy-segment-id","at:dblclick0":"select","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[Rc(),0]]})),hb}var mb;function Wz(){return mb===void 0&&(mb=Oe.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[S1(),Number.NEGATIVE_INFINITY]]})),mb}var gb;function zz(){return gb===void 0&&(gb=Oe.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[S1(),Number.NEGATIVE_INFINITY]]})),gb}function b1(n){n.global.addParent(Gz(),Number.NEGATIVE_INFINITY),n.sliceView.addParent(zz(),Number.NEGATIVE_INFINITY),n.perspectiveView.addParent(Wz(),Number.NEGATIVE_INFINITY)}function _e(n){for(;;){let e=n.firstChild;if(!e)break;n.removeChild(e)}}function Xe(n){let{parentElement:e}=n;return e?(e.removeChild(n),!0):!1}function Sn(n,e=Math.max(1,n.value.length)){let t=`${e}ch`;n.style.width!==t&&(n.style.width="0px",n.offsetWidth,n.style.width=t)}function qn(n,e){let t=n.firstElementChild;for(let r of e)r!==t&&n.insertBefore(r,t),t=r.nextElementSibling;for(;t!==null;){let r=t.nextElementSibling;n.removeChild(t),t=r}}function Jd(n){return n instanceof HTMLElement?!!(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement||n.isContentEditable):!1}function x1(n){let e=n.cloneNode(!0);return e.style.position="absolute",document.body.appendChild(e),e.getBoundingClientRect()}var _c,Kd=[];function Hz(){if(_c===void 0){let n=_c=document.createElement("div");n.classList.add("neuroglancer-drag-status"),document.body.appendChild(n)}return _c}function $z(){_c!==void 0&&(_e(_c),_c.style.display="none")}function C1(n){let e=Hz();_e(e),typeof n=="string"?e.appendChild(document.createTextNode(n)):e.appendChild(n()),e.style.display=""}function w1(n,e){Of(Kd,t=>!(t.target===n&&t.operation===e))}function Tr(n,e,t){w1(n,e),Kd.push({target:n,operation:e,status:t}),C1(t)}function Zt(n,e){w1(n,e);let t=Kd.length===0?void 0:Kd[Kd.length-1];t===void 0?$z():C1(t.status)}var jz=300,qz=100,yi={side:"right",col:0,row:Infinity,flex:1,size:jz,minSize:qz,visible:!1},sr=class{constructor(e=yi,t=e){this.defaultValue=e;this.value=t;this.changed=new Me;this.locationChanged=new Me;this.locationChanged.add(this.changed.dispatch);let r=this;this.watchableVisible={get value(){return r.visible},set value(i){r.visible=i},changed:r.locationChanged}}toJSON(e=this.defaultValue){let t={},{value:r}=this;for(let i in r)r[i]!==e[i]&&(t[i]=r[i]);return t}get visible(){return this.value.visible}set visible(e){let{value:t}=this;t.visible!==e&&(this.value={...t,visible:e},this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(e===void 0)return;Q(e);let r={side:le(e,"side",i=>{if(i!=="left"&&i!=="right"&&i!=="top"&&i!=="bottom")throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${JSON.stringify(i)}`);return i},t.side),col:le(e,"col",Ye,t.col),row:le(e,"row",Ye,t.row),flex:le(e,"flex",Ye,t.flex),size:le(e,"size",wt,t.size),visible:le(e,"visible",Ii,t.visible),minSize:t.minSize};this.value=r,this.locationChanged.dispatch()}};function bn(n,e,t){let{document:r}=n.view,i=n.clientX,a=n.clientY,o=p=>{let m=p.clientX-i,y=p.clientY-a;i=p.clientX,a=p.clientY,e(p,m,y)},l=n.button,c=p=>{r.removeEventListener("pointermove",o,!0),r.removeEventListener("pointerup",d,!1),t!==void 0&&t(p,p.clientX-i,p.clientY-a)},d=p=>{p.button===l&&c(p)};r.addEventListener("pointermove",o,!0),r.addEventListener("pointerup",d,!1),r.addEventListener("pointercancel",c,!1)}var T1='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="closeIconTitle"><path d="M6.34314575 6.34314575L17.6568542 17.6568542M6.34314575 17.6568542L17.6568542 6.34314575"></path></svg>';var k1='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="refreshIconTitle"><polyline points="22 12 19 15 16 12"></polyline><path d="M11,20 C6.581722,20 3,16.418278 3,12 C3,7.581722 6.581722,4 11,4 C15.418278,4 19,7.581722 19,12 L19,14"></path></svg>';function $e(n){let{title:e,onClick:t,href:r}=n,i;r!==void 0?(i=document.createElement("a"),i.href=r,i.target="_blank"):i=document.createElement("div"),e!==void 0&&(i.title=e),t!==void 0&&i.addEventListener("click",t);let{svg:a}=n;return i.className="neuroglancer-icon",a!==void 0&&(i.innerHTML=a),n.text!==void 0&&i.appendChild(document.createTextNode(n.text)),i}function Vc(n={}){return $e({svg:T1,...n})}function L1(n={}){return $e({svg:k1,...n})}var pl="neuroglancer-drag-over",E1={row:"row",column:"col"},Jz={left:"right",right:"left",top:"bottom",bottom:"top"},rs={left:"column",right:"column",top:"row",bottom:"row"},mm={left:"row",right:"row",top:"column",bottom:"column"},Oc={row:"width",column:"height"},P1={row:"left",column:"top"},Kz={row:"right",column:"bottom"},D1={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},gm={left:-1,right:1,top:-1,bottom:1},Fr=class extends j{constructor(e,t=new sr){super();this.sidePanelManager=e;this.location=t;this.element=document.createElement("div");this.visibility=new Pt(Pt.VISIBLE);let{element:r}=this;r.classList.add("neuroglancer-side-panel"),r.draggable=!0,r.addEventListener("dragstart",i=>{this.sidePanelManager.startDrag(this.makeDragSource(),i),r.style.backgroundColor="black",setTimeout(()=>{r.style.backgroundColor=""},0),Tr(r,"drag",()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel"))}),r.addEventListener("dragend",i=>{this.sidePanelManager.endDrag(),Zt(r,"drag")})}makeDragSource(){return{dropAsNewPanel:e=>{let t=this.location.value;this.location.value={...t,...e},this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){let t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");let{title:r}=e,i;r!==void 0&&(i=document.createElement("div"),i.classList.add("neuroglancer-side-panel-title"),i.textContent=r,t.appendChild(i));let a=Vc({title:"Close panel",onClick:()=>{this.close()}});return a.style.order="100",t.appendChild(a),this.element.appendChild(t),{titleBar:t,titleElement:i,closeButton:a}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation()}),this.element.appendChild(e)}},yb=class extends j{constructor(e,t,r=new Pt(Pt.VISIBLE)){super();this.display=e;this.center=t;this.visibility=r;this.element=document.createElement("div");this.centerColumn=document.createElement("div");this.beforeRender=new Me;this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")};this.registeredPanels=new Set;this.layoutNeedsUpdate=!1;this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};let{element:i,centerColumn:a}=this;i.style.display="flex",i.style.flex="1",i.style.flexDirection="row",a.style.display="flex",a.style.flex="1",a.style.flexDirection="column",a.style.flexBasis="0px",a.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),!!this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,gm[e]*Infinity,0,e,!1)}}hasDroppablePanel(){return this.dragSource!==void 0}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,r,i,a=!1){let o=document.createElement("div");o.className="neuroglancer-side-panel-drop-zone";let l=10,c=rs[i],d=mm[i];return o.style[Oc[d]]=`${l}px`,o.style[Oc[c]]="100%",a?(o.style.position="absolute",o.style[i]="50%",o.style[D1[i]]="-${size/2}px"):(o.style.position="relative",o.style[D1[Jz[i]]]=`-${l}px`),o.addEventListener("dragenter",p=>{!this.hasDroppablePanel()||(o.classList.add(pl),p.preventDefault(),Tr(o,"drop",()=>document.createTextNode(`Drop side panel as new ${c}`)))}),o.addEventListener("dragleave",()=>{Zt(o,"drop"),o.classList.remove(pl)}),o.addEventListener("dragover",p=>{!this.hasDroppablePanel()||p.preventDefault()}),o.addEventListener("drop",p=>{let{dragSource:m}=this;if(m===void 0)return;Zt(o,"drop"),o.classList.remove(pl);let y=rs[e];m.dropAsNewPanel({side:e,row:y==="column"?r:t,col:y==="row"?r:t}),this.dragSource=void 0,p.preventDefault(),p.stopPropagation()}),o}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){var t;this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),(t=e.panel)==null||t.dispose(),this.invalidateLayout()}disposed(){for(let{panel:e}of this.registeredPanels)e==null||e.dispose();super.disposed()}render(){this.layoutNeedsUpdate=!1;let e={left:[],right:[],top:[],bottom:[]};for(let o of this.registeredPanels)e[o.location.value.side].push(o);let t=o=>this.renderSide(o,this.sides[o].flexGroups,e[o]),r=this;function*i(){yield r.sides.left.outerDropZoneElement,yield*t("left"),yield r.centerColumn,yield*t("right"),yield r.sides.right.outerDropZoneElement}qn(this.element,i());function*a(){yield r.sides.top.outerDropZoneElement,yield*t("top"),yield r.center,yield*t("bottom"),yield r.sides.bottom.outerDropZoneElement}qn(this.centerColumn,a())}makeCrossGutter(e,t){let r=document.createElement("div");r.style.position="relative";let i=mm[e];r.className=`neuroglancer-resize-gutter-${i==="row"?"horizontal":"vertical"}`,r.addEventListener("pointerdown",o=>{if("button"in o&&o.button!==0)return;o.preventDefault();let l=this.sides[e].flexGroups[t];if(l===void 0||!l.visible)return;let d=l.element.getBoundingClientRect()[Oc[i]],p=l.minSize,m=()=>{Tr(r,"drag",`Drag to resize, current ${Oc[i]} is ${l.crossSize}px`)};m(),bn(o,(y,v,b)=>{let x=i==="row"?v:b;d-=gm[e]*x,l.crossSize=Math.max(p,Math.round(d)),m(),this.invalidateLayout()},()=>{Zt(r,"drag")})});let a=this.makeDropZone(e,t-gm[e]*.5,0,e,!0);return r.appendChild(a),r}makeFlexGutter(e,t,r){let i=document.createElement("div");i.style.position="relative";let a=rs[e];i.className=`neuroglancer-resize-gutter-${a==="row"?"horizontal":"vertical"}`,i.addEventListener("pointerdown",l=>{if("button"in l&&l.button!==0)return;l.preventDefault();let c=this.sides[e].flexGroups[t];if(c===void 0||!c.visible)return;let{cells:d}=c,p=d[r];if(p===void 0||!p.registeredPanel.location.visible)return;let m=r+1;for(;m<d.length&&!d[m].registeredPanel.location.visible;)++m;if(m===d.length)return;let y=d[m],v=()=>{Tr(i,"drag",`Drag to resize, current ${Oc[a]} ratio is ${p.registeredPanel.location.value.flex} : ${y.registeredPanel.location.value.flex}`)};v(),bn(l,b=>{let x=p.registeredPanel.panel,C=y.registeredPanel.panel;if(x===void 0||C===void 0)return;let k=x.element.getBoundingClientRect(),D=C.element.getBoundingClientRect(),P=Math.max(.1,Math.min(.9,a==="column"?(b.clientY-k.top)/(D.bottom-k.top):(b.clientX-k.left)/(D.right-k.left))),M=p.registeredPanel.location.value,I=y.registeredPanel.location.value,E=M.flex+I.flex;p.registeredPanel.location.value={...M,flex:Math.round(P*E*100)/100},y.registeredPanel.location.value={...I,flex:Math.round((1-P)*E*100)/100},v(),p.registeredPanel.location.locationChanged.dispatch(),y.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},()=>{Zt(i,"drag")})});let o=this.makeDropZone(e,t,r+.5,P1[rs[e]],!0);return i.appendChild(o),i}renderSide(e,t,r){let i=E1[mm[e]],a=E1[rs[e]];r.sort((c,d)=>{let p=c.location.value,m=d.location.value,y=p[a]-m[a];return y!==0?y:p[i]-m[i]});let o=this;function*l(){let c=0,d=r.length,p=0;for(;c<d;){let m=r[c].location.value[a],y=c,v=0,b=0;do{let D=r[y].location.value;if(D[a]!==m)break;D.visible&&(++v,b=Math.max(b,D.minSize)),++y}while(y<d);let x=v>0,C=t[p];if(C===void 0){let D=o.makeCrossGutter(e,p),P=document.createElement("div");P.className=`neuroglancer-side-panel-${rs[e]}`,C=t[p]={element:P,gutterElement:D,cells:[],crossSize:-1,minSize:b,visible:x,beginDropZone:o.makeDropZone(e,p,-Infinity,P1[rs[e]]),endDropZone:o.makeDropZone(e,p,Infinity,Kz[rs[e]])}}else C.visible=x,C.minSize=b,C.crossSize=Math.max(C.crossSize,b);function*k(){yield C.beginDropZone;let D=0;for(let P=c,M=0;P<y;++P,++M){let I=r[P],E=C.cells[M];E===void 0?E=C.cells[M]={registeredPanel:I,gutterElement:void 0}:E.registeredPanel=I;let _=E.registeredPanel.location.value;C.crossSize==-1&&(C.crossSize=Math.max(b,_.size)),(_[a]!==p||_[i]!==M||_.visible&&_.size!==C.crossSize)&&(E.registeredPanel.location.value={..._,[a]:p,[i]:M,size:_.visible?C.crossSize:_.size},E.registeredPanel.location.changed.dispatch());let O=_.visible&&o.visibility.visible,{panel:B}=I;if(!O){B!==void 0&&(B.dispose(),I.panel=void 0);continue}++D,B===void 0&&(B=I.panel=I.makePanel()),B.element.style.flex=v>1?`${_.flex}`:"1",yield B.element,D===v?E.gutterElement=void 0:(E.gutterElement===void 0&&(E.gutterElement=o.makeFlexGutter(e,p,M)),yield E.gutterElement)}yield C.endDropZone}qn(C.element,k()),C.cells.length=y-c,x&&(C.element.style[Oc[mm[e]]]=`${C.crossSize}px`,gm[e]>0?(yield C.gutterElement,yield C.element):(yield C.element,yield C.gutterElement)),c=y,++p}t.length=p}return l()}};function en(n,e="text/plain"){let t=!1,r=En(document,"copy",i=>{let{clipboardData:a}=i;a!==null&&(a.setData(e,n),t=!0),i.stopPropagation(),i.preventDefault()},!0);try{document.execCommand("copy")}finally{r()}return t}var xn=class extends j{constructor(e,t,r){super();this.target=e;this.eventMap=t;this.registerEventListener(e,"wheel",i=>{r!==void 0&&r(i),this.dispatch("wheel",i)}),this.registerEventListener(e,"click",i=>{r!==void 0&&r(i),this.dispatch(`click${i.button}`,i)}),this.registerEventListener(e,"dblclick",i=>{r!==void 0&&r(i),this.dispatch(`dblclick${i.button}`,i)}),this.registerEventListener(e,"mousedown",i=>{r!==void 0&&r(i);let a=i.button;a===2&&(i.buttons&3)==1&&(a=0),this.dispatch(`mousedown${a}`,i)}),this.registerEventListener(e,"mouseup",i=>{r!==void 0&&r(i),this.dispatch(`mouseup${i.button}`,i)})}dispatch(e,t){hm(e,t,t,this.eventMap)}};var lr=class extends j{constructor(e,t){super();this.element=$e({...t,onClick:()=>{e.value=!e.value}}),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add(t.backgroundScheme==="dark"?"dark-background":"light-background");let r=()=>{let i=e.value;this.element.dataset.checked=i?"true":"false",this.element.title=(i?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(r)),r()}};var A1='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="copyIconTitle"><rect width="12" height="14" x="8" y="7"></rect><polyline points="16 3 4 3 4 17"></polyline></svg>';function Jn(n={}){return $e({svg:A1,...n})}var I1=class extends j{constructor(e){super();this.redraw=e}},Kn=class extends j{constructor(e,t,r=new Pt(Pt.VISIBLE)){super();this.model=e;this.render=t;this.visibility=r;this.element=document.createElement("div");this.generation=-1;this.currentViewDisposer=void 0;this.debouncedUpdateView=this.registerCancellable(Ge(()=>this.updateView()));this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(r.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;let{model:e}=this;if(e.changed.count===this.generation)return;this.disposeCurrentView();let r=this.currentViewDisposer=new I1(this.debouncedUpdateView);this.render(e.value,this.element,r)}disposeCurrentView(){let{currentViewDisposer:e}=this;e!==void 0&&e.dispose(),_e(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}};function ym(n={}){return $e({text:"\u2197",...n})}function vb(n){return n.closest(".neuroglancer-selection-details")}var vm=class extends Fr{constructor(e,t,r,i){super(e,t.location);this.sidePanelManager=e;this.state=t;this.manager=r;this.selectedLayer=i;this.body=document.createElement("div");let{element:a,body:o}=this;a.classList.add("neuroglancer-selection-details"),this.registerDisposer(new xn(this.element,Rc()));let{titleBar:l}=this.addTitleBar({title:"Selection"}),c=$e({svg:um,title:"Previous selection",onClick:()=>{this.state.goBack()}}),d=$e({svg:dm,title:"Next selection",onClick:()=>{this.state.goForward()}});l.appendChild(c),l.appendChild(d),l.appendChild(this.registerDisposer(new lr(t.pin,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),o.classList.add("neuroglancer-selection-details-body"),this.addBody(o),o.appendChild(this.registerDisposer(new Kn(t,(p,m,y)=>{if(!t.location.visible||(c.style.visibility=t.canGoBack()?"visible":"hidden",d.style.visibility=t.canGoForward()?"visible":"hidden",p===void 0))return;let{position:v}=p;if(v!==void 0){let b=document.createElement("div");b.classList.add("neuroglancer-selection-details-position");let x=Jn({title:"Copy position",onClick:()=>{en(D.map(M=>Math.floor(M)).join(", "))}});b.appendChild(x);let{coordinateSpace:{rank:C,names:k},position:D}=p;for(let M=0;M<C;++M){let I=document.createElement("span");I.classList.add("neuroglancer-selection-details-position-dimension");let E=document.createElement("span");E.classList.add("neuroglancer-selection-details-position-dimension-name"),E.textContent=k[M];let _=document.createElement("span");_.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),_.textContent=Math.floor(D[M]).toString(),I.appendChild(E),I.appendChild(_),b.appendChild(I)}let P=ym({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=D}});b.appendChild(P),m.appendChild(b)}for(let b of p.layers){let{layer:x}=b;m.appendChild(y.registerDisposer(new Kn({value:void 0,changed:x.managedLayer.layerChanged},(C,k,D)=>{if(x.wasDisposed||!x.isReady)return;let P=document.createElement("div");if(P.classList.add("neuroglancer-selection-details-layer-body"),!x.displaySelectionState(b.state,P,D))return;let M=document.createElement("div");k.appendChild(M),M.classList.add("neuroglancer-selection-details-layer");let I=document.createElement("div");I.classList.add("neuroglancer-selection-details-layer-title"),I.textContent=x.managedLayer.name,I.addEventListener("click",()=>{this.selectedLayer.layer=x.managedLayer,this.selectedLayer.visible=!0}),I.title="Click to show layer side panel",M.appendChild(I),M.appendChild(P)})).element)}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}};var M1='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="filterIconTitle"><path d="M10 12.261L4.028 3.972h16L14 12.329V17l-4 3z"></path></svg>';function R1(n={}){return $e({svg:M1,...n})}var ji=class{constructor(e,t,r){this.key=e;this.value=t;this.label=r}toString(){let{key:e,value:t,label:r}=this,i;return t===void 0?i=`${e}`:i=`${e}\u2192${t}`,r===void 0?i:`${i} ${r}`}},Sb=class extends j{constructor(){super(...arguments);this.selectedSegment=new X;this.baseSelectedSegment=new X;this.hasSelectedSegment=!1;this.changed=new ae}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){let{selectedSegment:r,baseSelectedSegment:i}=this,a=0,o=0,l=0,c=0,d;if(e==null)d=!1;else if(typeof e=="number")a=l=e>>>0,o=c=e<0?4294967295:0,d=!0;else if(e instanceof ji){let p=e.value||e.key;a=p.low,o=p.high,l=e.key.low,c=e.key.high,d=!0}else e instanceof X?(a=l=e.low,o=c=e.high,d=!0):d=!1;t&&a===0&&o===0&&(d=!1),d?d&&(!this.hasSelectedSegment||r.low!==a||r.high!==o||i.low!==l||i.high!==c)&&(r.low=a,r.high=o,i.low=l,i.high=c,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&X.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{let r=e.get(t),i;r!==void 0&&(i=r.value),this.set(i,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}};function Yd(n){n.useTemporarySegmentEquivalences.value=!1,n.useTemporaryVisibleSegments.value=!1,n.temporaryVisibleSegments.clear(),n.temporarySegmentEquivalences.clear()}function bb(n,e,t=!1){let r,i,a,o;if(typeof e=="number"?r=new X(e>>>0,e<0?4294967295:0):typeof e=="string"?r=X.parseString(e):r=t?e.clone():e,n==null)return r;let{segmentEquivalences:l,segmentPropertyMap:{value:c}}=n.segmentationGroupState.value;return l.size!==0?(i=l.get(r),X.equal(i,r)?a=void 0:a=i):i=r,o=c==null?void 0:c.getSegmentLabel(i),o===void 0&&a==null?r:new ji(r,a,o)}function is(n,e){if(e instanceof ji)return e;let t=bb(n,e);return t instanceof X?new ji(t):t}function _1(n,e){let{length:t}=e;n.value<t&&(n.value=t)}function as(n,e){return Rr(t=>e.style.setProperty("--neuroglancer-segment-list-width",`${t}ch`),n.segmentationGroupState.value.maxIdLength)}var xb=(()=>{let n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry");let e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-sticky"),n.appendChild(e);let t=Jn({title:"Copy segment ID"});t.classList.add("neuroglancer-segment-list-entry-copy");let r=document.createElement("div");r.classList.add("neuroglancer-segment-list-entry-copy-container");let i=r.childElementCount;r.appendChild(t);let a=e.childElementCount;e.appendChild(r);let o=e.childElementCount,l=document.createElement("input");l.type="checkbox",l.title="Toggle segment visibility",l.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.appendChild(l);let c=document.createElement("div");c.classList.add("neuroglancer-segment-list-entry-id-container");let d=e.childElementCount;e.appendChild(c);let p=document.createElement("div");p.classList.add("neuroglancer-segment-list-entry-id");let m=c.childElementCount;c.appendChild(p);let y=document.createElement("span");y.classList.add("neuroglancer-segment-list-entry-name");let v=n.childElementCount;n.appendChild(y);let b=R1({title:"Filter by label"});b.classList.add("neuroglancer-segment-list-entry-filter");let x=n.childElementCount;return n.appendChild(b),{template:n,copyContainerIndex:a,copyIndex:i,visibleIndex:o,idContainerIndex:d,idIndex:m,labelIndex:v,filterIndex:x,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),Yz=(()=>{let n=xb,e=n.template.cloneNode(!0),t=e.children[0],r=t.children[n.idContainerIndex],i=r.childElementCount,a=r.children[n.idIndex].cloneNode(!0);a.classList.add("neuroglancer-segment-list-entry-unmapped-id"),r.appendChild(a);let o=t.children[n.copyContainerIndex],l=o.childElementCount;return o.appendChild(o.children[n.copyIndex].cloneNode(!0)),{...n,template:e,unmappedIdIndex:i,unmappedCopyIndex:l}})();function Xz(n){let e=xb,t=e.template.cloneNode(!0),r=[];for(let i=0;i<n;++i){r.push(t.childElementCount);let a=document.createElement("div");a.classList.add("neuroglancer-segment-list-entry-extra-property"),a.style.width=`max(var(--neuroglancer-column-${i}-width), var(--neuroglancer-column-${i}-label-width))`,t.appendChild(a)}return{...e,template:t,numericalPropertyIndices:r}}var V1=new WeakMap;function Qz(n){let e=p=>{let m=p.currentTarget,y=m.dataset.id,v=qi;v.tryParseString(y),n.segmentSelectionState.set(v),vb(m)||n.selectSegment(v,!1)},t=p=>{let m=p.currentTarget,y=m.dataset.id,v=qi;v.tryParseString(y),n.selectSegment(v,vb(m)?"toggle":!0)},r=()=>{n.segmentSelectionState.set(null)},i=p=>p.currentTarget.closest(".neuroglancer-segment-list-entry"),a=p=>{let m=i(p);en(m.dataset.id),p.stopPropagation()},o=p=>{let m=i(p);en(m.dataset.unmappedId),p.stopPropagation()},l=p=>{let y=i(p).dataset.id,v=qi;v.tryParseString(y);let{visibleSegments:b}=n.segmentationGroupState.value;b.set(v,!b.has(v)),p.stopPropagation()},c=p=>{let y=i(p).dataset.id,v=qi;v.tryParseString(y),n.filterBySegmentLabel(v),p.stopPropagation()},d=p=>{if(p.button!==2||p.ctrlKey||p.altKey||p.metaKey||p.shiftKey)return;let y=p.currentTarget.dataset.id,v=qi;v.tryParseString(y),n.moveToSegment(v)};return(p,m)=>{let{children:y}=p,v=y[0].children;p.addEventListener("mousedown",d);let b=v[m.copyContainerIndex];m.unmappedCopyIndex!==-1&&b.children[m.unmappedCopyIndex].addEventListener("click",o),b.children[m.copyIndex].addEventListener("click",a),p.addEventListener("mouseenter",e),p.addEventListener("mouseleave",r),v[m.visibleIndex].addEventListener("click",l),y[m.filterIndex].addEventListener("click",c),p.addEventListener("action:select-position",t)}}var fl=class{constructor(e,t){this.displayState=e;this.template=t;if(e!==void 0){let r=V1.get(e);r===void 0&&(r=Qz(e),V1.set(e,r)),this.registerEventHandlers=r}}static make(e,t){return new fl(e,t?Yz:xb)}get(e){let{displayState:t}=this;return this.getWithNormalizedId(is(t,e))}getWithNormalizedId(e){var y,v;let{displayState:t}=this,{template:r}=this,i=r.template.cloneNode(!0),a=e.key,o=(y=e.value)!=null?y:a,l=o.toString();i.dataset.id=l;let{children:c}=i,d=c[0].children,p=d[r.idContainerIndex];p.children[r.idIndex].textContent=l;let{unmappedIdIndex:m}=r;if(t!==void 0?this.registerEventHandlers(i,r):d[r.visibleIndex].style.display="none",m!==-1){let b=p.children[m];if(X.equal(a,o)){b.style.display="none";let x=d[r.copyContainerIndex];x.children[r.unmappedCopyIndex].style.display="none"}else{let x=a.toString();i.dataset.unmappedId=x,b.textContent=x,t!==void 0&&_1(t.segmentationGroupState.value.maxIdLength,x)}}return c[r.labelIndex].textContent=(v=e.label)!=null?v:"",t!==void 0&&(this.updateWithId(i,o),_1(t.segmentationGroupState.value.maxIdLength,l)),i}update(e){let t=qi,r=e.dataset.id;r!==void 0&&(t.parseString(r),this.updateWithId(e,t))}updateWithId(e,t){let{children:r}=e,i=r[0].children,{template:a}=this,{displayState:o}=this,{segmentSelectionState:l}=o,{visibleSegments:c}=o.segmentationGroupState.value;i[a.visibleIndex].checked=c.has(t),e.dataset.selected=(l.hasSelectedSegment&&X.equal(l.selectedSegment,t)).toString();let d=i[a.idContainerIndex];O1(d.children[a.idIndex],Tb(this.displayState,t));let{unmappedIdIndex:p}=a;if(p!==-1){let m,y;if(o.baseSegmentColoring.value&&(m=e.dataset.unmappedId)!==void 0){let v=qi;v.parseString(m),y=Tb(this.displayState,v)}else y=Jf;O1(d.children[p],y)}}};function O1(n,e){n.style.backgroundColor=ab(e),n.style.color=pd(e)?"white":"black"}var Cb=class extends fl{constructor(e,t,r){var c;let i=e.segmentationGroupState.value.segmentPropertyMap.value,a=((c=i==null?void 0:i.numericalProperties)!=null?c:[]).filter(r),o=Xz(a.length);super(e,o);this.parentElement=t,this.segmentPropertyMap=i,this.numericalProperties=a,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){var a,o,l;let t=super.getWithNormalizedId(e),{numericalProperties:r}=this,{numericalPropertyIndices:i}=this.template;if(i.length>0){let c=(l=(o=this.segmentPropertyMap)==null?void 0:o.getSegmentInlineIndex((a=e.value)!=null?a:e.key))!=null?l:-1;if(c!==-1){let{numericalPropertyWidths:d}=this;for(let p=0,m=i.length;p<m;++p){let y=r[p].values[c];if(!isNaN(y)){let v=y.toString(),b=v.length;b>d[p]&&(d[p]=b,this.parentElement.style.setProperty(`--neuroglancer-column-${p}-width`,`${b}ch`)),t.children[i[p]].textContent=v}}}}return t}makeHeaderLabel(e,t,r){let i=document.createElement("span");i.textContent=e,i.classList.add("neuroglancer-segment-list-header-label"),i.classList.add("neuroglancer-segment-list-header-label"),e==="label"&&(r.style.textAlign="left");let a=document.createElement("span");a.classList.add("neuroglancer-segment-list-header-label-sort"),i.appendChild(a),a.textContent="\u25B2";let o=x1(i).width;return this.parentElement.style.setProperty(t,`${o}px`),r.appendChild(i),{id:e,label:i,sortIcon:a}}getHeader(){let{template:e}=this,t=e.template.cloneNode(!0),{children:r}=t,i=r[0].children,a=i[e.copyContainerIndex];a.style.visibility="hidden",i[e.visibleIndex].style.visibility="hidden",r[e.filterIndex].style.visibility="hidden";let o=i[e.idContainerIndex],l=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",o.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",r[e.labelIndex])],{numericalProperties:c}=this,{numericalPropertyIndices:d}=this.template;for(let p=0,m=d.length;p<m;++p){let y=c[p],v=this.makeHeaderLabel(y.id,`--neuroglancer-column-${p}-label-width`,t.children[d[p]]),{description:b}=y;b&&(v.label.title=b),l.push(v)}return{container:t,propertyLabels:l}}};function Xd(n,e){return fl.make(n!=null?n:void 0,!0).getWithNormalizedId(e)}function os(n,e,t){e.registerDisposer(Qa((r,i)=>{AD(r,i,t)},n.segmentationGroupState)),e.registerDisposer(Qa((r,i)=>{r.registerDisposer(i.segmentColorHash.changed.add(t)),r.registerDisposer(i.segmentDefaultColor.changed.add(t))},n.segmentationColorGroupState)),e.registerDisposer(n.saturation.changed.add(t)),e.registerDisposer(n.segmentSelectionState.changed.add(t)),e.registerDisposer(n.baseSegmentColoring.changed.add(t))}function wb(n,e){let t=e.redrawNeeded.dispatch;os(n,e,t),e.registerDisposer(Qa((r,i)=>{ID(r,i,t)},n.segmentationGroupState))}function Zz(n,e){wb(n,e),e.registerDisposer(n.objectAlpha.changed.add(e.redrawNeeded.dispatch))}function Qd(n,e){Zz(n,e),e.registerDisposer(n.transform.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.renderScaleTarget.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.transparentPickEnabled.changed.add(e.redrawNeeded.dispatch))}var N1=nr.create(),qi=new X;function Tb(n,e,t=N1){if(n==null)return t.fill(1),t;let r=n.segmentationColorGroupState.value,{segmentStatedColors:i}=r;if(i.size!==0&&r.segmentStatedColors.get(e,qi))return t[0]=(qi.low&255)/255,t[1]=((qi.low&65280)>>>8)/255,t[2]=((qi.low&16711680)>>>16)/255,t;let a=r.segmentDefaultColor.value;return a!==void 0?(t[0]=a[0],t[1]=a[1],t[2]=a[2],t):(r.segmentColorHash.compute(t,e),t)}function e6(n,e,t=1){let r=N1;r[3]=t,Tb(n,e,r);let i=n.saturation.value;n.segmentSelectionState.isSelected(e)&&(i>.5?i=i-=.5:i+=.5);for(let a=0;a<3;++a)r[a]=r[a]*i+(1-i);return r[0]*=t,r[1]*=t,r[2]*=t,r}function kb(n,e={}){for(let t of DD)e[t]=n[t].rpcId;return e}var t6=va(La),ss=class extends t6{constructor(e,t,r){super(r);this.chunkManager=e;this.displayState=t}initializeCounterpartWithChunkManager(e){let{displayState:t}=this;e.chunkManager=this.chunkManager.rpcId,kb(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(gt.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(gt.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}};function Zd(n,e,t,r,i){let a=Math.min(1,n.objectAlpha.value),o=n.baseSegmentColoring.value;Ea(n.segmentationGroupState.value,(l,c)=>{let d=r==null?void 0:r.registerUint64(e,l),p=t?e6(n,o?l:c,a):void 0;i(l,p,d,c)})}var n6=re.create(),vi=Et.create(),B1=!1;function U1(n,e){e.vertexBuffer=Nt.fromData(n,e.meshData.vertexPositions,n.ARRAY_BUFFER,n.STATIC_DRAW),e.indexBuffer=Nt.fromData(n,e.meshData.indices,n.ELEMENT_ARRAY_BUFFER,n.STATIC_DRAW),e.normalBuffer=Nt.fromData(n,e.meshData.vertexNormals,n.ARRAY_BUFFER,n.STATIC_DRAW)}function F1(n){n.vertexBuffer.dispose(),n.indexBuffer.dispose(),n.normalBuffer.dispose()}var r6=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function G1(n){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(e,t,r){r.vertexBuffer.bindToVertexAttrib(t.attribute("aVertexPosition"),3,n,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}var i6={[mi.float32]:G1(WebGL2RenderingContext.FLOAT),[mi.uint16]:G1(WebGL2RenderingContext.UNSIGNED_SHORT),[mi.uint10]:{defineShader:n=>{n.addAttribute("highp uint","aVertexPosition"),n.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(n,e,t){t.vertexBuffer.bindToVertexAttribI(e.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(n,e)=>{n.disableVertexAttribArray(e.attribute("aVertexPosition"))}}},Lb=class{constructor(e,t){this.fragmentRelativeVertices=e;this.vertexPositionFormat=t;this.tempLightVec=new Float32Array(4);this.vertexPositionHandler=i6[this.vertexPositionFormat]}beginLayer(e,t,r,i){let{lightDirection:a,ambientLighting:o,directionalLighting:l}=r,c=this.tempLightVec;J.scale(c,a,l),c[3]=o,e.uniform4fv(t.uniform("uLightDirection"),c);let d=i.silhouetteRendering.value;d>0&&e.uniform1f(t.uniform("uSilhouettePower"),d)}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginModel(e,t,r,i){let{projectionParameters:a}=r;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,re.multiply(n6,a.viewProjectionMat,i)),Us(vi,i),Rv(vi,vi,a.displayDimensionRenderInfo.canonicalVoxelFactors),Et.invert(vi,vi),Et.transpose(vi,vi),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,vi)}drawFragmentHelper(e,t,r,i,a){this.vertexPositionHandler.bind(e,t,r);let{meshData:o}=r;r.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),r.indexBuffer.bind();let{indices:l}=o;e.drawElements(o.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,a-i,l.BYTES_PER_ELEMENT===2?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,i*l.BYTES_PER_ELEMENT)}drawFragment(e,t,r){let{meshData:i}=r,{indices:a}=i;this.drawFragmentHelper(e,t,r,0,a.length)}drawMultiscaleFragment(e,t,r,i,a){let o=r.meshData.subChunkOffsets[i],l=r.meshData.subChunkOffsets[a];this.drawFragmentHelper(e,t,r,o,l)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){let t=e.registerDisposer(Qt(r=>r>0,[e.displayState.silhouetteRendering]));return ei(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(r,i)=>{this.vertexPositionHandler.defineShader(r),r.addAttribute("highp vec2","aVertexNormal"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec4","uLightDirection"),r.addUniform("highp vec4","uColor"),r.addUniform("highp mat3","uNormalMatrix"),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp uint","uPickID"),i&&r.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(r.addUniform("highp vec3","uFragmentOrigin"),r.addUniform("highp vec3","uFragmentShape")),r.addVertexCode(r6);let a="";this.fragmentRelativeVertices?a+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:a+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,a+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,i&&(a+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),r.setVertexMain(a),r.setFragmentMain("emit(vColor, uPickID);")}})}},Sm=class extends Ur{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.meshShaderManager=new Lb(!1,mi.float32);this.getShader=this.meshShaderManager.makeGetter(this);Qd(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new ss(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=ZD,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:r,displayState:i,meshShaderManager:a}=this;if(i.objectAlpha.value<=0)return;let o=es(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;let{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),a.beginLayer(r,l,e,this.displayState),a.beginModel(r,l,e,o);let c=this.source.chunks,d=0,p=0,{renderScaleHistogram:m}=this.displayState,y=this.source.fragmentSource.chunks;Zd(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(v,b,x)=>{let C=Nr(v),k=c.get(C);if(++d,k!==void 0){++p,e.emitColor&&a.setColor(r,l,b),e.emitPickID&&a.setPickID(r,l,x),d+=k.fragmentIds.length;for(let D of k.fragmentIds){let{key:P}=this.source.getFragmentKey(C,D),M=y.get(P);M!==void 0&&M.state===nt.GPU_MEMORY&&(a.drawFragment(r,l,M),++p)}}}),e.emitColor&&(m.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),m.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,p,d-p)),a.endLayer(r,l)}isReady(){let{displayState:e,source:t}=this,r=!0,i=t.fragmentSource.chunks;return Ea(e.segmentationGroupState.value,a=>{let o=Nr(a),l=t.chunks.get(o);if(l===void 0){r=!1;return}for(let c of l.fragmentIds){let{key:d}=this.source.getFragmentKey(o,c),p=i.get(d);if(p===void 0||p.state!==nt.GPU_MEMORY){r=!1;return}}}),r}},W1=class extends xr{constructor(e,t){super(e);this.fragmentIds=t.fragmentIds}},z1=class extends xr{constructor(e,t){super(e);this.meshData=t}copyToGPU(e){super.copyToGPU(e),U1(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),F1(this)}},kr=class extends jn{constructor(e,t){super(e,t);this.fragmentSource=this.registerDisposer(new bm(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new W1(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}},bm=class extends jn{constructor(e,t){super(e);this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new z1(this,e)}};bm=Lt([yn(t1)],bm);function H1(n,e,t,r){let i=n.get(tb(e,t,r));return i!==void 0&&i.state===nt.GPU_MEMORY}var ep=class extends Ur{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.meshShaderManager=new Lb(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat);this.getShader=this.meshShaderManager.makeGetter(this);Qd(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new ss(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=e1,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:r,displayState:i,meshShaderManager:a}=this;if(i.objectAlpha.value<=0)return;let o=es(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;let{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),a.beginLayer(r,l,e,this.displayState);let{renderScaleHistogram:c}=this.displayState;e.emitColor&&c.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),Us(vi,o),Rv(vi,vi,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);let d=Math.pow(Math.abs(Et.determinant(vi)),1/3),{chunks:p}=this.source,m=this.source.fragmentSource.chunks,{projectionParameters:y}=e,v=re.multiply(re.create(),y.viewProjectionMat,o),b=Fs(new Float32Array(24),v),x=this.displayState.renderScaleTarget.value,{fragmentRelativeVertices:C}=this.source.format;a.beginModel(r,l,e,o);let k=0,D=0;Zd(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(P,M,I)=>{let E=Nr(P),_=p.get(E);if(++k,_===void 0)return;++D;let{manifest:O}=_,{octree:B,chunkShape:W,chunkGridSpatialOrigin:V,vertexOffsets:U}=O;if(B1)try{i1(B)}catch(N){console.log(`invalid octree for object=${P}: ${N.message}`)}e.emitColor&&a.setColor(r,l,M),e.emitPickID&&a.setPickID(r,l,I),eb(O,v,b,x,y.width,y.height,(N,q,ne)=>{let pe=H1(m,E,N,q);return e.emitColor&&c.add(O.lodScales[N]*d,ne,pe?1:0,pe?0:1),pe},(N,q,ne,pe)=>{let me=tb(E,N,q),Pe=m.get(me),se=B[5*q],Te=B[5*q+1],Ae=B[5*q+2],Be=1<<N;if(C&&(r.uniform3f(l.uniform("uFragmentOrigin"),V[0]+se*W[0]*Be+U[N*3+0],V[1]+Te*W[1]*Be+U[N*3+1],V[2]+Ae*W[2]*Be+U[N*3+2]),r.uniform3f(l.uniform("uFragmentShape"),W[0]*Be,W[1]*Be,W[2]*Be)),B1){let Ze=`lod=${N}, chunkIndex=${q}, subChunkBegin=${ne}, subChunkEnd=${pe}, uFragmentOrigin=${[V[0]+se*W[0]*Be+U[N*3+0],V[1]+Te*W[1]*Be+U[N*3+1],V[2]+Ae*W[2]*Be+U[N*3+2]]}, uFragmentShape=${[W[0]*Be,W[1]*Be,W[2]*Be]}`,ge=e.pickIDs.registerUint64(this,P,1,Ze);e.emitPickID&&a.setPickID(r,l,ge)}a.drawMultiscaleFragment(r,l,Pe,ne,pe)})}),c.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,D,k-D),a.endLayer(r,l)}isReady(e,t){let{displayState:r}=this;if(r.objectAlpha.value<=0)return!0;let i=es(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(i===void 0)return!1;let{chunks:a}=this.source,o=this.source.fragmentSource.chunks,{projectionParameters:l}=e,c=re.multiply(re.create(),l.viewProjectionMat,i),d=Fs(new Float32Array(24),c),p=this.displayState.renderScaleTarget.value,m=!0;return Ea(r.segmentationGroupState.value,y=>{if(!m)return;let v=Nr(y),b=a.get(v);if(b===void 0){m=!1;return}let{manifest:x}=b;eb(x,c,d,p,l.width,l.height,(C,k)=>(m=m&&H1(o,v,C,k),m),()=>{})}),m}getObjectPosition(e){let t=this.displayState.transform.value;if(t.error!==void 0)return;let r=this.source.chunks.get(Nr(e));if(r===void 0)return;let{manifest:i}=r,{clipLowerBound:a,clipUpperBound:o}=i,{rank:l}=t,c=new Float32Array(l);for(let p=0;p<3;++p)c[p]=(a[p]+o[p])/2;let d=new Float32Array(l);return Xr(d,t.modelToRenderLayerTransform,l+1,c,l),d}},$1=class extends xr{constructor(e,t){super(e);this.manifest=t.manifest}},j1=class extends xr{constructor(e,t){super(e);this.meshData=t}copyToGPU(e){super.copyToGPU(e),U1(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),F1(this)}},go=class extends jn{constructor(e,t){super(e,t);this.fragmentSource=this.registerDisposer(new xm(this.chunkManager,this));this.format=t.format}static encodeOptions(e){return{format:e.format,...super.encodeOptions(e)}}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new $1(this,e)}},xm=class extends jn{constructor(e,t){super(e);this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new j1(this,e)}};xm=Lt([yn(n1)],xm);var q1="skeleton/SkeletonLayer";function an(n,e,t){le(n,e,r=>t.restoreState(r))}var ls=class extends j{constructor(){super(...arguments);this.children=new Map;this.changed=new ae}add(e,t){let{children:r}=this;if(r.has(e))throw new Error(`Key ${JSON.stringify(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){let{children:t}=this;if(t.has(e))throw new Error(`Key ${JSON.stringify(e)} not registered.`);let r=t.get(e);this.children.delete(e),r.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){let{changed:e}=this;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){let e=this.baseJSON();for(let[t,r]of this.children)e[t]=r.toJSON();return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){Q(e);for(let[t,r]of this.children)try{if(e.hasOwnProperty(t)){let i=e[t];if(i===void 0)continue;r.restoreState(i)}}catch(i){throw new Error(`Error restoring property ${JSON.stringify(t)}: ${i.message}`)}}};var J1=new WeakMap;function hl(n){let e=J1.get(n),t=n.changed.count;if(e!==void 0&&e.generation===t)return e;let r;if(n instanceof ls){r=n.baseJSON();for(let[i,a]of n.children)r[i]=hl(a).value}else r=n.toJSON();return e===void 0?(e={generation:t,value:r},J1.set(n,e)):(e.generation=t,e.value=r),e}var cs=class{constructor(e,t,r=t){this.enumType=e;this.value_=t;this.defaultValue=r;this.changed=new ae}set value(e){this.value_!==e&&(this.value_=e,this.changed.dispatch())}get value(){return this.value_}reset(){this.value=this.defaultValue}restoreState(e){this.value=Mt(e,this.enumType)}toJSON(){if(this.value_!==this.defaultValue)return this.enumType[this.value_].toLowerCase()}};var tp=6;var Nc=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function Bc(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,tp*e,t)}function a6(n,e){let t=new Float32Array((n+1)*(e+1)*3),r=0;for(let i=0;i<=n;++i){let a=i*Math.PI/n,o=Math.sin(a),l=Math.cos(a);for(let c=0;c<=e;++c){let d=c*2*Math.PI/e,p=Math.sin(d),m=Math.cos(d);t[r++]=m*o,t[r++]=l,t[r++]=p*o}}return t}function o6(n,e){let t=new Uint16Array(n*e*6),r=0;for(let i=0;i<n;i++)for(let a=0;a<e;a++){let o=i*(e+1)+a,l=o+e+1;t[r++]=o,t[r++]=l,t[r++]=o+1,t[r++]=l,t[r++]=l+1,t[r++]=o+1}return t}var np=class extends j{constructor(e,t,r){super();this.vertexBuffer=this.registerDisposer(lo(e,WebGL2RenderingContext.ARRAY_BUFFER,a6,t,r)).value,this.indexBuffer=this.registerDisposer(lo(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,o6,t,r)).value,this.numIndices=t*r*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){let r=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(r)}};var Uc=tp;function _a(n,e){n.addVertexCode(Nc),n.addUniform("highp vec3","uCircleParams"),n.addVarying("highp vec4","vCircleCoord"),n.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),e?n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),n.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function Va(n,e,t){let{gl:r}=n;r.uniform3f(n.uniform("uCircleParams"),1/e.width,1/e.height,Math.max(1e-6,t.featherWidthInPixels))}function Oa(n,e,t){Bc(n,e,t)}var Eb=class extends j{constructor(e){super();this.lightDirection=new Float32Array([1,0,0,0]);this.sphereHelper=this.registerDisposer(new np(e,20,20))}defineShader(e){e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVertexCode(`
float getRadiusAdjustment(vec3 vertex, float r) {
  float radiusAdjustment = 1.0;
  for (int i = 0; i < 3; ++i) {
    if (r != 0.0) {
      float d = vertex[i] - uModelClipBounds[i];
      radiusAdjustment -= d * d / (r * r);
    }
  }

  return sqrt(max(0.1, radiusAdjustment));
}
    `),this.sphereHelper.defineShader(e)}draw(e,t,r){let{gl:i}=e;i.uniformMatrix4fv(e.uniform("uNormalTransform"),!1,re.transpose(re.create(),t.renderSubspaceInvModelMatrix)),i.uniform4f(e.uniform("uLightDirection"),this.lightDirection[0],this.lightDirection[1],this.lightDirection[2],this.lightDirection[3]),this.sphereHelper.draw(e,r)}};var Si=tp;function _n(n,e=!1){n.addVertexCode(Nc),n.addUniform("highp vec3","uLineParams"),n.addVarying("highp float","vLineCoord"),n.addVarying("highp float","vLineFeatherFraction"),e&&(n.addVarying("highp float","vEndpointFraction"),n.addVarying("highp float","vLineCoordT"),n.addVarying("highp float","vLineBorderStartFraction")),n.addVertexCode(eD),n.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${e?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${e?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${e?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${e?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${e?", borderWidth":""});
}
`),e&&n.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),n.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function Vn(n,e,t){Bc(n,e,t)}function On(n,e,t){let{gl:r}=n;r.uniform3f(n.uniform("uLineParams"),1/e.width,1/e.height,t)}function Yn(n){n.addAttribute("int","aDummyVertexId",0),n.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}var Cn=class extends j{constructor(e){super();this.buffer=new Nt(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){let{buffer:t}=this,{gl:r}=t;t.bind(),e>this.size&&(this.size=e,r.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),r.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),r.vertexAttribDivisor(0,0),r.enableVertexAttribArray(0)}disable(){let{gl:e}=this.buffer;e.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new Cn(e))}};var s6=re.create(),K1=`void main() {
  emitDefault();
}
`,rp=[],l6=gi(new $i,H.FLOAT32,3),Pb=class extends j{constructor(e,t){super();this.base=e;this.targetIsSliceView=t;this.textureAccessHelper=new mo("vertexData");this.vertexIdHelper=this.registerDisposer(Cn.get(this.gl));this.edgeShaderGetter=ei(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),_n(e),e.addAttribute("highp uvec2","aVertexIndex"),e.addUniform("highp float","uLineWidth");let r=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),e.addFragmentCode(Oi);let{vertexAttributes:i}=this,a=i.length;for(let o=1;o<a;++o){let l=i[o];e.addVarying(`highp ${l.glslDataType}`,`vCustom${o}`),r+=`vCustom${o} = readAttribute${o}(vertexIndex);
`,e.addFragmentCode(`#define ${l.name} vCustom${o}
`)}e.setVertexMain(r),Ui(t,e),e.setFragmentMainFunction(Ni(t.parseResult.code))}});this.nodeShaderGetter=ei(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),_a(e,this.targetIsSliceView),e.addUniform("highp float","uNodeDiameter");let r=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),e.addFragmentCode(Oi);let{vertexAttributes:i}=this,a=i.length;for(let o=1;o<a;++o){let l=i[o];e.addVarying(`highp ${l.glslDataType}`,`vCustom${o}`),r+=`vCustom${o} = readAttribute${o}(vertexIndex);
`,e.addFragmentCode(`#define ${l.name} vCustom${o}
`)}e.setVertexMain(r),Ui(t,e),e.setFragmentMainFunction(Ni(t.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(e){Yn(e),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(e){let{textureAccessHelper:t}=this;t.defineShader(e);let r=this.vertexAttributes.length;for(let i=rp.length;i<r;++i)rp[i]=Symbol(`SkeletonShader.vertexAttributeTextureUnit${i}`);this.vertexAttributes.forEach((i,a)=>{e.addTextureSampler(`${Mc(i.dataType)}sampler2D`,`uVertexAttributeSampler${a}`,rp[a]),e.addVertexCode(t.getAccessor(`readAttribute${a}`,`uVertexAttributeSampler${a}`,i.dataType,i.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(e,t,r,i){let{viewProjectionMat:a}=r.projectionParameters,o=re.multiply(s6,a,i);e.uniformMatrix4fv(t.uniform("uProjection"),!1,o),this.vertexIdHelper.enable()}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}drawSkeleton(e,t,r,i,a){let{vertexAttributes:o}=this,l=o.length,{vertexAttributeTextures:c}=i;for(let d=0;d<l;++d){let p=WebGL2RenderingContext.TEXTURE0+t.textureUnit(rp[d]);e.activeTexture(p),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c[d])}{t.bind();let d=t.attribute("aVertexIndex");i.indexBuffer.bindToVertexAttribI(d,2,WebGL2RenderingContext.UNSIGNED_INT),e.vertexAttribDivisor(d,1),On(t,a,this.targetIsSliceView?1:0),Vn(e,1,i.numIndices/2),e.vertexAttribDivisor(d,0),e.disableVertexAttribArray(d)}r!==null&&(r.bind(),Va(r,a,{featherWidthInPixels:this.targetIsSliceView?1:0}),Oa(r.gl,2,i.numVertices))}endLayer(e,t){let{vertexAttributes:r}=this,i=r.length;for(let a=0;a<i;++a){let o=t.textureUnit(rp[a])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(o),e.bindTexture(e.TEXTURE_2D,null)}this.vertexIdHelper.disable()}},Fc;(function(t){t[t.LINES=0]="LINES",t[t.LINES_AND_POINTS=1]="LINES_AND_POINTS"})(Fc||(Fc={}));var Db=class extends cs{constructor(e,t=e){super(Fc,e,t)}},Ab=class extends ht{constructor(e,t=e){super(e,St,t)}},Ib=class{constructor(){this.compound=new ls;this.shader=Ko(K1);this.shaderControlState=new po(this.shader);this.params2d={mode:new Db(1),lineWidth:new Ab(2)};this.params3d={mode:new Db(0),lineWidth:new Ab(1)};let{compound:e}=this;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){e!==void 0&&this.compound.restoreState(e)}toJSON(){let e=this.compound.toJSON();for(let t of Object.values(e))if(t!==void 0)return e}},Mb=class extends j{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.layerChunkProgressInfo=new fo;this.redrawNeeded=new ae;this.fallbackShaderParameters=new Re(Xo(uo(K1)));Qd(r,this),this.displayState.shaderError.value=void 0;let{skeletonRenderingOptions:i}=r;this.registerDisposer(i.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));let a=this.sharedObject=this.registerDisposer(new ss(e,r,this.layerChunkProgressInfo));a.RPC_TYPE_ID=q1,a.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});let o=this.vertexAttributes=[u6];for(let[l,c]of t.vertexAttributes)o.push({name:l,dataType:c.dataType,numComponents:c.numComponents,webglDataType:c6(c.dataType),glslDataType:c.numComponents>1?`vec${c.numComponents}`:"float"})}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,r,i,a){let o=i.lineWidth.value,{gl:l,source:c,displayState:d}=this;if(d.objectAlpha.value<=0)return;let p=es(d.transform.value,e.projectionParameters.displayDimensionRenderInfo,a);if(p===void 0)return;let m;i.mode.value===1?m=Math.max(5,o*2):m=o;let y=r.edgeShaderGetter(e.emitter),v=r.nodeShaderGetter(e.emitter),{shader:b,parameters:x}=y,{shader:C,parameters:k}=v;if(b===null||C===null)return;let{shaderControlState:D}=this.displayState.skeletonRenderingOptions;b.bind(),r.beginLayer(l,b,e,p),ti(l,b,D,x.parseResult.controls),l.uniform1f(b.uniform("uLineWidth"),o),C.bind(),r.beginLayer(l,C,e,p),l.uniform1f(C.uniform("uNodeDiameter"),m),ti(l,C,D,k.parseResult.controls);let P=c.chunks;Zd(d,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(M,I,E)=>{let _=Nr(M),O=P.get(_);O===void 0||O.state!==nt.GPU_MEMORY||(I!==void 0&&(b.bind(),r.setColor(l,b,I),C.bind(),r.setColor(l,C,I)),E!==void 0&&(b.bind(),r.setPickID(l,b,E),C.bind(),r.setPickID(l,C,E)),r.drawSkeleton(l,b,C,O,e.projectionParameters))}),r.endLayer(l,b)}isReady(){let{source:e,displayState:t}=this;if(t.objectAlpha.value<=0)return!0;let r=e.chunks,i=!0;return Ea(t.segmentationGroupState.value,a=>{let o=Nr(a),l=r.get(o);if(l===void 0||l.state!==nt.GPU_MEMORY){i=!1;return}}),i}},ip=class extends Ur{constructor(e){super();this.base=e;this.renderHelper=this.registerDisposer(new Pb(this.base,!1));this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d;this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}},Cm=class extends pi{constructor(e){super();this.base=e;this.renderHelper=this.registerDisposer(new Pb(this.base,!0));this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d;this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}};function c6(n){switch(n){case H.FLOAT32:return WebGL2RenderingContext.FLOAT;default:throw new Error(`Data type not supported by WebGL: ${H[n]}`)}}var u6={dataType:H.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"},Y1=class extends xr{constructor(e,t){super(e);this.vertexAttributes=t.vertexAttributes;let r=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=r.length}copyToGPU(e){super.copyToGPU(e);let{attributeTextureFormats:t}=this.source,{vertexAttributes:r,vertexAttributeOffsets:i}=this,a=this.vertexAttributeTextures=[];for(let o=0,l=i.length;o<l;++o){let c=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c),ns(e,t[o],r.subarray(i[o],o+1!==l?i[o+1]:r.length)),a[o]=c}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=Nt.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);let{vertexAttributeTextures:t}=this;for(let r of t)e.deleteTexture(r);t.length=0,this.indexBuffer.dispose()}},d6=new Map;function p6(n){let e=[l6];for(let t of n.values())e.push(gi(new $i,t.dataType,t.numComponents));return e}var yo=class extends jn{get attributeTextureFormats(){let e=this.attributeTextureFormats_;return e===void 0&&(e=this.attributeTextureFormats_=p6(this.vertexAttributes)),e}getChunk(e){return new Y1(this,e)}constructor(e,t){super(e,t)}get vertexAttributes(){return d6}};var dt;(function(r){r[r.UNKNOWN=0]="UNKNOWN",r[r.IMAGE=1]="IMAGE",r[r.SEGMENTATION=2]="SEGMENTATION"})(dt||(dt={}));function wm(n){let{rank:e,dataType:t,compressedSegmentationBlockSize:r}=n,{baseVoxelOffset:i=new Float32Array(e)}=n;return{...di(n),compressedSegmentationBlockSize:r,baseVoxelOffset:i,dataType:t}}function f6(n){if(n.compressedSegmentationBlockSize!==void 0||n.volumeType!==2&&!n.volumeSourceOptions.discreteValues)return!1;switch(n.dataType){case H.UINT32:case H.UINT64:break;default:return!1}switch(n.rank){case 3:return!0;case 4:{let{chunkDataSize:e}=n;return e[3]===1}default:return!1}}function Rb(n){let{rank:e,lowerVoxelBound:t,upperVoxelBound:r}=n;if(!f6(n))return wm(n);let{volumeSourceOptions:{displayRank:i,multiscaleToViewTransform:a},chunkToMultiscaleTransform:o,chunkToViewTransform:l}=n;l===void 0&&(l=Hs(new Float32Array(e*i),i,a,i,o,e+1,i,e,e));let{maxCompressedSegmentationBlockSize:c,chunkDataSize:d}=n;return wm({...n,compressedSegmentationBlockSize:Float32Array.from(kd({rank:e,chunkToViewTransform:l,displayRank:i,lowerVoxelBound:t,upperVoxelBound:r,maxVoxelsPerChunkLog2:9,maxBlockSize:c===void 0?d:_E(new Uint32Array(e),d,c)}))})}function bi(n){let{rank:e}=n,{volumeSourceOptions:{displayRank:t,multiscaleToViewTransform:r,modelChannelDimensionIndices:i},chunkToMultiscaleTransform:a}=n,o=Hs(new Float32Array(t*e),t,r,t,a,e+1,t,e,e),{minBlockSize:l}=n;l===void 0?(l=new Uint32Array(e),l.fill(1)):l=new Uint32Array(l);let{lowerVoxelBound:c,upperVoxelBound:d}=n;if(i.length!==0)for(let m of Gs(a,e,i)){let y=d[m];c!==void 0&&(y-=c[m]),l[m]=y}let{chunkDataSizes:p=lP({...n,minBlockSize:l,chunkToViewTransform:o,displayRank:t})}=n;return p.map(m=>Rb({...n,chunkDataSize:m,chunkToViewTransform:o}))}function Tm(n,e,t,r){let{dataType:i}=e;e.defineShader(n,t);let a="",o="";if(t===0)a+="highp int ignoredChannelIndex";else for(let c=0;c<t;++c)c!==0&&(a+=", "),a+=`highp int channelIndex${c}`,o+=`, channelIndex${c}`;n.addFragmentCode(jP);let l=`
${Vt(i)} getDataValue(${a}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${r}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${o});
}
${Vt(i)} getInterpolatedDataValue(${a}) {
  highp vec3 positionWithinChunk = ${r};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${Vt(i)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${Vt(i)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${Vt(i)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${o});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;n.addFragmentCode(l),t<=1&&n.addFragmentCode(`
${Vt(i)} getDataValue() { return getDataValue(0); }
${Vt(i)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}var X1=new Array;function km(n){X1.push(n)}function h6(n,e){for(let t of X1){let r=t(n,e);if(r!=null)return r}throw new Error("No chunk format handler found.")}var Xn=class extends rl{constructor(e,t){super(e,t);this.chunkFormatHandler=this.registerDisposer(h6(e.chunkQueueManager.gl,this.spec));let r=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(r),this.tempPositionWithinChunk=new Uint32Array(r)}static encodeSpec(e){let t=e;return{...super.encodeSpec(e),dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&Array.from(t.compressedSegmentationBlockSize),baseVoxelOffset:Array.from(t.baseVoxelOffset)}}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){let r=this.spec.rank,i=this.tempChunkGridPosition,a=this.tempPositionWithinChunk,{spec:o}=this;{let{chunkDataSize:x}=o;for(let C=0;C<r;++C){let k=e[C],D=x[C],P=Math.floor(k/D);i[C]=P,a[C]=Math.floor(k-D*P)}}let l=this.chunks.get(i.join());if(l===void 0)return null;let c=l.chunkDataSize;for(let x=0;x<3;++x)if(a[x]>=c[x])return;if(t.channelSpaceShape.length===0)return l.getValueAt(a);let{numChannels:d,chunkChannelCoordinates:p,chunkChannelDimensionIndices:m}=t,y=m.length,v=0,b=new Array(d);for(let x=0;x<d;++x){for(let C=0;C<y;++C)a[m[C]]=p[v++];b[x]=l.getValueAt(a)}return b}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}},_b=class extends Fd{get chunkFormat(){return this.source.chunkFormat}constructor(e,t){super(e,t);this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}},Gt=class extends qS{};var Q1=class extends Qe(rt()(Xn),Zh){},Z1=class extends Qe(rt()(go),em){},eA=class extends Qe(rt()(kr),tm){},tA=class extends Qe(rt()(yo),nm){},nA=class extends Qe(rt()(zi),im){},ap=new Map;ap.set("UINT8",H.UINT8);ap.set("FLOAT",H.FLOAT32);ap.set("UINT32",H.UINT32);ap.set("UINT64",H.UINT64);function m6(n){Q(n);try{return{corner:G(n,"corner",e=>fd(J.create(),e,Ye)),size:G(n,"size",e=>fd(J.create(),e,St)),metadata:G(n,"metadata",Ft)}}catch(e){throw new Error(`Failed to parse bounding box: ${e.message}`)}}var rA=class{constructor(e){try{Q(e),this.numChannels=G(e,"channelCount",wt),this.dataType=G(e,"channelType",t=>ih(t,ap)),this.voxelSize=G(e,"pixelSize",t=>fd(J.create(),t,St)),this.upperVoxelBound=G(e,"volumeSize",t=>fd(J.create(),t,wt)),this.boundingBoxes=G(e,"boundingBox",t=>t===void 0?[]:ye(t,m6))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}};function g6(n){return Q(n),{name:G(n,"name",ee),type:G(n,"type",ee)}}function y6(n){try{return Q(n),G(n,"meshes",e=>e===void 0?[]:ye(e,g6))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}var v6="([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",Vb="([0-9]+)",iA=new RegExp(`^(.*)_${Vb}x${Vb}x${Vb}_lod([0-9]+)_${v6}$`);function S6(n,e){let t=new Map,r=n.scales[0],i=new Set;for(let o of e){if(o.type!=="TRIANGLES")continue;let l=o.name.match(iA);if(l===null)continue;let c=l[1],d=t.get(c);d===void 0&&(d={key:c,chunkShape:J.create(),lods:[]},t.set(c,d));let p=parseInt(l[5]);if(d.lods[p]!==void 0){i.add(c);continue}let m=J.fromValues(parseInt(l[2],10),parseInt(l[3],10),parseInt(l[4],10)),y=new Uint32Array(3);for(let v=0;v<3;++v)y[v]=Math.ceil(r.upperVoxelBound[v]/m[v]);d.lods[p]={info:o,scale:parseFloat(l[6]),relativeBlockShape:m,gridShape:y}}let a=[];e:for(let o of t.values()){if(i.has(o.key))continue e;let l=o.lods[0];if(l===void 0)continue e;let c=l.relativeBlockShape;J.multiply(o.chunkShape,c,r.voxelSize);for(let d=1;d<o.lods.length;++d){let p=o.lods[d];if(p===void 0)continue e;let{relativeBlockShape:m}=p;for(let y=0;y<3;++y){let v=m[y],b=c[y];if(v<b||v%b!=0)continue e;m[y]=v/b}}c.fill(1),a.push(o)}return a}function b6(n,e){let t=S6(n,e),r=[],i=o=>{r.some(l=>l.name===o.name)||r.push(o)},a=new Set;for(let o of t){i({multi:o,single:void 0,name:o.key,partOfMultiscale:!1});for(let l of o.lods)a.add(l.info)}for(let o of e)i({single:o,multi:void 0,name:o.name,partOfMultiscale:a.has(o)});return r}var aA=class{constructor(e){try{Q(e);let t=this.scales=G(e,"geometry",o=>ye(o,l=>new rA(l)));if(t.length===0)throw new Error("Expected at least one scale.");let r=t[0],i=this.numChannels=r.numChannels,a=this.dataType=r.dataType;for(let o=1,l=t.length;o<l;++o){let c=t[o];if(c.dataType!==a)throw new Error(`Scale ${o} has data type ${H[c.dataType]} but scale 0 has data type ${H[a]}.`);if(c.numChannels!==i)throw new Error(`Scale ${o} has ${c.numChannels} channel(s) but scale 0 has ${i} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(r.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(e=!1){let t=this.scales[0],r=["x","y","z"],i=["m","m","m"],a=Array.from(t.voxelSize,c=>c/1e9),o=[0,0,0],l=Array.from(t.upperVoxelBound);return e&&(r.push("c^"),i.push(""),a.push(1),o.push(0),l.push(this.numChannels)),Ne({names:r,units:i,scales:Float64Array.from(a),boundingBoxes:[Mn({lowerBounds:new Float64Array(r.length),upperBounds:Float64Array.from(l)})]})}},oA=class extends Gt{constructor(e,t,r,i,a,o,l){super(e);this.instance=t;this.credentialsProvider=r;this.volumeId=i;this.changeSpec=a;this.multiscaleVolumeInfo=o;this.encoding=l.encoding,this.jpegQuality=l.jpegQuality,this.chunkLayoutPreference=l.chunkLayoutPreference;let c=dt.IMAGE;this.dataType===H.UINT64&&(c=dt.SEGMENTATION),this.volumeType=c}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return this.multiscaleVolumeInfo.numChannels!==1?4:3}getSources(e){let t=Ia.RAW;(this.dataType===H.UINT64||this.dataType===H.UINT32)&&this.volumeType===dt.SEGMENTATION&&this.encoding!==Ia.RAW?t=Ia.COMPRESSED_SEGMENTATION:this.volumeType===dt.IMAGE&&this.dataType===H.UINT8&&this.multiscaleVolumeInfo.numChannels===1&&this.encoding!==Ia.RAW&&e.discreteValues!==!0&&(t=Ia.JPEG);let r=t===Ia.JPEG?this.jpegQuality:void 0,i=this.scales[0],{upperVoxelBound:a}=i,o=J.create(),{rank:l}=this;return Mr(this.scales.map((c,d)=>{J.divide(o,c.voxelSize,i.voxelSize);let p=c.upperVoxelBound,m,{numChannels:y}=c,v=new Float32Array((l+1)**2);v[(l+1)*l+l]=1;let b=new Float32Array(l);y!==1&&(p=Float32Array.of(...p,y),m=Uint32Array.of(1,1,1,y),v[(l+1)*3+3]=1,b[3]=y);for(let x=0;x<3;++x)v[(l+1)*x+x]=o[x],b[x]=a[x]/o[x];return bi({rank:l,minBlockSize:m,chunkToMultiscaleTransform:v,dataType:c.dataType,upperVoxelBound:p,volumeType:this.volumeType,volumeSourceOptions:e,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:J.fromValues(64,64,64)}).map(x=>({chunkSource:this.chunkManager.getChunkSource(Q1,{credentialsProvider:this.credentialsProvider,spec:x,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:d,encoding:t,jpegQuality:r,instance:this.instance}}),chunkToMultiscaleTransform:v,upperClipBound:b}))}))}};function x6(n){let e=re.create(),t=n.scales[0].voxelSize;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}function C6(n){let e=n.match(/^([^:?\/]+:[^:?\/]+:[^:?\/]+)(?::([^:?\/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(e===null)throw new Error(`Invalid Brain Maps volume key: ${JSON.stringify(n)}.`);let t;e[2]!==void 0&&(t={changeStackId:e[2]});let r=Vr(e[4]||"");return{volumeId:e[1],changeSpec:t,meshName:e[3],parameters:r}}function w6(n){try{return Q(n),{id:G(n,"id",ee),label:G(n,"label",ee),description:G(n,"description",Ft)}}catch(e){throw new Error(`Failed to parse project: ${e.message}`)}}function T6(n){try{return Q(n),G(n,"project",e=>e===void 0?[]:ye(e,w6))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}function sA(n,e){try{return Q(n),G(n,e,t=>t===void 0?[]:ye(t,ee))}catch(t){throw new Error(`Error parsing dataset list: ${t.message}`)}}function k6(n){return G(n,"changeStackId",e=>e===void 0?void 0:ye(e,ee))}var L6=Qe(rt()(vn),rm),lA=class extends L6{constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:[],...t});this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){let{upperVoxelBound:e}=this.parameters,t=di({rank:3,chunkDataSize:e,upperVoxelBound:e}),r=re.create();return[[{chunkSource:this.chunkManager.getChunkSource(nA,{parent:this,spec:{limit:0,chunkToMultiscaleTransform:r,...t},parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:r}]]}},E6=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}],Lm=class extends Rt{constructor(e,t){super();this.instance=e;this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:ct(this.credentialsProvider)},()=>ll(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then(r=>new aA(r)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:ct(this.credentialsProvider)},()=>ll(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then(r=>y6(r)))}get(e){let{volumeId:t,changeSpec:r,meshName:i,parameters:a}=C6(e.providerUrl);Q(a);let o=le(a,"encoding",p=>Mt(p,Ia)),l=le(a,"jpegQuality",p=>{let m=ot(p);if(m<1||m>100)throw new Error(`Expected integer in range [1, 100], but received: ${p}`);return m},70),c=le(a,"chunkLayout",p=>Mt(p,Js)),d={encoding:o,chunkLayoutPreference:c,jpegQuality:l};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:t,changeSpec:r,brainmapsOptions:d},async()=>{let[p,m]=await Promise.all([this.getMultiscaleInfo(e.chunkManager,t),this.getMeshesInfo(e.chunkManager,t)]),y=new oA(e.chunkManager,this.instance,this.credentialsProvider,t,r,p,d),v={modelTransform:mt(p.getModelSpace(p.numChannels!==1)),subsources:[{id:i===void 0?"default":"volume",subsource:{volume:y},default:i===void 0}]},b=In(p.box);p.scales[0].boundingBoxes.forEach((D,P)=>{b.add({type:be.AXIS_ALIGNED_BOUNDING_BOX,description:D.metadata,pointA:D.corner,pointB:J.add(J.create(),D.corner,D.size),id:`boundingBox${P}`,properties:[]})}),v.subsources.push({id:"bounds",subsource:{staticAnnotations:b},default:!0});let C=b6(p,m),k=(D,P)=>{let M,{single:I}=D;if(I!==void 0)I.type==="TRIANGLES"?M=e.chunkManager.getChunkSource(eA,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:I.name,changeSpec:r}}):M=e.chunkManager.getChunkSource(tA,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:D.name,changeSpec:r}});else{let E=D.multi;M=e.chunkManager.getChunkSource(Z1,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:mi.float32},parameters:{instance:this.instance,volumeId:t,info:E,changeSpec:r}})}v.subsources.push({id:i===void 0?`/${D.name}`:"default",subsource:{mesh:M},subsourceToModelSubspaceTransform:x6(p),modelSubspaceDimensionIndices:[0,1,2],default:P})};if(i!==void 0){let D=C.find(P=>P.name===i);if(D===void 0)throw new Error(`Mesh/skeleton source not found: ${JSON.stringify(D)}`);k(D,!0)}else{let D=!0;for(let P of C)P.partOfMultiscale||(k(P,D),D=!1)}return r!==void 0&&v.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(lA,{parameters:{volumeId:t,changestack:r.changeStackId,instance:this.instance,upperVoxelBound:p.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),v})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{let t=ll(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then(i=>T6(i)),r=`${this.instance.description} project list`;return Ce.forPromise(t,{delay:!0,initialMessage:`Retrieving ${r}.`,errorPrefix:`Error retrieving ${r}: `}),t})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{let r=ll(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then(a=>sA(a,"datasetIds")),i=`${this.instance.description} dataset list`;return Ce.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}`,errorPrefix:`Error retrieving ${i}`}),r})}getVolumeList(e,t,r){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${r}:getVolumeList`},()=>{let i=ll(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${r}`,responseType:"json"}).then(o=>{let l=sA(o,"volumeId"),c=t.length+r.length+2,d=[];for(let p of l)d.push(p.substring(c));return d}),a=`${this.instance.description} volume list`;return Ce.forPromise(i,{delay:!0,initialMessage:`Retrieving ${a}`,errorPrefix:`Error retrieving ${a}`}),i})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{let r=ll(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then(a=>k6(a)),i=`change stacks for ${t}`;return Ce.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}.`,errorPrefix:`Error retrieving ${i}: `}),r})}async completeUrl(e){let{providerUrl:t}=e,r=t.match(/^([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(r===null)throw null;let[,i,a,o,l,c,d]=r;if(d!==void 0)return Br(t.length-d.length,await Kh(d,E6));if(c!==void 0){let m=`${i}:${a}:${o}`,y=await this.getMeshesInfo(e.chunkManager,m),v=[],b=new Set;for(let x of y)if(!!x.name.startsWith(c))switch(x.type){case"LINE_SEGMENTS":v.push({value:x.name,description:"Skeletons"});break;case"TRIANGLES":{v.push({value:x.name,description:"Mesh (single-resolution)"});let C=x.name.match(iA);if(C!==null){let k=C[1];if(b.has(k))break;b.add(k),v.push({value:k,description:"Mesh (multi-resolution)"})}break}}return v.sort((x,C)=>ho(x.value,C.value)),{offset:t.length-c.length,completions:v}}if(l!==void 0){let m=`${i}:${a}:${o}`,y=await this.getChangeStackList(e.chunkManager,m);if(y===void 0)throw null;return{offset:t.length-l.length,completions:Jh(l,y)}}if(o!==void 0)return{offset:t.length-o.length,completions:Jh(o,await this.getVolumeList(e.chunkManager,i,a))};if(a!==void 0){let m=await this.getDatasetList(e.chunkManager,i);return{offset:t.length-a.length,completions:Jh(a,m.map(y=>`${y}:`))}}let p=await this.getProjectList(e.chunkManager);return{offset:0,completions:rn(i,p,m=>`${m.id}:`,m=>m.label)}}},cA={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};var Jt=class extends j{};function uA(n){let e,t,r;return(i,a)=>t!==void 0&&(e===void 0||i===void 0||e.generation!==i.generation)?(e===void 0&&r.addConsumer(a),t):(e=void 0,r=new gS,t=n(i,r).then(o=>(e=o,r=void 0,o),o=>{throw r.isCanceled&&(r=void 0,t=void 0),o}),t)}function on(n){let e=0;return uA((t,r)=>n(r).then(i=>({generation:++e,credentials:i})))}var dA=class{constructor(){this.providers=new Map;this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){let r=this.providers.get(e);if(r===void 0)throw new Error(`No registered credentials provider: ${JSON.stringify(e)}`);return r(t,this.topLevelManager)}},pA=class extends j{constructor(e){super();this.base=e;this.memoize=new vd}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}},op=class extends pA{constructor(){super(new dA);this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}},Ob=class extends Jt{constructor(e,t){super();this.baseProvider=e;this.anonymousCredentials=t;this.anonymous=!0;this.get=uA(e=>this.anonymous&&e===void 0?Promise.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(e)))}};var Nn=new op;var P6="https://accounts.google.com/o/oauth2/auth",fA="https://accounts.google.com";function D6(n,e){let t=document.createElement("iframe");t.style.display="none",t.id=n,t.name=n;let r=location.origin;t.src=`https://accounts.google.com/o/oauth2/postmessageRelay?parent=${encodeURIComponent(r)}#rpctoken=${e}`,document.body.appendChild(t)}var hA=class{constructor(){this.finished=new Me}},mA=class{constructor(){this.proxyName=`postmessageRelay${no()}`;this.rpcToken=`${no()}`;this.relayReadyService=`oauth2relayReady:${this.rpcToken}`;this.oauth2CallbackService=`oauth2callback:${this.rpcToken}`;this.pendingRequests=new Map;D6(this.proxyName,this.rpcToken),this.relayReadyPromise=new Promise(e=>{addEventListener("message",t=>{if(t.origin===fA)try{let r=Q(JSON.parse(t.data)),i=ee(r.s);if(i===this.relayReadyService&&e(),i===this.oauth2CallbackService){let a=ye(r.a,D=>D),o=ee(a[0]),l=location.origin;if(!o.startsWith(l+"#")&&!o.startsWith(l+"?"))throw new Error(`oauth2callback: URL ${JSON.stringify(o)} does not match current origin ${l}.`);let d=o.substring(l.length+1).split("&"),p=new Map;for(let D of d){let P=D.match("^([a-z_]+)=(.*)$");if(P===null)throw new Error(`oauth2callback: URL part ${JSON.stringify(P)} does not match expected pattern.`);p.set(P[1],P[2])}let m=p.get("state");if(m===void 0)throw new Error("oauth2callback: State argument is missing.");let y=this.pendingRequests.get(m);if(y===void 0)return;let v=p.get("error");if(v!==void 0){let D=p.get("error_subtype"),P=v;D!==void 0&&(P+=": "+D),y.finished.dispatch(void 0,new Error(`Error obtaining Google OAuth2 token: ${P}`));return}let b=p.get("access_token"),x=p.get("token_type"),C=p.get("expires_in"),k=p.get("scope");if(b===void 0||x===void 0||C===void 0||k===void 0)throw new Error("oauth2callback: URL lacks expected parameters.");y.finished.dispatch({accessToken:b,tokenType:x,expiresIn:C,scope:k});return}}catch(r){throw new Error(`Invalid message received from ${fA}: ${JSON.stringify(t.data)}: ${r.message}.`)}})})}addPendingRequest(e){let t=new hA;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${P6}?client_id=${encodeURIComponent(e.clientId)}`;t+="&redirect_uri=postmessage",t+="&response_type=token";let{origin:r=location.origin}=e;return t+=`&origin=${encodeURIComponent(r)}`,t+=`&proxy=${this.proxyName}`,t+="&include_granted_scopes=true",t+=`&scope=${encodeURIComponent(e.scopes.join(" "))}`,e.state&&(t+=`&state=${e.state}`),e.approvalPrompt&&(t+=`&approval_prompt=${encodeURIComponent(e.approvalPrompt)}`),e.loginHint&&(t+=`&login_hint=${encodeURIComponent(e.loginHint)}`),e.immediate&&(t+="&immediate=true"),e.authUser!==void 0&&(t+=`&authuser=${e.authUser}`),t}},Nb;function A6(){return Nb===void 0&&(Nb=new mA),Nb}function I6(n,e=Je){let t=no(),r=A6(),i=r.makeAuthRequestUrl({state:t,clientId:n.clientId,scopes:n.scopes,approvalPrompt:n.approvalPrompt,loginHint:n.loginHint,immediate:n.immediate,authUser:n.authUser}),a=r.addPendingRequest(t),o=new Promise((l,c)=>{a.finished.add((d,p)=>{d!==void 0?l(d):c(p)})});if(a.finished.add(e.add(()=>{a.finished.dispatch(void 0,ir)})),n.immediate)r.relayReadyPromise.then(()=>{if(e.isCanceled)return;let l=document.createElement("iframe");l.src=i,l.style.display="none",document.body.appendChild(l),a.finished.add(()=>{Xe(l)})});else if(!e.isCanceled){let l=open(i);l!==null&&a.finished.add(()=>{l.close()})}return o}var Bb=class extends Jt{constructor(e){super();this.options=e;this.get=on(e=>{let{options:t}=this,r=new Ce(!0),i;return new Promise((a,o)=>{let l=()=>{i=void 0,r.dispose()};e.add(()=>{i!==void 0&&(i.cancel(),i=void 0,r.dispose(),o(ir))});function c(p=`${t.description} authorization required.`,m="Request authorization."){r.setText(p+"  ");let y=document.createElement("button");y.textContent=m,r.element.appendChild(y),y.addEventListener("click",()=>{d(!1)}),r.setVisible(!0)}function d(p){i!==void 0&&i.cancel(),i=new $n,c(`Waiting for ${t.description} authorization...`,"Retry"),I6({clientId:t.clientId,scopes:t.scopes,immediate:p,authUser:0},i).then(m=>{i!==void 0&&(l(),a(m))},m=>{i!==void 0&&(i=void 0,p?c():c(`${t.description} authorization failed: ${m}.`,"Retry"))})}d(!0)})})}};var M6="https://www.googleapis.com/auth/brainmaps",Ub=class extends Bb{constructor(e){super({clientId:e,scopes:[M6],description:"Brain Maps"})}};Nn.register(zd,()=>new Ub("639403125587-4k5hgdfumtrvur8v48e3pr7oo91d765k.apps.googleusercontent.com"));var gA=new Map;function At(n,e){gA.set(n,e)}function yA(n){let e=new ZS(n.credentialsManager);for(let[t,r]of gA)e.register(t,r(n));return e}At("brainmaps",n=>new Lm(cA,n.credentialsManager.getCredentialsProvider(zd)));if(typeof NEUROGLANCER_BRAINMAPS_SERVERS!="undefined")for(let[n,e]of Object.entries(NEUROGLANCER_BRAINMAPS_SERVERS))At(`brainmaps-${n}`,t=>new Lm(e,t.credentialsManager.getCredentialsProvider(zd)));var Em="boss";function ml(n,e,t,r,i=Je){return Rn(e,t,r,i).catch(a=>{if(a.status!==500&&a.status!==401&&a.status!==403&&a.status!==504)throw a;return hi(n,e,t,r,o=>{let l=new Headers(t.headers);return l.set("Authorization",`Bearer ${o}`),{...t,headers:l}},o=>{let{status:l}=o;if(l===403||l===401)return"refresh";if(l===504)return"retry";throw o},i)})}var vA=class{},Pm=class extends vA{static stringify(e){return`boss:volume:${e.baseUrl}/${e.collection}/${e.experiment}/${e.channel}/${e.resolution}/${e.encoding}`}};Pm.RPC_ID="boss/VolumeChunkSource";var Dm=class{static stringify(e){return`boss:mesh:${e.baseUrl}`}};Dm.RPC_ID="boss/MeshChunkSource";var SA=class extends Qe(rt()(Xn),Pm){},bA=class extends Qe(rt()(kr),Dm){},Fb=new Map;Fb.set("image",dt.IMAGE);Fb.set("annotation",dt.SEGMENTATION);var R6=new Set(["npz","jpeg"]),_6=Uint32Array.of(512,512,16),gl;(function(i){i[i.NANOMETERS=0]="NANOMETERS",i[i.MICROMETERS=1]="MICROMETERS",i[i.MILLIMETERS=2]="MILLIMETERS",i[i.CENTIMETERS=3]="CENTIMETERS"})(gl||(gl={}));function V6(n){switch(n){case 1:return 1e6;case 2:return 1e3;case 3:return 100;case 0:return 1e9}}function O6(n,e){Q(n);let t=G(n,"voxel_unit",d=>Mt(d,gl)),r=V6(t),i=new Float32Array(3),a=new Float64Array(3),o=new Float64Array(3),l=new Float64Array(3),c=["x","y","z"];for(let d=0;d<3;++d){let p=c[d];i[d]=G(n,`${p}_voxel_size`,St),a[d]=i[d]/r,o[d]=G(n,`${p}_start`,ot),l[d]=G(n,`${p}_stop`,ot)}return e.coordFrame={voxelSizeBaseInMeters:a,voxelSizeBaseInOriginalUnits:i,voxelOffsetBase:o,imageSizeBase:l,voxelUnit:t,names:c},e}function N6(n){let e=Fb.get(n);return e===void 0&&(e=dt.UNKNOWN),e}function B6(n){Q(n);let e=G(n,"type",ee),t=!1;return G(n,"downsample_status",ee)==="DOWNSAMPLED"&&(t=!0),{channelType:e,description:G(n,"description",ee),volumeType:N6(e),dataType:G(n,"datatype",i=>Mt(i,H)),downsampled:t,scales:[],key:G(n,"name",ee),baseResolution:G(n,"base_resolution",ot)}}function U6(n,e,t,r,i,a){Q(n);let o=G(n,"channels",l=>ye(l,c=>G6(e,t,r,a,i,c)));return Promise.all(o).then(l=>{let c=new Map;l.forEach(p=>{c.set(p.key,p)});let d={channels:c,scalingLevels:G(n,"num_hierarchy_levels",ot),coordFrameKey:G(n,"coord_frame",ee),coordFrame:void 0,key:G(n,"name",ee),collection:G(n,"collection",ee)};return J6(e,t,r,d)})}var xA=class extends Gt{constructor(e,t,r,i,a,o){super(e);this.baseUrl=t;this.credentialsProvider=r;this.experimentInfo=i;this.parameters=o;this.meshPath=void 0;this.meshUrl=void 0;if(a===void 0){let m=Array.from(i.channels.keys());if(m.length!==1)throw new Error(`Experiment contains multiple channels: ${JSON.stringify(m)}`);a=m[0]}let l=i.channels.get(a);if(l===void 0)throw new Error(`Specified channel ${JSON.stringify(a)} is not one of the supported channels ${JSON.stringify(Array.from(i.channels.keys()))}`);if(this.channel=a,this.channelInfo=l,this.scales=l.scales,i.coordFrame===void 0)throw new Error(`Specified experiment ${JSON.stringify(i.key)} does not have a valid coordinate frame`);this.coordinateFrame=i.coordFrame,this.channelInfo.downsampled===!1&&(this.scales=[l.scales[0]]),this.experiment=i.key;let c=Ft(o.window);if(c!==void 0){let m=vr.create(),y=c.split(/,/);if(y.length===2)m[0]=Ye(y[0]),m[1]=Ye(y[1]);else if(y.length===1)m[0]=0,m[1]=Ye(y[1]);else throw new Error(`Invalid window. Must be either one value or two comma separated values: ${JSON.stringify(c)}`);if(this.window=m,this.window[0]===this.window[1])throw new Error(`Invalid window. First element must be different from second: ${JSON.stringify(c)}.`)}let d=Ft(o.meshurl);d!==void 0&&(this.meshUrl=d);let p=Ft(o.encoding);if(p===void 0)p=this.volumeType===dt.IMAGE?"jpeg":"npz";else if(!R6.has(p))throw new Error(`Invalid encoding: ${JSON.stringify(p)}.`);this.encoding=p}get dataType(){return this.channelInfo.dataType}get volumeType(){return this.channelInfo.volumeType}get rank(){return 3}getSources(e){let t=this.scales[0].downsampleFactors,{rank:r}=this;return Mr(this.scales.map(i=>{let a=this.coordinateFrame.voxelOffsetBase,o=J.create();for(let m=0;m<3;++m)o[m]=Math.ceil(a[m]);let l=i.downsampleFactors,c=r+1,d=new Float32Array(c*c);d[d.length-1]=1;for(let m=0;m<3;++m){let y=l[m]/t[m];d[c*m+m]=y,d[c*r+m]=o[m]*y}r===4&&(d[c*3+3]=1);let p=i.imageSize;return bi({rank:3,volumeType:this.volumeType,dataType:this.dataType,chunkToMultiscaleTransform:d,chunkDataSizes:[_6],baseVoxelOffset:o,upperVoxelBound:p,volumeSourceOptions:e}).map(m=>({chunkSource:this.chunkManager.getChunkSource(SA,{credentialsProvider:this.credentialsProvider,spec:m,parameters:{baseUrl:this.baseUrl,collection:this.experimentInfo.collection,experiment:this.experimentInfo.key,channel:this.channel,resolution:i.key,encoding:this.encoding,window:this.window}}),chunkToMultiscaleTransform:d}))}))}getMeshSource(){return this.meshUrl!==void 0?this.chunkManager.getChunkSource(bA,{credentialsProvider:this.credentialsProvider,parameters:{baseUrl:this.meshUrl}}):null}},F6=/^([^\/?]+)\/([^\/?]+)(?:\/([^\/?]+))?(?:\?(.*))?$/;function CA(n,e,t,r,i){return n.memoize.getUncounted({hostname:e,collection:i,experiment:r,type:"boss:getExperimentInfo"},()=>ml(t,`${e}/latest/collection/${i}/experiment/${r}/`,{},ut).then(a=>U6(a,n,e,t,i,r)))}function G6(n,e,t,r,i,a){return n.memoize.getUncounted({hostname:e,collection:i,experiment:r,channel:a,type:"boss:getChannelInfo"},()=>ml(t,`${e}/latest/collection/${i}/experiment/${r}/channel/${a}/`,{},ut).then(B6))}function W6(n,e,t,r,i,a){return n.memoize.getUncounted({hostname:e,collection:r,experiment:i.key,channel:a,downsample:!0,type:"boss:getDownsampleInfoForChannel"},()=>ml(t,`${e}/latest/downsample/${r}/${i.key}/${a}`,{},ut)).then(o=>H6(o,i,a))}function z6(n,e){Q(n);let t=G(n,"voxel_size",o=>eo(o,vE)),r=G(n,"extent",o=>eo(o,SE)),i=G(n,"num_hierarchy_levels",ot),a=new Array;for(let o=0;o<i;o++){let l=String(o),c=t.get(l),d=r.get(l);if(c===void 0||d===void 0)throw new Error(`Missing voxel_size/extent for resolution ${l}.`);let p=new Float32Array(3);for(let m=0;m<3;++m)p[m]=c[m]/e[m];a[o]={downsampleFactors:p,imageSize:d,key:l}}return a}function H6(n,e,t){let r=e.coordFrame;if(r===void 0)throw new Error(`Missing coordinate frame information for experiment ${e.key}. A valid coordinate frame is required to retrieve downsampling information.`);let i=e.channels.get(t);if(i===void 0)throw new Error(`Specified channel ${JSON.stringify(t)} is not one of the supported channels ${JSON.stringify(Array.from(e.channels.keys()))}`);return i.scales=z6(n,r.voxelSizeBaseInOriginalUnits),e.channels.set(t,i),e}function $6(n,e,t,r){let i=r.match(F6);if(i===null)throw new Error(`Invalid volume path ${JSON.stringify(r)}`);let a=i[1],o=i[2],l=i[3],c=Vr(i[4]||"");return n.memoize.getUncounted({hostname:e,path:r,type:"boss:getVolume"},async()=>{let d=await CA(n,e,t,o,a),p=await W6(n,e,t,a,d,l),m=new xA(n,e,t,p,l,c),y=p.coordFrame,v={lowerBounds:y.voxelOffsetBase,upperBounds:Float64Array.from(y.imageSizeBase,(C,k)=>y.voxelOffsetBase[k]+C)},b=Ne({rank:3,names:y.names,units:["m","m","m"],scales:y.voxelSizeBaseInMeters,boundingBoxes:[Mn(v)]});return{modelTransform:mt(b),subsources:[{id:"default",default:!0,subsource:{volume:m}},{id:"bounds",default:!0,subsource:{staticAnnotations:In(v)}}]}})}var wA=/^((?:http|https):\/\/[^\/?]+)\/(.*)$/;function j6(n,e,t){return n.memoize.getUncounted({hostname:e,type:"boss:getCollections"},()=>ml(t,`${e}/latest/collection/`,{},ut).then(r=>G(r,"collections",i=>ye(i,ee))))}function q6(n,e,t,r){return n.memoize.getUncounted({hostname:e,collection:r,type:"boss:getExperiments"},()=>ml(t,`${e}/latest/collection/${r}/experiment/`,{},ut).then(i=>G(i,"experiments",a=>ye(a,ee))))}function J6(n,e,t,r){let i=r.coordFrameKey;return n.memoize.getUncounted({hostname:e,coordinateframe:i,experimentInfo:r,type:"boss:getCoordinateFrame"},()=>ml(t,`${e}/latest/coord/${i}/`,{},ut).then(a=>O6(a,r)))}function K6(n,e,t,r){let i=r.match(/^(?:([^\/]+)(?:\/?([^\/]*)(?:\/?([^\/]*)(?:\/?([^\/]*)?))?)?)?$/);if(i===null||i[1]===void 0)return Promise.reject(null);if(i[2]===void 0){let a=i[1]||"";return j6(n,e,t).then(o=>({offset:0,completions:rn(a,o,l=>l+"/",()=>{})}))}if(i[3]===void 0){let a=i[2]||"";return q6(n,e,t,i[1]).then(o=>({offset:i[1].length+1,completions:rn(a,o,l=>l+"/",()=>{})}))}return CA(n,e,t,i[2],i[1]).then(a=>{let o=rn(i[3],a.channels,l=>l[0],l=>`${l[1].channelType} (${H[l[1].dataType]})`);return{offset:i[1].length+i[2].length+2,completions:o}})}function Y6(n){let e=n.match(/^(?:https:\/\/[^.]+([^\/]+))/);if(e===null)throw new Error(`Unable to construct auth server hostname from base hostname ${n}.`);return`https://auth${e[1]}/auth`}var Gb=class extends Rt{constructor(e){super();this.credentialsManager=e}get description(){return"bossDB: Block & Object Storage System"}getCredentialsProvider(e){let t=Y6(e);return this.credentialsManager.getCredentialsProvider(Em,t)}get(e){let t=e.providerUrl.match(wA);if(t===null)throw new Error(`Invalid boss volume path: ${JSON.stringify(e.providerUrl)}`);let r=this.getCredentialsProvider(e.providerUrl);return $6(e.chunkManager,t[1],r,t[2])}async completeUrl(e){let t=e.providerUrl.match(wA);if(t===null)throw null;let r=t[1],i=this.getCredentialsProvider(t[1]),a=t[2],o=await K6(e.chunkManager,r,i,a);return Br(t[1].length+1,o)}};var TA=class{constructor(){this.finished=new Me}},kA=class{constructor(){this.oidcCallbackService="bossAuthCallback";this.pendingRequests=new Map;this.registerListener()}registerListener(){addEventListener("message",e=>{if(e.origin===location.origin)try{let t=Q(JSON.parse(e.data));if(ee(t.service)===this.oidcCallbackService){let i=ee(t.access_token),a=ee(t.state),o=this.pendingRequests.get(a);if(o===void 0)return;o.finished.dispatch(i)}}catch(t){}})}addPendingRequest(e){let t=new TA;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${e.authServer}/realms/BOSS/protocol/openid-connect/auth?`;return t+=`client_id=${encodeURIComponent(e.clientId)}`,t+=`&redirect_uri=${encodeURIComponent(e.redirect_uri)}`,t+="&response_mode=fragment",t+="&response_type=code%20id_token%20token",e.state&&(t+=`&state=${e.state}`),e.nonce&&(t+=`&nonce=${e.nonce}`),t}},Wb;function X6(){return Wb===void 0&&(Wb=new kA),Wb}function Q6(n,e=Je){let t=no(),r=no(),i=X6(),a=i.makeAuthRequestUrl({state:t,clientId:n.clientId,redirect_uri:new URL("bossauth.html",window.location.href).href,authServer:n.authServer,nonce:r}),o=i.addPendingRequest(t),l=new Promise((c,d)=>{o.finished.add((p,m)=>{p!==void 0?c(p):d(m)})});if(o.finished.add(e.add(()=>{o.finished.dispatch(void 0,ir)})),!e.isCanceled){let c=open(a);c!==null&&o.finished.add(()=>{c.close()})}return l}var zb=class extends Jt{constructor(e){super();this.authServer=e;this.get=on(e=>{let t=new Ce(!0),r;return new Promise((i,a)=>{let o=()=>{r=void 0,t.dispose()};e.add(()=>{r!==void 0&&(r.cancel(),r=void 0,t.dispose(),a(ir))});function l(p="Boss authorization required.",m="Request authorization."){t.setText(p+" ");let y=document.createElement("button");y.textContent=m,t.element.appendChild(y),y.addEventListener("click",()=>{d()}),t.setVisible(!0)}let c=this.authServer;function d(){r!==void 0&&r.cancel(),r=new $n,l("Waiting for Boss authorization...","Retry"),Q6({realm:"boss",clientId:"endpoint",authServer:c},r).then(p=>{r!==void 0&&(o(),i(p))},p=>{r!==void 0&&(r=void 0,l(`Boss authorization failed: ${p}.`,"Retry"))})}l()})})}};Nn.register(Em,n=>new zb(n));At("boss",n=>new Gb(n.credentialsManager));var sp="DVID";function Am(n){return n.text()}function LA(n,e=Je){let t=`${n.url}`,r={method:n.method,body:n.payload};return n.responseType===""?Rn(t,r,Am,e):n.responseType==="arraybuffer"?Rn(t,r,sl,e):Rn(t,r,ut,e)}function EA(n,e,t=Je){return Z6(n,e.url,{method:e.method,body:e.payload},e.responseType===""?Am:e.responseType==="json"?ut:sl,t)}function Z6(n,e,t,r,i=Je){return hi(n,e,t,r,(a,o)=>{let l={...o};return a.token&&(l.headers={...l.headers,Authorization:`Bearer ${a}`}),l},a=>{let{status:o}=a;if(o===504)return"retry";throw a},i)}var eH=J.fromValues(128,128,128),ni;(function(i){i[i.JPEG=0]="JPEG",i[i.RAW=1]="RAW",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSED_SEGMENTATIONARRAY=3]="COMPRESSED_SEGMENTATIONARRAY"})(ni||(ni={}));var lp=class{},Im=class extends lp{};Im.RPC_ID="dvid/VolumeChunkSource";var Mm=class extends lp{};Mm.RPC_ID="dvid/SkeletonSource";var Rm=class extends lp{};Rm.RPC_ID="dvid/MeshSource";var Hb=class extends lp{constructor(){super(...arguments);this.chunkDataSize=eH}},cp=class extends Hb{};cp.RPC_ID="dvid/AnnotationSource";var _m=class extends Hb{};_m.RPC_ID="dvid/AnnotationChunkSource";var up=class{constructor(e,t){this.numLevels=1;try{if(Q(e),t==="dvid"){let r=G(e,"Extended",Q);if(r.MaxDownresLevel){let i=G(r,"MaxDownresLevel",wt);this.numLevels=i+1}this.voxelSize=G(r,"VoxelSize",i=>zo(J.create(),i)),this.upperVoxelBound=G(r,"MaxPoint",i=>zo(J.create(),i.map(a=>++a))),this.lowerVoxelBound=G(r,"MinPoint",i=>zo(J.create(),i)),this.blockSize=G(r,"BlockSize",i=>zo(J.create(),i))}else if(t==="gs"){Q(e);let r=G(e,"scales",o=>o);if(r.length===0)throw new Error("Expected at least one scale");let i=r[0];this.voxelSize=G(i,"resolution",o=>Wo(J.create(),o)),this.lowerVoxelBound=le(i,"offset",o=>zo(J.create(),o))||J.fromValues(0,0,0);let a=G(i,"size",o=>zo(J.create(),o));this.upperVoxelBound=J.add(J.create(),a,this.lowerVoxelBound),this.blockSize=J.fromValues(64,64,64)}else throw new Error("unrecognized volume info")}catch(r){throw new Error(`Failed to parse volume geometry: ${r.message}`)}}},$b=class{get numChannels(){return this.scales.length===0?0:this.scales[0].numChannels}constructor(e){try{this.scales=[],this.scales.push(e);let t=e.voxelSize,r=e.lowerVoxelBound,i=e.upperVoxelBound;for(let a=1;a<e.numLevels;++a){let o={...e};o.voxelSize=J.multiply(J.create(),t,J.fromValues(2,2,2)),t=o.voxelSize,o.upperVoxelBound=J.ceil(J.create(),J.divide(J.create(),i,J.fromValues(2,2,2))),i=o.upperVoxelBound,o.lowerVoxelBound=J.ceil(J.create(),J.divide(J.create(),r,J.fromValues(2,2,2))),r=o.lowerVoxelBound,this.scales.push(o)}}catch(t){throw new Error(`Failed to parse multiscale volume specification: ${t.message}`)}}};var Vm=new Map;Vm.set("uint8",H.UINT8);Vm.set("uint32",H.UINT32);Vm.set("uint64",H.UINT64);var jb=class{constructor(e){this.obj=e;Q(e),G(e,"TypeName",ee)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}get tags(){return this.obj.Tags}},qb=class{constructor(e,t,r){this.name=t;this.base=r;this.volumeInfo=new up(tH(r.tags,e),"dvid")}get lowerVoxelBound(){return this.volumeInfo.lowerVoxelBound}get upperVoxelBound(){return this.volumeInfo.upperVoxelBound}get blockSize(){return this.volumeInfo.blockSize}get voxelSize(){return this.volumeInfo.voxelSize}get numLevels(){return this.volumeInfo.numLevels}},PA=class extends Qe(rt()(Xn),Im){},DA=class extends Qe(rt()(yo),Mm){},AA=class extends Qe(rt()(kr),Rm){},dp=class extends qb{constructor(e,t,r,i,a){super(e,t,r);this.encoding=i;let o=G(e,"Extended",Q),l=G(o,"Values",d=>ye(d,Q));if(l.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");let c=new Set(a);if(i!==ni.COMPRESSED_SEGMENTATIONARRAY)for(;c.has(t+"_"+this.volumeInfo.numLevels.toString());)this.volumeInfo.numLevels+=1;c.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",c.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=G(l[0],"DataType",d=>ih(d,Vm))}get volumeType(){return this.encoding===ni.COMPRESSED_SEGMENTATION||this.encoding===ni.COMPRESSED_SEGMENTATIONARRAY?dt.SEGMENTATION:dt.IMAGE}getSources(e,t,r,i){let{encoding:a}=this,o=[],l=64;for(let c=0;c<this.numLevels;++c){let d=Math.pow(2,c),p=Math.pow(2,-c),m=J.create(),y=J.create();for(let k=0;k<3;++k){let D=Math.floor(this.lowerVoxelBound[k]*p);m[k]=D-D%l;let P=Math.ceil(this.upperVoxelBound[k]*p);y[k]=P,P%l!=0&&(y[k]+=l-P%l)}let v=t.dataInstanceKey;a!==ni.COMPRESSED_SEGMENTATIONARRAY&&c>0&&(v+="_"+c.toString());let b={...t,dataInstanceKey:v,dataScale:c.toString(),encoding:a},x=re.create();for(let k=0;k<3;++k)x[5*k]=d,x[12+k]=m[k]*d;let C=bi({rank:3,chunkToMultiscaleTransform:x,dataType:this.dataType,baseVoxelOffset:m,upperVoxelBound:J.subtract(J.create(),y,m),volumeType:this.volumeType,volumeSourceOptions:r,compressedSegmentationBlockSize:a===ni.COMPRESSED_SEGMENTATION||a===ni.COMPRESSED_SEGMENTATIONARRAY?J.fromValues(8,8,8):void 0}).map(k=>({chunkSource:e.getChunkSource(PA,{spec:k,parameters:b,credentialsProvider:i}),chunkToMultiscaleTransform:x}));o.push(C)}return Mr(o)}};function IA(n){let e=G(n,"Base",Q),t=G(e,"Syncs",jt);return t.length===1?t[0]:""}function tH(n,e){if(!n)return e;let t=e&&e.Extended||{},{MaxDownresLevel:r,MaxPoint:i,MinPoint:a,VoxelSize:o,BlockSize:l}=t;try{n.MaxDownresLevel&&typeof n.MaxDownresLevel=="string"?(r=parseInt(G(n,"MaxDownresLevel",ee)),r<0&&(r=t.MaxDownresLevel)):typeof n.MaxDownresLevel=="number"&&(r=G(n,"MaxDownresLevel",rh))}catch(p){}try{n.MaxPoint&&typeof n.MaxPoint=="string"?i=JSON.parse(G(n,"MaxPoint",ee)):Array.isArray(n.MaxPoint)&&n.MaxPoint.length===3&&(i=n.MaxPoint)}catch(p){}try{n.MinPoint&&typeof n.MinPoint=="string"?a=JSON.parse(G(n,"MinPoint",ee)):Array.isArray(n.MinPoint)&&n.MinPoint.length===3&&(a=n.MinPoint)}catch(p){}try{n.VoxelSize&&typeof n.VoxelSize=="string"?o=JSON.parse(G(n,"VoxelSize",ee)):Array.isArray(n.VoxelSize)&&n.VoxelSize.length===3&&(o=n.VoxelSize)}catch(p){}try{n.BlockSize&&typeof n.BlockSize=="string"?l=JSON.parse(G(n,"BlockSize",ee)):Array.isArray(n.BlockSize)&&n.BlockSize.length===3&&(l=n.BlockSize)}catch(p){}return{Base:e&&e.Base||{},Extended:{...t,VoxelSize:o,MinPoint:a,MaxPoint:i,MaxDownresLevel:r,BlockSize:l}}}var Jb=class extends qb{get tags(){return G(this.base.obj,"Tags",Q)}constructor(e,t,r){super(e,t,r)}};function nH(n,e,t){Q(n);let r=n[e],i=G(r,"Base",a=>new jb(a));if(i.typeName==="annotation"){let a=IA(r);return a&&(r=n[a]),new Jb(r,e,i)}return rH(r,e,t)}function rH(n,e,t){Q(n);let r=G(n,"Base",i=>new jb(i));switch(r.typeName){case"uint8blk":case"grayscale8":let i=r.compressionName.indexOf("jpeg")!==-1;return new dp(n,e,r,i?ni.JPEG:ni.RAW,t);case"labels64":case"labelblk":return new dp(n,e,r,ni.COMPRESSED_SEGMENTATION,t);case"labelarray":case"labelmap":return new dp(n,e,r,ni.COMPRESSED_SEGMENTATIONARRAY,t);default:throw new Error(`DVID data type ${JSON.stringify(r.typeName)} is not supported.`)}}var pp=class{constructor(e){this.errors=[];this.dataInstances=new Map;this.vnodes=new Set;if(e instanceof pp){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}Q(e),this.alias=G(e,"Alias",ee),this.description=G(e,"Description",ee);let t=G(e,"DataInstances",Q),r=Object.keys(t);for(let o of r)try{this.dataInstances.set(o,nH(t,o,r))}catch(l){let c=`Failed to parse data instance ${JSON.stringify(o)}: ${l.message}`;console.log(c),this.errors.push(c)}let i=G(e,"DAG",Q),a=G(i,"Nodes",Q);for(let o of Object.keys(a))this.vnodes.add(o)}};function iH(n){try{let e=eo(n,r=>new pp(r)),t=new Map;for(let[r,i]of e){t.set(r,i);for(let a of i.vnodes)if(a!==r){let o=new pp(i);t.set(a,o)}}for(let[r,i]of t)i.uuid=r;return t}catch(e){throw new Error(`Failed to parse DVID repositories info: ${e.message}`)}}var MA=class{constructor(e){this.repositories=iH(e)}getNode(e){let t=[];for(let r of this.repositories.keys())r.startsWith(e)&&t.push(r);if(t.length!==1)throw new Error(`Node key ${JSON.stringify(e)} matches ${JSON.stringify(t)} nodes.`);return this.repositories.get(t[0])}};function RA(n,e,t){return n.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:e},()=>{let r=EA(t,{url:`${e}/api/repos/info`,method:"GET",responseType:"json"}).then(a=>new MA(a)),i=`repository info for DVID server ${e}`;return Ce.forPromise(r,{initialMessage:`Retrieving ${i}.`,delay:!0,errorPrefix:`Error retrieving ${i}: `}),r})}var _A=class extends Gt{constructor(e,t,r,i){super(e);this.sourceParameters=t;this.info=r;this.credentialsProvider=i}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}get baseUrl(){return this.sourceParameters.baseUrl}get nodeKey(){return this.sourceParameters.nodeKey}get dataInstanceKey(){return this.sourceParameters.dataInstanceKey}get supervoxels(){return this.sourceParameters.supervoxels||!1}getSegmentPosition(e){let{dvidService:t}=this.sourceParameters;return t?fetch(`${t}/locate-body?dvid=${this.baseUrl}&uuid=${this.nodeKey}&segmentation=${this.dataInstanceKey}&body=${e.toString()}${this.supervoxels?"&supervoxels=true":""}`,{method:"GET"}).then(r=>r.json()).then(r=>new Float32Array(r)):Promise.reject("No locate service is available")}getSources(e){return this.info.getSources(this.chunkManager,this.sourceParameters,e,this.credentialsProvider)}},aH=/^((?:http|https):\/\/[^\/]+)\/([^\/]+)\/([^\/\?#]+)(?:(?:\?|#)(.*))?$/;function VA(n){if(n.startsWith("https"))return n+"/api/server/token"}function oH(n){let e=n.match(aH);if(e===null)throw new Error(`Invalid DVID URL: ${JSON.stringify(n)}.`);let t={baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]},r=e[4];if(r){let i=Vr(r);i.usertag==="true"&&(t.usertag=!0),i.user&&(t.user=i.user);let a=i.dvidService||i.dvidservice||i["dvid-service"];a&&(t.dvidService=a),(i.forceDvidService||i.forcedividservice||i["force-dvid-service"])&&(t.forceDvidService=!0),t.supervoxels=i.supervoxels==="true"}return t.authServer=VA(t.baseUrl),t}function sH(n,e,t){return n.usertag?J.sub(J.create(),t,e):n.chunkDataSize}function lH(n,e){let t=3,r=i=>{let{lowerVoxelBound:a,upperVoxelBound:o}=i,l=sH(e,a,o);return{spec:di({rank:t,chunkDataSize:Uint32Array.from(l),lowerVoxelBound:a,upperVoxelBound:o}),chunkToMultiscaleTransform:re.create()}};if(e.usertag){if(e.user)return[[r(n.scales[0])]];throw"Expecting a valid user"}else return[n.scales.map(i=>r(i))]}var cH=Qe(rt()(vn),cp),OA=class extends Qe(rt()(zi),_m){},NA=class extends cH{constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:t.parameters.properties,...t});this.readonly=!1;this.parameters=t.parameters,this.multiscaleVolumeInfo=t.multiscaleVolumeInfo,this.childAdded=this.childAdded||new Me,this.childUpdated=this.childUpdated||new Me,this.childDeleted=this.childDeleted||new Me,this.childRefreshed=this.childRefreshed||new ae,this.parameters.readonly!==void 0&&(this.readonly=this.parameters.readonly),this.parameters.user||(this.readonly=!0)}getSources(e){let t=lH(this.multiscaleVolumeInfo,this.parameters),r=0;return t[0].length>1&&(r=3),this.chunkSources=t.map(i=>i.map(({spec:a,chunkToMultiscaleTransform:o})=>({chunkSource:this.chunkManager.getChunkSource(OA,{spec:{limit:r,chunkToMultiscaleTransform:o,...a},parent:this,credentialsProvider:this.credentialsProvider,parameters:this.parameters}),chunkToMultiscaleTransform:o}))),this.chunkSources}invalidateCache(){this.metadataChunkSource.invalidateCache();for(let e of this.chunkSources)for(let t of e)t.chunkSource.invalidateCache();for(let e of this.segmentFilteredSources)e.invalidateCache();this.childRefreshed.dispatch()}};async function uH(n,e,t,r){let i=(o,l)=>n.chunkManager.getChunkSource(NA,{parameters:l,credentialsProvider:r,multiscaleVolumeInfo:o}),a=new $b(t.volumeInfo);return i(a,e)}async function dH(n,e,t,r){let i={lowerBounds:new Float64Array(t.lowerVoxelBound),upperBounds:Float64Array.from(t.upperVoxelBound)},a=Ne({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(t.voxelSize,c=>c/1e9),boundingBoxes:[Mn(i)]}),o=await uH(n,e,t,r);return{modelTransform:mt(a),subsources:[{id:"default",subsource:{annotation:o},default:!0}]}}function pH(n,e,t,r){let i=t,a={lowerBounds:new Float64Array(i.lowerVoxelBound),upperBounds:Float64Array.from(i.upperVoxelBound)},o=Ne({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(i.voxelSize,d=>d/1e9),boundingBoxes:[Mn(a)]}),l=new _A(n.chunkManager,e,i,r),c={modelTransform:mt(o),subsources:[{id:"default",subsource:{volume:l},default:!0}]};if(i.meshSrc){let d=re.create();for(let p=0;p<3;++p)d[5*p]=1/i.voxelSize[p];c.subsources.push({id:"meshes",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(AA,{parameters:{...e,segmentationName:i.name,dataInstanceKey:i.meshSrc},credentialsProvider:r})},subsourceToModelSubspaceTransform:d})}return i.skeletonSrc&&c.subsources.push({id:"skeletons",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(DA,{parameters:{...e,dataInstanceKey:i.skeletonSrc},credentialsProvider:r})}}),c.subsources.push({id:"bounds",subsource:{staticAnnotations:In(a)},default:!0}),c}function fH(n){return n.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",sourceUrl:n.providerUrl},async()=>{let e=oH(n.providerUrl),{baseUrl:t,nodeKey:r,dataInstanceKey:i}=e,a=r.indexOf(":"),o=a!==-1?r.slice(0,a):r,l=n.credentialsManager.getCredentialsProvider(sp,{dvidServer:e.baseUrl,authServer:e.authServer}),d=(await RA(n.chunkManager,t,l)).getNode(o);if(d===void 0)throw new Error(`Invalid node: ${JSON.stringify(r)}.`);let p=d.dataInstances.get(i);if(!p)throw new Error(`Invalid data instance ${i}.`);if(p.base.typeName==="annotation"){if(!(p instanceof Jb))throw new Error(`Invalid data instance ${i}.`);let m={...new cp,...e};return p.blockSize&&(m.chunkDataSize=p.blockSize),m.syncedLabel=IA({Base:p.base.obj}),m.properties=[{identifier:"rendering_attribute",description:"rendering attribute",type:"int32",default:0,min:0,max:5,step:1}],dH(n,m,p,l)}else{if(!(p instanceof dp))throw new Error(`Invalid data instance ${i}.`);return pH(n,e,p,l)}})}function hH(n,e){return{offset:0,completions:rn(e,n.dataInstances.values(),t=>t.name,t=>`${t.base.typeName}`)}}function mH(n,e){let t=e.match(/^(?:([^\/]+)(?:\/([^\/]*))?)?$/);if(t===null)throw new Error("Invalid DVID URL syntax.");if(t[2]===void 0)return{offset:0,completions:rn(e,n.repositories.values(),a=>a.uuid+"/",a=>`${a.alias}: ${a.description}`)};let r=t[1],i=n.getNode(r);return Br(r.length+1,hH(i,t[2]))}async function gH(n){let e=/^((?:http|https):\/\/[^\/]+)\/([^\?]*).*$/,r=n.providerUrl.match(e);if(r===null)throw null;let i=r[1],a=r[2],o=VA(i),l=await RA(n.chunkManager,i,n.credentialsManager.getCredentialsProvider(sp,{dvidServer:i,authServer:o}));return Br(i.length+1,mH(l,a))}var Kb=class extends Rt{constructor(e){super();this.credentialsManager=e}get description(){return"DVID"}get(e){return fH(e)}completeUrl(e){return gH(e)}};async function yH(n,e=Je){return{token:await Rn(n,{method:"GET",credentials:"include"},Am,e)}}var BA=class extends Jt{constructor(e){super();this.authServer=e;this.get=on(e=>{if(!this.authServer)return Promise.resolve({token:""});let t=new Ce(!0),r;return new Promise((i,a)=>{let o=()=>{r=void 0,t.dispose()};e.add(()=>{r!==void 0&&(r.cancel(),r=void 0,t.dispose(),a(ir))});function l(d,p="DVID authorization required.",m="Request authorization."){t.setText(p+" ");let y=document.createElement("button");y.textContent=m,t.element.appendChild(y),y.addEventListener("click",()=>{let v=d.match(/^[^\/]+\/\/[^\/\.]+\.([^\/]+)/);if(v){let b=`https://flyemlogin.${v[1]}/login`;window.alert(`Please log into ${b} and then refresh the neurogalncer page to try again.
If you are unable to log into ${b}, please check your authorization server ${d} to make sure it is correct.`)}else window.alert(`Please check your authorization server ${d} to make sure it is correct.`)}),t.setVisible(!0)}function c(d){r!==void 0&&r.cancel(),r=new $n,l(d,"Waiting for DVID authorization...","Retry"),yH(d,r).then(p=>{r!==void 0&&(o(),i(p))},p=>{r!==void 0&&(r=void 0,l(d,`DVID authorization failed: ${p}.`,"Retry"))})}c(this.authServer)})})}},Yb=class extends Ob{constructor(e,t){super(new BA(t),{})}};Nn.register(sp,n=>new Yb(n.dvidServer,n.authServer));At("dvid",n=>new Kb(n.credentialsManager));var vH="annotation.add.signal";bt(vH,function(n){let e=this.get(n.id),t=yd(n.newAnnotation);t&&(e.parent.updateReference(t),e.parent.childAdded.dispatch(t))});function Xb(n){class e extends n{constructor(...r){super(...r)}}return e}var Om=class{},UA=class extends Om{},FA=class extends Om{},GA=class extends Om{},SH=class extends Xb(UA){},bH=class extends Xb(FA){},xH=class extends Xb(GA){},Qb=class{constructor(e){this.annotation=e}get renderingAttribute(){if(this.kind==="Atlas")if(this.title){if(this.checked)return 1}else return-1;else{if(this.bookmarkType==="False Split")return 2;if(this.bookmarkType==="False Merge")return 3}return 0}updateProperties(){this.annotation.properties=[this.renderingAttribute]}get ext(){return this.annotation.ext===void 0&&(this.annotation.ext={}),this.annotation.ext}get prop(){return this.annotation.prop}set prop(e){this.annotation.prop=e}get bookmarkType(){if(this.prop)switch(this.prop.type){case"Split":return"False Merge";case"Merge":return"False Split";default:break}return"Other"}get type(){return this.annotation.type}get kind(){return this.annotation.kind}set kind(e){this.annotation.kind=e,this.update()}roundPos(){this.annotation.type===be.POINT?this.annotation.point=this.annotation.point.map(e=>Math.round(e)):(this.annotation.type===be.LINE||this.annotation.type===be.SPHERE)&&(this.annotation.pointA=this.annotation.pointA.map(e=>Math.round(e)),this.annotation.pointB=this.annotation.pointB.map(e=>Math.round(e)))}setProp(e){this.prop={...this.prop,...e}}get user(){return this.prop&&this.prop.user}set user(e){this.setProp({user:e})}get comment(){return this.prop&&this.prop.comment}get description(){return this.comment}updatePresentation(){this.title?this.annotation.description=this.title+": ":this.annotation.description="",this.description&&(this.annotation.description+=this.description)}update(){this.updatePresentation(),this.updateProperties()}set comment(e){this.setProp({comment:e}),this.updatePresentation()}updateComment(){this.comment=this.annotation.description||"",this.annotation.description=void 0}get title(){return this.prop&&this.prop.title}set title(e){this.setProp({title:e}),this.updatePresentation()}get timestamp(){return this.prop&&this.prop.timestamp?Number(this.prop.timestamp):0}addTimeStamp(){this.setProp({timestamp:String(Date.now())})}get checked(){return this.ext&&this.ext.verified||this.prop&&this.prop.checked||!1}set checked(e){this.setProp({checked:e})}get presentation(){return this.updatePresentation(),this.annotation.description||""}set presentation(e){this.annotation.description=e}};function CH(n){let e=n.split(".")[1];if(e){let t=e.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(window.atob(t).split("").map(function(i){return"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(r)}}function Zb(n,e){let t,r=CH(n);if(r&&("user"in r?t=r.user:"email"in r&&(t=r.email)),t){if(e&&e!==t)return}else t=e;return t}var WA={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["comment"],properties:{comment:{$id:"#/properties/Prop/properties/comment",type:"string",title:"Comment",default:""}}}}};var Gc=class extends Qb{get title(){return this.annotation.ext&&this.annotation.ext.title}set title(e){this.ext.title=e}get description(){return this.annotation.ext&&this.annotation.ext.description}set description(e){this.ext.description=e}get user(){return this.annotation.ext&&this.annotation.ext.user}set user(e){this.ext.user=e}get checked(){return this.ext&&this.ext.verified}set checked(e){this.ext.verified=e}};function zA(n){let e=n.match(/^\${(.*):JSON}$/);return e?JSON.parse(e[1]):null}var HA={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["description"],properties:{description:{$id:"#/properties/Prop/properties/description",type:"string",title:"Description",default:""}}}}},$A={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["title","description"],properties:{title:{$id:"#/properties/Prop/properties/title",type:"string",title:"Title",default:""},description:{$id:"#/properties/Prop/properties/description",type:"string",title:"Description",default:""}}}}};function jA(n){return Array.isArray(n)}function wH(n){return jA(n)||n===null?!1:typeof n=="object"}var ex=class{constructor(e){this.name=e;this.childNodeList=new Array;this.parentNode=null}isRoot(){return this.parentNode===null}isLeaf(){return this.childNodeList.length===0}*[Symbol.iterator](){function*e(t){yield t;for(let r of t.childNodeList)yield*e(r)}yield*e(this)}*leafNodes(){for(let e of this)e.childNodeList.length===0&&(yield e)}get fullName(){let e=this.name,t=this.parentNode;for(;t;)e=t.name+"/"+e,t=t.parentNode;return e}get nameArray(){let e=new Array;if(!this.isRoot()){e.push(this.name);let t=this.parentNode;for(;t&&!t.isRoot();)e.push(t.name),t=t.parentNode}return e}getPropertyValue(e){if(!this.isRoot()&&e){let t=this.nameArray,r=e;for(let i=t.length-1;i>=0;--i)if(wH(r)){let a=t[i];r=r[a]}else return r;return r}}};function qA(n,e){if(n.type=="object"){e.properties==null&&(e.properties={}),e.properties.title=n.title;let t=n.required;jA(t)&&t.forEach(r=>{let i=new ex(r);i.parentNode=e,e.childNodeList.push(i);let o=n.properties[r];qA(o,i)})}else e.properties=n}function JA(n,e){let t=new ex(e);return qA(n,t),t}var TH="annotation";function kH(n,e,t,r=!1){let i=document.createElement("div"),a=n.title;a&&i.appendChild(document.createTextNode(a));let o;switch(n.type){case"number":o=document.createElement("input"),typeof t=="number"&&(o.text=t);break;case"string":let l=n.enum;Array.isArray(l)?(o=document.createElement("select"),i.appendChild(o),l.forEach(c=>{let d=document.createElement("option");d.text=c,d.value=c,d.disabled=r,o.appendChild(d)}),t!==void 0&&(o.value=t)):(o=document.createElement("input"),o.setAttribute("autocomplete","off"),typeof t=="string"&&(o.value=t,o.setAttribute("value",t)));break;case"boolean":o=document.createElement("input"),o.type="checkbox",typeof t=="boolean"?o.checked=t:o.checked=t==1;break;default:break}return o&&(o.id=e,o.readOnly=r,i.appendChild(o)),i}function LH(n,e){return n+"/"+e}function EH(n,e,t,r=!1){let i=document.createElement("div"),a=JA(n,t);a.record=i;for(let o of a)if(!o.isRoot())if(o.isLeaf()){let l=o.getPropertyValue(e),c=kH(o.properties,o.fullName,l,r);o.parentNode.record.appendChild(c)}else{let l=document.createElement("fieldset"),c=document.createElement("legend");c.textContent=o.properties.title,l.appendChild(c),o.record=l,o.parentNode.record.appendChild(l)}return i}function PH(n,e,t=!1){return EH(n,e,TH,t)}function DH(n){let e=document.getElementById(n);if(e)return e.type==="checkbox"?e.checked:e.value}function KA(n,e,t,r){n.type==="object"?n.required.forEach(i=>{let a=t;e&&(typeof t[e]=="undefined"&&(t[e]={}),a=t[e]),KA(n.properties[i],i,a,LH(r,i))}):t[e]=DH(r)}function YA(n,e,t,r,i,a){let o={...n.value};if(o.type!==be.POINT&&o.type!==be.LINE&&o.type!==be.SPHERE)return null;e||(e=WA);let l=r(o),c=i?i(o):l.prop,d=PH(e,c?{Prop:c}:{},t.readonly),p=document.createElement("button");return p.textContent="update",p.onclick=()=>{let m={};KA(e,"",m,"annotation");let y=m.Prop;a?a(o,y):l.setProp(y),l.update(),t.update(n,o),t.commit(n)},d.appendChild(p),d}var AH=`
{
  "definitions": {},
  "type": "object",
  "required": [
    "Prop"
  ],
  "properties": {
    "Prop": {
      "$id": "#/properties/Prop",
      "type": "object",
      "title": "Properties",
      "required": [
        "comment",
        "type",
        "checked"
      ],
      "properties": {
        "comment": {
          "$id": "#/properties/Prop/properties/comment",
          "type": "string",
          "title": "Comment",
          "default": ""
        },
        "type": {
          "$id": "#/properties/Prop/properties/type",
          "type": "string",
          "title": "Type",
          "enum": ["Merge", "Split", "Other"]
        },
        "checked": {
          "$id": "#/properties/Prop/properties/checked",
          "type": "boolean",
          "title": "Checked"
        }
      }
    }
  }
}
`,jse=JSON.parse(AH);function tx(n){return n.text()}function nx(n,e,t,r=Je){let i={method:t.method,body:t.payload};return i.method==="POST"&&(i.headers={"Content-Type":"application/json"}),MH(n,e,t.url,i,t.responseType===""?tx:t.responseType==="json"?ut:sl,r)}function IH(n){return(e,t)=>{let r={...t};return e?r.headers={...r.headers,Authorization:`Bearer ${e}`}:n.startsWith("https:")&&(r.credentials="include"),r}}function MH(n,e,t,r,i,a=Je){return hi(n,t,r,i,IH(t),o=>{let{status:l}=o;if((l===403||l===401)&&e)return"refresh";if(l===504)return"retry";throw o},a)}var RH=!1,_H={neurohub:{clio:{auth:{getAuthResponse:()=>({id_token:"<test-token>"})}}}};function VH(n){return"neurohub"in n?Promise.resolve(n.neurohub.clio.auth.getAuthResponse().id_token):Promise.resolve("")}var rx=class extends Jt{constructor(e,t){super();this.authServer=e;this.retry=t;this.get=on(e=>{let t=new Ce(!0),r;return new Promise((i,a)=>{let o=()=>{r=void 0,t.dispose()};e.add(()=>{r!==void 0&&(r.cancel(),r=void 0,t.dispose(),a(ir))});let l=(p="Authorization required.",m="Request authorization.")=>{if(t.setText(p+" "),this.retry){let y=document.createElement("button");y.textContent=m,t.element.appendChild(y),y.addEventListener("click",this.retry)}t.setVisible(!0)},c=this.authServer;(()=>{r!==void 0&&r.cancel(),r=new $n,l("Waiting for authorization...","Retry"),this.getAuthToken(c,r).then(p=>{r!==void 0&&(o(),i(p))},p=>{r!==void 0&&(r=void 0,l(`Authorization failed: ${p}.`,"Retry"))})})()})})}getAuthToken(e,t=Je){if(e){if(e.startsWith("token:"))return Promise.resolve(e.substring(6));if(e=="neurohub")return VH(RH?_H:window);{let r=new Headers;return Rn(e,{method:"GET",headers:r},tx,t).catch(()=>Rn(e,{method:"GET"},tx,t))}}else return Promise.resolve("")}};var Nm="Clio",OH=/^([^\/]+:\/\/[^\/]+)\/([^\/]+)\/([^\/\?]+)(\?.*)?$/;function NH(n){let e=n.match(OH);if(e===null)throw new Error(`Invalid DVID URL: ${JSON.stringify(n)}.`);return{baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]}}function ix(n){let e=Da(n);return e.protocol==="precomputed"&&(e=Da(e.host+e.path)),e}function ax(n){let{protocol:e,host:t,path:r}=n;switch(e){case"gs":return`https://storage.googleapis.com/${t}${r}/info`;case"dvid":let i=NH(t+r);return`${i.baseUrl}/api/node/${i.nodeKey}/${i.dataInstanceKey}/info`;case"https":return`${e}://${t}${r}/info`;default:throw Error("Unrecognized volume information")}}var ox=class{constructor(e){this.parameters=e}getTopLevelUrl(){let{baseUrl:e,api:t}=this.parameters;return`${e}/${t||"clio_toplevel"}`}getDatasetsUrl(){return`${this.getTopLevelUrl()}/datasets`}getGrayscaleInfoUrl(){let e=ix(this.parameters.grayscale);return ax(e)}getAnnotationEndpoint(){return this.parameters.kind==="Atlas"?"atlas":"annotations"}getAnnotationEntryUrl(){return`${this.getTopLevelUrl()}/${this.getAnnotationEndpoint()}/${this.parameters.dataset}`}getAllAnnotationsUrl(){return this.getAnnotationEntryUrl()+(this.parameters.groups?`?groups=${this.parameters.groups}`:"")}hasPointQueryApi(){return this.parameters.api==="clio_toplevel"||this.parameters.kind==="Atlas"}getPostAnnotationUrl(e){return this.hasPointQueryApi()?`${this.getAnnotationEntryUrl()}?x=${e[0]}&y=${e[1]}&z=${e[2]}`:this.getAnnotationEntryUrl()}getDeleteAnnotationUrl(e){if(this.hasPointQueryApi()){let t=e.match(/(-?\d+)_(-?\d+)_(-?\d+)/);if(t)return this.getAnnotationUrl(t==null?void 0:t.slice(1,4))}return`${this.getAnnotationEntryUrl()}/${e}`}getAnnotationUrl(e){return`${this.getAnnotationEntryUrl()}?x=${e[0]}&y=${e[1]}&z=${e[2]}`}};var BH=J.fromValues(64,64,64),XA=class{};function QA(n){return n.authServer?n.authServer==="neurohub"||n.authServer.startsWith("http"):!1}var sx=class extends XA{constructor(){super(...arguments);this.chunkDataSize=BH}},fp=class extends sx{};fp.RPC_ID="clio/Annotation";var Bm=class extends sx{};Bm.RPC_ID="clio/AnnotationChunkSource";var ZA=class extends Qe(rt()(zi),Bm){};async function UH(n){let{grayscale:e}=n;if(e){let t=ix(e);return LA({method:"GET",url:ax(t),responseType:"json"}).then(r=>new up(r,t.protocol==="https"?"gs":t.protocol))}else return Promise.resolve({numChannels:1,voxelSize:J.fromValues(8,8,8),lowerVoxelBound:J.fromValues(0,0,0),upperVoxelBound:J.fromValues(5e4,5e4,5e4),blockSize:J.fromValues(64,64,64),numLevels:1})}function FH(n){let e=3;return[[(r=>{let i=r.upperVoxelBound;return{spec:di({rank:e,chunkDataSize:Uint32Array.from(i),lowerVoxelBound:r.lowerVoxelBound,upperVoxelBound:r.upperVoxelBound}),chunkToMultiscaleTransform:re.create()}})(n)]]}var GH=Qe(rt()(vn),fp),eI=class extends GH{constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:t.parameters.properties,...t});this.readonly=!1;this.parameters=t.parameters,this.dataInfo=t.dataInfo,this.childAdded=this.childAdded||new Me,this.childUpdated=this.childUpdated||new Me,this.childDeleted=this.childDeleted||new Me,this.makeEditWidget=r=>{let i=l=>new Gc(l),a=l=>({...l.prop,...l.ext}),o=(l,c)=>{let d=new Gc(l);c.title&&(d.title=c.title),c.description&&(d.description=c.description)};return YA(r,this.parameters.schema,this,i,a,o)},this.getUser=()=>this.parameters.user}getSources(e){let t=FH(this.dataInfo),r=0;return t[0].length>1&&(r=10),t.map(i=>i.map(({spec:a,chunkToMultiscaleTransform:o})=>({chunkSource:this.chunkManager.getChunkSource(ZA,{spec:{limit:r,chunkToMultiscaleTransform:o,...a},parent:this,credentialsProvider:this.credentialsProvider,parameters:this.parameters}),chunkToMultiscaleTransform:o})))}*[Symbol.iterator](){for(let e of this.references)e[1].value&&(yield e[1].value)}commit(e){e.value&&(e.value.type===be.LINE||e.value.type===be.SPHERE)&&(e.value.pointA=e.value.pointA.map(t=>Math.round(t)),e.value.pointB=e.value.pointB.map(t=>Math.round(t))),super.commit(e)}add(e,t=!0){if(this.readonly){let i="Permission denied for changing annotations.";throw Ce.showTemporaryMessage(i),Error(i)}let r=new Gc(e);if(r.addTimeStamp(),this.parameters.user&&(r.user=this.parameters.user),e.type===be.POINT&&(r.kind=this.parameters.kind||"Note",e.description)){let i=zA(e.description);i&&r.setProp(i)}return r.roundPos(),r.update(),super.add(e,t)}update(e,t){let r=new Gc(t);r.roundPos(),r.update(),super.update(e,t)}invalidateCache(){this.references.forEach(e=>{e.dispose()}),this.references.clear(),this.childRefreshed.dispatch(),this.metadataChunkSource.invalidateCache();for(let e of this.getSources({multiscaleToViewTransform:new Float32Array,displayRank:1,modelChannelDimensionIndices:[]}))for(let t of e)t.chunkSource.invalidateCache();for(let e of this.segmentFilteredSources)e.invalidateCache()}};async function WH(n,e,t,r){return((a,o)=>n.chunkManager.getChunkSource(eI,{parameters:o,credentialsProvider:r,dataInfo:a}))(t,e)}async function zH(n,e,t){let r=await UH(e),i={lowerBounds:new Float64Array(r.lowerVoxelBound),upperBounds:Float64Array.from(r.upperVoxelBound)},a=Ne({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(r.voxelSize,c=>c/1e9),boundingBoxes:[Mn(i)]}),o=await WH(n,e,r,t);return{modelTransform:mt(a),subsources:[{id:"default",subsource:{annotation:o},default:!0}]}}var HH=/^([^\/]+:\/\/[^\/]+)\/(?:([^\/\?#]+)\/)?([^\/\?#]+)(?:(?:\?|#)(.*))?$/;function $H(n){let e=n.match(HH);if(e===null)throw new Error(`Invalid Clio URL: ${JSON.stringify(n)}.`);let t={baseUrl:e[1],api:e[2],dataset:e[3]},r=e[4];if(r){let i=Vr(r);i.token?(t.authToken=i.token,t.authServer="token:"+i.token):i.auth&&(t.authServer=i.auth),i.user?t.user=i.user:t.authToken&&(t.user=Zb(t.authToken)),i.kind?i.kind==="atlas"?t.kind="Atlas":t.kind=i.kind:t.kind="Normal",i.groups&&(t.groups=i.groups)}return t}async function jH(n,e){let t=new ox(n);return nx(e(n.authServer),QA(n),{url:t.getDatasetsUrl(),method:"GET",responseType:"json"}).then(r=>{let i=G(r,n.dataset,Q);if("location"in i)n.grayscale=G(i,"location",ee);else if("mainLayer"in i){let a=G(i,"mainLayer",ee),c=G(i,"neuroglancer",Q).layers.find(d=>d.name===a);c.source&&c.source.url?n.grayscale=G(c.source,"url",ee):n.grayscale=G(c,"source",ee)}return n})}async function qH(n,e){let t=$H(n.providerUrl);if(!t.user&&t.authServer){let r=e(t.authServer).get();t.authToken=(await r).credentials,t.user=Zb(t.authToken)}return n.chunkManager.memoize.getUncounted({type:"clio:MultiscaleVolumeChunkSource",...t},async()=>{t=await jH(t,e);let r={...new fp,...t};t.kind==="Atlas"?r.schema=$A:r.schema=HA,r.properties=[{identifier:"rendering_attribute",description:"rendering attribute",type:"int32",default:0,min:0,max:5,step:1}];let i=e(t.authServer);return zH(n,r,i)})}async function JH(n){return Promise.resolve({offset:0,completions:[{value:""}]})}var lx=class extends Rt{constructor(e){super();this.credentialsManager=e;this.description="Clio"}getCredentialsProvider(e){let t="";return e&&(t=e),this.credentialsManager.getCredentialsProvider(Nm,t)}get(e){return qH(e,this.getCredentialsProvider.bind(this))}completeUrl(e){return JH(e.providerUrl)}};var cx=class extends rx{constructor(e){super(e);this.authServer=e}};Nn.register(Nm,n=>new cx(n));At("clio",n=>new lx(n.credentialsManager));var tI=class{},nI=class extends tI{},Um=class extends nI{};Um.RPC_ID="render/TileChunkSource";var KH=new Set(["jpg","raw16"]),YH=Qe(Xn,Um),rI=class extends YH{},XH=new Set(["COMPLETE","READ_ONLY"]),QH=new Set(["LOADING"]);function ZH(n){let e=ye(n,Q);if(e.length<1)throw new Error("No stacks found for owner object.");let t=new Map,r=G(e[0],"stackId",t$);for(let i of e){let a=G(i,"stackId",e$),o=n$(i);if(o!==void 0){let l=o.project,c=t.get(l);if(c===void 0){let d=new Map;t.set(l,{stacks:d}),c=t.get(l)}c.stacks.set(a,o)}}return{owner:r,projects:t}}function e$(n){return Q(n),G(n,"stack",ee)}function t$(n){return Q(n),G(n,"owner",ee)}function n$(n){Q(n);let e=G(n,"state",ee),t=[],r=J.create(),i=J.create();if(XH.has(e)){let l=G(n,"stats",Q);r=i$(l),i=r$(l),l.hasOwnProperty("channelNames")&&(t=a$(l))}else if(!QH.has(e))return;let a=G(n,"currentVersion",o$),o=G(n,"stackId",s$);return{lowerVoxelBound:r,upperVoxelBound:i,voxelResolution:a,project:o,channels:t}}function r$(n){Q(n);let e=G(n,"stackBounds",Q),t=J.create();return t[0]=G(e,"maxX",zn)+1,t[1]=G(e,"maxY",zn)+1,t[2]=G(e,"maxZ",zn)+1,t}function i$(n){Q(n);let e=G(n,"stackBounds",Q),t=J.create();return t[0]=G(e,"minX",zn),t[1]=G(e,"minY",zn),t[2]=G(e,"minZ",zn),t}function a$(n){return Q(n),G(n,"channelNames",e=>ye(e,ee))}function o$(n){Q(n);let e=J.create();try{e[0]=G(n,"stackResolutionX",zn),e[1]=G(n,"stackResolutionY",zn),e[2]=G(n,"stackResolutionZ",zn)}catch(t){e[0]=1,e[1]=1,e[2]=1}return e}function s$(n){return Q(n),G(n,"project",ee)}var iI=class extends Gt{constructor(e,t,r,i,a,o,l){super(e);this.baseUrl=t;this.ownerInfo=r;this.project=a;this.parameters=l;let c=r.projects.get(a);if(c===void 0)throw new Error(`Specified project ${JSON.stringify(a)} does not exist for specified owner ${JSON.stringify(r.owner)}`);if(i===void 0){let y=Array.from(c.stacks.keys());if(y.length!==1)throw new Error(`Dataset contains multiple stacks: ${JSON.stringify(y)}`);i=y[0]}let d=c.stacks.get(i);if(d===void 0)throw new Error(`Specified stack ${JSON.stringify(i)} is not one of the supported stacks: `+JSON.stringify(Array.from(c.stacks.keys())));this.stack=i,this.stackInfo=d,o!==void 0&&o.length>0&&(this.channel=o),this.minIntensity=si(l.minIntensity),this.maxIntensity=si(l.maxIntensity),this.maxTileSpecsToRender=si(l.maxTileSpecsToRender),this.filter=mE(l.filter),this.minX=si(l.minX),this.minY=si(l.minY),this.minZ=si(l.minZ),this.maxX=si(l.maxX),this.maxY=si(l.maxY),this.maxZ=si(l.maxZ),this.minX!==void 0&&(d.lowerVoxelBound[0]=this.minX),this.minY!==void 0&&(d.lowerVoxelBound[1]=this.minY),this.minZ!==void 0&&(d.lowerVoxelBound[2]=this.minZ),this.maxX!==void 0&&(d.upperVoxelBound[0]=this.maxX),this.maxY!==void 0&&(d.upperVoxelBound[1]=this.maxY),this.maxZ!==void 0&&(d.upperVoxelBound[2]=this.maxZ);let p=Ft(l.encoding);if(p===void 0)p="jpg";else if(!KH.has(p))throw new Error(`Invalid encoding: ${JSON.stringify(p)}.`);this.encoding=p,this.numLevels=si(l.numlevels),this.dims=J.create();let m=si(l.tilesize);m===void 0&&(m=1024),this.dims[0]=m,this.dims[1]=m,this.dims[2]=1}get dataType(){return this.parameters.encoding==="raw16"?H.UINT16:H.UINT8}get volumeType(){return dt.IMAGE}get rank(){return 3}getSources(e){let t=[],r=this.numLevels;r===void 0&&(r=l$(this.stackInfo,this.dims[0]));let{lowerVoxelBound:i,upperVoxelBound:a}=this.stackInfo;for(let o=0;o<r;o++){let l=re.create(),c=Uint32Array.of(1,1,1);for(let x=0;x<2;++x)l[5*x]=Math.pow(2,o),c[x]=this.dims[x];let d=J.create(),p=J.create(),m=J.create(),y=J.create();for(let x=0;x<3;x++){let C=l[5*x],k=m[x]=i[x]/C,D=y[x]=a[x]/C;d[x]=Math.floor(k),p[x]=Math.ceil(D)}let v=wm({rank:3,chunkDataSize:c,dataType:this.dataType,lowerVoxelBound:d,upperVoxelBound:p}),b=this.chunkManager.getChunkSource(rI,{spec:v,parameters:{baseUrl:this.baseUrl,owner:this.ownerInfo.owner,project:this.stackInfo.project,stack:this.stack,channel:this.channel,minIntensity:this.minIntensity,maxIntensity:this.maxIntensity,maxTileSpecsToRender:this.maxTileSpecsToRender,filter:this.filter,dims:`${this.dims[0]}_${this.dims[1]}`,level:o,encoding:this.encoding}});t.push([{chunkSource:b,chunkToMultiscaleTransform:l,lowerClipBound:m,upperClipBound:y}])}return Mr(t)}};function l$(n,e){let t=0;for(let i=0;i<2;i++)t=Math.max(t,n.upperVoxelBound[i]);if(e>=t)return 1;let r=0;for(;t>e;)t=t/2,r++;return r}function Fm(n,e,t){return n.memoize.getUncounted({type:"render:getOwnerInfo",hostname:e,owner:t},()=>Qh(`${e}/render-ws/v1/owner/${t}/stacks`).then(r=>r.json()).then(ZH))}var c$=/^([^\/?]+)(?:\/([^\/?]+))?(?:\/([^\/?]+))(?:\/([^\/?]*))?(?:\?(.*))?$/,aI=/^((?:(?:(?:http|https):\/\/[^,\/]+)[^\/?]))\/(.*)$/;function u$(n,e){let t,r;{let p=e.match(aI);if(p===null)throw new Error(`Invalid render volume path: ${JSON.stringify(e)}`);t=p[1],r=p[2]}let i=r.match(c$);if(i===null)throw new Error(`Invalid volume path ${JSON.stringify(r)}`);let a=i[1],o=i[2],l=i[3],c=i[4],d=Vr(i[5]||"");return n.memoize.getUncounted({type:"render:MultiscaleVolumeChunkSource",hostname:t,path:r},async()=>{let p=await Fm(n,t,a),m=new iI(n,t,p,l,o,c,d),y=Ne({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(m.stackInfo.voxelResolution,b=>b/1e9),boundingBoxes:[Mn({lowerBounds:new Float64Array(m.stackInfo.lowerVoxelBound),upperBounds:new Float64Array(m.stackInfo.upperVoxelBound)})]});return{modelTransform:mt(y),subsources:[{id:"default",default:!0,subsource:{volume:m}},{id:"bounds",default:!0,subsource:{staticAnnotations:In(y.bounds)}}]}})}async function d$(n,e,t){let r=t.match(/^(?:([^\/]+)(?:\/([^\/]*))?(?:\/([^\/]*))?(\/.*?)?)?$/);if(r===null||r[2]===void 0)throw null;if(r[3]===void 0){let p=r[2]||"",m=await Fm(n,e,r[1]),y=rn(p,m.projects,v=>v[0]+"/",()=>{});return{offset:r[1].length+1,completions:y}}if(r[4]===void 0){let p=r[3]||"",y=(await Fm(n,e,r[1])).projects.get(r[2]);if(y===void 0)throw null;let v=rn(p,y.stacks,b=>b[0]+"/",b=>b[1].project);return{offset:r[1].length+r[2].length+2,completions:v}}let i=r[4].substr(1)||"",o=(await Fm(n,e,r[1])).projects.get(r[2]);if(o===void 0)throw null;let l=o.stacks.get(r[3]);if(l===void 0)throw null;let c=l.channels;if(c.length===0)throw null;let d=rn(i,c,p=>p,()=>{});return{offset:r[1].length+r[2].length+r[3].length+3,completions:d}}async function p$(n,e){let t=n.match(aI);if(t===null)throw null;let r=t[1],i=t[2],a=await d$(e,r,i);return Br(t[1].length+1,a)}var ux=class extends Rt{get description(){return"Render"}get(e){return u$(e.chunkManager,e.providerUrl)}completeUrl(e){return p$(e.providerUrl,e.chunkManager)}};At("render",()=>new ux);var hp;(function(a){a[a.RAW=0]="RAW",a[a.JPEG=1]="JPEG",a[a.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",a[a.COMPRESSO=3]="COMPRESSO",a[a.PNG=4]="PNG"})(hp||(hp={}));var Gm=class{};Gm.RPC_ID="precomputed/VolumeChunkSource";var Wm=class{};Wm.RPC_ID="precomputed/MeshSource";var us;(function(t){t[t.RAW=0]="RAW",t[t.GZIP=1]="GZIP"})(us||(us={}));var Wc;(function(t){t[t.IDENTITY=0]="IDENTITY",t[t.MURMURHASH3_X86_128=1]="MURMURHASH3_X86_128"})(Wc||(Wc={}));var zm=class{};zm.RPC_ID="precomputed/MultiscaleMeshSource";var Hm=class{};Hm.RPC_ID="precomputed/SkeletonSource";var $m=class{};$m.RPC_ID="precomputed/AnnotationSpatialIndexSource";var jm=class{};jm.RPC_ID="precomputed/AnnotationSource";var qm=class{};qm.RPC_ID="precomputed/IndexedSegmentPropertySource";function oI(n,e){return e=Math.imul(e,3432918353)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,461845907)>>>0,n^=e,n=(n<<13|n>>>19)>>>0,n=Math.imul(n,5)+3864292196>>>0,n}function f$(n,e){return n^=e,n^=n>>>16,n=Math.imul(n,2246822507)>>>0,n^=n>>>13,n*=3266489909,n^=n>>>16,n>>>0}function dx(n,e,t){let r=n;return r=oI(r,e),r=oI(r,t),f$(r,8)}var px=class extends jn{constructor(e,t){super(e,t);this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}};function h$(n,e,t){let r=n.length-1;for(;;){if(e=e&r,n[e]===0){n[e]=t;return}++e}}function Jm(n,e){return e<=255?new Uint8Array(n):e<=65535?new Uint16Array(n):new Uint32Array(n)}function m$(n){let e=n.length/2,t=Math.ceil(Math.log2(e))+1,r=2**t,i=Jm(r,e+1);for(let a=0;a<e;++a){let o=n[2*a],l=n[2*a+1];h$(i,dx(0,o,l),a+1)}return i}function g$(n,e,t,r){let i=dx(0,t,r),a=n.length-1;for(;;){i=i&a;let o=n[i];if(o===0)return-1;if(--o,e[2*o]===t&&e[2*o+1]===r)return o;++i}}var Km=class{constructor(e){this.inlineProperties=e.inlineProperties}},sI=class{constructor(e){this.segmentPropertyMap=e;var r;let{inlineProperties:t}=e;t!==void 0&&(this.inlineIdToIndex=m$(t.ids)),this.tags=t==null?void 0:t.properties.find(i=>i.type==="tags"),this.labels=t==null?void 0:t.properties.find(i=>i.type==="label"),this.numericalProperties=(r=t==null?void 0:t.properties.filter(i=>i.type==="number"))!=null?r:[]}getSegmentInlineIndex(e){let{inlineIdToIndex:t}=this;return t===void 0?-1:g$(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){let t=this.getSegmentInlineIndex(e);if(t===-1)return;let{labels:r,tags:i}=this,a="";if(r!==void 0&&(a=r.values[t]),i!==void 0){let{tags:o,values:l}=i,c=l[t];for(let d=0,p=c.length;d<p;++d){let m=o[c.charCodeAt(d)];a.length>0&&(a+=" "),a+="#",a+=m}}if(a.length!==0)return a}};function lI(n,e,t){for(let r=0,i=t.length;r<i;++r)e[t[r]]=n[r]}function y$(n){let e=n.length;if(e===0)return!0;let t=n[0],r=n[1];for(let i=0;i<e;i+=2){let a=n[i],o=n[i+1];if((o-r||a-t)<=0)return!1;t=a,r=o}return!0}function cI(n){let{ids:e}=n;if(y$(e))return n;let t=e.length/2,r=Jm(t,t-1);for(let o=0;o<t;++o)r[o]=o;r.sort((o,l)=>{let c=e[o*2],d=e[o*2+1],p=e[l*2],m=e[l*2+1];return d-m||c-p});let i=new Uint32Array(t*2);for(let o=0;o<t;++o){let l=r[o];i[o*2]=e[l*2],i[o*2+1]=e[l*2+1]}let a=n.properties.map(o=>{let{values:l}=o,c=new l.constructor(t);for(let d=0;d<t;++d)c[d]=l[r[d]];return{...o,values:c}});return{ids:i,properties:a}}function v$(n,e,t){let r=new Array(e);return r.fill(""),lI(n.values,r,t),{...n,values:r}}function S$(n,e,t){let r=new Float32Array(e);return r.fill(Number.NaN),lI(n.values,r,t),{...n,values:r}}function uI(n,e,t){let{type:r}=n;return r==="label"||r==="description"||r==="string"||r==="tags"?v$(n,e,t):S$(n,e,t)}function b$(n,e){if(n===void 0)return e;if(e===void 0)return n;let t=0,r=n.ids.length/2,i=e.ids.length/2,a=new Uint32Array(r),o=new Uint32Array(i),l=n.ids,c=e.ids;Uk(r,i,(m,y)=>{let v=l[2*m+1],b=l[2*m],x=c[2*y+1],C=c[2*y];return v-x||b-C},m=>{a[m]=t,++t},m=>{o[m]=t,++t},(m,y)=>{a[m]=t,o[y]=t,++t});let d;if(t===r)d=l;else if(t===i)d=c;else{d=new Uint32Array(t*2);for(let m=0;m<r;++m){let y=a[m];d[2*y]=l[2*m],d[2*y+1]=l[2*m+1]}for(let m=0;m<i;++m){let y=o[m];d[2*y]=c[2*m],d[2*y+1]=c[2*m+1]}}let p=[];if(t===r)p.push(...n.properties);else for(let m of n.properties)p.push(uI(m,t,a));if(t===i)p.push(...e.properties);else for(let m of e.properties)p.push(uI(m,t,o));return{ids:d,properties:p}}function x$(n,e){return new Km({inlineProperties:b$(n.inlineProperties,e.inlineProperties)})}function C$(n){for(;;){if(n.length===0)return;if(n.length===1)return n[0];let e=[];for(let t=0,r=n.length;t<r;t+=2)t+1===r?e.push(n[t]):e.push(x$(n[t],n[t+1]));n=e}}function dI(n,e){return n.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:e.map(t=>ct(t))},()=>{let t=C$(e);if(t!==void 0)return new sI(t)})}var w$=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function pI(n,e){var p;if(e.match(w$)!==null){let m=e.split(/[\s,]+/),y=[],v=new Set;for(let b=0,x=m.length;b<x;++b){let C=m[b];if(C==="")continue;let k=new X;if(!k.tryParseString(C))continue;let D=k.toString();v.has(D)||(v.add(D),y.push(k))}return y.sort(X.compare),{ids:y}}let t={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},r=(p=n==null?void 0:n.segmentPropertyMap.inlineProperties)==null?void 0:p.properties,i=n==null?void 0:n.tags,a=(i==null?void 0:i.tags)||[],o=a.map(m=>m.toLowerCase()),l=n==null?void 0:n.labels,c=[],d;for(let m=0;m<e.length;m=d){let y=e.indexOf(" ",m),v;if(y===-1?d=y=e.length:d=y+1,v=e.substring(m,y),v.length===0)continue;let b=(C,k)=>{let D=C.toLowerCase(),P=o.indexOf(D);if(P===-1){c.push({begin:k,end:y,message:`Invalid tag: ${C}`});return}if(C=a[P],t.includeTags.includes(C)||t.excludeTags.includes(C)){c.push({begin:k,end:y,message:`Duplicate tag: ${C}`});return}return C};if(v.startsWith("#")){let C=b(v.substring(1),m+1);C!==void 0&&t.includeTags.push(C);continue}if(v.startsWith("-#")){let C=b(v.substring(2),m+2);C!==void 0&&t.excludeTags.push(C);continue}if(v.startsWith("<")||v.startsWith(">")){let C=v.substring(1).toLowerCase();if(C!=="id"&&C!=="label"){let k=r==null?void 0:r.find(D=>D.id.toLowerCase()===C&&(D.type==="number"||D.type==="label"||D.type==="string"));if(k===void 0){c.push({begin:m+1,end:y,message:`Invalid field: ${C}`});continue}C=k.id}if(t.sortBy.find(k=>k.fieldId===C)!==void 0){c.push({begin:m+1,end:y,message:`Duplicate sort field: ${C}`});continue}t.sortBy.push({order:v[0],fieldId:C});continue}if(v.startsWith("|")){let C=v.substring(1).toLowerCase();if(C==="id"||C==="label")continue;let k=r==null?void 0:r.find(D=>D.id.toLowerCase()===C&&(D.type==="number"||D.type==="string"));if(k===void 0){c.push({begin:m+1,end:y,message:`Invalid field: ${C}`});continue}if(C=k.id,t.sortBy.find(D=>D.fieldId===C)||t.includeColumns.find(D=>D===C))continue;t.includeColumns.push(C);continue}if(v.startsWith("/")){if(t.regexp!==void 0){c.push({begin:m,end:y,message:"Only one regular expression allowed"});continue}if(t.prefix!==void 0){c.push({begin:m,end:y,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0){c.push({begin:m,end:y,message:"No label property"});continue}try{t.regexp=new RegExp(v.substring(1))}catch(C){c.push({begin:m,end:y,message:"Invalid regular expression syntax"})}continue}let x=v.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(x!==null){let C=x[1].toLowerCase(),k=x[2],D=n==null?void 0:n.numericalProperties.find(B=>B.id.toLowerCase()===C);if(D===void 0){c.push({begin:m,end:m+C.length,message:`Invalid numerical field: ${C}`});continue}C=D.id;let P;try{P=to(D.dataType,x[3])}catch(B){c.push({begin:m+x[1].length+x[2].length,end:y,message:B.message});continue}let M=t.numericalConstraints.find(B=>B.fieldId===C);M===void 0&&(M={fieldId:C,bounds:D.bounds},t.numericalConstraints.push(M));let I=Ws(D.bounds,M.bounds[0]),E=Ws(D.bounds,M.bounds[1]),_=E,O=I;switch(k){case"<":_=gd(D.dataType,P,-1);break;case"<=":_=P;break;case"=":_=O=P;break;case">=":O=P;break;case">":O=gd(D.dataType,P,1);break}if(O=Sr(I,O)>0?I:O,_=Sr(E,_)<0?E:_,Sr(O,_)>0){c.push({begin:m,end:y,message:"Constraint would not match any values"});continue}M.bounds=[O,_];continue}if(t.regexp!==void 0){c.push({begin:m,end:y,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0){c.push({begin:m,end:y,message:"No label property"});continue}t.prefix!==void 0?t.prefix+=` ${v}`:t.prefix=v}return c.length>0?{errors:c}:(t.sortBy.length===0&&t.sortBy.push({fieldId:mI(n),order:"<"}),t)}function fx(n){return"\\u"+n.toString(16).padStart(4,"0")}function fI(n,e){var k;if(e.errors!==void 0)return{query:e,total:-1,count:0,errors:e.errors};if(e.ids!==void 0){let{ids:D}=e;return{query:e,total:-1,explicitIds:D,count:D.length}}let t=(k=n==null?void 0:n.segmentPropertyMap)==null?void 0:k.inlineProperties;if(t===void 0)return{query:e,count:0,total:-1};let r=t==null?void 0:t.properties,i=t.ids.length/2,a=Jm(i,i);for(let D=0;D<i;++D)a[D]=D;let o=D=>{let P=a.length,M=0;for(let I=0;I<P;++I){let E=a[I];D(E)&&(a[M]=E,++M)}a=a.subarray(0,M)};if(e.regexp!==void 0||e.prefix!==void 0){let D=n.labels.values,{regexp:P,prefix:M}=e;P!==void 0&&o(I=>D[I].match(P)!==null),M!==void 0&&o(I=>D[I].startsWith(M))}let{includeTags:l,excludeTags:c}=e,d=n.tags;if(l.length>0||c.length>0){let{values:D,tags:P}=d,M=[];for(let B of l)M.push([P.indexOf(B),1]);for(let B of c)M.push([P.indexOf(B),0]);M.sort((B,W)=>B[0]-W[0]);let I="^",E=0,_=B=>{B<E||(I+=`[${fx(E)}-${fx(B)}]*`)};for(let[B,W]of M)_(B-1),W&&(I+=fx(B)),E=B+1;_(65535),I+="$";let O=new RegExp(I);o(B=>D[B].match(O)!==null)}let p,m,{numericalConstraints:y}=e;if(y.length>0){let D=n.numericalProperties,P=y.length,M=2**P-1;p=Jm(a.length,M);for(let _=0;_<P;++_){let O=y[_],B=D.find(q=>q.id===O.fieldId),{values:W}=B,V=2**_,[U,N]=O.bounds;for(let q=0,ne=a.length;q<ne;++q){let pe=W[a[q]];p[q]|=V*(pe>=U&&pe<=N)}}m=a,a=m.slice();let I=a.length,E=0;for(let _=0;_<I;++_)p[_]===M&&(a[E]=a[_],++E);a=a.subarray(0,E)}let v=[];if(d!==void 0){let D=[],{tags:P,values:M}=d,I=new Uint32Array(P.length);for(let E=0,_=a.length;E<_;++E){let O=M[a[E]];for(let B=0,W=O.length;B<W;++B)++I[O.charCodeAt(B)]}for(let E=0,_=P.length;E<_;++E){let O=I[E],B=P[E],W={tag:B,tagIndex:E,count:I[E]};e.includeTags.includes(B)||e.excludeTags.includes(B)?D.push(W):O>0&&v.push(W)}D.push(...v),v=D}let b=(D,P)=>{if(D.type!=="number"){let{values:M}=D;a.sort((I,E)=>ho(M[I],M[E])*P)}else{let M=D.values;a.sort((I,E)=>(M[I]-M[E])*P)}},x=D=>{d!==void 0&&b(d,D);let P=n==null?void 0:n.labels;P!==void 0&&b(P,D)},{sortBy:C}=e;for(let D=C.length-1;D>=0;--D){let{fieldId:P,order:M}=C[D],I=M==="<"?1:-1;if(P==="id"){if(D+1===C.length){if(M==="<")continue;a.reverse();continue}a.sort((E,_)=>I*(E-_));continue}else P==="label"?x(I):b(r.find(E=>E.id===P),I)}return{query:e,intermediateIndices:m,intermediateIndicesMask:p,indices:a,tags:v,count:a.length,total:i}}function T$(n,e,t){let r=256,{values:i}=e,[a,o]=t,l=o<=a?0:r/(o-a),c=new Uint32Array(r+2),{numericalConstraints:d}=n.query,p=d.findIndex(m=>m.fieldId===e.id);if(p===-1){let m=n.indices;for(let y=0,v=m.length;y<v;++y){let b=i[m[y]];isNaN(b)||++c[Math.min(r-1,Math.max(-1,(b-a)*l))+1>>>0]}}else{let m=n.intermediateIndices,y=n.intermediateIndicesMask,v=2**d.length-1-2**p;for(let b=0,x=m.length;b<x;++b)if((y[b]&v)==v){let k=i[m[b]];isNaN(k)||++c[Math.min(r-1,Math.max(-1,(k-a)*l))+1>>>0]}}return{queryResult:n,histogram:c,window:t}}function hI(n,e,t,r){if(n===void 0){t.length=0,r.length=0;return}let{numericalProperties:i}=n,a=i.length;if((e==null?void 0:e.indices)===void 0){t.length=0;return}for(let l=0;l<a;++l){let c=t[l],d=r[l],p=i[l];c!==void 0&&c.queryResult===e&&ci(p.dataType,c.window,d)||(t[l]=T$(e,p,d))}}function mI(n){return(n==null?void 0:n.tags)||(n==null?void 0:n.labels)?"label":"id"}function gI(n,e){let{ids:t}=e;if(t!==void 0)return t.map(l=>l.toString()).join(", ");let r="";e=e;let{prefix:i,regexp:a}=e;i!==void 0?r=i:a!==void 0&&(r=`/${a}`);for(let l of e.includeTags)r.length>0&&(r+=" "),r+=`#${l}`;for(let l of e.excludeTags)r.length>0&&(r+=" "),r+=`-#${l}`;for(let l of e.numericalConstraints){let{fieldId:c,bounds:d}=l,[p,m]=d,y=n.numericalProperties.find(v=>v.id===c);if(!ci(y.dataType,y.bounds,d)){if(Sr(p,m)===0){r.length>0&&(r+=" "),r+=`${c}=${p}`;continue}if(Sr(p,y.bounds[0])>0){r.length>0&&(r+=" ");let v=gd(y.dataType,p,-1),b=p.toString(),x=v.toString();y.dataType!==H.FLOAT32||b.length<=x.length?r+=`${c}>=${b}`:r+=`${c}>${x}`}if(Sr(m,y.bounds[1])<0){r.length>0&&(r+=" ");let v=gd(y.dataType,m,1),b=m.toString(),x=v.toString();y.dataType!==H.FLOAT32||b.length<=x.length?r+=`${c}<=${b}`:r+=`${c}<${x}`}}}let{sortBy:o}=e;if(o.length===1){let l=o[0];l.order==="<"&&l.fieldId===mI(n)&&(o=[])}for(let l of o)r.length>0&&(r+=" "),r+=`${l.order}${l.fieldId}`;for(let l of e.includeColumns)r.length>0&&(r+=" "),r+=`|${l}`;return r}var hx=new X;function mp(n,e,t){if(e===void 0)return;let{explicitIds:r}=e;if(r!==void 0){r.forEach(t);return}let{indices:i}=e;if(i!==void 0){let{ids:a}=n==null?void 0:n.segmentPropertyMap.inlineProperties;for(let o=0,l=i.length;o<l;++o){let c=i[o];hx.low=a[c*2],hx.high=a[c*2+1],t(hx,o)}}}function yI(n,e,t){if(t.size===0)return 0;let r=0;return mp(n,e,i=>{t.has(i)&&++r}),r}function mx(n,e,t,r){let i=n.includeTags.filter(o=>o!==e),a=n.excludeTags.filter(o=>o!==e);return r===!0&&(t?i:a).push(e),{...n,includeTags:i,excludeTags:a}}function vI(n){return n.ids!==void 0?!1:n.errors!==void 0?!0:!(n.numericalConstraints.length>0||n.includeTags.length>0||n.excludeTags.length>0||n.prefix||n.regexp)}function Ym(n,e){if(n===void 0||n.ids!==void 0||n.errors!==void 0)return!1;let{sortBy:t,includeColumns:r}=n;return t.find(i=>i.fieldId===e)!==void 0||r.includes(e)}async function k$(n,e,t,r,i){let a=await Hi(n,`https://www.googleapis.com/storage/v1/b/${e}/o?delimiter=${encodeURIComponent(r)}&prefix=${encodeURIComponent(t)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},ut,i);Q(a);let o=le(a,"prefixes",jt,[]),l=le(a,"items",c=>ye(c,d=>(Q(d),G(d,"name",ee))),[]).filter(c=>!c.endsWith("_$folder$"));return[...o,...l]}async function SI(n,e,t,r,i){if(!r.startsWith("/"))throw null;let o=await k$(n,t,r.substring(1),"/",i),l=r.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}async function L$(n,e,t,r,i){let a=await Hi(n,`${e}?prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent(r)}`,{},p=>p.text(),i),o=new DOMParser().parseFromString(a,"application/xml"),l=o.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=[];for(let p=0,m=l.snapshotLength;p<m;++p)c.push(l.snapshotItem(p).textContent||"");let d=o.evaluate('//*[name()="Contents"]/*[name()="Key"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let p=0,m=d.snapshotLength;p<m;++p)c.push(d.snapshotItem(p).textContent||"");return c}async function gp(n,e,t,r,i){if(!r.startsWith("/"))throw null;let o=await L$(n,t,r.substring(1),"/",i),l=r.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}var bI=class extends Jt{constructor(e){super();this.bucket=e;this.get=on(async()=>{var o;let{bucket:e}=this,t=await Rn(`https://s3.amazonaws.com/${e}?location`,{},l=>l.text()),i=new DOMParser().parseFromString(t,"application/xml").querySelector("LocationConstraint");if(i===null)throw new Error(`Unable to determine location of S3 bucket: ${e}`);return{region:((o=i.textContent)==null?void 0:o.trim())||"us-east-1"}})}},Xm;function gx(n){return Xm===void 0&&(Xm=new op,Xm.register("s3",e=>new bI(e))),Xm.getCredentialsProvider("s3",n)}async function xI(n,e,t,r,i,a=Je){let o=await n.get(),{region:l}=o.credentials;return await Rn(`https://${e}.s3.${l}.amazonaws.com${t}`,r,i,a)}async function CI(n,e,t){let i=await gx(n).get(),{region:a}=i.credentials;return await gp(void 0,`s3://${n}`,`https://${n}.s3.${a}.amazonaws.com`,e,t)}function E$(n,e){return n.getCredentialsProvider("middleauthapp",new URL(e).origin)}function Qm(n,e,t){let r=/^\/([^\/]+)/,i=t.match(r);if(i!==null)return typeof NEUROGLANCER_PYTHON_INTEGRATION!="undefined"?n.getCredentialsProvider("gcs",{bucket:i[1]}):n.getCredentialsProvider("ngauth_gcs",{authServer:e,bucket:i[1]})}function wn(n,e){let t=Da(n);switch(t.protocol){case"gs":case"gs+json":case"gs+xml":return{credentialsProvider:typeof NEUROGLANCER_PYTHON_INTEGRATION!="undefined"?e.getCredentialsProvider("gcs",{bucket:t.host}):void 0,url:n};case"gs+ngauth+http":return{credentialsProvider:Qm(e,`http://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+ngauth+https":return{credentialsProvider:Qm(e,`https://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+xml+ngauth+http":return{credentialsProvider:Qm(e,`http://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"gs+xml+ngauth+https":return{credentialsProvider:Qm(e,`https://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"middleauth+https":return n=n.substr("middleauth+".length),{credentialsProvider:E$(e,n),url:n};case"s3":return{credentialsProvider:gx(t.host),url:n};default:return{credentialsProvider:void 0,url:n}}}async function cr(n,e,t,r,i=Je){let a=Da(e);switch(a.protocol){case"gs":return Hi(n,`https://www.googleapis.com/storage/v1/b/${a.host}/o/${encodeURIComponent(a.path.substring(1))}?alt=media&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,t,r,i);case"gs+json":return Hi(n,`https://storage.googleapis.com/storage/v1/b/${a.host}/o/${encodeURIComponent(a.path.substring(1))}?alt=media`,t,r,i);case"gs+xml":return Hi(n,`https://storage.googleapis.com/${a.host}${a.path}`,t,r,i);case"s3":return xI(n,a.host,a.path,t,r,i);default:return Hi(n,e,t,r,i)}}async function P$(n,e,t){let{text:r,contentType:i}=await cr(t,n,{headers:{accept:"text/html"}},async c=>({text:await c.text(),contentType:c.headers.get("content-type")}),e);if(i===null||/\btext\/html\b/i.exec(i)===null)return[];let a=new DOMParser().parseFromString(r,"text/html"),o=a.evaluate("//a/@href",a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),l=[];for(let c=0,d=o.snapshotLength;c<d;++c){let m=o.snapshotItem(c).textContent;m&&l.push(new URL(m,n).toString())}return l}async function D$(n,e,t){console.log("getHtmlPathCompletions");let r=n.match(/^([a-z]+:\/\/.*\/)([^\/?#]*)$/);if(r===null)throw null;let i=await P$(r[1],e,t),a=r[1].length,o=[];for(let l of i)!l.startsWith(n)||o.push({value:l.substring(a)});return{offset:a,completions:o}}var A$=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+json://",description:"Google Cloud Storage (storage JSON API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function xi(n,e,t){if(!e.includes("://"))return{offset:0,completions:rn(e,A$,m=>m.value,m=>m.description)};let{url:r,credentialsProvider:i}=wn(e,n),a=e.length-r.length,o;try{o=Da(r)}catch{throw null}let{protocol:l,host:c,path:d}=o,p=await(async()=>{if(l==="gs+xml"&&d.length>0)return await gp(i,`${l}://${c}`,`https://storage.googleapis.com/${c}`,d,t);if((l==="gs"||l==="gs+json")&&d.length>0)return await SI(i,`${l}://${c}`,c,d,t);if(l==="s3"&&d.length>0)return await CI(c,d,t);let m=r.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^\/]+|[^\/]+\.storage\.googleapis\.com|[^\/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(m!==null)return await gp(i,m[1],m[1],m[2],t);if((l==="http"||l==="https")&&d.length>0)return await D$(r,t,i);throw null})();return{offset:a+p.offset,completions:p.completions}}var wI=class extends Qe(rt()(Xn),Gm){},TI=class extends Qe(rt()(kr),Wm){},kI=class extends Qe(rt()(go),zm){},LI=class extends Qe(rt()(yo),Hm){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}};function Na(n,e){let t=n.split("/");for(let r of e.split("/")){if(r===".."&&t.length!==0){t.length=t.length-1;continue}t.push(r)}return t.join("/")}var EI=class{constructor(e,t){Q(e);let r=t===1?3:4,i=this.resolution=new Float64Array(r),a=this.voxelOffset=new Float32Array(r),o=this.size=new Float32Array(r);if(r===4&&(i[3]=1,o[3]=t),G(e,"resolution",c=>He(i.subarray(0,3),c,St)),le(e,"voxel_offset",c=>He(a.subarray(0,3),c,ot)),G(e,"size",c=>He(o.subarray(0,3),c,wt)),this.chunkSizes=G(e,"chunk_sizes",c=>ye(c,d=>{let p=new Uint32Array(r);return r===4&&(p[3]=t),He(p.subarray(0,3),d,wt),p})),this.chunkSizes.length===0)throw new Error("No chunk sizes specified.");if(this.sharding=G(e,"sharding",eg),this.sharding!==void 0&&this.chunkSizes.length!==1)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=G(e,"encoding",c=>Mt(c,hp)))===hp.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=G(e,"compressed_segmentation_block_size",c=>He(J.create(),c,wt))),this.key=G(e,"key",ee)}};function yx(n){Q(n);let e=G(n,"data_type",k=>Mt(k,H)),t=G(n,"num_channels",wt),r=G(n,"type",k=>Mt(k,dt)),i=G(n,"mesh",Ft),a=G(n,"skeletons",Ft),o=G(n,"segment_properties",Ft),l=G(n,"scales",k=>ye(k,D=>new EI(D,t)));if(l.length===0)throw new Error("Expected at least one scale");let c=l[0],d=t===1?3:4,p=new Float64Array(d),m=new Float64Array(d),y=new Float64Array(d),v=["x","y","z"],b=["m","m","m"];for(let k=0;k<3;++k)p[k]=c.resolution[k]/1e9,m[k]=c.voxelOffset[k],y[k]=m[k]+c.size[k];d===4&&(p[3]=1,y[3]=t,v[3]="c^",b[3]="");let C=Ne({rank:d,names:v,units:b,scales:p,boundingBoxes:[Mn({lowerBounds:m,upperBounds:y})]});return{dataType:e,volumeType:r,mesh:i,skeletons:a,segmentPropertyMap:o,scales:l,modelSpace:C}}var Zm=class extends Gt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.url=r;this.info=i}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){let t=this.info.scales[0].resolution,{rank:r}=this;return Mr(this.info.scales.map(i=>{let{resolution:a}=i,o=r+1,l=new Float32Array(o*o);l[l.length-1]=1;let{lowerBounds:c,upperBounds:d}=this.info.modelSpace.boundingBoxes[0].box,p=new Float32Array(r),m=new Float32Array(r);for(let y=0;y<3;++y){let v=a[y]/t[y];l[o*y+y]=v;let b=i.voxelOffset[y];l[o*r+y]=b*v,p[y]=c[y]/v-b,m[y]=d[y]/v-b}return r===4&&(l[o*3+3]=1,p[3]=c[3],m[3]=d[3]),bi({rank:r,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:i.size,volumeType:this.volumeType,chunkDataSizes:i.chunkSizes,baseVoxelOffset:i.voxelOffset,compressedSegmentationBlockSize:i.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(y=>({chunkSource:this.chunkManager.getChunkSource(wI,{credentialsProvider:this.credentialsProvider,spec:y,parameters:{url:Na(this.url,i.key),encoding:i.encoding,sharding:i.sharding}}),chunkToMultiscaleTransform:l,lowerClipBound:p,upperClipBound:m}))}))}},I$=Qe(rt()(vn),jm),PI=class extends Qe(rt()(zi),$m){},DI=class extends I${constructor(e,t){let{parameters:r}=t;super(e,{rank:r.rank,relationships:r.relationships.map(i=>i.name),properties:r.properties,parameters:r});this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{let{spec:t}=e;return{chunkSource:this.chunkManager.getChunkSource(PI,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}};function M$(n,e,t){return n.getChunkSource(TI,{parameters:t,credentialsProvider:e})}function AI(n){return G(n,"transform",e=>{let t=re.create();return e!==void 0&&He(t.subarray(0,12),e,Ye),re.transpose(t,t),t})}function R$(n){Q(n);let e=G(n,"@type",ee),t;if(e==="neuroglancer_legacy_mesh")t=void 0;else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{let i=G(n,"lod_scale_multiplier",St),a=G(n,"vertex_quantization_bits",wt),o=AI(n),l=G(n,"sharding",eg);t={lodScaleMultiplier:i,transform:o,sharding:l,vertexQuantizationBits:a}}}let r=G(n,"segment_properties",Ft);return{metadata:t,segmentPropertyMap:r}}async function _$(n,e,t){let r;try{r=await zc(n,e,t)}catch(i){if(Aa(i))return{metadata:void 0};throw i}return R$(r)}function II(n){return n===void 0?us.RAW:Mt(n,us)}function eg(n){if(n===void 0)return;Q(n);let e=G(n,"@type",ee);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);let t=G(n,"hash",c=>Mt(c,Wc)),r=G(n,"preshift_bits",ot),i=G(n,"shard_bits",ot),a=G(n,"minishard_bits",ot),o=G(n,"minishard_index_encoding",II),l=G(n,"data_encoding",II);return{hash:t,preshiftBits:r,shardBits:i,minishardBits:a,minishardIndexEncoding:o,dataEncoding:l}}function V$(n){Q(n);let e=G(n,"@type",ee);if(e!=="neuroglancer_skeletons")throw new Error(`Unsupported skeleton type: ${JSON.stringify(e)}`);let t=AI(n),r=new Map;G(n,"vertex_attributes",o=>{o!==void 0&&ye(o,l=>{Q(l);let c=G(l,"id",ee);if(c==="")throw new Error("vertex attribute id must not be empty");if(r.has(c))throw new Error(`duplicate vertex attribute id ${JSON.stringify(c)}`);let d=G(l,"data_type",m=>Mt(m,H)),p=G(l,"num_components",wt);r.set(c,{dataType:d,numComponents:p})})});let i=G(n,"sharding",eg),a=G(n,"segment_properties",Ft);return{metadata:{transform:t,vertexAttributes:r,sharding:i},segmentPropertyMap:a}}async function O$(n,e,t){let r=await zc(n,e,t);return V$(r)}function MI(){return Ne({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function RI(n,e,t){let{metadata:r,segmentPropertyMap:i}=await _$(n,e,t);if(r===void 0)return{source:M$(n,e,{url:t,lod:0}),transform:re.create(),segmentPropertyMap:i};let a,{vertexQuantizationBits:o}=r;if(o===10)a=mi.uint10;else if(o===16)a=mi.uint16;else throw new Error(`Invalid vertex quantization bits: ${o}`);return{source:n.getChunkSource(kI,{credentialsProvider:e,parameters:{url:t,metadata:r},format:{fragmentRelativeVertices:!0,vertexPositionFormat:a}}),transform:r.transform,segmentPropertyMap:i}}async function _I(n,e,t){let{metadata:r,segmentPropertyMap:i}=await O$(n,e,t);return{source:n.getChunkSource(LI,{credentialsProvider:e,parameters:{url:t,metadata:r}}),transform:r.transform,segmentPropertyMap:i}}function zc(n,e,t){return n.memoize.getUncounted({type:"precomputed:metadata",url:t,credentialsProvider:ct(e)},async()=>await cr(e,`${t}/info`,{},ut))}function VI(n){let e=re.create(),t=n.scales[0].resolution;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}async function N$(n,e,t,r){let i=yx(r),a=new Zm(n.chunkManager,e,t,i),{modelSpace:o}=i,l=[{id:"default",default:!0,subsource:{volume:a}},{id:"bounds",default:!0,subsource:{staticAnnotations:In(o.bounds)}}];if(i.segmentPropertyMap!==void 0){let c=Na(t,i.segmentPropertyMap),d=await zc(n.chunkManager,e,c),p=Hc(n.chunkManager,e,d,c);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:p}})}if(i.mesh!==void 0){let c=Na(t,i.mesh),{source:d,transform:p}=await RI(n.chunkManager,e,c),m=VI(i);re.multiply(m,m,p),l.push({id:"mesh",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:m})}if(i.skeletons!==void 0){let c=Na(t,i.skeletons),{source:d,transform:p}=await _I(n.chunkManager,e,c),m=VI(i);re.multiply(m,m,p),l.push({id:"skeletons",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:m})}return{modelTransform:mt(o),subsources:l}}async function B$(n,e,t){let{source:r,transform:i,segmentPropertyMap:a}=await _I(n.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:i}];if(a!==void 0){let l=Na(t,a),c=await zc(n.chunkManager,e,l),d=Hc(n.chunkManager,e,c,l);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}return{modelTransform:mt(MI()),subsources:o}}function vx(n,e){return Q(e),{url:Na(n,G(e,"key",ee)),sharding:G(e,"sharding",eg)}}var OI=class{constructor(e,t){this.url=e;Q(t);let r=G(t,"dimensions",Cd),{rank:i}=r,a=G(t,"lower_bound",l=>He(new Float64Array(i),l,Ye)),o=G(t,"upper_bound",l=>He(new Float64Array(i),l,Ye));this.coordinateSpace=Ne({rank:i,names:r.names,units:r.units,scales:r.scales,boundingBoxes:[Mn({lowerBounds:a,upperBounds:o})]}),this.parameters={type:G(t,"annotation_type",l=>Mt(l,be)),rank:i,relationships:G(t,"relationships",l=>ye(l,c=>{let d=vx(e,c),p=G(c,"id",ee);return{...d,name:p}})),properties:G(t,"properties",lh),byId:G(t,"by_id",l=>vx(e,l))},this.spatialIndices=G(t,"spatial",l=>ye(l,c=>{let d=vx(e,c),p=G(c,"grid_shape",C=>He(new Float32Array(i),C,wt)),m=G(c,"chunk_size",C=>He(new Float32Array(i),C,St)),y=G(c,"limit",wt),v=new Float32Array(i);for(let C=0;C<i;++C)v[C]=p[C]*m[C];let b=rr(Float32Array,i+1);for(let C=0;C<i;++C)b[(i+1)*i+C]=a[C];let x={limit:y,chunkToMultiscaleTransform:b,...di({rank:i,chunkDataSize:m,upperVoxelBound:v})};return x.upperChunkBound=p,{parameters:d,spec:x,limit:y}})),this.spatialIndices.reverse()}};async function U$(n,e,t,r){let i=new OI(t,r);return{modelTransform:mt(i.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:n.chunkManager.getChunkSource(DI,{credentialsProvider:e,metadata:i,parameters:i.parameters})}}]}}async function NI(n,e,t){let{source:r,transform:i,segmentPropertyMap:a}=await RI(n.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:i}];if(a!==void 0){let l=Na(t,a),c=await zc(n.chunkManager,e,l),d=Hc(n.chunkManager,e,c,l);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}return{modelTransform:mt(MI()),subsources:o}}function F$(n){Q(n);let e=new X,t=G(n,"ids",a=>{a=jt(a);let o=a.length,l=new Uint32Array(o*2);for(let c=0;c<o;++c){if(!e.tryParseString(a[c]))throw new Error(`Invalid uint64 id: ${JSON.stringify(a[c])}`);l[2*c]=e.low,l[2*c+1]=e.high}return l}),r=t.length/2,i=G(n,"properties",a=>ye(a,o=>{Q(o);let l=G(o,"id",ee),c=le(o,"description",ee),d=G(o,"type",m=>{if(m!=="label"&&m!=="description"&&m!=="string"&&m!=="tags"&&m!=="number")throw new Error(`Invalid property type: ${JSON.stringify(m)}`);return m});if(d==="tags"){let m=G(o,"tags",jt),y=le(o,"tag_descriptions",jt);if(y===void 0)y=new Array(m.length),y.fill("");else if(y.length!==m.length)throw new Error(`Expected tag_descriptions to have length: ${m.length}`);let v=G(o,"values",b=>{if(!Array.isArray(b)||b.length!==r)throw new Error(`Expected ${r} values, but received: ${b.length}`);return b.map(x=>String.fromCharCode(...x))});return{id:l,description:c,type:d,tags:m,tagDescriptions:y,values:v}}if(d==="number"){let m=G(o,"data_type",x=>Mt(x,H));if(m===H.UINT64)throw new Error("uint64 properties not supported");let y=G(o,"values",x=>{if(!Array.isArray(x)||x.length!==r)throw new Error(`Expected ${r} values, but received: ${x.length}`);return pE[m].from(x)}),v=Infinity,b=-Infinity;for(let x=y.length-1;x>=0;--x){let C=y[x];C<v&&(v=C),C>b&&(b=C)}return{id:l,description:c,type:d,dataType:m,values:y,bounds:[v,b]}}let p=G(o,"values",m=>{if(jt(m),m.length!==r)throw new Error(`Expected ${r} values, but received: ${m.length}`);return m});return{id:l,description:c,type:d,values:p}}));return cI({ids:t,properties:i})}var Kue=Qe(rt()(px),qm);function Hc(n,e,t,r){try{let i=G(t,"@type",ee);if(i!=="neuroglancer_segment_properties")throw new Error(`Unsupported segment property map type: ${JSON.stringify(i)}`);let a=le(t,"inline",F$);return new Km({inlineProperties:a})}catch(i){throw new Error(`Error parsing segment property map: ${i.message}`)}}async function G$(n,e,t,r){return{modelTransform:mt(Vi),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:Hc(n.chunkManager,e,r,t)}}]}}var W$=/^([^#]*)(?:#(.*))?$/;function yp(n){let[,e,t]=n.match(W$);e.endsWith("/")&&(e=e.substring(0,e.length-1));let r=Vr(t||"");return{url:e,parameters:r}}function BI(n,e){let t=gE(e);return t&&(n+=`#${t}`),n}var vp=class extends Rt{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){let{url:t,parameters:r}=yp(e.providerUrl);return e.providerProtocol+"://"+BI(t,r)}convertLegacyUrl(e){let{url:t,parameters:r}=yp(e.providerUrl);return e.type==="mesh"&&(r.type="mesh"),e.providerProtocol+"://"+BI(t,r)}get(e){let{url:t,parameters:r}=yp(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:t,parameters:r},async()=>{let{url:i,credentialsProvider:a}=wn(t,e.credentialsManager),o;try{o=await zc(e.chunkManager,a,i)}catch(d){if(Aa(d)&&r.type==="mesh")return await NI(e,a,i);throw d}Q(o);let l=le(o,"redirect",ee);if(l!==void 0)throw new Pc(l);let c=le(o,"@type",ee);switch(c){case"neuroglancer_skeletons":return await B$(e,a,i);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":return await NI(e,a,i);case"neuroglancer_annotations_v1":return await U$(e,a,i,o);case"neuroglancer_segment_properties":return await G$(e,a,i,o);case"neuroglancer_multiscale_volume":case void 0:return await N$(e,a,i,o);default:throw new Error(`Invalid type: ${JSON.stringify(c)}`)}})}completeUrl(e){return xi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};At("precomputed",()=>new vp);var UI="nifti/getNiftiVolumeInfo",tg=class{};tg.RPC_ID="nifti/VolumeChunkSource";var FI=class extends Qe(rt()(Xn),tg){},GI=class extends Gt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.url=r;this.info=i}get dataType(){return this.info.dataType}get volumeType(){return dt.UNKNOWN}get rank(){return this.info.rank}getSources(e){let{info:t}=this,r=rr(Float32Array,t.rank+1),i=Rb({rank:t.rank,volumeType:dt.UNKNOWN,chunkDataSize:t.volumeSize,dataType:t.dataType,upperVoxelBound:Float32Array.from(t.volumeSize),chunkToMultiscaleTransform:r,volumeSourceOptions:e});return[[{chunkSource:this.chunkManager.getChunkSource(FI,{credentialsProvider:this.credentialsProvider,spec:i,parameters:{url:this.url}}),chunkToMultiscaleTransform:r}]]}};function z$(n,e,t,r){return n.rpc.promiseInvoke(UI,{chunkManager:n.addCounterpartRef(),credentialsProvider:Wd(n,e),url:t},r)}function H$(n,e,t){return n.memoize.getUncounted({type:"nifti/getVolume",url:t},async()=>{let{url:r,credentialsProvider:i}=wn(t,e),a=await z$(n,i,r,Je),o=new GI(n,i,r,a),l={lowerBounds:new Float64Array(a.rank),upperBounds:Float64Array.from(a.volumeSize)},c=Ne({rank:a.rank,names:a.sourceNames,scales:a.sourceScales,units:a.units,boundingBoxes:[Mn(l)]}),d=Ne({rank:a.rank,names:a.viewNames,scales:a.viewScales,units:a.units});return{subsources:[{id:"default",default:!0,subsource:{volume:o}},{id:"bounds",default:!0,subsource:{staticAnnotations:In(l)}}],modelTransform:{sourceRank:a.rank,rank:a.rank,inputSpace:c,outputSpace:d,transform:a.transform}}})}var Sx=class extends Rt{get description(){return"Single NIfTI file"}get(e){return H$(e.chunkManager,e.credentialsManager,e.providerUrl)}completeUrl(e){return xi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};At("nifti",()=>new Sx);var Sp;(function(r){r[r.RAW=0]="RAW",r[r.GZIP=1]="GZIP",r[r.BLOSC=2]="BLOSC"})(Sp||(Sp={}));var ng=class{};ng.RPC_ID="n5/VolumeChunkSource";var WI=class extends Qe(rt()(Xn),ng){},zI=class extends Gt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.multiscaleMetadata=r;this.scales=i;let a,o;if(i.forEach((m,y)=>{if(m!==void 0){if(o===void 0&&(o=y),a!==void 0&&m.dataType!==a)throw new Error(`Scale s${y} has data type ${H[m.dataType]} but expected ${H[a]}.`);a=m.dataType}}),a===void 0)throw new Error("At least one scale must be specified.");let l=r.scales[o],c=i[o];this.dataType=a,this.volumeType=dt.IMAGE,this.baseScaleIndex=o;let d=r.modelSpace,{rank:p}=d;this.modelSpace=Ne({names:d.names,scales:d.scales,units:d.units,boundingBoxes:[{transform:Zv(Float64Array,l.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(p),upperBounds:new Float64Array(c.size)}}],coordinateArrays:d.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(e){let{}=this,{scales:t,rank:r}=this,i=this.multiscaleMetadata.scales;return Mr(t.filter(a=>a!==void 0).map((a,o)=>{let l=i[o],c=Zv(Float32Array,l.downsamplingFactor);return bi({rank:r,chunkToMultiscaleTransform:c,dataType:a.dataType,upperVoxelBound:a.size,volumeType:this.volumeType,chunkDataSizes:[a.chunkSize],volumeSourceOptions:e}).map(d=>({chunkSource:this.chunkManager.getChunkSource(WI,{credentialsProvider:this.credentialsProvider,spec:d,parameters:{url:l.url,encoding:a.encoding}}),chunkToMultiscaleTransform:c}))}))}},HI=class{constructor(e){Q(e),this.dataType=G(e,"dataType",r=>Mt(r,H)),this.size=Float32Array.from(G(e,"dimensions",r=>ye(r,wt))),this.chunkSize=G(e,"blockSize",r=>He(new Uint32Array(this.size.length),r,wt));let t;le(e,"compression",r=>{t=G(r,"type",i=>Mt(i,Sp))}),t===void 0&&(t=G(e,"compressionType",r=>Mt(r,Sp))),this.encoding=t}};function $$(n,e,t){return Promise.all(t.scales.map(async r=>{let i=await $I(n,e,r.url,!0);if(i!==void 0)return new HI(i)}))}function j$(n){let{protocol:e,host:t,path:r}=Da(n);r.endsWith("/")&&(r=r.substring(0,r.length-1));let i=[];for(;;){i.push(`${e}://${t}${r}/attributes.json`);let a=r.lastIndexOf("/");if(a===-1)break;r=r.substring(0,a)}return i}function q$(n,e,t,r){return n.memoize.getUncounted({type:"n5:attributes.json",url:t,credentialsProvider:ct(e)},()=>cr(e,t,{},ut).then(i=>{try{return Q(i)}catch(a){throw new Error(`Error reading attributes from ${t}: ${a.message}`)}}).catch(i=>{if(Aa(i))return r?void 0:{};throw i}))}async function $I(n,e,t,r){let i=j$(t),a=await Promise.all(i.map((o,l)=>q$(n,e,o,r&&l===i.length-1)));if(a.indexOf(void 0)===-1)return a.reverse(),Object.assign({},...a)}function ds(n,e){if(n!==-1&&e!==n)throw new Error(`Rank mismatch, received ${e} but expected ${n}`);return e}function jI(n){return Float64Array.from(ye(n,St))}function qI(n){let e=Kr(n);if(e.length===0)throw new Error("Expected non-empty array");let t=-1;return{all:ye(e,i=>{let a=jI(i);return t=ds(t,a.length),a}),single:void 0,rank:t}}function J$(n){let e=Kr(n);if(e.length===0)throw new Error("Expected non-empty array");if(Array.isArray(e[0]))return qI(e);let t=jI(n);return{all:void 0,single:t,rank:t.length}}var K$=["x","y","z","t","c"];function Y$(n){let e=K$.slice(0,n);for(;e.length<n;)e.push(`d${e.length+1}`);return e}function X$(n,e){Q(e);let t=-1,r=le(e,"resolution",y=>{let v=Float64Array.from(ye(y,St));return t=ds(t,v.length),v}),i=le(e,"axes",y=>{let v=ye(y,ee);return t=ds(t,v.length),v}),a=le(e,"units",y=>{let v=ye(y,Th);return t=ds(t,v.length),v}),o={unit:"m",exponent:-9},l,c;le(e,"downsamplingFactors",y=>{let{single:v,all:b,rank:x}=J$(y);t=ds(t,x),v!==void 0&&(l=v),b!==void 0&&(c=b)}),le(e,"pixelResolution",y=>{o=G(y,"unit",Th),le(y,"dimensions",v=>{r=Float64Array.from(ye(v,St)),t=ds(t,r.length)})}),le(e,"scales",y=>{let{all:v,rank:b}=qI(y);t=ds(t,b),c=v});let d=le(e,"dimensions",y=>{let v=ye(y,wt);return t=ds(t,v.length),v});if(t===-1)throw new Error("Unable to determine rank of dataset");a===void 0&&(a=new Array(t),a.fill(o)),r===void 0&&(r=new Float64Array(t),r.fill(1));for(let y=0;y<t;++y)r[y]=xd(r[y],a[y].exponent);let p=new Array(t);i!==void 0&&le(e,"coordinateArrays",y=>{Q(y);for(let v=0;v<t;++v){let b=i[v];if(Object.prototype.hasOwnProperty.call(y,b)){let x=jt(y[b]);p[v]={explicit:!1,labels:x,coordinates:Array.from(x,(C,k)=>k)},a[v]={unit:"",exponent:0},r[v]=1}}}),i===void 0&&(i=Y$(t));let m=Ne({rank:t,valid:!0,names:i,scales:r,units:a.map(y=>y.unit),coordinateArrays:p});if(d===void 0){if(c===void 0)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:m,url:n,attributes:e,scales:c.map((y,v)=>({url:`${n}/s${v}`,downsamplingFactor:y}))}}return l===void 0&&(l=new Float64Array(t),l.fill(1)),{modelSpace:m,url:n,attributes:e,scales:[{url:n,downsamplingFactor:l}]}}var bx=class extends Rt{get description(){return"N5 data source"}get(e){let{providerUrl:t}=e;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{let{url:r,credentialsProvider:i}=wn(t,e.credentialsManager),a=await $I(e.chunkManager,i,r,!1),o=X$(r,a),l=await $$(e.chunkManager,i,o),c=new zI(e.chunkManager,i,o,l);return{modelTransform:mt(c.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:c}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:In(c.modelSpace.bounds)}}]}})}completeUrl(e){return xi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};At("n5",()=>new bx);var yl;(function(r){r[r.RAW=0]="RAW",r[r.GZIP=1]="GZIP",r[r.BLOSC=2]="BLOSC"})(yl||(yl={}));var rg=class{};rg.RPC_ID="zarr/VolumeChunkSource";var vo=new Map;vo.set("|u1",{endianness:mn.LITTLE,dataType:H.UINT8});vo.set("|i1",{endianness:mn.LITTLE,dataType:H.INT8});for(let[n,e]of[["<",mn.LITTLE],[">",mn.BIG]]){for(let t of["u","i"])vo.set(`${n}${t}8`,{endianness:e,dataType:H.UINT64});vo.set(`${n}u2`,{endianness:e,dataType:H.UINT16}),vo.set(`${n}i2`,{endianness:e,dataType:H.INT16}),vo.set(`${n}u4`,{endianness:e,dataType:H.UINT32}),vo.set(`${n}i4`,{endianness:e,dataType:H.INT32}),vo.set(`${n}f4`,{endianness:e,dataType:H.FLOAT32})}function JI(n){let e=vo.get(n);if(e===void 0)throw new Error(`Unsupported numpy data type: ${JSON.stringify(n)}`);return e}var KI=class extends Qe(rt()(Xn),rg){};function YI(n){return le(n,"dimension_separator",e=>{if(e!=="."&&e!=="/")throw new Error(`Expected "." or "/", but received: ${JSON.stringify(e)}`);return e})}function Q$(n){try{Q(n),G(n,"zarr_format",l=>{if(l!==2)throw new Error(`Expected 2 but received: ${JSON.stringify(l)}`)});let e=G(n,"shape",l=>ye(l,c=>{if(typeof c!="number"||!Number.isInteger(c)||c<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(c)}`);return c})),t=G(n,"chunks",l=>He(new Array(e.length),l,c=>{if(typeof c!="number"||!Number.isInteger(c)||c<=0)throw new Error(`Expected positive integer, but received: ${JSON.stringify(c)}`);return c})),r=G(n,"order",l=>{if(l!=="C"&&l!=="F")throw new Error(`Expected "C" or "F", but received: ${JSON.stringify(l)}`);return l}),i=YI(n),a=G(n,"dtype",l=>JI(ee(l))),o=G(n,"compressor",l=>{if(l===null)return yl.RAW;Q(l);let c=G(l,"id",ee);switch(c){case"blosc":return yl.BLOSC;case"gzip":return yl.GZIP;case"zlib":return yl.GZIP;default:throw new Error(`Unsupported compressor: ${JSON.stringify(c)}`)}});return{rank:e.length,shape:e,chunks:t,order:r,dataType:a.dataType,encoding:{compressor:o,endianness:a.endianness},dimensionSeparator:i}}catch(e){throw new Error(`Error parsing zarr metadata: ${e.message}`)}}var XI=class extends Gt{constructor(e,t,r,i,a,o){super(e);this.credentialsProvider=t;this.url=r;this.separator=i;this.metadata=a;this.attrs=o;this.dataType=a.dataType,this.volumeType=dt.IMAGE;let l=le(o,"_ARRAY_DIMENSIONS",c=>He(new Array(a.rank),c,ee));l===void 0&&(l=Array.from(a.shape,(c,d)=>`d${d}`)),this.modelSpace=Ne({names:l,scales:Float64Array.from(a.shape,()=>1),units:Array.from(a.shape,()=>""),boundingBoxes:[Mn({lowerBounds:new Float64Array(a.rank),upperBounds:Float64Array.from(a.shape)})]})}get rank(){return this.metadata.rank}getSources(e){let{metadata:t}=this,{rank:r,chunks:i,shape:a}=t,o,l,c;if(t.order==="F")o=Uint32Array.from(i),l=Float32Array.from(a),c=rr(Float32Array,r+1);else{o=new Uint32Array(r),l=new Float32Array(r),c=new Float32Array((r+1)**2),c[(r+1)**2-1]=1;for(let d=0;d<r;++d)o[d]=i[r-1-d],l[d]=a[r-1-d],c[d+(r-1-d)*(r+1)]=1}return Mr([bi({rank:r,chunkToMultiscaleTransform:c,dataType:t.dataType,upperVoxelBound:l,volumeType:this.volumeType,chunkDataSizes:[o],volumeSourceOptions:e}).map(d=>({chunkSource:this.chunkManager.getChunkSource(KI,{credentialsProvider:this.credentialsProvider,spec:d,parameters:{url:this.url,encoding:t.encoding,separator:this.separator}}),chunkToMultiscaleTransform:c}))])}};function Z$(n,e,t){return n.memoize.getUncounted({type:"zarr:.zattrs json",url:t,credentialsProvider:ct(e)},async()=>{try{let r=await cr(e,t+"/.zattrs",{},ut);return Q(r),r}catch(r){if(Aa(r))return{};throw r}})}function ej(n,e,t){return n.memoize.getUncounted({type:"zarr:.zarray json",url:t,credentialsProvider:ct(e)},async()=>{let r=await cr(e,t+"/.zarray",{},ut);return Q$(r)})}var tj=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}],xx=class extends Rt{get description(){return"Zarr data source"}get(e){let[,t,r]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),i=Vr(r||"");Q(i);let a=YI(i);return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:t,dimensionSeparator:a},async()=>{let{url:o,credentialsProvider:l}=wn(t,e.credentialsManager),[c,d]=await Promise.all([ej(e.chunkManager,l,o),Z$(e.chunkManager,l,o)]);if(c.dimensionSeparator!==void 0&&a!==void 0&&c.dimensionSeparator!==a)throw new Error(`Explicitly specified dimension separator ${JSON.stringify(a)} does not match value in .zarray ${JSON.stringify(c.dimensionSeparator)}`);let p=new XI(e.chunkManager,l,o,a||c.dimensionSeparator||".",c,d);return{modelTransform:mt(p.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:p}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:In(p.modelSpace.bounds)}}]}})}async completeUrl(e){let[,,t]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);return t!==void 0?Br(e.providerUrl.length-t.length,await Kh(t,tj)):await xi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};At("zarr",()=>new xx);var QI="single_mesh/SingleMeshLayer",ZI="single_mesh/getSingleMeshInfo",ig="",eM=class{},ag=class extends eM{};ag.RPC_ID="single_mesh/SingleMeshSource";var tM=class extends j{constructor(e){super();this.gl=e;this.buffer=this.registerDisposer(new Nt(e))}resize(e){let t;if(e<256){let r=t=new Uint8Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_BYTE}else if(e<65536){let r=t=new Uint16Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_SHORT}else{let r=t=new Uint32Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_INT}this.buffer.setData(t),this.length=e}ensure(e){return(this.length===void 0||this.length<e)&&this.resize(e),this}bindToVertexAttrib(e){this.buffer.bindToVertexAttribI(e,1,this.webglType)}bind(e,t=0){let r=e.attribute("aIndexRaw");r>=0&&(this.bindToVertexAttrib(r),t!==0&&this.gl.vertexAttribDivisor(r,t))}};function nM(n,e,t=!1){let r=e.attribute("aIndexRaw");r>=0&&(t&&n.vertexAttribDivisor(r,0),n.disableVertexAttribArray(r))}function rM(n){return n.memoize.get("IndexBuffer",()=>new tM(n))}function iM(n){n.addAttribute("highp uint","aIndexRaw"),n.addVertexCode(Ys),n.addVertexCode(`
uint getPrimitiveIndex() {
  return aIndexRaw;
}
`)}var Cx=class{constructor(e){this.name=e}defineShader(e){e.addAttribute("highp uint",this.name)}bind(e,t){let r=t.attribute(this.name);e.bindToVertexAttribI(r,1,WebGL2RenderingContext.UNSIGNED_INT)}disable(e){e.gl.disableVertexAttribArray(e.attribute(this.name))}};function aM(n,e){return Nt.fromData(n,e,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}var oM=`void main() {
  emitGray();
}
`,wx=class{constructor(){this.shaderError=ya();this.fragmentMain=Ko(oM);this.shaderControlState=new po(this.fragmentMain)}};function Tx(n){return Vt(n.dataType,n.numComponents)}var vl=[],sM=gi(new $i,H.FLOAT32,3),nj=sM;function rj(n){return n.split(/[^a-zA-Z0-9]+/).filter(e=>e).join("_")}function kx(n){let e=new Set,t=[];for(let r of n){let i=rj(r),a="",o=0;for(;e.has(i+a);)a=""+ ++o;t.push(i+a)}return t}var lM=class{constructor(e,t){this.attributeNames=e;this.attributeInfo=t;this.tempLightVec=new Float32Array(4);this.textureAccessHelper=new mo("vertexData");this.indexBufferHelper=new Cx("vertexIndex")}defineAttributeAccess(e,t){let{textureAccessHelper:r}=this;r.defineShader(e);let{attributeNames:i}=this,a=2+i.length;for(let l=vl.length;l<a;++l)vl[l]=Symbol(`SingleMeshShaderManager.vertexAttributeTextureUnit${l}`);a=0,e.addTextureSampler("sampler2D","uVertexAttributeSampler0",vl[a++]),e.addTextureSampler("sampler2D","uVertexAttributeSampler1",vl[a++]),e.addVertexCode(r.getAccessor("readVertexPosition","uVertexAttributeSampler0",H.FLOAT32,3)),e.addVertexCode(r.getAccessor("readVertexNormal","uVertexAttributeSampler1",H.FLOAT32,3));let o=`
vec3 vertexPosition = readVertexPosition(${t});
vec3 vertexNormal = readVertexNormal(${t});
`;this.attributeInfo.forEach((l,c)=>{e.addTextureSampler(`${Mc(l.dataType)}sampler2D`,`uVertexAttributeSampler${a}`,vl[a]);let d=Tx(l);e.addVarying(`highp ${d}`,`vCustom${c}`),e.addFragmentCode(`
#define ${i[c]} vCustom${c}
`),e.addVertexCode(r.getAccessor(`readAttribute${c}`,`uVertexAttributeSampler${a}`,l.dataType,l.numComponents)),o+=`vCustom${c} = readAttribute${c}(${t});
`,++a}),e.addVertexMain(o)}defineShader(e){e.require(iM),this.indexBufferHelper.defineShader(e),e.addVarying("highp float","vLightingFactor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uModelMatrix"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexMain(`
uint triangleIndex = getPrimitiveIndex() / 3u;
vPickID = uPickID + triangleIndex;
`),e.addFragmentCode(`
void emitPremultipliedRGBA(vec4 color) {
  emit(vec4(color.rgb * vLightingFactor, color.a), vPickID);
}
void emitRGBA(vec4 color) {
  color = clamp(color, 0.0, 1.0);
  color.xyz *= color.a;
  emitPremultipliedRGBA(color);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitGray() {
  emitRGB(vec3(1.0, 1.0, 1.0));
}
`),e.addFragmentCode(Oi),this.defineAttributeAccess(e,"vertexIndex"),e.addVertexMain(`
gl_Position = uProjection * (uModelMatrix * vec4(vertexPosition, 1.0));
vec3 normal = normalize((uModelMatrix * vec4(vertexNormal, 0.0)).xyz);
vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
`)}beginLayer(e,t,r){let{lightDirection:i,ambientLighting:a,directionalLighting:o,projectionParameters:l}=r,{viewProjectionMat:c}=l;e.uniformMatrix4fv(t.uniform("uProjection"),!1,c);let d=this.tempLightVec;J.scale(d,i,o),d[3]=a,e.uniform4fv(t.uniform("uLightDirection"),d)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginObject(e,t,r){e.uniformMatrix4fv(t.uniform("uModelMatrix"),!1,r)}bindVertexData(e,t,r){let i=0,a=l=>{let c=WebGL2RenderingContext.TEXTURE0+t.textureUnit(vl[i]);e.activeTexture(c),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,l),++i};a(r.vertexTexture),a(r.normalTexture);let{attributeNames:o}=this;r.vertexAttributeTextures.forEach((l,c)=>{o[c]!==void 0&&a(l)})}disableVertexData(e,t){let r=2,i=this.attributeInfo.length,{attributeNames:a}=this;for(let o=0;o<i;++o)a[o]!==void 0&&++r;for(let o=0;o<r;++o){let l=t.textureUnit(vl[o])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(l),e.bindTexture(e.TEXTURE_2D,null)}}drawFragment(e,t,r,i){i.ensure(r.numIndices).bind(t),this.bindVertexData(e,t,r.vertexData),this.indexBufferHelper.bind(r.indexBuffer,t),e.drawArrays(WebGL2RenderingContext.TRIANGLES,0,r.numIndices)}endLayer(e,t){nM(e,t),this.indexBufferHelper.disable(t),this.disableVertexData(e,t)}},cM=class{copyToGPU(e,t){let r=(i,a)=>{let o=e.createTexture();return e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o),ns(e,a,i),o};this.vertexTexture=r(this.vertexPositions,sM),this.normalTexture=r(this.vertexNormals,nj),this.vertexAttributeTextures=this.vertexAttributes.map((i,a)=>r(i,t[a])),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}freeGPUMemory(e){e.deleteTexture(this.vertexTexture),e.deleteTexture(this.normalTexture);let{vertexAttributeTextures:t}=this;for(let r of t)e.deleteTexture(r);t.length=0}},uM=class extends xr{constructor(e,t){super(e);let r=this.vertexData=new cM;r.vertexPositions=t.vertexPositions,r.vertexNormals=t.vertexNormals,r.vertexAttributes=t.vertexAttributes;let i=this.indices=t.indices;this.numIndices=i.length}copyToGPU(e){super.copyToGPU(e),this.vertexData.copyToGPU(e,this.source.attributeTextureFormats),this.indexBuffer=aM(e,this.indices)}freeGPUMemory(e){super.freeGPUMemory(e),this.vertexData.freeGPUMemory(e),this.indexBuffer.dispose()}};function ij(n){return n.map(e=>gi(new $i,e.dataType,e.numComponents))}var dM=class extends Qe(rt()(jn),ag){constructor(){super(...arguments);this.attributeTextureFormats=ij(this.info.vertexAttributes)}get info(){return this.parameters.info}getChunk(e){return new uM(this,e)}},aj=va(gn),pM=class extends aj{},Lx=class extends Ur{constructor(e,t,r){super();this.source=e;this.displayState=t;this.transform=r;this.shaderManager=new lM(kx(this.source.info.vertexAttributes.map(e=>e.name)),this.source.info.vertexAttributes);this.shaders=new Map;this.sharedObject=this.registerDisposer(new pM);this.shaderGetter=ei(this,this.gl,{memoizeKey:{t:"single_mesh/RenderLayer",attributes:this.source.info.vertexAttributes},fallbackParameters:new Re(Xo(uo(oM))),parameters:this.displayState.shaderControlState.builderState,encodeParameters:e=>e.key,shaderError:this.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Ui(t,e),this.shaderManager.defineShader(e),e.setFragmentMainFunction(Ni(t.parseResult.code))}});this.countingBuffer=this.registerDisposer(rM(this.gl));this.registerDisposer(t.shaderControlState.parseResult.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch));let{sharedObject:i}=this;i.visibility.add(this.visibility),i.RPC_TYPE_ID=QI,i.initializeCounterpart(e.chunkManager.rpc,{chunkManager:e.chunkManager.rpcId,source:e.addCounterpartRef()})}disposeShaders(){let{shaders:e}=this;for(let t of e.values())t!==null&&t.dispose();e.clear()}disposed(){this.disposeShaders(),super.disposed()}get isTransparent(){return this.displayState.fragmentMain.value.match(/emitRGBA|emitPremultipliedRGBA/)!==null}get gl(){return this.source.gl}isReady(){let e=this.source.chunks.get(ig);return!(e===void 0||e.state!==nt.GPU_MEMORY)}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let r=es(this.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(r===void 0)return;let i=this.source.chunks.get(ig);if(i===void 0||i.state!==nt.GPU_MEMORY)return;let a=this.shaderGetter(e.emitter),{shader:o,parameters:l}=a;if(o===null)return;let{gl:c}=this,d=this.shaderManager;o.bind(),d.beginLayer(c,o,e),ti(c,o,this.displayState.shaderControlState,l.parseResult.controls);let{pickIDs:p}=e;d.beginObject(c,o,r),e.emitPickID&&d.setPickID(c,o,p.register(this,i.numIndices/3)),d.drawFragment(c,o,i,this.countingBuffer),d.endLayer(c,o)}transformPickedValue(e){let{pickedOffset:t}=e,r=this.source.chunks.get(ig);if(r===void 0)return;let i=t*3,{indices:a}=r;if(i>=a.length)return;let o=a[i],l=[],{attributeNames:c}=this.shaderManager;return r.vertexData.vertexAttributes.forEach((d,p)=>{let m=c[p];m!==void 0&&l.push(`${m}=${d[o].toPrecision(6)}`)}),l.join(", ")}};function oj(n,e,t){return n.memoize.getUncounted({type:"single_mesh:getMeshInfo",url:t},async()=>{let{url:r,credentialsProvider:i}=wn(t,e);return{info:await n.rpc.promiseInvoke(ZI,{chunkManager:n.addCounterpartRef(),credentialsProvider:Wd(n,i),parameters:{meshSourceUrl:r}}),url:r,credentialsProvider:i}})}async function og(n,e,t){let{info:r,url:i,credentialsProvider:a}=await oj(n,e,t);return n.getChunkSource(dM,{credentialsProvider:a,parameters:{meshSourceUrl:i,info:r}})}var Ex=class extends Rt{get description(){return"VTK mesh file"}async get(e){let t=await og(e.chunkManager,e.credentialsManager,e.url),r=Ne({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:mt(r),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return xi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};At("vtk",()=>new Ex);var Px=class extends Rt{get description(){return"Wavefront OBJ mesh file"}async get(e){let t=await og(e.chunkManager,e.credentialsManager,e.url),r=Ne({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:mt(r),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return xi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};At("obj",()=>new Px);function fM(n){return new Error(`ngauth server ${n} does not allow requests from Neuroglancer instance ${self.origin}`)}async function sj(n){let e=new Ce(!1);function t(i,a){e.element.textContent=i+" ";let o=document.createElement("button");o.textContent=a,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${n}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to ngauth server ${n}...`,"Retry")})}let r=new Promise((i,a)=>{function o(l){if((l.origin||l.originalEvent.origin)!==n)return;let d=()=>{window.removeEventListener("message",o,!1)},{data:p}=l;l.data==="badorigin"&&(d(),a(fM(n)));try{Q(p);let m=G(p,"token",ee);d(),i(m)}catch(m){console.log("ngauth: Received unexpected message from ${serverUrl}",l)}}window.addEventListener("message",o,!1)});t(`ngauth server ${n} login required.`,"Login");try{return{token:await r}}finally{e.dispose()}}var Dx=class extends Jt{constructor(e){super();this.serverUrl=e;this.get=on(async()=>{let e=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(e.status){case 200:return{token:await e.text()};case 401:return await sj(this.serverUrl);case 403:throw fM(this.serverUrl);default:throw wr.fromResponse(e)}})}},Ax=class extends Jt{constructor(e,t,r){super();this.ngauthCredentialsProvider=e;this.serverUrl=t;this.bucket=r;this.get=on(async()=>{let e=await hi(this.ngauthCredentialsProvider,`${this.serverUrl}/gcs_token`,{method:"POST"},ut,(t,r)=>({...r,body:JSON.stringify({token:t.token,bucket:this.bucket})}),t=>{let{status:r}=t;if(r===401)return"refresh";throw t});return{tokenType:"Bearer",accessToken:e.token}})}};Nn.register("ngauth",n=>new Dx(n));Nn.register("ngauth_gcs",(n,e)=>new Ax(e.getCredentialsProvider("ngauth",n.authServer),n.authServer,n.bucket));function lj(n,e,t){let r=window.outerHeight-window.innerHeight+window.innerHeight/2-t/2,i=window.innerWidth/2-e/2;return window.open(n,void 0,`toolbar=no, menubar=no, width=${e}, height=${t}, top=${r}, left=${i}`)}async function cj(n){let e=new Ce(!1),t=new Promise(r=>{function i(a,o){e.element.textContent=a+" ";let l=document.createElement("button");l.textContent=o,e.element.appendChild(l),l.addEventListener("click",()=>{i(`Waiting for login to middleauth server ${n}...`,"Retry");let c=lj(`${n}/api/v1/authorize`,400,650),d=()=>{c==null||c.close()};window.addEventListener("beforeunload",d);let p=setInterval(()=>{(c==null?void 0:c.closed)&&(clearInterval(p),i(`Login window closed for middleauth server ${n}.`,"Retry"))},1e3),m=async y=>{if(y.source===c){clearInterval(p),window.removeEventListener("message",m),window.removeEventListener("beforeunload",d),d(),Q(y.data);let v=G(y.data,"token",ee),b=G(y.data,"app_urls",jt);r({tokenType:"Bearer",accessToken:v,url:n,appUrls:b})}};window.addEventListener("message",m)})}i(`middleauth server ${n} login required.`,"Login")});try{return await t}finally{e.dispose()}}var hM="auth_token_v2";function uj(n){let e=localStorage.getItem(`${hM}_${n}`);return e?JSON.parse(e):null}function dj(n,e){localStorage.setItem(`${hM}_${n}`,JSON.stringify(e))}var Ix=class extends Jt{constructor(e){super();this.serverUrl=e;this.alreadyTriedLocalStorage=!1;this.get=on(async()=>{let e;return this.alreadyTriedLocalStorage||(this.alreadyTriedLocalStorage=!0,e=uj(this.serverUrl)),e||(e=await cj(this.serverUrl),dj(this.serverUrl,e)),e})}},mM=class extends Error{constructor(e){super();this.url=e}},Mx=class extends Jt{constructor(e,t){super();this.serverUrl=e;this.credentialsManager=t;this.credentials=void 0;this.get=on(async()=>{let e=await fetch(`${this.serverUrl}/auth_info`).then(r=>r.json()),t=this.credentialsManager.getCredentialsProvider("middleauth",e.login_url);if(this.credentials=await t.get(this.credentials),this.credentials.credentials.appUrls.includes(this.serverUrl))return this.credentials.credentials;throw new Ce(!1).setText(`middleauth: unverified app ${this.serverUrl}`),new mM(this.serverUrl)})}};Nn.register("middleauth",n=>new Ix(n));Nn.register("middleauthapp",(n,e)=>new Mx(n,e));var Vx=at(It());function gM(n){return new Error(`Nggraph server ${n} does not allow requests from Neuroglancer instance ${self.origin}`)}async function pj(n){let e=new Ce(!1);function t(i,a){e.element.textContent=i+" ";let o=document.createElement("button");o.textContent=a,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${n}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to nggraph server ${n}...`,"Retry")})}let r=new Promise((i,a)=>{function o(l){if((l.origin||l.originalEvent.origin)!==n||typeof l.data!="string")return;let d=()=>{window.removeEventListener("message",o,!1)};l.data==="badorigin"?(d(),a(gM(n))):(d(),i(l.data))}window.addEventListener("message",o,!1)});t(`Nggraph server ${n} login required.`,"Login");try{return{token:await r}}finally{e.dispose()}}var Rx=class extends Jt{constructor(e){super();this.serverUrl=e;this.get=on(async()=>{let e=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(e.status){case 200:return{token:await e.text()};case 401:return await pj(this.serverUrl);case 403:throw gM(this.serverUrl);default:throw wr.fromResponse(e)}})}};var sg=Symbol("disjoint_sets:rank"),So=Symbol("disjoint_sets:parent"),lg=Symbol("disjoint_sets:next"),bp=Symbol("disjoint_sets:prev");function _x(n){let e=n,t=n[So];for(;t!==n;)n=t,t=n[So];for(n=e[So];t!==n;)e[So]=t,e=n,n=e[So];return t}function fj(n,e){let t=n[sg],r=e[sg];return t>r?(e[So]=n,n):(n[So]=e,t===r&&(e[sg]=r+1),e)}function hj(n,e){let t=n[bp],r=e[bp];e[bp]=t,t[lg]=e,n[bp]=r,r[lg]=n}function*yM(n){let e=n;do yield e,e=e[lg];while(e!==n)}function mj(n){n[So]=n,n[sg]=0,n[lg]=n[bp]=n}var $c=Symbol("disjoint_sets:min");function vM(n){return n[So]===n}var Sl=class{constructor(){this.map=new Map;this.visibleSegmentEquivalencePolicy=new Re(qt.MIN_REPRESENTATIVE);this.generation=0}has(e){let t=e.toString();return this.map.get(t)!==void 0}get(e){let t=e.toString(),r=this.map.get(t);return r===void 0?e:_x(r)[$c]}isMinElement(e){let t=this.get(e);return t===e||X.equal(t,e)}makeSet(e){let t=e.toString(),{map:r}=this,i=r.get(t);return i===void 0?(i=e.clone(),mj(i),i[$c]=i,r.set(t,i),i):_x(i)}link(e,t){if(e=this.makeSet(e),t=this.makeSet(t),e===t)return!1;this.generation++;let r=fj(e,t);hj(e,t);let i=e[$c],a=t[$c],o=(this.visibleSegmentEquivalencePolicy.value&qt.MAX_REPRESENTATIVE)!=0;return r[$c]=X.less(i,a)===o?a:i,!0}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}deleteSet(e){let{map:t}=this,r=!1;for(let i of this.setElements(e))t.delete(i.toString()),r=!0;return r}*setElements(e){let t=e.toString(),r=this.map.get(t);r===void 0?yield e:yield*yM(r)}clear(){let{map:e}=this;return e.size===0?!1:(++this.generation,e.clear(),!0)}get size(){return this.map.size}*mappings(e=new Array(2)){for(let t of this.map.values())e[0]=t,e[1]=_x(t)[$c],yield e}*roots(){for(let e of this.map.values())vM(e)&&(yield e)}[Symbol.iterator](){return this.mappings()}toJSON(){let e=new Array;for(let t of this.map.values())if(vM(t)){let r=new Array;for(let i of yM(t))r.push(i);r.sort(X.compare),e.push(r)}return e.sort((t,r)=>X.compare(t[0],r[0])),e.map(t=>t.map(r=>r.toString()))}};var gj="^(https?://[^/]+)/(.*)$";function yj(n){return Q(n),{id:G(n,"id",e=>X.parseString(ee(e))),baseSegments:G(n,"base_segment_ids",e=>ye(e,t=>X.parseString(ee(t)))),baseSegmentParents:G(n,"base_segment_parent_ids",e=>ye(e,t=>X.parseString(ee(t)))),name:G(n,"name",ee),tags:G(n,"tags",jt),numVoxels:G(n,"num_voxels",ot),bounds:G(n,"bounds",e=>ye(e,t=>Ye(t))),lastLogId:G(n,"last_log_id",e=>e==null?null:X.parseString(ee(e)))}}var SM=0,bM=class extends el{constructor(e,t){super(e,t);this.debouncedVisibleSegmentsChanged=this.registerCancellable((0,Vx.default)(()=>this.visibleSegmentsChanged(),0));this.segmentQueries=new Map;this.ignoreVisibleSegmentsChanged=!1;this.segmentEquivalencesChanged=this.registerCancellable((0,Vx.default)(()=>{this.debouncedVisibleSegmentsChanged.flush(),this.segmentEquivalencesChanged.cancel();let{segmentQueries:e}=this,{segmentEquivalences:t}=this.segmentsState;t.clear();for(let[r,i]of e){if(i.current===void 0||kc(i.id))continue;let{id:a,baseSegments:o}=i.current;if(o.length>0){for(let l of o)t.link(l,a);i.addedEquivalences=!0}else i.addedEquivalences=!1}},0));let r=()=>{this.ignoreVisibleSegmentsChanged||this.debouncedVisibleSegmentsChanged()};this.registerDisposer(t.visibleSegments.changed.add(r)),this.registerDisposer(t.temporaryVisibleSegments.changed.add(r)),this.visibleSegmentsChanged()}computeSplit(e,t){let{segmentEquivalences:r}=this.segmentsState,i=r.get(e);if(kc(i)||!X.equal(r.get(t),i))return;let a=this.segmentQueries.get(i.toString());if(a===void 0)return;let{current:o}=a;if(o===void 0)return;let{baseSegments:l,baseSegmentParents:c}=o,d=c.length,p=new Sl;for(let b=0;b<d;++b){let x=l[b],C=c[b];X.equal(x,t)||X.equal(C,t)||(p.link(x,C),console.log(`Linking ${x} - ${C} == ${e}? ${X.equal(e,x)} ${X.equal(e,C)} :: unioned with include = ${X.equal(e,p.get(x))}, with exclude = ${X.equal(t,p.get(x))}`))}let m=[],y=[],v=p.get(e);for(let b of l)X.equal(p.get(b),v)?m.push(b):y.push(b);return console.log("include = "+m.map(b=>b.toString()).join(",")),console.log("exclude = "+y.map(b=>b.toString()).join(",")),{includeRepresentative:i,includeBaseSegments:m,excludeRepresentative:zS,excludeBaseSegments:y}}registerVisibleSegment(e){let t={id:e,current:void 0,addedEquivalences:!1,seenGeneration:SM,disposer:this.graph.watchSegment(e,i=>this.handleSegmentUpdate(t.id.toString(),i))},r=e.toString();this.segmentQueries.set(r,t),console.log(`adding to segmentQueries: ${r}`)}handleSegmentUpdate(e,t){console.log(`handleSegmentUpdate: ${e}`);let r=this.segmentQueries.get(e);if(t==="invalid"){r.disposer(),console.log(`removing from segmentQueries: ${e} due to invalid`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.delete(r.id),this.segmentsState.temporaryVisibleSegments.delete(r.id)}finally{this.ignoreVisibleSegmentsChanged=!1}r.addedEquivalences&&this.segmentEquivalencesChanged();return}if(t==="error"){r.current=void 0,r.addedEquivalences&&this.segmentEquivalencesChanged(),console.log(`Error from ${this.graph.serverUrl}/${this.graph.entityName} watching segment ${e}`);return}r.current=t;let i=r.id,a=t.id;if(X.equal(a,i))r.current=t,kc(r.id)||this.segmentEquivalencesChanged();else{r.id=a;let o=a.toString(),l=this.segmentQueries.get(o);console.log(`removing from segmentQueries: ${e} due to rename -> ${a}`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.has(i)&&(this.segmentsState.visibleSegments.delete(i),this.segmentsState.visibleSegments.add(a)),this.segmentsState.temporaryVisibleSegments.has(i)&&(this.segmentsState.temporaryVisibleSegments.delete(i),this.segmentsState.temporaryVisibleSegments.add(a))}finally{this.ignoreVisibleSegmentsChanged=!1}l===void 0?(console.log(`adding to segmentQueries due to rename -> ${a}`),this.segmentQueries.set(o,r),this.segmentEquivalencesChanged()):(t.lastLogId!==null&&(typeof l.current!="object"||l.current.lastLogId===null||X.less(l.current.lastLogId,t.lastLogId))&&(l.current=t,this.segmentEquivalencesChanged()),r.disposer())}}visibleSegmentsChanged(){let{segmentsState:e}=this,{segmentQueries:t}=this,r=++SM,i=a=>{for(let o of a.unsafeKeys()){if(X.equal(o,zS))continue;let l=o.toString(),c=t.get(l);if(c!==void 0){c.seenGeneration=r;continue}this.registerVisibleSegment(o.clone())}};i(e.visibleSegments),i(e.temporaryVisibleSegments);for(let[a,o]of t)o.seenGeneration!==r&&(console.log(`removing from segmentQueries due to seenGeneration: ${a}`),t.delete(a),o.disposer(),o.addedEquivalences&&this.segmentEquivalencesChanged())}},xM=class extends Zs{constructor(e,t,r){super();this.chunkManager=e;this.serverUrl=t;this.entityName=r;this.startingWebsocket=!1;this.websocket=void 0;this.watchesById=new Map;this.watches=new Set;this.nextWatchId=0;this.numOpenFailures=0}get visibleSegmentEquivalencePolicy(){return qt.MAX_REPRESENTATIVE|qt.REPRESENTATIVE_EXCLUDED}startWebsocket(){if(this.startingWebsocket||this.watches.size===0)return;this.startingWebsocket=!0;let e=new Ce(!this.numOpenFailures);e.setText(`Opening websocket connection for nggraph://${this.serverUrl}/${this.entityName}`),(async()=>{let{numOpenFailures:t}=this;if(t>1){let o=1e3*Math.min(16,2**t);await new Promise(l=>setTimeout(l,o))}let r=(await Nx(this.chunkManager,this.serverUrl,this.entityName).get()).credentials,i=new URL("/graph/watch/"+encodeURIComponent(r.token),this.serverUrl);i.protocol=i.protocol.replace("http","ws");let a=new WebSocket(i.href);a.onclose=()=>{e!==void 0&&(e.dispose(),e=void 0),++this.numOpenFailures,this.websocket=void 0,this.startingWebsocket=!1,this.watchesById.clear(),this.startWebsocket()},a.onopen=()=>{e!==void 0&&(e.dispose(),e=void 0),this.numOpenFailures=0,this.websocket=a,this.nextWatchId=0;try{for(let o of this.watches){a.send(JSON.stringify({watch:{segment_id:o.segment.toString()}}));let l=this.nextWatchId++;o.watchId=l,this.watchesById.set(l,o)}}catch{}},a.onmessage=o=>{let l,c;try{let d=JSON.parse(o.data);Q(d);let p=G(d,"watch_id",ot),m=this.watchesById.get(p);if(m===void 0)return;c=m;let y=G(d,"state",ee);y==="invalid"||y==="error"?l=y:l=G(d,"info",yj)}catch(d){console.log(`Received unexpected websocket message from ${this.serverUrl}:`,o.data,d);return}console.log("got update",l),c.callback(l)}})()}connect(e){return new bM(this,e)}trackSegment(e,t){return this.watchSegment(e,r=>{if(r==="invalid")t(null);else{if(r==="error")return;t(r.id)}})}watchSegment(e,t){let r={callback:t,segment:e,watchId:-1};this.watches.add(r);let{websocket:i}=this;if(i!==void 0)try{i.send(JSON.stringify({watch:{segment_id:e.toString()}}));let o=this.nextWatchId++;r.watchId=o,this.watchesById.set(o,r)}catch{}else this.startWebsocket();return()=>{let{websocket:o}=this;if(o!==void 0&&o.readyState===WebSocket.OPEN){let l=r.watchId;this.watchesById.delete(l);try{o.send(JSON.stringify({unwatch:{watch_id:l}}))}catch{}}this.watches.delete(r)}}async merge(e,t){let r=await Bx(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({merge:{anchor:e.toString(),other:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return Q(r),G(r,"merged",i=>X.parseString(i))}async split(e,t){let r=await Bx(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({split:{include:e.toString(),exclude:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return Q(r),{include:G(r,"include",i=>X.parseString(i)),exclude:G(r,"exclude",i=>X.parseString(i))}}};function CM(n){let e=n.match(gj);if(e===null)throw new Error(`Invalid nggraph url: ${JSON.stringify(n)}`);return{serverUrl:e[1],id:e[2]}}function Ox(n,e,t,r,i=Je){return hi(n,`${e}${t}`,r,ut,(a,o)=>{let l=new Headers(o.headers);return l.set("Authorization",a.token),{...o,headers:l}},a=>{let{status:o}=a;if(o===401)return"refresh";throw a},i)}function vj(n,e,t,r,i=Je){return Ox(TM(n,e),e,t,r,i)}var wM=class extends Jt{constructor(e,t,r){super();this.parentCredentialsProvider=e;this.serverUrl=t;this.entityName=r;this.get=on(async()=>{let e=await Ox(this.parentCredentialsProvider,this.serverUrl,"/entity_token",{body:JSON.stringify({entity:this.entityName}),headers:{"Content-Type":"application/json"},method:"POST"});return{token:e.token,entityType:e.entity_type,role:e.role}})}};function TM(n,e){return n.memoize.getUncounted({type:"nggraph:credentialsProvider",serverUrl:e},()=>new Rx(e))}function Nx(n,e,t){return n.memoize.getUncounted({type:"nggraph:entityCredentialsProvider",serverUrl:e,entityName:t},()=>new wM(TM(n,e),e,t))}function Bx(n,e,t,r,i,a=Je){return Ox(Nx(n,e,t),e,r,i,a)}function Sj(n){return Q(n),G(n,"entities",e=>ye(e,t=>{Q(t);let r=G(t,"entity",ee),i=G(t,"entity_type",ee),a=G(t,"access_role",ee);return{id:r,entityType:i,accessRole:a}}))}var Ux=class extends Rt{get description(){return"nggraph data source"}get(e){let{serverUrl:t,id:r}=CM(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"nggraph:get",serverUrl:t,id:r},async()=>{let i=Nx(e.chunkManager,t,r),{entityType:a}=(await i.get()).credentials;if(a!="graph")throw new Error(`Unsupported entity type: ${JSON.stringify(a)}`);let{datasource_url:o}=await Bx(e.chunkManager,t,r,"/graph/config",{method:"POST"}),l=await e.registry.get({...e,url:o}),c=new xM(e.chunkManager,t,r),d=[...l.subsources,{id:"graph",default:!0,subsource:{segmentationGraph:c}}];return{modelTransform:l.modelTransform,subsources:d}})}async completeUrl(e){let{serverUrl:t,id:r}=CM(e.providerUrl),i=await e.chunkManager.memoize.getUncounted({type:"nggraph:list",serverUrl:t},async()=>Sj(await vj(e.chunkManager,t,"/list",{method:"POST"})));return{offset:t.length+1,completions:rn(r,i,a=>a.id,a=>`${a.entityType} (${a.accessRole})`)}}};At("nggraph",()=>new Ux);var xp=1,kM;(function(r){r[r.RAW=0]="RAW",r[r.JPEG=1]="JPEG",r[r.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(kM||(kM={}));var LM=class{};LM.RPC_ID="graphene/VolumeChunkSource";var cg=class{};cg.RPC_ID="graphene/ChunkedGraphSource";var ug=class{};ug.RPC_ID="graphene/MeshSource";var EM=async n=>n;function PM(n,e){let t=X.rshift(new X,n,64-e);return X.equal(t,X.ONE)}function DM(n){if(n.charAt(0)==="~"){let t=n.substring(1).split(/:(.+)/);return{key:t[0],fragmentId:t[1]}}else return{key:n,fragmentId:n}}var AM="ChunkedGraphLayer",IM="ChunkedGraphLayer:updateSources";function MM(n){let{rank:e,dataType:t}=n,{baseVoxelOffset:r=new Float32Array(e)}=n;return{...di(n),baseVoxelOffset:r,dataType:t}}function jc(n){try{return n()}catch(e){return{error:e.message}}}function dg(n){if(n.error!==void 0)throw new Error(n.error);return n}var RM=class extends Qe(rt()(kr),ug){getFragmentKey(e,t){return DM(t)}},_M=class{constructor(e,t){let r=/^(https?:\/\/[.\w:\-\/]+)\/segmentation\/(?:1\.0|table)\/([^\/]+)\/?$/,i=e.match(r);if(i===null)throw Error(`Graph URL invalid: ${e}`);this.segmentationUrl=`${i[1]}/segmentation/api/v${xp}/table/${i[2]}`,this.meshingUrl=`${i[1]}/meshing/api/v${xp}/table/${i[2]}`;try{Q(t),this.supported_api_versions=G(t,"supported_api_versions",a=>ye(a,rh))}catch(a){this.supported_api_versions=[0]}if(!(xp in this.supported_api_versions)){let a=`This Neuroglancer branch requires Graph Server version ${xp}, but the server only supports version(s) ${this.supported_api_versions}.`;throw new Error(a)}}},bj=8,VM=class{constructor(e){Q(e),this.chunkSize=G(e,"chunk_size",t=>He(J.create(),t,wt)),this.nBitsForLayerId=le(e,"n_bits_for_layer_id",wt,bj)}};function xj(n,e,t){let r=yx(n),i=G(n,"data_dir",l=>wn(l,t)).url,a=G(n,"app",l=>new _M(e,l)),o=G(n,"graph",l=>new VM(l));return{...r,app:a,graph:o,dataUrl:i}}var OM=class extends Zm{constructor(e,t,r){super(e,void 0,r.dataUrl,r);this.chunkedGraphCredentialsProvider=t;this.info=r}getChunkedGraphSource(){let{rank:e}=this,t=this.info.scales[0],r=MM({rank:e,dataType:this.info.dataType,upperVoxelBound:t.size,chunkDataSize:Uint32Array.from(this.info.graph.chunkSize),baseVoxelOffset:t.voxelOffset}),i=e+1,a=new Float32Array(i*i);a[a.length-1]=1;let{lowerBounds:o,upperBounds:l}=this.info.modelSpace.boundingBoxes[0].box,c=new Float32Array(e),d=new Float32Array(e);for(let p=0;p<3;++p){let m=1;a[i*p+p]=m,a[i*e+p]=t.voxelOffset[p],c[p]=o[p],d[p]=l[p]}return{chunkSource:this.chunkManager.getChunkSource(HM,{spec:r,credentialsProvider:this.chunkedGraphCredentialsProvider,parameters:{url:`${this.info.app.segmentationUrl}/node`}}),chunkToMultiscaleTransform:a,lowerClipBound:c,upperClipBound:d}}};function NM(n){return G(n,"transform",e=>{let t=re.create();return e!==void 0&&He(t.subarray(0,12),e,Ye),re.transpose(t,t),t})}function Cj(n){Q(n);let e=G(n,"@type",ee),t;if(e==="neuroglancer_legacy_mesh"){let i=G(n,"sharding",UM);if(i===void 0)t=void 0;else{let a=0,o=10,l=NM(n);t={lodScaleMultiplier:a,transform:l,sharding:i,vertexQuantizationBits:o}}}else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{let i=G(n,"lod_scale_multiplier",St),a=G(n,"vertex_quantization_bits",wt),o=NM(n),l=G(n,"sharding",UM);t={lodScaleMultiplier:i,transform:o,sharding:l,vertexQuantizationBits:a}}}let r=G(n,"segment_properties",Ft);return{metadata:t,segmentPropertyMap:r}}async function wj(n,e,t){let r;try{r=await Fx(n,e,t)}catch(i){if(Aa(i))return{metadata:void 0};throw i}return Cj(r)}function BM(n){return n===void 0?us.RAW:Mt(n,us)}function Tj(n){if(n===void 0)return;Q(n);let e=G(n,"@type",ee);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);let t=G(n,"hash",c=>Mt(c,Wc)),r=G(n,"preshift_bits",ot),i=G(n,"shard_bits",ot),a=G(n,"minishard_bits",ot),o=G(n,"minishard_index_encoding",BM),l=G(n,"data_encoding",BM);return{hash:t,preshiftBits:r,shardBits:i,minishardBits:a,minishardIndexEncoding:o,dataEncoding:l}}function UM(n){if(n===void 0)return;Q(n);let e=new Array;for(let t in n){let r=Number(t);e[r]=Tj(n[r])}return e}function kj(n,e,t){return n.getChunkSource(RM,{parameters:e,credentialsProvider:t})}async function Lj(n,e,t,r,i){let{metadata:a,segmentPropertyMap:o}=await wj(n,void 0,r),l={manifestUrl:t,fragmentUrl:r,lod:0,sharding:a==null?void 0:a.sharding,nBitsForLayerId:i},c=(a==null?void 0:a.transform)||re.create();return{source:kj(n,l,e),transform:c,segmentPropertyMap:o}}function Fx(n,e,t){return n.memoize.getUncounted({type:"graphene:metadata",url:t,credentialsProvider:ct(e)},async()=>await cr(e,`${t}/info`,{},ut))}function Ej(n){let e=re.create(),t=n.scales[0].resolution;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}async function Pj(n,e,t,r){let i=xj(r,t,n.credentialsManager),a=new OM(n.chunkManager,e,i),o=new WM(i,e,a),{modelSpace:l}=i,c=[{id:"default",default:!0,subsource:{volume:a}},{id:"graph",default:!0,subsource:{segmentationGraph:o}},{id:"bounds",default:!0,subsource:{staticAnnotations:In(l.bounds)}}];if(i.segmentPropertyMap!==void 0){let d=Na(t,i.segmentPropertyMap),p=await Fx(n.chunkManager,e,d),m=Hc(n.chunkManager,e,p,d);c.push({id:"properties",default:!0,subsource:{segmentPropertyMap:m}})}if(i.mesh!==void 0){let{source:d,transform:p}=await Lj(n.chunkManager,e,i.app.meshingUrl,Na(i.dataUrl,i.mesh),i.graph.nBitsForLayerId),m=Ej(i);re.multiply(m,m,p),c.push({id:"mesh",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:m})}return{modelTransform:mt(l),subsources:c}}var Gx=class extends vp{get description(){return"Graphene file-backed data source"}get(e){let{url:t,parameters:r}=yp(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"graphene:get",providerUrl:t,parameters:r},async()=>{let{url:i,credentialsProvider:a}=wn(t,e.credentialsManager),o;try{o=await Fx(e.chunkManager,a,i)}catch(d){throw Aa(d)&&r.type==="mesh"&&console.log("does this happen?"),d}Q(o);let l=le(o,"redirect",ee);if(l!==void 0)throw new Pc(l);let c=le(o,"@type",ee);switch(c){case"neuroglancer_multiscale_volume":case void 0:return await Pj(e,a,i,o);default:throw new Error(`Invalid type: ${JSON.stringify(c)}`)}})}},FM=class extends el{constructor(e,t,r,i){super(e,t);this.graph=e;this.transform=r;this.chunkSource=i;this.lastDeselectionMessageExists=!1;t.visibleSegments.changed.add((a,o)=>{a!==null&&(a=Array().concat(a)),this.visibleSegmentsChanged(a,o)})}createRenderLayers(e,t,r){return[new $M(e,this.chunkSource.getChunkedGraphSource(),t,r,this.graph.info.graph.nBitsForLayerId)]}visibleSegmentsChanged(e,t){let{segmentsState:r}=this;if(e===null){let i=this.segmentsState.visibleSegments.size;this.segmentsState.segmentEquivalences.clear(),Ce.showTemporaryMessage(`Deselected all ${i} segments.`,3e3);return}for(let i of e){let a=PM(i,this.graph.info.graph.nBitsForLayerId),o=i.clone();if(t)a&&this.graph.getRoot(o).then(l=>{o===l&&console.error("when does this happen?"),r.visibleSegments.delete(o),r.visibleSegments.add(l)});else if(!a){let l=[...r.segmentEquivalences.setElements(i)].length;r.segmentEquivalences.deleteSet(i),this.lastDeselectionMessage&&this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1),this.lastDeselectionMessage=Ce.showMessage(`Deselected ${l} segments.`),this.lastDeselectionMessageExists=!0,setTimeout(()=>{this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1)},2e3)}}}computeSplit(e,t){}};async function Dj(n,e){let t=new Ce(!0);t.setText(e.initialMessage);let r=t.dispose.bind(t);try{let i=await n;return r(),i}catch(i){if(i instanceof wr&&i.response){let a;i.response.headers.get("content-type")==="application/json"?a=(await i.response.json()).message:a=await i.response.text();let{errorPrefix:o=""}=e;throw t.setErrorMessage(o+a),t.setVisible(!0),new Error(`[${i.response.status}] ${o}${a}`)}throw i}}var GM=class{constructor(e,t){this.url=e;this.credentialsProvider=t}async getRoot(e,t=""){let r=new Date(t).valueOf()/1e3,i=`${this.url}/node/${String(e)}/root?int64_as_str=1${Number.isNaN(r)?"":`&timestamp=${r}`}`,a=cr(this.credentialsProvider,i,{},EM),l=await(await Dj(a,{initialMessage:`Retrieving root for segment ${e}`,errorPrefix:"Could not fetch root: "})).json();return X.parseString(l.root_id)}},WM=class extends Zs{constructor(e,t,r){super();this.info=e;this.chunkSource=r;this.connections=new Set;this.graphServer=new GM(e.app.segmentationUrl,t)}connect(e,t){let r=new FM(this,e,t,this.chunkSource);return this.connections.add(r),r.registerDisposer(()=>{this.connections.delete(r)}),r}get visibleSegmentEquivalencePolicy(){return qt.MAX_REPRESENTATIVE|qt.NONREPRESENTATIVE_EXCLUDED}getRoot(e){return this.graphServer.getRoot(e)}async merge(e,t){return new X}async split(e,t){return{include:e,exclude:t}}trackSegment(e,t){return()=>{console.log("trackSegment... do nothing",e,t)}}},zM=class extends rl{constructor(e,t){super(e,t)}},HM=class extends Qe(rt()(zM),cg){},$M=class extends pi{constructor(e,t,r,i,a){super();this.chunkManager=e;this.source=t;this.displayState=r;this.localPosition=i;this.layerChunkProgressInfo=new fo;this.leafRequestsActive=this.registerDisposer(gt.make(e.rpc,!0)),this.chunkTransform=this.registerDisposer(Pn(l=>jc(()=>Sc(dg(l))),this.displayState.transform));let o=this.sharedObject=this.backend=this.registerDisposer(new ss(e,r,this.layerChunkProgressInfo));o.RPC_TYPE_ID=AM,o.initializeCounterpartWithChunkManager({source:t.chunkSource.addCounterpartRef(),localPosition:this.registerDisposer(gt.makeFromExisting(e.rpc,this.localPosition)).rpcId,leafRequestsActive:this.leafRequestsActive.rpcId,nBitsForLayerId:this.registerDisposer(gt.make(e.rpc,a)).rpcId}),this.registerDisposer(o.visibility.add(this.visibility)),this.registerDisposer(this.leafRequestsActive.changed.add(()=>{this.showOrHideMessage(this.leafRequestsActive.value)}))}attach(e){super.attach(e);let t=this.chunkTransform.value,r=e.view.displayDimensionRenderInfo.value;e.state={chunkTransform:t,displayDimensionRenderInfo:r},e.state.source=e.registerDisposer(Dn((i,a,o)=>{let l=al(o,a,c=>[[this.source]],e.messages,this);return e.view.flushBackendProjectionParameters(),this.sharedObject.rpc.invoke(IM,{layer:this.sharedObject.rpcId,view:e.view.rpcId,displayDimensionRenderInfo:o,sources:nl(l)}),l[0][0]},this.displayState.transform,e.view.displayDimensionRenderInfo))}isReady(){return!0}showOrHideMessage(e){this.leafRequestsStatusMessage&&e?(this.leafRequestsStatusMessage.dispose(),this.leafRequestsStatusMessage=void 0,Ce.showTemporaryMessage("Loading chunked graph segmentation...",3e3)):!this.leafRequestsStatusMessage&&!e&&(this.leafRequestsStatusMessage=Ce.showMessage("At this zoom level, chunked graph segmentation will not be loaded. Please zoom in if you wish to load it."))}};At("graphene",()=>new Gx);var Gg=at(It()),tV=at(Cp());function _j(n){return typeof n=="boolean"?{enabled:n}:(Q(n),{enabled:le(n,"enabled",Ii)})}function bl(n,e=void 0){return typeof n=="string"?{url:n,transform:e,enableDefaultSubsources:!0,subsources:new Map}:(Q(n),{url:G(n,"url",ee),transform:G(n,"transform",uS)||e,enableDefaultSubsources:le(n,"enableDefaultSubsources",Ii,!0),subsources:le(n,"subsources",t=>eo(t,_j),new Map)})}function Vj(n){return n.enabled}function qM(n){let e=dS(n.transform),t={},r=!0;for(let[i,a]of n.subsources){let o=Vj(a);o!==void 0&&(t[i]=o,r=!1)}return e===void 0&&r&&n.enableDefaultSubsources===!0?n.url:{url:n.url,transform:e,subsources:r?void 0:t,enableDefaultSubsources:n.enableDefaultSubsources===!0?void 0:!1}}var JM=class{constructor(e,t,r,i,a){this.loadedDataSource=e;this.subsourceEntry=t;this.subsourceSpec=r;this.subsourceIndex=i;this.activated=void 0;this.guardValues=[];this.messages=new Gi;this.isActiveChanged=new ae;let o;r===void 0||r.enabled===void 0?o=t.default&&a:o=r.enabled;let l=e.dataSource.modelTransform.sourceRank,{modelSubspaceDimensionIndices:c}=t;if(c===void 0){c=new Array(l);for(let p=0;p<l;++p)c[p]=p}let{subsourceToModelSubspaceTransform:d=rr(Float32Array,c.length+1)}=t;this.enabled=o,this.subsourceToModelSubspaceTransform=d,this.modelSubspaceDimensionIndices=c,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),this.activated!==void 0){if(we(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t;let r=this.activated=new j;e(r),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:Cr.error,message:e});let{activated:t}=this;t!==void 0&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){let t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){let t=this.activated,{layer:r,transform:i}=this.loadedDataSource;return t.registerDisposer(Ah(r.manager.root.coordinateSpace,r.localPosition.coordinateSpace,i,this,e))}},qc=class extends j{constructor(e,t,r){super();this.layerDataSource=e;this.dataSource=t;this.error=void 0;this.enabledSubsourcesChanged=new ae;this.activatedSubsourcesChanged=new ae;this.messages=new Gi;t.canChangeModelSpaceRank?(this.transform=new Lh(mt(Ne({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new Lh(t.modelTransform),r.transform!==void 0&&(this.transform.spec=r.transform);let i=r.subsources;this.enableDefaultSubsources=r.enableDefaultSubsources,this.subsources=t.subsources.map((a,o)=>new JM(this,a,i.get(a.id),o,this.enableDefaultSubsources))}get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}disposed(){for(let e of this.subsources){let{activated:t}=e;t!==void 0&&(e.activated=void 0,t.dispose())}}},Wx=class extends j{constructor(e,t=void 0){super();this.layer=e;this.changed=new ae;this.messages=new Gi;this.loadState_=void 0;this.specGeneration=-1;this.refCounted_=void 0;this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),t===void 0?this.spec_=Yh():this.spec=t}get spec(){let{loadState:e}=this;if(e!==void 0&&e.error===void 0){let t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,r=>{let i=e.enableDefaultSubsources&&r.subsourceEntry.default;return[r.subsourceEntry.id,{enabled:r.enabled!==i?r.enabled:void 0}]}))})}return this.spec_}get loadState(){return this.loadState_}set spec(e){let{layer:t}=this;if(this.messages.clearMessages(),e.url.length===0){if(t.dataSources.length!==1){let c=t.dataSources.indexOf(this);if(c!==-1){t.dataSources.splice(c,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}let r=new j,i=r.registerDisposer(Bf(t.markLoading()));this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=r,this.spec_=e;let a=t.manager.chunkManager,o=t.manager.dataSourceProviderRegistry,l=new $n;this.messages.addMessage({severity:Cr.info,message:"Loading data source"}),o.get({chunkManager:a,url:e.url,cancellationToken:l,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform}).then(c=>{if(r.wasDisposed)return;this.messages.clearMessages();let d=r.registerDisposer(new qc(this,c,e));d.registerDisposer(t.addCoordinateSpace(d.transform.outputSpace)),d.registerDisposer(d.transform.changed.add(this.changed.dispatch)),this.loadState_=d,d.registerDisposer(d.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),i()}).catch(c=>{this.wasDisposed||(this.loadState_={error:c},this.messages.clearMessages(),this.messages.addMessage({severity:Cr.error,message:c.message}),this.changed.dispatch())}),r.registerDisposer(()=>{l.cancel()}),this.changed.dispatch()}disposed(){let e=this.refCounted_;e!==void 0&&e.dispose()}toJSON(){let{loadState:e}=this;return e===void 0||e.error!==void 0?qM(this.spec):qM({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{let r=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==r?t.enabled:void 0}]}))})}};var Wt;(function(r){r[r.LINKED=0]="LINKED",r[r.RELATIVE=1]="RELATIVE",r[r.UNLINKED=2]="UNLINKED"})(Wt||(Wt={}));var pg;(function(t){t[t.LINKED=0]="LINKED",t[t.UNLINKED=2]="UNLINKED"})(pg||(pg={}));var KM=class extends cs{constructor(e=0){super(Wt,e)}},YM=class extends cs{constructor(e=0){super(pg,e)}},fg=J.create(),XM=qe.create();function wp(n,e,t,r){let i=!1,a=!1,o;n.registerDisposer(e);let l=()=>{if(!a){switch(i=!0,t.value){case 2:if(r.isValid(n))break;case 0:r.assign(n,e);break;case 1:r.add(n,e,o);break}i=!1}},c=()=>{if(!i)switch(t.value){case 2:break;case 0:r.assign(e,n);break;case 1:r.subtract(e,n,o);break}},d=2,p=()=>{let m=t.value;if(m!==d)switch(m){case 2:o=void 0;break;case 0:o=void 0,r.assign(n,e);break;case 1:o=r.difference(n,e);break}d=m,n.changed.dispatch()};return n.registerDisposer(n.changed.add(c)),n.registerDisposer(e.changed.add(l)),n.registerDisposer(t.changed.add(p)),p(),n}function QM(n,e,t,r){return wp(n,e,t,r)}var Ji=class extends j{constructor(e){super();this.coordinateSpace=e;this.coordinates_=io;this.changed=new ae;this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=io,this.changed.dispatch()}set value(e){let{curCoordinateSpace:t}=this;if(t===void 0||!t.valid||t.rank!==e.length)return;let{coordinates_:r}=this;r.set(e),this.changed.dispatch()}handleCoordinateSpaceChanged(){let e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;let{rank:r}=e;if(!e.valid)return;if(t===void 0||!t.valid){let{coordinates_:p}=this;if(!(p!==void 0&&p.length===r)){p=this.coordinates_=new Float32Array(r),FE(p,e.bounds);for(let m=0;m<r;++m)p[m]=Math.floor(p[m])+.5}this.changed.dispatch();return}let i=new Float32Array(r),a=this.coordinates_,{ids:o,scales:l}=e,{ids:c,scales:d}=t;for(let p=0;p<r;++p){let m=o[p],y=c.indexOf(m);y===-1?i[p]=rS(e.bounds.lowerBounds[p],e.bounds.upperBounds[p]):i[p]=a[y]*(d[y]/l[p])}this.coordinates_=i,this.changed.dispatch()}toJSON(){if(!this.valid&&this.coordinates_.length===0)return;this.handleCoordinateSpaceChanged();let{value:e}=this;if(e.length!==0)return Array.from(e)}restoreState(e){if(e===void 0){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from(ye(e,Ye)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();let{coordinates_:e}=this,t=e.length;for(let r=0;r<t;++r)e[r]=Math.floor(e[r])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();let{curCoordinateSpace:t,coordinates_:r}=e;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(r),this.changed.dispatch()}static getOffset(e,t){let r=e.coordinates_,i=t.coordinates_;if(r.length===i.length)return Sh(new Float32Array(r.length),r,i)}static addOffset(e,t,r,i=1){e.handleCoordinateSpaceChanged();let{value:a}=t;r!==void 0&&a.length===r.length&&(ME(e.value,a,r,i),e.changed.dispatch())}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){e.reset()},restoreState(t){if(t===void 0||Array.isArray(t)){e.restoreState(t);return}Q(t),an(t,"voxelCoordinates",e)}}}};function ZM(n,e,t){if(t===void 0||Object.keys(t).length===0){n.value=0;return}Q(t),n.value=2,G(t,"value",r=>{r!==void 0&&e.restoreState(r)}),G(t,"link",r=>n.restoreState(r))}var Jc=class{constructor(e,t=new KM){this.peer=e;this.link=t}get changed(){return this.value.changed}toJSON(){let{link:e}=this;if(e.value!==0)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=0}restoreState(e){ZM(this.link,this.value,e)}copyToPeer(){this.link.value!==0&&(this.link.value=2,this.peer.assign(this.value),this.link.value=0)}},zx=class extends Jc{constructor(e,t=new YM){super(e,t)}},Tp=class extends Jc{constructor(){super(...arguments);this.value=wp(new Ji(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:Ji.getOffset,add:Ji.addOffset,subtract:(e,t,r)=>{Ji.addOffset(e,t,r,-1)}})}};function Oj(n){return n[0]===0&&n[1]===0&&n[2]===0&&n[3]===1}var bo=class extends j{constructor(e){super();this.changed=new ae;e==null&&(e=qe.create()),this.orientation=e}toJSON(){let{orientation:e}=this;if(qe.normalize(this.orientation,this.orientation),!Oj(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{Wo(this.orientation,e),qe.normalize(this.orientation,this.orientation)}catch(t){qe.identity(this.orientation)}this.changed.dispatch()}reset(){qe.identity(this.orientation),this.changed.dispatch()}snap(){let e=Et.create();Et.fromQuat(e,this.orientation);let t=[!1,!1,!1];for(let r=0;r<3;++r){let i=0,a=0;for(let o=0;o<3;++o){let l=e[r*3+o];e[r*3+o]=0,!t[o]&&Math.abs(l)>Math.abs(i)&&(i=l,a=o)}e[r*3+a]=Math.sign(i),t[a]=!0}qe.fromMat3(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let r=new bo(qe.multiply(qe.create(),e.orientation,t)),i=!1;r.registerDisposer(e.changed.add(()=>{i||(a=!0,qe.multiply(r.orientation,e.orientation,t),r.changed.dispatch(),a=!1)}));let a=!1,o=qe.invert(qe.create(),t);return r.registerDisposer(r.changed.add(()=>{a||(i=!0,qe.multiply(e.orientation,r.orientation,o),e.changed.dispatch(),i=!1)})),r}assign(e){qe.copy(this.orientation,e.orientation),this.changed.dispatch()}},Kc=class extends Jc{constructor(){super(...arguments);this.value=wp(new bo,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{let r=qe.create();return qe.multiply(r,qe.invert(r,t.orientation),e.orientation)},add:(e,t,r)=>{qe.multiply(e.orientation,t.orientation,r),e.changed.dispatch()},subtract:(e,t,r)=>{qe.multiply(e.orientation,t.orientation,qe.invert(XM,r)),e.changed.dispatch()}})}},hg=class extends j{constructor(e){super();this.coordinateSpace=e;this.changed=new ae;this.curCoordinateSpace=Qr;this.value_={factors:new Float64Array(0)};this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=Qr,this.changed.dispatch()}toJSON(){let e={},t=!1,{value:r}=this,{factors:i}=r,{names:a,rank:o}=this.curCoordinateSpace;for(let l=0;l<o;++l){let c=i[l];c!==1&&(e[a[l]]=c,t=!0)}if(t)return e}restoreState(e){let{coordinateSpace:{value:t}}=this,{names:r,rank:i}=t,a=new Float64Array(i);if(a.fill(-1),e!==void 0){let o=Q(e);for(let l=0;l<i;++l)a[l]=G(o,r[l],c=>c===void 0?1:St(c))}this.value_={factors:a},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){let{coordinateSpace:{value:t}}=this;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){let{coordinateSpace:{value:e}}=this,t=this.value_,{curCoordinateSpace:r}=this;if(r===e)return t;let{ids:i}=r,{ids:a,rank:o}=e,l=t.factors,c=new Float64Array(o);c.fill(1);for(let d=0;d<o;++d){let p=a[d],m=i.indexOf(p);m!==-1&&(c[d]=l[m])}return we(c,l)||(t=this.value_={factors:c},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}};function eR(n,e,t,r,i){if(t===r)return e;let{ids:a}=t,{rank:o,ids:l}=r,c=new n(o);for(let d=0;d<o;++d){let p=l[d],m=a.indexOf(p);c[d]=m===-1?i(d):e[m]}return c}var Hx=class extends Jc{constructor(){super(...arguments);this.value=wp(new hg(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{let{factors:r}=e.value,i=e.coordinateSpace.value,a=t.value.factors;return{coordinateSpace:i,offsets:Sh(new Float64Array(r.length),r,a)}},add:(e,t,r)=>{let i=eR(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(vh(new Float64Array(i.length),i,t.value.factors))},subtract:(e,t,r)=>{let i=eR(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Sh(new Float64Array(i.length),t.value.factors,i))},isValid:()=>!0})}};function tR(n,e,t){let{rank:r,names:i,units:a}=n,{displayRank:o,displayDimensionIndices:l}=e,c=new Float64Array(3),d=new Float64Array(3),p,{factors:m}=t,y=new Array(3),v=new Float64Array(3);if(c.fill(1),d.fill(1),v.fill(1),y.fill(""),o===0)p=1;else{p=Number.POSITIVE_INFINITY;let{scales:b}=n;for(let x=0;x<o;++x){let C=l[x],k=d[x]=m[C]*b[C];p=Math.min(p,k),y[x]=a[C],v[x]=b[C]}for(let x=0;x<o;++x)c[x]=d[x]/p}return{globalRank:r,globalDimensionNames:i,displayRank:o,displayDimensionIndices:l,displayDimensionUnits:y,displayDimensionScales:v,canonicalVoxelFactors:c,voxelPhysicalScales:d,canonicalVoxelPhysicalSize:p}}function Nj(n,e){return we(n.globalDimensionNames,e.globalDimensionNames)&&we(n.displayDimensionIndices,e.displayDimensionIndices)&&we(n.canonicalVoxelFactors,e.canonicalVoxelFactors)&&we(n.voxelPhysicalScales,e.voxelPhysicalScales)&&n.canonicalVoxelPhysicalSize===e.canonicalVoxelPhysicalSize&&we(n.displayDimensionUnits,e.displayDimensionUnits)&&we(n.displayDimensionScales,e.displayDimensionScales)}var kp=class extends j{constructor(e,t){super();this.relativeDisplayScales=e;this.displayDimensions=t;this.changed=new ae;this.curRelativeDisplayScales=this.relativeDisplayScales.value;this.curDisplayDimensions=this.displayDimensions.value;this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value;this.value_=tR(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales);this.registerDisposer(e),this.registerDisposer(t);let r=()=>{this.value};this.registerDisposer(e.changed.add(r)),this.registerDisposer(t.changed.add(r))}get value(){let{relativeDisplayScales:{value:e,coordinateSpace:{value:t}},displayDimensions:{value:r},curRelativeDisplayScales:i,curDisplayDimensions:a,curCoordinateSpace:o}=this,l=this.value_;if(i!==e||a!==r||o!==t){this.curRelativeDisplayScales=e,this.curDisplayDimensions=r,this.curCoordinateSpace=t;let c=tR(t,r,e);Nj(l,c)||(this.value_=l=c,this.changed.dispatch())}return l}},mg=class extends j{constructor(e){super();this.coordinateSpace=e;this.changed=new ae;this.default_=!0;this.value_=void 0;this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){let{coordinateSpace:{value:e}}=this,t=this.value_;if(t!==void 0&&t.coordinateSpace===e)return;if(t===void 0||this.default_){this.setToDefault(e);return}let r=new Int32Array(3),{ids:i}=t.coordinateSpace,{ids:a}=e,o=t.displayDimensionIndices,l=t.displayRank,c=0;for(let d=0;d<l;++d){let p=a.indexOf(i[o[d]]);p!==-1&&(r[c]=p,++c)}if(r.fill(-1,c),c===0){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,c,r),this.changed.dispatch()}setToDefault(e){let t=Math.min(e.rank,3),r=new Int32Array(3);r.fill(-1);for(let i=0;i<t;++i)r[i]=i;this.assignValue(e,t,r)}assignValue(e,t,r){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:r},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(e===void 0){this.reset();return}let t=Td(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");let{coordinateSpace:{value:r}}=this,i=new Int32Array(3);i.fill(-1);let{names:a}=r,o=0;for(let l of t){let c=a.indexOf(l);c!==-1&&(i[o++]=c)}if(o===0){this.reset();return}this.default_=!1,this.assignValue(r,o,i)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;let{value:e}=this,t=[],{displayRank:r,displayDimensionIndices:i,coordinateSpace:{names:a}}=e;if(r!==0){for(let o=0;o<r;++o)t[o]=a[i[o]];return t}}assign(e){if(e.default)this.default=!0;else{let{displayRank:t,displayDimensionIndices:r}=e.value;this.setDimensionIndices(t,r)}}},$x=class extends zx{constructor(e){super(e);this.value=QM(new mg(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0})}},Ba=class extends j{constructor(e,t,r){super();this.position=e;this.displayDimensionRenderInfo=t;this.orientation=r;this.changed=new ae;this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(r.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=fg){let{coordinateSpace:{value:r},value:i}=this.position,{displayDimensionIndices:a,displayRank:o}=this.displayDimensions.value;if(r===void 0)return!1;t.fill(0);for(let l=0;l<o;++l){let c=a[l];t[l]=i[c]}if(e(t)!==!1){for(let l=0;l<o;++l){let c=a[l];i[c]=t[l]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){re.fromQuat(e,this.orientation.orientation);let{value:r}=this.position,{canonicalVoxelFactors:i,displayDimensionIndices:a}=this.displayDimensionRenderInfo.value;for(let o=0;o<3;++o){let l=a[o],c=t/i[o];e[o]*=c,e[4+o]*=c,e[8+o]*=c,e[12+o]=r[l]||0}}toMat3(e,t){Et.fromQuat(e,this.orientation.orientation);let{canonicalVoxelFactors:r,displayRank:i}=this.displayDimensionRenderInfo.value;for(let a=0;a<i;++a){let o=t/r[a];e[a]*=o,e[3+a]*=o,e[6+a]*=o}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;let{position:r}=this,{value:i}=r,{bounds:{lowerBounds:a,upperBounds:o}}=r.coordinateSpace.value,l=i[e]+t;if(t>0){let c=o[e];Number.isFinite(c)&&(l=Math.min(l,Math.ceil(c-1)))}else{let c=a[e];Number.isFinite(c)&&(l=Math.max(l,Math.floor(c)))}i[e]=l,r.changed.dispatch()}translateVoxelsRelative(e,t=!1){if(!this.valid)return;let r=J.transformQuat(fg,e,this.orientation.orientation),{position:i}=this,{value:a}=i,{displayDimensionIndices:o,displayRank:l}=this.displayDimensions.value,{bounds:{lowerBounds:c,upperBounds:d}}=i.coordinateSpace.value;for(let p=0;p<l;++p){let m=o[p],y=r[p];if(y===0)continue;let v=a[m]+y;if(y>0){let b=d[m];Number.isFinite(b)&&(v=Math.min(v,Math.ceil(b-1)))}else{let b=c[m];Number.isFinite(b)&&(v=Math.max(v,Math.floor(b)))}t&&(v=Math.floor(v)+.5),a[m]=v}this.position.changed.dispatch()}rotateRelative(e,t){var r=qe.create();qe.setAxisAngle(r,e,t);var i=this.orientation.orientation;qe.multiply(i,i,r),this.orientation.changed.dispatch()}rotateAbsolute(e,t,r){let{coordinateSpace:{value:i},value:a}=this.position;if(i===void 0)return;let{relativeDisplayScales:{value:{factors:o}},displayDimensions:{value:{displayDimensionIndices:l,displayRank:c}}}=this,{scales:d}=i,p=qe.create();qe.setAxisAngle(p,e,t);let m=this.orientation.orientation,y=fg;fg.fill(0);for(let b=0;b<c;++b){let x=l[b],C=r[x]-a[x];y[b]=C*d[x]*o[x]}let v=qe.invert(XM,m);J.transformQuat(y,y,v),qe.multiply(m,p,m),J.transformQuat(y,y,m);for(let b=0;b<c;++b){let x=l[b];a[x]=r[x]-y[b]/(d[x]*o[x])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;let{displayDimensionIndices:r}=this.displayDimensions.value,{position:i}=this,a=i.coordinateSpace.value.rank;for(let o=0;o<a;++o)if(r.indexOf(o)===-1&&e--==0){this.translateDimensionRelative(o,t);return}}},Yc=class extends Jc{constructor(e,t){super(e);this.value=(()=>{let r=new e.constructor(t),i=(d,p)=>{d.assign(p)},a=(d,p)=>d.value/p.value*(d.canonicalVoxelPhysicalSize/p.canonicalVoxelPhysicalSize),o=(d,p,m)=>{d.setPhysicalScale(p.value*m,p.canonicalVoxelPhysicalSize)},l=(d,p,m)=>{d.setPhysicalScale(p.value/m,p.canonicalVoxelPhysicalSize)},c=d=>d.coordinateSpaceValue.valid&&d.canonicalVoxelPhysicalSize!==0;return wp(r,this.peer,this.link,{assign:i,isValid:c,difference:a,add:o,subtract:l}),r})()}};function xl(n){return{changed:n.changed,toJSON(){return n.toJSON()},restoreState(e){ZM(n.link,n.value.legacyJsonView,e)},reset(){n.reset()}}}var jx=class extends j{constructor(e){super();this.displayDimensionRenderInfo=e;this.changed=new ae;this.curCanonicalVoxelPhysicalSize=0;this.value_=Number.NaN;this.legacyValue_=Number.NaN;this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){let{canonicalVoxelPhysicalSize:t}=this;Object.is(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Object.is(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){let{value_:e}=this,{displayDimensionRenderInfo:{value:{canonicalVoxelPhysicalSize:t},relativeDisplayScales:{coordinateSpace:{value:r}}}}=this,{curCanonicalVoxelPhysicalSize:i}=this;if(!(!Number.isNaN(e)&&t===i)){if(!Number.isNaN(e)){i!==0&&(this.value_=e*(i/t),this.curCanonicalVoxelPhysicalSize=t,this.changed.dispatch());return}!r.valid||t===0||(this.curCanonicalVoxelPhysicalSize=t,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){let{value:e}=this;return Number.isNaN(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,e===void 0?this.value_=Number.NaN:this.value_=St(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){return e.reset()},restoreState(t){e.legacyValue=St(t)}}}setPhysicalScale(e,t){let r=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/r)}assign(e){let{legacyValue:t}=e;Number.isNaN(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}},qx=class extends jx{getDefaultValue(){let{legacyValue_:e}=this;if(Number.isNaN(e))return 1;let{canonicalVoxelPhysicalSize:t}=this;return this.legacyValue_*1e-9/t}},Jx=class extends jx{getDefaultValue(){let{legacyValue_:e}=this;if(!Number.isNaN(e)){this.legacyValue_=Number.NaN;let{canonicalVoxelPhysicalSize:l}=this;return 2*100*Math.tan(Math.PI/8)*1e-9*e/l}let{coordinateSpaceValue:{bounds:{lowerBounds:t,upperBounds:r}}}=this,{canonicalVoxelFactors:i,displayDimensionIndices:a}=this.displayDimensionRenderInfo.value,o=i.reduce((l,c,d)=>{let p=a[d],m=(r[p]-t[p])*c;return Math.max(l,m)},0);return Number.isFinite(o)?o=2**Math.ceil(Math.log2(o)):o=1024,o}},Lp=class extends j{constructor(e,t){super();this.defaultValue=e;this.displayDimensionRenderInfo=t;this.changed=new ae;this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}get value(){let{value_:e}=this;if(e>0){let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value,r=this.canonicalVoxelPhysicalSize;t!==r&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=r/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){let{value:e}=this;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){typeof e!="number"||!Number.isFinite(e)||e===0?this.value=this.defaultValue:this.value=e}setValueAbsolute(e,t){if(e>0){let{canonicalVoxelPhysicalSize:r}=this.displayDimensionRenderInfo.value;e=e*(t/r)}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}},gg=class extends zx{constructor(e,t){super(e);this.value=QM(new Lp(e.defaultValue,t),this.peer,this.link,{assign:(r,i)=>r.assign(i),isValid:()=>!0})}},Ua=class extends j{constructor(e,t,r){super();this.pose=e;this.zoomFactor=t;this.depthRange=r;this.changed=new ae;this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(r),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Number.isNaN(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}};var Cl='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="plusIconTitle"><path d="M20 12L4 12M12 4L12 20"></path></svg>';function yg(n={}){return $e({svg:Cl,...n})}var nR='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowUpIconTitle"><path d="M18 9l-6-6-6 6"></path><path d="M12 21V4"></path><path stroke-linecap="round" d="M12 3v1"></path></svg>';var Ep=new Re(0);window.addEventListener("keydown",n=>{Ep.value=pm(n)});window.addEventListener("keyup",n=>{Ep.value=pm(n)});var Bj=new Set(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),Uj=new Set(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]),zt=class extends j{constructor(e,t){super();this.target=e;this.eventMap=t;this.modifierShortcutsAreGlobal=!0;this.allShortcutsAreGlobal=!1;this.allowSpaceKeyOnButtons=!1;this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){var r=t.target;let{tagName:i}=r;if(r===this.target)return!1;var a=i==="TEXTAREA"||i==="INPUT"||i==="BUTTON"||i==="SELECT",o=!a&&(r.isContentEditable||r.ownerDocument&&r.ownerDocument.designMode==="on");return!a&&!o||this.allShortcutsAreGlobal||Bj.has(e)?!1:o||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey)?!0:i==="INPUT"&&Uj.has(r.type)?e!=="enter":i==="INPUT"||i==="BUTTON"?this.allowSpaceKeyOnButtons?!1:e==="space":!0}handleKeyDown(e){let t=Fj(e);this.shouldIgnoreEvent(t,e)||hm(t,e,e,this.eventMap)}};function Fj(n){return n.code.toLowerCase()}function Pp(n,e=n.value){n.style.minWidth=e.length+1+"ch"}var rR="neuroglancer-coordinate-space-transform-singleton";function iR(n,e){let t;n===Number.NEGATIVE_INFINITY?t="(-\u221E,":t=`[${Math.floor(n)},`;let r;return e===Number.POSITIVE_INFINITY?r="+\u221E)":r=`${Math.floor(e)})`,{lower:t,upper:r}}var aR=Oe.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function oR(){let n=document.createElement("div"),e=document.createElement("input");n.classList.add("neuroglancer-coordinate-space-transform-scale-container"),e.spellcheck=!1,e.autocomplete="off",e.size=1,e.classList.add("neuroglancer-coordinate-space-transform-scale"),n.appendChild(e);let t=document.createElement("div"),r=document.createElement("span");r.innerHTML=nR,t.appendChild(r);let i=document.createTextNode("");return t.appendChild(i),t.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),n.appendChild(t),{cellElement:n,inputElement:e,suggestionElement:t}}function sR(n,e,t,r,i){if(e===void 0||e.scale===t&&e.unit===r)n.style.display="none";else{n.style.display="";let a=_i(e.scale,e.unit,{elide1:!1});n.lastChild.textContent=a,n.title=`${i}${a}`}}function lR(){let n=document.createElement("input");return n.spellcheck=!1,n.autocomplete="off",n.size=1,n.placeholder=" ",n.classList.add("neuroglancer-coordinate-space-transform-output-name"),n}function cR(n,e,t){let r=n.map(y=>jo(y.value));if(r.includes(void 0))return!1;let i=Float64Array.from(r,y=>y.scale),a=Array.from(r,y=>y.unit),o=t.value,{scales:l,units:c,rank:d}=o;for(let y=0;y<d;++y)e[y]||(i[y]=l[y],a[y]=c[y]);if(we(l,i)&&we(c,a))return!1;let p=o.timestamps.map((y,v)=>i[v]===l[v]&&a[v]===c[v]?y:Date.now()),m=Ne({valid:o.valid,rank:o.rank,scales:i,units:a,timestamps:p,ids:o.ids,names:o.names,boundingBoxes:o.boundingBoxes,coordinateArrays:o.coordinateArrays});return t.value=m,!0}function uR(n,e,t,r){let i=new Float64Array(n.scales),a=Array.from(n.units);if(i[e]===t&&a[e]===r)return n;let o=Array.from(n.timestamps);return i[e]=t,a[e]=r,o[e]=Date.now(),{...n,scales:i,units:a,timestamps:o}}var Kx=class extends j{constructor(e,t,r){super();this.transform=e;this.localCombiner=t;this.globalCombiner=r;this.element=document.createElement("div");this.coefficientContainer=document.createElement("div");this.translationContainer=document.createElement("div");this.outputNameContainer=document.createElement("div");this.outputScaleContainer=document.createElement("div");this.inputNameContainer=document.createElement("div");this.inputScaleContainer=document.createElement("div");this.inputLowerBoundsContainer=document.createElement("div");this.inputUpperBoundsContainer=document.createElement("div");this.coefficientElements=[];this.inputNameElements=[];this.outputNameElements=[];this.outputScaleElements=[];this.outputScaleSuggestionElements=[];this.inputScaleSuggestionElements=[];this.inputScaleElements=[];this.inputBoundsElements=[];this.outputBoundsElements=[];this.addSourceDimensionIcon=$e({svg:Cl,text:"S"});this.addOutputDimensionIcon=$e({svg:Cl,text:"V"});this.addOutputDimensionCell=document.createElement("div");this.addOutputDimensionInput=lR();this.inputScaleModified=[];this.outputScaleModified=[];this.curSourceRank=-1;this.curRank=-1;this.curTransform=void 0;this.addingSourceDimension=!1;this.resetToIdentityButton=$e({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{let{transform:e}=this,t=e.value.rank;e.transform=rr(Float64Array,t+1)}});this.resetToDefaultButton=$e({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{let{transform:e}=this;if(e.mutableSourceRank)return;let{defaultTransform:t}=e,{outputSpace:r}=t,i=r.ids.map(()=>$s());e.value={...t,outputSpace:{...r,ids:i}}}});let{element:i}=this,a=this.registerDisposer(new zt(i,aR));a.allShortcutsAreGlobal=!0,i.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new xn(i,aR));let o=Ge(()=>this.updateView());this.registerDisposer(e.changed.add(o));let{coefficientContainer:l,translationContainer:c,outputNameContainer:d,inputNameContainer:p,inputScaleContainer:m,inputLowerBoundsContainer:y,inputUpperBoundsContainer:v,outputScaleContainer:b,addOutputDimensionCell:x,addOutputDimensionIcon:C,addSourceDimensionIcon:k,resetToIdentityButton:D,resetToDefaultButton:P}=this;l.style.display="contents",c.style.display="contents",d.style.display="contents",p.style.display="contents",m.style.display="contents",b.style.display="contents",y.style.display="contents",v.style.display="contents";let M=document.createElement("div");M.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),D.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),P.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),M.appendChild(D),M.appendChild(P),i.appendChild(M);for(let[B,W]of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){let V=document.createElement("div");V.classList.add(`neuroglancer-coordinate-space-transform-${B}-label`),V.classList.add("neuroglancer-coordinate-space-transform-label"),V.textContent=W,i.appendChild(V)}e.mutableSourceRank&&x.appendChild(k),x.appendChild(C),x.classList.add("neuroglancer-coordinate-space-transform-output-extend");let I="Embed in additional output dimension",E="Extend to additional source dimension";C.title=I,k.title=E,x.appendChild(this.addOutputDimensionInput),x.dataset.isActive="false",C.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=I,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),k.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=E,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),i.appendChild(l),i.appendChild(d),i.appendChild(p),i.appendChild(m),i.appendChild(b),i.appendChild(y),i.appendChild(v),l.appendChild(c),i.addEventListener("input",B=>{let{target:W}=B;if(W instanceof HTMLInputElement){Pp(W);let V=this.inputScaleElements.indexOf(W);if(V!==-1){this.inputScaleModified[V]=!0,this.updateScaleValidity(W);return}if(V=this.outputScaleElements.indexOf(W),V!==-1){this.outputScaleModified[V]=!0,this.updateScaleValidity(W);return}if(V=this.outputNameElements.indexOf(W),V!==-1){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(W)){this.updateCoefficientValidity(W);return}}});let _=(B,W,V)=>{ce(i,B,U=>{U.stopPropagation();let N=U.target;if(!(N instanceof HTMLInputElement)||V!==0&&(N.selectionStart!==N.selectionEnd||N.selectionStart!==(V===1?N.value.length:0)))return;let q=this.getElementGridPosition(N);if(q===void 0)return;let ne=this.getElementByGridPosition(q.row+W,q.col+V);ne!==null&&(ne.focus(),U.preventDefault())})};_("move-up",-1,0),_("move-down",1,0),_("move-left",0,-1),_("move-right",0,1);let O=(B,W)=>{B.addEventListener("focusout",V=>{let{relatedTarget:U}=V;U instanceof Node&&B.contains(U)||W(V)})};O(l,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),O(d,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),O(m,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),O(b,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),ce(i,"cancel",B=>{this.curTransform=void 0,this.updateView(),B.target.blur()}),ce(l,"commit",()=>{this.updateModelTransform()}),ce(d,"commit",()=>{this.updateModelOutputNames()}),ce(m,"commit",()=>{this.updateModelInputScales()}),ce(b,"commit",()=>{this.updateModelOutputScales()}),i.addEventListener("focusin",B=>{let{target:W}=B;W instanceof HTMLInputElement&&W.select()}),this.updateView()}updateWillBeDeletedAttributes(e){let{rank:t}=this.transform.value;e===void 0&&(e=new Array(t),e.fill(!1));let{coefficientElements:r,inputBoundsElements:i,inputScaleElements:a}=this;for(let o=0;o<t;++o){let l=e[o];for(let p=0;p<=t;++p){let m=r[t*p+o],y=p<t&&e[p];m.dataset.willBeDeleted=(l||y).toString()}a[o].dataset.willBeDeleted=l.toString();let{lower:c,upper:d}=i[o];c.dataset.willBeDeleted=l.toString(),d.dataset.willBeDeleted=l.toString()}}updateAddOutputDimensionCellStyle(){let{addOutputDimensionInput:e}=this;this.addOutputDimensionCell.dataset.isActive=(e.value.length!==0||document.activeElement===e).toString()}updateOutputNameValidity(){let{outputNameElements:e}=this,t=e.map(c=>c.value),{value:{sourceRank:r,rank:i},mutableSourceRank:a}=this.transform;if(e.length!==i+1)return;let o=wd(t),l=new Array(i);l.fill(!1);for(let c=0;c<=i;++c){let d=o[c];t[c].length===0&&(a||c>=r)&&(d=!0,l[c]=!0),e[c].dataset.isValid=d.toString()}this.updateWillBeDeletedAttributes(l),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){let t=jo(e.value)!==void 0;e.dataset.isValid=t.toString()}updateCoefficientValidity(e){let t=Number.isFinite(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{let t=this.outputNameElements.indexOf(e);if(t!==-1)return{row:t,col:-2}}{let t=this.inputScaleElements.indexOf(e);if(t!==-1)return{row:-1,col:t}}{let t=this.coefficientElements.indexOf(e),{rank:r}=this.transform.value;if(t!==-1)return{row:t%r,col:Math.floor(t/r)}}{let t=this.outputScaleElements.indexOf(e);if(t!==-1)return{row:t,col:-1}}}getElementByGridPosition(e,t){let{rank:r}=this.transform.value;return e===-1?t<0||t>=r?null:this.inputScaleElements[t]:t===-2?e<0||e>r?null:this.outputNameElements[e]:t===-1?e<0||e>=r?null:this.outputScaleElements[e]:e<0||e>=r||t<0||t>r?null:this.coefficientElements[t*r+e]}dimensionRefCount(e){return(qo(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return cR(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return cR(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){let e=this.outputNameElements.map(D=>D.value),{value:t,mutableSourceRank:r}=this.transform,{outputSpace:i,rank:a,sourceRank:o}=t;if(e.length!==a+1)return;let l=[],c=[],d=e[a].length!==0,p=o;for(let D=0;D<=a;++D){let P=e[D];if(P.length===0){if(D<o){if(!r)return!1;--p}continue}c.push(P),l.push(D)}if(!yc(c))return!1;let m=i.names;if(!d&&we(m,c))return!0;let y=t.inputSpace,v=t.outputSpace,b=t.transform;if(d){this.addingSourceDimension&&++p;let D=e[a],P=(qo(D)?this.localCombiner:this.globalCombiner).combined.value,M=P.names.indexOf(D),I,E;M!==-1?(I=P.units[M],E=P.scales[M]):(I="",E=1);let _=y.boundingBoxes.map(O=>oS(O,a,a+1));this.addingSourceDimension||_.push(aS(a+1,a)),y=Ne({valid:y.valid,rank:a+1,names:[...y.names,""],ids:[...y.ids,$s()],timestamps:[...y.timestamps,Date.now()],scales:Float64Array.from([...y.scales,E]),units:[...y.units,I],boundingBoxes:_,coordinateArrays:[...y.coordinateArrays,void 0]}),v=Ne({valid:i.valid,rank:a+1,names:[...i.names,D],ids:[...i.ids,$s()],timestamps:[...i.timestamps,Date.now()],scales:Float64Array.from([...i.scales,E]),units:[...i.units,I],coordinateArrays:[...i.coordinateArrays,void 0]}),b=bd(new Float64Array((a+2)**2),a+1,b,a)}b=Eh(Float64Array,b,y.rank,l,l),y=Ph(y,l),v=Ph(v,l);let x=v.ids.map((D,P)=>{let M=l[P];if(M===a)return D;let I=c[P],E=m[M];return I===E||this.dimensionRefCount(E)===1&&this.dimensionRefCount(I)===(m.includes(I)?1:0)?D:$s()}),C=v.timestamps.map((D,P)=>{let M=l[P];return M===a||c[P]===m[M]?D:Date.now()});v={...v,names:c,ids:x,timestamps:C};let k={rank:v.rank,sourceRank:p,outputSpace:v,inputSpace:y,transform:b};return this.transform.value=k,!0}updateModelTransform(){let e=this.coefficientElements,{rank:t}=this.transform.value,r=new Float64Array((t+1)**2);r[r.length-1]=1;for(let i=0;i<t;++i)for(let a=0;a<=t;++a){let o=e[a*t+i],l=parseFloat(o.value);if(!Number.isFinite(l))return!1;r[a*(t+1)+i]=l}return this.transform.transform=r,!0}updateViewOutputNames(){let{transform:{value:{outputSpace:e,rank:t}}}=this;if(t!==this.curRank)return;let{outputNameElements:r}=this,{names:i}=e;for(let a=0;a<t;++a){let o=r[a];o.value=i[a],o.dataset.isValid="true",Pp(o)}r[t].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){let{transform:{value:{transform:e,rank:t}}}=this,{coefficientElements:r}=this;for(let i=0;i<t;++i)for(let a=0;a<=t;++a){let o=r[a*t+i];o.value=e[a*(t+1)+i].toString(),o.dataset.isValid="true",Pp(o)}}ensureViewRankUpdated(){let e=this.transform.value,{rank:t}=e,r=e.sourceRank;if(this.curSourceRank===r&&this.curRank===t)return;let{inputBoundsElements:i,inputNameElements:a,inputScaleElements:o}=this,{element:l,coefficientElements:c,outputNameElements:d,outputScaleElements:p,outputScaleSuggestionElements:m,inputScaleSuggestionElements:y,outputBoundsElements:v,coefficientContainer:b,translationContainer:x,outputNameContainer:C,inputNameContainer:k,inputScaleContainer:D,inputLowerBoundsContainer:P,inputUpperBoundsContainer:M,outputScaleContainer:I}=this;l.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,l.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,_e(b),_e(x),b.appendChild(x),_e(C),_e(k),_e(D),_e(P),_e(M),_e(I),a.length=0,o.length=0,i.length=0,p.length=0,m.length=0,y.length=0,c.length=0,d.length=0,v.length=0;for(let E=0;E<t;++E){let _=O=>{O.classList.add("neuroglancer-coordinate-space-transform-input"),E>=r&&O.classList.add(rR)};{let O=document.createElement("div");O.classList.add("neuroglancer-coordinate-space-transform-input-name"),_(O),O.style.gridRowStart="sourceNames",O.style.gridColumnStart=`sourceDim ${E+1}`,k.appendChild(O),a.push(O)}{let{cellElement:O,inputElement:B,suggestionElement:W}=oR();O.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),_(O),O.style.gridRowStart="sourceScales",O.style.gridColumnStart=`sourceDim ${E+1}`,D.appendChild(O),o.push(B),y.push(W);let V=E;W.addEventListener("click",()=>{let U=fS(this.transform,V);U!==void 0&&(this.transform.inputSpace.value=uR(this.transform.inputSpace.value,V,U.scale,U.unit))})}{let O=document.createElement("div");_(O),O.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),O.style.gridRowStart="sourceLower",O.style.gridColumnStart=`sourceDim ${E+1}`,P.appendChild(O);let B=document.createElement("div");_(B),B.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),B.style.gridRowStart="sourceUpper",B.style.gridColumnStart=`sourceDim ${E+1}`,M.appendChild(B),i.push({lower:O,upper:B})}}for(let E=0;E<t;++E){for(let _=0;_<=t;++_){let O=document.createElement("input");O.classList.add("neuroglancer-coordinate-space-transform-coeff"),O.spellcheck=!1,O.autocomplete="off",O.size=1,O.style.gridRowStart=`outputDim ${E+1}`,O.placeholder=" ",O.style.gridColumnStart=`sourceDim ${_+1}`,c[_*t+E]=O,_===t?O.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):_==r&&O.classList.add(rR),(_===t?x:b).appendChild(O)}{let{cellElement:_,suggestionElement:O,inputElement:B}=oR();_.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),_.style.gridRowStart=`outputDim ${E+1}`,_.style.gridColumnStart="outputScales";let W=E;O.addEventListener("click",()=>{let{value:V}=this.transform,U=pS(V,W);U!==void 0&&(this.transform.outputSpace.value=uR(V.outputSpace,W,U.scale,U.unit))}),m.push(O),I.appendChild(_),p.push(B)}{let _=document.createElement("div");_.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),_.style.gridRowStart=`outputDim ${E+1}`,_.style.gridColumnStart="outputNames";let O=lR();O.title="Rebind to a different dimension",E>=r?O.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(O.title+=", or delete to remove source dimension"),O.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",d.push(O),C.appendChild(_),_.appendChild(O);let B=document.createElement("div");B.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),_.appendChild(B);let W=document.createElement("div");W.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),_.appendChild(W),v.push({lower:B,upper:W}),_.addEventListener("mousedown",V=>{V.target!==O&&(O.focus(),V.preventDefault())})}}d.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",C.appendChild(this.addOutputDimensionCell),this.curSourceRank=r,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;let{inputSpace:e,rank:t,sourceRank:r}=this.transform.value,{inputBoundsElements:i,inputNameElements:a,inputScaleElements:o,inputScaleSuggestionElements:l}=this,{names:c,scales:d,units:p,bounds:{lowerBounds:m,upperBounds:y}}=e;for(let v=0;v<t;++v){let b=o[v],x=d[v],C=p[v];b.value=_i(x,C,{elide1:!1}),b.dataset.isValid="true",Pp(b);let k;if(v<r){let I=c[v];I||(I=`${v}`),a[v].textContent=I,k=`source dimension ${I}`,b.title=`Override scale of ${k}`}else k="singleton dimension",b.title=`Set extent of ${k}`;let{lower:D,upper:P}=iR(m[v],y[v]),M=i[v];M.lower.textContent=D,M.lower.title=`Lower bound of ${k}`,M.upper.title=`Upper bound of ${k}`,M.upper.textContent=P,sR(l[v],fS(this.transform,v),x,C,`Revert scale of ${k} to `)}}updateViewOutputScales(){let{value:e}=this.transform,{rank:t,names:r,units:i,scales:a,bounds:{lowerBounds:o,upperBounds:l}}=e.outputSpace,{outputScaleElements:c,outputBoundsElements:d,outputScaleSuggestionElements:p}=this;for(let m=0;m<t;++m){let y=c[m],v=a[m],b=i[m];y.value=_i(v,b,{elide1:!1}),Pp(y);let x=r[m];y.dataset.isValid="true";let C=`Change coordinates of ${qo(x)?"local":"global"} dimension ${x}`;y.title=`${C} (does not rescale the source)`;let{lower:k,upper:D}=iR(o[m],l[m]),P=d[m];P.lower.textContent=k,P.upper.textContent=D,sR(p[m],pS(e,m),v,b,`${C} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){let{transform:{value:r,mutableSourceRank:i,defaultTransform:a}}=this,{rank:o}=r;this.resetToIdentityButton.style.visibility=e||!OE(r.transform,o+1,o+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!i&&(e||t||!GE(a,r))?"visible":"hidden"}updateView(){let e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){Xe(this.element),super.disposed()}};var Xx=at(It());function dR(n,e,{horizontal:t=!1,vertical:r=!0,topMargin:i=6,bottomMargin:a=6,leftMargin:o=6,rightMargin:l=6,maxHeight:c=!0,maxWidth:d=!0}={}){let p=e.getBoundingClientRect();if(t){let m=n.ownerDocument.documentElement.clientWidth,y=p.right,v=m-p.left;y>v?(n.style.left="",n.style.right=`${m-p.right}px`,d&&(n.style.maxWidth=y-o+"px")):(n.style.right="",n.style.left=`${p.left}px`,d&&(n.style.maxWidth=v-l+"px"))}if(r){let m=n.ownerDocument.documentElement.clientHeight,y=p.top-i,v=m-p.bottom-a;n.style.left=`${p.left}px`,n.style.width=`${p.width}px`,y>v*3?(n.style.top="",n.style.bottom=`${m-p.top}px`,c&&(n.style.maxHeight=y+"px")):(n.style.top=`${p.bottom}px`,n.style.bottom="",c&&(n.style.maxHeight=v+"px"))}}function pR(n){let e=n[Symbol.iterator](),{value:t,done:r}=e.next();if(r)return"";let i=t.length;for(;i>0;){let{value:a,done:o}=e.next();if(o)break;let l=0;for(;l<i&&t.charCodeAt(l)===a.charCodeAt(l);++l);i=l}return t.substring(0,i)}var fR=10,vg=.5,hR=class{constructor(){this.anchorIndex=0;this.anchorClientOffset=0}splice(e){let{anchorIndex:t}=this,r=0;for(let i of e){if(r+=i.retainCount,t<r)break;let{deleteCount:a}=i;if(t<r+a){t=r;break}let{insertCount:o}=i;t=t-a+o,r+=o-o}this.anchorIndex=t}},Yx=class{constructor(){this.startIndex=0;this.endIndex=0;this.anchorIndex=0;this.anchorOffset=0;this.scrollOffset=0}},mR=class{constructor(){this.itemSize=[];this.totalKnownSize=0;this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){var t;return(t=this.itemSize[e])!=null?t:this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,r=0){for(;t<e;++t)r+=this.getEstimatedSize(t);for(;t>e;--t)r-=this.getEstimatedSize(t-1);return r}getRangeSize(e,t){var o;let r=0,{itemSize:i,averageSize:a}=this;for(let l=e;l<t;++l)r+=(o=i[l])!=null?o:a;return r}splice(e){let{itemSize:t}=this;t=this.itemSize=Nk(t,e),this.totalKnownSize=t.reduce((r,i)=>r+i,0),this.numItemsInTotalKnownSize=t.reduce(r=>r+1,0)}};function Gj(n,e,t,r,i,a){let{anchorIndex:o,anchorClientOffset:l}=a,c=i.getEstimatedOffset(o),d,p,m,y,v;if(r===0||i.totalKnownSize===0)d=Math.max(0,o-fR/2),p=Math.min(t,d+fR),v=o,m=0,y=l;else{let b=i.getEstimatedTotalSize(),x=Math.max(0,b-r);y=c-l,y=Math.max(0,Math.min(x,y));let C=y-2*vg*r,k=y-vg*r,D=y+r+vg*r,P=c-l+r+2*vg*r;d=Math.min(t,e.startIndex);let M=i.getEstimatedOffset(d,o,c);if(M<C)for(;d+1<t;++d){let E=i.getEstimatedSize(d);if(M+E>=k)break;M+=E}if(M>=k)for(;M>C&&d>0;--d)M-=i.getEstimatedSize(d-1);p=Math.min(t,e.endIndex);let I=i.getEstimatedOffset(p,o,c);if(I<D)for(;I<=P&&p+1<=t;++p)I+=i.getEstimatedSize(p);else if(I>=P)for(;p>d;--p){let E=i.getEstimatedSize(p-1);if(I-E<D)break;I-=E}for(v=o,m=c;v<d;++v)m+=i.getEstimatedSize(v);for(;v>p;--v)m-=i.getEstimatedSize(v-1)}n.startIndex=d,n.endIndex=p,n.anchorIndex=v,n.anchorOffset=m,n.scrollOffset=y}function Wj(n,e){let t=e.getEstimatedOffset(n.anchorIndex),r=n.anchorOffset;n.anchorOffset=t,n.scrollOffset+=t-r}function zj(n,e){return n.startIndex<e.startIndex||n.endIndex>e.endIndex}var wl=class extends j{constructor(e){super();this.element=document.createElement("div");this.scrollContent=document.createElement("div");this.header=document.createElement("div");this.body=document.createElement("div");this.topItems=document.createElement("div");this.bottomItems=document.createElement("div");this.renderedItems=[];this.renderGeneration=-1;this.listGeneration=-1;this.newRenderedItems=[];this.state=new hR;this.renderParams=new Yx;this.newRenderParams=new Yx;this.sizes=new mR;this.debouncedUpdateView=this.registerCancellable(Ge(()=>this.updateView()));this.resizeObserver=new ResizeObserver(()=>this.updateView());let{selectedIndex:t}=e;t!==void 0&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);let r=this.source=e.source;this.sizes.itemSize.length=r.length;let{element:i,header:a,body:o,scrollContent:l,topItems:c,bottomItems:d}=this;this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.disconnect()),i.appendChild(l),i.style.overflowAnchor="none",l.appendChild(a),l.appendChild(o),a.style.position="sticky",a.style.zIndex="1",a.style.top="0",e.horizontalScroll?(l.style.width="min-content",l.style.minWidth="100%",a.style.width="min-content",a.style.minWidth="100%",d.style.width="min-content",d.style.minWidth="100%"):(l.style.width="100%",a.style.width="100%",d.style.width="100%"),o.appendChild(c),o.appendChild(d),c.style.width="min-content",c.style.position="relative",c.style.height="0",c.style.minWidth="100%",d.style.height="0",d.style.position="relative",i.addEventListener("scroll",()=>{let p=i.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-p,this.renderParams.scrollOffset=p,this.debouncedUpdateView()}),r.changed!==void 0&&this.registerDisposer(r.changed.add(p=>{this.sizes.splice(p),this.state.splice(p),this.renderedItems.length=0,this.debouncedUpdateView()})),r.renderChanged!==void 0&&this.registerDisposer(r.renderChanged.add(this.debouncedUpdateView))}updateView(){let{element:e}=this;if(e.offsetHeight===0)return;let t=e.clientHeight-this.header.offsetHeight,{source:r,state:i,sizes:a}=this,o=r.length,{body:l,topItems:c,bottomItems:d}=this,{changed:p,renderChanged:m}=r,y;for(;;){y=this.newRenderParams;let x=this.renderParams;Gj(y,x,o,t,a,i);let C;if(m!==void 0&&m.count!==this.renderGeneration||p!==void 0&&p.count!==this.listGeneration?(this.renderGeneration=m===void 0?-1:m.count,this.listGeneration=p===void 0?-1:p.count,C=!0,this.renderedItems.length=0):C=!1,!C&&!zj(y,x)){x.scrollOffset=y.scrollOffset,y=x;break}this.renderParams=y,this.newRenderParams=x;let k=this.renderedItems,D=this.newRenderedItems;D.length=0,this.renderedItems=D,this.newRenderedItems=k;let{source:P}=this,{render:M}=P,{startIndex:I,endIndex:E,anchorIndex:_}=y;function*O(B,W){for(let V=B;V<W;++V){let U=k[V];U===void 0&&(U=M.call(P,V)),D[V]=U,yield U}}qn(c,O(I,_)),qn(d,O(_,E));for(let B=I;B<E;++B){let U=D[B].getBoundingClientRect().height,N=a.itemSize[B];N!==void 0&&(a.totalKnownSize-=N,--a.numItemsInTotalKnownSize),a.itemSize[B]=U,a.totalKnownSize+=U,++a.numItemsInTotalKnownSize}}Wj(y,a),i.anchorIndex=y.anchorIndex,i.anchorClientOffset=y.anchorOffset-y.scrollOffset;let v=a.getRangeSize(y.startIndex,y.anchorIndex),b=a.getEstimatedTotalSize();l.style.height=`${b}px`,c.style.top=`${y.anchorOffset-v}px`,d.style.top=`${y.anchorOffset}px`,e.scrollTop=y.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){let{startIndex:t,endIndex:r}=this.renderParams,{renderedItems:i}=this;for(let a=t;a<r;++a){let o=i[a];o!==void 0&&e(o,a)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){let t=this.sizes.getEstimatedOffset(e),r=t+this.sizes.getEstimatedSize(e),i=this.element.scrollTop;if(t<i)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else if(t>i&&r>i+this.element.offsetHeight)this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight;else return;this.debouncedUpdateView()}disposed(){Xe(this.element)}};var Qx="neuroglancer-multiline-autocomplete-completion-active",Hj=!1;function $j(n){let e=document.createElement("div");return e.textContent=n.value,e}function*gR(n){for(;n.length>0;){let e=n.match(/[:/_]+/);if(e===null){yield n;return}let t=e.index+e[0].length;yield n.substring(0,t),n=n.substring(t)}}function yR(n){let e=document.createElement("div");e.className="neuroglancer-multiline-autocomplete-completion-with-description",e.textContent=n.value;let t=document.createElement("div");return t.className="neuroglancer-multiline-autocomplete-completion-description",t.textContent=n.description||"",e.appendChild(t),e}var jj=Oe.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}}),qj=200,Zx=class extends j{constructor(e){super();this.element=document.createElement("div");this.inputElement=document.createElement("span");this.hintElement=document.createElement("span");this.completionsVirtualList=void 0;this.onCommit=new Me;this.onInput=new Me;this.prevInputValue="";this.completionsVisible=!1;this.activeCompletionPromise=null;this.activeCompletionCancellationToken=void 0;this.hasFocus=!1;this.completionResult=null;this.dropdownContentsStale=!0;this.hasResultForDropdown=!1;this.commonPrefix="";this.completionDisabled=-1;this.activeIndex=-1;this.dropdownStyleStale=!0;this.resizeHandler=()=>{!this.completionsVisible||this.updateDropdownStyle()};this.resizeObserver=new ResizeObserver(this.resizeHandler);this.debouncedUpdateHintState=this.registerCancellable((0,Xx.default)(()=>this.updateHintState(),0));this.completer=e.completer;let{delay:t=qj}=e,r=this.scheduleUpdateCompletions=(0,Xx.default)(()=>{let c=this.activeCompletionCancellationToken=new $n,d=this.activeCompletionPromise=this.completer(this.value,c);d!==null&&d.then(p=>{this.activeCompletionPromise===d&&(this.setCompletions(p),this.activeCompletionPromise=null)})},t);this.registerDisposer(()=>{r.cancel()});let{element:i,inputElement:a,hintElement:o}=this;i.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.unobserve(a)),a.contentEditable="true",a.spellcheck=!1,i.appendChild(document.createTextNode("\u200B")),i.appendChild(a),i.appendChild(o),a.classList.add("neuroglancer-multiline-autocomplete-input"),o.classList.add("neuroglancer-multiline-autocomplete-hint"),a.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),a.addEventListener("copy",c=>{let{clipboardData:d}=c;if(d!==null){let p=window.getSelection();p!==null&&!p.isCollapsed&&p.containsNode(a,!0)&&d.setData("text/plain",p.toString())}c.preventDefault(),c.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{let c=this.getSelectionRange(),{completionDisabled:d}=this;c!==void 0&&c.begin===d&&c.end===d||(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),i.addEventListener("pointerdown",c=>{let{target:d}=c;if(d instanceof Node){if(a.contains(d))return;let{completionsVirtualList:p}=this;if(p!==void 0&&p.element.contains(d))return}a===document.activeElement&&(this.moveCaretToEndOfInput(),c.stopPropagation(),c.preventDefault())}),i.addEventListener("click",()=>{a.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();let c=document.createRange(),{childNodes:d}=a;c.setStart(a,0),d.length===0?c.setEnd(a,0):c.setEndAfter(d[d.length-1]);let p=window.getSelection();p!==null&&(p.removeAllRanges(),p.addRange(c)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{if(this.hasFocus){if(Hj)return;this.hasFocus=!1,this.updateDropdown()}this.debouncedUpdateHintState();let c=window.getSelection();c!==null&&c.containsNode(this.inputElement,!0)&&c.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0});let l=this.registerDisposer(new zt(a,jj));l.allShortcutsAreGlobal=!0,ce(a,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),ce(a,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),ce(a,"home",()=>{this.moveCaretToBeginningOfInput()}),ce(a,"end",()=>{this.moveCaretToEndOfInput()}),ce(a,"choose-active-completion-or-prefix",c=>{this.selectActiveCompletion(!0)&&c.preventDefault()}),ce(a,"commit",c=>{if(this.selectActiveCompletion(!1))c.stopPropagation();else{let d=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,d)}}),ce(a,"cancel",c=>{c.stopPropagation(),this.cancel()&&(c.detail.preventDefault(),c.detail.stopPropagation())})}disableCompletion(){let e=this.getSelectionRange();this.completionDisabled=e!==void 0&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){let e=window.getSelection();if(e===null||e.rangeCount===0)return;let t=e.getRangeAt(0),{inputElement:r}=this,i=document.createRange();i.setStart(r,0),i.setEnd(t.startContainer,t.startOffset);let a=i.toString().length,o=e.toString().length;return{begin:a,end:a+o}}setValueAndSelection(e,t=void 0){let r=this.completionDisabled!==-1;this.onInput.dispatch(e);let{inputElement:i}=this;_e(i);let a=0,o=t!==void 0?document.createRange():void 0,l=!0;for(let c of gR(e)){l||i.appendChild(document.createElement("wbr")),l=!1;let d=a+c.length,p=document.createTextNode(c);if(i.appendChild(p),o!==void 0){let{begin:m,end:y}=t;m>=a&&m<=d&&o.setStart(p,m-a),y>=a&&y<=d&&o.setEnd(p,y-a)}a=d}if(o!==void 0){l&&(o.setStart(i,0),o.setEnd(i,0));let c=window.getSelection();c!==null&&(c.removeAllRanges(),c.addRange(o))}this.completionDisabled=r&&t!==void 0&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){let{inputElement:e}=this;if(document.activeElement!==e)return!1;let t=this.getSelectionRange();return t!==void 0&&t.end===t.begin&&t.end!=this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),this.shouldAttemptCompletion()){let{value:e}=this;if(e===this.prevInputValue)return;this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions()}else{this.hideCompletions();return}}handleDropdownClick(e){let{completionsVirtualList:t}=this;if(t===void 0)return;let r=t.element;for(let i=e.target;i instanceof HTMLElement&&i!==r;i=i.parentElement){let a=i.dataset.completionIndex;if(a!==void 0){this.selectCompletion(Number(a));break}}}cycleActiveCompletion(e){if(this.completionResult===null)return;let{activeIndex:t}=this,r=this.completionResult.completions.length;t===-1?e>0?t=0:t=r-1:t=(t+e+r)%r,this.setActiveIndex(t)}shouldShowDropdown(){let{completionResult:e}=this;return e===null||!this.hasFocus?!1:this.hasResultForDropdown}updateDropdownStyle(){let{completionsVirtualList:e,element:t}=this;e!==void 0&&dR(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let{completionsVirtualList:e}=this;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){e!==void 0&&e.dispose();let r=this.completionResult,{makeElement:i=$j}=r;e=this.completionsVirtualList=new wl({source:{length:r.completions.length,render:a=>{let o=r.completions[a],l=i.call(r,o);return l.classList.add("neuroglancer-multiline-autocomplete-completion"),l.dataset.completionIndex=`${a}`,this.activeIndex===a&&l.classList.add(Qx),l}},selectedIndex:this.activeIndex===-1?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",a=>{this.inputElement.focus(),a.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);let{activeIndex:t}=this;t!==-1&&this.completionsVirtualList.scrollItemIntoView(t)}else this.completionsVisible&&(e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let{completions:t}=e;if(t.length===0)return;let r=this.prevInputValue;if(r!==void 0){if(this.completionResult=e,t.length===1){let i=t[0];e.showSingleResult?this.hasResultForDropdown=!0:i.value.startsWith(r)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let i=pR(function*(){for(let o of e.completions)yield o.value}()),a=this.getCompletedValue(i);a.startsWith(r)&&(this.commonPrefix=a,this.setHintValue(a))}this.updateDropdown()}}setHintValue(e){let t=this.prevInputValue;if(t===void 0)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);let{hintElement:r}=this;_e(r);let i=!0;for(let a of gR(e)){i||r.appendChild(document.createElement("wbr")),i=!1;let o=document.createTextNode(a);r.appendChild(o)}}setActiveIndex(e){if(!this.dropdownContentsStale){let{activeIndex:t}=this,{completionsVirtualList:r}=this;if(r!==void 0){if(t!==-1){let i=r.getItemElement(t);i!==void 0&&i.classList.remove(Qx)}if(e!==-1){let i=r.getItemElement(e);i!==void 0&&i.classList.add(Qx),r.scrollItemIntoView(e)}}}e!==-1&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,r=this.prevInputValue;return r===void 0?"":r.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){let e=document.createRange(),{inputElement:t}=this;e.setStart(t,0),e.setEnd(t,0);let r=window.getSelection();r!==null&&(r.removeAllRanges(),r.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){let e=document.createRange(),{inputElement:t}=this,{childNodes:r}=t,i=r[r.length-1];i===void 0?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(i),e.setEndAfter(i));let a=window.getSelection();a!==null&&(a.removeAllRanges(),a.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let{activeIndex:t}=this;if(t===-1){if(!e)return!1;let{completionResult:i}=this;if(i!==null&&i.completions.length===1)t=0;else{let{commonPrefix:a}=this;return a.length>this.value.length?(this.value=a,this.moveCaretToEndOfInput(),!0):!1}}let r=this.getCompletedValueByIndex(t);return this.value===r?!1:(this.value=r,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;let e=this.activeCompletionCancellationToken;e!==void 0&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(this.completionResult!==null){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";let{completionsVirtualList:e}=this;e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){let{completionsVirtualList:e}=this;e!==void 0&&e.dispose(),Xe(this.element),this.cancelActiveCompletion(),super.disposed()}};var sn=class extends j{constructor(e=new Pt(Pt.VISIBLE)){super();this.visibility=e;this.element=document.createElement("div");let{element:t}=this;t.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){Xe(this.element),super.disposed()}},vR=class extends j{constructor(){super(...arguments);this.changed=new ae;this.options=new Map;this.optionsChanged=new ae;this.selectedValue=void 0;this.defaultValue=void 0;this.ready_=!0}get value(){let{selectedValue:e}=this;return e!==void 0?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){e!==void 0&&this.ready_&&!this.options.has(e)&&(e=void 0);let{selectedValue:t}=this;t!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){let e=this.selectedValue;return e===void 0||!this.options.has(e)?this.defaultValue:e}add(e,t){let{options:r}=this;if(r.has(e))throw new Error(`Option already defined: ${JSON.stringify(e)}.`);r.set(e,t),this.optionsChanged.dispatch(),this.defaultValue===void 0&&(this.default=e)}toJSON(){let{value:e,defaultValue:t}=this;if(e!==t)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){typeof e!="string"&&(e=void 0),this.value=e}},SR=class extends j{constructor(e,t,r=new Pt(Pt.VISIBLE),i=!1){super();this.getter=e;this.selected=t;this.visibility=r;this.invalidateByDefault=i;this.element=document.createElement("div");this.tabs=new Map;this.tabVisibilityChanged=new Me;this.debouncedUpdateSelectedTab=this.registerCancellable(Ge(()=>this.updateSelectedTab()));let{element:a}=this;a.className="neuroglancer-stack-view",this.registerDisposer(r.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){let{tabs:t}=this,r=t.get(e);r!==void 0&&(r.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){let t=this.tabs.get(e);t!==void 0&&(t.visibility.value=Pt.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){let{tabs:t}=this,r=t.get(e);r===void 0&&(r=this.getter(e),this.element.appendChild(r.element),t.set(e,r)),r.element.style.display="",r.visibility.value=Pt.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){let{displayedTab:e}=this,t=this.visible?this.selected.value:void 0;t===e&&(t===void 0||this.tabs.has(t))||(e!==void 0&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,t!==void 0&&this.showTab(t))}invalidateAll(e=void 0){let{tabs:t}=this;for(let[r,i]of t)e!==void 0&&e(r)||(t.delete(r),i.dispose());this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),Xe(this.element),super.disposed()}},eC=class extends vR{};function Jj(n,e){let t="neuroglancer-selected-tab-label";e?n.classList.add(t):n.classList.remove(t)}var tC=class extends j{constructor(e,t=new Pt(Pt.VISIBLE)){super();this.visibility=t;this.element=document.createElement("div");this.tabBar=document.createElement("div");this.tabLabels=new Map;this.tabsGeneration=-1;this.debouncedUpdateView=this.registerCancellable(Ge(()=>this.updateTabs()));this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;let{element:r,tabBar:i}=this;r.className="neuroglancer-tab-view",i.className="neuroglancer-tab-view-bar",r.appendChild(i),this.registerDisposer(t.changed.add(this.debouncedUpdateView));let a=this.stack=this.registerDisposer(new SR(e.makeTab,e.selectedTab,this.visibility));r.appendChild(a.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView)),this.registerDisposer(e.selectedTab.changed.add(()=>this.updateTabLabelStyles())),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){let e=this.selectedTab.value;for(let[t,r]of this.tabLabels)Jj(r,t===e)}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(this.tabsGeneration!==-1){if(this.tabLabels.clear(),!this.visible)this.stack.invalidateAll();else{let e=this.tabs.value;this.stack.invalidateAll(t=>e.find(({id:r})=>r===t)!==void 0)}_e(this.tabBar),this.tabsGeneration=-1}}makeTabs(){let{tabBar:e,tabLabels:t,handleTabElement:r}=this;for(let{id:i,label:a}of this.tabs.value){let o=document.createElement("div");o.classList.add("neuroglancer-tab-label"),o.textContent=a,o.addEventListener("click",()=>{this.selectedTab.value=i}),r!==void 0&&r(i,o),t.set(i,o),e.appendChild(o)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){_e(this.tabBar),this.tabLabels.clear(),Xe(this.element),super.disposed()}};var bR=class extends Zx{constructor(e){let{manager:t}=e.source.layer,r=(a,o)=>t.dataSourceProviderRegistry.completeUrl({url:a,chunkManager:t.chunkManager,cancellationToken:o}).then(l=>({completions:l.completions,makeElement:yR,offset:l.offset,showSingleResult:!0}));super({completer:r,delay:0});this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new Re(!1);let i=a=>{a!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};i(""),this.onInput.add(i)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}},nC=class extends j{constructor(e){super();this.model=e;this.element=document.createElement("ul");this.generation=-1;this.element.classList.add("neuroglancer-layer-data-sources-source-messages");let t=this.registerCancellable(Ge(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>Xe(this.element)),this.updateView()}updateView(){let{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.generation=t;let{element:r}=this;_e(r);let i=new Set;for(let a of e){let o=`${a.severity} ${a.message}`;if(i.has(o))continue;i.add(o);let l=document.createElement("li");r.appendChild(l),l.classList.add("neuroglancer-message"),l.classList.add(`neuroglancer-message-${Cr[a.severity]}`),l.textContent=a.message}}},xR=class extends j{constructor(e,t){super();this.loadedSubsource=t;this.element=document.createElement("div");let{element:r}=this;r.classList.add("neuroglancer-layer-data-source-subsource");let i=document.createElement("label"),a=document.createElement("span"),o=()=>{i.dataset.isActive=(t.activated!==void 0||!t.enabled).toString()};o(),this.registerDisposer(t.isActiveChanged.add(o)),this.registerDisposer(e.enabledSubsourcesChanged.add(o));let l=this.registerDisposer(new br({get value(){return t.enabled},set value(b){t.enabled=b,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));i.classList.add("neuroglancer-layer-data-sources-info-line"),i.appendChild(l.element);let c=document.createElement("span");c.classList.add("neuroglancer-layer-data-sources-source-id");let{id:d}=t.subsourceEntry;d!=="default"&&(c.textContent=d),i.appendChild(c),a.classList.add("neuroglancer-layer-data-sources-source-type");let p=this.registerDisposer(new nC(this.loadedSubsource.messages));r.appendChild(i),i.appendChild(a),r.appendChild(p.element);let m="",{subsource:y}=t.subsourceEntry,{volume:v}=y;if(v instanceof Gt)m=`${H[v.dataType].toLowerCase()} volume`;else if(y.mesh instanceof kr)m="meshes (single-res.)";else if(y.mesh instanceof go)m="meshes (multi-res.)";else if(y.mesh instanceof yo)m="skeletons";else if(y.segmentPropertyMap!==void 0)m="segment property map";else if(y.local!==void 0)switch(y.local){case fi.annotations:m="Local annotations";break;case fi.equivalences:m="local segmentation graph";break}else y.staticAnnotations!==void 0?m="default annotations":y.annotation!==void 0?m="annotations":y.singleMesh!==void 0?m="single mesh":y.segmentationGraph!==void 0&&(m="segmentation graph");a.textContent=m}},CR=class extends j{constructor(e){super();this.source=e;this.element=document.createElement("div");let{element:t}=this,r=document.createElement("label");r.classList.add("neuroglancer-layer-data-sources-source-default"),r.appendChild(this.registerDisposer(new br({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(a){if(e.enableDefaultSubsources!==a){if(e.enableDefaultSubsources=a,a)for(let o of e.subsources)o.enabled=o.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),r.appendChild(document.createTextNode("Enable default subsource set")),r.title="Enable the default set of subsources for this data source.",t.appendChild(r);for(let a of e.subsources)t.appendChild(this.registerDisposer(new xR(e,a)).element);let{transform:i}=e;if(i.mutableSourceRank||i.value.sourceRank!==0){let a=this.registerDisposer(new Kx(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(a.element)}this.registerDisposer(()=>Xe(this.element))}},wR=class extends j{constructor(e,t){super();this.tab=e;this.source=t;this.element=document.createElement("div");this.seenGeneration=0;this.generation=-1;let r=this.urlInput=this.registerDisposer(new bR(this)),i=(o,l)=>{let{source:c}=this,d=c.spec,p=this.source.layer;if(o=p.manager.dataSourceProviderRegistry.normalizeUrl({url:o}),o!==r.value&&(r.disableCompletion(),r.setValueAndSelection(o,{begin:o.length,end:o.length})),r.dirty.value=!1,o&&o===d.url){l&&e.detectedLayerConstructor!==void 0&&TR(c.layer);return}if(p instanceof Ki)try{let m=p.manager.dataSourceProviderRegistry.suggestLayerName(o);Sg(p.managedLayer,m)}catch{}c.spec={...d,url:o}};r.onCommit.add(i);let{element:a}=this;a.classList.add("neuroglancer-layer-data-source"),a.appendChild(r.element),a.appendChild(this.registerDisposer(new nC(t.messages)).element),this.updateView()}updateView(){let e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;let{loadState:t}=this.source,{loadedView:r}=this;if(r!==void 0){if(r.source===t)return;r.dispose(),r=this.loadedView=void 0}t instanceof qc&&(r=this.loadedView=new CR(t),this.element.appendChild(r.element))}disposed(){let{loadedView:e}=this;e!==void 0&&e.dispose(),Xe(this.element),super.disposed()}};function TR(n){if(n instanceof Ki){let e=n.detectedLayerConstructor;if(e!==void 0)return Dp(n.managedLayer,e),!0}return!1}var rC=class extends sn{constructor(e){super();this.layer=e;this.generation=-1;this.sourceViews=new Map;this.addDataSourceIcon=yg({title:"Add additional data source"});this.layerTypeDetection=document.createElement("div");this.layerTypeElement=document.createElement("span");this.dataSourcesContainer=document.createElement("div");this.detectedLayerConstructor=void 0;let{element:t,dataSourcesContainer:r}=this;t.classList.add("neuroglancer-layer-data-sources-tab"),r.classList.add("neuroglancer-layer-data-sources-container");let{addDataSourceIcon:i}=this;if(i.style.alignSelf="start",i.addEventListener("click",()=>{let o=this.layer.addDataSource(void 0);this.updateView();let l=this.sourceViews.get(o);l!==void 0&&l.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof Ki){let{layerTypeDetection:o,layerTypeElement:l}=this;o.style.display="none",l.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),o.appendChild(document.createTextNode("Create as ")),o.appendChild(l),o.appendChild(document.createTextNode(" layer")),t.appendChild(o),o.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),o.addEventListener("click",()=>{TR(e)})}let a=this.reRender=Ge(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(a)),this.registerDisposer(this.visibility.changed.add(a)),this.updateView()}updateLayerTypeDetection(){let e=(()=>{let r=this.layer;if(!(r instanceof Ki))return;let i=r.detectedLayerConstructor;if(i!==void 0){for(let a of this.sourceViews.values())if(a.urlInput.dirty.value)return;return i}})();if(e===this.detectedLayerConstructor)return;let{layerTypeDetection:t}=this;if(this.detectedLayerConstructor=e,e!==void 0){let{layerTypeElement:r}=this;r.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){let{sourceViews:e}=this;for(let t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;let e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;let t=Date.now(),{sourceViews:r}=this,{layer:i}=this;function*a(){let o=!0,{dataSources:l}=i;for(let c of l){let d=r.get(c);d===void 0&&(d=new wR(this,c),d.registerDisposer(d.urlInput.dirty.changed.add(this.reRender)),r.set(c,d)),d.seenGeneration=t,d.updateView();let p=c.spec.url;l.length===1&&p===""&&setTimeout(()=>{d.urlInput.inputElement.focus()},0),o=c.spec.url.length===0,yield d.element}o||(yield this.addDataSourceIcon)}qn(this.dataSourcesContainer,a.call(this));for(let[o,l]of r)l.seenGeneration!==t&&(l.dispose(),r.delete(o))}this.updateLayerTypeDetection()}};var bg="tab",kR="tabs",LR="panels",ER={...yi,row:0},iC={...yi,visible:!0,row:0},Xc=class extends j{constructor(e){super();this.panels=e;this.layer=this.panels.layer;this.location=new sr(iC);this.tabsChanged=new Me;this.selectedTab=new Re(void 0);this.tabs=[]}initialize(){let{panels:e}=this;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{var a;e.specificationChanged.dispatch();let{layer:t}=this,{selectedLayer:r}=t.manager.root;if(((a=r.layer)==null?void 0:a.layer)!==t||this!==t.panels.panels[0])return;let i=this.location.value;r.location.value!==i&&(r.location.value=i,r.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)})}normalizeTabs(){let{tabs:e}=this;if(e.length===0){this.selectedTab.value=void 0;return}let t=this.layer.tabs.options,r=o=>{var l;return(l=t.get(o).order)!=null?l:0};e.sort((o,l)=>r(o)-r(l));let{selectedTab:i}=this,a=i.value;(a===void 0||!e.includes(a))&&(i.value=e[0])}pin(){var a;let{layer:e}=this,{selectedLayer:t}=e.manager.root;if(((a=t.layer)==null?void 0:a.layer)!==e||this!==e.panels.panels[0]||this.tabs.length===0)return;let{panels:r}=this,i=e.registerDisposer(new Xc(r));r.panels.splice(0,1,i),r.panels.push(this),r.updateTabs(),i.initialize(),t.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){var l;let{panels:e}=this,t=e.panels.indexOf(this);if(t===-1||t===0)return;let{layer:r}=this,{selectedLayer:i}=r.manager.root,a=(l=i.layer)==null?void 0:l.layer;i.visible&&a!=null&&a!=r&&a.panels.panels[0].pin(),e.panels.splice(t,1);let[o]=e.panels.splice(0,1,this);if(this.explicitTabs===void 0)r.unregisterDisposer(o);else{e.panels.push(o);for(let c=1,d=e.panels.length;c<d;++c){let p=e.panels[c];p.explicitTabs===void 0&&(p.explicitTabs=new Set(p.tabs))}}this.explicitTabs=void 0,e.updateTabs(),i.layer=r.managedLayer,i.location.value=this.location.value,i.location.locationChanged.dispatch(),i.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;let{panels:r}=this;{let{explicitTabs:o}=this;o!==void 0&&o.delete(e)}let{layer:i}=this,a=i.registerDisposer(new Xc(r));a.location.value=t,a.explicitTabs=new Set([e]),r.panels.splice(1,0,a),r.updateTabs(),a.initialize(),i.manager.root.layerManager.layersChanged.dispatch(),r.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{let{explicitTabs:i}=this;i!==void 0&&i.delete(e)}{let{explicitTabs:i}=t;i!==void 0&&i.add(e)}let{panels:r}=this;r.updateTabs(),t.selectedTab.value=e,r.specificationChanged.dispatch()}mergeInto(e){let{explicitTabs:t}=e;if(t!==void 0)for(let i of this.tabs)t.add(i);let{panels:r}=this;r.removePanel(this)}},aC=class{constructor(e){this.layer=e;this.specificationChanged=new Me;this.updating=!1;this.panels=[e.registerDisposer(new Xc(this))]}restoreState(e){let{panels:t}=this;t[0].selectedTab.value=le(e,bg,ee);let{layer:r}=this,{tabs:i}=r,a=new Set(i.options.keys());le(e,LR,o=>ye(o,l=>{Q(l);let c=new Xc(this);c.location.restoreState(l),!!c.location.visible&&(c.selectedTab.value=le(l,bg,ee),c.explicitTabs=le(l,kR,d=>{let p=new Set;for(let m of jt(d))!a.has(m)||(a.delete(m),p.add(m));return p}),c.explicitTabs===void 0?(c.tabs=Array.from(a),a.clear()):c.tabs=Array.from(c.explicitTabs),c.tabs.length!==0&&(c.normalizeTabs(),r.registerDisposer(c),c.initialize(),t.push(c)))})),t[0].tabs=Array.from(a),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;let t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){var o;let{layer:e}=this,{tabs:t}=e,r=new Set(t.options.keys()),{panels:i}=this;this.updating=!0;let a=l=>{let c=l.tabs;if(l.explicitTabs===void 0)l.tabs=Array.from(r),r.clear();else{l.tabs=Array.from(l.explicitTabs);for(let d of l.tabs)r.delete(d)}we(c,l.tabs)||(l.normalizeTabs(),l.tabsChanged.dispatch())};for(let l=1;l<i.length;){let c=i[l];if(c.location.visible&&(a(c),c.tabs.length!==0)){++l;continue}i.splice(l,1),e.unregisterDisposer(c)}if(a(i[0]),i[0].tabs.length===0){let{selectedLayer:l}=this.layer.manager.root;((o=l.layer)==null?void 0:o.layer)===this.layer&&(l.location.visible=!1)}this.updating=!1}toJSON(){var r;let{panels:e}=this,t={};if(t[bg]=e[0].selectedTab.value,e.length>1){let i=[];for(let a=1,o=e.length;a<o;++a){let l=e[a],c=(r=l.location.toJSON())!=null?r:{};c[bg]=l.selectedTab.value;let{explicitTabs:d}=l;d!==void 0&&(c[kR]=Array.from(d)),i.push(c)}t[LR]=i}return t}};var oC=at(It());var Kj=/^[A-Z]$/,sC=class extends j{constructor(e,t){super();this.tool=e;this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(ce(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){this==this.tool.layer.manager.root.toolBinder.activeTool_&&this.tool.layer.manager.root.toolBinder.deactivate_()}},Yi=class extends j{constructor(e,t=!1){super();this.layer=e;this.toggle=t;this.changed=new Me;this.keyBinding=void 0}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}unbind(){let{layer:e}=this,{keyBinding:t}=this;t!==void 0&&e.toolBinder.set(t,void 0)}},Ap=class extends j{constructor(e){super();this.layer=e;this.changed=new Me}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){let{layer:e}=this;e.tool.value===this&&(e.tool.value=void 0)}};function PR(n,e){var i;if(e===void 0)return;typeof e=="string"&&(e={type:e}),Q(e);let t=G(e,"type",ee),r=(i=lC.get(n.constructor))==null?void 0:i.get(t);if(r===void 0&&(r=Xj.get(t)),r===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return r(n,e)}function Yj(n,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),Q(e);let t=G(e,"type",ee),r=DR.get(t);if(r===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return r(n,e)}var DR=new Map,Xj=new Map,lC=new Map;function Qc(n,e){DR.set(n,e)}function xo(n,e,t){let r=lC.get(n);r===void 0&&(r=new Map,lC.set(n,r)),r.set(e,t)}var cC=class extends j{constructor(e){super();this.layer=e;this.changed=new Me}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),e!==void 0&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){let e=this.value_;e!==void 0&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=Yj(this.layer,e)}reset(){this.value=void 0}toJSON(){let e=this.value_;if(e!==void 0)return e.toJSON()}},uC=class extends j{constructor(e){super();this.inputEventMapBinder=e;this.bindings=new Map;this.changed=new Me;this.debounceDeactivate=this.registerCancellable((0,oC.default)(()=>this.deactivate_(),100));this.debounceReactivate=this.registerCancellable((0,oC.default)(()=>this.reactivateQueuedTool(),100))}get(e){return this.bindings.get(e)}set(e,t){let{bindings:r}=this,i=r.get(e);if(i!==void 0){i.keyBinding=void 0,r.delete(e);let a=i.layer.toolBinder;a.bindings.delete(e),a.jsonToKey.delete(JSON.stringify(i.toJSON())),this.destroyTool(i),a.changed.dispatch()}if(t!==void 0){let a=t.layer.toolBinder,o=JSON.stringify(t.toJSON()),l=a.jsonToKey.get(o);if(l!==void 0){let c=a.bindings.get(l);c.keyBinding=void 0,r.delete(l),a.bindings.delete(l),a.jsonToKey.delete(o),this.destroyTool(c)}a.bindings.set(e,t),t.keyBinding=e,a.jsonToKey.set(o,e),r.set(e,t),a.changed.dispatch()}this.changed.dispatch()}activate(e){let t=this.get(e);if(t===void 0){this.deactivate_();return}this.debounceDeactivate.cancel(),this.debounceReactivate.cancel();let r=this.activeTool_;if(t===(r==null?void 0:r.tool)){t.toggle&&this.deactivate_();return}else r!==void 0&&(r.tool.toggle&&!t.toggle&&(this.queuedTool=r.tool),this.deactivate_());let i=new sC(t,this.inputEventMapBinder);if(this.activeTool_=i,!t.toggle){let a=`Key${e}`;i.registerEventListener(window,"keyup",o=>{o.code===a&&(this.debounceDeactivate(),this.debounceReactivate())}),i.registerEventListener(window,"blur",()=>{this.debounceDeactivate(),this.debounceReactivate()})}return t.activate(i),t}reactivateQueuedTool(){if(this.queuedTool){let e=new sC(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){var t;this.queuedTool===e&&(this.queuedTool=void 0),((t=this.activeTool_)==null?void 0:t.tool)===e&&this.deactivate_(),e.dispose()}disposed(){this.deactivate_(),super.disposed()}deactivate_(){this.debounceDeactivate.cancel();let e=this.activeTool_;e!==void 0&&(this.activeTool_=void 0,e.dispose())}},dC=class{constructor(e){this.layer=e;this.bindings=new Map;this.jsonToKey=new Map;this.changed=new Me;e.registerDisposer(()=>this.clear())}get globalBinder(){return this.layer.manager.root.toolBinder}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){let r=PR(this.layer,t);r!==void 0&&this.set(e,r)}removeJsonString(e){let t=this.jsonToKey.get(e);t!==void 0&&this.set(t,void 0)}toJSON(){let{bindings:e}=this;if(e.size===0)return;let t={};for(let[r,i]of e)t[r]=i.toJSON();return t}clear(){let{globalBinder:e,bindings:t}=this;if(t.size!==0){for(let[r,i]of t)i.keyBinding=void 0,e.bindings.delete(r),e.destroyTool(i);t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(e!==void 0){Q(e);for(let[t,r]of Object.entries(e)){if(!t.match(Kj))throw new Error(`Invalid tool key: ${JSON.stringify(t)}`);let i=PR(this.layer,r);if(i===void 0)return;this.set(t,i)}}}},xg=class extends j{constructor(e,t){super();this.layer=e;this.toolJson=t;this.element=document.createElement("div");this.toolJsonString=JSON.stringify(this.toolJson);let{element:r}=this;r.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.toolBinder.changed.add(this.registerCancellable(Ge(()=>this.updateView())))),this.updateView(),r.title="click \u2192 bind key, dbclick \u2192 unbind",r.addEventListener("dblclick",()=>{this.layer.toolBinder.removeJsonString(this.toolJsonString)}),pC(this,r,i=>this.layer.toolBinder.setJson(i,this.toolJson))}updateView(){let{toolBinder:e}=this.layer,t=e.jsonToKey.get(this.toolJsonString);this.element.textContent=t!=null?t:" "}};function pC(n,e,t){let r;e.addEventListener("mousedown",i=>{if(i.button!==0||r!==void 0)return;i.preventDefault(),i.stopPropagation(),r=new j,n.registerDisposer(r),r.registerDisposer(new Ce(!1)).setText("Press A-Z to bind key"),r.registerEventListener(window,"keydown",o=>{let{code:l}=o,c=l.match(/^Key([A-Z])$/);if(c===null)return;o.stopPropagation(),o.preventDefault();let d=c[1];t(d)},{capture:!0}),r.registerEventListener(window,"mouseup",o=>{o.button!==0||r===void 0||(o.preventDefault(),o.stopPropagation(),n.unregisterDisposer(r),r.dispose(),r=void 0)})}),e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation()})}function Cg(n,e,t){let r=document.createElement("div");r.classList.add("neuroglancer-tool-button"),r.appendChild(n.registerDisposer(new xg(e,t.toolJson)).element);let i=document.createElement("div");return i.classList.add("neuroglancer-tool-button-label"),i.textContent=t.label,t.title&&(i.title=t.title),r.appendChild(i),r}function Qj(n){let e=n.registerDisposer(new Ce(!1));e.element.classList.add("neuroglancer-tool-status");let t=document.createElement("div");t.classList.add("neuroglancer-tool-status-content"),e.element.appendChild(t);let{inputEventMapBinder:r}=n;return n.inputEventMapBinder=(i,a)=>{let o=document.createElement("div");o.textContent=i.describe(),o.classList.add("neuroglancer-tool-status-bindings"),e.element.appendChild(o),r(i,a)},{message:e,content:t}}function Tl(n){let{message:e,content:t}=Qj(n),r=document.createElement("div");r.classList.add("neuroglancer-tool-status-header");let i=document.createElement("div");i.classList.add("neuroglancer-tool-status-header-container"),i.appendChild(r),t.appendChild(i);let a=document.createElement("div");return a.classList.add("neuroglancer-tool-status-body"),t.appendChild(a),{message:e,body:a,header:r}}function AR(n,e){n.remove(e)}function IR(n,e){n.add(e)}var wg='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="controlsAltIconTitle"><circle cx="9" cy="6" r="2"></circle><path d="M4 6H7"></path><path d="M11 6H20"></path><circle cx="9" cy="18" r="2"></circle><path d="M4 18H7"></path><path d="M11 18H20"></path><circle cx="15" cy="12" r="2"></circle><path d="M4 12H13"></path><path d="M17 12L20 12"></path></svg>';var MR='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="layersIconTitle"><path d="M12 4L20 8.00004L12 12L4 8.00004L12 4Z"></path><path d="M20 12L12 16L4 12"></path><path d="M20 16L12 20L4 16"></path></svg>';var RR='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="listIconTitle"><path d="M10 7L18 7M10 12L18 12M10 17L18 17"></path><line x1="7" y1="7" x2="7" y2="7"></line><line x1="7" y1="12" x2="7" y2="12"></line><line x1="7" y1="17" x2="7" y2="17"></line></svg>';var _R='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="settingsIconTitle"><path d="M5.03506429,12.7050339 C5.01187484,12.4731696 5,12.2379716 5,12 C5,11.7620284 5.01187484,11.5268304 5.03506429,11.2949661 L3.20577137,9.23205081 L5.20577137,5.76794919 L7.9069713,6.32070904 C8.28729123,6.0461342 8.69629298,5.80882212 9.12862533,5.61412402 L10,3 L14,3 L14.8713747,5.61412402 C15.303707,5.80882212 15.7127088,6.0461342 16.0930287,6.32070904 L18.7942286,5.76794919 L20.7942286,9.23205081 L18.9649357,11.2949661 C18.9881252,11.5268304 19,11.7620284 19,12 C19,12.2379716 18.9881252,12.4731696 18.9649357,12.7050339 L20.7942286,14.7679492 L18.7942286,18.2320508 L16.0930287,17.679291 C15.7127088,17.9538658 15.303707,18.1911779 14.8713747,18.385876 L14,21 L10,21 L9.12862533,18.385876 C8.69629298,18.1911779 8.28729123,17.9538658 7.9069713,17.679291 L5.20577137,18.2320508 L3.20577137,14.7679492 L5.03506429,12.7050339 Z"></path><circle cx="12" cy="12" r="1"></circle></svg>';var K_=at(It());var KR=at(It());function ri(n,e){return t=>{t.style.flex=n,e(t)}}function ps(n,e){return t=>{t.style.display="flex",t.style.flexDirection=n;for(let r of e){let i=t.ownerDocument.createElement("div");t.appendChild(i),r(i)}}}var Zj=re.create();function Tg(n,e){let t=re.identity(Zj),{globalPosition:r,displayDimensionRenderInfo:{canonicalVoxelFactors:i,displayDimensionIndices:a}}=n;for(let o=0;o<3;++o){let l=a[o];t[12+o]=l===-1?0:r[l],t[5*o]=e/i[o]}return re.multiply(t,n.viewProjectionMat,t),t}var kl=class extends j{constructor(e){super();this.gl=e;this.vertexBuffer=this.registerDisposer(Nt.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));let t=.5;this.colorBuffer=this.registerDisposer(Nt.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(WP(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new kl(e))}draw(e,t=!0){let r=this.trivialColorShader,i=this.gl;r.bind(),i.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,e);let a=r.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(a,4);let o=r.attribute("aColor");this.colorBuffer.bindToVertexAttrib(o,4),t&&(i.colorMask(!1,!1,!1,!0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),i.colorMask(!0,!0,!0,!0),i.enable(i.BLEND),i.blendFunc(i.ONE_MINUS_DST_ALPHA,i.DST_ALPHA)),i.lineWidth(1),i.drawArrays(i.LINES,0,6),t&&i.disable(i.BLEND),i.disableVertexAttribArray(a),i.disableVertexAttribArray(o)}};var VR="perspective_view/PerspectiveView";var OR=!1,Ip=class{constructor(){this.renderLayers=[null];this.pickData=[null];this.values=[0,0,0];this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,r=1,i=null){return this.register(e,r,t.low,t.high,i)}register(e,t=1,r=0,i=0,a=null){let{renderLayers:o,values:l}=this,c=this.nextPickID;this.nextPickID+=t;let d=o.length;o[d]=e;let p=d*3;return l[p]=c,l[p+1]=r,l[p+2]=i,this.pickData[d]=a,c}setMouseState(e,t){let{renderLayers:r,values:i}=this,a=0,o=r.length-1;for(;a<o;){let y=Math.ceil(a+(o-a)/2);i[y*3]>t?o=y-1:a=y}let l=e.pickedRenderLayer=r[a],c=a*3,d=e.pickedOffset=t-i[c];OR&&console.log(`Looking up pick ID ${t}: renderLayer`,l,`offset=${d}`);let{pickedValue:p}=e;p.low=i[c+1],p.high=i[c+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;let m=this.pickData[a];l!==null&&(OR&&console.log(`Picked value=${p}, offset=${d}, data=${this.pickData[a]}`),l.updateMouseState(e,p,d,m))}};var fC=at(It());var fs=class{static insertAfter(n,e){let t=n.next0;e.next0=t,e.prev0=n,n.next0=e,t.prev0=e}static insertBefore(n,e){let t=n.prev0;e.prev0=t,e.next0=n,n.prev0=e,t.next0=e}static front(n){let e=n.next0;return e===n?null:e}static back(n){let e=n.prev0;return e===n?null:e}static pop(n){let e=n.next0,t=n.prev0;return e.prev0=t,t.next0=e,n.next0=null,n.prev0=null,n}static*iterator(n){for(let e=n.next0;e!==n;e=e.next0)yield e}static*reverseIterator(n){for(let e=n.prev0;e!==n;e=e.prev0)yield e}static initializeHead(n){n.next0=n.prev0=n}};var NR=class{constructor(){fs.initializeHead(this)}},hC=new NR,e5=window.top===window,mC=(0,fC.default)(()=>{if(!e5)return;let{activeElement:n}=document;if(n===null||n===document.body){let e=fs.front(hC);e!==null&&e.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{mC()},!0);window.addEventListener("blur",()=>{mC()},!0);var Co=class extends j{constructor(e){super();this.element=e;this.prev0=null;this.next0=null;this.lastFocusedElement=null;this.scheduleUpdateFocus=this.registerCancellable((0,fC.default)(()=>{let{activeElement:e}=document,{element:t}=this;t.contains(e)||Jd(e)||(e!=null&&(e===this.lastFocusedElement||e.contains(t))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0));e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),fs.insertBefore(hC,this),this.registerEventListener(e,"focus",()=>{fs.pop(this),fs.insertAfter(hC,this)}),mC()}disposed(){fs.pop(this),super.disposed()}};var BR=at(Cp());var UR=10,t5=1e3,n5=400,r5=500,i5=Math.PI/20,a5=20,o5=10;function FR(n,e){return Math.sqrt(n*n+e*e)}function GR(n){let[e,t]=n;e.identifier>t.identifier&&([t,e]=[e,t]);let r=e.clientX-t.clientX,i=e.clientY-t.clientY,a=FR(r,i),o=Math.atan2(r,i);return{distance:a,angle:o}}function s5(n,e){let t=Math.PI*2,r=Math.abs(n-e)%t;return Math.min(r,t-r)}var gC=class extends j{constructor(e,t){super();this.target=e;this.eventMap=t;this.prevTouches=new Map;this.moved=!1;this.prevAngle=0;this.rotated=!1;this.prevDistance=0;this.pinched=!1;this.prevCenterX=0;this.prevCenterY=0;this.translated=!1;this.startHold=this.registerCancellable((0,BR.default)((e,t,r,i)=>{let a={event:e,centerX:r,centerY:i};this.dispatch(`touchhold${e.targetTouches.length}`,e,a,t)},t5,{leading:!1,trailing:!0}));this.numPriorTaps=0;this.priorTapNumTouches=0;this.tapStartTime=0;this.tapEndTime=0;this.curTapNumTouches=0;this.registerEventListener(e,"touchstart",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchmove",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchend",r=>{this.handleTouchEvent(r)})}dispatch(e,t,r,i=t.eventPhase){ub(e,t,i,r,this.eventMap)}handleTouchEvent(e){if(e.target===this.target)e.preventDefault();else return;let t=new Map,{prevTouches:r,prevEvent:i}=this,a=0,o=0;for(let y of e.targetTouches)t.set(y.identifier,y),a+=y.clientX,o+=y.clientY;a/=t.size,o/=t.size;for(let[y,v]of r.entries()){let b=t.get(y);if(b===void 0)r.delete(y);else{let x=b.clientX-v.clientX,C=b.clientY-v.clientY;(Math.abs(x)>=UR||Math.abs(C)>=UR)&&(this.moved=!0)}}if(i===void 0||i.targetTouches.length!==t.size||t.size==0){if(this.moved=!1,e.type==="touchstart")this.startHold(e,e.eventPhase,a,o),(i===void 0||i.targetTouches.length===0)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if(e.type=="touchend"){let y=Date.now();if(e.targetTouches.length===0&&y-this.tapStartTime<n5){(this.curTapNumTouches!==this.priorTapNumTouches||y-this.tapEndTime>=r5)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=y,this.priorTapNumTouches=this.curTapNumTouches;let v={event:e,centerX:a,centerY:o};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,v)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=a,this.prevCenterY=o,this.translated=!1,t.size===2){let{distance:y,angle:v}=GR(t.values());this.prevDistance=y,this.prevAngle=v,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let{prevCenterX:l,prevCenterY:c,translated:d}=this,p=a-l,m=o-c;if(d===!1&&FR(p,m)>=o5&&(d=this.translated=!0),d===!0&&(p!==0||m!==0)){this.prevCenterX=a,this.prevCenterY=o;let y={event:e,deltaX:p,deltaY:m,centerX:a,centerY:o};this.dispatch(`touchtranslate${t.size}`,e,y)}if(t.size===2){let{distance:y,angle:v}=GR(t.values()),{pinched:b,rotated:x,prevDistance:C,prevAngle:k}=this;b===!1&&Math.abs(y-C)>=a5&&(this.pinched=b=!0);let D=s5(v,k);if(x===!1&&D>=i5&&(this.rotated=x=!0),b===!0&&y!=C){this.prevDistance=y;let P={event:e,distance:y,prevDistance:C,centerX:a,centerY:o};this.dispatch("touchpinch",e,P)}x===!0&&v!==k&&(this.prevAngle=v,this.dispatch("touchrotate",e,{event:e,centerX:a,centerY:o,angle:v,prevAngle:k}))}}};var l5=0,c5=1,u5=2;function Ll(n){let e=0,{deltaMode:t}=n;switch(t){case l5:e=1/200;break;case c5:e=1/10;break;case u5:e=2;break}return Math.exp(n.deltaY*e)}var yC=J.create(),vC=class{constructor(){this.pickIDs=new Ip;this.viewportWidth=0;this.viewportHeight=0;this.invTransform=re.create();this.frameNumber=-1}},SC=class{constructor(){this.buffer=null;this.glWindowX=0;this.glWindowY=0}},d5=30,ln=5,st=1+ln*2,Zc=(()=>{let n=ln**2,e=(i,a)=>(i-ln)**2+(a-ln)**2,t=new Uint32Array(st*st),r=0;for(let i=0;i<st;++i)for(let a=0;a<st;++a)e(i,a)>n||(t[r++]=a*st+i);return t=t.subarray(0,r),t.sort((i,a)=>{let o=i%st,l=(i-o)/st,c=a%st,d=(a-c)/st;return e(o,l)-e(c,d)}),t})();function kg(n,e,t,r,i,a,o){let l=r-ln,c=i-ln;if(!(l>=0&&c>=0&&l+st<=a&&c+st<=o))for(let d=0;d<st;++d)for(let p=0;p<st;++p){let m=l+p,y=c+d;(m<0||y<0||m>=a||y>=o)&&(n[e+(y*st+m)*t]=0)}}var Mp=class extends gh{constructor(e,t,r){super(e,t,r.visibility);this.viewer=r;this.mouseX=-1;this.mouseY=-1;this.pickRequestPending=!1;this.mouseStateForcer=()=>this.blockOnPickRequest();this.pickingData=[new vC,new vC];this.pickRequests=[new SC,new SC];this.pickBufferContents=new Float32Array(2*4*st*st);this.pickTimerId=-1;this.nextPickRequestTime=0;this.pendingPickRequestTimerId=-1;this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,!!this.pickRequestPending&&this.attemptToIssuePickRequest()};this.inputEventMap=r.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP!="undefined"&&NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP===!0&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new Co(t)),this.registerDisposer(new zt(t,this.inputEventMap)),this.registerDisposer(new xn(t,this.inputEventMap,i=>{this.onMousemove(i)})),this.registerDisposer(new gC(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",i=>{i.target!==t&&this.onMouseout()},!0),ce(t,"select-position",()=>{this.viewer.selectionDetailsState.select(!1)}),ce(t,"snap",()=>{this.navigationState.pose.snap()}),ce(t,"zoom-in",()=>{this.navigationState.zoomBy(.5)}),ce(t,"zoom-out",()=>{this.navigationState.zoomBy(2)}),ce(t,"depth-range-decrease",()=>{this.navigationState.depthRange.value*=.5}),ce(t,"depth-range-increase",()=>{this.navigationState.depthRange.value*=2});for(let i=0;i<3;++i){let a=iE[i];for(let o of[-1,1]){let l=o<0?"-":"+";ce(t,`rotate-relative-${a}${l}`,()=>{this.navigationState.pose.rotateRelative(Jr[i],o*.1)});let c=J.create();ce(t,`${a}${l}`,()=>{let{navigationState:d}=this,p=c;p[0]=0,p[1]=0,p[2]=0,p[i]=o,d.pose.translateVoxelsRelative(p,!0)})}}ce(t,"zoom-via-wheel",i=>{let a=i.detail;this.onMousemove(a,!1),this.zoomByMouse(Ll(a))}),ce(t,"adjust-depth-range-via-wheel",i=>{let a=i.detail;this.navigationState.depthRange.value*=Ll(a)}),ce(t,"translate-via-mouse-drag",i=>{bn(i.detail,(a,o,l)=>{this.translateByViewportPixels(o,l)})}),ce(t,"translate-in-plane-via-touchtranslate",i=>{let{detail:a}=i;this.translateByViewportPixels(a.deltaX,a.deltaY)}),ce(t,"translate-z-via-touchtranslate",i=>{let{detail:a}=i,{navigationState:o}=this,l=yC;l[0]=0,l[1]=0,l[2]=a.deltaY+a.deltaX,o.pose.translateVoxelsRelative(l,!0)});for(let i of[1,10])ce(t,`z+${i}-via-wheel`,a=>{let o=a.detail,{navigationState:l}=this,c=yC,d=o.deltaY!==0?o.deltaY:o.deltaX;c[0]=0,c[1]=0,c[2]=(d>0?-1:1)*i,l.pose.translateVoxelsRelative(c,!0)});ce(t,"move-to-mouse-position",()=>{let{mouseState:i}=this.viewer;i.updateUnconditionally()&&(this.navigationState.position.value=i.position)}),ce(t,"snap",()=>this.navigationState.pose.snap()),ce(t,"move-annotation",i=>{let{mouseState:a}=this.viewer,o=a.pickedAnnotationId,l=a.pickedAnnotationLayer;if(l!==void 0&&o!==void 0){i.stopPropagation();let c=l.source.getReference(o),d=c.value,p=Qo(d.type),m=a.pickedOffset,{chunkTransform:{value:y}}=l;if(y.error!==void 0)return;let{layerRank:v}=y,b=new Float32Array(v);p.getRepresentativePoint(b,d,a.pickedOffset);let x=vr.set(vr.create(),0,0);a.updateUnconditionally()&&bn(i.detail,(C,k,D)=>{vr.add(x,x,[k,D]);let P=new Float32Array(v);Xr(P,y.chunkToLayerTransform,v+1,b,v);let M=yC,{displayDimensionIndices:I}=this.navigationState.pose.displayDimensions.value;KE(M,P,y.modelTransform,I),this.translateDataPointByViewportPixels(M,M,x[0],x[1]),YE(P,M,y.modelTransform,I);let E=new Float32Array(v);Xr(E,y.layerToChunkTransform,v+1,P,v);let _=p.updateViaRepresentativePoint(d,E,m);l.source.update(c,_)},C=>{l.source.commit(c),c.dispose()})}}),ce(t,"delete-annotation",()=>{let{mouseState:i}=this.viewer,a=i.pickedAnnotationId,o=i.pickedAnnotationLayer;if(o!==void 0&&!o.source.readonly&&a!==void 0){let l=o.source.getReference(a);try{o.source.delete(l)}finally{l.dispose()}}}),ce(t,"zoom-via-touchpinch",i=>{let{detail:a}=i;this.handleMouseMove(a.centerX,a.centerY);let o=a.prevDistance/a.distance;o>.1&&o<10&&this.zoomByMouse(o)})}cancelPickRequests(){let{gl:e}=this;for(let t of this.pickRequests){let{sync:r}=t;r!==null&&e.deleteSync(r),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){let{gl:t}=this,{buffer:r}=e;r===null?(r=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,2*4*4*st*st,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r);let{renderViewport:i}=this,a=this.mouseX-i.visibleLeftFraction*i.logicalWidth,o=i.height-(this.mouseY-i.visibleTopFraction*i.logicalHeight);this.issuePickRequest(a,o),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=a,e.glWindowY=o,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),this.pickTimerId===-1&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;let{pickRequests:l}=this;e!==l[0]&&(l[1]=l[0],l[0]=e),this.nextPickRequestTime=Date.now()+d5}completePickInternal(e){let{gl:t}=this,{pickBufferContents:r}=this;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,r),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);let{pickingData:i}=this,{frameNumber:a}=e;this.completePickRequest(e.glWindowX,e.glWindowY,r,i[0].frameNumber===a?i[0]:i[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let r=this.context.frameNumber,i=-1;e&&(--r,i=r-1);let{pickRequests:a}=this,{gl:o}=this,l=!1,c=!1,d;for(let m of a){let{sync:y}=m;if(y===null)continue;let{frameNumber:v}=m;if(!c&&v>=r-1){if(t||o.getSyncParameter(y,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(m),c=!0;else if(v!==i){l=!0;continue}}o.deleteSync(y),m.sync=null,d=m}let{pickTimerId:p}=this;l&&p===-1?this.scheduleCheckForPickRequestCompletion():!l&&p!==-1&&(window.clearTimeout(p),this.pickTimerId=-1),!e&&d!==void 0&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(d)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){let{width:e,height:t}=this.renderViewport;this.checkForPickRequestCompletion(!0);let{pickingData:r}=this;r[0]=r[1];let i=this.context.frameNumber,a=r[1];if(a.frameNumber=i,a.viewportWidth=e,a.viewportHeight=t,a.pickIDs.clear(),!this.drawWithPicking(a)){a.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}canIssuePickRequest(){let e=Date.now(),{nextPickRequestTime:t,pendingPickRequestTimerId:r}=this;return e<t?(r==-1&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1):!0}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;let e=this.context.frameNumber,{gl:t}=this,{pickRequests:r}=this;for(let i of r){let{sync:a}=i;if(a!==null)if(i.frameNumber<e-1)t.deleteSync(a);else continue;this.issuePickRequestInternal(i);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}let r=this.context.frameNumber,i=this.pickingData[1];i.frameNumber!==r||this.renderViewport.width!==i.viewportWidth||this.renderViewport.height!==i.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){let{element:r}=this,i=r.getBoundingClientRect(),a=e-(i.left+r.clientLeft),o=t-(i.top+r.clientTop),{mouseState:l}=this.viewer;l.pageX=e+window.scrollX,l.pageY=t+window.scrollY,l.setForcer(this.mouseStateForcer),this.updateMousePosition(a,o)}onMousemove(e,t=!0){let{element:r}=this;t&&e.target!==r||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let{element:t}=this;if(e.target!==t||e.targetTouches.length!==1)return;let{clientX:r,clientY:i}=e.targetTouches[0];this.handleMouseMove(r,i)}disposed(){let{mouseState:e}=this.viewer;e.removeForcer(this.mouseStateForcer);let{gl:t}=this;this.cancelPickRequests();let{pendingPickRequestTimerId:r}=this;r!==-1&&window.clearTimeout(r);for(let i of this.pickRequests)t.deleteBuffer(i.buffer);super.disposed()}};var El=class extends j{constructor(e,t){super();this.register=e;this.changed=new ae;this.disposerMap=new Map;if(t===void 0)this.map=new Map;else{let r=this.map=new Map(t),{disposerMap:i}=this;for(let[a,o]of r){let l=new j;i.set(a,l),e(l,o,a)}}}get value(){return this.map}set(e,t){let{map:r,disposerMap:i}=this,a=i.get(e);return a!==void 0&&a.dispose(),a=new j,i.set(e,a),r.set(e,t),this.register(a,t,e),this.changed.dispatch(),this}delete(e){let{map:t,disposerMap:r}=this,i=r.get(e);return i!==void 0?(i.dispose(),r.delete(e),t.delete(e),this.changed.dispatch(),!0):!1}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Symbol.iterator](){return this.map[Symbol.iterator]()}clear(){let{map:e,disposerMap:t}=this;if(e.size>0){for(let r of t.values())r.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){let{map:e,disposerMap:t}=this;for(let r of t.values())r.dispose();e.clear(),t.clear(),super.disposed()}};var p5=[1.5,2,3,5,7.5,10];var WR=class{constructor(){this.allowedSignificands=p5;this.targetLengthInPixels=0;this.physicalSizePerPixel=0;this.prevPhysicalSizePerPixel=0;this.prevTargetLengthInPixels=0;this.prevPhysicalUnit="\0"}update(){let{physicalSizePerPixel:e,targetLengthInPixels:t}=this;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;let r=t*e,i=Math.floor(Math.log10(r)),a=10**i,o=r/a,l=1;for(let p of this.allowedSignificands)if(Math.abs(p-o)<Math.abs(l-o))l=p;else break;let c=l*a,d=eS(c);return this.lengthInPixels=Math.round(c/e),this.physicalUnit=`${d.prefix}${this.physicalBaseUnit}`,this.physicalLength=l*10**(i-d.exponent),!0}};function f5(n,e,t,r,i){let a=document.createElement("canvas"),o=a.getContext("2d"),l=i.textHeightInPixels*i.scaleFactor,c=`bold ${l}px ${i.fontName}`;o.font=c,o.fillStyle="white";let d=`${r}${n.physicalLength} ${n.physicalUnit}`,p=o.measureText(d),m=Math.max(n.lengthInPixels,p.width),y=i.barHeightInPixels*i.scaleFactor,v=i.barTopMarginInPixels*i.scaleFactor,b=y+v+l,x=i.paddingInPixels*i.scaleFactor,C=b+2*x,k=m+2*x;return a.width=k,a.height=C,o.font=c,o.textAlign="center",o.fillStyle="rgba(0, 0, 0, 0.3)",o.fillRect(0,0,k,C),o.fillStyle="white",o.fillText(d,k/2,C-x-y-v),o.fillRect(x,C-x-y,n.lengthInPixels,y),FP(e,t,a),{width:k,height:C}}var zR=class extends j{constructor(e,t=new WR){super();this.gl=e;this.dimensions=t;this.texture=null;this.width=0;this.height=0;this.label="";this.factor=1;this.priorOptions=void 0;this.prevLabel=""}update(e){let{dimensions:t,label:r}=this,{texture:i}=this;if(!t.update()&&i!==null&&e===this.priorOptions&&r==this.prevLabel)return;i===null&&(i=this.texture=this.gl.createTexture());let{width:a,height:o}=f5(t,this.gl,i,r,e);this.priorOptions=e,this.prevLabel=r,this.width=a,this.height=o}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}},Rp=class extends j{constructor(e){super();this.gl=e;this.scaleBarCopyHelper=this.registerDisposer(ba.get(this.gl));this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new zR(e)))}draw(e,t,r,i,a){let{scaleBars:o}=this,{displayRank:l,displayDimensionIndices:c,canonicalVoxelFactors:d,globalDimensionNames:p,displayDimensionUnits:m,displayDimensionScales:y}=t,{factors:v}=r,b=Math.min(a.maxWidthFraction*e.logicalWidth,a.maxWidthInPixels*a.scaleFactor),x=0;for(let P=0;P<l;++P){let M=c[P],I=m[P],E=v[M],_,O,B;for(_=0;_<x&&(O=o[_],B=O.dimensions,!(B.physicalBaseUnit===I&&O.factor===E));++_);_===x&&(++x,O=o[_],O.label="",B=O.dimensions,O.factor=E,B.physicalBaseUnit=I,B.targetLengthInPixels=b,B.physicalSizePerPixel=y[P]*i/d[P]),O.label+=`${p[M]} `}let{gl:C,scaleBarCopyHelper:k}=this,D=a.bottomPixelOffset*a.scaleFactor;for(let P=x-1;P>=0;--P){let M=o[P];x===1?M.label="":M.label+=": ",M.update(a),C.viewport(a.leftPixelOffset*a.scaleFactor-e.visibleLeftFraction*e.logicalWidth,D-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,M.width,M.height),k.draw(M.texture),D+=M.height+a.marginPixelsBetweenScaleBars*a.scaleFactor}}},h5={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2},HR={...h5,maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5};function m5(n){let e={...HR};for(let t of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])G(n,t,r=>{r!==void 0&&(e[t]=zn(r))});return G(n,"fontName",t=>{t!==void 0&&(e.fontName=ee(t))}),e}var bC=class extends ht{constructor(){super(HR,m5)}};var ii;(function(i){i[i.COLOR=0]="COLOR",i[i.Z=1]="Z",i[i.PICK=2]="PICK",i[i.NUM_TEXTURES=3]="NUM_TEXTURES"})(ii||(ii={}));var g5=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,y5=`
float computeOITWeight(float alpha) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -gl_FragCoord.z * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,v5=[y5,`
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a);
  vec4 accum = color * weight;
  v4f_fragData0 = vec4(accum.rgb, color.a);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
`];function xC(n){n.addOutputBuffer("vec4","out_color",0),n.addOutputBuffer("highp vec4","out_z",1),n.addOutputBuffer("highp vec4","out_pickId",2),n.addFragmentCode(g5)}function S5(n){n.addOutputBuffer("vec4","v4f_fragData0",0),n.addOutputBuffer("vec4","v4f_fragData1",1),n.addFragmentCode(v5)}var wo=J.create(),$R=nr.create(),b5=re.create();function x5(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}var C5=va(gn),jR=class extends C5{constructor(e){super();this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new tl(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}},_p=class extends Mp{constructor(e,t,r){super(e,t,r);this.sliceViews=this.registerDisposer(new El((e,t,r)=>{e.registerDisposer(r),e.registerDisposer(r.visibility.add(this.visibility))}));this.axesLineHelper=this.registerDisposer(kl.get(this.gl));this.sliceViewRenderHelper=this.registerDisposer(il.get(this.gl,xC));this.offscreenFramebuffer=this.registerDisposer(new Bi(this.gl,{colorBuffers:[new Sa(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new Sa(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new Sa(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new PS(this.gl)}));this.offscreenCopyHelper=this.registerDisposer(ba.get(this.gl));this.transparencyCopyHelper=this.registerDisposer(ba.get(this.gl,x5,2));this.scaleBars=this.registerDisposer(new Rp(this.gl));this.projectionParameters=this.registerDisposer(new Bd({navigationState:this.navigationState,update:(a,o)=>{let{invViewMatrix:l,projectionMat:c,logicalWidth:d,logicalHeight:p}=a,m=d/p,y=Math.PI/4,{relativeDepthRange:v}=o,x=o.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){let C=Math.max(.1,1-v),k=1+v;re.ortho(c,-m,m,-1,1,C,k)}else{let C=1/Math.tan(y/2);v/=C;let k=Math.max(.1,1-v),D=1+v;x*=C,re.perspective(c,y,m,k,D)}hh(a,c),o.pose.toMat4(l,x),re.scale(l,l,J.set(wo,1,-1,-1)),re.translate(l,l,Jr[2]),bh(a)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());let i=this.sharedObject=this.registerDisposer(new jR(this));if(i.RPC_TYPE_ID=VR,i.initializeCounterpart(r.rpc,{}),i.visibility.add(this.visibility),this.visibleLayerTracker=Lg(this.viewer.layerManager,Ur,this.viewer.visibleLayerRoles,this),ce(t,"rotate-via-mouse-drag",a=>{bn(a.detail,(o,l,c)=>{this.navigationState.pose.rotateRelative(Jr[1],l/4*Math.PI/180),this.navigationState.pose.rotateRelative(Jr[0],-c/4*Math.PI/180)})}),ce(t,"rotate-in-plane-via-touchrotate",a=>{let{detail:o}=a;this.navigationState.pose.rotateRelative(Jr[2],o.angle-o.prevAngle)}),ce(t,"rotate-out-of-plane-via-touchtranslate",a=>{let{detail:o}=a;this.navigationState.pose.rotateRelative(Jr[1],o.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(Jr[0],-o.deltaY/4*Math.PI/180)}),r.showSliceViewsCheckbox){let a=this.registerDisposer(new br(r.showSliceViews));a.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let o=document.createElement("label");o.className="perspective-panel-show-slice-views neuroglancer-noselect",o.appendChild(document.createTextNode("Sections")),o.appendChild(a.element),this.element.appendChild(o)}this.registerDisposer(r.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(r.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){let r=wo,{viewProjectionMat:i,invViewProjectionMat:a,logicalWidth:o,logicalHeight:l}=this.projectionParameters.value,{pose:c}=this.viewer.navigationState;c.updateDisplayPosition(d=>{J.transformMat4(r,d,i),r[0]+=-2*e/o,r[1]+=2*t/l,J.transformMat4(d,r,a)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(let[o,l]of this.sliceViews)if((l||this.viewer.showSliceViews.value)&&!o.isReady())return!1;this.ensureBoundsUpdated();let{width:e,height:t}=this.renderViewport;if(e===0||t===0)return!0;let i={projectionParameters:this.projectionParameters.value},{visibleLayers:a}=this.visibleLayerTracker;for(let[o,l]of a)if(!o.isReady(i,l))return!1;return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;let{offscreenFramebuffer:e,renderViewport:{width:t,height:r}}=this,i=t*r,a=new Float32Array(i*4);try{e.bindSingle(1),this.gl.readPixels(0,0,t,r,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,a)}finally{e.framebuffer.unbind()}let o=new Float32Array(i);for(let l=0;l<i;++l)o[l]=a[l*4];return o}issuePickRequest(e,t){let{offscreenFramebuffer:r}=this;r.readPixelFloat32IntoBuffer(1,e-ln,t-ln,0,st,st),r.readPixelFloat32IntoBuffer(2,e-ln,t-ln,4*4*st*st,st,st)}completePickRequest(e,t,r,i){let{mouseState:a}=this.viewer;a.pickedRenderLayer=null,kg(r,0,4,e,t,i.viewportWidth,i.viewportHeight);let o=Zc.length;for(let l=0;l<o;++l){let c=Zc[l],d=r[4*c];if(d===0)continue;let p=c%st,m=(c-p)/st,y=1-d;wo[0]=2*(e+p-ln)/i.viewportWidth-1,wo[1]=2*(t+m-ln)/i.viewportHeight-1,wo[2]=2*y-1,J.transformMat4(wo,wo,i.invTransform);let{position:v,unsnappedPosition:b}=a,{value:x}=this.navigationState.position,C=x.length;v.length!==C&&(v=a.position=new Float32Array(C)),b.length!==C&&(b=a.unsnappedPosition=new Float32Array(C)),v.set(x),a.coordinateSpace=this.navigationState.coordinateSpace.value;let k=this.navigationState.pose.displayDimensions.value,{displayDimensionIndices:D}=k;for(let M=0,I=D.length;M<I;++M)v[D[M]]=wo[M];b.set(v);let P=r[4*st*st+4*c];i.pickIDs.setMouseState(a,P),a.displayDimensions=k,a.setActive(!0);return}a.setActive(!1)}translateDataPointByViewportPixels(e,t,r,i){let a=wo,{viewProjectionMat:o,invViewProjectionMat:l,width:c,height:d}=this.projectionParameters.value;return J.transformMat4(a,t,o),a[0]+=2*r/c,a[1]+=-2*i/d,J.transformMat4(e,a,l)}get transparentConfiguration(){let e=this.transparentConfiguration_;return e===void 0&&(e=this.transparentConfiguration_=this.registerDisposer(new Bi(this.gl,{colorBuffers:Ks(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;let{width:t,height:r}=this.renderViewport,i=this.viewer.showSliceViews.value;for(let[x,C]of this.sliceViews)(C||i)&&x.updateRendering();let a=this.gl;this.offscreenFramebuffer.bind(t,r),a.disable(a.SCISSOR_TEST),a.enable(WebGL2RenderingContext.STENCIL_TEST),a.stencilMask(4294967295),a.clearStencil(0),a.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),a.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);let o=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(o[0],o[1],o[2],0),a.clear(a.DEPTH_BUFFER_BIT),a.clearBufferfv(WebGL2RenderingContext.COLOR,0,[o[0],o[1],o[2],0]),a.clearBufferfv(WebGL2RenderingContext.COLOR,1,ld),a.clearBufferfv(WebGL2RenderingContext.COLOR,2,ld),a.enable(a.DEPTH_TEST);let l=this.projectionParameters.value,c=J.create();J.transformQuat(c,Jr[2],this.navigationState.pose.orientation.orientation),J.scale(c,c,-1);let d=.2,p=1-d,m={wireFrame:this.viewer.wireFrame.value,projectionParameters:l,lightDirection:c,ambientLighting:d,directionalLighting:p,pickIDs:e.pickIDs,emitter:xC,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1};re.copy(e.invTransform,l.invViewProjectionMat);let{visibleLayers:y}=this.visibleLayerTracker,v=!1,b=!1;for(let[x,C]of y)x.isTransparent?v=!0:x.isAnnotation?b=!0:x.draw(m,C);if(this.drawSliceViews(m),b){a.enable(WebGL2RenderingContext.BLEND),a.depthFunc(WebGL2RenderingContext.LEQUAL),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(let[x,C]of y)x.isAnnotation&&x.draw(m,C);a.depthFunc(WebGL2RenderingContext.LESS),a.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),v){a.depthMask(!1),a.enable(WebGL2RenderingContext.BLEND);let{transparentConfiguration:x}=this;x.bind(t,r),this.gl.clearColor(0,0,0,1),a.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),m.emitter=S5,a.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),m.emitPickID=!1;for(let[C,k]of y)C.isTransparent&&C.draw(m,k);a.disable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bindSingle(0),a.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.transparencyCopyHelper.draw(x.colorBuffers[0].texture,x.colorBuffers[1].texture),a.depthMask(!0),a.disable(WebGL2RenderingContext.BLEND),a.enable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bind(t,r),a.enable(WebGL2RenderingContext.STENCIL_TEST),a.drawBuffers([a.NONE,a.COLOR_ATTACHMENT1,a.COLOR_ATTACHMENT2]),m.emitter=xC,m.emitPickID=!0,m.emitColor=!1,a.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),a.stencilMask(2);for(let[C,k]of y)!C.isTransparent||!C.transparentPickEnabled||C.draw(m,k);a.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),a.stencilMask(0);for(let[C,k]of y)!C.isTransparent||C.transparentPickEnabled||C.draw(m,k)}if(a.stencilMask(4294967295),a.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){a.drawBuffers([a.COLOR_ATTACHMENT0]),a.disable(WebGL2RenderingContext.DEPTH_TEST),a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);let{scaleBars:x}=this,C=this.viewer.scaleBarOptions.value;x.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,C),a.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}drawSliceViews(e){let{sliceViewRenderHelper:t}=this,{lightDirection:r,ambientLighting:i,directionalLighting:a,projectionParameters:{viewProjectionMat:o}}=e,l=this.viewer.showSliceViews.value;for(let[c,d]of this.sliceViews){if(!d&&!l)continue;let{width:p,height:m,invViewMatrix:y,viewportNormalInCanonicalCoordinates:v}=c.projectionParameters.value;if(p===0||m===0||!c.valid)continue;let b=Math.abs(J.dot(r,v)),x=i+b*a,C=b5;re.identity(C),C[0]=p/2,C[5]=-m/2,re.multiply(C,y,C),re.multiply(C,o,C);let k=$R,D=this.viewer.crossSectionBackgroundColor.value;k[0]=D[0],k[1]=D[1],k[2]=D[2],k[3]=1,t.draw(c.offscreenFramebuffer.colorBuffers[0].texture,C,nr.fromValues(x,x,x,1),$R,0,0,1,1)}}drawAxisLines(){let{zoomFactor:{value:e}}=this.viewer.navigationState,t=this.projectionParameters.value,r=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,i=e*r,{gl:a}=this;a.drawBuffers([a.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(Tg(t,i),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}};var eu;(function(r){r[r.COLOR=0]="COLOR",r[r.PICK=1]="PICK",r[r.NUM_TEXTURES=2]="NUM_TEXTURES"})(eu||(eu={}));function w5(n){n.addOutputBuffer("vec4","out_fragColor",0),n.addOutputBuffer("highp vec4","out_pickId",1),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function T5(n){n.addOutputBuffer("vec4","out_fragColor",null),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}var Pl=J.create(),k5=J.create(),L5=nr.create(),tu=class extends Mp{constructor(e,t,r,i){super(e,t,i);this.sliceView=r;this.axesLineHelper=this.registerDisposer(kl.get(this.gl));this.sliceViewRenderHelper=this.registerDisposer(il.get(this.gl,T5));this.colorFactor=nr.fromValues(1,1,1,1);this.pickIDs=new Ip;this.offscreenFramebuffer=this.registerDisposer(new Bi(this.gl,{colorBuffers:[new Sa(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new Sa(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]}));this.offscreenCopyHelper=this.registerDisposer(ba.get(this.gl));this.scaleBars=this.registerDisposer(new Rp(this.gl));i.wireFrame.changed.add(()=>this.scheduleRedraw()),ce(t,"rotate-via-mouse-drag",a=>{let{mouseState:o}=this.viewer;if(o.updateUnconditionally()){let l=Float32Array.from(o.position);bn(a.detail,(c,d,p)=>{let{pose:m}=this.navigationState,y=J.transformQuat(Pl,Jr[0],m.orientation.orientation),v=J.transformQuat(k5,Jr[1],m.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(v,-d/4*Math.PI/180,l),this.viewer.navigationState.pose.rotateAbsolute(y,-p/4*Math.PI/180,l)})}}),ce(t,"rotate-in-plane-via-touchrotate",a=>{let{detail:o}=a,{mouseState:l}=this.viewer;this.handleMouseMove(o.centerX,o.centerY),l.updateUnconditionally()&&this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,o.angle-o.prevAngle,l.position)}),this.registerDisposer(r),this.visibleLayerTracker=Lg(this.viewer.layerManager,pi,this.viewer.visibleLayerRoles,this),this.registerDisposer(i.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.visibility.add(this.visibility)),this.registerDisposer(r.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(i.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(i.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(i.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){let{pose:r}=this.viewer.navigationState;r.updateDisplayPosition(i=>{J.set(i,-e,-t,0),J.transformMat4(i,i,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,r,i){let a=this.sliceView.projectionParameters.value;return J.transformMat4(e,t,a.viewMatrix),J.set(e,e[0]+r,e[1]+i,e[2]),J.transformMat4(e,e,a.invViewMatrix),e}isReady(){if(!this.visible)return!1;let{sliceView:e}=this;if(this.ensureBoundsUpdated(),!e.isReady())return!1;let t={projectionParameters:e.projectionParameters.value,sliceView:e};for(let[r,i]of this.visibleLayerTracker.visibleLayers)if(!r.isReady(t,i))return!1;return!0}drawWithPicking(e){let{sliceView:t}=this;if(!t.valid)return!1;t.updateRendering();let r=t.projectionParameters.value,{width:i,height:a,invViewProjectionMat:o}=r;re.copy(e.invTransform,o);let{gl:l}=this;this.offscreenFramebuffer.bind(i,a),l.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let c=L5,d=this.viewer.crossSectionBackgroundColor.value;c[0]=d[0],c[1]=d[1],c[2]=d[2],c[3]=1,this.offscreenFramebuffer.bindSingle(0),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,qf,this.colorFactor,c,0,0,1,1);let{visibleLayers:p}=this.visibleLayerTracker,{pickIDs:m}=this;m.clear();let y={wireFrame:this.viewer.wireFrame.value,projectionParameters:r,pickIDs:m,emitter:w5,emitColor:!0,emitPickID:!0,sliceView:t};this.offscreenFramebuffer.bind(i,a),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(let[v,b]of p)v.draw(y,b);if(l.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(0),this.viewer.showAxisLines.value){let v=Math.min(r.logicalWidth,r.logicalHeight)/4*1.5,{zoomFactor:{value:b}}=this.viewer.navigationState;this.axesLineHelper.draw(lE(Tg(r,v*b)))}this.viewer.showScaleBar.value&&(l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(r,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),l.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){let{offscreenFramebuffer:r}=this;r.readPixelFloat32IntoBuffer(1,e-ln,t-ln,0,st,st)}completePickRequest(e,t,r,i){let{mouseState:a}=this.viewer;a.pickedRenderLayer=null,kg(r,0,4,e,t,i.viewportWidth,i.viewportHeight);let{viewportWidth:o,viewportHeight:l}=i,c=Zc.length,{value:d}=this.navigationState.position,p=d.length,m=this.navigationState.pose.displayDimensions.value,{displayRank:y,displayDimensionIndices:v}=m,b=(k,D,P)=>{let M=e+k,I=t+D;Pl[0]=2*M/o-1,Pl[1]=2*I/l-1,Pl[2]=0,J.transformMat4(Pl,Pl,i.invTransform),P.set(d);for(let E=0;E<y;++E)P[v[E]]=Pl[E]},{unsnappedPosition:x}=a;x.length!==p&&(x=a.unsnappedPosition=new Float32Array(p)),a.coordinateSpace=this.navigationState.coordinateSpace.value,a.displayDimensions=m,b(0,0,x);let C=(k,D,P)=>{let{position:M}=a;M.length!==p&&(M=a.position=new Float32Array(p)),b(k-ln,D-ln,M),this.pickIDs.setMouseState(a,P),a.setActive(!0)};for(let k=0;k<c;++k){let D=Zc[k],P=r[4*k];if(P===0)continue;let M=D%st,I=(D-M)/st;C(M,I,P);return}C(ln,ln,0)}zoomByMouse(e){let{navigationState:t}=this;if(!t.valid)return;let{sliceView:r}=this,{width:i,height:a,invViewMatrix:o,displayDimensionRenderInfo:{displayDimensionIndices:l,displayRank:c}}=r.projectionParameters.value,{mouseX:d,mouseY:p}=this;d-=i/2,p-=a/2;let m=this.navigationState.position.value;for(let y=0;y<c;++y){let v=l[y],b=o[y]*d+o[4+y]*p;m[v]+=b*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}};var qR=at(It());function Eg(n,e){let t="";for(let r=0;r<=e&&(t=n.toFixed(r),parseFloat(t)!==n);++r);return t}var E5=["#f00","#0f0","#00f"],JR=Oe.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function P5(n){if(n<1||n>1024){let e=Math.log2(n)|0,t=n/2**e;return`${Eg(t,1)}p${e}`}return n.toString()}var D5=[n=>n.name,n=>n.scaleFactor],A5=2e3,CC=class extends j{constructor(e,t,r,i="px"){super();this.displayDimensionRenderInfo=e;this.zoom=t;this.depthRange=r;this.displayUnit=i;this.element=document.createElement("div");this.dimensionGridContainer=document.createElement("div");this.depthGridContainer=document.createElement("div");this.defaultCheckbox=document.createElement("input");this.dimensionElements=Array.from(Array(3),(e,t)=>{let r=document.createElement("div");r.classList.add("neuroglancer-display-dimensions-widget-dimension"),r.style.display="contents",ce(r,"adjust-via-wheel",d=>{let p=d.detail,{deltaY:m}=p;m!==0&&this.zoomDimension(t,Math.sign(m))});let i=document.createElement("input");i.classList.add("neuroglancer-display-dimensions-widget-name"),i.title="Change display dimensions",i.spellcheck=!1,i.autocomplete="off",i.style.color=E5[t],i.style.gridColumn="1",i.style.gridRow=`${t+1}`,i.addEventListener("focus",()=>{i.select()}),r.appendChild(i);let a=document.createElement("span");a.classList.add("neuroglancer-display-dimensions-widget-scale-factor");let o=document.createElement("input");o.spellcheck=!1,o.title="Change relative scale at which dimension is displayed",o.autocomplete="off",a.style.gridColumn="2",a.style.gridRow=`${t+1}`,o.addEventListener("focus",()=>{o.select()}),a.appendChild(o),r.appendChild(a);let l=document.createElement("span");l.classList.add("neuroglancer-display-dimensions-widget-scale"),l.style.gridColumn="3",l.style.gridRow=`${t+1}`,r.appendChild(l),this.dimensionGridContainer.appendChild(r);let c={name:i,container:r,scaleFactor:o,scale:l,scaleFactorModified:!1};i.addEventListener("input",()=>{Sn(i),this.updateNameValidity()}),ce(i,"commit",()=>{this.updateNames()}),i.addEventListener("blur",d=>{let{relatedTarget:p}=d;this.dimensionElements.some(m=>m.name===p)||this.updateNames()||this.updateView()}),a.addEventListener("click",d=>{let{target:p}=d;p!==o&&(o.focus(),d.preventDefault())}),o.addEventListener("input",()=>{Sn(o),c.scaleFactorModified=!0}),ce(o,"commit",()=>{this.updateScaleFactors()}),o.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()});for(let d of D5)ce(d(c),"move-up",()=>{t!==0&&d(this.dimensionElements[t-1]).focus()}),ce(d(c),"move-down",()=>{t!==2&&d(this.dimensionElements[t+1]).focus()});return c});this.scheduleUpdateView=Ge(()=>this.updateView());let{element:a,dimensionGridContainer:o,defaultCheckbox:l}=this,c=document.createElement("label"),d=this.registerCancellable((0,qR.default)(()=>{a.dataset.active="false"},A5)),p=()=>{a.dataset.active="true",d()};this.registerDisposer(t.changed.add(p)),this.registerDisposer(e.relativeDisplayScales.changed.add(p)),this.registerDisposer(r.changed.add(p)),a.classList.add("neuroglancer-display-dimensions-widget"),a.appendChild(o),o.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),a.addEventListener("pointerleave",()=>{let x=document.activeElement;x instanceof HTMLElement&&a.contains(x)&&x.blur()}),l.type="checkbox",c.appendChild(l),c.appendChild(document.createTextNode("Default")),c.title="Display first 3 dimensions",c.classList.add("neuroglancer-display-dimensions-widget-default"),l.addEventListener("change",()=>{this.updateDefault()}),o.appendChild(c),this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));let m=this.registerDisposer(new zt(a,JR));m.allShortcutsAreGlobal=!0,this.registerDisposer(new xn(a,JR)),ce(o,"cancel",()=>{this.updateView();let x=document.activeElement;x instanceof HTMLElement&&a.contains(x)&&x.blur()});let{depthGridContainer:y}=this;y.classList.add("neuroglancer-depth-range-widget-grid"),a.appendChild(y);let v=document.createElement("label"),b=document.createElement("input");b.type="checkbox",v.classList.add("neuroglancer-depth-range-relative-checkbox-label"),b.classList.add("neuroglancer-depth-range-relative-checkbox"),v.appendChild(b),v.appendChild(document.createTextNode("Zoom-relative")),b.addEventListener("change",()=>{let x=b.checked,C=this.depthRange.value;x!==C<0&&(x?C=-C/this.zoom.value:C=-C*this.zoom.value,this.depthRange.value=C)}),v.title="Depth range is multiplied by scale",a.appendChild(v),ce(y,"adjust-via-wheel",x=>{let C=x.detail,{deltaY:k}=C;if(k===0)return;let D=this.depthRange.value;this.depthRange.value=D*2**Math.sign(k)}),this.registerDisposer(Dn((x,C,{factors:k})=>{_e(y);let{displayRank:D,globalDimensionNames:P,displayDimensionIndices:M,displayDimensionUnits:I,displayDimensionScales:E,canonicalVoxelFactors:_}=C,O=[],B=()=>{b.checked=this.depthRange.value<0;let U=this.depthRange.value;U<0&&(U*=-this.zoom.value);for(let N of O){let{input:q}=N;q.value=_i(U*N.scale,N.unit,{precision:2,elide1:!1}),Sn(q)}},W=U=>{let N=jo(U.input.value);if(N===void 0||N.unit!==U.unit)return!1;let q=N.scale/U.scale;return this.depthRange.value<0&&(q=-q/this.zoom.value),this.depthRange.value=q,!0};for(let U=0;U<D;++U){let N=M[U],q=P[N],ne=I[U],pe=k[N],me=O.find(Pe=>Pe.unit===ne&&Pe.factor===pe);if(me===void 0){let Pe=document.createElement("div");Pe.title="Visible depth range",Pe.style.display="contents",y.appendChild(Pe);let se=document.createElement("span");se.textContent="\xB1",Pe.appendChild(se);let Te=document.createElement("input");Te.spellcheck=!1,Te.autocomplete="off",Te.addEventListener("focus",()=>{Te.select()}),ce(Te,"commit",()=>{W(me)}),Te.addEventListener("change",()=>{W(me)||B()}),Te.addEventListener("input",()=>{Sn(Te)}),Pe.appendChild(Te);let Ae=document.createElement("span");Ae.classList.add("neuroglancer-depth-range-widget-dimension-names"),Pe.appendChild(Ae),me={unit:ne,factor:pe,dimensionNames:[],input:Te,label:Ae,scale:E[U]/_[U]},O.push(me)}me.dimensionNames.push(q)}for(let U of O)U.dimensionNames.length!==D&&(U.label.textContent=U.dimensionNames.join(" "));x.registerDisposer(ce(y,"cancel",()=>{B();let U=document.activeElement;U instanceof HTMLElement&&y.contains(U)&&U.blur()}));let V=x.registerCancellable(Ge(B));x.registerDisposer(this.depthRange.changed.add(V)),x.registerDisposer(this.zoom.changed.add(V)),B()},e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();let{displayDimensions:r}=this,{relativeDisplayScales:i}=this,{displayDimensionIndices:a}=r.value,o=a[e];if(o===-1)return;let{factors:l}=i.value,c=new Float64Array(l);c[o]*=2**-t,i.setFactors(c)}updateNameValidity(){let{dimensionElements:e}=this,{displayDimensionIndices:t}=this.displayDimensions.value,r=e.map(c=>c.name.value),i=wd(r),a=this.displayDimensions.coordinateSpace.value,{names:o}=a,l=r.length;for(let c=0;c<l;++c){let d=i[c],p=r[c],m=-1;p.length===0?d=!0:(m=o.indexOf(p),m===-1&&(d=!1));let y=e[c];y.name.dataset.isValid=d.toString(),y.container.dataset.isModified=(m!==t[c]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){let e=this.dimensionElements.map(l=>l.name.value).filter(l=>l.length>0);if(!yc(e))return!1;let{displayDimensions:t}=this.displayDimensionRenderInfo;if(e.length===0)return t.reset(),!0;let r=new Int32Array(3);r.fill(-1);let i=t.coordinateSpace.value,{names:a}=i,o=e.length;for(let l=0;l<o;++l){let c=a.indexOf(e[l]);if(c===-1)return!1;r[l]=c}return we(r,t.value.displayDimensionIndices)||t.setDimensionIndices(o,r),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){let{displayDimensions:e}=this,{relativeDisplayScales:t}=this,{displayDimensionIndices:r,displayRank:i}=e.value,{factors:a}=t.value,{dimensionElements:o}=this,l=new Float64Array(a);for(let c=0;c<i;++c){let d=o[c];if(!d.scaleFactorModified)continue;let p=Number(d.scaleFactor.value),m=r[c];!Number.isFinite(p)||p<=0||(l[m]=p)}return we(l,a)||t.setFactors(l),!0}updateView(){let{dimensionElements:e,displayDimensions:{default:t}}=this,{displayDimensionIndices:r,canonicalVoxelFactors:i,displayDimensionUnits:a,displayDimensionScales:o,globalDimensionNames:l}=this.displayDimensionRenderInfo.value,{factors:c}=this.relativeDisplayScales.value;this.defaultCheckbox.checked=t;let d=this.zoom.value,p=r[0],m=!0;if(p!==-1){let y=a[0],v=c[p];for(let b=1;b<3;++b){let x=r[b];if(x!==-1&&(a[b]!==y||c[x]!==v)){m=!1;break}}}for(let y=0;y<3;++y){let v=r[y],b=e[y];if(delete b.name.dataset.isValid,b.container.dataset.isModified=(v===-1).toString(),v===-1)b.name.value="",b.scale.textContent="",b.scaleFactor.value="";else{b.name.value=l[v];let x=o[y]*d/i[y];if(y===0||!m){let C=_i(x,a[y],{precision:2,elide1:!1});b.scale.textContent=`${C}/${this.displayUnit}`}else b.scale.textContent="";b.scaleFactor.value=P5(c[v])}Sn(b.name),Sn(b.scaleFactor)}}disposed(){Xe(this.element),super.disposed()}};var YR=new Map([["xy",void 0],["xz",qe.rotateX(qe.create(),qe.create(),Math.PI/2)],["yz",qe.rotateY(qe.create(),qe.create(),Math.PI/2)]]),XR="\u25FB",wC=new Map([["4panel","\u25F1"],["3d",XR]]);function I5(n,e){let t;return e===void 0?t=n.navigationState.addRef():t=new Ua(new Ba(n.navigationState.pose.position.addRef(),n.navigationState.pose.displayDimensionRenderInfo.addRef(),bo.makeRelative(n.navigationState.pose.orientation,e)),n.navigationState.zoomFactor.addRef(),n.navigationState.depthRange.addRef()),new Ec(n.chunkManager,n.layerManager,t,n.wireFrame)}function Vp(n,e){return I5(n,YR.get(e))}function M5(n){return new Map([["xy",Vp(n,"xy")],["xz",Vp(n,"xz")],["yz",Vp(n,"yz")]])}function QR(n){return{crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor,selectionDetailsState:n.selectionDetailsState,mouseState:n.mouseState,layerManager:n.layerManager,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,visibleLayerRoles:n.visibleLayerRoles,selectedLayer:n.selectedLayer,visibility:n.visibility,scaleBarOptions:n.scaleBarOptions}}function TC(n){let{viewer:e}=n;return{...QR(e),navigationState:e.perspectiveNavigationState,inputEventMap:e.inputEventBindings.perspectiveView,orthographicProjection:n.specification.orthographicProjection,showScaleBar:e.showScaleBar,rpc:e.chunkManager.rpc}}function Pg(n){return{...QR(n),navigationState:n.navigationState,inputEventMap:n.inputEventBindings.sliceView}}function nu(n,e){let{navigationState:t}=e;e.element.appendChild(n.registerDisposer(new CC(t.pose.displayDimensionRenderInfo.addRef(),t.zoomFactor,t.depthRange.addRef(),e instanceof tu?"px":"vh")).element)}function ru(n,e,t){let r=document.createElement("div");r.className="neuroglancer-data-panel-layout-controls",n.registerDisposer(()=>Xe(r));for(let i=0;i<2;++i){let a=t[Math.min(t.length-1,i)];n.registerDisposer(ce(e.element,i===0?"toggle-layout":"toggle-layout-alternative",o=>{n.container.name=a,o.stopPropagation()}))}for(let i of t){let a=document.createElement("button"),o=document.createElement("div");a.appendChild(o),o.textContent=wC.get(i),a.title=`Switch to ${i} layout.`,a.addEventListener("click",()=>{n.container.name=i}),r.appendChild(a)}e.element.appendChild(r)}function R5(n,e){let t=new Ec(n.chunkManager,n.layerManager,e.navigationState.addRef(),n.wireFrame),r=()=>{let{width:{value:i},height:{value:a}}=e;t.projectionParameters.setViewport({width:i,height:a,logicalWidth:i,logicalHeight:a,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return t.registerDisposer(e.width.changed.add(r)),t.registerDisposer(e.height.changed.add(r)),r(),t}function kC(n,e,t){let r=new Map;(()=>{let a=new Set;for(let o of t.values()){if(a.add(o),r.has(o))continue;let l=R5(n,o);e.sliceViews.set(l,!0),r.set(o,l)}for(let[o,l]of r)a.has(o)||e.sliceViews.delete(l)})()}var ZR=class extends j{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a=M5(r),{display:o}=r,l={...TC(e),showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},c={...Pg(r),showScaleBar:r.showScaleBar},d={...Pg(r),showScaleBar:new xt(!1,!1)},p=(y,v,b,x)=>{let C=this.registerDisposer(new tu(o,v,a.get(y),b));return x&&nu(this,C),ru(this,C,[y,`${y}-3d`]),C},m=[ri(1,ps("column",[ri(1,ps("row",[ri(1,y=>{p("xy",y,c,!0)}),ri(1,y=>{p("xz",y,d,!1)})])),ri(1,ps("row",[ri(1,y=>{let v=this.registerDisposer(new _p(o,y,l));for(let b of a.values())v.sliceViews.set(b.addRef(),!1);nu(this,v),kC(r,v,i),ru(this,v,["3d"])}),ri(1,y=>{p("yz",y,d,!1)})]))]))];ps("row",m)(t)}disposed(){_e(this.rootElement),super.disposed()}},e_=class extends j{constructor(e,t,r,i,a,o){super();this.container=e;this.rootElement=t;this.viewer=r;this.direction=i;let l=Vp(r,a),{display:c}=r,d={...TC(e),showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},p={...Pg(r),showScaleBar:r.showScaleBar};ri(1,ps(i,[ri(1,m=>{let y=this.registerDisposer(new tu(c,m,l,p));nu(this,y),ru(this,y,[a,"4panel"])}),ri(1,m=>{let y=this.registerDisposer(new _p(c,m,d));y.sliceViews.set(l.addRef(),!1),kC(r,y,o),nu(this,y),ru(this,y,["3d","4panel"])})]))(t)}disposed(){_e(this.rootElement),super.disposed()}},t_=class extends j{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a=Vp(r,i),o={...Pg(r),showScaleBar:r.showScaleBar};ps("row",[ri(1,l=>{let c=this.registerDisposer(new tu(r.display,l,a,o));nu(this,c),ru(this,c,["4panel",`${i}-3d`])})])(t)}disposed(){_e(this.rootElement),super.disposed()}},n_=class extends j{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a={...TC(e),showSliceViews:new xt(!1,!1)};ps("row",[ri(1,o=>{let l=this.registerDisposer(new _p(r.display,o,a));kC(r,l,i),nu(this,l),ru(this,l,["4panel"])})])(t)}disposed(){_e(this.rootElement),super.disposed()}},LC=new Map([["4panel",{factory:(n,e,t,r)=>new ZR(n,e,t,r)}],["3d",{factory:(n,e,t,r)=>new n_(n,e,t,r)}]]);for(let n of YR.keys()){LC.set(n,{factory:(t,r,i)=>new t_(t,r,i,n)});let e=`${n}-3d`;wC.set(n,XR),wC.set(e,"\u25EB"),LC.set(e,{factory:(t,r,i,a)=>new e_(t,r,i,"row",n,a)})}function r_(n){let e=LC.get(n);if(e===void 0)throw new Error(`Invalid layout name: ${JSON.stringify(n)}.`);return e}function _5(n){return r_(n),n}var i_=class extends j{constructor(e){super();this.width=new ht(1e3,wt);this.height=new ht(1e3,wt);this.changed=new ae;this.position=new Tp(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new Kc(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new Yc(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new Ua(new Ba(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){Q(e),an(e,"width",this.width),an(e,"height",this.height),an(e,"position",xl(this.position)),an(e,"orientation",this.orientation),an(e,"scale",this.scale),an(e,"zoom",xl(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}},a_=class extends El{constructor(e){super((t,r)=>t.registerDisposer(t.registerDisposer(r).changed.add(this.changed.dispatch)));this.parentNavigationState=e;this.registerDisposer(e)}restoreState(e){Q(e);for(let t of Object.keys(e)){let r=new i_(this.parentNavigationState);try{this.set(t,r.addRef()),r.restoreState(e[t])}finally{r.dispose()}}}reset(){this.clear()}toJSON(){if(this.size===0)return;let e={};for(let[t,r]of this)e[t]=r.toJSON();return e}},o_=class extends j{constructor(e,t){super();this.changed=new ae;this.orthographicProjection=new xt(!1);this.type=new ht(t,_5),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new a_(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),typeof e=="string"?this.type.restoreState(e):(Q(e),G(e,"type",t=>this.type.restoreState(t)),G(e,"orthographicProjection",t=>this.orthographicProjection.restoreState(t)),G(e,"crossSections",t=>t!==void 0&&this.crossSections.restoreState(t)))}toJSON(){let{type:e,crossSections:t,orthographicProjection:r}=this,i=r.toJSON();return t.size===0&&i===void 0?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:i}}},EC=class extends j{constructor(e,t){super();this.viewer=e;this.element=document.createElement("div");this.specification=this.registerDisposer(new o_(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";let r=this.registerCancellable((0,KR.default)(()=>this.updateLayout(),0));this.specification.type.changed.add(r),ce(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>r.flush())),r()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let{layout:e}=this;e!==void 0&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=r_(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}};var s_=typeof STATE_SERVERS!="undefined"&&Object.keys(STATE_SERVERS).length>0,PC=class extends j{constructor(e){super();this.element=document.createElement("div");this.button=$e({text:"Share",title:"Share State"});if(typeof STATE_SERVERS=="undefined")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(Object.keys(STATE_SERVERS).length>1){let t=document.createElement("select");t.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{let r=e.selectedStateServer.value;Object.values(STATE_SERVERS).map(i=>i.url).includes(r)&&(t.value=r)})),this.registerEventListener(t,"change",()=>{e.selectedStateServer.value=t.value});for(let[r,i]of Object.entries(STATE_SERVERS)){let a=document.createElement("option");a.textContent=r,a.value=i.url,a.selected=!!i.default,t.appendChild(a)}this.element.appendChild(t),this.selectStateServerElement=t}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{let t=this.selectStateServerElement?this.selectStateServerElement.value:Object.values(STATE_SERVERS)[0].url,r=new URL(t).protocol,{url:i,credentialsProvider:a}=wn(t,Nn);Ce.forPromise(cr(a,i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.state.toJSON())},ut).then(o=>{let l=new URL(o);l.protocol=r;let c=`${window.location.origin}/#!${l}`;navigator.clipboard.writeText(c).then(()=>{Ce.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{Ce.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${t}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}};function V5(n){return n.startsWith("key")?n.substring(3):n.startsWith("digit")||n.startsWith("arrow")?n.substring(5):n}function O5(n){return n.split("+").map(V5).join("+")}var N5={...yi,side:"left",row:1},DC=class{constructor(){this.location=new sr(N5)}get changed(){return this.location.changed}toJSON(){return Mi(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}},AC=class extends Fr{constructor(e,t,r,i,a){super(e,t.location);this.bindings=r;this.toolBinder=a;this.scroll=document.createElement("div");this.addTitleBar({title:"Help"});let o=document.createElement("div");o.classList.add("neuroglancer-help-body");let{scroll:l}=this;l.classList.add("neuroglancer-help-scroll-container"),o.appendChild(l),this.addBody(o);let c=this.registerCancellable(Ge(()=>this.updateView()));this.registerDisposer(a.changed.add(c)),this.registerDisposer(i.layersChanged.add(c)),this.updateView()}updateView(){let{scroll:e,bindings:t,toolBinder:r}=this;_e(e);let i=new Map;function a(p,m){for(let y of p.parents)y.label!==void 0?o(y.label,y):a(y,m);for(let[y,v]of p.bindings.entries()){let b=y.indexOf(":"),x=y.substring(b+1);m.set(x,v.action)}}function o(p,m){if(i.has(m))return;let y={label:p,entries:new Map};a(m,y.entries),i.set(m,y)}for(let[p,m]of t)o(p,m);let l=(p,m)=>{let y=document.createElement("h2");y.textContent=p,e.appendChild(y);for(let[v,b]of m){let x=document.createElement("div");x.className="dt",x.textContent=O5(v);let C=document.createElement("div");C.className="dd",C.textContent=b,e.appendChild(x),e.appendChild(C)}},c=new Map;for(let[p,m]of r.bindings){let y=c.get(m.layer);y===void 0&&(y=[],c.set(m.layer,y)),y.push([`shift+key${p.toLowerCase()}`,m.description])}let d=Array.from(c.entries());d.length>0&&(d[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),d.sort((p,m)=>p[0].managedLayer.nonArchivedLayerIndex-m[0].managedLayer.nonArchivedLayerIndex));for(let[p,m]of d)m.sort(),l(`Tool bindings for layer ${p.managedLayer.nonArchivedLayerIndex+1}: ${p.managedLayer.name}`,m);for(let p of i.values())l(p.label,p.entries)}};var HC=at(It());var w_=at(It());function B5(n,e){n.style.display="block";let{offsetWidth:t,offsetHeight:r}=n,i=document.documentElement.clientWidth,a=document.documentElement.clientHeight,o=document.documentElement.scrollLeft+Math.min(i-t,e.clientX),l=document.documentElement.scrollTop+Math.min(a-r,e.clientY);n.style.left=o+"px",n.style.top=l+"px"}var IC=class extends j{constructor(e){super();this.element=document.createElement("div");this.parentDisposers=new Map;this.disabledValue=!1;this.opened=new ae;this.closed=new ae;let{element:t}=this;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),e!==void 0&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return this.menuDisposer!==void 0}registerParent(e){let{parentDisposers:t}=this;t.has(e)||t.set(e,En(e,"contextmenu",r=>{this.show(r),r.stopPropagation(),r.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();let{element:t}=this,r=En(document,"mousedown",o=>{o.target instanceof Node&&!t.contains(o.target)&&this.hide()},!0),i=En(document,"keydown",o=>{o.code==="Escape"&&this.hide()},!0),a=()=>{i(),r(),t.style.display="none"};this.opened.dispatch(),B5(t,e),this.menuDisposer=a}unregisterParent(e){let{parentDisposers:t}=this,r=t.get(e);r!==void 0&&(r(),t.delete(e))}disposed(){let{parentDisposers:e}=this;for(let t of e.values())t();e.clear(),Xe(this.element)}hide(){this.menuDisposer!==void 0&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}};function U5(n){return uE(new TextEncoder().encode(n))}function F5(n){return new TextDecoder().decode(dE(n))}function G5(n,e){if(!!n.startsWith(e))try{let t=F5(n.substring(e.length));return JSON.parse(t)}catch{return}}function l_(n,e){return n+U5(JSON.stringify(e))}function c_(n,e){for(let t of n){let r=G5(t,e);if(r!==void 0)return{parameters:r,dragType:t}}}var u_;function Op(n,e){return n.dataTransfer.dropEffect=e,u_=e,e}function Np(){return u_}function d_(n){return n.draggable=!0,En(n,"dragstart",e=>{e.stopPropagation(),e.preventDefault()})}var p_="neuroglancer-layer\0",Ci;function MC(n,e){var i;n.dataTransfer.setData(l_(p_,e.layers.map(a=>({name:a.name,visible:a.visible}))),JSON.stringify({layers:e.layers.map(a=>a.toJSON()),layout:e.layoutSpec})),Ci!==void 0&&Ci.disposer();let t,r=()=>{e.manager.unregisterDisposer(r);for(let a of e.layers)a.dispose();e.manager.dispose(),Ci===t&&(Ci=void 0)};Ci=t={manager:e.manager.addRef(),layers:e.layers.map(a=>a.addRef()),layoutSpec:e.layoutSpec,isLayerListPanel:(i=e.isLayerListPanel)!=null?i:!1,disposer:r}}function iu(n="none"){if(Ci!==void 0){if(n==="move"){let e=new Set(Ci.layers);Ci.manager.layerManager.filter(t=>!e.has(t))}Ci.disposer()}}function Bp(n){return c_(n.dataTransfer.types,p_)}function f_(n){if(Ci!==void 0&&Ci.manager.rootLayers===n.rootLayers)return Ci}var RC=class{initializeExternalLayers(e){let{dragType:t}=this;if(t!==void 0)try{let{layers:r,layout:i}=JSON.parse(e.dataTransfer.getData(t));if(!Array.isArray(r)||this.numSourceLayers!==r.length)throw new Error("Invalid layer drop data");this.layoutSpec=i;for(let[a,o]of this.layers)g_(a,r[o])}catch{return!1}return!0}updateArchiveStates(e){let{targetIsLayerListPanel:t}=this,r=e.dataTransfer.dropEffect;for(let i of this.layers.keys()){let a=t;t&&!i.archived&&r!=="copy"&&this.sourceIsLayerListPanel&&(a=!1),(i.archived!==a||a&&i.visible)&&(i.archived=a,a&&(i.visible=!1),i.layerChanged.dispatch())}}get method(){return this.sourceManager!==void 0?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e?!0:this.forceCopy&&e!=="copy"?!1:!this.moveSupported&&e==="move"}};function _C(n,e,t){let r;n.shiftKey?r="copy":n.ctrlKey&&t?r="move":r=e;let i="",a=o=>{i!==""&&(i+=", "),i+=o};return e!=="none"&&r!==e&&(n.shiftKey?a(`release SHIFT to ${e}`):a(`release CONTROL to ${e}`)),r!=="copy"&&a("hold SHIFT to copy"),r!=="move"&&t&&e!=="move"&&a("hold CONTROL to move"),{dropEffect:r,dropEffectMessage:i}}function h_(n,e,t,r){let i=f_(e),a=!1,o;return i===void 0?o="copy":r?(i.isLayerListPanel||(a=!0),o="link"):i.manager===e&&i.isLayerListPanel===t?(o="move",a=!0):t?o="none":(i.isLayerListPanel||(a=!0),o="link"),_C(n,o,a)}function m_(n,e,t,r){let i=h_(n,e,t,r);return Op(n,i.dropEffect),i}function Dg(n,e,t){let{forceCopy:r,newTarget:i,isLayerListPanel:a=!1}=t,o=f_(e);if(!r&&o!==void 0){let c=!i&&o.manager===e&&(o.isLayerListPanel===a||o.isLayerListPanel),d=new RC;return d.manager=e,d.numSourceLayers=o.layers.length,d.sourceManager=o.manager,d.targetIsLayerListPanel=a,d.sourceIsLayerListPanel=o.isLayerListPanel,d.moveSupported=c,d.layers=new Map,d.forceCopy=!1,d.layoutSpec=o.layoutSpec,c?o.layers.forEach((p,m)=>{d.layers.set(p,m)}):o.layers.forEach((p,m)=>{(i||!e.layerManager.has(p))&&d.layers.set(p.addRef(),m)}),d}let l=Bp(n);if(l!==void 0)try{let c=ye(l.parameters,(p,m)=>{let y=G(p,"name",ee),v=G(p,"visible",Ii),b=new Up(y,e);return a&&(v=!1),b.visible=v,b.archived=a,[b,m]}),d=new RC;return d.numSourceLayers=c.length,d.targetIsLayerListPanel=a,d.sourceIsLayerListPanel=!1,d.sourceManager=void 0,d.moveSupported=!1,d.forceCopy=o!==void 0,d.manager=e,d.dragType=l.dragType,d.layers=new Map(c),d}catch{}}function VC(n,e){return n.moveSupported?!1:(n.manager.layerManager.filter(t=>!n.layers.has(t)),e!==void 0&&n.layers.has(e))}function au(n,e,t,r=!1){function i(a,o){let l=n.dropLayers,{dropEffect:c,dropEffectMessage:d}=o?h_(a,n.manager,r,!1):{dropEffect:Np(),dropEffectMessage:""};if(c===void 0)return;Op(a,c);let p=!0;if(!(l!==void 0&&!l.compatibleWithMethod(c)&&(n.dropLayers=void 0,VC(l,t)))){if(l===void 0){if(l=n.dropLayers=Dg(a,n.manager,{forceCopy:c==="copy",newTarget:!1,isLayerListPanel:r}),l===void 0)return;p=l.method==="move"}if(t!==void 0&&l.layers.has(t))return{dropLayers:l,dropEffect:c,dropEffectMessage:d};if(p){let{layerManager:m}=n.manager,y=new Set,v=Number.POSITIVE_INFINITY,b=m.managedLayers=m.managedLayers.filter((C,k)=>l.layers.has(C)?(v===Number.POSITIVE_INFINITY&&(v=k),y.add(C),!1):!0),x;t!==void 0?(x=b.indexOf(t),v<=x&&++x):x=b.length;for(let C of l.layers.keys())y.has(C)||l.layers.delete(C);b.splice(x,0,...l.layers.keys()),m.layersChanged.dispatch()}else{let m;t!==void 0&&(m=n.manager.layerManager.managedLayers.indexOf(t));for(let y of l.layers.keys())n.manager.add(y,m)}return{dropLayers:l,dropEffect:c,dropEffectMessage:d}}}e.addEventListener("dragenter",a=>{i(a,!0)!==void 0?a.preventDefault():Zt(n.element,"drop")}),e.addEventListener("drop",a=>{var l;a.preventDefault(),n.dragEnterCount=0,Zt(n.element,"drop");let o=(l=i(a,!1))==null?void 0:l.dropLayers;if(n.dropLayers=void 0,o!==void 0){if(!o.initializeExternalLayers(a)){VC(o);return}o.updateArchiveStates(a),iu(o.method==="move"?void 0:a.dataTransfer.dropEffect)}}),e.addEventListener("dragover",a=>{let o=i(a,!0);if(o===void 0){Zt(n.element,"drop");return}let{dropLayers:l,dropEffect:c,dropEffectMessage:d}=o,p=l.layers.size,m="",y=l.numSourceLayers===1?"":"s",v=l.numSourceLayers;if(c==="none")m=`Cannot link dragged layer${y} here`;else{let b=v===p?`${v}`:`${p}/${v}`;m=`Drop to ${c} ${b} layer${y}`}d&&(m+=` (${d})`),Tr(n.element,"drop",m),a.preventDefault(),a.stopPropagation()})}function Ag(n,e,t,r){e.draggable=!0,e.addEventListener("dragstart",i=>{Tr(e,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),MC(i,{manager:n.manager,layers:[t],layoutSpec:r.getLayoutSpec(),isLayerListPanel:r.isLayerListPanel}),i.stopPropagation()}),e.addEventListener("dragend",()=>{Zt(e,"drag"),iu()})}function Ig(n){n.element.addEventListener("dragenter",()=>{++n.dragEnterCount}),n.element.addEventListener("dragleave",()=>{if(--n.dragEnterCount!=0)return;Zt(n.element,"drop");let{dropLayers:e}=n;e!==void 0&&(VC(e),n.manager.layerManager.layersChanged.dispatch(),n.dropLayers=void 0)})}var y_='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="binIconTitle"><path d="M19 6L5 6M14 5L10 5M6 10L6 20C6 20.6666667 6.33333333 21 7 21 7.66666667 21 11 21 17 21 17.6666667 21 18 20.6666667 18 20 18 19.3333333 18 16 18 10"></path></svg>';function wi(n={}){let e=$e({svg:y_,...n}),t=e.firstElementChild;return t.style.fill="white",e}var Fp="neuroglancer-position",v_=Oe.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),W5=[n=>n.nameElement,n=>n.coordinate,n=>n.scaleElement];function Mg(n,e){let t=n.coordinateArrays[e];return t===void 0?t:n.units[e]!=""||n.scales[e]!==1?null:t}var S_=class{constructor(e,t){this.coordinateSpace=e;this.container=document.createElement("div");this.nameContainer=document.createElement("span");this.nameElement=document.createElement("input");this.scaleContainer=document.createElement("span");this.scaleElement=document.createElement("input");this.coordinate=document.createElement("input");this.coordinateLabel=document.createElement("span");this.coordinateLabelWidth=0;this.dropdownOwner=void 0;this.modified=!1;this.draggingPosition=!1;this.hasFocus=!1;let{container:r,scaleElement:i,scaleContainer:a,coordinate:o,nameElement:l,nameContainer:c,coordinateLabel:d}=this;r.title="",r.classList.add("neuroglancer-position-dimension"),r.draggable=!0,r.tabIndex=-1,r.appendChild(c),r.appendChild(i),c.appendChild(l),c.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",a.appendChild(i),l.classList.add("neuroglancer-position-dimension-name"),l.disabled=!0,l.spellcheck=!1,l.autocomplete="off",l.required=!0,l.placeholder=" ",a.classList.add("neuroglancer-position-dimension-scale-container"),i.classList.add("neuroglancer-position-dimension-scale"),i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",r.appendChild(a),r.appendChild(o),o.type="text",o.classList.add("neuroglancer-position-dimension-coordinate"),o.spellcheck=!1,o.autocomplete="off",o.pattern=String.raw`(-?\d+(?:\.(?:\d+)?)?)`;let p=Mg(e,t);if(p!=null){let m=0;for(let y of p.labels)m=Math.max(m,y.length);this.coordinateLabelWidth=m,d.style.width=`${m+2}ch`,r.appendChild(d)}o.required=!0,o.placeholder=" ",d.classList.add("neuroglancer-position-dimension-coordinate-label")}};function OC(n,e,t,r){return Math.floor((n-e)*(r-1)/(t-e))}function z5(n,e,t){let{boundingBoxes:r,bounds:i}=n,a=Math.floor(i.lowerBounds[e]),o=Math.ceil(i.upperBounds[e]-1);if(!Number.isFinite(a)||!Number.isFinite(o))return;let l=[],c=p=>OC(p,a,o,t),{rank:d}=n;for(let p of r){let m=iS(p,e,d);m!==void 0&&(m.lower=c(m.lower),m.upper=c(Math.ceil(m.upper-1)),l.push(m))}return l.sort((p,m)=>{let y=p.lower-m.lower;return y!==0?y:m.upper-m.upper}),Of(l,(p,m)=>{if(m===0)return!0;let y=l[m-1];return y.lower!==p.lower||y.upper!==p.upper}),{lowerBound:a,upperBound:o,normalizedBounds:l}}var NC=10,BC=15,H5=10,UC=NC+BC+H5;function $5(n,e,t){e.clearRect(0,0,n.width,n.height);let{normalizedBounds:r}=t;function i(o){e.fillRect(0,o,NC,1)}e.fillStyle="#fff";for(let{lower:o,upper:l}of r)i(o),i(l);let a=r.length;e.fillStyle="#ccc";for(let o=0;o<a;++o){let{lower:l,upper:c}=r[o],d=Math.floor(o*BC/a),p=Math.max(1,BC/a);e.fillRect(d+NC,l,p,c+1-l)}}function b_(n,e){Sn(n,e.length+1)}function x_(n){let{value:e}=n;Sn(n),n.parentElement.dataset.isEmpty=e===""?"true":"false"}var hs=class extends j{constructor(e,t,{copyButton:r=!0}={}){super();this.position=e;this.combiner=t;this.element=document.createElement("div");this.dimensionContainer=document.createElement("div");this.coordinateSpace=void 0;this.dimensionWidgets=new Map;this.dimensionWidgetList=[];this.dragSource=void 0;let{element:i,dimensionContainer:a}=this;if(this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable(Ge(()=>this.updateDimensions())))),i.className="neuroglancer-position-widget",a.style.display="contents",i.appendChild(a),r){let l=Jn({title:"Copy position to clipboard",onClick:()=>{let c=en(this.getPositionText());Ce.showTemporaryMessage(c?"Position copied to clipboard":"Failed to copy position to clipboard")}});l.addEventListener("dragstart",c=>{c.dataTransfer.setData(Fp,JSON.stringify({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),c.dataTransfer.setData("text",this.getPositionText()),c.stopPropagation()}),l.draggable=!0,i.appendChild(l)}this.registerDisposer(e.changed.add(this.registerCancellable(Ge(()=>this.updateView()))));let o=this.registerDisposer(new zt(i,v_));o.allShortcutsAreGlobal=!0,this.registerDisposer(new xn(i,v_)),this.registerDisposer(ce(i,"cancel",l=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();let{target:c}=l;c instanceof HTMLElement&&c.blur()})),this.updateView()}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");let r=document.createElement("canvas"),i=r.getContext("2d"),a=document.createElement("div"),o=document.createElement("div");o.appendChild(a);let l=document.createTextNode("");a.appendChild(l);let c=document.createElement("div"),d=document.createElement("div");o.classList.add("neuroglancer-position-dimension-dropdown-lowerbound"),c.classList.add("neuroglancer-position-dimension-dropdown-upperbound"),d.classList.add("neuroglancer-position-dimension-dropdown-hoverposition"),t.appendChild(o),t.appendChild(c),t.appendChild(d),t.appendChild(r);let p=100;r.width=UC,r.height=p,c.style.marginTop=`${p-1}px`;let m,y,v,b=()=>{let P=this.dimensionWidgetList.indexOf(e);if(P===-1)return;let{coordinateSpace:M}=e,I=z5(M,P,p);if(I===void 0||M.bounds.lowerBounds[P]+1===M.bounds.upperBounds[P]){t.style.display="none",e.container.dataset.dropdownVisible=void 0;return}e.container.dataset.dropdownVisible="true",t.style.display="";let{lowerBound:E,upperBound:_}=I;m=E,y=_,l.textContent=E.toString(),c.textContent=_.toString(),$5(r,i,I);let O=this.position.value[P];if(O>=E&&O<=_&&(i.fillStyle="#f66",i.fillRect(0,OC(O,E,_,p),UC,1)),v!==void 0&&v>=E&&v<=_){i.fillStyle="#66f";let B=OC(v,E,_,p);i.fillRect(0,B,UC,1),d.textContent=v.toString();let W=a.clientHeight;a.style.visibility=B>W?"":"hidden",c.style.visibility=B<p-W?"":"hidden",d.style.display="",d.style.visibility="visible",d.style.marginTop=`${B}px`}else a.style.visibility="",d.style.display="none",c.style.visibility=""},x=e.dropdownOwner,C=x.registerCancellable(Ge(b));x.registerDisposer(this.position.changed.add(C));let k=P=>{if(m===void 0||y===void 0)return;let M=r.getBoundingClientRect(),I=(P.clientY-M.top)/M.height;return I=Math.max(0,I),I=Math.min(1,I),Math.round(I*(y-m))+m},D=P=>{let M=this.dimensionWidgetList.indexOf(e);if(M===-1)return;let I=k(P);if(I===void 0)return;let{position:E}=this,_=E.value;_[M]=I+.5,e.modified=!1,E.value=_};r.addEventListener("pointermove",P=>{v=k(P),C()}),r.addEventListener("pointerleave",()=>{v=void 0,C()}),r.addEventListener("pointerdown",P=>{P.preventDefault(),P.stopPropagation(),!(P.ctrlKey||P.altKey||P.shiftKey||P.metaKey)&&(bn(P,M=>{e.dropdownOwner!==void 0&&(v=void 0,D(M),C(),e.draggingPosition=!0)},()=>{e.draggingPosition=!1,this.updateDropdownVisibility(e)}),D(P))}),b()}openCoordinateArrayDropdown(e,t,r){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");let{coordinates:i,labels:a}=r,o=[],l=i.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let c=0;c<l;++c){let d=document.createElement("div");d.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");let p=document.createElement("div");p.classList.add("neuroglancer-dimension-dropdown-coordinate");let m=document.createElement("div");m.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),m.textContent=a[c],p.textContent=i[c].toString(),d.appendChild(p),d.appendChild(m),d.addEventListener("click",()=>{let y=this.dimensionWidgetList.indexOf(e);if(y===-1)return;let{position:v}=this,b=v.value;b[y]=i[c]+.5,e.modified=!1,v.value=b}),t.appendChild(d),o.push({entryElement:d,coordinateElement:p,labelElement:m})}}openDropdown(e){if(e.dropdownOwner!==void 0)return;let t=this.dimensionWidgetList.indexOf(e);if(t===-1)return;this.closeDropdown();let r=e.dropdownOwner=new j,i=document.createElement("div");i.draggable=!0,i.addEventListener("dragstart",o=>{o.stopPropagation(),o.preventDefault()}),i.addEventListener("pointerenter",()=>{e.hasFocus=!0}),i.tabIndex=-1,e.container.appendChild(i);let a=Mg(e.coordinateSpace,t);a==null?this.openRegularDropdown(e,i):this.openCoordinateArrayDropdown(e,i,a),this.widgetWithOpenDropdown=e,r.registerDisposer(()=>{Xe(i),e.dropdownOwner=void 0,delete e.container.dataset.dropdownVisible,this.widgetWithOpenDropdown=void 0}),r.registerEventListener(document,"pointerdown",o=>{let{target:l}=o;l instanceof Node&&e.container.contains(l)||this.closeDropdown(e)},{capture:!0})}closeDropdown(e=this.widgetWithOpenDropdown){if(e===void 0)return;let{dropdownOwner:t}=e;t!==void 0&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();let r=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(r===null)break;if(r[1]!==void 0&&document.execCommand("insertText",void 0,r[1]),r[2]!==void 0){let{dimensionWidgetList:i}=this,a=i.indexOf(e);if(a===-1||a+1===i.length)break;let o=t.substring(r[0].length);e=i[a+1],t=o;continue}break}}reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:r}=this.position;r.value=Dh(r.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t){let r=new S_(e,t);r.container.addEventListener("dragstart",i=>{this.dragSource=r,i.stopPropagation(),i.dataTransfer.setData("neuroglancer-dimension","")}),r.container.addEventListener("dragenter",i=>{let{dragSource:a}=this;if(a===void 0||a===r)return;let{dimensionWidgetList:o}=this,l=o.indexOf(a),c=o.indexOf(r);l===-1||c===-1||(i.preventDefault(),this.reorderDimensionTo(c,l))}),r.container.addEventListener("dragend",i=>{this.dragSource===r&&(this.dragSource=void 0)}),r.nameContainer.addEventListener("dblclick",()=>{r.nameElement.disabled=!1,r.nameElement.focus(),r.nameElement.select()}),r.scaleContainer.addEventListener("dblclick",()=>{r.scaleElement.disabled=!1,r.scaleElement.focus(),r.scaleElement.select()}),r.coordinate.addEventListener("focus",()=>{r.coordinate.select()}),r.container.addEventListener("focusin",()=>{r.hasFocus=!0,this.updateDropdownVisibility(r)}),r.container.addEventListener("focusout",i=>{let{relatedTarget:a}=i;a instanceof Node&&r.container.contains(a)||(r.hasFocus=!1,this.updateDropdownVisibility(r))}),r.container.addEventListener("click",i=>{(!(i.target instanceof HTMLInputElement)||i.target.disabled)&&r.coordinate.focus()}),r.coordinate.addEventListener("paste",i=>{let a=r.coordinate,o=a.value,{clipboardData:l}=i;if(l===null)return;let c=l.getData("text"),{selectionEnd:d,selectionStart:p}=a;if(p!==0||d!==o.length){p==null&&(p=0),d==null&&(d=0);let m=c.match(/[^\-0-9\.]/);m!==null&&(c=c.substring(0,m.index)),c.length>0&&document.execCommand("insertText",void 0,c)}else this.pasteString(r,c);i.preventDefault(),i.stopPropagation()}),r.coordinate.addEventListener("input",()=>{r.modified=!0;let i=r.coordinate,a=i.value,{selectionDirection:o,selectionEnd:l,selectionStart:c}=i;c===null&&(c=0),l===null&&(l=c);let d="",p=/[^\-0-9\.]/g;d+=a.substring(0,c).replace(p,"");let m=d.length;d+=a.substring(c,l).replace(p,"");let y=d.length;d+=a.substring(l).replace(p,""),i.value=d,i.selectionStart=m,i.selectionEnd=y,i.selectionDirection=o,b_(i,d),l===c&&l===a.length&&a.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(r,1)}),r.nameElement.addEventListener("input",()=>{let{nameElement:i}=r;Sn(i),this.updateNameValidity()}),r.scaleElement.addEventListener("input",()=>{let{scaleElement:i}=r;x_(i),this.updateScaleValidity(r)}),r.coordinate.addEventListener("blur",i=>{let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.coordinate===a)||r.modified&&this.updatePosition()}),r.nameElement.addEventListener("blur",i=>{r.nameElement.disabled=!0;let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.nameElement===a)||this.updateNames()||this.forceUpdateDimensions()}),r.scaleElement.addEventListener("blur",i=>{r.scaleElement.disabled=!0;let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.scaleElement===a)||this.updateScales()||this.forceUpdateDimensions()}),ce(r.container,"adjust-via-wheel",i=>{let a=i.detail,{deltaY:o}=a;o!==0&&this.adjustDimension(r,Math.sign(o))}),ce(r.container,"adjust-up",()=>{this.adjustDimension(r,-1)}),ce(r.container,"adjust-down",()=>{this.adjustDimension(r,1)});for(let i of W5){let a=i(r);ce(a,"maybe-tab-forward",o=>{this.handleLeftRightMovement(o,r,1,i)}),ce(a,"maybe-tab-backward",o=>{this.handleLeftRightMovement(o,r,-1,i)}),ce(a,"tab-forward",()=>{this.selectAdjacentField(r,1,i)}),ce(a,"tab-backward",()=>{this.selectAdjacentField(r,-1,i)})}return ce(r.coordinate,"commit",()=>{this.updatePosition()}),ce(r.nameElement,"commit",()=>{this.updateNames()}),ce(r.scaleElement,"commit",()=>{this.updateScales()}),ce(r.coordinate,"delete-backward",i=>{i.stopPropagation();let{coordinate:a}=r;a.selectionStart===a.selectionEnd&&a.selectionStart===0&&(i.preventDefault(),this.selectAdjacentCoordinate(r,-1))}),r}forceUpdateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e.valid||(e=Qr),this.coordinateSpace=e;let{dimensionWidgets:t,dimensionWidgetList:r}=this;r.length=0;let{names:i,ids:a,scales:o,units:l}=e;qn(this.dimensionContainer,a.map((c,d)=>{let p=t.get(c);p===void 0?(p=this.newDimension(e,d),t.set(c,p)):p.coordinateSpace=e;let m=i[d];p.nameElement.value=m,delete p.nameElement.dataset.isValid,Sn(p.nameElement);let y=Mg(e,d);y===void 0?p.container.dataset.coordinateArray="none":y===null?p.container.dataset.coordinateArray="invalid":p.container.dataset.coordinateArray="valid",p.scaleContainer.title="Drag to reorder, double click to change scale",y===null&&(p.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");let{scale:v,prefix:b,unit:x}=tS(o[d],l[d]),C=`${v}${b}${x}`;return p.scaleElement.value=C,delete p.scaleElement.dataset.isValid,x_(p.scaleElement),r.push(p),p.container}));for(let[c,d]of t)d.coordinateSpace!==e&&(this.closeDropdown(d),t.delete(c))}updateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,r){let{dimensionWidgetList:i}=this,a=i.indexOf(e);if(a!==-1)for(;;){if(a+=t,a<0||a>=i.length)return!1;let o=i[a],l=r(o);if(l.style.display!=="none")return l.disabled=!1,l.focus(),l.selectionStart=0,l.selectionEnd=l.value.length,l.selectionDirection=t===1?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,r=>r.coordinate)}handleLeftRightMovement(e,t,r,i){e.stopPropagation();let a=i(t);a.selectionStart!==a.selectionEnd||a.selectionStart!==(r===1?a.value.length:0)||this.selectAdjacentField(t,r,i)&&e.preventDefault()}updateNameValidity(){let{dimensionWidgetList:e}=this,t=e.map(a=>a.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let a=0;a<r;++a)e[a].nameElement.dataset.isValid=i[a]===!1?"false":"true"}updateScaleValidity(e){let t=jo(e.scaleElement.value)!==void 0;e.scaleElement.dataset.isValid=t.toString()}adjustDimension(e,t){let r=this.dimensionWidgetList.indexOf(e);if(r===-1)return;this.updatePosition();let{position:i}=this;if(!i.valid)return;let a=i.coordinateSpace.value,{bounds:o}=a,l=Float32Array.from(i.value),c=Math.floor(l[r]+t);if(t>0){let d=o.upperBounds[r];Number.isFinite(d)&&(c=Math.min(c,Math.ceil(d-1)))}else{let d=o.lowerBounds[r];Number.isFinite(d)&&(c=Math.max(c,Math.floor(d)))}l[r]=c+.5,this.position.value=l,this.updateView()}updatePosition(){let{dimensionWidgetList:e}=this,{position:t}=this,{value:r}=t;if(r===void 0)return;let i=e.length;for(let a=0;a<i;++a){let o=e[a];o.modified=!1;let l=Number(o.coordinate.value);Number.isFinite(l)&&(r[a]=l+(Number.isInteger(l)?.5:0))}t.value=r}updateNames(){let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;let a=r.names;if(we(a,i))return!1;let o=r.timestamps.map((c,d)=>a[d]===i[d]?c:Date.now()),l={...r,names:i,timestamps:o};return t.value=l,!0}updateScales(){let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,r=t.value,i=e.map(m=>jo(m.scaleElement.value));if(i.includes(void 0))return!1;let a=Float64Array.from(i,m=>m.scale),o=Array.from(i,m=>m.unit),{scales:l,units:c}=r;if(we(l,a)&&we(c,o))return!1;let d=r.timestamps.map((m,y)=>a[y]===l[y]&&o[y]===c[y]?m:Date.now()),p=Ne({valid:r.valid,rank:r.rank,scales:a,units:o,timestamps:d,ids:r.ids,names:r.names,boundingBoxes:r.boundingBoxes,coordinateArrays:r.coordinateArrays});return t.value=p,!0}getPositionText(){let{position:e}=this;return e.valid?e.value.map(t=>Math.floor(t)).join(", "):""}updateView(){this.updateDimensions();let{position:{value:e},dimensionWidgetList:t}=this,r=t.length;if(e===void 0)return;let i=this.coordinateSpace;for(let a=0;a<r;++a){let o=t[a],l=o.coordinate,c=Math.floor(e[a]),d=c.toString();b_(l,d),l.value=d;let p=Mg(i,a),m="";if(p!=null){let{coordinates:v}=p,b=Rk(v,c,(x,C)=>x-C);b!==v.length&&(m=p.labels[b])}let y=o.coordinateLabel;y.textContent=m}}disposed(){this.closeDropdown(),Xe(this.element),super.disposed()}},FC=class extends j{constructor(e,t,r){super();this.element=e;this.mouseState=t;this.coordinateSpace=r;this.tempPosition=J.create();e.className="neuroglancer-mouse-position-widget";let i=this.registerCancellable(Ge(()=>this.updateView()));this.registerDisposer(t.changed.add(i)),this.registerDisposer(r.changed.add(i))}updateView(){let e="",{mouseState:t,coordinateSpace:{value:r}}=this;if(t.active&&r!==void 0){let i=t.position,{rank:a,names:o}=r;for(let l=0;l<a;++l)l!==0&&(e+="  "),e+=`${o[l]} ${Math.floor(i[l])}`}this.element.textContent=e}disposed(){Xe(this.element),super.disposed()}};var C_=class extends j{constructor(e,t){super();this.layer=e;this.panel=t;this.element=document.createElement("div");this.layerNumberElement=document.createElement("div");this.labelElement=document.createElement("div");this.visibleProgress=document.createElement("div");this.prefetchProgress=document.createElement("div");this.labelElementText=document.createTextNode("");this.valueElement=document.createElement("div");this.maxLength=0;this.prevValueText="";var C;let{element:r,labelElement:i,layerNumberElement:a,valueElement:o,visibleProgress:l,prefetchProgress:c,labelElementText:d}=this;r.className="neuroglancer-layer-item neuroglancer-noselect",r.appendChild(l),r.appendChild(c),i.className="neuroglancer-layer-item-label",i.appendChild(d),l.className="neuroglancer-layer-item-visible-progress",c.className="neuroglancer-layer-item-prefetch-progress",a.className="neuroglancer-layer-item-number",o.className="neuroglancer-layer-item-value";let p=document.createElement("div");p.className="neuroglancer-layer-item-value-container";let m=document.createElement("div");m.className="neuroglancer-layer-item-button-container";let y=Vc();y.title="Remove layer from this layer group";let v=L1();v.title="Refresh data",this.registerEventListener(v,"click",k=>{k.stopPropagation();let D=this.layer.layer;if(D&&D.dataSources&&D.dataSources[0].loadState){let{loadState:P}=D.dataSources[0];if(P instanceof qc){let{dataSource:M}=P;if(M&&M.subsources[0]&&M.subsources[0].subsource){let{annotation:I}=M.subsources[0].subsource;(I==null?void 0:I.invalidateCache)&&I.invalidateCache()}}}}),y.addEventListener("click",k=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),k.stopPropagation()});let b=wi();b.title="Delete this layer",b.addEventListener("click",k=>{To(this.layer),k.stopPropagation()}),r.appendChild(a),p.appendChild(o),p.appendChild(m),m.appendChild(y),m.appendChild(b),r.appendChild(i),((C=e.layer)==null?void 0:C.allowingRefresh)&&r.appendChild(v),r.appendChild(p);let x=this.registerDisposer(new hs(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1}));r.appendChild(x.element),x.element.addEventListener("click",k=>{k.stopPropagation()}),x.element.addEventListener("dblclick",k=>{k.stopPropagation()}),r.addEventListener("click",k=>{k.ctrlKey?t.selectedLayer.toggle(e):k.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),r.addEventListener("contextmenu",k=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,k.stopPropagation(),k.preventDefault()}),Ag(t,r,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),au(this.panel,r,this.layer)}update(){let{layer:e,element:t}=this;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let r=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(r+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),r+=", drag to move, shift+drag to copy",t.title=r}disposed(){this.element.remove(),super.disposed()}},GC=class extends j{constructor(e,t,r,i,a,o){super();this.display=e;this.manager=t;this.viewerNavigationState=r;this.selectedLayer=i;this.getLayoutSpecForDrag=a;this.showLayerHoverValues=o;this.layerWidgets=new Map;this.element=document.createElement("div");this.layerUpdateNeeded=!0;this.valueUpdateNeeded=!1;this.layerWidgetInsertionPoint=document.createElement("div");this.positionWidget=this.registerDisposer(new hs(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner));this.dragEnterCount=0;this.scheduleUpdate=this.registerCancellable(Ge(()=>this.update()));this.registerDisposer(i);let{element:l}=this;l.className="neuroglancer-layer-panel",this.registerDisposer(t.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(t.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(i.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(o.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let c=$e({svg:Cl,title:"Click to add layer, control+click/right click/\u2318+click to add local annotation layer."});c.classList.add("neuroglancer-layer-add-button");let d=this.dropZone=document.createElement("div");d.className="neuroglancer-layer-panel-drop-zone";let p=y=>{if(y.ctrlKey||y.metaKey||y.type==="contextmenu"){let v=WC(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(v),this.selectedLayer.layer=v,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(c,"click",p),this.registerEventListener(c,"contextmenu",p),l.appendChild(c),l.appendChild(d),this.registerDisposer(d_(c)),l.appendChild(this.positionWidget.element);let m=()=>{let y=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=y===Wt.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(m)),m(),this.update(),this.updateChunkStatistics(),Ig(this),au(this,d,void 0),this.registerDisposer(e.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(t.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable(Ge(()=>this.updateChunkStatistics()))))}get layerManager(){return this.manager.layerManager}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,Xe(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),this.showLayerHoverValues.value===!1)return;let e=this.manager.layerSelectedValues;for(let[t,r]of this.layerWidgets){let i=t.layer,a="";if(i!==null){let o=e.get(i);if(o!==void 0){let{value:l}=o;l!==void 0&&(a=""+l)}}if(a!==r.prevValueText){if(r.prevValueText=a,a.length>r.maxLength){let o=r.maxLength=a.length;r.valueElement.style.width=`${o}ch`}r.valueElement.textContent=a}}}updateChunkStatistics(){for(let[e,t]of this.layerWidgets){let r=0,i=0,a=0,o=0,l=e.layer;if(l!==null)for(let{layerChunkProgressInfo:c}of l.renderLayers)r+=c.numVisibleChunksNeeded,i+=c.numVisibleChunksAvailable,a+=c.numPrefetchChunksNeeded,o+=c.numPrefetchChunksAvailable;t.visibleProgress.style.width=`${i/Math.max(1,r)*100}%`,t.prefetchProgress.style.width=`${o/Math.max(1,a)*100}%`}}updateLayers(){var i;if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let e=this.element,t=new Set,r=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(let a of this.manager.layerManager.managedLayers){if(a.archived&&!((i=this.dropLayers)==null?void 0:i.layers.has(a)))continue;t.add(a);let o=this.layerWidgets.get(a),l=a.nonArchivedLayerIndex;o===void 0&&(o=new C_(a,this),this.layerWidgets.set(a,o)),o.layerNumberElement.textContent=""+(1+l),o.update();let{element:c}=o;c!==r&&e.insertBefore(o.element,r),r=c.nextElementSibling}for(let[a,o]of this.layerWidgets)t.has(a)||(this.layerWidgets.delete(a),o.dispose())}addLayerMenu(){Rg(this.manager,this.selectedLayer)}};function _g(n,e){let t=En(n,"drop",o=>{if(o.preventDefault(),o.dataTransfer.types.indexOf(Fp)!==-1){o.stopPropagation();let l=Q(JSON.parse(o.dataTransfer.getData(Fp))),c=G(l,"dimensions",Td),d=G(l,"position",v=>ye(v,Ye));if(d.length!==c.length)throw new Error("length mismatch between position and dimensions");let p=d.length,{coordinateSpace:{value:{names:m}},value:y}=e;for(let v=0;v<p;++v){let b=m.indexOf(c[v]);b!==-1&&(y[b]=d[v])}e.changed.dispatch()}}),r=o=>{o.dataTransfer.types.indexOf(Fp)!==-1&&(o.dataTransfer.dropEffect="link",o.preventDefault(),o.stopPropagation())},i=En(n,"dragenter",r),a=En(n,"dragover",r);return()=>{i(),a(),t()}}var Gp=class extends j{constructor(e){super();this.model=e;this.element=document.createElement("select");this.valueIndexMap=new Map;let{element:t,valueIndexMap:r}=this,i=0;for(let a of Object.keys(e.enumType))if(isNaN(Number(a))){let o=document.createElement("option");o.textContent=o.value=a.toLowerCase(),t.appendChild(o),r.set(e.enumType[a],i),++i}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",a=>{a.preventDefault(),a.stopPropagation(),this.adjustViaWheel(a)}),this.updateView()}adjustViaWheel(e){let{element:t}=this,{deltaY:r}=e;r>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):r<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){let{element:e}=this;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}};var Vg="neuroglancer-layer-group-viewer";function zC(n){return n.dataTransfer.types.indexOf(Vg)!==-1}var Fa;function j5(n){if(Fa&&Fa.viewer.layerSpecification.rootLayers===n.rootLayers)return Fa.viewer}function T_(n,e){let t=j5(e),r,i=!1;return t===void 0||t.layerSpecification===t.layerSpecification.root?r="copy":(i=!0,r="move"),_C(n,r,i)}var k_=class extends j{constructor(e){super();this.relativeDisplayScales=new Hx(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new $x(e.navigationState.pose.displayDimensions.addRef()),this.position=new Tp(e.navigationState.position.addRef()),this.crossSectionOrientation=new Kc(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new kp(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new Yc(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new gg(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new gg(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new Ua(new Ba(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new Kc(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new Yc(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new Ua(new Ba(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(let e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",xl(this.position)),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}};function q5(n,e){let t=new IC(n),r=t.element;r.classList.add("neuroglancer-layer-group-viewer-context-menu");let i=document.createElement("button");i.textContent="Remove layer group",r.appendChild(i),t.registerEventListener(i,"click",()=>{e.layerSpecification.layerManager.clear()});let{viewerNavigationState:a}=e;for(let[o,l]of[["Render scale factors",a.relativeDisplayScales.link],["Render dimensions",a.displayDimensions.link],["Position",a.position.link],["Cross-section orientation",a.crossSectionOrientation.link],["Cross-section zoom",a.crossSectionScale.link],["Cross-section depth range",a.crossSectionDepthRange.link],["3-D projection orientation",a.projectionOrientation.link],["3-D projection zoom",a.projectionScale.link],["3-D projection depth range",a.projectionDepthRange.link]]){let c=t.registerDisposer(new Gp(l)),d=document.createElement("label");d.style.display="flex",d.style.flexDirection="row",d.style.whiteSpace="nowrap",d.textContent=o,d.appendChild(c.element),r.appendChild(d)}return t}var ou=class extends j{constructor(e,t,r={}){super();this.element=e;this.viewerState=t;this.state=new ls;this.options={showLayerPanel:new xt(!0),showViewerMenu:!1,showLayerHoverValues:new xt(!0),...r},this.layerSpecification=this.registerDisposer(t.layerSpecification),this.viewerNavigationState=this.registerDisposer(new k_(t)),this.viewerNavigationState.register(this.state),this.layerSpecification instanceof Wp?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(i=>i.name),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new Co(e)),this.layout=this.registerDisposer(new EC(this,"xy")),this.state.add("layout",this.layout),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(_g(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable((0,w_.default)(()=>this.updateUI(),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(ce(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return{type:"viewer",...this.state.toJSON()}}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),an(e,"crossSectionZoom",xl(this.viewerNavigationState.crossSectionScale)),an(e,"perspectiveZoom",xl(this.viewerNavigationState.projectionScale)),an(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){let{options:e}=this,t=e.showLayerPanel.value;if(this.layerPanel!==void 0&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&this.layerPanel===void 0){let r=this.layerPanel=new GC(this.display,this.layerSpecification,this.viewerNavigationState,this.viewerState.selectedLayer.addRef(),()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(r.registerDisposer(q5(r.element,this)),r.element.title="Right click for options, drag to move/copy layer group."):r.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS!="undefined"&&NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS===!0){{let a=document.createElement("button");a.textContent="Clear segments",a.title='De-select all objects ("x")',a.addEventListener("click",o=>{cb(o,o,{action:"clear-segments"})}),r.element.appendChild(a)}for(let a of["3d","xy","xz","yz"]){let o=document.createElement("button");o.textContent=a,o.title=`Switch to ${a} layout`,o.addEventListener("click",()=>{let l;this.layout.name===a?a!=="3d"?l=`${a}-3d`:l="4panel":l=a,this.layout.name=l}),r.element.appendChild(o)}}r.element.draggable=!0;let i=r.element;i.addEventListener("dragstart",a=>{Tr(r.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),MC(a,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});let o=()=>{Fa&&Fa.viewer===this&&(Fa=void 0),this.unregisterDisposer(o)};Fa={viewer:this,disposer:o},this.registerDisposer(o);let l=this.toJSON();delete l.layers,a.dataTransfer.setData(Vg,JSON.stringify(l)),r.element.style.backgroundColor="black",setTimeout(()=>{r.element.style.backgroundColor=""},0)}),r.element.addEventListener("dragend",()=>{Zt(i,"drag"),iu(),Fa!==void 0&&Fa.viewer===this&&Fa.disposer()}),this.element.insertBefore(i,this.element.firstChild)}}disposed(){_e(this.element);let{layerPanel:e}=this;e!==void 0&&(e.dispose(),this.layerPanel=void 0),super.disposed()}};var L_=Symbol("layoutComponentContainer"),zp=class extends j{constructor(e,t,r){super();this.viewer=e;this.parent=r;this.changed=new ae;this.element=document.createElement("div");let{element:i}=this;i.style.display="flex",i.style.flex="1",i.style.position="relative",i.style.alignItems="stretch",i[L_]=this,this.setSpecification(t);let a=[],o=c=>{let d=document.createElement("div");d.className="neuroglancer-layout-split-drop-zone";let p;switch(d.style[c]="0",c){case"left":case"right":p="row",d.style.width="10px",d.style.height="100%";break;case"top":case"bottom":p="column",d.style.height="10px",d.style.width="100%";break}d.style.display="none",a.push({element:d,direction:p,orientation:c}),i.appendChild(d),P_(d,this.viewer.layerSpecification,()=>this.split(c).newContainer.component,p==="row"?"column":"row")};o("left"),o("right"),o("top"),o("bottom");let l=!1;i.addEventListener("dragenter",c=>{if(!l&&Bp(c)!==void 0){l=!0;for(let{element:d,direction:p,orientation:m}of a){if(r!==void 0&&p===r.direction&&((m==="left"||m==="top")&&r.get(0)!==this||(m==="bottom"||m==="right")&&r.get(r.length-1)!==this))continue;let{component:y}=this;y instanceof Ng&&y.direction===p||(d.style.display="block")}}},!0),i.addEventListener("drop",c=>{if(!!l){l=!1;for(let{element:d}of a)d.style.display="none"}},!0),i.addEventListener("dragleave",c=>{let{relatedTarget:d}=c;if(!!l&&!(d instanceof HTMLElement&&this.element.contains(d))){l=!1;for(let{element:p}of a)p.style.display="none"}},!0)}unsetComponent(){let e=this.componentValue;e!==void 0&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof ou){let{layerManager:t}=e,r=e.registerCancellable((0,HC.default)(()=>{t.managedLayers.length===0&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{t.managedLayers.length===0&&r()})),r()}else if(e instanceof Ng){let t=e.registerCancellable((0,HC.default)(()=>{let{length:r}=e;if(r===0&&this.parent!==void 0)this.dispose();else if(r===1){let i=e.get(0).component,a;if(this.parent===void 0&&i instanceof ou){a=i.layout.specification.toJSON(),i.viewerNavigationState.copyToParent();let o=i.layerManager.managedLayers,l=new Set(o),{layerSpecification:c}=i;c.rootLayers.filter(m=>l.has(m)||m.archived);let d=[],{managedLayers:p}=c.rootLayers;for(let m=0,y=p.length;m<y;++m)l.has(p[m])&&d.push(m);for(let m=0,y=o.length;m<y;++m)p[d[m]]=o[m];c.rootLayers.layersChanged.dispatch()}else a=i.toJSON();this.setSpecification(a)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}toJSON(){return this.component.toJSON()}setSpecification(e){this.setComponent(J5(this,e))}static getFromElement(e){return e[L_]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){let t={type:"viewer"},{parent:r}=this;if(r!==void 0){if(e==="left"&&r.direction==="row"||e==="top"&&r.direction==="column")return{newContainer:r.insertChild(t,this),existingContainer:this};if(e==="right"&&r.direction==="row"||e==="bottom"&&r.direction==="column")return{newContainer:r.insertChild(t),existingContainer:this}}let i,a=this.component;a instanceof Og?i=a.layerGroupViewer.toJSON():i=a.toJSON();let o,l,c=e==="left"||e==="right"?"row":"column";switch(e){case"left":case"top":o={type:c,children:[t,i]},l=0;break;case"right":case"bottom":o={type:c,children:[i,t]},l=1;break}this.setSpecification(o);let d=this.component;return{newContainer:d.get(l),existingContainer:d.get(1-l)}}};function E_(n){return{mouseState:n.mouseState,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,showScaleBar:n.showScaleBar,scaleBarOptions:n.scaleBarOptions,showPerspectiveSliceViews:n.showPerspectiveSliceViews,inputEventBindings:n.inputEventBindings,visibility:n.visibility,selectedLayer:n.selectedLayer,visibleLayerRoles:n.visibleLayerRoles,navigationState:n.navigationState.addRef(),perspectiveNavigationState:n.perspectiveNavigationState.addRef(),crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor}}var Og=class extends j{constructor(e,t,r){super();this.element=e;this.layerGroupViewer=this.registerDisposer(new ou(e,{display:r.display,layerSpecification:r.layerSpecification.addRef(),...E_(r)},{showLayerPanel:r.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:r.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}};function P_(n,e,t,r){n.addEventListener("dragenter",i=>{Bp(i)!==void 0&&n.classList.add("neuroglancer-drag-over")}),n.addEventListener("dragleave",()=>{Zt(n,"drop"),n.classList.remove("neuroglancer-drag-over")}),n.addEventListener("dragover",i=>{let a=(o,l)=>{o.dropEffectMessage&&(l+=` (${o.dropEffectMessage})`),Tr(n,"drop",l),i.stopPropagation(),i.preventDefault()};if(zC(i)){let o=T_(i,e);Op(i,o.dropEffect),a(o,`Drop to ${o.dropEffect} layer group as new ${r}`);return}if(Bp(i)!==void 0){let o=m_(i,e,!1,!0);a(o,`Drop to ${o.dropEffect} layer as new ${r}`);return}}),n.addEventListener("drop",i=>{n.classList.remove("neuroglancer-drag-over"),Zt(n,"drop");let a,o;if(zC(i)){i.stopPropagation();try{o=JSON.parse(i.dataTransfer.getData(Vg))}catch(d){return}if(a=Dg(i,e,{forceCopy:!1,newTarget:!0}),a===void 0)return}else{if(a=Dg(i,e,{forceCopy:Np()==="copy",newTarget:!0}),a===void 0)return;o=a.layoutSpec}if(!a.initializeExternalLayers(i)){if(!a.moveSupported)for(let d of a.layers.keys())d.dispose();return}i.preventDefault();let l=i.dataTransfer.dropEffect=Np();iu(l);let c=t();a.updateArchiveStates(i);for(let d of a.layers.keys())c.layerSpecification.add(d);try{c.restoreState(o)}catch{c.layout.reset()}})}var Ng=class extends j{constructor(e,t,r,i){super();this.element=e;this.direction=t;this.container=i;this.changed=new ae;e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(let a of r)this.insertChild(a)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){let t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",P_(t,this.viewer.layerSpecification,()=>{let r=t.nextElementSibling,i;return r!==null&&(i=zp.getFromElement(r)),this.insertChild({type:"viewer",layers:[]},i).component},this.direction==="row"?"column":"row"),e.registerDisposer(()=>{Xe(t)}),t}get viewer(){return this.container.viewer}get(e){return zp.getFromElement(this.element.children[e*2+1])}insertChild(e,t){let r=new zp(this.viewer,e,this),i=this.makeDropPlaceholder(r);r.element.classList.add("neuroglancer-stack-layout-child"),r.registerDisposer(r.changed.add(this.changed.dispatch)),r.registerDisposer(()=>{this.element.removeChild(r.element),this.changed.dispatch()});let a=t!==void 0?t.element:null;return this.element.insertBefore(r.element,a),this.element.insertBefore(i,a),this.changed.dispatch(),r}disposed(){this.clear(),super.disposed()}clear(){for(;this.length!==0;)this.get(0).dispose()}*[Symbol.iterator](){let{length:e}=this;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Array.from(this).map(e=>e.toJSON())}}};function J5(n,e){let t=document.createElement("div");if(t.style.flex="1",t.style.width="0px",typeof e=="string"){if(n.parent!==void 0)throw new Error(`Invalid layout component specification: ${JSON.stringify(e)}`);return new Og(t,e,n.viewer)}Q(e);let r=G(e,"type",ee);switch(r){case"row":case"column":return new Ng(t,r,G(e,"children",i=>{let a=ye(i,o=>o);if(n.parent===void 0&&a.length===0)throw new Error("Stack layout requires at least one child.");return a}),n);case"viewer":{let i=n.viewer,a=new Wp(i.layerSpecification.addRef()),o=new ou(t,{display:i.display,layerSpecification:a,...E_(i)},{showLayerPanel:i.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:i.uiControlVisibility.showLayerHoverValues});try{o.restoreState(e)}catch(l){throw o.dispose(),l}return o}default:return new Og(t,e,n.viewer)}}var $C=class extends j{constructor(e,t){super();this.viewer=e;this.defaultSpecification=t;this.container=this.registerDisposer(new zp(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}};var Bg=0,K5=Oe.fromObject({escape:{action:"close"}}),Xi=class extends j{constructor(){super();this.keyMap=new Oe;this.keyMap.addParent(K5,Number.NEGATIVE_INFINITY),++Bg;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new Co(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new zt(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--Bg,document.body.removeChild(this.container),super.disposed()}};var D_='<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeCrossedIconTitle"><path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"></path><circle cx="12" cy="12" r="3"></circle><path d="M3 21L20 4"></path></svg>';var A_='<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeIconTitle"><path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"></path><circle cx="12" cy="12" r="3"></circle></svg>';var I_='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="cursorIconTitle"><polygon points="7 20 7 4 19 16 12 16 7 21"></polygon></svg>';var Y5=Oe.fromObject({escape:{action:"cancel"}}),Ug=class extends j{constructor(e){super();this.layer=e;this.element=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";let r=this.registerDisposer(new zt(t,Y5));r.allShortcutsAreGlobal=!0,ce(t,"cancel",i=>{this.updateView(),t.blur(),i.stopPropagation(),i.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){Sg(this.layer,this.element.value)}},M_=class extends j{constructor(e){super();this.layer=e;this.element=document.createElement("select");this.measureElement=document.createElement("div");let{element:t,measureElement:r}=this;t.classList.add("neuroglancer-layer-side-panel-type"),r.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(r);for(let[i,a]of $p){if(a.type!==i)continue;let o=document.createElement("option");o.textContent=a.typeAbbreviation,o.value=i,t.appendChild(o)}t.addEventListener("change",()=>{let i=t.value,a=$p.get(i);Dp(this.layer.managedLayer,a)}),this.updateView()}updateView(){let e=this.layer.type,{element:t,measureElement:r}=this;r.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${r.offsetWidth}px`}disposed(){this.measureElement.remove()}},Hp=class extends Fr{constructor(e,t){super(e,t.location);this.panelState=t;let r=this.layer=t.layer,{element:i}=this,{titleBar:a}=this.addTitleBar({});a.classList.add("neuroglancer-layer-side-panel-title"),a.appendChild(this.registerDisposer(new M_(r)).element),a.appendChild(this.registerDisposer(new Ug(r.managedLayer)).element),this.registerDisposer(Rr(c=>{i.dataset.neuroglancerLayerVisible=c.toString()},{get value(){return r.managedLayer.visible},changed:r.managedLayer.layerChanged}));let o=this.registerDisposer(new lr({get value(){return r.managedLayer.pickEnabled},set value(c){r.managedLayer.pickEnabled=c},changed:r.managedLayer.layerChanged},{svg:I_,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new ar({get value(){return r.managedLayer.supportsPickOption},changed:r.managedLayer.layerChanged},o.element)),a.appendChild(o.element);let l={get value(){return t!==r.panels.panels[0]},set value(c){c?t.pin():t.unpin()},changed:r.manager.root.layerManager.layersChanged};a.appendChild(this.registerDisposer(new lr(l,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer(Rr(c=>{i.dataset.neuroglancerLayerPanelPinned=c.toString()},l)),a.appendChild(wi({title:"Delete layer",onClick:()=>{To(this.layer.managedLayer)}})),this.tabView=new tC({makeTab:c=>r.tabs.options.get(c).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new Ff({get value(){return t.tabs.map(c=>({id:c,label:r.tabs.options.get(c).label}))},changed:t.tabsChanged})),handleTabElement:(c,d)=>{d.draggable=!0,d.addEventListener("dragstart",p=>{p.stopPropagation(),p.dataTransfer.setData("neuroglancer-side-panel","");let m="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(v=>v!==t&&v.location.visible)&&(m+=`, or move tab to other ${JSON.stringify(r.managedLayer.name)} panel`),Tr(d,"drag",m),this.sidePanelManager.startDrag({dropAsNewPanel:v=>{this.panelState.splitOffTab(c,{...iC,...v})},canDropAsTabs:v=>v instanceof Hp&&v.layer===this.layer&&v!==this?1:0,dropAsTab:v=>{this.panelState.moveTabTo(c,v.panelState)}},p)}),d.addEventListener("dragend",p=>{Zt(d,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{t.tabs.length===0&&(this.location.visible=!1)}))}makeDragSource(){return{...super.makeDragSource(),canDropAsTabs:e=>e instanceof Hp&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}}}makeTabDropZone(){let e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{var a;let{dragSource:r}=this.sidePanelManager,i=(a=r==null?void 0:r.canDropAsTabs)==null?void 0:a.call(r,this);!i||(e.classList.add(pl),Tr(e,"drop",`Move ${i} ${i===1?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",()=>{Zt(e,"drop"),e.classList.remove(pl)}),e.addEventListener("dragover",t=>{var i;let{dragSource:r}=this.sidePanelManager;!((i=r==null?void 0:r.canDropAsTabs)==null?void 0:i.call(r,this))||t.preventDefault()}),e.addEventListener("drop",t=>{var i;Zt(e,"drop");let{dragSource:r}=this.sidePanelManager;!((i=r==null?void 0:r.canDropAsTabs)==null?void 0:i.call(r,this))||(e.classList.remove(pl),r.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}},jC=class extends j{constructor(e,t){super();this.sidePanelManager=e;this.selectedLayerState=t;this.layerSidePanels=new Map;this.generation=0;this.layersNeedUpdate=!0;let r=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(r)),this.registerDisposer(t.layerManager.layersChanged.add(r)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){var e,t;return(t=(e=this.selectedLayerState.layer)==null?void 0:e.layer)!=null?t:void 0}update(){var a;if(!this.layersNeedUpdate)return;let{layerManager:e}=this.selectedLayerState,t=++this.generation;this.layersNeedUpdate=!1;let{layerSidePanels:r}=this,i=o=>{let l=r.get(o);l===void 0?(l={generation:t,unregister:this.sidePanelManager.registerPanel({location:o.location,makePanel:()=>new Hp(this.sidePanelManager,o)})},r.set(o,l)):l.generation=t};{let o=this.getSelectedUserLayer(),{location:l}=this.selectedLayerState;if(o===void 0||!l.visible)this.placeholderSelectedLayerPanel===void 0&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:l,makePanel:()=>new Fr(this.sidePanelManager,l)}));else{(a=this.placeholderSelectedLayerPanel)==null||a.call(this),this.placeholderSelectedLayerPanel=void 0;let c=o.panels.panels[0];c.location.value=l.value,i(c)}}for(let o of e.managedLayers){let l=o.layer;if(l===null)continue;let{panels:c}=l.panels;for(let d=1,p=c.length;d<p;++d)i(c[d])}for(let[o,l]of r)l.generation!==t&&(l.unregister(),r.delete(o))}disposed(){var e;(e=this.placeholderSelectedLayerPanel)==null||e.call(this);for(let{unregister:t}of this.layerSidePanels.values())t()}};var X5={...yi,side:"left",row:0},qC=class{constructor(){this.location=new sr(X5)}get changed(){return this.location.changed}restoreState(e){e!==void 0&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return Mi(this.location.toJSON())}},R_=class extends j{constructor(e){super();this.layer=e;this.element=document.createElement("div");let{element:t}=this,r=$e({svg:A_,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),i=$e({svg:D_,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(i),t.appendChild(r);let a=()=>{let o=this.layer.visible;r.style.display=o?"":"none",i.style.display=o?"none":""};a(),this.registerDisposer(e.layerChanged.add(a))}};function Q5(n){let{selectedLayer:e}=n.manager.root,t=new lr({get value(){return e.layer===n&&e.visible},set value(r){r?(e.layer=n,e.visible=!0):e.visible=!1},changed:e.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:wg});return t.element.classList.add("neuroglancer-layer-list-panel-item-controls"),t}var __=class extends j{constructor(e,t){super();this.panel=e;this.layer=t;this.element=document.createElement("div");this.numberElement=document.createElement("div");this.generation=-1;let{element:r,numberElement:i}=this;r.classList.add("neuroglancer-layer-list-panel-item"),i.classList.add("neuroglancer-layer-list-panel-item-number"),r.appendChild(this.registerDisposer(new br({get value(){return!t.archived},set value(o){t.setArchived(!o)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),r.appendChild(i),r.appendChild(this.registerDisposer(new R_(t)).element),r.appendChild(this.registerDisposer(new Ug(t)).element),r.appendChild(this.registerDisposer(Q5(t)).element);let a=wi({title:"Delete layer",onClick:()=>{To(this.layer)}});a.classList.add("neuroglancer-layer-list-panel-item-delete"),r.appendChild(a),Ag(e,r,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),au(e,r,t,!0),r.addEventListener("click",o=>{o.ctrlKey?(e.selectedLayer.toggle(t),o.preventDefault()):o.altKey&&(t.pickEnabled=!t.pickEnabled,o.preventDefault())}),r.addEventListener("contextmenu",o=>{e.selectedLayer.toggle(t),o.stopPropagation(),o.preventDefault()})}},JC=class extends Fr{constructor(e,t,r){super(e,r.location);this.manager=t;this.state=r;this.items=new Map;this.itemContainer=document.createElement("div");this.layerDropZone=document.createElement("div");this.dragEnterCount=0;this.generation=-1;let{itemContainer:i,layerDropZone:a}=this,{titleElement:o}=this.addTitleBar({title:""});this.titleElement=o,i.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(i),a.style.flex="1";let l=this.registerCancellable(Ge(()=>this.render()));this.visibility.changed.add(l),this.registerDisposer(this.layerManager.layersChanged.add(l)),this.registerDisposer(this.selectedLayer.changed.add(l)),Ig(this),au(this,a,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){let e=this,t=this.selectedLayer.layer,r=++this.generation,i=0,a=0,o=0;this.layerManager.updateNonArchivedLayerIndices();function*l(){let{items:d}=e,p=0;for(let y of e.layerManager.managedLayers)y.archived||++p;let m=`${(p+1).toString().length}ch`;for(let y of e.layerManager.managedLayers){y.visible?++i:y.archived?++o:++a;let v=d.get(y);v===void 0&&(v=e.registerDisposer(new __(e,y)),d.set(y,v)),v.generation=r;let{nonArchivedLayerIndex:b}=y;v.numberElement.style.width=m,b===-1?v.numberElement.style.visibility="hidden":(v.numberElement.style.visibility="",v.numberElement.textContent=`${b+1}`),v.element.dataset.selected=(y===t).toString(),v.element.dataset.archived=y.archived.toString(),yield v.element}for(let[y,v]of d)r!==v.generation&&(d.delete(y),e.unregisterDisposer(v),v.dispose());yield e.layerDropZone}qn(this.itemContainer,l());let c="Layers";if(i||a||o){c+=" (";let d="";i+a&&(c+=`${i}/${a+i} visible`,d=", "),o&&(c+=`${d}${o} archived`),c+=")"}this.titleElement.textContent=c}},KC=class extends j{constructor(e){super();this.layerManager=e;this.element=document.createElement("div");let t=this.registerCancellable(Ge(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0,{managedLayers:t}=this.layerManager;for(let i of t)i.archived&&++e;let{element:r}=this;if(e!==0){let i=t.length;r.textContent=`${i-e}/${i}`}else r.textContent=""}};var vTe=at(N_()),STe=at(QC()),bTe=at(W_()),xTe=at($_());var ZC=at(ms()),j_=at(It());var Z5=100,ew=class extends Xi{constructor(e){super();this.viewer=e;this.parsedValue=null;this.debouncedValueUpdater=(0,j_.default)(()=>{let e=this.textEditor.getValue();try{let t=JSON.parse(e);this.parsedValue=t,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(t){this.parsedValue=null,this.applyButton.disabled=!0;let r=0,i=0,a="Unknown parse error";if(t instanceof Error){let o=t.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(o!==null){a=o[1];let l=parseInt(o[2],10),d=e.substring(0,l).split(`
`);r=d.length-1,i=d[d.length-1].length}else a=t.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:a,severity:"error",from:ZC.default.Pos(r,i)}]})}},Z5);this.content.classList.add("neuroglancer-state-editor");let t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;let r=this.closeButton=document.createElement("button");r.classList.add("close-button"),r.textContent="Close",this.content.appendChild(r),r.addEventListener("click",()=>this.dispose());let i=this.downloadButton=document.createElement("button");i.textContent="Download",i.title="Download state as a JSON file",this.content.appendChild(i),i.addEventListener("click",()=>this.downloadState()),this.textEditor=(0,ZC.default)(a=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){let e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),r=URL.createObjectURL(t);e.href=r,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){this.parsedValue!==null&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return JSON.stringify(hl(this.viewer.state).value,null,"  ")}};var q_=at(It());var eq={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1},tw=class{constructor(){this.location=new sr(eq)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return Mi(this.location.toJSON())}};function tq(n){let e=new Map;function t(r,i){if(typeof r!="object"){e.set(i,""+r);return}for(let a of Object.keys(r))t(r[a],i+"."+a)}return t(n,""),e}function nq(n){let e=new Set;e.add(".type");let t=new Set;function r(i,a){for(let o of e)if(n[i].get(o)!==n[a].get(o))return!0;return!1}for(let i=0,a=n.length;i<a;++i){for(let l of n[i].keys())t.add(l);let o=[];for(let l=0;l<i;++l)r(i,l)||o.push(l);for(;o.length>0;){let l=o,c;for(let d of t){if(e.has(d))continue;let p=[];for(let m of o)n[m].get(d)===n[i].get(d)&&p.push(m);if(p.length<l.length&&(l=p,c=d),p.length===0)break}if(c===void 0)break;o=l,e.add(c)}}return Array.from(e)}function rq(n,e){let t={};for(let r of e){let i=n.get(r);if(i!==void 0){if(r==="")return i;t[r]=i}}return JSON.stringify(t)}function iq(n){return Object.assign({type:n.RPC_TYPE_ID},n.key||{})}function aq(n){let e=n.map(tq),t=nq(e);return e.map(r=>rq(r,t))}var oq=1e3,nw=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:n=>{let e=0;for(let t=0;t<Wh;++t)e+=n[Zo(t,wa.VISIBLE)*ka+Ta.numChunks];return e}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:n=>n[Zo(nt.DOWNLOADING,wa.VISIBLE)*ka+Ta.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:n=>n[Zo(nt.SYSTEM_MEMORY,wa.VISIBLE)*ka+Ta.numChunks]+n[Zo(nt.SYSTEM_MEMORY_WORKER,wa.VISIBLE)*ka+Ta.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:n=>n[Zo(nt.GPU_MEMORY,wa.VISIBLE)*ka+Ta.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:n=>n[Zo(nt.FAILED,wa.VISIBLE)*ka+Ta.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:n=>n[Zo(nt.GPU_MEMORY,wa.VISIBLE)*ka+Ta.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:n=>n[WS(_d.totalTime)]/n[WS(_d.totalChunks)]}],rw=class extends Fr{constructor(e,t,r){super(e,r.location);this.chunkQueueManager=t;this.displayState=r;this.data=void 0;this.requestDataTimerId=-1;this.dataRequested=!1;this.body=document.createElement("div");this.debouncedUpdateView=this.registerCancellable((0,q_.default)(()=>this.updateView(),0));let{body:i}=this;i.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(i),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;let{chunkQueueManager:e}=this;this.dataRequested=!0,e.getStatistics().then(t=>{this.dataRequested=!1,this.data=t,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},oq)})}updateView(){let{data:e}=this;if(e===void 0)return;let t=document.createElement("table"),r=[];for(let[l,c]of e){let d=[l];for(let{getter:p}of nw)d.push(p(c));r.push(d)}let i=aq(r.map(l=>iq(l[0]))),a=new Map;i.forEach((l,c)=>{a.set(r[c][0],l)});{let l=document.createElement("thead"),c=document.createElement("tr");l.appendChild(c);let d=m=>{let y=document.createElement("td");y.textContent=m,c.appendChild(y)};d("Name");let p;for(let{label:m}of nw){let y=m.indexOf("/"),v=m;if(y!==-1){if(v=m.substring(0,y),v===p){++c.lastElementChild.colSpan;continue}p=v}d(v)}c=document.createElement("tr"),l.appendChild(c);{let m=document.createElement("td");c.appendChild(m)}for(let{label:m}of nw){let y=m.indexOf("/"),v="";y!==-1&&(v=m.substring(y+1));let b=document.createElement("td");b.textContent=v,c.appendChild(b)}t.appendChild(l)}let o=document.createElement("tbody");for(let[l,...c]of r){let d=document.createElement("tr"),p=m=>{let y=document.createElement("td");y.textContent=m,d.appendChild(y)};p(a.get(l));for(let m of c)p(""+m);o.appendChild(d)}t.appendChild(o),_e(this.body),this.body.appendChild(t)}};var Dl=class extends j{constructor(e,t=()=>J.fromValues(1,0,0)){super();this.model=e;this.getDefaultColor=t;this.element=document.createElement("input");let{element:r}=this;r.classList.add("neuroglancer-color-widget"),r.type="color",r.addEventListener("change",()=>this.updateModel()),r.addEventListener("input",()=>this.updateModel()),r.addEventListener("wheel",i=>{i.stopPropagation(),i.preventDefault(),this.adjustHueViaWheel(i)}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){var e;return(e=this.model.value)!=null?e:this.getDefaultColor()}updateView(){this.element.value=hn(this.getRGB())}updateModel(){this.model.value=ha(this.element.value)}adjustHueViaWheel(e){let t=this.getRGB(),r=J.create();f1(r,t[0],t[1],t[2]);let{deltaY:i}=e,a=Math.round(r[0]*256);a+=i>0?1:i<0?-1:0,a=(a+256)%256,r[0]=a/256,dl(r,r[0],r[1],r[2]),this.model.value=r}};var iw=class extends j{constructor(e,t={}){super();this.model=e;this.element=document.createElement("label");this.inputElement=document.createElement("input");let{validator:r,label:i}=t,{element:a,inputElement:o}=this;r===void 0&&(e instanceof ht?r=e.validator:r=l=>l),this.validator=r,i!==void 0&&(a.textContent=i),a.appendChild(o),a.className="neuroglancer-number-input",o.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(o,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Number.isNaN(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){Xe(this.element),super.disposed()}};var jp=class extends j{constructor(e){super();this.model=e;this.element=document.createElement("input");this.registerDisposer(e.changed.add(()=>this.updateView()));let{element:t}=this;t.type="text",this.registerEventListener(t,"change",()=>this.updateModel()),this.updateView()}disposed(){Xe(this.element)}updateView(){var e;this.element.value=((e=this.model.value)!=null?e:"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}};var sq={...yi,side:"left",row:2},aw=class{constructor(){this.location=new sr(sq)}get changed(){return this.location.changed}toJSON(){return Mi(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}},ow=class extends Fr{constructor(e,t,r){super(e,t.location);this.addTitleBar({title:"Settings"});let i=document.createElement("div");i.classList.add("neuroglancer-settings-body");let a=document.createElement("div");a.classList.add("neuroglancer-settings-scroll-container"),i.appendChild(a),this.addBody(i);{let d=this.registerDisposer(new jp(r.title));d.element.placeholder="Title",d.element.classList.add("neuroglancer-settings-title"),a.appendChild(d.element)}let o=(d,p)=>{let m=this.registerDisposer(new iw(p,{label:d}));m.element.classList.add("neuroglancer-settings-limit-widget"),a.appendChild(m.element)};o("GPU memory limit",r.chunkQueueManager.capacities.gpuMemory.sizeLimit),o("System memory limit",r.chunkQueueManager.capacities.systemMemory.sizeLimit),o("Concurrent chunk requests",r.chunkQueueManager.capacities.download.itemLimit);let l=(d,p)=>{let m=document.createElement("label");m.textContent=d;let y=this.registerDisposer(new br(p));m.appendChild(y.element),a.appendChild(m)};l("Show axis lines",r.showAxisLines),l("Show scale bar",r.showScaleBar),l("Show cross sections in 3-d",r.showPerspectiveSliceViews),l("Show default annotations",r.showDefaultAnnotations),l("Show chunk statistics",r.statisticsDisplayState.location.watchableVisible),l("Wire frame rendering",r.wireFrame),l("Enable prefetching",r.chunkQueueManager.enablePrefetch);let c=(d,p)=>{let m=document.createElement("label");m.textContent=d;let y=this.registerDisposer(new Dl(p));m.appendChild(y.element),a.appendChild(m)};c("Cross-section background",r.crossSectionBackgroundColor),c("Projection background",r.perspectiveViewBackgroundColor)}};var sw=class extends j{constructor(e,t){super();this.selectedLayer=e;this.toolBinder=t;this.element=document.createElement("div");this.viewContext=void 0;this.updateView=this.registerCancellable(Ge(()=>{let{viewContext:e}=this;e!==void 0&&(this.unregisterDisposer(e),e.dispose()),this.viewContext=e=this.registerDisposer(new j),_e(this.element);let{selectedTool:t}=this;t!==void 0&&this.element.appendChild(this.makeWidget(e,t));let r=Array.from(this.toolBinder.bindings);r.sort(([i],[a])=>ho(i,a));for(let[,i]of r)this.element.appendChild(this.makeWidget(e,i))}));let{element:r}=this;r.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){let e=this.selectedLayer.layer;if(e===void 0)return;let t=e.layer;if(t!==null)return t.tool.value}selectedLayerChanged(){let{unbindPreviousLayer:e}=this;e!==void 0&&e();let t=this.selectedLayer.layer;t!==void 0&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){let{unbindPreviousLayer:e}=this;e!==void 0&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){let r=document.createElement("div");r.title="dblclick \u2192 unbind",t instanceof Yi&&(r.title+=", click \u2192 bind key"),r.className="neuroglancer-annotation-tool-status-widget";let i=document.createElement("div");i.className="neuroglancer-annotation-tool-status-widget-layer-number";let{managedLayer:a}=t.layer;a.manager.rootLayers.updateNonArchivedLayerIndices();let o=a.nonArchivedLayerIndex;i.textContent=(o+1).toString();let l=document.createElement("div");if(l.className="neuroglancer-annotation-tool-status-widget-description",l.textContent=t.description,r.addEventListener("dblclick",()=>{t instanceof Ap?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof Yi){let c=document.createElement("div");c.className="neuroglancer-annotation-tool-status-widget-key",c.textContent=t.keyBinding,r.appendChild(c),pC(e,r,d=>t.layer.toolBinder.set(d,t.addRef()))}return r.appendChild(i),r.appendChild(l),r}};var J_=at(It());function lw(n){return encodeURI(n).replace(/[!'()*;,]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}var cw=class extends j{constructor(e,t,r={}){super();this.root=e;this.credentialsManager=t;this.parseError=new Re(void 0);let{updateDelayMilliseconds:i=200,defaultFragment:a="{}"}=r;this.registerEventListener(window,"hashchange",()=>this.updateFromUrlHash());let o=(0,J_.default)(()=>this.setUrlHash(),i);this.registerDisposer(e.changed.add(o)),this.registerDisposer(()=>o.cancel()),this.defaultFragment=a}setUrlHash(){let e=hl(this.root),{generation:t}=e;if(t!==this.prevStateGeneration){this.prevStateGeneration=e.generation;let r=lw(JSON.stringify(e.value));r!==this.prevStateString&&(this.prevStateString=r,decodeURIComponent(r)==="{}"?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+r))}}updateFromUrlHash(){try{let e=location.href.replace(/^[^#]+/,"");if((e===""||e==="#"||e==="#!")&&(e="#!"+this.defaultFragment),e.match(/^#!([a-z][a-z\d+-.]*):\/\//)){let t=e.substring(2),{url:r,credentialsProvider:i}=wn(t,this.credentialsManager);Ce.forPromise(cr(i,r,{},ut).then(a=>{Q(a),this.root.reset(),this.root.restoreState(a)}),{initialMessage:`Loading state from ${t}`,errorPrefix:"Error loading state:"})}else if(e.startsWith("#!+")){e=e.slice(3),e=decodeURIComponent(e);let t=nh(e);Q(t),this.root.restoreState(t),this.prevStateString=void 0}else if(e.startsWith("#!")){if(e=e.slice(2),e=decodeURIComponent(e),e===this.prevStateString)return;this.prevStateString=e,this.root.reset();let t=nh(e);Q(t),this.root.restoreState(t)}else throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');this.parseError.value=void 0}catch(e){this.parseError.value=e}}};var Y_=class extends j{constructor(e,t,r=""){super();this.gl=e;this.frameNumberCounter=t;let i=r+"chunk_worker.bundle.js";this.worker=new Worker(i),this.chunkQueueManager=this.registerDisposer(new Vd(new vS(this.worker),this.gl,this.frameNumberCounter,{gpuMemory:new Tc({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new Tc({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new Tc({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new Tc({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new Od(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}};var X_=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],Q_=[...X_,"showLayerPanel","showLayerHoverValues"],Z_=[...Q_,"showUIControls","showPanelBorders"];function lq(){return Object.fromEntries(Z_.map(n=>[n,new xt(!0)]))}function cq(n,e){for(let t of Z_){let r=e[t];r!==void 0&&(n[t].value=r)}}var uq=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS!="undefined"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0},eV=class extends ls{constructor(e){super();this.viewer=e;this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer)}restoreState(e){let{viewer:t}=this;super.restoreState(e),le(e,"navigation",r=>{Q(r),le(r,"pose",i=>{Q(i),le(i,"position",a=>{Q(a),an(a,"voxelCoordinates",t.position),le(a,"voxelSize",o=>{let l=He(new Float64Array(3),o,St);for(let c=0;c<3;++c)l[c]*=1e-9;t.coordinateSpace.value=Ne({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:l})})}),an(i,"orientation",t.crossSectionOrientation)}),an(r,"zoomFactor",t.crossSectionScale.legacyJsonView)}),an(e,"perspectiveOrientation",t.projectionOrientation),an(e,"perspectiveZoom",t.projectionScale.legacyJsonView),an(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}},Ga={expectingExternalUI:!1},uw=class extends j{constructor(e,t={}){super();this.display=e;this.title=new ht(void 0,ee);this.coordinateSpace=new js;this.position=this.registerDisposer(new Ji(this.coordinateSpace));this.relativeDisplayScales=this.registerDisposer(new hg(this.coordinateSpace));this.displayDimensions=this.registerDisposer(new mg(this.coordinateSpace));this.displayDimensionRenderInfo=this.registerDisposer(new kp(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef()));this.crossSectionOrientation=this.registerDisposer(new bo);this.crossSectionScale=this.registerDisposer(new qx(this.displayDimensionRenderInfo.addRef()));this.projectionOrientation=this.registerDisposer(new bo);this.crossSectionDepthRange=this.registerDisposer(new Lp(-10,this.displayDimensionRenderInfo));this.projectionDepthRange=this.registerDisposer(new Lp(-50,this.displayDimensionRenderInfo));this.projectionScale=this.registerDisposer(new Jx(this.displayDimensionRenderInfo.addRef()));this.navigationState=this.registerDisposer(new Ua(new Ba(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef()));this.perspectiveNavigationState=this.registerDisposer(new Ua(new Ba(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef()));this.mouseState=new dw;this.layerManager=this.registerDisposer(new Fg);this.selectedLayer=this.registerDisposer(new hw(this.layerManager.addRef()));this.showAxisLines=new xt(!0,!0);this.wireFrame=new xt(!1,!1);this.showScaleBar=new xt(!0,!0);this.showPerspectiveSliceViews=new xt(!0,!0);this.visibleLayerRoles=OD();this.showDefaultAnnotations=new xt(!0,!0);this.crossSectionBackgroundColor=new Go(J.fromValues(.5,.5,.5));this.perspectiveViewBackgroundColor=new Go(J.fromValues(0,0,0));this.scaleBarOptions=new bC;this.partialViewport=new Yv;this.statisticsDisplayState=new tw;this.helpPanelState=new DC;this.settingsPanelState=new aw;this.layerSelectedValues=this.registerDisposer(new pw(this.layerManager,this.mouseState));this.selectionDetailsState=this.registerDisposer(new fw(this.coordinateSpace,this.layerSelectedValues));this.selectedStateServer=new ht("",ee);this.layerListPanelState=new qC;this.resetInitiated=new ae;this.makeUrlFromState=e=>Ga.expectingExternalUI?"/#!"+lw(JSON.stringify(e)):window.location.toString();this.uiControlVisibility={};this.visible=!0;this.toolInputEventMapBinder=(e,t)=>{t.registerDisposer(this.inputEventBindings.sliceView.addParent(e,Number.POSITIVE_INFINITY)),t.registerDisposer(this.inputEventBindings.perspectiveView.addParent(e,Number.POSITIVE_INFINITY))};this.toolBinder=this.registerDisposer(new uC(this.toolInputEventMapBinder));let{dataContext:r=new Y_(e.gl,e,t.bundleRoot),visibility:i=new Pt(Pt.VISIBLE),inputEventBindings:a={global:new Oe,sliceView:new Oe,perspectiveView:new Oe},element:o=e.makeCanvasOverlayElement(),dataSourceProvider:l=yA({credentialsManager:Nn}),uiConfiguration:c=lq()}=t;this.visibility=i,this.inputEventBindings=a,this.element=o,this.dataSourceProvider=l,this.uiConfiguration=c,this.registerDisposer(Rr(v=>{this.display.applyWindowedViewportToElement(o,v)},this.partialViewport)),this.registerDisposer(()=>Xe(this.element)),this.dataContext=this.registerDisposer(r),cq(c,t);let d={...uq,...t},{resetStateWhenEmpty:p,showLayerDialog:m}=d;for(let v of Q_)this.uiControlVisibility[v]=this.makeUiControlVisibilityState(v);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=m,this.resetStateWhenEmpty=p,this.layerSpecification=new mw(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.toolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(or.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(or.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));let y=this.registerCancellable((0,K_.default)(()=>{!this.wasDisposed&&this.layerManager.managedLayers.length===0&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!Bg&&this.showLayerDialog&&this.visibility.visible&&Rg(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(y),y(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(_g(o,this.navigationState.position)),this.state=new eV(this)}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}get expectingExternalUI(){return Ga.expectingExternalUI}set expectingExternalUI(e){Ga.expectingExternalUI=e}makeUiControlVisibilityState(e){let t=this.uiConfiguration.showUIControls,r=this.uiConfiguration[e];return this.registerDisposer(gv((i,a)=>i&&a,t,r))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){let{element:e}=this,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){let e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";let t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";let r=this.registerDisposer(new hs(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner));this.registerDisposer(new ar(this.uiControlVisibility.showLocation,r.element)),t.appendChild(r.element);let i=this.registerDisposer(new FC(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(i.element.style.flex="1",i.element.style.alignSelf="center",this.registerDisposer(new ar(this.uiControlVisibility.showLocation,i.element)),t.appendChild(i.element),typeof NEUROGLANCER_CREDIT_LINK!="undefined"){let l=NEUROGLANCER_CREDIT_LINK;Array.isArray(l)||(l=[l]);for(let{url:c,text:d}of l){let p=document.createElement("a");p.style.marginRight="5px",p.href=c,p.textContent=d,p.style.fontFamily="sans-serif",p.style.color="yellow",p.target="_blank",t.appendChild(p)}}let a=this.registerDisposer(new sw(this.selectedLayer,this.toolBinder));if(t.appendChild(a.element),this.registerDisposer(new ar(this.uiControlVisibility.showAnnotationToolStatus,a.element)),s_){let l=this.registerDisposer(new PC(this));t.appendChild(l.element)}{let{layerListPanelState:l}=this,c=this.registerDisposer(new lr(l.location.watchableVisible,{svg:MR,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));c.element.insertAdjacentElement("afterbegin",this.registerDisposer(new KC(this.layerManager)).element),this.registerDisposer(new ar(this.uiControlVisibility.showLayerListPanelButton,c.element)),t.appendChild(c.element)}{let{selectionDetailsState:l}=this,c=this.registerDisposer(new lr(l.location.watchableVisible,{svg:RR,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new ar(this.uiControlVisibility.showSelectionPanelButton,c.element)),t.appendChild(c.element)}{let{selectedLayer:l}=this,c=this.registerDisposer(new lr({get value(){return l.visible},set value(d){l.visible=d},changed:l.location.locationChanged},{svg:wg,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new ar(this.uiControlVisibility.showLayerSidePanelButton,c.element)),t.appendChild(c.element)}{let l=$e({text:"{}",title:"Edit JSON state"});this.registerEventListener(l,"click",()=>{this.editJsonState()}),this.registerDisposer(new ar(this.uiControlVisibility.showEditStateButton,l)),t.appendChild(l)}{let l=Jn({title:"Copy view URL to clipboard",onClick:()=>{let c=en(this.makeUrlFromState(this.state.toJSON()));Ce.showTemporaryMessage(c?"URL copied to clipboard":"Failed to copy URL to clipboard")}});t.appendChild(l)}{let{helpPanelState:l}=this,c=this.registerDisposer(new lr(l.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new ar(this.uiControlVisibility.showHelpButton,c.element)),t.appendChild(c.element)}{let{settingsPanelState:l}=this,c=this.registerDisposer(new lr(l.location.watchableVisible,{svg:_R,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new ar(this.uiControlVisibility.showSettingsButton,c.element)),t.appendChild(c.element)}this.registerDisposer(new ar(gv((...l)=>l.reduce((c,d)=>c||d,!1),...X_.map(l=>this.uiControlVisibility[l])),t)),e.appendChild(t),this.layout=this.registerDisposer(new $C(this,"4panel")),this.sidePanelManager=this.registerDisposer(new yb(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new JC(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new jC(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new vm(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.closeSelectionTab=()=>{for(let l of this.sidePanelManager.registeredPanels)l.panel instanceof vm&&l.panel.close()},this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new rw(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{let{inputEventBindings:l}=this;return new AC(this.sidePanelManager,this.helpPanelState,[["Global",l.global],["Cross section view",l.sliceView],["3-D projection view",l.perspectiveView]],this.layerManager,this.toolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new ow(this.sidePanelManager,this.settingsPanelState,this)}));let o=()=>{let l=this.visibility.visible;l!==this.visible&&(e.style.visibility=l?"inherit":"hidden",this.visible=l)};o(),this.registerDisposer(this.visibility.changed.add(o))}registerEventActionBindings(){let{element:e}=this;this.registerDisposer(new zt(e,this.inputEventMap)),this.registerDisposer(new Co(e))}bindAction(e,t){this.registerDisposer(ce(this.element,e,t))}bindCallback(e,t){let r=()=>{t(this)};this.registerDisposer(ce(this.element,e,r))}registerActionListeners(){for(let e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e),this.closeSelectionTab&&this.closeSelectionTab()});for(let e of["select"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)});for(let e of["copy-segment-id","add-copy-segment-id"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e,this.selectedLayer.layer)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){let t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{let e=this.selectedLayer.layer;if(e===void 0){Ce.showTemporaryMessage("The annotate command requires a layer to be selected.");return}let t=e.layer;if(t===null||t.tool.value===void 0){Ce.showTemporaryMessage(`The selected layer (${JSON.stringify(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e){this.toolBinder.activate(e)}editJsonState(){new ew(this)}copyJsonStateToUrl(){en(this.makeUrlFromState(this.state.toJSON()))}showStatistics(e=void 0){e===void 0&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let{chunkQueueManager:e}=this.dataContext;e.chunkUpdateDeadline===null&&(e.chunkUpdateDeadline=Date.now()+10)}}};var nV="tool",rV="toolBindings",gw="localPosition",iV="localDimensions",aV="source",dq="transform",oV="pick",sV=class{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}},Ti=class extends j{constructor(e){super();this.managedLayer=e;this.pick=new xt(!0,!0);this.layersChanged=new ae;this.readyStateChanged=new ae;this.specificationChanged=new ae;this.renderLayers=new Array;this.loadingCounter=1;this.tabs=this.registerDisposer(new eC);this.panels=new aC(this);this.tool=this.registerDisposer(new cC(this));this.toolBinder=new dC(this);this.dataSourcesChanged=new ae;this.dataSources=[];this.allowingRefresh=!1;this.localCoordinateSpaceCombiner.includeDimensionPredicate=cS,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("source",{label:"Source",order:-100,getter:()=>new rC(this)})}get localPosition(){return this.managedLayer.localPosition}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=io,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){let r=e.localCoordinateSpace=this.localCoordinateSpace.value,{rank:i}=r;if(i!==0){let o=le(t,gw,l=>He(new Float32Array(i),l,Ye));o===void 0?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=o)}(e.annotationId=le(t,"annotationId",ee))!==void 0&&(e.annotationSourceIndex=le(t,"annotationSource",ot,0),e.annotationPartIndex=le(t,"annotationPart",ot),e.annotationSubsource=le(t,"annotationSubsource",ee)),e.value=t.value}displaySelectionState(e,t,r){return!1}selectionStateToJson(e,t){let r={};if(e.localPositionValid){let{localPosition:i}=e;i.length>0&&(r.localPosition=Array.from(i))}return e.annotationId!==void 0&&(r.annotationId=e.annotationId,r.annotationPart=e.annotationPartIndex,r.annotationSource=e.annotationSourceIndex,r.annotationSubsource=e.annotationSubsource),e.value!=null&&(r.value=e.value),r}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;let r=this.localPosition.value,{localPosition:i}=e;i.length!==r.length?e.localPosition=r.slice():i.set(r),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;let r=t.localPosition,{localPosition:i}=e;i.length!==r.length?e.localPosition=r.slice():e.localPosition.set(r),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return this.loadingCounter===0}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){let t=new Wx(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){function*e(){for(let t of this.dataSources){let{loadState:r}=t;if(!(r===void 0||r.error!==void 0))for(let i of r.subsources)if(i.enabled)yield i;else{let{activated:a}=i;i.messages.clearMessages(),a!==void 0&&(a.dispose(),i.activated=void 0,r.activatedSubsourcesChanged.dispatch())}}}this.activateDataSubsources(e.call(this))}decrementLoadingCounter(){--this.loadingCounter==0&&this.readyStateChanged.dispatch()}markLoading(){let e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return++this.loadingCounter==1&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){let t=this.manager.root.coordinateSpaceCombiner.bind(e),r=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}initializationDone(){let e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,r,i){return e===void 0?[]:[bl(e,r)]}getDataSourceSpecifications(e){let t,r=G(e,aV,a=>Array.isArray(a)?a.map(o=>bl(o)):typeof a=="object"?[bl(a)]:(t=a,[])),i=G(e,dq,qE);return r.push(...this.getLegacyDataSourceSpecifications(t,e,i,r)),r=r.filter(a=>a.url),r.length===0&&r.push(Yh()),r}restoreState(e){this.tool.restoreState(e[nV]),this.toolBinder.restoreState(e[rV]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[iV]),this.localPosition.restoreState(e[gw]),this.constructor.supportsPickOption&&this.pick.restoreState(e[oV]);for(let t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);let{layersChanged:t}=this;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){let{renderLayers:t,layersChanged:r}=this,i=t.indexOf(e);if(i===-1)throw new Error("Attempted to remove invalid RenderLayer");t.splice(i,1),e.layerChanged.remove(r.dispatch),e.userLayer=void 0,e.dispose(),r.dispatch()}disposed(){let{layersChanged:e}=this;Xa(this.dataSources);for(let t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let r,{renderLayers:i}=this,{pickedRenderLayer:a}=t;if(a!==null&&i.indexOf(a)!==-1&&(r=a.transformPickedValue(t),r=this.transformPickedValue(r),r!=null))return r;for(let o of i)if(r=o.getValueAt(e),r!=null)break;return this.transformPickedValue(r)}transformPickedValue(e){return e}toJSON(){return{type:this.type,[aV]:pq(this.dataSources),[nV]:this.tool.toJSON(),[rV]:this.toolBinder.toJSON(),[iV]:this.localCoordinateSpace.toJSON(),[gw]:this.localPosition.toJSON(),[oV]:this.pick.toJSON(),...this.panels.toJSON()}}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){let{globalPosition:r}=this.manager.root,{localPosition:i}=this;e?(dv(r.value,t,e.globalToRenderLayerDimensions),dv(i.value,t,e.localToRenderLayerDimensions)):r.value.set(t),i.changed.dispatch(),r.changed.dispatch()}};Ti.supportsPickOption=!1;function pq(n){if(n.length!==0)return n.length===1?n[0].toJSON():n.map(e=>e.toJSON())}var Up=class extends j{constructor(e,t){super();this.manager=t;this.localCoordinateSpace=new js;this.localCoordinateSpaceCombiner=new vc(this.localCoordinateSpace,qo);this.localPosition=this.registerDisposer(new Ji(this.localCoordinateSpace));this.nonArchivedLayerIndex=-1;this.readyStateChanged=new ae;this.layerChanged=new ae;this.specificationChanged=new ae;this.containers=new Set;this.layer_=null;this.visible=!0;this.archived=!1;this.name_=e}get layer(){return this.layer_}set layer(e){let t=this.layer_;if(t!=null&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,e!=null){let r=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{r.forEach(i=>i())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){let{layer:e}=this;return e!==null&&e.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){let e=this.layer;return e!==null&&e.constructor.supportsPickOption}get pickEnabled(){let e=this.layer;return e!==null&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){let t=this.layer;t!==null&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){let e=this.layer;if(e===null)return;let t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(e===!0){this.visible=!1,this.archived=!0;for(let{layerManager:t}of this.manager.root.subsets)!t.has(this)||t.removeManagedLayer(this)}else{for(let{layerManager:t}of this.manager.root.subsets)t.has(this)||t.addManagedLayer(this.addRef());this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}},Fg=class extends j{constructor(){super();this.managedLayers=new Array;this.layerSet=new Set;this.layersChanged=new ae;this.readyStateChanged=new ae;this.specificationChanged=new ae;this.boundPositions=new WeakSet;this.numDirectUsers=0;this.nonArchivedLayerIndexGeneration=-1;this.renderLayerToManagedLayerMapGeneration=-1;this.renderLayerToManagedLayerMap_=new Map;this.scheduleRemoveLayersWithSingleRef=this.registerCancellable((0,Gg.default)(()=>this.removeLayersWithSingleRef(),0));this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){let e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(let r of this.managedLayers)r.archived||(r.nonArchivedLayerIndex=t++);for(let r of this.managedLayers)r.archived&&(r.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(let r of this.managedLayers)if(!r.archived){if(t===e)return r;++t}}get renderLayerToManagedLayerMap(){let e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(let r of this.managedLayers){let i=r.layer;if(i!==null)for(let a of i.renderLayers)t.set(a,r)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(r=>e(r)?!0:(this.unbindManagedLayer(r),this.layerSet.delete(r),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter(e=>e.refCount!==1||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return++this.numDirectUsers==1&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{--this.numDirectUsers==0&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,IR),this.layerSet.add(e),e.containers.add(this),t===void 0&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,AR),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){let t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(t===-1)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){let r=this.managedLayers.length;if(e===t||e<0||e>=r||t<0||t>=r)return;let[i]=this.managedLayers.splice(e,1);this.managedLayers.splice(t,0,i),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,r=0;for(;this.getLayerByName(t)!==void 0;)t=e+ ++r;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(t.layer!==null)for(let r of t.layer.renderLayers)yield r}}}get visibleRenderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(!(t.layer===null||!t.visible))for(let r of t.layer.renderLayers)yield r}}}invokeAction(e,t){let r=new sV;for(let i of this.managedLayers){if(i.layer===null||!i.visible||t!==void 0&&i!==t)continue;let a=i.layer;a.handleAction(e,r);for(let o of a.renderLayers)o.handleAction(e)}for(let i of r.callbacks)i()}},dw=class{constructor(){this.changed=new ae;this.coordinateSpace=Qr;this.position=io;this.unsnappedPosition=io;this.active=!1;this.displayDimensions=void 0;this.pickedRenderLayer=null;this.pickedValue=new X(0,0);this.pickedOffset=0;this.pickedAnnotationLayer=void 0;this.pickedAnnotationId=void 0;this.pickedAnnotationBuffer=void 0;this.pickedAnnotationBufferBaseOffset=void 0;this.pickedAnnotationIndex=void 0;this.pickedAnnotationCount=void 0;this.pickedAnnotationType=void 0;this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,e===void 0&&this.setActive(!1)}updateUnconditionally(){let{forcerFunction:e}=this;return e===void 0?!1:(e(),this.active)}setActive(e){(this.active!==e||e===!0)&&(this.active=e,this.changed.dispatch())}},pw=class extends j{constructor(e,t){super();this.layerManager=e;this.mouseState=t;this.changed=new ae;this.needsUpdate=!0;this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState,t=this.changed.count;if(e.active)for(let r of this.layerManager.managedLayers){let i=r.layer;if(r.visible&&i!==null){let{selectionState:a}=i;a&&(i.resetSelectionState(a),a.generation=t,i.captureSelectionState(a,e))}}}get(e){this.update();let{selectionState:t}=e;if(!(t&&t.generation!==this.changed.count))return t}toJSON(){this.update();let e={};for(let t of this.layerManager.managedLayers){let r=t.layer;if(r){let i=this.get(r);i!==void 0&&(e[t.name]=r.selectionStateToJson(i,!0))}}return e}},lV=10,yw={...yi,minSize:150,row:1},cV={...yw,visible:!0},fw=class extends j{constructor(e,t){super();this.coordinateSpace=e;this.layerSelectedValues=t;this.changed=new ae;this.history=[];this.historyIndex=0;this.location=new sr(yw);this.pin=new Re(!0);this.registerDisposer(Dn((r,i)=>{i||(this.capture(!0),r.registerDisposer(t.changed.add(r.registerCancellable((0,tV.default)(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){let e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return this.pin.value?this.historyIndex+1<this.history.length:!1}goForward(){if(!this.pin.value)return;let e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,e!==void 0&&this.pin.value){let{history:t}=this;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>lV&&t.splice(0,t.length-lV),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,r=!0,i=!0){if(r===!1&&(!this.location.visible||this.pin.value))return;let a={};e.initializeSelectionState(a),t(a)&&(i&&(this.location.visible=!0),r===!0?this.pin.value=!0:r==="toggle"&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:a}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){let{value:e}=this,t;if(this.location.visible){if(t=this.location.toJSON({...cV,visible:!Ga.expectingExternalUI}),this.pin.value&&e!==void 0){let r={};for(let i of e.layers){let{layer:a}=i,o=a.selectionStateToJson(i.state,!1);Object.keys(o).length===0&&(o=void 0),r[i.layer.managedLayer.name]=o}e.position!==void 0&&(t.position=Array.from(e.position)),t.layers=r}}else t=this.location.toJSON(yw),t=Mi(t),t!==void 0&&(t.visible=!1);return t}select(e=!0){let{pin:t}=this;e&&(this.location.visible=!0),t.value=!t.value,t.value&&this.capture()}capture(e=!1){let t=fq(this.layerSelectedValues);e&&t===void 0||(this.value=t)}restoreState(e){if(e===void 0){this.pin.value=!0,this.value=void 0;return}if(e===null){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}Q(e),this.location.restoreState(e,{...cV,visible:!Ga.expectingExternalUI});let t=this.coordinateSpace.value,r=t.rank>0?le(e,"position",a=>He(new Float32Array(t.rank),a,Ye)):void 0,i=[];le(e,"layers",a=>{Q(a);let{layerManager:o}=this.layerSelectedValues;for(let[l,c]of Object.entries(a)){let d=o.getLayerByName(l);if(d===void 0)return;let p=d.layer;if(p===null)return;Q(c);let m={};p.initializeSelectionState(m),p.selectionStateFromJson(m,c),i.push({layer:p,state:m})}}),this.pin.value=i.length>0||r!==void 0,this.value={position:r,coordinateSpace:t,layers:i}}};function fq(n){let{mouseState:e}=n;if(!e.active)return;let t=[];for(let r of n.layerManager.managedLayers){let i=r.layer;if(i===null)continue;let a=n.get(i);if(a===void 0)continue;let o={};i.initializeSelectionState(o),i.copySelectionState(o,a),t.push({layer:i,state:o})}return{position:e.position.slice(),coordinateSpace:e.coordinateSpace,layers:t}}var uV=class extends j{constructor(e){super();this.view=e;this.messages=new Gi;this.seenGeneration=-1;this.state=void 0}},hq=0,dV=class extends j{constructor(e,t,r,i,a,o){super();this.layerManager=e;this.renderLayerType=t;this.view=r;this.roles=i;this.layerAdded=a;this.visibility=o;this.visibleLayers_=new Map;this.debouncedUpdateVisibleLayers=this.registerCancellable((0,Gg.default)(()=>this.updateVisibleLayers(),0));this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(i.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){let e=++hq,{visibleLayers_:t,renderLayerType:r,layerAdded:i,roles:a}=this;for(let o of this.layerManager.readyRenderLayers())if(o instanceof r&&a.has(o.role)){let l=o,c=t.get(l);c===void 0&&(c=new uV(this.view),c.registerDisposer(l.messages.addChild(c.messages)),c.registerDisposer(l.addRef()),c.registerDisposer(l.visibility.add(this.visibility)),t.set(l,c),i(l,c),l.attach(c)),c.seenGeneration=e}for(let[o,l]of t)l.seenGeneration!==e&&(t.delete(o),l.dispose())}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}};function Lg(n,e,t,r,i){return r.registerDisposer(new dV(n,e,r,t,(a,o)=>{o.registerDisposer(a.redrawNeeded.add(()=>r.scheduleRedraw()));let{backend:l}=a;l&&(l.rpc.invoke(MD,{layer:l.rpcId,view:r.rpcId}),o.registerDisposer(()=>l.rpc.invoke(RD,{layer:l.rpcId,view:r.rpcId}))),i!==void 0&&i(a,o),r.scheduleRedraw(),o.registerDisposer(()=>r.scheduleRedraw())},r.visibility))}var hw=class extends j{constructor(e){super();this.layerManager=e;this.changed=new ae;this.location=new sr(ER);this.registerDisposer(e),this.location.changed.add(()=>{var r,i;this.changed.dispatch();let t=(i=(r=this.layer)==null?void 0:r.layer)!=null?i:void 0;if(t!==void 0){let a=this.location.value;if(a.visible){let o=t.panels.panels[0];o.location.value!==a&&(o.location.value=a,o.location.locationChanged.dispatch())}}})}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(e===!0&&t===void 0){let{managedLayers:r}=this.layerManager;r.length>0?t=this.layer=r[0]:e=!1}if(e===!0&&t!==void 0){let r=t.layer;(r===null||r.panels.panels[0].tabs.length===0)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&t!==void 0&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;let t=e.layer;t!==null&&t instanceof Ki&&(t.dataSources.some(r=>r.spec.url.length!==0)||To(e))}set layer(e){if(e===this.layer_)return;let t=this.layer_;if(t!==void 0&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,e!==void 0){let r=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(r);let i=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{let a=e.layer;if(a!==null){let o=a.tool.value;o!==void 0&&o.deactivate()}e.unregisterDisposer(r),i()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){let e=this.location.toJSON();return this.layer!==void 0&&(e.layer=this.layer.name),Mi(e)}restoreState(e){if(e===void 0){this.reset();return}Q(e),this.location.restoreState(e);let t=G(e,"layer",Ft),r=t!==void 0?this.layerManager.getLayerByName(t):void 0;r===void 0&&(this.visible=!1),this.layer=r}reset(){this.location.reset(),this.layer=void 0}},vw=class extends j{constructor(e,t){super();this.layerManager=e;this.filter=t;this.changed=new ae;this.validate=(0,Gg.default)(()=>{let{layerName_:e}=this;if(e!==void 0){let t=this.layerManager.getLayerByName(e);t!==void 0&&this.filter(t)?(this.layer_=t,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}},0);this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{let{layer_:r}=this;if(r!==void 0)if(!this.layerManager.layerSet.has(r)||!this.filter(r))this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch();else{let{name:i}=r;i!==this.layerName_&&(this.layerName_=i,this.changed.dispatch())}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(e!==void 0&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){let t=Ft(e);this.layerName=t}toJSON(){let{layer_:e}=this;return e!==void 0?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}},Wg=class extends j{constructor(e,t,r,i){super();this.layerManager=e;this.layer=t;this.predicate=r;this.getGroup=i;this.linkedLayers_=new Set;this.changed=new ae;this.linkedLayersChanged=new ae;this.root_=t;let a=this;this.root={get value(){return a.root_},changed:a.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(e===void 0)return;let t=ee(e);this.linkByName(t)}toJSON(){let{root:{value:e}}=this;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){let{getGroup:t,layer:r,root_:i}=this;if(i===r){let{linkedLayers_:o}=this;if(o.size!==0){for(let l of o){let c=t(l);c.root_=l,c.changed.dispatch()}o.clear(),this.linkedLayersChanged.dispatch()}return}let a=t(i);a.linkedLayers_.delete(r),a.linkedLayersChanged.dispatch(),this.root_=r,e&&this.changed.dispatch()}linkByName(e){let{layer:t}=this,{managedLayer:r}=t,{layerManager:i}=this,a=i.getLayerByName(e);if(a===void 0||a===r)return;let o=a.layer;o!==null&&(!this.predicate(o)||this.linkToLayer(o))}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);let{getGroup:t}=this,r=t(e).root_;if(r===this.layer)return;let i=t(r);i.linkedLayers_.add(this.layer),i.linkedLayersChanged.dispatch(),this.root_=r,this.changed.dispatch()}disposed(){this.isolate(!1)}};function pV(n,e){let t=le(e,"type",ee,"auto");n.archived=le(e,"archived",Ii,!1),n.archived?n.visible=!1:n.visible=le(e,"visible",Ii,!0);let r=$p.get(t)||Ki;return n.layer=new r(n),e}function fV(n,e){try{let t=n.layer;if(t===null)return;t.restoreState(e),t.initializationDone()}catch(t){throw To(n),t}}function hV(n,e){try{Q(e),pV(n,e),fV(n,e)}catch(t){throw To(n),t}}function g_(n,e){try{hV(n,e)}catch(t){new Ce().setErrorMessage(t instanceof Error?t.message:""+t)}}function WC(n,e,t){let r=new Up(e,n);return hV(r,t),r}var Sw=class extends j{constructor(){super(...arguments);this.changed=new ae}},mw=class extends Sw{constructor(e,t,r,i,a,o,l,c,d){super();this.display=e;this.dataSourceProviderRegistry=t;this.layerManager=r;this.chunkManager=i;this.selectionState=a;this.selectedLayer=o;this.coordinateSpace=l;this.globalPosition=c;this.toolBinder=d;this.coordinateSpaceCombiner=new vc(this.coordinateSpace,HE);this.subsets=new Set;this.layerSelectedValues=this.selectionState.layerSelectedValues;this.registerDisposer(r.layersChanged.add(this.changed.dispatch)),this.registerDisposer(r.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){this.layerManager.clear();let t;Array.isArray(e)?t=e:(Q(e),t=Object.entries(e).map(([i,a])=>typeof a=="string"?{name:i,source:a}:(Q(a),{...a,name:i})));let r=[];for(let i of t){Q(i);let a=this.layerManager.getUniqueLayerName(G(i,"name",ee)),o=new Up(a,this);try{pV(o,i),this.layerManager.addManagedLayer(o),r.push({managedLayer:o,spec:i})}catch(l){o.dispose(),new Ce().setErrorMessage(`Error creating layer ${JSON.stringify(a)}: `+(l instanceof Error)?l.message:""+l)}}for(let{managedLayer:i,spec:a}of r)try{fV(i,a)}catch(o){new Ce().setErrorMessage(`Error creating layer ${JSON.stringify(name)}: `+(o instanceof Error)?o.message:""+o)}}add(e,t){this.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){let e=[],t=0;for(let r of this.layerManager.managedLayers){let i=r.toJSON();i!=null&&(e.push(i),++t)}if(t!==0)return e}get rootLayers(){return this.layerManager}},Wp=class extends Sw{constructor(e){super();this.master=e;this.changed=new ae;this.layerManager=this.registerDisposer(new Fg);this.registerDisposer(e);let{layerManager:t}=this;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){let t=this.master.layerManager,r=[];for(let i of new Set(ye(e,ee))){let a=t.getLayerByName(i);if(a===void 0)throw new Error(`Undefined layer referenced in subset specification: ${JSON.stringify(i)}`);a.archived||r.push(a)}this.layerManager.clear();for(let i of r)this.layerManager.addManagedLayer(i.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){this.master.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}},$p=new Map,bw=new Map,mV=[n=>{let{volume:e}=n;if(e===void 0)return;let t=bw.get(e.volumeType);if(t!==void 0)return{layerConstructor:t,priority:0}}];function Qi(n,e=n.type){$p.set(e,n)}function gs(n){mV.push(n)}function zg(n,e){bw.set(n,e)}function Dp(n,e){let t=n.layer;if(t===null)return;let r=t.toJSON(),i=new e(n);i.restoreState(r),i.initializationDone(),n.layer=i}function Sg(n,e){return e!==n.name?(e=n.manager.root.layerManager.getUniqueLayerName(e),n.name=e,n.layerChanged.dispatch(),!0):!1}function To(n){if(!n.wasDisposed)for(let e of n.containers)e.removeManagedLayer(n)}function xw(n,e){return n===void 0?e:e===void 0?n:n.priority<e.priority?e:n}function mq(n){let e;for(let r of mV)e=xw(e,r(n));let{volume:t}=n;if(t!==void 0){let r=bw.get(t.volumeType);r!==void 0&&(e=xw(e,{layerConstructor:r,priority:0}))}return e}function gV(n){let e;for(let t of n){let{subsourceEntry:r}=t,{subsource:i}=r;e=xw(e,mq(i))}return e}var Ki=class extends Ti{activateDataSubsources(e){var t;this.detectedLayerConstructor=(t=gV(e))==null?void 0:t.layerConstructor}};Ki.type="new",Ki.typeAbbreviation="new";var Hg=class extends Ti{activateDataSubsources(e){var r;let t=(r=gV(e))==null?void 0:r.layerConstructor;t!==void 0&&Dp(this.managedLayer,t)}};Hg.type="auto",Hg.typeAbbreviation="auto";function Rg(n,e){let t=WC(n,"new layer",{type:"new"});n.add(t),e.layer=t,e.visible=!0}Qi(Ki);Qi(Hg);var gq=J.create(),yq=J.create(),$g=.001,yV=.001;function vV(n){let e=0;for(var t=0;t<3;++t)n[t]<0&&(e+=1<<t);return e}var jg=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),SV=(()=>{let n=[0,1,2,4,5,3,6,7],e=[0,1,2,5,3,4,6,7],t=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],r=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],i=new Int32Array(8*8*6);for(let a=0;a<8;++a)for(let o=0;o<t.length;++o){let l=e[a]*8+t[o];i[a*8*6+o]=n[r[l]]}return i})();function Al(n){n.addUniform("highp vec3","uPlaneNormal"),n.addUniform("highp float","uPlaneDistance"),n.addUniform("highp ivec2","uVertexIndex",24),n.addUniform("highp vec3","uVertexBasePosition",8),n.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),jg)}),n.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > ${yV}) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -${$g}) && (lambda <= (1.0 + ${$g}))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function bV(n,e,t,r,i,a,o,l=!0){let c=vV(i),d=SV.subarray(c*48,(c+1)*48),p=[0,0],m=[J.create(),J.create()],y=J.create(),v=J.create(),b=x=>jg.subarray(x*3,x*3+3);for(let x=0;x<4;++x){for(let k=0;k<2;++k)p[k]=d[2*(o*4+x)+k],J.multiply(m[k],n,b(p[k])),J.add(m[k],m[k],a),J.min(m[k],m[k],t),J.max(m[k],m[k],e);J.subtract(y,m[1],m[0]);let C=J.dot(y,i);if(Math.abs(C)>yV){let k=(r-J.dot(m[0],i))/C;if(k>=-$g&&k<=1+$g)return l&&console.log(`vertex ${o}, e = ${x}, good, lambda=${k}, denom=${C}, v0=${m[0].join()}, vDir=${y.join()}`),k=Math.max(0,Math.min(1,k)),J.scaleAndAdd(v,m[0],y,k),v;l&&console.log(`vertex ${o}, e = ${x}, skipped, denom = ${C}, vDir = ${y.join()}, v0=${m[0].join()}, v1=${m[1].join()}uPlaneNormal = ${Fo(i)}, lambda=${k}`)}else l&&console.log(`vertex ${o}, e = ${x}, skipped, deom = ${C}, vDir = ${Fo(y)}, uPlaneNormal = ${Fo(i)}, uLowerClipBound=${e.join()}, uUpperClipBound=${t.join()}, chunkSize=${n}, uVertexBasePosition(v0)=${b(p[0]).join()}, uVertexBasePosition(v1)=${b(p[1]).join()}, uTranslation=${a.join()}`)}}function vq(n,e,t){let{gl:r}=n;r.uniform3fv(n.uniform("uPlaneNormal"),e),r.uniform1f(n.uniform("uPlaneDistance"),t);let i=vV(e);r.uniform2iv(n.uniform("uVertexIndex"),SV.subarray(i*48,(i+1)*48))}function su(n,e,t,r,i){let a=Kf(gq,e,r);J.normalize(a,a);let o=J.dot(J.transformMat4(yq,t,i),a);vq(n,a,o)}var Cw=!1,xV=.001,CV=re.create();function Sq(n,e){if(Yn(n),Al(n),n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),e){_n(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${Si};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}n.addVarying("highp vec3","vChunkPosition"),n.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    ${xV} * abs(uPlaneNormal);
`)}function bq(n,e,t,r,i,a,o){let l=J.create(),c=J.create(),d=J.fromValues(Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])),p=J.create();for(let m=0;m<6;++m){let y=bV(n,e,t,r,i,a,m);if(y===void 0){console.log("no intersection found");return}J.transformMat4(l,y,o);let v=m!==0&&J.equals(l,p);J.copy(p,l),J.sub(c,y,a),J.scaleAndAdd(c,c,d,xV),console.log(`${v?"SKIPPED":"OUTPUT"} vertex ${m}, at ${l}, vChunkPosition = ${c}, uTranslation=${a.join()}, position=${y.join()}`)}}function xq(n,e,t){t&&On(n,e,1)}function Cq(n,e,t,r,i,a){let o=t.projectionParameters.value,{centerDataPosition:l}=o;su(e,o.viewportNormalInGlobalCoordinates,l,a.transform,a.invTransform),n.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,re.multiply(CV,r,a.transform)),n.uniform3fv(e.uniform("uLowerClipBound"),i.lowerClipDisplayBound),n.uniform3fv(e.uniform("uUpperClipBound"),i.upperClipDisplayBound),Cw&&(window.debug_sliceView_uLowerClipBound=i.lowerClipDisplayBound,window.debug_sliceView_uUpperClipBound=i.upperClipDisplayBound,window.debug_sliceView=t,window.debug_sliceView_dataToDevice=re.clone(CV),window.debug_sliceView_chunkLayout=a)}function wq(n,e,t){n.uniform3fv(e.uniform("uChunkDataSize"),t),Cw&&(window.debug_sliceView_chunkDataSize=t)}function Tq(n,e,t,r){if(n.uniform3fv(e.uniform("uTranslation"),t),r?Vn(e.gl,6,1):n.drawArrays(n.TRIANGLE_FAN,0,6),Cw){let a=window.debug_sliceView.projectionParameters.value,o=window.debug_sliceView_chunkDataSize,l=window.debug_sliceView_uLowerClipBound,c=window.debug_sliceView_uUpperClipBound,d=window.debug_sliceView_dataToDevice,p=window.debug_sliceView_chunkLayout;console.log(`Drawing chunk: ${t.join()} of data size ${o.join()}, projection`,d);let m=p.globalToLocalNormal(J.create(),a.viewportNormalInGlobalCoordinates),y=J.dot(J.transformMat4(J.create(),a.centerDataPosition,p.invTransform),m);bq(o,l,c,y,m,t,d)}}function kq(n,e,t){return n>e?t>n?n:e>t?e:t:t>e?e:n>t?n:t}var qp=class extends Lc{constructor(e,t){let{shaderError:r=ya(),shaderParameters:i}=t;super(e.chunkManager,e,t);let{gl:a}=this;this.vertexIdHelper=this.registerDisposer(Cn.get(a)),this.shaderParameters=i;let{channelCoordinateSpace:o}=t;this.channelCoordinateSpace=o===void 0?qr(Qr):o,this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch));let l=this.registerDisposer(Qt((c,d)=>({numChannelDimensions:c.rank,dataHistogramChannelSpecifications:d}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=Ed(this,a,{memoizeKey:`volume/RenderLayer:${ct(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:i,encodeParameters:t.encodeShaderParameters,shaderError:r,extraParameters:l,defineShader:(c,d,p,m)=>{let{chunkFormat:y,dataHistogramsEnabled:v}=d,{dataHistogramChannelSpecifications:b,numChannelDimensions:x}=m;if(Sq(c,y===null),c.addOutputBuffer("vec4","v4f_fragData0",0),c.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),y===null)return;Tm(c,y,x,"vChunkPosition");let C=b.length;if(v&&C>0){let k="",{dataType:D}=y;for(let P=0;P<C;++P){let{channel:M}=b[P],I=`out_histogram${P}`;c.addOutputBuffer("vec4",I,1+P);let E=`getDataValue(${M.join(",")})`,_=`invlerpForHistogram${P}`;c.addFragmentCode(Gh(c,_,D,!1)),c.addFragmentCode(`
float getHistogramValue${P}() {
  return invlerpForHistogram${P}(${E});
}
`),k+=`{
float x = getHistogramValue${P}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${I} = vec4(x, x, x, 1.0);
}`}c.addFragmentCode(`void userMain();
void main() {
  ${k}
  userMain();
}
#define main userMain
`)}this.defineShader(c,p)},getContextKey:c=>{var d;return`${(d=c.chunkFormat)==null?void 0:d.shaderKey}/${c.dataHistogramsEnabled}`}}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let{tempChunkPosition:t}=this;for(let{source:r,chunkTransform:i}of this.visibleSourcesList){if(!ao(t,e,this.localPosition.value,i.layerRank,i.combinedGlobalLocalToChunkTransform))continue;let a=r.getValueAt(t,i);if(a!=null)return a}return null}beginChunkFormat(e,t,r){let{gl:i}=this,a=this.dataHistogramSpecifications.visibility.visible,o=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:a}),{shader:l,parameters:c,fallback:d}=o;if(l!==null&&(l.bind(),xq(l,r,t===null),t!==null)){if(a){let{dataHistogramChannelSpecifications:p}=o.extraParameters,m=p.length,y=this.dataHistogramSpecifications.bounds.value;for(let v=0;v<m;++v)Cc(l,`invlerpForHistogram${v}`,t.dataType,y[v])}this.initializeShader(e,l,c,d),t.beginDrawing(i,l)}return o}endSlice(e,t,r){}draw(e){let{sliceView:t}=e,r=t.visibleLayers.get(this),{visibleSources:i}=r;if(i.length===0)return;let{projectionParameters:a,wireFrame:o}=e,{gl:l}=this;this.vertexIdHelper.enable();let c=J.create(),{renderScaleHistogram:d}=this;d!==void 0&&d.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let p,m=null,y,v=J.create(),b=()=>{m!==null&&(y!==null&&y.endDrawing(l,m),this.endSlice(t,m,p.parameters))},x=!0;for(let C of i){let k=xc(a,C.chunkLayout),{chunkTransform:{channelToChunkDimensionIndices:D}}=C,P=C.source,{fixedPositionWithinChunk:M,chunkDisplayDimensionIndices:I}=C;for(let N of I)M[N]=0;let E=o?null:P.chunkFormat;if(E!==y&&(y=E,b(),p=this.beginChunkFormat(t,E,a),m=p.shader),m===null)continue;let _=P.chunks;v.fill(1);let O=k.size,B,W=P.spec.rank;Cq(l,m,t,a.viewProjectionMat,C,k),E!==null&&E.beginSource(l,m),x=!0;let V=0,U=0;if(t.forEachVisibleChunk(C,k,N=>{let q=_.get(N);if(q&&q.state===nt.GPU_MEMORY){let ne=q.chunkDataSize;if(ne!==B){B=ne;for(let me=0;me<3;++me){let Pe=I[me];v[me]=Pe===-1||Pe>=W?1:B[Pe]}wq(l,m,v)}let{chunkGridPosition:pe}=q;for(let me=0;me<3;++me){let Pe=I[me];c[me]=Pe===-1||Pe>=W?0:O[me]*pe[Pe]}E!==null&&E.bindChunk(l,m,q,M,I,D,x),x=!1,Tq(l,m,c,o),++V}else++U}),(V!==0||U!==0)&&d!==void 0){let{effectiveVoxelSize:N}=C,q=kq(N[0],N[1],N[2]);d.add(q,q/a.pixelSize,V,U)}}if(b(),this.vertexIdHelper.disable(),!e.wireFrame){let C=this.getDataHistogramCount();C>0&&t.computeHistograms(C,this.dataHistogramSpecifications)}}};var ys;(function(t){t[t.DEFAULT=0]="DEFAULT",t[t.ADDITIVE=1]="ADDITIVE"})(ys||(ys={}));var wV=new Map([[0,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA)}],[1,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE)}]]);function TV(n=0){return new cs(ys,n)}var kV=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function LV(n=kV){return Ko(n)}function ww(n,e){n.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
`),n.addFragmentCode(Oi),Ui(e,n),n.setFragmentMainFunction(Ni(e.parseResult.code))}var Tw=class extends qp{constructor(e,t){var o,l,c;let{opacity:r,blendMode:i,shaderControlState:a}=t;super(e,{...t,fallbackShaderParameters:new Re(Xo(uo(kV,{imageData:{dataType:e.dataType,channelRank:(c=(l=(o=t.channelCoordinateSpace)==null?void 0:o.value)==null?void 0:l.rank)!=null?c:0}}))),encodeShaderParameters:d=>d.key,shaderParameters:a.builderState,dataHistogramSpecifications:a.histogramSpecifications});this.shaderControlState=a,this.opacity=r,this.blendMode=i,this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(a.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),ww(e,t)}initializeShader(e,t,r){let{gl:i}=this;i.uniform1f(t.uniform("uOpacity"),this.opacity.value),ti(i,t,this.shaderControlState,r.parseResult.controls)}setGLBlendMode(e,t){let r=this.blendMode.value;r===ys.ADDITIVE||t>0?(e.enable(e.BLEND),wV.get(r)(e)):e.disable(WebGL2RenderingContext.BLEND)}};function Il(n=.5){return new ht(n,ah)}var EV=class extends Re{},PV=class extends El{constructor(){super((e,{showMatches:t,segmentationState:r})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(r.changed.add(this.changed.dispatch)),e.registerDisposer(Dn((i,a)=>{if(a==null)return;let{segmentationGroupState:o}=a;i.registerDisposer(o.changed.add(this.changed.dispatch)),i.registerDisposer(Dn((l,c)=>{let{visibleSegments:d}=c,p=d.size===0;l.registerDisposer(d.changed.add(()=>{let m=d.size===0;m!==p&&(p=m,this.changed.dispatch())}))},o))},r))})}get(e){let t=super.get(e);return t===void 0&&(t={segmentationState:new Re(void 0),showMatches:new xt(!1)},super.set(e,t)),t}},DV=`
void main() {
  setColor(defaultColor());
}
`,kw=class extends j{constructor(){super(...arguments);this.shader=Ko(DV);this.shaderControls=new po(this.shader);this.fallbackShaderControls=new Re(Xo(uo(DV)));this.shaderError=ya();this.color=new Go(J.fromValues(1,1,0));this.relationshipStates=this.registerDisposer(new PV);this.ignoreNullSegmentFilter=new xt(!0);this.displayUnfiltered=Pn((e,t)=>{for(let r of e.values())if(r.showMatches.value){if(!t)return!1;let i=r.segmentationState.value;if(i!=null&&i.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter);this.hoverState=new EV(void 0)}},lu=class extends j{constructor(e){super();let{transform:t,localPosition:r,source:i,role:a=or.ANNOTATION}=e;this.transform=t,this.localPosition=r,this.source=this.registerDisposer(i),this.role=a,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer(Pn(o=>jc(()=>Sc(dg(o))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex}get sourceIndex(){let{dataSource:e}=this;return e.layer.dataSources.indexOf(e)}};var Jp=12,Lw=8,Lq=6,AV=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function IV(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*Lq*e,t)}var MV=0,qg=MV+1,Qn=qg+Lw,Ew=Qn+Jp,Eq=Ew+6,Pq=Float32Array.from([0,0,0,0,0,1,Qn+0,1,0,0,1,0,1,Qn+1,0,1,0,0,1,1,Qn+2,1,1,0,1,1,1,Qn+3,0,0,0,0,1,0,Qn+4,0,0,1,0,1,1,Qn+5,1,0,0,1,1,0,Qn+6,1,0,1,1,1,1,Qn+7,0,0,0,1,0,0,Qn+8,0,0,1,1,0,1,Qn+9,0,1,0,1,1,0,Qn+10,0,1,1,1,1,1,Qn+11]),RV=re.create(),vs=new Float32Array(6),Pw=class extends Fi{constructor(){super(...arguments);this.vertexIdHelper=this.registerDisposer(Cn.get(this.gl))}defineShader(e){Yn(e);let{rank:t}=this;xa(e,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",t,2),e.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(e,t,r){re.invert(RV,t.modelViewProjectionMatrix),cE(RV,vs);let{numChunkDisplayDims:i}=t.chunkDisplayTransform;for(let a=0;a<i;++a)vs[a]=0,vs[a+3]=0;for(let a=i;a<3;++a){let o=Math.abs(vs[a+3]-vs[a]);vs[a]-=o,vs[a+3]+=o}super.enable(e,t,a=>{let o=a.vertexShaderInputBinders.Bounds;o.enable(1);let{gl:l}=this;l.uniform3fv(a.uniform("uModelSpaceBoundOffsets"),vs),l.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),o.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:c}=this;c.enable(),r(a),c.disable(),o.disable()})}};function _V(n){n.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function VV(n){n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function Dw(n){VV(n),n.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}function Dq(n){_V(n),n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`)}var OV=class extends Pw{constructor(){super(...arguments);this.edgeBoxCornerOffsetsBuffer=this.registerDisposer(Nt.fromData(this.gl,ed(Pq,7,1,Si)));this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{let{rank:t}=this;this.defineShader(e),_n(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),Dw(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)});this.boxCornerOffsetsBuffer=this.registerDisposer(Nt.fromData(this.gl,ed(jg,3,1,Uc)));this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{let{rank:t}=this;this.defineShader(e),_a(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),Dw(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${qg}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}drawEdges(e){let{gl:t}=this;this.enable(this.edgeShaderGetter,e,r=>{let i=r.attribute("aBoxCornerOffset1"),a=r.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1,4*7,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(a,4,WebGL2RenderingContext.FLOAT,!1,4*7,4*3),On(r,e.renderContext.projectionParameters,1),Vn(t,Jp,e.count),t.disableVertexAttribArray(i),t.disableVertexAttribArray(a)})}drawCorners(e){let{gl:t}=this;this.enable(this.cornerShaderGetter,e,r=>{let i=r.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1),Va(r,e.renderContext.projectionParameters,{featherWidthInPixels:0}),Oa(r.gl,Lw,e.count),t.disableVertexAttribArray(i)})}draw(e){this.drawEdges(e),this.drawCorners(e)}},NV=class extends Pw{constructor(){super(...arguments);this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",e=>{let{rank:t}=this;super.defineShader(e),Al(e),_n(e),e.addVarying("highp float","vClipCoefficient"),Dw(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / ${Si};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)});this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",e=>{let{rank:t}=this;super.defineShader(e),Al(e),e.addVarying("highp float","vClipCoefficient"),Dq(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)})}enableForBoundingBox(e,t,r){super.enable(e,t,i=>{let a=t.renderContext.sliceView.projectionParameters.value;su(i,a.viewportNormalInGlobalCoordinates,a.centerDataPosition,t.renderSubspaceModelMatrix,t.renderSubspaceInvModelMatrix),r(i)})}draw(e){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,e,()=>{VP(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,e.count)}),this.enableForBoundingBox(this.faceShaderGetter,e,t=>{On(t,e.renderContext.projectionParameters,1),Vn(t.gl,6,e.count)})}};function Aq(n,e){let t=n.length;for(let r=0;r<t;++r){let i=e[r],a=e[r+t],o=n[r];n[r]=Math.abs(i-o)<Math.abs(a-o)?i:a}}Ca(be.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:NV,perspectiveViewRenderHelper:OV,defineShaderNoOpSetters(n){VV(n),_V(n)},pickIdsPerInstance:Eq,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r>=qg&&r<Qn?Aq(n,a):r>=Qn&&r<Ew},getRepresentativePoint(n,e,t){t===MV||t>=qg&&t<Qn||t>=Qn&&t<Ew,n.set(e.pointA)},updateViaRepresentativePoint(n,e,t){let r=e.length,{pointA:i,pointB:a}=n,o=new Float32Array(r),l=new Float32Array(r);for(let c=0;c<r;++c){let d=o[c]=e[c];l[c]=a[c]+(d-i[c])}return{...n,pointA:o,pointB:l}}});var cu=0,Aw=cu+1,Iq=Aw+2;function BV(n){n.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function UV(n){n.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}var Iw=class extends Fi{constructor(){super(...arguments);this.vertexIdHelper=this.registerDisposer(Cn.get(this.gl));this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",e=>{let{rank:t}=this;this.defineShader(e),_n(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),BV(e),e.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)});this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",e=>{let{rank:t}=this;this.defineShader(e),_a(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),UV(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${Uc};
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}defineShader(e){Yn(e);let{rank:t}=this;xa(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:o}=this;o.enable(),r(i),o.disable(),a.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{On(t,e.renderContext.projectionParameters,1),Vn(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{Va(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),Oa(t.gl,2,e.count)})}draw(e){this.drawEdges(e),this.drawEndpoints(e)}};function Mq(n,e){let t=n.length;Yf(n,e.subarray(0,t),e.subarray(t),n)}function Rq(n,e,t){let r=n.length,i=r*t;for(let a=0;a<r;++a)n[a]=e[i+a]}Ca(be.LINE,{sliceViewRenderHelper:Iw,perspectiveViewRenderHelper:Iw,defineShaderNoOpSetters(n){BV(n),UV(n)},pickIdsPerInstance:Iq,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r===cu?Mq(n,a):Rq(n,a,r-Aw)},getRepresentativePoint(n,e,t){n.set(t===cu||t===Aw?e.pointA:e.pointB)},updateViaRepresentativePoint(n,e,t){let r={...n},i=e.length;switch(t){case cu:{let{pointA:a,pointB:o}=n,l=new Float32Array(i),c=new Float32Array(i);for(let d=0;d<i;++d){let p=l[d]=e[d];c[d]=o[d]+(p-a[d])}return{...n,pointA:l,pointB:c}}case cu+1:return{...n,pointA:new Float32Array(e)};case cu+2:return{...n,pointB:new Float32Array(e)}}return r}});var Mw=class extends Fi{constructor(){super(...arguments);this.shaderGetter3d=this.getDependentShader("annotation/point:3d",e=>{Yn(e),_a(e,this.targetIsSliceView),this.defineShaderCommon(e),e.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)});this.makeShaderGetter2d=e=>this.getDependentShader(`annotation/point:2d:${e}`,t=>{Yn(t),_n(t,!0),this.defineShaderCommon(t),t.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${e}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${e}] = minZ;
subspacePositionB[${e}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),t.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)});this.shaderGetter2d=this.makeShaderGetter2d(2);this.shaderGetter1d=this.makeShaderGetter2d(1);this.vertexIdHelper=this.registerDisposer(Cn.get(this.gl))}defineShaderCommon(e){let{rank:t}=this;xa(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t),e.addVarying("highp vec4","vBorderColor"),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),e.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${t}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(e)};
`)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:o}=this;o.enable(),r(i),o.disable(),a.disable()})}draw(e){let{numChunkDisplayDims:t}=e.chunkDisplayTransform;switch(t){case 3:this.enable(this.shaderGetter3d,e,r=>{Va(r,e.renderContext.projectionParameters,{featherWidthInPixels:1}),Oa(r.gl,1,e.count)});break;case 2:case 1:this.enable(t===2?this.shaderGetter2d:this.shaderGetter1d,e,r=>{On(r,e.renderContext.projectionParameters,1),Vn(r.gl,1,e.count)});break}}};Ca(be.POINT,{sliceViewRenderHelper:Mw,perspectiveViewRenderHelper:Mw,defineShaderNoOpSetters(n){n.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(n,e,t){n.set(new Float32Array(e,t,n.length))},getRepresentativePoint(n,e){n.set(e.point)},updateViaRepresentativePoint(n,e){return{...n,point:new Float32Array(e)}}});var FV=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,GV=[FV,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`];function WV(n,e){let t=[[n[0],n[1],n[2]],[n[3],n[4],n[5]],[n[6],n[7],n[8]]];return{A:t[0][0],B:t[0][1]+t[1][0],C:t[1][1],D:-2*e[0]*t[0][0]-e[1]*(t[0][1]+t[1][0])+e[2]*(t[0][2]+t[2][0]),E:-e[0]*(t[0][1]+t[1][0])-2*e[1]*t[1][1]+e[2]*(t[1][2]+t[2][1]),F:e[0]*e[0]*t[0][0]+e[0]*e[1]*(t[0][1]+t[1][0])-e[0]*e[2]*(t[0][2]+t[2][0])+e[1]*e[1]*t[1][1]-e[1]*e[2]*(t[1][2]+t[2][1])+e[2]*e[2]*t[2][2]-1}}var _q=`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,zV=[FV,_q,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`];function HV(n){let e=n.A,t=n.B/2,r=n.C,i=n.D,a=n.E,o=n.F,l=2*(t*t-e*r),c=(r*i-t*a)/l,d=(e*a-t*i)/l,p=1/(e*c*c+2*t*c*d+r*d*d-o),m=p*e,y=p*t,v=p*r,b=m+v,x=Math.sqrt((m-v)*(m-v)+4*y*y),C=(b+x)/2,k=(b-x)/2,D=1/Math.sqrt(C),P=1/Math.sqrt(k),M;m>=v?M=vr.fromValues(C-v,y):M=vr.fromValues(y,C-m),vr.normalize(M,M);let I=vr.fromValues(-M[1],M[0]);return{k:vr.fromValues(c,d),u1:M,u2:I,a:D,b:P,lambda1:C,lambda2:k,m11:m,m12:y,m22:v,valid:C>0&&k>0}}var $V=re.create(),Vq=!1,Rw=class extends Fi{defineShader(e){let{rank:t}=this;xa(e,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",t,2),e.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${t}] = getCenterAndRadii0();
  highp float modelRadii[${t}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${t}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${t}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.CenterAndRadii;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.geometryDataStride,t.bufferOffset),r(i),a.disable()})}},jV=class extends Rw{constructor(){super(...arguments);this.sphereRenderHelper=this.registerDisposer(new np(this.gl,10,10));this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)});this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:r}=t,i=this.tempLightVec,{lightDirection:a,ambientLighting:o,directionalLighting:l}=e.renderContext;J.scale(i,a,l),i[3]=o,r.uniform4fv(t.uniform("uLightDirection"),i),r.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,re.transpose(re.create(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}},qV=class extends Rw{constructor(){super(...arguments);this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{Yn(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(GV),e.addVertexCode(zV),e.addVertexCode(Nc),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)});this.vertexIdHelper=this.registerDisposer(Cn.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:r}=t,i=e.renderContext.sliceView.projectionParameters.value,a=re.multiply($V,e.renderSubspaceInvModelMatrix,i.invViewMatrix);r.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,a),r.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,i.projectionMat);let o=$V;re.invert(o,a),r.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,o);let{vertexIdHelper:l}=this;if(l.enable(),Bc(r,1,e.count),l.disable(),Vq){let c=J.fromValues(3406.98779296875,3234.910400390625,4045),d=J.fromValues(10,10,10),p=Et.create();p[0]=1/(d[0]*d[0]),p[4]=1/(d[1]*d[1]),p[8]=1/(d[2]*d[2]);let m=Et.fromMat4(Et.create(),a),y=Et.multiply(Et.create(),Et.transpose(Et.create(),m),p);Et.multiply(y,y,m);let v=J.transformMat4(J.create(),c,o);console.log("Aviewport",y),console.log("cViewport",v);let b=WV(y,v),x=HV(b);console.log(b),console.log(x)}})}};Ca(be.ELLIPSOID,{sliceViewRenderHelper:qV,perspectiveViewRenderHelper:jV,defineShaderNoOpSetters(n){n.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(n,e){n.set(e.center)},updateViaRepresentativePoint(n,e){return{...n,center:new Float32Array(e)}}});var uu=0,_w=uu+1,Oq=_w+2;function Vw(n){n.addVertexCode(`
 void setAxisEndpointMarkerSize(float startSize, float endSize) {}
 void setAxisEndpointMarkerBorderWidth(float startSize, float endSize) {}
 void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
 void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
 `)}function Ow(n){n.addVertexCode(`
 void setAxisWidth(float width) {}
 void setAxisColor(vec4 startColor, vec4 endColor) {}
 `)}function Nw(n){n.addVertexCode(`
 void setSphereColor(vec4 color) {}
 `)}var Bw=class extends Fi{constructor(){super(...arguments);this.sphereShader=this.registerDisposer(new Eb(this.gl));this.vertexIdHelper=this.registerDisposer(Cn.get(this.gl));this.edgeShaderGetter=this.getDependentShader("annotation/sphere/axis",e=>{let{rank:t}=this;this.defineShader(e),_n(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),Vw(e),Nw(e),e.addVertexCode(`
void setAxisWidth(float width) {
  ng_LineWidth = width;
}
void setAxisColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)});this.endpointShaderGetter=this.getDependentShader("annotation/sphere/endpoint",e=>{let{rank:t}=this;this.defineShader(e),_a(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),Ow(e),Nw(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${Uc};
}
void setAxisEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setAxisEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)});this.sphereShadeGetter=this.getDependentShader("annotation/sphere/sphere",e=>{let{rank:t}=this;this.defineShader(e),this.sphereShader.defineShader(e),e.addVarying("highp float","vClipCoefficient"),Ow(e),Vw(e),e.addVertexCode(`
 void setSphereColor(vec4 color) {
   vColor = color;
 }
 `),e.setVertexMain(`
 float modelPosition[${t}] = getVertexPosition0();
 float modelPositionB[${t}] = getVertexPosition1();
 float diameter = 0.0;
 for (int i = 0; i < ${t}; ++i) {
   float dx = modelPosition[i] - modelPositionB[i];
   diameter += dx * dx;
   modelPosition[i] = (modelPosition[i] + modelPositionB[i]) * 0.5;
 }
 float radius = sqrt(diameter) * 0.5;
 if (radius > 0.0) {
   vClipCoefficient = getRadiusAdjustment(vec3(modelPosition[0], modelPosition[1], modelPosition[2]), radius);
 } else {
   vClipCoefficient = 1.0;
 }

 // vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
 vColor = vec4(1.0, 0.0, 0.0, 0.5);
 // vColor = vec4(defaultColor(), 0.5);
 ${this.invokeUserMain}
 // float radius = diameter * 0.5;
 emitSphere(uModelViewProjection, uNormalTransform, projectModelVectorToSubspace(modelPosition), vec3(radius, radius, radius), uLightDirection);
 ${this.setPartIndex(e)};
 `),e.setFragmentMain(`
     vec4 color = vColor;
     color.a *= vClipCoefficient;
     emitAnnotation(color);
 `)})}defineShader(e){Yn(e);let{rank:t}=this;xa(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,r,i=!0){super.enable(e,t,a=>{let o=a.vertexShaderInputBinders.VertexPosition;o.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),o.bind(this.serializedBytesPerAnnotation,t.bufferOffset);let{vertexIdHelper:l}=this;i&&l.enable(),r(a),i&&l.disable(),o.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{On(t,e.renderContext.projectionParameters,1),Vn(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{Va(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),Oa(t.gl,2,e.count)})}drawSphere(e){this.enable(this.sphereShadeGetter,e,t=>{this.sphereShader.draw(t,e,e.count)},!1)}draw(e){this.drawEdges(e),this.drawEndpoints(e),this.drawSphere(e)}};function Nq(n,e){let t=n.length;Yf(n,e.subarray(0,t),e.subarray(t),n)}function Bq(n,e,t){let r=n.length,i=r*t;for(let a=0;a<r;++a)n[a]=e[i+a]}Ca(be.SPHERE,{sliceViewRenderHelper:Bw,perspectiveViewRenderHelper:Bw,defineShaderNoOpSetters(n){Vw(n),Ow(n),Nw(n)},pickIdsPerInstance:Oq,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r===uu?Nq(n,a):Bq(n,a,r-_w)},getRepresentativePoint(n,e,t){n.set(t===uu||t===_w?e.pointA:e.pointB)},updateViaRepresentativePoint(n,e,t){let r={...n},i=e.length;switch(t){case uu:{let{pointA:a,pointB:o}=n,l=new Float32Array(i),c=new Float32Array(i);for(let d=0;d<i;++d){let p=l[d]=e[d];c[d]=o[d]+(p-a[d])}return{...n,pointA:l,pointB:c}}case uu+1:return{...n,pointA:new Float32Array(e)};case uu+2:return{...n,pointB:new Float32Array(e)}}return r}});var JV=re.create(),KV=J.create();function YV(n){n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}var XV={defineShader(n){YV(n),_n(n),n.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),n.setVertexMain(`
int edgeIndex = gl_VertexID / ${Si};
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){On(n,e,1)},draw(n,e,t){let{gl:r}=n,i=JV,{chunkLayout:a}=e;re.multiply(i,t.viewProjectionMat,a.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),a.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,d=KV;for(let p=0;p<3;++p){let m=c[p];d[p]=(m===-1?0:l[m])*o[p]}r.uniform3fv(n.uniform("uTranslation"),d),Vn(r,Jp,1)}},QV={defineShader(n){Al(n),YV(n),_n(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${Si};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){On(n,e,1)},draw(n,e,t){let{gl:r}=n,i=JV,{chunkLayout:a}=e;re.multiply(i,t.viewProjectionMat,a.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),a.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,d=KV;for(let p=0;p<3;++p){let m=c[p];d[p]=(m===-1?0:l[m])*o[p]}r.uniform3fv(n.uniform("uTranslation"),d),su(n,t.viewportNormalInGlobalCoordinates,t.centerDataPosition,a.transform,a.invTransform),Vn(r,6,1)}};var Uq=re.create();function Fq(n){if(n!==void 0)return e=>{let{relatedSegments:t}=e;if(t===void 0)return!1;for(let r=0,i=t.length;r<i;++r){let a=n[r];if(a==null)continue;let{visibleSegments:o,segmentEquivalences:l}=a.segmentationGroupState.value;for(let c of t[r])if(o.has(l.get(c)))return!0}return!1}}function Gq(n,e){let t=new Kv(n.annotationPropertySerializers);for(let r of n)(e===void 0||e(r))&&t.add(r);return t.serialize()}var Jg=class extends va(La){constructor(e,t,r,i){super(i);this.chunkManager=e;this.source=t;this.segmentationStates=r;this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:t.rpcId,segmentationStates:this.serializeDisplayState()});let a=()=>{let o={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke(PP,o)};this.registerDisposer(r.changed.add(a))}serializeDisplayState(){let{value:e}=this.segmentationStates;if(e!==void 0)return e.map(t=>t==null?t:kb(t.segmentationGroupState.value))}};Jg=Lt([yn(EP)],Jg);var Uw=class extends j{constructor(e,t){super();this.chunkManager=e;this.state=t;this.layerChunkProgressInfo=new fo;this.numPickIds=0;this.generation=-1;this.redrawNeeded=new ae;this.serializedAnnotations=void 0;this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()};this.segmentationStates=this.registerDisposer(Qt(e=>{let{displayState:t,source:r}=this.state,{relationshipStates:i}=t;return t.displayUnfiltered.value?void 0:r.relationships.map(a=>{let o=i.get(a);return o.showMatches.value?o.segmentationState.value:void 0})},[this.state.displayState.relationshipStates],(e,t)=>e===void 0||t===void 0?e===t:we(e,t)));this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer(Dn((i,a)=>{if(this.handleChangeAffectingBuffer(),a!==void 0)for(let o of a)o!=null&&i.registerDisposer(Qa((l,c)=>{l.registerDisposer(c.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),l.registerDisposer(c.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},o.segmentationGroupState))},this.segmentationStates)),this.source instanceof ro||(this.sharedObject=this.registerDisposer(new Jg(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));let{displayState:r}=this.state;this.registerDisposer(r.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){let{sharedObject:e}=this;if(e!==void 0)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){let{source:e}=this;if(e instanceof ro){let t=e.changed.count;if(this.generation!==t){let{buffer:r}=this;r===void 0&&(r=this.buffer=this.registerDisposer(new Nt(this.chunkManager.gl))),this.generation=t;let i=this.serializedAnnotations=Gq(e,Fq(this.segmentationStates.value));r.setData(this.serializedAnnotations.data),this.numPickIds=JS(i)}}}};function ZV(n){let{chunkTransform:e}=n,{unpaddedRank:t}=e.modelTransform,r=new Float32Array(t*2),i=new Float32Array(t*3);i.fill(0),r.fill(1,t);let{numChunkDisplayDims:a,chunkDisplayDimensionIndices:o}=n;for(let l=0;l<a;++l){let c=o[l];r[t+c]=0,i[c*3+l]=1}return{modelClipBounds:r,renderSubspaceTransform:i}}function e2(n,e,t){t.clearMessages();let r=c=>{t.addMessage({severity:Cr.error,message:c})};if(n.error!==void 0)return r(n.error);let i=Ih(n.modelTransform,e.displayDimensionIndices),a;try{a=Mh(n,i)}catch(c){return r(c.message)}let{modelClipBounds:o,renderSubspaceTransform:l}=ZV(a);return{chunkTransform:n,chunkDisplayTransform:a,modelClipBounds:o,renderSubspaceTransform:l}}function Fw(n,e){class t extends n{constructor(i,a){super();this.base=i;this.renderScaleHistogram=a;this.curRank=-1;this.renderHelpers=[];this.isAnnotation=!0;let o=i.visibility;o!==void 0&&this.registerDisposer(o.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(let l of this.renderHelpers)l.dispose()}),this.role=i.state.role,this.registerDisposer(i.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged()}handleRankChanged(){let{rank:i}=this.base.source;if(i===this.curRank)return;this.curRank=i,this.tempChunkPosition=new Float32Array(i);let{renderHelpers:a,gl:o}=this;for(let d of a)d.dispose();let{properties:l}=this.base.source,{displayState:c}=this.base.state;for(let d of Ri){let p=Qo(d),m=p[e],y=a[d]=new m(o,d,i,l,c.shaderControls,c.fallbackShaderControls,c.shaderError);y.pickIdsPerInstance=p.pickIdsPerInstance,y.targetIsSliceView=e==="sliceViewRenderHelper"}}attach(i){super.attach(i),this.handleRankChanged();let{chunkTransform:a}=this,o=i.view.displayDimensionRenderInfo.value;i.state={chunkTransform:a,displayDimensionRenderInfo:o,chunkRenderParameters:e2(a,o,i.messages)}}updateAttachmentState(i){let a=i.state;this.handleRankChanged();let{chunkTransform:o}=this,l=i.view.displayDimensionRenderInfo.value;return a!==void 0&&a.chunkTransform===o&&a.displayDimensionRenderInfo===l?a.chunkRenderParameters:(a.chunkTransform=o,a.displayDimensionRenderInfo=l,a.chunkRenderParameters=e2(o,l,i.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(i,a){let{modelClipBounds:o}=a,l=this.curRank,{chunkTransform:c}=a;ao(o.subarray(0,l),i.projectionParameters.globalPosition,this.base.state.localPosition.value,c.layerRank,c.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(i,a,o,l=1){if(!i.bufferValid){let{buffer:c}=i;c===void 0&&(c=i.buffer=new Nt(this.gl));let{serializedAnnotations:d}=i;c.setData(d.data),i.numPickIds=JS(d),i.bufferValid=!0}this.drawGeometry(i,a,o,l)}drawGeometry(i,a,o,l=1){let{base:c}=this,{chunkDisplayTransform:d}=o,{serializedAnnotations:p}=i,{typeToIdMaps:m,typeToOffset:y}=p,v=0;a.emitPickID&&(v=a.pickIDs.register(this,i.numPickIds,0,0,i));let b=c.hoverState.value,x=re.multiply(Uq,a.projectionParameters.viewProjectionMat,d.displaySubspaceModelMatrix),C={annotationLayer:c,renderContext:a,selectedIndex:0,basePickId:v,buffer:i.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:x,modelClipBounds:o.modelClipBounds,subspaceMatrix:o.renderSubspaceTransform,renderSubspaceModelMatrix:d.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:d.displaySubspaceInvModelMatrix,chunkDisplayTransform:d};for(let k of Ri){let D=m[k],P=D.size;if(P>0){let M=Qo(k),I=4294967295;if(b!==void 0){let E=D.get(b.id);E!==void 0&&(I=E*M.pickIdsPerInstance)}P=Math.round(P*l),C.count=P,C.bufferOffset=y[k],C.selectedIndex=I,this.renderHelpers[k].draw(C),C.basePickId+=P*M.pickIdsPerInstance}}}updateMouseState(i,a,o,l){let c=l,{serializedAnnotations:d}=c,{typeToIds:p,typeToOffset:m}=d,y=this.curRank,v=this.chunkTransform;if(v.error===void 0)for(let b of Ri){let x=p[b],C=Qo(b),{pickIdsPerInstance:k}=C;if(o<x.length*k){let D=Math.floor(o/k),P=x[D],M=o%k;i.pickedAnnotationId=P,i.pickedAnnotationLayer=this.base.state,i.pickedOffset=M,i.pickedAnnotationBuffer=d.data.buffer,i.pickedAnnotationType=b,i.pickedAnnotationBufferBaseOffset=d.data.byteOffset+m[b],i.pickedAnnotationIndex=D,i.pickedAnnotationCount=x.length;let I=this.tempChunkPosition,{chunkToLayerTransform:E,combinedGlobalLocalToChunkTransform:_,layerRank:O}=v,{globalToRenderLayerDimensions:B}=v.modelTransform,{position:W}=i;if(!ao(I,W,this.base.state.localPosition.value,O,_))return;let V=this.base.source.annotationPropertySerializers[b];C.snapPosition(I,i.pickedAnnotationBuffer,i.pickedAnnotationBufferBaseOffset+i.pickedAnnotationIndex*V.propertyGroupBytes[0],M);let U=B.length;for(let N=0;N<U;++N){let q=B[N];if(q===-1)continue;let ne=E[(y+1)*y+q];for(let pe=0;pe<y;++pe)ne+=I[pe]*E[pe*(O+1)+q];!Number.isFinite(ne)||(W[N]=ne)}return}o-=x.length*k}}transformPickedValue(i){let{pickedAnnotationBuffer:a}=i;if(a===void 0)return;let{properties:o}=this.base.source;if(o.length===0)return;let{pickedAnnotationBufferBaseOffset:l,pickedAnnotationType:c,pickedAnnotationIndex:d,pickedAnnotationCount:p}=i,{annotationPropertySerializers:m}=this.base.source,y=new Array(o.length);return m[c].deserialize(new DataView(a),l,d,p,mn.LITTLE===ma,y),DE(o[0],y[0])}isReady(){let{base:i}=this,{source:a}=i;if(!(a instanceof vn))return!0;let{value:o}=this.base.segmentationStates;if(o===void 0)return!0;for(let l=0,c=o.length;l<c;++l){let d=o[l];if(d===null)return!1;if(d===void 0)continue;let p=a.segmentFilteredSources[l].chunks,m=!1;if(Ea(d.segmentationGroupState.value,y=>{let v=Nr(y);p.has(v)||(m=!0)}),m)return!1}return!0}}return t}var t2=n=>class extends n{constructor(){super(...arguments);this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(t,r){let i=this.updateAttachmentState(r);if(this.curRank===0||i===void 0)return;this.updateModelClipBounds(t,i);let{source:a}=this.base;if(a instanceof ro){let{base:o}=this;o.updateBuffer(),this.drawGeometry(o,t,i)}else{let{renderScaleHistogram:o}=this;o.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(a.temporary.data,t,i);let{value:l}=this.base.segmentationStates,c=0,d=0;if(l!==void 0)for(let p=0,m=l.length;p<m;++p){let y=l[p];if(y==null)continue;let v=a.segmentFilteredSources[p].chunks;Ea(y.segmentationGroupState.value,b=>{let x=Nr(b),C=v.get(x);if(C!==void 0&&C.state===nt.GPU_MEMORY){let{data:k}=C;if(k===void 0)return;this.drawGeometryChunkData(k,t,i),++c}else++d})}o.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,c,d)}}},n2=Fw(Ur,"perspectiveViewRenderHelper"),Gw=class extends t2(n2){},r2=n=>{class e extends n{constructor(r){super(r.annotationLayer,r.renderScaleHistogram);this.wireFrameRenderHelper=this instanceof pi?QV:XV;this.wireFrameShaderGetter=ei(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof pi}`,parameters:qr(void 0),defineShader:r=>{this.wireFrameRenderHelper.defineShader(r)}});this.renderScaleTarget=r.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));let i=this.registerDisposer(new La(this.layerChunkProgressInfo)),a=this.base.chunkManager.rpc;i.RPC_TYPE_ID=kP,i.initializeCounterpart(a,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(gt.makeFromExisting(a,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(gt.makeFromExisting(a,this.renderScaleTarget)).rpcId}),this.backend=i}attach(r){super.attach(r),r.state.sources=r.registerDisposer(Dn((i,a,o)=>{let l=al(o,a,c=>this.base.state.source.getSources(c),r.messages,this);for(let c of l)for(let d of c)i.registerDisposer(d.source),Object.assign(d,ZV(d.chunkDisplayTransform));return r.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(LP,{layer:this.backend.rpcId,view:r.view.rpcId,displayDimensionRenderInfo:o,sources:nl(l)}),this.redrawNeeded.dispatch(),l},this.base.state.transform,r.view.displayDimensionRenderInfo))}draw(r,i){let a=this.updateAttachmentState(i);if(this.curRank===0||a===void 0)return;let o=i.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(r,a);let{renderScaleHistogram:l}=this;l.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let{projectionParameters:c}=r,d;if(r.wireFrame){let{shader:p}=this.wireFrameShaderGetter(r.emitter);if(p===null)return;p.bind(),this.wireFrameRenderHelper.initialize(p,c),d=p}DP(c,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(p,m,y,v,b)=>{let x=p.source.chunks.get(p.curPositionInChunks.join()),C;if(x===void 0||x.state!==nt.GPU_MEMORY)C=0;else{let{data:k}=x;if(k===void 0)return;d!==void 0?this.wireFrameRenderHelper.draw(d,p,c):this.drawGeometryChunkData(k,r,a,y),C=1}l.add(v,b,C,1-C)})}}return e},i2=r2(n2),a2=r2(Fw(pi,"sliceViewRenderHelper")),o2=t2(Fw(pi,"sliceViewRenderHelper"));var s2=class extends j{constructor(){super(...arguments);this.changed=new ae;this.isLoadingChanged=new ae;this.states=[];this.relationships=[];this.loadingCount=0}get value(){return this.states}get isLoading(){return this.loadingCount!==0}markLoading(){return this.loadingCount++,()=>{--this.loadingCount==0&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{let r=e.sourceIndex-t.sourceIndex;return r!==0?r:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){let e=new Set;for(let t of this.states)for(let r of t.source.relationships)e.add(r);this.relationships=Array.from(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{let t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}};function Wq(n,e){switch(e.type){case be.AXIS_ALIGNED_BOUNDING_BOX:case be.LINE:case be.SPHERE:vh(n,e.pointA,e.pointB),RE(n,n,.5);break;case be.POINT:n.set(e.point);break;case be.ELLIPSOID:n.set(e.center);break}}function l2(n,e,t){e.error===void 0&&n.setLayerPosition(e.modelTransform,t)}function c2(n,e,t){let{layerRank:r}=e,i=new Float32Array(r);An[n.type].visitGeometry(n,(a,o)=>{i.set(a);let l=new Float32Array(r);(o?Ch:Xr)(l,e.chunkToLayerTransform,r+1,i,r),t(l,o)})}var u2=class extends sn{constructor(e,t){super();this.layer=e;this.displayState=t;this.previousSelectedState=void 0;this.previousHoverId=void 0;this.previousHoverAnnotationLayerState=void 0;this.virtualListSource={length:0,render:e=>this.render(e),changed:new Me};this.virtualList=new wl({source:this.virtualListSource});this.listElements=[];this.updated=!1;this.mutableControls=document.createElement("div");this.headerRow=document.createElement("div");this.attachedAnnotationStates=new Map;this.forceUpdateView=()=>{this.updated=!1,this.updateView()};this.globalDimensionIndices=[];this.localDimensionIndices=[];this.curCoordinateSpaceGeneration=-1;this.prevCoordinateSpaceGeneration=-1;this.columnWidths=[];this.gridTemplate="";this.selectedAnnotationState=Pn((e,t)=>{var l;if(e===void 0)return;let{layer:r}=this,i=(l=e.layers.find(c=>c.layer===r))==null?void 0:l.state;if(i===void 0)return;let{annotationId:a}=i;if(a===void 0)return;let o=this.annotationStates.states.find(c=>c.sourceIndex===i.annotationSourceIndex&&(i.annotationSubsource===void 0||c.subsourceId===i.annotationSubsource));if(o!==void 0)return{annotationId:a,annotationLayerState:o,pin:t}},this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin);this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(e.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");let r=document.createElement("div");r.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);let i=this.registerDisposer(new Dl(this.displayState.color));i.element.title="Change annotation display color",this.registerDisposer(new ar(Pn(v=>v.match(/\bdefaultColor\b/)!==null,t.shaderControls.processedFragmentMain),i.element)),r.appendChild(i.element);let{mutableControls:a}=this,o=$e({text:An[be.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new zw(this.layer,{})}});a.appendChild(o);let l=$e({text:An[be.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new Yg(this.layer,{})}});a.appendChild(l);let c=$e({text:An[be.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new Xg(this.layer,{})}});a.appendChild(c);let d=$e({text:An[be.SPHERE].icon,title:"Annotate Sphere",onClick:()=>{this.layer.tool.value=new Qg(this.layer,{})}});a.appendChild(d);let p=$e({text:An[be.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new $w(this.layer,{})}});a.appendChild(p),r.appendChild(a),this.element.appendChild(r),this.element.appendChild(this.headerRow);let{virtualList:m}=this;m.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(m.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});let y=v1();this.registerDisposer(new xn(this.virtualList.element,y)),this.virtualList.element.title=y.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){let e=this.annotationStates.states,{attachedAnnotationStates:t}=this,r=new Map;for(let[i,a]of t)e.includes(i)||(t.delete(i),a.refCounted.dispose());for(let i of e){let a=t.get(i);if(a!==void 0){r.set(i,a);continue}let o=i.source,l=new j;(o instanceof ro||o instanceof vn)&&(l.registerDisposer(o.childAdded.add(c=>this.addAnnotationElement(c,i))),l.registerDisposer(o.childUpdated.add(c=>this.updateAnnotationElement(c,i))),l.registerDisposer(o.childDeleted.add(c=>this.deleteAnnotationElement(c,i))),l.registerDisposer(o.childRefreshed.add(()=>this.clearAnnotationElement(i)))),l.registerDisposer(i.transform.changed.add(this.forceUpdateView)),r.set(i,{refCounted:l,annotations:[],idToIndex:new Map,listOffset:0})}this.attachedAnnotationStates=r,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){let e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,r=[],i=[];for(let a=0,o=t.rank;a<o;++a)this.annotationStates.states.some(l=>{let c=l.transform.value;return c.error!==void 0?!1:c.globalToRenderLayerDimensions[a]!==-1})&&r.push(a);for(let a=0,o=e.rank;a<o;++a)this.annotationStates.states.some(l=>{let c=l.transform.value;return c.error!==void 0?!1:c.localToRenderLayerDimensions[a]!==-1})&&i.push(a);(!we(r,this.globalDimensionIndices)||!we(i,this.localDimensionIndices))&&(this.localDimensionIndices=i,this.globalDimensionIndices=r,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t,r=!1){let i=this.attachedAnnotationStates.get(e);if(i==null)return;let a=i.idToIndex.get(t);if(a===void 0)return;let o=i.listOffset+a;return r&&this.virtualList.scrollItemIntoView(a),this.virtualList.getItemElement(o)}clearSelectionClass(){let{previousSelectedState:e}=this;if(e===void 0)return;this.previousSelectedState=void 0;let t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);t!==void 0&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){let{previousHoverId:e,previousHoverAnnotationLayerState:t}=this;if(t!==void 0){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;let r=this.getRenderedAnnotationListElement(t,e);r!==void 0&&r.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){let e=this.selectedAnnotationState.value,{previousSelectedState:t}=this;if(t===e||t!==void 0&&e!==void 0&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,e===void 0))return;let r=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);r!==void 0&&r.classList.add("neuroglancer-annotation-selected")}updateHoverView(){let e=this.displayState.hoverState.value,t,r;e!==void 0&&(t=e.id,r=e.annotationLayerState);let{previousHoverId:i,previousHoverAnnotationLayerState:a}=this;if(t===i&&r===a||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=r,t===void 0))return;let o=this.getRenderedAnnotationListElement(r,t);o!==void 0&&o.classList.add("neuroglancer-annotation-hover")}render(e){let{annotation:t,state:r}=this.listElements[e];return this.makeAnnotationListElement(t,r)}setColumnWidth(e,t){t+=2;let{columnWidths:r}=this;r[e]>t||(r[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;let{columnWidths:i}=this;i.length=0;let{headerRow:a}=this,o=document.createElement("div");o.style.gridColumn="symbol";let l=document.createElement("div");l.style.gridColumn="delete",_e(a),a.appendChild(o);let c=0,d="[symbol] 2ch",p=(v,b)=>{let x=document.createElement("div");x.classList.add("neuroglancer-annotations-view-dimension");let C=document.createElement("span");C.classList.add("neuroglancer-annotations-view-dimension-name"),C.textContent=v.names[b];let k=document.createElement("scale");k.classList.add("neuroglancer-annotations-view-dimension-scale"),k.textContent=_i(v.scales[b],v.units[b],{precision:2}),x.appendChild(C),x.appendChild(k),x.style.gridColumn=`dim ${c+1}`,this.setColumnWidth(c,k.textContent.length+C.textContent.length+3),d+=` [dim] var(--neuroglancer-column-${c}-width)`,++c,a.appendChild(x)},m=this.layer.manager.root.coordinateSpace.value;for(let v of this.globalDimensionIndices)p(m,v);let y=this.layer.localCoordinateSpace.value;for(let v of this.localDimensionIndices)p(y,v);a.appendChild(l),d+=" [delete] 2ch",this.gridTemplate=d,a.style.gridTemplateColumns=d,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1,{listElements:t}=this;t.length=0;for(let[i,a]of this.attachedAnnotationStates){if(i.source.readonly||(e=!0),i.chunkTransform.value.error!==void 0)continue;let{source:o}=i,l=Array.from(o);a.annotations=l;let{idToIndex:c}=a;c.clear();for(let d=0,p=l.length;d<p;++d)c.set(l[d].id,d);for(let d of l)t.push({state:i,annotation:d})}let r=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:r,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(let t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}clearAnnotationElement(e){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let t=this.attachedAnnotationStates.get(e);if(t!==void 0){let r=t.annotations.length;t.annotations=[],t.idToIndex.clear(),this.listElements=[],this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:r,insertCount:0}])}this.resetOnUpdate()}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let i=r.annotations.length;r.annotations.push(e),r.idToIndex.set(e.id,i);let a=r.listOffset+i;this.listElements.splice(a,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let i=r.idToIndex.get(e.id);if(i!==void 0){let a=r.listOffset+i;r.annotations[i]=e,this.listElements[a].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let{idToIndex:i}=r,a=i.get(e);if(a!==void 0){let o=r.listOffset+a,{annotations:l}=r;l.splice(a,1),i.delete(e);for(let c=a,d=l.length;c<d;++c)i.set(l[c].id,c);this.listElements.splice(o,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:o,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){let r=t.chunkTransform.value,i=document.createElement("div");i.classList.add("neuroglancer-annotation-list-entry"),i.style.gridTemplateColumns=this.gridTemplate;let a=document.createElement("div");a.className="neuroglancer-annotation-icon",a.textContent=An[e.type].icon,i.appendChild(a);let o,l=()=>{t.source.readonly||o===void 0&&(o=wi({title:"Delete annotation",onClick:p=>{p.stopPropagation(),p.preventDefault();let m=t.source.getReference(e.id);try{t.source.delete(m)}finally{m.dispose()}}}),o.classList.add("neuroglancer-annotation-list-entry-delete"),i.appendChild(o))},c=0;if(c2(e,r,(p,m)=>{++c;let y=document.createElement("div");y.className="neuroglancer-annotation-position",i.appendChild(y);let v=0,b=(x,C)=>{for(let k of x){let D=C[k];if(D!==-1){let P=Math.floor(p[D]),M=document.createElement("div"),I=P.toString();M.textContent=I,M.classList.add("neuroglancer-annotation-coordinate"),M.style.gridColumn=`dim ${v+1}`,this.setColumnWidth(v,I.length),y.appendChild(M)}++v}};b(this.globalDimensionIndices,r.modelTransform.globalToRenderLayerDimensions),b(this.localDimensionIndices,r.modelTransform.localToRenderLayerDimensions),l()}),e.description){++c;let p=document.createElement("div");p.classList.add("neuroglancer-annotation-description"),p.textContent=e.description,i.appendChild(p)}a.style.gridRow=`span ${c}`,o!==void 0&&(o.style.gridRow=`span ${c}`),i.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)}),i.addEventListener("action:select-position",p=>{p.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")}),i.addEventListener("action:pin-annotation",p=>{p.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)}),i.addEventListener("action:move-to-annotation",p=>{p.stopPropagation(),p.preventDefault();let{layerRank:m}=r,y=new Float32Array(m),v=new Float32Array(m);Wq(y,e),Xr(v,r.chunkToLayerTransform,m+1,y,m),l2(this.layer,r,v)});let d=this.selectedAnnotationState.value;return d!==void 0&&d.annotationLayerState===t&&d.annotationId===e.id&&i.classList.add("neuroglancer-annotation-selected"),i}},d2=class extends sn{constructor(e){super();this.layer=e;this.layerView=this.registerDisposer(new u2(this.layer,this.layer.annotationDisplayState));let{element:t}=this;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}};function du(n){let e=[],{relationships:t}=n.source,{relationshipStates:r}=n.displayState;for(let i=0,a=t.length;i<a;++i){let o=r.get(t[i]).segmentationState.value;if(o!=null&&o.segmentSelectionState.hasSelectedSegment){e[i]=[o.segmentSelectionState.selectedSegment.clone()];continue}e[i]=[]}return e}var Ww=class extends Ap{constructor(e,t){super(e)}get annotationLayer(){for(let e of this.layer.annotationStates.states)if(!e.source.readonly)return e}},p2="annotatePoint",f2="annotateLine",h2="annotateBoundingBox",m2="annotateEllipsoid",g2="annotateSphere",zw=class extends Ww{constructor(){super(...arguments);this.sourceSignalUpdated=!1}trigger(e){let{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){let r=Kp(e,t);if(r===void 0)return;let i={id:"",description:"",relatedSegments:du(t),point:r,type:be.POINT,properties:t.source.properties.map(o=>o.default)},a=t.source.add(i,!0);t.source instanceof vn?this.sourceSignalUpdated||(t.source.childAdded.add(o=>{o.source===void 0&&this.layer.selectAnnotation(t,o.id,!0,!Ga.expectingExternalUI)}),this.sourceSignalUpdated=!0):this.layer.selectAnnotation(t,a.id,!0),a.dispose()}}get description(){return"annotate point"}toJSON(){return p2}};function Kp(n,e){let t=e.chunkTransform.value;if(t.error!==void 0)return;let r=new Float32Array(t.modelTransform.unpaddedRank);if(!!ao(r,n.unsnappedPosition,e.localPosition.value,t.layerRank,t.combinedGlobalLocalToChunkTransform))return r}var Hw=class extends Ww{trigger(e){let{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){let r=()=>{let i=this.inProgressAnnotation,a=i.reference,o=this.getUpdatedAnnotation(a.value,e,t);JSON.stringify(dh(o,t.source))!==JSON.stringify(dh(a.value,t.source))&&(i.annotationLayer.source.update(a,o),this.layer.selectAnnotation(t,a.id,!0,!Ga.expectingExternalUI))};if(this.inProgressAnnotation===void 0){let i=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,i.id,!0,!Ga.expectingExternalUI);let a=e.changed.add(r),o=()=>{a(),i.dispose()};this.inProgressAnnotation={annotationLayer:t,reference:i,disposer:o}}else r(),this.inProgressAnnotation.annotationLayer.source.commit(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0}}disposed(){this.deactivate(),super.disposed()}deactivate(){this.inProgressAnnotation!==void 0&&(this.inProgressAnnotation.annotationLayer.source.delete(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0)}},Kg=class extends Hw{getInitialAnnotation(e,t){let r=Kp(e,t);return{id:"",type:this.annotationType,description:"",pointA:r,pointB:r,properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){let i=Kp(t,r);return i===void 0?e:{...e,pointB:i}}},Yg=class extends Kg{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),{pointA:a,pointB:o}=i,l=a.length;for(let c=0;c<l;++c)a[c]===o[c]&&(o[c]+=1);return i}toJSON(){return h2}};Yg.prototype.annotationType=be.AXIS_ALIGNED_BOUNDING_BOX;var Xg=class extends Kg{get description(){return"annotate line"}getInitialAnnotation(e,t){let r=super.getInitialAnnotation(e,t);return this.initialRelationships=r.relatedSegments=du(t),r}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),a=this.initialRelationships,o=du(r);return a===void 0?i.relatedSegments=o:i.relatedSegments=Array.from(o,(l,c)=>{let d=a[c];return l=l.filter(p=>d.findIndex(m=>X.equal(p,m))===-1),[...d,...l]}),i}toJSON(){return f2}};Xg.prototype.annotationType=be.LINE;var Qg=class extends Kg{get description(){return"annotate sphere"}getInitialAnnotation(e,t){let r=super.getInitialAnnotation(e,t);return this.initialRelationships=r.relatedSegments=du(t),r}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),a=this.initialRelationships,o=du(r);return a===void 0?i.relatedSegments=o:i.relatedSegments=Array.from(o,(l,c)=>{let d=a[c];return l=l.filter(p=>d.findIndex(m=>X.equal(p,m))===-1),[...d,...l]}),i}toJSON(){return g2}};Qg.prototype.annotationType=be.SPHERE;var $w=class extends Hw{getInitialAnnotation(e,t){let r=Kp(e,t);return{type:be.ELLIPSOID,id:"",description:"",segments:du(t),center:r,radii:J.fromValues(0,0,0),properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){let i=Kp(t,r);if(i===void 0)return e;let a=e.center,o=a.length;for(let l=0;l<o;++l)i[l]=Math.abs(a[l]-i[l]);return{...e,radii:i}}get description(){return"annotate ellipsoid"}toJSON(){return m2}};Qc(p2,(n,e)=>new zw(n,e));Qc(h2,(n,e)=>new Yg(n,e));Qc(f2,(n,e)=>new Xg(n,e));Qc(m2,(n,e)=>new $w(n,e));Qc(g2,(n,e)=>new Qg(n,e));var zq=Oe.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function Hq(n,e,t,r){return new Kn(t,(i,a,o)=>{let l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list"),i!=null&&o.registerDisposer(as(i,l));let c=document.createElement("div");c.classList.add("neuroglancer-related-segment-list-header");let d=Jn({title:"Copy segment IDs",onClick:()=>{en(e.map(b=>b.toString()).join(", "))}});c.appendChild(d);let p;if(i!=null&&(p=document.createElement("input"),p.type="checkbox",p.addEventListener("change",()=>{let{visibleSegments:b}=i.segmentationGroupState.value,x=e.some(C=>!b.has(C));for(let C of e)b.set(C,x)}),c.appendChild(p)),r!==void 0){let b=wi({title:"Remove all IDs",onClick:()=>{r([])}});c.appendChild(b)}let m=document.createElement("span");if(m.classList.add("neuroglancer-related-segment-list-title"),m.textContent=n,c.appendChild(m),r!==void 0){let b=yg({title:"Add related segment ID",onClick:()=>{let x=new j,C=o.registerDisposer(Bf(x)),k=document.createElement("div");k.classList.add("neuroglancer-segment-list-entry"),k.classList.add("neuroglancer-segment-list-entry-new");let D=Jn({});if(D.classList.add("neuroglancer-segment-list-entry-copy"),k.appendChild(D),i!=null){let _=document.createElement("input");_.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),_.type="checkbox",k.appendChild(_)}let P=wi({title:"Cancel adding new segment ID",onClick:()=>{C()}});P.classList.add("neuroglancer-segment-list-entry-delete"),k.appendChild(P);let M=document.createElement("input");M.autocomplete="off",M.spellcheck=!1,M.classList.add("neuroglancer-segment-list-entry-id");let I=x.registerDisposer(new zt(M,zq));I.allShortcutsAreGlobal=!0;let E=()=>{let _=new X;if(_.tryParseString(M.value))return M.dataset.valid="true",_;M.dataset.valid="false"};E(),M.addEventListener("input",()=>{E()}),M.addEventListener("blur",()=>{let _=E();_!==void 0&&r([...e,_]),C()}),ce(M,"cancel",C),ce(M,"commit",()=>{let _=E();_!==void 0&&r([...e,_]),C()}),k.appendChild(M),l.appendChild(k),M.focus(),x.registerDisposer(()=>{M.value="",k.remove()})}});c.appendChild(b)}l.appendChild(c);let y=[],v=fl.make(i!=null?i:void 0,!1);for(let b of e){let x=v.get(b);if(y.push(x),r!==void 0){let C=wi({title:"Remove ID",onClick:k=>{r(e.filter(D=>!X.equal(D,b))),k.stopPropagation()}});C.classList.add("neuroglancer-segment-list-entry-delete"),x.children[0].appendChild(C)}l.appendChild(x)}if(i!=null){let b=o.registerCancellable(Ge(()=>{let{visibleSegments:x}=i.segmentationGroupState.value,C=0;for(let k of e)x.has(k)&&++C;for(let k of y)v.update(k);p.checked=C===e.length&&C>0,p.indeterminate=C>0&&C<e.length}));b(),b.flush(),os(i,o,b),o.registerDisposer(i.segmentationGroupState.changed.add(b))}a.appendChild(l)})}var y2="annotationColor";function pu(n){class e extends n{constructor(...r){super(...r);this.annotationStates=this.registerDisposer(new s2);this.annotationDisplayState=new kw;this.annotationCrossSectionRenderScaleHistogram=new Pa;this.annotationCrossSectionRenderScaleTarget=Wi(8);this.annotationProjectionRenderScaleHistogram=new Pa;this.annotationProjectionRenderScaleTarget=Wi(8);this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new d2(this)});let i,a=()=>{let l=this.isReady;l&&i!==void 0?(i(),i=void 0):!l&&i===void 0&&(i=this.annotationStates.markLoading())};this.readyStateChanged.add(a),a();let{mouseState:o}=this.manager.layerSelectedValues;this.registerDisposer(o.changed.add(()=>{if(o.active){let{pickedAnnotationLayer:l}=o;if(l!==void 0&&this.annotationStates.states.includes(l)){let c=this.annotationDisplayState.hoverState.value;(c===void 0||c.id!==o.pickedAnnotationId||c.partIndex!==o.pickedOffset||c.annotationLayerState!==l)&&(this.annotationDisplayState.hoverState.value={id:o.pickedAnnotationId,partIndex:o.pickedOffset,annotationLayerState:l});return}}this.annotationDisplayState.hoverState.value=void 0}))}initializeAnnotationLayerViewTab(r){}restoreState(r){super.restoreState(r),this.annotationDisplayState.color.restoreState(r[y2])}captureSelectionState(r,i){super.captureSelectionState(r,i);let a=i.pickedAnnotationLayer;a===void 0||!this.annotationStates.states.includes(a)||(r.annotationId=i.pickedAnnotationId,r.annotationType=i.pickedAnnotationType,r.annotationBuffer=new Uint8Array(i.pickedAnnotationBuffer,i.pickedAnnotationBufferBaseOffset),r.annotationIndex=i.pickedAnnotationIndex,r.annotationCount=i.pickedAnnotationCount,r.annotationPartIndex=i.pickedOffset,r.annotationSourceIndex=a.sourceIndex,r.annotationSubsource=a.subsourceId)}displayAnnotationState(r,i,a){if(r.annotationId===void 0)return!1;let o=this.annotationStates.states.find(c=>c.sourceIndex===r.annotationSourceIndex&&(r.annotationSubsource===void 0||c.subsourceId===r.annotationSubsource));if(o===void 0)return!1;o.source instanceof vn;let l=a.registerDisposer(o.source.getReference(r.annotationId));return i.appendChild(a.registerDisposer(new Kn(a.registerDisposer(new id(()=>({annotation:l,chunkTransform:o.chunkTransform}))),({annotation:c,chunkTransform:d},p,m)=>{let y;if(c==null)if(r.annotationType!==void 0&&r.annotationBuffer!==void 0){let v=An[r.annotationType],b=o.source.rank,x=v.serializedBytes(b),C=r.annotationBuffer.byteOffset,k=new DataView(r.annotationBuffer.buffer),D=mn.LITTLE===ma,{properties:P}=o.source,M=new oh(b,x,P),I=r.annotationIndex,E=r.annotationCount;c=v.deserialize(k,C+M.propertyGroupBytes[0]*I,D,b,r.annotationId),M.deserialize(k,C,I,E,D,c.properties=new Array(P.length)),o.source.hasNonSerializedProperties()&&(y="Loading...")}else y=c===null?"Annotation not found":"Loading...";if(c!=null){let v=d.error===void 0?d.layerRank:0,b=document.createElement("div");b.classList.add("neuroglancer-selected-annotation-details-position-grid"),b.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${v}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,p.appendChild(b);let x=An[c.type],C=document.createElement("div");if(C.className="neuroglancer-selected-annotation-details-icon",C.textContent=x.icon,b.appendChild(C),v!==0){let{layerDimensionNames:_}=d.modelTransform;for(let O=0;O<v;++O){let B=document.createElement("div");B.classList.add("neuroglancer-selected-annotation-details-position-dim"),B.textContent=_[O],B.style.gridColumn=`dim ${O+1}`,b.appendChild(B)}c2(c,d,(O,B)=>{let W=Jn({title:"Copy position",onClick:()=>{en(O.map(V=>Math.floor(V)).join(", "))}});W.style.gridColumn="copy",b.appendChild(W);for(let V=0;V<v;++V){let U=document.createElement("div");U.classList.add("neuroglancer-selected-annotation-details-position-coord"),U.style.gridColumn=`coord ${V+1}`,U.textContent=Math.floor(O[V]).toString(),b.appendChild(U)}if(!B){let V=ym({title:"Move to position",onClick:()=>{l2(this,d,O)}});V.style.gridColumn="move",b.appendChild(V)}})}if(!o.source.readonly){let _=wi({title:"Delete annotation",onClick:()=>{o.source.delete(l)}});_.classList.add("neuroglancer-selected-annotation-details-delete"),b.appendChild(_)}let{relationships:k,properties:D}=o.source,P=o.source.readonly;for(let _=0,O=D.length;_<O;++_){let B=D[_],W=document.createElement("label");W.classList.add("neuroglancer-annotation-property");let V=document.createElement("span");V.classList.add("neuroglancer-annotation-property-label"),V.textContent=B.identifier,W.appendChild(V);let{description:U}=B;U!==void 0&&(W.title=U);let N=c.properties[_],q=document.createElement("span");switch(q.classList.add("neuroglancer-annotation-property-value"),B.type){case"rgb":{let ne=Za(N),pe=hn(ne);q.textContent=pe,q.style.backgroundColor=pe,q.style.color=pd(ne)?"white":"black";break}case"rgba":{let ne=Za(N);q.textContent=hn(dd(N)),q.style.backgroundColor=hn(Za(N)),q.style.color=pd(ne)?"white":"black";break}default:q.textContent=$v(B,N);break}W.appendChild(q),p.appendChild(W)}let{relatedSegments:M}=c;for(let _=0,O=k.length;_<O;++_){let B=M===void 0?[]:M[_];if(B.length===0&&P)continue;let W=_,V=k[_];p.appendChild(m.registerDisposer(Hq(V,B,o.displayState.relationshipStates.get(V).segmentationState,P?void 0:U=>{let N=l.value;if(N==null)return;let{relatedSegments:q}=N;q===void 0?q=o.source.relationships.map(()=>[]):q=q.slice(),q[W]=U;let ne={...N,relatedSegments:q};o.source.update(l,ne),o.source.commit(l)})).element)}let I=null,{source:E}=o;if(E instanceof vn&&E.makeEditWidget&&(I=E.makeEditWidget(l),I&&(I.className="neuroglancer-annotation-details-description",p.appendChild(I))),(!o.source.readonly||c.description)&&I===null)if(o.source.readonly){let _=document.createElement("div");_.className="neuroglancer-annotation-details-description",_.textContent=c.description||"",p.appendChild(_)}else{let _=document.createElement("textarea");_.value=c.description||"",_.rows=3,_.className="neuroglancer-annotation-details-description",_.placeholder="Description",_.addEventListener("change",()=>{let O=_.value;o.source.update(l,{...c,description:O||void 0}),o.source.commit(l)}),p.appendChild(_)}}if(y!==void 0){let v=document.createElement("div");v.classList.add("neuroglancer-selection-annotation-status"),v.textContent=y,p.appendChild(v)}})).element),!0}displaySelectionState(r,i,a){let o=this.displayAnnotationState(r,i,a);return super.displaySelectionState(r,i,a)&&(o=!0),o}addLocalAnnotations(r,i,a){let{subsourceEntry:o}=r,l=new lu({localPosition:this.localPosition,transform:r.getRenderLayerTransform(),source:i,displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:o.id,role:a});this.addAnnotationLayerState(l,r)}addStaticAnnotations(r){let{subsourceEntry:i}=r,{staticAnnotations:a}=i.subsource;return a===void 0?!1:(r.activate(()=>{this.addLocalAnnotations(r,a,or.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(r,i){let a=i.activated;a.registerDisposer(this.annotationStates.add(r));let o=new Uw(this.manager.chunkManager,r.addRef());if(o.source instanceof vn){let l=new a2({annotationLayer:o.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});a.registerDisposer(i.messages.addChild(l.messages));let c=new i2({annotationLayer:o.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});a.registerDisposer(i.messages.addChild(c.messages)),a.registerDisposer(Dn((d,p)=>{p&&(d.registerDisposer(this.addRenderLayer(l.addRef())),d.registerDisposer(this.addRenderLayer(c.addRef())))},this.annotationDisplayState.displayUnfiltered))}{let l=new o2(o,this.annotationCrossSectionRenderScaleHistogram);a.registerDisposer(this.addRenderLayer(l)),a.registerDisposer(i.messages.addChild(l.messages))}{let l=new Gw(o.addRef(),this.annotationProjectionRenderScaleHistogram);a.registerDisposer(this.addRenderLayer(l)),a.registerDisposer(i.messages.addChild(l.messages))}}selectAnnotation(r,i,a,o=!0){this.manager.root.selectionState.captureSingleLayerState(this,l=>(l.annotationId=i,l.annotationSourceIndex=r.sourceIndex,l.annotationSubsource=r.subsourceId,!0),a,o)}toJSON(){let r=super.toJSON();return r[y2]=this.annotationDisplayState.color.toJSON(),r}}return e}var v2="volume_rendering/VolumeRenderingRenderLayer",S2="volume_rendering/VolumeRenderingRenderLayer/update",Zg=64,$q=Et.create();function b2(n,e,t){let r=0,i=0;for(let d=0;d<3;++d){let p=n[16+d],m=p*e[d],y=p*t[d];r+=Math.min(m,y),i+=Math.max(m,y)}let a=-n[19],o=Math.max(a,r),l=n[23],c=Math.min(l,i);return{near:a,far:l,adjustedNear:o,adjustedFar:c}}function jw(n,e,t,r,i,a){if(r.length===0)return;let{viewMatrix:o,projectionMat:l,displayDimensionRenderInfo:c}=n,{voxelPhysicalScales:d}=c,p=cd(d),y=(Qf(l)/Zg)**3,v=Et.determinant(Us($q,o)),b=I=>{let E=r[I];return Math.abs(E.chunkLayout.detTransform*v)},x=r.length-1,C=b(x);for(let I=x-1;I>=0;--I){let E=b(I);if(Math.abs(E-y)<Math.abs(C-y))C=E,x=I;else break}let k=Math.pow(C*p/v,1/3),D=Math.pow(C,1/3)*n.width/(2*l[0]),P=!0,M=r[x];Oh(n,e,M,(I,E)=>{P&&(i(M,x,k,D,E),P=!1),a(M,x,I)})}var jq=re.create(),qq=new Float32Array(24),qw=class extends Ur{get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}constructor(e){super();this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.renderScaleTarget=e.renderScaleTarget,this.renderScaleHistogram=e.renderScaleHistogram,this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility));let t=this.registerDisposer(Qt(o=>o.rank,[this.channelCoordinateSpace]));this.shaderGetter=Ed(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:o,chunkFormat:l})=>`${ct(o)}:${l.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(o,{emitter:l,chunkFormat:c},d,p)=>{if(d.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Yn(o),o.addFragmentCode(`
#define VOLUME_RENDERING true
`),l(o),o.addUniform("highp float","uNearLimitFraction"),o.addUniform("highp float","uFarLimitFraction"),o.addUniform("highp int","uMaxSteps"),o.addUniform("highp vec3","uTranslation"),o.addUniform("highp mat4","uModelViewProjectionMatrix"),o.addUniform("highp mat4","uInvModelViewProjectionMatrix"),o.addUniform("highp vec3","uChunkDataSize"),o.addUniform("highp vec3","uLowerClipBound"),o.addUniform("highp vec3","uUpperClipBound"),o.addUniform("highp float","uBrightnessFactor"),o.addVarying("highp vec4","vNormalizedPosition"),o.addVertexCode(AV),o.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),o.addFragmentCode(`
vec3 curChunkPosition;
vec4 outputColor;
void userMain();
`),Tm(o,c,p,"curChunkPosition"),o.addFragmentCode(`
void emitRGBA(vec4 rgba) {
  float alpha = rgba.a * uBrightnessFactor;
  outputColor += vec4(rgba.rgb * alpha, alpha);
}
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGB(vec3(value, value, value));
}
void emitTransparent() {
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
`),o.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  for (int step = startStep; step < endStep; ++step) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(step) * stepSize);
    curChunkPosition = position - uTranslation;
    userMain();
  }
  emit(outputColor, 0u);
}
`),o.addFragmentCode(Oi),Ui(d,o),o.addFragmentCode(`
#define main userMain
`+Ni(d.parseResult.code)+`
#undef main
`)}}),this.vertexIdHelper=this.registerDisposer(Cn.get(this.gl)),this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));let{chunkManager:r}=this.multiscaleSource,i=this.registerDisposer(new La(this.layerChunkProgressInfo)),a=r.rpc;i.RPC_TYPE_ID=v2,i.initializeCounterpart(a,{chunkManager:r.rpcId,localPosition:this.registerDisposer(gt.makeFromExisting(a,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(gt.makeFromExisting(a,this.renderScaleTarget)).rpcId}),this.backend=i}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer(Dn((t,r,i)=>{let a=al(i,r,o=>this.multiscaleSource.getSources(o),e.messages,this);for(let o of a)for(let l of o)t.registerDisposer(l.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(S2,{layer:this.backend.rpcId,view:e.view.rpcId,sources:nl(a)}),this.redrawNeeded.dispatch(),a},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;let r=t.state.sources.value;if(r.length===0)return;let i=0,a=0,o=null,l,c,d=J.create(),{gl:p}=this;this.vertexIdHelper.enable();let{renderScaleHistogram:m}=this;m.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let y=()=>{o!==null&&(l!==null&&l.endDrawing(p,o),(C!==0||k!==0)&&m.add(i,a,C,k))},v=!0,{projectionParameters:b}=e,x,C=0,k=0,D,P=this.multiscaleSource.rank,M=J.create();p.enable(WebGL2RenderingContext.CULL_FACE),p.cullFace(WebGL2RenderingContext.FRONT),jw(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],(I,E,_,O)=>{i=_,a=O;let B=xc(b,I.chunkLayout),W=I.source,{fixedPositionWithinChunk:V,chunkDisplayDimensionIndices:U}=I;for(let ge of U)V[ge]=0;let N=W.chunkFormat;if(N!==l&&(l=N,y(),c=this.shaderGetter({emitter:e.emitter,chunkFormat:N}),o=c.shader,o!==null&&(o.bind(),N!==null&&(ti(p,o,this.shaderControlState,c.parameters.parseResult.controls),N.beginDrawing(p,o),N.beginSource(p,o)))),D=void 0,o===null)return;x=W.chunks,d.fill(1);let q=re.multiply(jq,b.viewProjectionMat,B.transform);p.uniformMatrix4fv(o.uniform("uModelViewProjectionMatrix"),!1,q);let ne=qq;Fs(ne,q),re.invert(q,q),p.uniformMatrix4fv(o.uniform("uInvModelViewProjectionMatrix"),!1,q);let{near:pe,far:me,adjustedNear:Pe,adjustedFar:se}=b2(ne,I.lowerClipDisplayBound,I.upperClipDisplayBound),Ae=(se-Pe)/(Zg-1)/(me-pe);p.uniform1f(o.uniform("uBrightnessFactor"),Ae);let Be=(Pe-pe)/(me-pe),Ze=(se-pe)/(me-pe);p.uniform1f(o.uniform("uNearLimitFraction"),Be),p.uniform1f(o.uniform("uFarLimitFraction"),Ze),p.uniform1i(o.uniform("uMaxSteps"),Zg),p.uniform3fv(o.uniform("uLowerClipBound"),I.lowerClipDisplayBound),p.uniform3fv(o.uniform("uUpperClipBound"),I.upperClipDisplayBound)},I=>{if(o===null)return;let E=I.curPositionInChunks.join(),_=x.get(E);if(_!==void 0&&_.state===nt.GPU_MEMORY){let O=I.chunkLayout.size,B=_.chunkDataSize,{chunkDisplayDimensionIndices:W,fixedPositionWithinChunk:V,chunkTransform:{channelToChunkDimensionIndices:U}}=I,{}=I;if(B!==D){D=B;for(let q=0;q<3;++q){let ne=W[q];d[q]=ne===-1||ne>=P?1:D[ne]}p.uniform3fv(o.uniform("uChunkDataSize"),d)}let{chunkGridPosition:N}=_;for(let q=0;q<3;++q){let ne=W[q];M[q]=ne===-1||ne>=P?0:O[q]*N[ne]}l!=null&&l.bindChunk(p,o,_,V,W,U,v),v=!1,p.uniform3fv(o.uniform("uTranslation"),M),IV(p,1,1),++C}else++k}),p.disable(WebGL2RenderingContext.CULL_FACE),y(),this.vertexIdHelper.disable()}isReady(e,t){let r=t.state.sources.value;if(r.length===0)return!0;let i=!1;return jw(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],()=>{},a=>{let o=a.source.chunks.get(a.curPositionInChunks.join());(o===void 0||o.state!==nt.GPU_MEMORY)&&(i=!0)}),i}};var Jq=Oe.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}}),x2=class{constructor(e){this.id=e;this.element=document.createElement("div");this.nameContainer=document.createElement("div");this.nameElement=document.createElement("input");this.lowerElement=document.createElement("div");this.upperElement=document.createElement("div");let{element:t,nameContainer:r,nameElement:i,lowerElement:a,upperElement:o}=this;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),r.classList.add("neuroglancer-channel-dimensions-widget-name-container"),i.classList.add("neuroglancer-channel-dimensions-widget-name"),r.appendChild(i),a.classList.add("neuroglancer-channel-dimensions-widget-lower"),o.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(r),t.appendChild(a),t.appendChild(o),r.draggable=!0,i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",i.required=!0,i.placeholder=" ",r.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",r.addEventListener("dblclick",()=>{i.disabled=!1,i.focus(),i.select()}),i.addEventListener("focus",()=>{i.select()})}},Jw=class extends j{constructor(e){super();this.combiner=e;this.element=document.createElement("div");this.dimensionWidgets=[];this.curCoordinateSpace=void 0;this.dragSource=void 0;this.coordinateSpace=this.combiner.combined;let{element:t}=this;t.classList.add("neuroglancer-channel-dimensions-widget");let r=this.registerCancellable(Ge(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(r));let i=this.registerDisposer(new zt(t,Jq));i.allShortcutsAreGlobal=!0,this.registerDisposer(ce(t,"cancel",a=>{this.forceUpdateView();let{target:o}=a;o instanceof HTMLElement&&o.blur()})),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:r}=this;r.value=Dh(r.value,e,t)}makeNewDimensionWidget(e){let t=new x2(e);return t.nameContainer.addEventListener("dragstart",r=>{this.dragSource=t,r.stopPropagation(),r.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",r=>{let{dragSource:i}=this;if(i===void 0||i===t)return;let{dimensionWidgets:a}=this,o=a.indexOf(i),l=a.indexOf(t);o===-1||l===-1||(r.preventDefault(),this.reorderDimensionTo(l,o))}),t.nameContainer.addEventListener("dragend",r=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",r=>{t.nameElement.disabled=!0;let{relatedTarget:i}=r;this.dimensionWidgets.some(a=>a.nameElement===i)||this.updateNames()||this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{let{nameElement:r}=t;Sn(r),this.updateNameValidity()}),ce(t.nameElement,"commit",()=>{this.updateNames()}),ce(t.nameElement,"tab-forward",r=>this.selectAdjacentField(r,t,1)),ce(t.nameElement,"tab-backward",r=>this.selectAdjacentField(r,t,-1)),t}selectAdjacentField(e,t,r){e.stopPropagation();let{dimensionWidgets:i}=this,a=i.indexOf(t);if(a===-1)return;let o=a+r;if(o<0||o>=i.length)return;let l=i[o];l.nameElement.disabled=!1,l.nameElement.focus(),e.preventDefault()}updateNames(){let{dimensionWidgets:e,coordinateSpace:t}=this,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;let a=r.names;if(we(a,i))return!1;let o=r.timestamps.map((c,d)=>a[d]===i[d]?c:Date.now()),l={...r,names:i,timestamps:o};return t.value=l,!0}updateNameValidity(){let{dimensionWidgets:e}=this,t=e.map(a=>a.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let a=0;a<r;++a)e[a].nameElement.dataset.isValid=i[a]===!1?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){let{coordinateSpace:{value:e}}=this;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;let{element:t}=this,r=this.dimensionWidgets,i=this.dimensionWidgets=e.ids.map(o=>r.find(l=>l.id===o)||this.makeNewDimensionWidget(o));function*a(){let{names:o,rank:l,bounds:{lowerBounds:c,upperBounds:d}}=e;for(let p=0;p<l;++p){let m=i[p];m.nameElement.value=o[p],delete m.nameElement.dataset.isValid,Sn(m.nameElement),m.lowerElement.textContent=c[p].toString(),m.upperElement.textContent=d[p].toString(),yield m.element}}qn(t,a.call(this))}};function Ss(n={}){return $e({text:"?",...n})}function C2(n,e,t,r){let i=document.createElement("label");i.classList.add("neuroglancer-layer-control-container");let a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label-container");let o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label"),a.appendChild(o);let l=document.createElement("div");l.classList.add("neuroglancer-layer-control-label-text-container"),l.appendChild(document.createTextNode(t.label)),o.appendChild(l),t.title&&(o.title=t.title),i.appendChild(a);let{control:c,controlElement:d}=t.makeControl(e,n,{labelContainer:a,labelTextContainer:l,display:e.manager.root.display,visibility:r});return d.classList.add("neuroglancer-layer-control-control"),i.appendChild(d),{controlContainer:i,label:o,labelContainer:a,labelTextContainer:l,control:c}}var ey=class extends Yi{constructor(e,t){super(e);this.options=t}activate(e){let{options:t}=this,{layer:r}=this,{isValid:i}=t;if(i!==void 0&&!i(r).value)return;let{header:a,body:o}=Tl(e),{controlContainer:l,control:c,labelContainer:d}=C2(e,r,t,new Pt(Pt.VISIBLE));a.appendChild(d),o.appendChild(l),t.activateTool(e,c)}get description(){var t;let{options:e}=this;return(t=e.toolDescription)!=null?t:e.label}toJSON(){return this.options.toolJson}};function w2(n,e,t,r){let{controlContainer:i,label:a}=C2(n,e,t,r);return i.classList.add("neuroglancer-layer-options-control-container"),a.prepend(n.registerDisposer(new xg(e,t.toolJson)).element),i}function fu(n,e,t,r){let{isValid:i}=r;return i===void 0?w2(n,e,r,t):n.registerDisposer(new Kn(i(e),(a,o,l)=>{!a||o.appendChild(w2(l,e,r,t))},t)).element}function ty(n,e){let{toolJson:t}=e,r=typeof t=="string"?t:t.type;xo(n,r,i=>new ey(i,e))}function bs(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new br(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}var Kq=Oe.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function ny(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new Gp(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(Kq),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)})}}}var Kw=class extends j{constructor(e,{min:t=0,max:r=1,step:i=.01}={}){super();this.value=e;this.element=document.createElement("label");this.inputElement=document.createElement("input");this.numericInputElement=document.createElement("input");let{element:a,inputElement:o,numericInputElement:l}=this;a.className="range-slider";let c=p=>{p.min=""+t,p.max=""+r,p.step=""+i,p.valueAsNumber=this.value.value,this.registerEventListener(p,"change",()=>this.inputValueChanged(p)),this.registerEventListener(p,"input",()=>this.inputValueChanged(p)),this.registerEventListener(p,"wheel",m=>{this.adjustViaWheel(p,m)})};o.type="range",c(o),l.type="number";let d=Math.max(t.toString().length,r.toString().length,Math.min(r,t+i).toString().length,Math.max(t,r-i).toString().length);l.style.width=d+2+"ch",c(l),a.appendChild(o),a.appendChild(l),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){let r=this.inputElement,{deltaY:i}=t;i>0?(r.stepUp(),this.inputValueChanged(e)):i<0&&(r.stepDown(),this.inputValueChanged(e))}disposed(){Xe(this.element),super.disposed()}};var Yq=Oe.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function Zi(n){return{makeControl:(e,t)=>{let{value:r,options:i}=n(e),a=t.registerDisposer(new Kw(r,i));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(Yq),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(t.inputElement,r.detail)})}}}var T2='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="maximiseIconTitle"><polyline points="21 16 21 21 16 21"></polyline><polyline points="8 21 3 21 3 16"></polyline><polyline points="16 3 21 3 21 8"></polyline><polyline points="3 8 3 3 8 3"></polyline></svg>';function xs(n={}){return $e({svg:T2,...n})}var k2=at(It()),L2=at(Cp());var Xq=200,E2=Oe.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});function Qq(n){if(n<1||n>1024){let e=Math.log2(n)|0,t=n/2**e;return`${Eg(t,1)}p${e}`}return Math.round(n)+""}var Yp=class extends j{constructor(e,t){super();this.histogram=e;this.target=t;this.label=document.createElement("div");this.element=document.createElement("div");this.canvas=document.createElement("canvas");this.legend=document.createElement("div");this.legendRenderScale=document.createElement("div");this.legendSpatialScale=document.createElement("div");this.legendChunks=document.createElement("div");this.ctx=this.canvas.getContext("2d");this.hoverTarget=new Re(void 0);this.throttledUpdateView=this.registerCancellable((0,L2.default)(()=>this.debouncedUpdateView(),Xq,{leading:!0,trailing:!0}));this.debouncedUpdateView=this.registerCancellable((0,k2.default)(()=>this.updateView(),0));let{canvas:r,label:i,element:a,legend:o,legendRenderScale:l,legendSpatialScale:c,legendChunks:d}=this;i.className="neuroglancer-render-scale-widget-prompt",a.className="neuroglancer-render-scale-widget",a.title=E2.describe(),o.className="neuroglancer-render-scale-widget-legend",a.appendChild(i),a.appendChild(r),a.appendChild(o),l.title="Target resolution of data in screen pixels",d.title="Number of chunks rendered",o.appendChild(l),o.appendChild(d),o.appendChild(c),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new xn(r,E2)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));let p=y=>{let v=y.offsetX/r.width*nn;return UD(v)};this.registerEventListener(r,"pointermove",y=>{this.hoverTarget.value=[p(y),y.offsetY]}),this.registerEventListener(r,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(ce(r,"set",y=>{this.target.value=p(y.detail)})),this.registerDisposer(ce(r,"adjust-via-wheel",y=>{this.adjustViaWheel(y.detail)})),this.registerDisposer(ce(r,"reset",y=>{this.reset(),y.preventDefault()}));let m=new ResizeObserver(()=>this.debouncedUpdateView());m.observe(r),this.registerDisposer(()=>m.disconnect()),this.updateView()}adjustViaWheel(e){let{deltaY:t}=e;t!==0&&(this.hoverTarget.value=void 0,this.target.value*=2**Math.sign(t),e.preventDefault())}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){let{ctx:e}=this,{canvas:t}=this,r=t.width=t.offsetWidth,i=t.height=t.offsetHeight,a=this.target.value,o=this.hoverTarget.value;{let{legendRenderScale:E}=this,_=o===void 0?a:o[0],O=Qq(_);E.textContent=O+" px"}function l(E){return E*r/nn}e.clearRect(0,0,r,i);let{histogram:c}=this,{value:d,spatialScales:p}=c;c.visibility.visible||d.fill(0);let m=Array.from(p.keys());m.sort();let y=J.create(),v=1,b=p.size,x=0,C=0;for(let E=0;E<nn;++E){let _=0;for(let O=0;O<b;++O){let B=O*nn*2+E,W=d[B],V=d[B+nn];x+=W,C+=V,_+=W+V}v=Math.max(_,v)}let D=i/Math.log(1+v);function P(E){return i-Math.log(1+E)*D}let M;if(o!==void 0){let E=Math.floor(Ud(o[0]));if(E>=0&&E<nn){let _=0,O=o[1];for(let B=b-1;B>=0;--B){let W=m[B],V=p.get(W),U=2*V*nn+E,N=d[U]+d[U+nn];if(N===0)continue;let q=Math.round(P(_));if(_+=N,Math.round(P(_))<=O&&O<=q){M=W;break}}}}if(M!==void 0){x=0,C=0;let E=p.get(M),_=2*E*nn;for(let O=0;O<nn;++O){let B=_+O;x+=d[B],C+=d[B+nn]}Number.isFinite(M)?this.legendSpatialScale.textContent=_i(M,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${x}/${x+C}`;let I=m.map(E=>{let _=E===M?.5:1,O;Number.isFinite(E)?O=(Math.log2(E)*.1%1+1)%1:O=0,dl(y,O,_,1);let B=hn(y);dl(y,O,_,.5);let W=hn(y);return[B,W]});for(let E=0;E<nn;++E){let _=0;for(let O=b-1;O>=0;--O){let B=m[O],V=p.get(B)*nn*2+E,U=d[V],N=d[V+nn],q=U+N;if(q===0)continue;let ne=Math.round(l(E)),pe=Math.round(l(E+1)),me=Math.round(P(_));_+=q;let Pe=Math.round(P(_)),se=(U*Pe+N*me)/q;e.fillStyle=I[O][1],e.fillRect(ne,Pe,pe-ne,se-Pe),e.fillStyle=I[O][0],e.fillRect(ne,se,pe-ne,me-se)}}{let E=a;e.fillStyle="#fff";let _=l(Ud(E)),O=1;e.fillRect(Math.floor(_),0,O,i)}if(o!==void 0){let E=o[0];e.fillStyle="#888";let _=l(Ud(E)),O=1;e.fillRect(Math.floor(_),0,O,i)}}},Zq=Oe.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function hu(n){return{makeControl:(e,t)=>{let{histogram:r,target:i}=n(e),a=t.registerDisposer(new Yp(r,i));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(Zq),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)}),e.bindAction("reset",r=>{r.stopPropagation(),r.preventDefault(),t.reset()})}}}var FMe=at(A2());var Ml=at(ms()),R2=at(M2()),_2=at(It());(0,R2.default)(Ml.default);var eJ=500,ko=class extends j{constructor(e){super();this.state=e;this.changingValue=!1;this.debouncedValueUpdater=(0,_2.default)(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},eJ);this.textEditor=(0,Ml.default)(i=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));let{shaderControlState:t}=this.state;t!==void 0&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();let r=new IntersectionObserver(i=>{i.some(a=>a.isIntersecting)&&this.textEditor.refresh()},{root:document.body});r.observe(this.element),this.registerDisposer(()=>r.disconnect())}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){let{sourceStringNumber:e=1}=this.state,t=this.state.shaderError.value,r,{shaderControlState:i}=this.state;i!==void 0?r=i.parseErrors.value:r=[],t===void 0&&r.length===0?this.setValidState(void 0):t!=null||r.length!==0?(this.textEditor.setOption("lint",{getAnnotations:()=>{let a=[];for(let o of r)a.push({message:o.message,severity:"error",from:Ml.default.Pos(o.line)});if(t!=null)if(t.name==="ShaderCompilationError")for(let o of t.errorMessages)a.push({message:o.message,severity:"error",from:Ml.default.Pos(o.file===e&&o.line||0)});else t.name==="ShaderLinkError"?a.push({message:t.log,severity:"error",from:Ml.default.Pos(0)}):a.push({message:t.message,severity:"error",from:Ml.default.Pos(0)});return a}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let{element:t}=this;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),e===!0?t.classList.add("valid-input"):e===!1&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,Xe(this.element),this.textEditor=void 0,super.disposed()}};var Zw=at(It());var V2=Oe.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}}),ry=class extends j{constructor(e,t,r,i){super();this.element=e;this.dataType=t;this.getModel=r;this.setModel=i;e.title=V2.describe(),this.registerDisposer(new xn(e,V2)),ce(e,"set",a=>{let o=a.detail,l=this.getModel(),c=this.getTargetValue(o);if(c===void 0)return;let d=zs(l.window,l.range),p=kE(d,c),m=y=>{let v=this.getModel();this.setModel(Xp(v,"range",p,y))};m(c),bn(o,y=>{let v=this.getTargetValue(y);v!==void 0&&m(v)})}),ce(e,"adjust-window-via-drag",a=>{let o=a.detail,l=this.getTargetFraction(o),c=this.getWindowLerp(l),d=l<.5?0:1,p=m=>{let y=this.getModel();this.setModel(Xp(y,"window",d,m))};bn(o,m=>{let y=this.getModel().window,v=this.getTargetFraction(m);p(d===0?ga([c,y[1]],this.dataType,-v/(1-v)):ga([y[0],c],this.dataType,1/v))})}),ce(e,"zoom-via-wheel",a=>{let o=a.detail,l=Ll(o),c=this.getTargetFraction(o),{dataType:d}=this,p=this.getModel(),m=ga(p.window,d,c*(1-l)),y=ga(p.window,d,(1-c)*l+c);this.setModel({...p,window:[m,y],range:p.range})})}getTargetFraction(e){let t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return ga(this.getModel().window,this.dataType,e)}getTargetValue(e){let t=this.getTargetFraction(e);if(!!Number.isFinite(t))return this.getWindowLerp(t)}},O2=Symbol("histogramSamplerTexture");function Xp(n,e,t,r,i=!1){let a={...n},o=n[e];if(a[e]=[o[0],o[1]],a[e][t]=r,e==="window"&&Sr(r,o[1-t])*(2*t-1)<0&&(a[e][1-t]=r),e==="range"&&i){let l=[n.window[0],n.window[1]];for(let c=0;c<2;++c)Sr(r,l[c])*(2*c-1)>0&&(l[c]=r);a.window=l}return a}var tJ=254,Qp=tJ+1,N2=class extends yh{constructor(e){super(e.display,document.createElement("div"),e.visibility);this.parent=e;this.controller=this.registerDisposer(new ry(this.element,this.parent.dataType,()=>this.parent.trackable.value,e=>{this.parent.trackable.value=e}));this.dataValuesBuffer=this.registerDisposer(lo(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{let e=new Uint8Array(Qp*Si);for(let t=0;t<Qp;++t)for(let r=0;r<Si;++r)e[t*Si+r]=t;return e})).value;this.lineShader=this.registerDisposer((()=>{let e=new Zr(this.gl);return _n(e),e.addTextureSampler("sampler2D","uHistogramSampler",O2),e.addOutputBuffer("vec4","out_color",0),e.addAttribute("uint","aDataValue"),e.addUniform("float","uBoundsFraction"),e.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),e.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${Qp-1} ? cumSum : total;
if (dataValue == ${Qp-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),e.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),e.build()})());this.regionCornersBuffer=Yo(this.gl,0,-1,1,1);this.regionShader=this.registerDisposer((()=>{let e=new Zr(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addUniform("vec2","uBounds"),e.addUniform("vec4","uColor"),e.addOutputBuffer("vec4","out_color",0),e.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),e.setFragmentMain(`
out_color = uColor;
`),e.build()})());let{element:t}=this;t.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){let{lineShader:e,gl:t,regionShader:r,parent:{dataType:i,trackable:{value:a}}}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{r.bind(),t.uniform4f(r.uniform("uColor"),.2,.2,.2,1);let o=Or(a.window,a.range[0]),l=Or(a.window,a.range[1]),c=dc(i,a.window);t.uniform2f(r.uniform("uBounds"),Math.min(o,l)*c,Math.max(o,l)*c+(1-c));let d=r.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(d,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(d)}if(this.parent.histogramSpecifications.producerVisibility.visible){let{renderViewport:o}=this;e.bind(),On(e,{width:o.logicalWidth,height:o.logicalHeight},1);let l=e.textureUnit(O2);t.uniform1f(e.uniform("uBoundsFraction"),dc(i,a.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+l),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),co(t);let c=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(c,1,WebGL2RenderingContext.UNSIGNED_BYTE),Vn(t,Qp,1),t.disableVertexAttribArray(c),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}};function nJ(){}var B2=class extends yh{constructor(e){super(e.display,document.createElement("div"),e.visibility);this.parent=e;this.cornersBuffer=Yo(this.gl,-1,-1,1,1);let{element:t}=this;t.classList.add("neuroglancer-invlerp-legend-panel");let r=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=ei(this,this.gl,{...r,memoizeKey:{id:"colorLegendShader",base:r.memoizeKey},defineShader:(i,a,o)=>{i.addOutputBuffer("vec4","v4f_fragData0",0),i.addAttribute("vec2","aVertexPosition"),i.addUniform("float","uLegendOffset"),i.addVarying("float","vLinearPosition"),i.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);let l=this.parent.dataType,c=Vt(l);i.addFragmentCode(dD(i,"ng_colorLegendLerp",l)),i.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${c} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${c} getDataValue(int dummyChannel) {
  return getDataValue();
}
${c} getInterpolatedDataValue() {
  return getDataValue();
}
${c} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),r.defineShader(i,a,o)}})}drawIndirect(){let e=this.shaderGetter(nJ),{shader:t}=e;if(t===null)return;this.setGLLogicalViewport();let{gl:r}=this;r.clearColor(0,0,0,0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),r.enable(WebGL2RenderingContext.BLEND);let{trackable:{value:{window:i}},dataType:a}=this.parent;Cc(t,"ng_colorLegendLerp",this.parent.dataType,i);let o=LE(a,i);r.uniform1f(t.uniform("uLegendOffset"),Number.isFinite(o)?o:0),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),r.disable(WebGL2RenderingContext.DEPTH_TEST),r.disable(WebGL2RenderingContext.STENCIL_TEST);let l=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(l,2,WebGL2RenderingContext.FLOAT),r.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),r.disableVertexAttribArray(l)}isReady(){return!0}};function U2(n,e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-invlerp-widget-bound"),t.classList.add(`neuroglancer-invlerp-widget-${n}-bound`),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=n==="range"?`Data value that maps to ${e}`:`${e===0?"Lower":"Upper"} bound for distribution`,t}function F2(n,e,t){let r=document.createElement("div");r.classList.add("neuroglancer-invlerp-widget-bounds"),r.classList.add(`neuroglancer-invlerp-widget-${n}-bounds`);let i=[U2(n,0),U2(n,1)];for(let o=0;o<2;++o){let l=i[o];l.addEventListener("input",()=>{G2(l)}),l.addEventListener("change",()=>{let c=t.value,d=c[n];try{let p=to(e,l.value);t.value=Xp(c,n,o,p,!0)}catch{Yw(l,d[o])}})}let a;return r.appendChild(i[0]),r.appendChild(i[1]),n==="range"&&(a=[document.createElement("div"),document.createElement("div"),document.createElement("div")],a[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),r.insertBefore(a[0],i[0]),r.insertBefore(a[1],i[1]),r.appendChild(a[2])),{container:r,inputs:i,spacers:a}}function G2(n){Sn(n,Math.max(1,n.value.length+.1))}function Yw(n,e){let t;e instanceof X||Number.isInteger(e)?t=e.toString():t=e.toPrecision(6),n.value=t,G2(n)}function Xw(n){let e=n.value,{range:t}=e;n.value={...e,range:[t[1],t[0]]}}function W2(n,e,t){let r=e.value,i=ga(r.range,n,.5-t/2),a=ga(r.range,n,.5+t/2);e.value={...r,range:[i,a]}}function z2(n,e,t,r,i){let a=Math.exp(i),o=e.value,l=ga(t,n,.5-a/2+r),c=ga(t,n,.5+a/2+r);e.value={...o,range:[l,c]}}var Qw=class extends sn{constructor(e,t,r,i,a,o,l){super(e);this.display=t;this.dataType=r;this.trackable=i;this.histogramSpecifications=a;this.histogramIndex=o;this.legendShaderOptions=l;this.cdfPanel=this.registerDisposer(new N2(this));this.boundElements={range:F2("range",this.dataType,this.trackable),window:F2("window",this.dataType,this.trackable)};this.registerDisposer(a.visibility.add(this.visibility));let{element:c,boundElements:d}=this;if(l!==void 0){let m=this.registerDisposer(new B2(this));c.appendChild(m.element)}let p=m=>{let y=$e({svg:m,title:"Invert range",onClick:()=>{this.invertRange()}});return d.range.spacers[1].appendChild(y),y};this.invertArrows=[p(dm),p(um)],c.appendChild(d.range.container),c.appendChild(this.cdfPanel.element),c.classList.add("neuroglancer-invlerp-widget"),c.appendChild(d.window.container),this.updateView(),this.registerDisposer(i.changed.add(this.registerCancellable(Ge(()=>this.updateView()))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){Xw(this.trackable)}updateView(){let{boundElements:e}=this,{trackable:{value:t},dataType:r}=this;for(let m=0;m<2;++m)Yw(e.range.inputs[m],t.range[m]),Yw(e.window.inputs[m],t.window[m]);let i=Sr(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=i?"row-reverse":"row";let a=zs(t.window,t.range),o=e.range.spacers,l=dc(r,t.window),c=Or(t.window,a[i?1:0])*l,d=Or(t.window,a[i?0:1])*l+(1-l);o[i?2:0].style.width=`${c*100}%`,o[i?0:2].style.width=`${(1-d)*100}%`;let{invertArrows:p}=this;p[i?1:0].style.display="",p[i?0:1].style.display="none"}};var rJ=Oe.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function H2(n){return{makeControl:(e,t,r)=>{let{watchableValue:i,channelCoordinateSpaceCombiner:a,dataType:o,defaultChannel:l,histogramSpecifications:c,legendShaderOptions:d,histogramIndex:p}=n(e);if(a!==void 0&&l.length!==0){let y=t.registerDisposer(new Ji(a.combined)),v=t.registerDisposer(new hs(y,a,{copyButton:!1}));t.registerDisposer(y.changed.add(()=>{let x=y.value,C=Array.from(x,D=>Math.floor(D)),k=i.value;we(k.channel,C)||(i.value={...i.value,channel:C})}));let b=()=>{let x=y.value,C=i.value;we(x,C.channel)||(x.set(C.channel),y.changed.dispatch())};b(),t.registerDisposer(i.changed.add(b)),r.labelContainer.appendChild(v.element)}let m=t.registerDisposer(new Qw(r.visibility,r.display,o,i,c,p,l.length===0?d:void 0));return{control:m,controlElement:m.element}},activateTool:(e,t)=>{e.bindInputEventMap(rJ),e.bindAction("adjust-contrast-via-wheel",r=>{r.stopPropagation();let i=Ll(r.detail);W2(t.dataType,t.trackable,i)}),e.bindAction("adjust-via-drag",r=>{r.stopPropagation();let i=r.detail.screenX,a=r.detail.screenY,o=t.trackable.value.range,l=o,c=i,d=a;bn(r.detail,p=>{let m=t.trackable.value.range,y=p.screenX,v=p.screenY;ci(t.dataType,m,l)||(o=m,i=c,a=d),z2(t.dataType,t.trackable,o,(v-a)*2/screen.height,(y-i)*4/screen.width),l=t.trackable.value.range,c=y,d=v})}),e.bindAction("invert-range",r=>{r.stopPropagation(),Xw(t.trackable)})}}}var iJ=Oe.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function iy(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new Dl(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(iJ),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustHueViaWheel(r.detail)})}}}function $2(n,e){let{shaderControlState:t}=n,r=t.state.get(e);if(r===void 0)return;let{control:i}=r;switch(i.type){case"slider":return Zi(()=>({value:r.trackable,options:{min:i.min,max:i.max,step:i.step}}));case"color":return iy(()=>r.trackable);case"checkbox":return bs(()=>r.trackable);case"invlerp":{let a=0;for(let[o,{control:{type:l}}]of t.state){if(o===e)break;l==="invlerp"&&++a}return H2(()=>({dataType:i.dataType,defaultChannel:i.default.channel,watchableValue:r.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,histogramSpecifications:t.histogramSpecifications,histogramIndex:a,legendShaderOptions:n.legendShaderOptions}))}}}function j2(n,e,t){return{label:t,toolJson:aJ(t,e),makeControl:(r,i,a)=>{let o=n(r);return $2(o,t).makeControl(r,i,a)},activateTool:(r,i)=>{let a=n(r.tool.layer);return $2(a,t).activateTool(r,i)}}}var Lo=class extends sn{constructor(e,t,r,i={}){super(i.visibility);this.state=e;this.display=t;this.layer=r;this.options=i;this.controlDisposer=void 0;let{toolId:a=q2}=i;this.toolId=a;let{element:o}=this;o.style.display="contents";let{controls:l}=e;this.registerDisposer(l.changed.add(this.registerCancellable((0,Zw.default)(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){let{element:e}=this;this.controlDisposer!==void 0&&(this.controlDisposer.dispose(),_e(e));let t=this.controlDisposer=new j,r=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(let i of this.state.state.keys())e.appendChild(fu(t,this.layer,this.visibility,j2(r,this.toolId,i)))}disposed(){var e;(e=this.controlDisposer)==null||e.dispose(),super.disposed()}},q2="shaderControl",J2="control";function aJ(n,e){return{type:e,[J2]:n}}var K2=class extends ey{constructor(e,t,r,i){super(e,j2(()=>t,r,i));this.layerShaderControls=t;this.control=i;this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable((0,Zw.default)(()=>{t.shaderControlState.state.get(i)===void 0&&this.unbind()}))))}activate(e){let{shaderControlState:t}=this.layerShaderControls;t.state.get(this.control)!==void 0&&super.activate(e)}};function Cs(n,e,t=q2){xo(n,t,(r,i)=>{let a=G(i,J2,ee);return new K2(r,e(r),t,a)})}var e0="opacity",t0="blend",Y2="shader",X2="shaderControls",n0="crossSectionRenderScale",Q2="channelDimensions",r0="volumeRendering",oJ="volumeRenderScale",sJ=pu(Ti),ws=class extends sJ{constructor(e){super(e);this.opacity=Il(.5);this.blendMode=TV();this.fragmentMain=LV();this.shaderError=ya();this.dataType=new Re(void 0);this.sliceViewRenderScaleHistogram=new Pa;this.sliceViewRenderScaleTarget=Wi(1);this.volumeRenderingRenderScaleHistogram=new Pa;this.volumeRenderingRenderScaleTarget=Wi(1);this.channelCoordinateSpace=new js;this.channelCoordinateSpaceCombiner=new vc(this.channelCoordinateSpace,zE);this.channelSpace=this.registerDisposer(Pn(e=>jc(()=>JE(e)),this.channelCoordinateSpace));this.volumeRendering=new xt(!1,!1);this.shaderControlState=this.registerDisposer(new po(this.fragmentMain,this.registerDisposer(Qt((e,t)=>e===void 0?null:{imageData:{dataType:e,channelRank:t.rank}},[this.dataType,this.channelCoordinateSpace],(e,t)=>JSON.stringify(e)===JSON.stringify(t))),this.channelCoordinateSpaceCombiner));this.localCoordinateSpaceCombiner.includeDimensionPredicate=qo,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRendering.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new tO(this)}),this.tabs.default="rendering"}markLoading(){let e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){let t=super.addCoordinateSpace(e),r=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}activateDataSubsources(e){let t;for(let r of e){if(this.addStaticAnnotations(r))continue;let{subsourceEntry:i}=r,{subsource:a}=i,{volume:o}=a;if(!(o instanceof Gt)){r.deactivate("Not compatible with image layer");continue}if(t&&o.dataType!==t){r.deactivate(`Data type must be ${H[o.dataType].toLowerCase()}`);continue}t=o.dataType,r.activate(l=>{r.addRenderLayer(new Tw(o,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));let c=l.registerDisposer(new qw({multiscaleSource:o,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.volumeRenderingRenderScaleTarget,renderScaleHistogram:this.volumeRenderingRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));l.registerDisposer(r.messages.addChild(c.messages)),l.registerDisposer(Dn((d,p)=>{!p||d.registerDisposer(this.addRenderLayer(c.addRef()))},this.volumeRendering)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[e0]),le(e,t0,t=>this.blendMode.restoreState(t)),this.fragmentMain.restoreState(e[Y2]),this.shaderControlState.restoreState(e[X2]),this.sliceViewRenderScaleTarget.restoreState(e[n0]),this.channelCoordinateSpace.restoreState(e[Q2]),this.volumeRendering.restoreState(e[r0])}toJSON(){let e=super.toJSON();return e[e0]=this.opacity.toJSON(),e[t0]=this.blendMode.toJSON(),e[Y2]=this.fragmentMain.toJSON(),e[X2]=this.shaderControlState.toJSON(),e[n0]=this.sliceViewRenderScaleTarget.toJSON(),e[Q2]=this.channelCoordinateSpace.toJSON(),e[r0]=this.volumeRendering.toJSON(),e}displayImageSelectionState(e,t){let{value:r}=e;if(r==null)return!1;let i=this.channelSpace.value;if(i.error!==void 0)return!1;let{numChannels:a,coordinates:o,channelCoordinateSpace:{names:l,rank:c}}=i,d=document.createElement("div");d.classList.add("neuroglancer-selection-details-value-grid");let p="[copy] 0fr ";c!==0&&(p+=`repeat(${c}, [dim] 0fr [coord] 0fr) `),p+="[value] 1fr",d.style.gridTemplateColumns=p;for(let m=0;m<a;++m){let y=c===0?r:r[m],v=y==null?"":y.toString(),b=Jn({title:"Copy value",onClick:()=>{en(v)}});d.appendChild(b);for(let C=0;C<c;++C){let k=document.createElement("div");k.classList.add("neuroglancer-selection-details-value-grid-dim"),k.textContent=l[C],d.appendChild(k);let D=document.createElement("div");D.classList.add("neuroglancer-selection-details-value-grid-coord"),D.textContent=o[m*c+C].toString(),d.appendChild(D)}let x=document.createElement("div");x.classList.add("neuroglancer-selection-details-value-grid-value"),x.textContent=v,d.appendChild(x)}return t.appendChild(d),!0}displaySelectionState(e,t,r){let i=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,r)&&(i=!0),i}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),ww(e,t)},initializeShader:e=>{let t=e.shader;ti(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}};ws.type="image",ws.typeAbbreviation="img";function Z2(n){return new ko({shaderError:n.shaderError,fragmentMain:n.fragmentMain,shaderControlState:n.shaderControlState})}var eO=[{label:"Resolution (slice)",toolJson:n0,...hu(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))},{label:"Blending",toolJson:t0,...ny(n=>n.blendMode)},{label:"Volume rendering (experimental)",toolJson:r0,...bs(n=>n.volumeRendering)},{label:"Resolution (3d)",toolJson:oJ,isValid:n=>n.volumeRendering,...hu(n=>({histogram:n.volumeRenderingRenderScaleHistogram,target:n.volumeRenderingRenderScaleTarget}))},{label:"Opacity",toolJson:e0,...Zi(n=>({value:n.opacity}))}];for(let n of eO)ty(ws,n);var tO=class extends sn{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(Z2(this.layer));let{element:t}=this;t.classList.add("neuroglancer-image-dropdown");for(let a of eO)t.appendChild(fu(this,e,this.visibility,a));let r=document.createElement("div");r.style.flex="1";let i=document.createElement("div");i.className="neuroglancer-image-dropdown-top-row",i.appendChild(document.createTextNode("Shader")),i.appendChild(r),i.appendChild(xs({title:"Show larger editor view",onClick:()=>{new nO(this.layer)}})),i.appendChild(Ss({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(i),t.appendChild(this.registerDisposer(new Jw(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new Lo(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}},nO=class extends Xi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(Z2(this.layer));this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};Qi(ws);zg(dt.IMAGE,ws);gs(n=>{let{volume:e}=n;if(e!==void 0&&e.volumeType===dt.UNKNOWN)return{layerConstructor:ws,priority:-100}});Cs(ws,n=>({shaderControlState:n.shaderControlState,legendShaderOptions:n.getLegendShaderOptions()}));var lO=at(It());var lJ="DisjointUint64Sets",rO="DisjointUint64Sets.add",iO="DisjointUint64Sets.clear",aO="DisjointUint64Sets.highBitRepresentativeChanged",oO="DisjointUint64Sets.deleteSet",Wa=class extends oo{constructor(){super(...arguments);this.disjointSets=new Sl;this.changed=new ae}get value(){return this}static makeWithCounterpart(e,t){let r=new this;return r.disjointSets.visibleSegmentEquivalencePolicy=t,r.registerDisposer(t.changed.add(()=>{sO(r)})),r.initializeCounterpart(e),t.value&&sO(r),r}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(e,t){if(this.disjointSets.link(e,t)){let{rpc:r}=this;return r&&r.invoke(rO,{id:this.rpcId,al:e.low,ah:e.high,bl:t.low,bh:t.high}),this.changed.dispatch(),!0}return!1}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}has(e){return this.disjointSets.has(e)}get(e){return this.disjointSets.get(e)}clear(){if(this.disjointSets.clear()){let{rpc:e}=this;e&&e.invoke(iO,{id:this.rpcId}),this.changed.dispatch()}}setElements(e){return this.disjointSets.setElements(e)}deleteSet(e){if(this.disjointSets.deleteSet(e)){let{rpc:t}=this;t&&t.invoke(oO,{id:this.rpcId,l:e.low,h:e.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(e){if(e!==void 0){let t=[new X,new X];ye(e,r=>{ye(r,(i,a)=>{t[a%2].parseString(String(i),10),a!==0&&this.link(t[0],t[1])})})}}assignFrom(e){this.clear(),e instanceof Wa&&(e=e.disjointSets);for(let[t,r]of e)this.link(t,r)}};Wa=Lt([Jo(lJ)],Wa);var mu=new X,i0=new X;bt(rO,function(n){let e=this.get(n.id);mu.low=n.al,mu.high=n.ah,i0.low=n.bl,i0.high=n.bh,e.disjointSets.link(mu,i0)&&e.changed.dispatch()});bt(iO,function(n){let e=this.get(n.id);e.disjointSets.clear()&&e.changed.dispatch()});function sO(n){n.rpc.invoke(aO,{id:n.rpcId,value:n.disjointSets.visibleSegmentEquivalencePolicy.value})}bt(aO,function(n){let e=this.get(n.id);e.disjointSets.visibleSegmentEquivalencePolicy.value=n.value});bt(oO,function(n){let e=this.get(n.id);mu.low=n.l,mu.high=n.h,e.disjointSets.deleteSet(mu)&&e.changed.dispatch()});var a0=class extends Zs{constructor(){super(...arguments);this.spanningTreeEdges=new Map;this.equivalences=new Wa;this.connections=new Set;this.changed=new Me}link(e,t){this.equivalences.link(e,t);for(let r of this.connections)r.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(let t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(let t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(let e of this.connections)o0(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){let r=e.toString(),i=t.toString(),{spanningTreeEdges:a}=this,o=a.get(r);o===void 0&&(o=new Set,a.set(r,o));let l=a.get(i);l===void 0&&(l=new Set,a.set(i,l)),o.add(i),l.add(r)}removeSpanningTreeEdge(e,t){let r=e.toString(),i=t.toString(),{spanningTreeEdges:a}=this,o=a.get(r),l=a.get(i);o.delete(i),o.size===0&&a.delete(r),l.delete(r),l.size===0&&a.delete(i)}*getSpanningTreeNeighbors(e){let t=new X,r=this.spanningTreeEdges.get(e.toString());if(r!==void 0)for(let i of r)t.parseString(i),yield t}restoreState(e){let{equivalences:t,spanningTreeEdges:r}=this;if(t.clear(),r.clear(),e===void 0)return;let i=[new X,new X];ye(e,a=>{ye(a,(o,l)=>{i[l%2].parseString(String(o),10),l!==0&&t.link(i[0],i[1])&&this.addSpanningTreeEdge(i[0],i[1])})})}toJSON(){let{spanningTreeEdges:e}=this;if(e.size===0)return;let t=new Array;for(let[r,i]of e){let a=X.parseString(r);for(let o of i){let l=X.parseString(o);X.compare(a,l)>0||t.push([a,l])}}return t.sort((r,i)=>X.compare(r[0],i[0])||X.compare(r[1],i[1])),t.map(r=>r.map(i=>i.toString()))}get visibleSegmentEquivalencePolicy(){return qt.MIN_REPRESENTATIVE}async merge(e,t){let{equivalences:r}=this;return X.equal(r.get(e),r.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),r.get(e))}async split(e,t){let r=this.computeSplit(e,t);if(r===void 0)throw new Error("Segments are already split");let{includeBaseSegments:i,includeRepresentative:a,excludeBaseSegments:o,excludeRepresentative:l}=r,{equivalences:c}=this;this.deleteSet(e),this.linkAll(i),this.linkAll(o);let d=(y,v)=>{for(let b of y)for(let x of this.getSpanningTreeNeighbors(b))X.equal(c.get(x),v)||this.removeSpanningTreeEdge(b,x)},p=c.get(e),m=c.get(t);d(i,p),d(o,m);for(let y of this.connections){let{visibleSegments:v}=y.segmentsState;v.has(l)&&(v.delete(l),v.add(a))}return this.normalizeAll(),this.changed.dispatch(),{include:p,exclude:m}}trackSegment(e,t){return()=>{}}computeSplit(e,t){let{equivalences:r}=this,i=r.get(e);if(!X.equal(i,r.get(t)))return;let a=new Sl;for(let m of r.setElements(i))if(!X.equal(m,t))for(let y of this.getSpanningTreeNeighbors(m))X.equal(y,t)||a.link(m,y);let o=[],l=[],c=a.get(e),d=e,p=t;for(let m of r.setElements(i))X.equal(a.get(m),c)?(o.push(m),X.compare(m,d)<0&&(d=m)):(l.push(m),X.compare(m,p)<0&&(p=m));return o.sort(X.compare),l.sort(X.compare),{includeBaseSegments:o,includeRepresentative:d,excludeBaseSegments:l,excludeRepresentative:p}}connect(e){let t=new cO(this,e);return e.segmentEquivalences.assignFrom(this.equivalences),o0(e.visibleSegments,e.segmentEquivalences.disjointSets),t.registerDisposer(e.visibleSegments.changed.add(t.registerCancellable((0,lO.default)(()=>o0(e.visibleSegments,e.segmentEquivalences.disjointSets),0)))),this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}};function o0(n,e){let t=[];for(let r of n.unsafeKeys()){let i=e.get(r);X.equal(r,i)||(t.push(i),n.delete(r))}for(let r of t)n.add(r)}var cO=class extends el{computeSplit(e,t){return this.graph.computeSplit(e,t)}};var s0=class{constructor(e){this.disjointSets=e;this.generation=Number.NaN;this.hashMap=new Ic}update(){let{disjointSets:e}=this,{generation:t}=e;if(this.generation!==t){this.generation=t;let{hashMap:r}=this;r.clear();for(let[i,a]of e.mappings())r.set(i,a)}}},Zp=class extends qp{constructor(e,t){super(e,{shaderParameters:new id(r=>({hasEquivalences:r.registerDisposer(Qt(i=>i.size!==0,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:r.registerDisposer(Qt(i=>i.size!==0,[t.segmentStatedColors])),hasSegmentDefaultColor:r.registerDisposer(Qt(i=>i!==void 0,[t.segmentDefaultColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition});this.displayState=t;this.segmentationGroupState=this.displayState.segmentationGroupState.value;this.segmentColorShaderManager=new ib("segmentColorHash");this.segmentStatedColorShaderManager=new ob("segmentStatedColor");this.hashTableManager=new cm("visibleSegments");this.gpuHashTable=this.registerDisposer(ul.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable));this.gpuTemporaryHashTable=ul.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable);this.equivalencesShaderManager=new jd("equivalences");this.equivalencesHashMap=new s0(this.segmentationGroupState.segmentEquivalences.disjointSets);this.temporaryEquivalencesHashMap=new s0(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets);this.gpuEquivalencesHashTable=this.registerDisposer(ul.get(this.gl,this.equivalencesHashMap.hashMap));this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(ul.get(this.gl,this.temporaryEquivalencesHashMap.hashMap));this.registerDisposer(this.shaderParameters),wb(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){var e;(e=this.gpuSegmentStatedColorHashTable)==null||e.dispose()}getSources(e){return this.multiscaleSource.getSources({...e,discreteValues:!0})}defineShader(e,t){this.hashTableManager.defineShader(e);let r=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;r+=`return x;
}
`,e.addFragmentCode(r),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uShowAllSegments"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let i=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(i+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),i+=`
  bool has = uShowAllSegments != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if (uSelectedSegment == value.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let a=`vec3 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),a+=`
  vec3 rgb;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgb)) {
    return rgb;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec3","uSegmentDefaultColor"),a+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),a+=`  return segmentColorHash(value);
`),a+=`
}
`,e.addFragmentCode(a),i+=`
  vec3 rgb = getMappedIdColor(valueForColor);
  emit(vec4(mix(vec3(1.0,1.0,1.0), rgb, saturation), alpha));
`,e.setFragmentMain(i)}initializeShader(e,t,r){let{gl:i}=this,{displayState:a,segmentationGroupState:o}=this,{segmentSelectionState:l}=this.displayState,{segmentDefaultColor:{value:c},segmentColorHash:{value:d}}=this.displayState,p=HS(o),m=this.displayState.ignoreNullVisibleSet.value,y=0,v=0;if(l.hasSelectedSegment){let b=l.selectedSegment;y=b.low,v=b.high}if(i.uniform1f(t.uniform("uSelectedAlpha"),a.selectedAlpha.value),i.uniform1f(t.uniform("uSaturation"),a.saturation.value),i.uniform1f(t.uniform("uNotSelectedAlpha"),a.notSelectedAlpha.value),i.uniform2ui(t.uniform("uSelectedSegment"),y,v),i.uniform1ui(t.uniform("uShowAllSegments"),p.hashTable.size||!m?0:1),this.hashTableManager.enable(i,t,o.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),r.hasEquivalences){let b=o.useTemporarySegmentEquivalences.value;(b?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(i,t,b?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}if(c===void 0?this.segmentColorShaderManager.enable(i,t,d):i.uniform3fv(t.uniform("uSegmentDefaultColor"),c),r.hasSegmentStatedColors){let b=this.displayState.segmentStatedColors.value,{gpuSegmentStatedColorHashTable:x}=this;(x===void 0||x.hashTable!==b.hashTable)&&(x==null||x.dispose(),this.gpuSegmentStatedColorHashTable=x=ul.get(i,b.hashTable)),this.segmentStatedColorShaderManager.enable(i,t,x)}}endSlice(e,t,r){let{gl:i}=this;this.hashTableManager.disable(i,t),r.hasEquivalences&&this.equivalencesShaderManager.disable(i,t),r.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(i,t),super.endSlice(e,t,r)}};var ly=at(It()),mO=at(Cp());var ay="mergeSegments",oy="splitSegments",cJ=Oe.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),uJ=Oe.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),uO=class extends Yi{constructor(e){super(e);this.lastAnchorBaseSegment=new Re(void 0);let t=()=>{let r=e.anchorSegment.value;if(r===void 0)return;let{segmentSelectionState:i}=e.displayState;if(!i.hasSelectedSegment)return;let{segmentEquivalences:a}=e.displayState.segmentationGroupState.value,o=a.get(r);if(!X.equal(i.selectedSegment,o))return;let l=i.baseSelectedSegment,c=kc(l),d=a.disjointSets.visibleSegmentEquivalencePolicy.value;d&qt.NONREPRESENTATIVE_EXCLUDED&&c||d&qt.REPRESENTATIVE_EXCLUDED&&!c||(this.lastAnchorBaseSegment.value=l.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return ay}activate(e){let t=this.layer.displayState.segmentationGroupState.value,r=()=>{let d=this.layer.anchorSegment.value,p=this.lastAnchorBaseSegment.value;if(d===void 0)return{anchorSegment:void 0,error:"Select anchor segment for merge"};let m=t.segmentEquivalences.get(d);return t.visibleSegments.has(m)?p===void 0||!X.equal(t.segmentEquivalences.get(p),m)?{anchorSegment:d,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:p,error:void 0}:{anchorSegment:d,error:"Anchor segment must be in visible set"}},i=()=>{let{anchorSegment:d,error:p}=r();if(d===void 0||p!==void 0)return{anchorSegment:d,error:p,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:m}=this.layer,y=m.segmentSelectionState.baseValue;return y===void 0||X.equal(m.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(d))?{anchorSegment:d,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:d,otherSegment:y,error:void 0,anchorSegmentValid:!0}},{body:a,header:o}=Tl(e);o.textContent="Merge segments",a.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(cJ),e.registerDisposer(()=>{Yd(t)});let l=()=>{_e(a);let{displayState:d}=this.layer,{anchorSegment:p,otherSegment:m,anchorSegmentValid:y,error:v}=i(),b=C=>{let k=Xd(this.layer.displayState,C);return k.classList.add("neuroglancer-segment-list-entry-double-line"),k};if(p!==void 0&&a.appendChild(b(is(d,p))),v!==void 0){let C=document.createElement("span");C.textContent=v,a.appendChild(C)}if(m!==void 0){let C=document.createElement("span");C.textContent=" merge ",a.appendChild(C),a.appendChild(b(is(d,m)))}let{segmentEquivalences:x}=t;if(y){t.useTemporaryVisibleSegments.value=!0;let C=t.temporaryVisibleSegments;C.clear(),C.add(x.get(p)),m!==void 0&&C.add(x.get(m))}else{Yd(t);return}};l(),e.registerDisposer(as(this.layer.displayState,a));let c=e.registerCancellable(Ge(l));os(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(c)),e.bindAction("merge-segments",d=>{d.stopPropagation(),(async()=>{let{graph:{value:p}}=t;if(p===void 0)return;let{anchorSegment:m,otherSegment:y,error:v}=i();if(!(m===void 0||y===void 0||v!==void 0))try{await p.merge(m,y),Ce.showTemporaryMessage("Merge performed")}catch(b){Ce.showTemporaryMessage(`Merge failed: ${b}`)}})()}),e.bindAction("set-anchor",d=>{d.stopPropagation();let{segmentSelectionState:p}=this.layer.displayState,m=p.baseValue;if(m===void 0)return;let y=this.layer.anchorSegment.value;if(t.visibleSegments.add(m),y===void 0||!X.equal(y,m)){this.layer.anchorSegment.value=m.clone();return}})}get description(){return"merge"}},dO=class extends Yi{toJSON(){return oy}activate(e){let t=this.layer.displayState.segmentationGroupState.value,r=()=>{let p=this.layer.anchorSegment.value;if(p===void 0)return{anchorSegment:void 0,error:"Select anchor segment for split"};let m=t.segmentEquivalences.get(p);return t.visibleSegments.has(m)?{anchorSegment:p,error:void 0}:{anchorSegment:p,error:"Anchor segment must be in visible set"}},{body:i,header:a}=Tl(e);a.textContent="Split segments",i.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(uJ);let o=()=>{let{anchorSegment:p,error:m}=r();if(p===void 0||m!==void 0)return{anchorSegment:p,error:m,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:y}=this.layer,v=y.segmentSelectionState.baseValue;return v===void 0||!X.equal(y.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(p))||X.equal(v,p)?{anchorSegment:p,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:p,otherSegment:v,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{Yd(t)});let l=()=>{_e(i);let{displayState:p}=this.layer,{anchorSegment:m,otherSegment:y,anchorSegmentValid:v,error:b}=o(),x,C;(()=>{let{segmentEquivalences:P}=t,{graphConnection:M}=this.layer;if(!v||M===void 0){Yd(t);return}else{if(t.useTemporaryVisibleSegments.value=!0,y!==void 0){let E=M.computeSplit(m,y);if(E!==void 0){x=new ji(m,E.includeRepresentative),C=new ji(y,E.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;let _=E.includeRepresentative,O=E.excludeRepresentative,B=t.temporarySegmentEquivalences;B.clear();for(let V of E.includeBaseSegments)B.link(V,_);for(let V of E.excludeBaseSegments)B.link(V,O);let W=t.temporaryVisibleSegments;W.clear(),W.add(_),W.add(O);return}}t.useTemporarySegmentEquivalences.value=!1;let I=t.temporaryVisibleSegments;I.clear(),I.add(P.get(m))}})();let D=P=>{let M=Xd(this.layer.displayState,P);return M.classList.add("neuroglancer-segment-list-entry-double-line"),M};if(m!==void 0&&i.appendChild(D(x!=null?x:is(p,m))),b!==void 0){let P=document.createElement("span");P.textContent=b,i.appendChild(P)}if(C!==void 0){let P=document.createElement("span");P.textContent=" split ",i.appendChild(P),i.appendChild(D(C))}};e.registerDisposer(as(this.layer.displayState,i)),l();let c=e.registerCancellable(Ge(l));os(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c));let d=async p=>{let{graph:{value:m}}=t;if(m===void 0)return;let{anchorSegment:y,otherSegment:v,error:b}=o();if(!(y===void 0||v===void 0||b!==void 0))try{await m.split(y,v),p&&t.visibleSegments.add(t.segmentEquivalences.get(v)),Ce.showTemporaryMessage("Split performed")}catch(x){Ce.showTemporaryMessage(`Split failed: ${x}`)}};e.bindAction("split-segments",p=>{p.stopPropagation(),d(!1)}),e.bindAction("split-and-select-segments",p=>{p.stopPropagation(),d(!0)}),e.bindAction("set-anchor",p=>{p.stopPropagation();let{segmentSelectionState:m}=this.layer.displayState,y=m.baseValue;if(y===void 0)return;t.visibleSegments.add(y);let v=this.layer.anchorSegment.value;if(v===void 0||!X.equal(v,y)){this.layer.anchorSegment.value=y.clone();return}})}get description(){return"split"}};function pO(){xo(Tn,ay,n=>new uO(n)),xo(Tn,oy,n=>new dO(n))}var sy="selectSegments",l0="mousedown0",dJ=Oe.fromObject({[`at:alt?+shift?+${l0}`]:"drag-select-segments"}),Lr;(function(r){r[r.IDLE=0]="IDLE",r[r.SELECT=1]="SELECT",r[r.DESELECT=2]="DESELECT"})(Lr||(Lr={}));var fO=class extends Yi{constructor(e){super(e)}toJSON(){return sy}activate(e){let{layer:t}=this,{body:r,header:i}=Tl(e),a=0,o=!1;e.bindInputEventMap(dJ);let l=()=>Ep.value&Tt.ALT?2:1,c=y=>{a!==y&&(a=y,o=!1,d())},d=()=>{_e(r);let y=document.createElement("span");switch(a){case 0:i.textContent="Select/Deselect segments",y.textContent=`${l0} to select segments; alt+${l0} to deselect segments.`;break;case 1:case 2:i.textContent=`${a==1?"Select":"Deselect"} segments`,y.textContent=`Drag to ${a==1?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}r.appendChild(y)};d();let p=()=>{if(a==0)return;let{segmentSelectionState:y}=t.displayState;if(y.hasSelectedSegment){let v=y.selectedSegment,{visibleSegments:b}=t.displayState.segmentationGroupState.value;switch(a){case 1:b.add(v);break;case 2:b.delete(v);break}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add(()=>{o&&p()})),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(d)),e.registerDisposer(Ep.changed.add(()=>{a!=0&&c(l())}));let m=(y,v)=>{y.stopPropagation(),c(v),p();let b=y.detail.screenX,x=y.detail.screenY;bn(y.detail,(C,k,D)=>{if(!o){let P=C.screenX-b,M=C.screenY-x;P*P+M*M>25&&(p(),o=!0)}},C=>{o=!1,c(0)})};e.bindAction("drag-select-segments",y=>m(y,l()))}get description(){return"select"}};function hO(){xo(Tn,sy,n=>new fO(n))}var pJ=new X,gO=class extends j{constructor(e,t,r,i){super();this.query=e;this.segmentPropertyMap=t;this.segmentationDisplayState=r;this.parentElement=i;this.changed=new Me;this.explicitSegmentsVisible=!1;this.visibleSegmentsGeneration=-1;this.queryResult=new Re(void 0);this.statusText=new Re("");this.selectedMatches=0;this.matchStatusTextPrefix="";this.debouncedUpdate=(0,ly.default)(()=>this.update(),0);this.render=e=>{let{explicitSegments:t}=this,r,i=!1;if(t!==void 0&&e<t.length)r=t[e],i=this.explicitSegmentsVisible;else{t!==void 0&&(e-=t.length),r=pJ;let o=this.queryResult.value.indices[e],{ids:l}=this.segmentPropertyMap.segmentPropertyMap.inlineProperties;r.low=l[o*2],r.high=l[o*2+1]}let a=this.segmentWidgetFactory.get(r);return i&&(a.dataset.visibleList="true"),a};this.update(),this.registerDisposer(r.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){var e,t;return(t=(e=this.queryResult.value)==null?void 0:e.count)!=null?t:0}update(){var b;let e=this.query.value,{segmentPropertyMap:t}=this,r=this.queryResult.value,i;if(this.prevQuery===e)i=r;else{let x=pI(t,e);i=fI(t,x)}let a=[],o=!1,l="",{visibleSegments:c}=this.segmentationDisplayState.segmentationGroupState.value,d=c.changed.count,p=this.visibleSegmentsGeneration,m=vI(i.query);if(m){if(p!==d||this.explicitSegments===void 0||!this.explicitSegmentsVisible){this.visibleSegmentsGeneration=d;let x=Array.from(c,k=>k.clone());x.sort(X.compare);let{explicitSegments:C}=this;C===void 0?(this.explicitSegments=x,a.push({retainCount:0,insertCount:x.length,deleteCount:0})):a.push(...Bk(C,x,X.compare)),this.explicitSegments=x,o=!0}else a.push({retainCount:this.explicitSegments.length,deleteCount:0,insertCount:0});this.explicitSegmentsVisible=!0}else this.visibleSegmentsGeneration=d,this.explicitSegments!==void 0&&this.explicitSegmentsVisible&&(a.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,o=!0),this.explicitSegmentsVisible=!1;let{explicitIds:y}=i;if(y!==void 0?this.explicitSegments=y:this.explicitSegmentsVisible||(this.explicitSegments=void 0),r!==i&&(a.push({retainCount:0,deleteCount:(b=r==null?void 0:r.count)!=null?b:0,insertCount:i.count}),o=!0,this.queryResult.value=i),i.explicitIds!==void 0?l=`${i.count} ids`:m?l=`${i.count} listed ids`:i.total>0&&(l=`${i.count}/${i.total} matches`),r!==i||d!==p){let x=l,C=0;t!==void 0&&i.count>0&&(C=yI(t,i,c),x+=` (${C} visible)`),this.selectedMatches=C,this.statusText.value=x}this.prevQuery=e,this.matchStatusTextPrefix=l;let{explicitSegments:v}=this;this.length=(this.explicitSegmentsVisible?v.length:0)+i.count,o&&this.changed.dispatch(a)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem(t=>{this.updateRendering(t)})}},yO=Oe.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}}),fJ=100;function vO(n){Sn(n,Math.max(1,n.value.length+.1))}function c0(n,e){let t;if(Number.isInteger(e))t=e.toString();else{let r=e.toString(),i=e.toPrecision(6);t=r.length<i.length?r:i}n.value=t,vO(n)}function hJ(n,e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add(`neuroglancer-segment-query-result-numerical-plot-${n}-bound`),t.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=(e===0?"Lower":"Upper")+" bound "+(n==="range"?"range":"for distribution"),t.addEventListener("input",()=>{vO(t)}),t}function mJ(n,e,t){if(n===void 0||n.indices===void 0)return;let r=n.query,{sortBy:i,includeColumns:a}=r;Ym(r,t)?(i=i.filter(l=>l.fieldId!==t),a=a.filter(l=>l!==t)):a.push(t),e({...r,sortBy:i,includeColumns:a})}function SO(n,e,t){var d;let r=n==null?void 0:n.query,i=r==null?void 0:r.sortBy;if(i===void 0)return;let{includeColumns:a}=r,l=((d=i.find(p=>p.fieldId===t))==null?void 0:d.order)==="<"?">":"<",c=a.filter(p=>p!==t);for(let p of i)p.fieldId!=="id"&&p.fieldId!=="label"&&p.fieldId!==t&&c.push(p.fieldId);e({...r,sortBy:[{fieldId:t,order:l}],includeColumns:c})}function bO(n,e,t){var a,o;let r=(a=n==null?void 0:n.query)==null?void 0:a.sortBy,i=(o=r==null?void 0:r.find(l=>l.fieldId===t))==null?void 0:o.order;e.textContent=i===">"?"\u25BC":"\u25B2",e.style.visibility=i===void 0?"":"visible",e.title=`Sort by ${t} in ${i==="<"?"descending":"ascending"} order`}var xO=class extends j{constructor(e,t,r){super();this.segmentPropertyMap=e;this.queryResult=t;this.setQuery=r;this.propertyHistograms=[];this.bounds={window:new Re([]),range:new Re([])};this.throttledUpdate=this.registerCancellable((0,mO.default)(()=>this.updateHistograms(),100));this.debouncedRender=this.registerCancellable(Ge(()=>this.updateHistogramRenderings()));this.debouncedSetQuery=this.registerCancellable((0,ly.default)(()=>this.setQueryFromBounds(),200));let i=e==null?void 0:e.numericalProperties,a=[],o;if(i!==void 0&&i.length>0){o=document.createElement("details");let l=document.createElement("summary");l.textContent=`${i.length} numerical propert${i.length>1?"ies":"y"}`,o.appendChild(l),o.classList.add("neuroglancer-segment-query-result-numerical-list");let c=this.bounds.window.value;for(let d=0,p=i.length;d<p;++d){let m=i[d],y=this.makeNumericalPropertySummary(d,m);a.push(y),o.appendChild(y.element),c[d]=m.bounds}}this.listElement=o,this.properties=a,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){let e=this.queryResult.value;if(e===void 0||e.indices===void 0)return;let t=e.query,r=[],i=this.bounds.range.value,{properties:a}=this;for(let o=0,l=a.length;o<l;++o){let c=a[o].property;r.push({fieldId:c.id,bounds:i[o]})}this.setQuery({...t,numericalConstraints:r})}getBounds(e){let{bounds:t}=this;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){let{property:r}=this.properties[e],i=zs(r.bounds,t.range);Sr(i[0],i[1])>0&&(i=[i[1],i[0]]);let a=zs(r.bounds,t.window),o=this.getBounds(e),{dataType:l}=this.properties[e].property;ci(l,a,o.window)||(this.bounds.window.value[e]=a,this.bounds.window.changed.dispatch()),ci(l,i,o.range)||(this.bounds.range.value[e]=i,this.bounds.range.changed.dispatch())}setBound(e,t,r,i){let o=this.segmentPropertyMap.numericalProperties[r].bounds;i=Ws(o,i);let l=this.getBounds(r),c=Xp(l,e,t,i,!0);this.setBounds(r,c)}handleNewQueryResult(){let e=this.queryResult.value,{listElement:t}=this;if(t!==void 0){if((e==null?void 0:e.indices)!==void 0){let{numericalConstraints:r}=e.query,{numericalProperties:i}=this.segmentPropertyMap,a=this.bounds.range.value,o=r.length,l=i.length;a.length=l;for(let c=0;c<l;++c)a[c]=i[c].bounds;for(let c=0;c<o;++c){let d=r[c],p=i.findIndex(m=>m.id===d.fieldId);a[p]=d.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){let e=this.queryResult.value,{listElement:t}=this;t!==void 0&&(hI(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();let{listElement:e}=this;if(e===void 0)return;let{propertyHistograms:t}=this;if(t.length===0){e.style.display="none";return}e.style.display="";let{properties:r}=this;for(let i=0,a=r.length;i<a;++i)this.updateNumericalPropertySummary(i,r[i],t[i])}makeNumericalPropertySummary(e,t){let r=document.createElement("div");r.classList.add("neuroglancer-segment-query-result-numerical-plot-container");let i=document.createElement("img");i.classList.add("neuroglancer-segment-query-result-numerical-plot");let a=new ry(i,t.dataType,()=>this.getBounds(e),p=>this.setBounds(e,p)),o=document.createElement("span");o.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");let l=document.createElement("input");l.type="checkbox",l.addEventListener("click",()=>{mJ(this.queryResult.value,this.setQuery,t.id)});let c=p=>{let m=document.createElement("div");m.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),m.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${p}`);let y=x=>{let C=hJ(p,x);return C.addEventListener("change",()=>{if(this.bounds[p].value[e]!==void 0){try{let D=to(t.dataType,C.value);this.setBound(p,x,e,D),this.bounds[p].changed.dispatch()}catch{}c0(C,this.bounds[p].value[e][x])}}),C},v=[y(0),y(1)],b;if(p==="range"){b=[document.createElement("div"),document.createElement("div"),document.createElement("div")],b[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),b[1].appendChild(l);let x=document.createElement("span");x.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),x.appendChild(document.createTextNode(t.id)),x.appendChild(o),x.addEventListener("click",()=>{SO(this.queryResult.value,this.setQuery,t.id)}),b[1].appendChild(x);let{description:C}=t;C&&(b[1].title=C),m.appendChild(b[0]),m.appendChild(v[0]);let k=document.createElement("div");k.textContent="\u2264",k.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),m.appendChild(k),m.appendChild(b[1]);let D=document.createElement("div");D.textContent="\u2264",D.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),m.appendChild(D),m.appendChild(v[1]),m.appendChild(b[2])}else m.appendChild(v[0]),m.appendChild(v[1]);return{container:m,spacers:b,inputs:v}},d={range:c("range"),window:c("window")};return r.appendChild(d.range.container),r.appendChild(i),r.appendChild(d.window.container),{property:t,controller:a,element:r,plotImg:i,boundElements:d,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:l,sortIcon:o}}updateNumericalPropertySummary(e,t,r){let i=t.bounds.window,a=this.bounds.window.value[e],o=t.bounds.range,l=this.bounds.range.value[e],{property:c}=t,d=this.queryResult.value,p=Ym(d==null?void 0:d.query,c.id);if(t.columnCheckbox.checked=p,t.columnCheckbox.title=p?"Remove column from result table":"Add column to result table",bO(d,t.sortIcon,c.id),t.propertyHistogram===r&&ci(c.dataType,i,a)&&ci(c.dataType,o,l))return;let{histogram:m}=r,y="http://www.w3.org/2000/svg",v=document.createElementNS(y,"svg");v.setAttribute("width","1"),v.setAttribute("height","1"),v.setAttribute("preserveAspectRatio","none");let b=document.createElementNS(y,"rect"),x=Or(a,l[0]),C=Or(a,l[1]);b.setAttribute("x",`${x}`),b.setAttribute("y","0"),b.setAttribute("width",`${C-x}`),b.setAttribute("height","1"),b.setAttribute("fill","#4f4f4f"),v.appendChild(b);let k=m.length,D=(B,W,V)=>{let U=document.createElementNS(y,"polyline"),N="",q=0;for(let se=B;se<V;++se)q+=m[se];if(q===0)return;let ne=Or(a,r.window[0]),pe=Or(a,r.window[1]),me=(se,Te)=>{let Ae=se/(k-2);N+=` ${ne*(1-Ae)+pe*Ae},${1-Te}`};B!==0&&me(B,0);let Pe=0;for(let se=B;se<W;++se)Pe+=m[se],me(se,Pe/q);return U.setAttribute("fill","none"),U.setAttribute("stroke-width","1px"),U.setAttribute("points",N),U.setAttribute("vector-effect","non-scaling-stroke"),U};{let B=D(0,k-1,k);B!==void 0&&(B.setAttribute("stroke","cyan"),v.appendChild(B))}if(!ci(c.dataType,c.bounds,l)){let B=Math.floor(Math.max(0,Math.min(1,Or(r.window,l[0])))*(k-2)),W=Math.ceil(Math.max(0,Math.min(1,Or(r.window,l[1])))*(k-2)),V=D(B,W,W);V!==void 0&&(V.setAttribute("stroke","white"),v.appendChild(V))}let P=new XMLSerializer().serializeToString(v);t.plotImg.src=`data:image/svg+xml;base64,${btoa(P)}`,t.propertyHistogram=r;for(let B=0;B<2;++B)i[B]=a[B],c0(t.boundElements.window.inputs[B],a[B]),o[B]=l[B],c0(t.boundElements.range.inputs[B],l[B]);let M=t.boundElements.range.spacers,I=zs(a,l),E=dc(c.dataType,a),_=Or(a,I[0])*E,O=Or(a,I[1])*E+(1-E);M[0].style.width=`${_*100}%`,M[2].style.width=`${(1-O)*100}%`}};function gJ(n,e){let{tags:t}=n;if(t===void 0||t.length===0)return;let r=n.query,i=document.createElement("div");i.classList.add("neuroglancer-segment-query-result-tag-list");for(let{tag:a,count:o}of t){let l=document.createElement("div");l.classList.add("neuroglancer-segment-query-result-tag");let c=document.createElement("span");c.classList.add("neuroglancer-segment-query-result-tag-name"),c.textContent=a,i.appendChild(l);let d=r.includeTags.includes(a),p=r.excludeTags.includes(a),m;d?m="Remove tag from required set":p?m="Remove tag from excluded set":m="Add tag to required set",c.addEventListener("click",()=>{e(mx(r,a,!0,!d&&!p))}),c.title=m;let y=d||p,v=x=>{let C=x?o:n.count-o,k=document.createElement("div");if(k.classList.add("neuroglancer-segment-query-result-tag-toggle"),k.classList.add(`neuroglancer-segment-query-result-tag-${x?"include":"exclude"}`),l.appendChild(k),!y&&C===0)return;let D=x?d:p;k.appendChild(new lr({get value(){return D},set value(P){e(mx(r,a,x,P))},changed:Uf},{text:x?"+":"-",enableTitle:`Add tag to ${x?"required":"exclusion"} set`,disableTitle:`Remove tag from ${x?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};v(!0),v(!1),l.appendChild(c);let b=document.createElement("span");b.classList.add("neuroglancer-segment-query-result-tag-count"),y||(b.textContent=o.toString()),l.appendChild(b)}return i}var u0=class extends sn{constructor(e){super();this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new Kn(e.displayState.segmentationGroupState.value.graph,(c,d,p)=>{if(c===void 0)return;let m=document.createElement("div");m.className="neuroglancer-segmentation-toolbox",m.appendChild(Cg(p,e,{toolJson:ay,label:"Merge",title:"Merge segments"})),m.appendChild(Cg(p,e,{toolJson:oy,label:"Split",title:"Split segments"})),d.appendChild(m)})).element);let r=document.createElement("div");r.className="neuroglancer-segmentation-toolbox",r.appendChild(Cg(this,e,{toolJson:sy,label:"Select",title:"Select/Deselect segments"})),t.appendChild(r);let i=document.createElement("input");i.classList.add("neuroglancer-segment-list-query"),i.addEventListener("focus",()=>{i.select()});let a=this.registerDisposer(new zt(i,yO));a.allShortcutsAreGlobal=!0;let{segmentQuery:o}=this.layer.displayState,l=this.registerCancellable((0,ly.default)(()=>{o.value=i.value},200));i.autocomplete="off",i.title=yO.describe(),i.spellcheck=!1,i.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer(Rr(c=>{i.value=c},o)),this.registerDisposer(Rr(c=>{Date.now()-c<100&&(setTimeout(()=>{i.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(i),t.appendChild(this.registerDisposer(new Kn(e.displayState.segmentPropertyMap,(c,d,p)=>{let m=se=>{i.focus(),i.select();let Te=gI(c,se);document.execCommand("insertText",!1,Te),o.value=Te,i.select()},y=p.registerDisposer(new gO(o,c,e.displayState,d)),v=e.displayState.segmentationGroupState.value,b=document.createElement("ul");b.classList.add("neuroglancer-segment-query-errors"),d.appendChild(b);let x=document.createElement("div");x.classList.add("neuroglancer-segment-query-result-statistics");let C=document.createElement("span"),k=document.createElement("input");k.type="checkbox",k.checked=!0,k.title="Deselect all segment IDs",k.addEventListener("change",()=>{v.visibleSegments.clear()});let D=Jn({title:"Copy visible segment IDs",onClick:()=>{let se=Array.from(v.visibleSegments,Te=>Te.clone());se.sort(X.compare),en(se.join(", "))}}),P=document.createElement("span");C.appendChild(D),C.appendChild(k),C.appendChild(P);let M=document.createElement("span"),I=document.createElement("input"),E=Jn({onClick:()=>{l(),l.flush(),y.debouncedUpdate.flush();let se=y.queryResult.value;if(se===void 0)return;let Te=new Array(se.count);mp(c,se,(Ae,Be)=>{Te[Be]=Ae.toString()}),en(Te.join(", "))}});I.type="checkbox";let _=()=>{l(),l.flush(),y.debouncedUpdate.flush();let se=y.queryResult.value;if(se===void 0)return;let{visibleSegments:Te}=v,{selectedMatches:Ae}=y,Be=Ae!==se.count;if(Be&&se.count-Ae>fJ){if(!U)return U=!0,O.textContent=`Confirm: show ${se.count-Ae} segments?`,!1;U=!1,V()}return mp(c,se,Ze=>{Te.set(Ze,Be)}),!0};I.addEventListener("click",se=>{_()||se.preventDefault()});let O=document.createElement("span");M.appendChild(E),M.appendChild(I),M.appendChild(O),C.classList.add("neuroglancer-segment-list-status"),M.classList.add("neuroglancer-segment-list-status"),d.appendChild(x);let B=document.createElement("div");B.classList.add("neuroglancer-segment-query-result-statistics-separator"),d.appendChild(B),d.appendChild(M),d.appendChild(C);let W=-1,V=()=>{let se=v.visibleSegments.size;W!==se&&(W=se,P.textContent=`${se} visible in total`,k.checked=se>0,k.style.visibility=se?"visible":"hidden",D.style.visibility=se?"visible":"hidden"),O.textContent=y.statusText.value;let{numMatches:Te,selectedMatches:Ae}=y;E.style.visibility=Te?"visible":"hidden",E.title=`Copy ${Te} segment ID(s)`,I.style.visibility=Te?"visible":"hidden",Ae===0?(I.checked=!1,I.indeterminate=!1,I.title=`Show ${Te} segment ID(s)`):Ae===Te?(I.checked=!0,I.indeterminate=!1,I.title=`Hide ${Ae} segment ID(s)`):(I.checked=!0,I.indeterminate=!0,I.title=`Show ${Te-Ae} segment ID(s)`)};V(),y.statusText.changed.add(V),p.registerDisposer(v.visibleSegments.changed.add(V));let U=!1;p.registerEventListener(i,"input",()=>{l(),U&&(U=!1,V())}),p.registerDisposer(ce(i,"cancel",()=>{i.focus(),i.select(),document.execCommand("delete"),i.blur(),i.value="",o.value="",U=!1,V()})),p.registerDisposer(ce(i,"toggle-listed",_)),p.registerDisposer(ce(i,"hide-all",()=>{v.visibleSegments.clear()})),p.registerDisposer(ce(i,"hide-listed",()=>{l(),l.flush(),y.debouncedUpdate.flush();let{visibleSegments:se}=v;if(o.value==="")se.clear();else{let Te=y.queryResult.value;if(Te===void 0)return;mp(c,Te,Ae=>{se.delete(Ae)})}}));let N=p.registerDisposer(new wl({source:y,horizontalScroll:!0})),q=p.registerCancellable(Ge(()=>{y.updateRenderedItems(N)})),{displayState:ne}=this.layer;p.registerDisposer(ne.segmentSelectionState.changed.add(q)),p.registerDisposer(v.visibleSegments.changed.add(q)),p.registerDisposer(ne.segmentColorHash.changed.add(q)),p.registerDisposer(ne.segmentStatedColors.changed.add(q)),p.registerDisposer(ne.segmentDefaultColor.changed.add(q)),N.element.classList.add("neuroglancer-segment-list"),p.registerDisposer(e.bindSegmentListWidth(N.element)),p.registerDisposer(new xn(N.element,Rc()));let pe=p.registerDisposer(new xO(c,y.queryResult,m));{let{listElement:se}=pe;se!==void 0&&x.appendChild(se)}let me,Pe=se=>{let Te=se==null?void 0:se.errors;if(_e(b),Te!==void 0)for(let Ae of Te){let Be=document.createElement("li");Be.textContent=Ae.message,b.appendChild(Be)}};Rr(se=>{if(y.segmentWidgetFactory=new Cb(y.segmentationDisplayState,y.parentElement,Ae=>Ym(se==null?void 0:se.query,Ae.id)),N.scrollToTop(),_e(N.header),c!==void 0){let Ae=y.segmentWidgetFactory.getHeader();Ae.container.classList.add("neuroglancer-segment-list-header");for(let Be of Ae.propertyLabels){let{label:Ze,sortIcon:ge,id:Le}=Be;Ze.addEventListener("click",()=>{SO(y.queryResult.value,m,Le)}),bO(se,ge,Le)}N.header.appendChild(Ae.container)}if(Pe(se),B.style.display="none",me==null||me.remove(),se===void 0)return;let{query:Te}=se;Te.errors!==void 0||Te.ids!==void 0||(me=gJ(se,m),me!==void 0&&x.appendChild(me),(pe.properties.length>0||me!==void 0)&&(B.style.display=""))},y.queryResult),d.appendChild(N.element)})).element)}};var CO=at(It());var cy=class extends j{constructor(e){super();this.group=e;this.element=document.createElement("div");this.topRow=document.createElement("div");this.label=document.createElement("label");this.selectElement=document.createElement("select");this.linkedLayers=document.createElement("div");this.unlinkButton=document.createElement("button");let{element:t,label:r,topRow:i,selectElement:a,linkedLayers:o,unlinkButton:l}=this;i.appendChild(r),i.appendChild(a),i.appendChild(l),l.textContent="Unlink",l.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(i),t.appendChild(o),this.updateView();let c=(0,CO.default)(()=>this.updateView(),0);this.registerEventListener(a,"change",()=>{this.updateModel(),c()}),this.registerDisposer(this.group.changed.add(c)),this.registerDisposer(this.group.linkedLayersChanged.add(c)),this.registerDisposer(this.group.layerManager.layersChanged.add(c))}updateModel(){let e=this.selectElement.value;e===""&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){var l;let{selectElement:e,group:t}=this,{predicate:r}=t;_e(e);let i=this.group.rootGroup.linkedLayers.size!==0;this.unlinkButton.style.display=i?"":"none";let{linkedLayers:a}=this,o=t.linkedLayers.size!==0;if(a.style.display=o?"":"none",this.unlinkButton.textContent=o?"Unlink all":"Unlink",o){this.element.style.display="",e.style.display="none",_e(a);for(let c of t.linkedLayers){let d=document.createElement("div");d.classList.add("neuroglancer-linked-layer-widget-layer");let p=Vc({title:"Unlink layer",onClick:()=>{this.group.getGroup(c).isolate()}});d.appendChild(p),d.appendChild(document.createTextNode(c.managedLayer.name)),a.appendChild(d)}}else{e.style.display="";let c=document.createElement("option");e.appendChild(c);let d=0;for(let p of this.group.layerManager.managedLayers){let m=p.layer;if(m!==null&&m!==t.layer&&r(m)){++d;let y=document.createElement("option"),{name:v}=p;y.textContent=v,y.value=v,e.appendChild(y)}}e.value=(l=t.toJSON())!=null?l:"",this.element.style.display=d===0?"none":""}}};function wO(n){return new ko({fragmentMain:n.displayState.skeletonRenderingOptions.shader,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState})}var d0=class extends sn{constructor(e){super();this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segmentation-rendering-tab");{let i=this.registerDisposer(new cy(e.displayState.linkedSegmentationGroup));i.label.textContent="Linked to: ",t.appendChild(i.element)}{let i=this.registerDisposer(new cy(e.displayState.linkedSegmentationColorGroup));i.label.textContent="Colors linked to: ",t.appendChild(i.element)}for(let i of f0)t.appendChild(fu(this,e,this.visibility,i));let r=this.registerDisposer(new Kn(e.hasSkeletonsLayer,(i,a,o)=>{if(!i)return;let l=document.createElement("div");l.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let c=document.createElement("div");c.style.flex="1",c.textContent="Skeleton shader:",l.appendChild(c),l.appendChild(xs({title:"Show larger editor view",onClick:()=>{new TO(this.layer)}})),l.appendChild(Ss({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),a.appendChild(l);let d=o.registerDisposer(wO(this.layer));a.appendChild(d.element),a.appendChild(o.registerDisposer(new Lo(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:p0})).element),d.textEditor.refresh()},this.visibility));t.appendChild(r.element)}},TO=class extends Xi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(wO(this.layer));this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};var Rl=class extends oo{constructor(){super(...arguments);this.hashTable=new Ic;this.changed=new Me}get value(){return this}static makeWithCounterpart(e){let t=new Rl;return t.initializeCounterpart(e),t}set_(e,t){return this.hashTable.set(e,t)}set(e,t){if(this.set_(e,t)){let{rpc:r}=this;r&&r.invoke("Uint64Map.set",{id:this.rpcId,key:e,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}get(e,t){return this.hashTable.get(e,t)}[Symbol.iterator](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Map.delete",{id:this.rpcId,key:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}assignFrom(e){this.clear();for(let[t,r]of e.unsafeEntries())this.set(t,r)}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e={};for(let[t,r]of this.hashTable.unsafeEntries())e[t.toString()]=r.toString();return e}};Rl=Lt([Jo("Uint64Map")],Rl);bt("Uint64Map.set",function(n){let e=this.get(n.id);e.set_(n.key,n.value)&&e.changed.dispatch()});bt("Uint64Map.delete",function(n){let e=this.get(n.id);e.delete_(n.key)&&e.changed.dispatch()});bt("Uint64Map.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});var Ts=class extends oo{constructor(){super(...arguments);this.hashTable=new sm;this.changed=new Me}get value(){return this}static makeWithCounterpart(e){let t=new Ts;return t.initializeCounterpart(e),t}set(e,t){t?this.add(e):this.delete(e)}reserve_(e){return this.hashTable.reserve(e)}reserve(e){if(this.reserve_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.reserve",{id:this.rpcId,value:e})}}add_(e){let t=!1;for(let r of e)t=this.hashTable.add(r)||t;return t}add(e){let t=Array().concat(e);if(this.add_(t)){let{rpc:r}=this;r&&r.invoke("Uint64Set.add",{id:this.rpcId,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}[Symbol.iterator](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(e){let t=!1;for(let r of e)t=this.hashTable.delete(r)||t;return t}delete(e){let t=Array().concat(e);if(this.delete_(Array().concat(e))){let{rpc:r}=this;r&&r.invoke("Uint64Set.delete",{id:this.rpcId,value:t}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e=new Array;for(let t of this.unsafeKeys())e.push(t.toString());return e.sort(),e}assignFrom(e){this.clear();for(let t of e.unsafeKeys())this.add(t)}};Ts=Lt([Jo("Uint64Set")],Ts);bt("Uint64Set.reserve",function(n){let e=this.get(n.id);e.reserve_(n.value)&&e.changed.dispatch()});bt("Uint64Set.add",function(n){let e=this.get(n.id);e.add_(n.value)&&e.changed.dispatch()});bt("Uint64Set.delete",function(n){let e=this.get(n.id);e.delete_(n.value)&&e.changed.dispatch()});bt("Uint64Set.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});var kO='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="rotateIconTitle"><path d="M22 12l-3 3-3-3"></path><path d="M2 12l3-3 3 3"></path><path d="M19.016 14v-1.95A7.05 7.05 0 0 0 8 6.22"></path><path d="M16.016 17.845A7.05 7.05 0 0 1 5 12.015V10"></path><path stroke-linecap="round" d="M5 10V9"></path><path stroke-linecap="round" d="M19 15v-1"></path></svg>';function uy(n,e){e?n.displayState.segmentDefaultColor.value=J.fromValues(1,0,0):n.displayState.segmentDefaultColor.value=void 0}function LO(){let n=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(e,t,{labelTextContainer:r})=>{let i=document.createElement("input");i.type="radio",i.addEventListener("change",()=>{uy(e,!i.checked)}),r.prepend(i);let a=document.createElement("div");a.classList.add("neuroglancer-segmentation-color-seed-control");let o=t.registerDisposer(new jp(e.displayState.segmentColorHash));a.appendChild(o.element);let l=$e({svg:kO,title:"Randomize",onClick:()=>n(e)});return a.appendChild(l),t.registerDisposer(Rr(c=>{let d=c===void 0;a.style.visibility=d?"":"hidden",i.checked=d},e.displayState.segmentDefaultColor)),{controlElement:a,control:o}},activateTool:e=>{let{layer:t}=e.tool;uy(t,!1),n(t)}}}function EO(){let n=iy(e=>e.displayState.segmentDefaultColor);return{...n,makeControl:(e,t,r)=>{let i=n.makeControl(e,t,r),{controlElement:a}=i,o=document.createElement("input");return o.type="radio",o.addEventListener("change",()=>{uy(e,o.checked),o.checked&&a.click()}),r.labelTextContainer.prepend(o),t.registerDisposer(Rr(l=>{let c=l!==void 0;a.style.visibility=c?"":"hidden",o.checked=c},e.displayState.segmentDefaultColor)),i},activateTool:(e,t)=>{uy(e.tool.layer,!0),n.activateTool(e,t)}}}var h0="selectedAlpha",m0="notSelectedAlpha",g0="objectAlpha",y0="saturation",v0="hideSegmentZero",S0="baseSegmentColoring",b0="ignoreNullVisibleSet",yJ="mesh",vJ="skeletons",PO="segments",dy="equivalences",x0="colorSeed",DO="segmentColors",C0="meshRenderScale",w0="crossSectionRenderScale",py="skeletonRendering",SJ="skeletonShader",AO="segmentQuery",T0="meshSilhouetteRendering",IO="linkedSegmentationGroup",MO="linkedSegmentationColorGroup",k0="segmentDefaultColor",RO="anchorSegment",p0="skeletonShaderControl",_O=class extends j{constructor(e){super();this.layer=e;this.specificationChanged=new Me;this.localGraph=new a0;this.visibleSegments=this.registerDisposer(Ts.makeWithCounterpart(this.layer.manager.rpc));this.segmentPropertyMap=new Re(void 0);this.graph=new Re(void 0);this.segmentEquivalences=this.registerDisposer(Wa.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer(Qt(e=>e&&e.visibleSegmentEquivalencePolicy||qt.MIN_REPRESENTATIVE,[this.graph]))));this.localSegmentEquivalences=!1;this.maxIdLength=new Re(1);this.hideSegmentZero=new xt(!0,!0);this.segmentQuery=new ht("",ee);this.temporaryVisibleSegments=this.layer.registerDisposer(Ts.makeWithCounterpart(this.layer.manager.rpc));this.temporarySegmentEquivalences=this.layer.registerDisposer(Wa.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy));this.useTemporaryVisibleSegments=this.layer.registerDisposer(gt.make(this.layer.manager.rpc,!1));this.useTemporarySegmentEquivalences=this.layer.registerDisposer(gt.make(this.layer.manager.rpc,!1));let{specificationChanged:t}=this;this.visibleSegments.changed.add(t.dispatch),this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch)}restoreState(e){le(e,v0,t=>this.hideSegmentZero.restoreState(t)),le(e,dy,t=>{this.localGraph.restoreState(t)}),le(e,PO,t=>{let{segmentEquivalences:r,visibleSegments:i}=this;ye(t,a=>{let o=X.parseString(String(a),10);i.add(r.get(o))})}),le(e,AO,t=>this.segmentQuery.restoreState(t))}toJSON(){let e={};e[v0]=this.hideSegmentZero.toJSON();let{visibleSegments:t}=this;t.size>0&&(e[PO]=t.toJSON());let{segmentEquivalences:r}=this;return this.localSegmentEquivalences&&r.size>0&&(e[dy]=r.toJSON()),e[AO]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}},VO=class extends j{constructor(e){super();this.layer=e;this.specificationChanged=new Me;this.segmentColorHash=qd.getDefault();this.segmentStatedColors=this.registerDisposer(new Rl);this.segmentDefaultColor=new Nv;let{specificationChanged:t}=this;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch)}restoreState(e){le(e,x0,t=>this.segmentColorHash.restoreState(t)),le(e,k0,t=>this.segmentDefaultColor.restoreState(t)),le(e,DO,t=>{let r=eo(t,i=>ha(String(i)));for(let[i,a]of r){let o=X.parseString(String(i)),l=new X(ud(a));this.segmentStatedColors.set(o,l)}})}toJSON(){let e={};e[x0]=this.segmentColorHash.toJSON(),e[k0]=this.segmentDefaultColor.toJSON();let{segmentStatedColors:t}=this;if(t.size>0){let r=e[DO]={};for(let[i,a]of t.unsafeEntries())r[i.toString()]=hn(Za(a.low))}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.segmentDefaultColor.value=e.segmentDefaultColor.value}},L0=class extends j{constructor(e,t){super();this.linkedGroup=e;this.propertyName=t;this.value}get changed(){return this.linkedGroup.root.changed}get value(){let e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;let t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){let{curGroupState:r}=this;r!==void 0&&(t.assignFrom(r),r.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){var e;(e=this.curGroupState)==null||e.dispose()}},OO=class{constructor(e){this.layer=e;this.segmentSelectionState=new Sb;this.selectedAlpha=Il(.5);this.saturation=Il(1);this.notSelectedAlpha=Il(0);this.silhouetteRendering=new ht(0,th,0);this.objectAlpha=Il(1);this.ignoreNullVisibleSet=new xt(!0,!0);this.skeletonRenderingOptions=new Ib;this.shaderError=ya();this.renderScaleHistogram=new Pa;this.renderScaleTarget=Wi(1);this.selectSegment=this.layer.selectSegment;this.transparentPickEnabled=this.layer.pick;this.baseSegmentColoring=new xt(!1,!1);this.filterBySegmentLabel=this.layer.filterBySegmentLabel;this.moveToSegment=e=>{this.layer.moveToSegment(e)};this.linkedSegmentationGroup=this.layer.registerDisposer(new Wg(this.layer.manager.rootLayers,this.layer,e=>e instanceof Tn,e=>e.displayState.linkedSegmentationGroup));this.linkedSegmentationColorGroup=this.layer.registerDisposer(new Wg(this.layer.manager.rootLayers,this.layer,e=>e instanceof Tn,e=>e.displayState.linkedSegmentationColorGroup));this.originalSegmentationGroupState=this.layer.registerDisposer(new _O(this.layer));this.originalSegmentationColorGroupState=this.layer.registerDisposer(new VO(this.layer));e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new L0(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new L0(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new sc(this.segmentationGroupState,t=>t.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new ad(this.segmentationColorGroupState,t=>t.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new ad(this.segmentationColorGroupState,t=>t.segmentStatedColors)),this.segmentDefaultColor=this.layer.registerDisposer(new ad(this.segmentationColorGroupState,t=>t.segmentDefaultColor)),this.segmentQuery=this.layer.registerDisposer(new sc(this.segmentationGroupState,t=>t.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new sc(this.segmentationGroupState,t=>t.segmentPropertyMap))}},bJ=pu(Ti),Tn=class extends bJ{constructor(e){super(e);this.sliceViewRenderScaleHistogram=new Pa;this.sliceViewRenderScaleTarget=Wi(1);this.segmentQueryFocusTime=new Re(Number.NEGATIVE_INFINITY);this.selectSegment=(e,t)=>{this.manager.root.selectionState.captureSingleLayerState(this,r=>(r.value=e.clone(),!0),t)};this.filterBySegmentLabel=e=>{let t=is(this.displayState,e),{label:r}=t;!r||this.filterSegments(r)};this.filterSegments=e=>{this.displayState.segmentationGroupState.value.segmentQuery.value=e,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer};this.displayState=new OO(this);this.anchorSegment=new ht(void 0,e=>e===void 0?void 0:X.parseString(e));this.has2dLayer=this.registerDisposer(Pn(e=>e.some(t=>t instanceof Zp),{changed:this.layersChanged,value:this.renderLayers}));this.has3dLayer=this.registerDisposer(Pn(e=>e.some(t=>t instanceof Sm||t instanceof ep||t instanceof ip||t instanceof Cm),{changed:this.layersChanged,value:this.renderLayers}));this.hasSkeletonsLayer=this.registerDisposer(Pn(e=>e.some(t=>t instanceof ip),{changed:this.layersChanged,value:this.renderLayers}));this.registerDisposer(Qa((t,r)=>{t.registerDisposer(r.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer(Qa((t,r)=>{t.registerDisposer(r.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new d0(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new u0(this)}),this.tabs.default="rendering"}bindSegmentListWidth(e){return as(this.displayState,e)}get volumeOptions(){return{volumeType:dt.SEGMENTATION}}activateDataSubsources(e){let t=[],r=this.displayState.linkedSegmentationGroup.root.value===this,i;for(let a of e){if(this.addStaticAnnotations(a))continue;let{volume:o,mesh:l,segmentPropertyMap:c,segmentationGraph:d,local:p}=a.subsourceEntry.subsource;if(o instanceof Gt){switch(o.dataType){case H.FLOAT32:a.deactivate("Data type not compatible with segmentation layer");continue}a.activate(()=>a.addRenderLayer(new Zp(o,{...this.displayState,transform:a.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition})),this.displayState.segmentationGroupState.value)}else l!==void 0?a.activate(()=>{let m={...this.displayState,transform:a.getRenderLayerTransform()};if(l instanceof kr)a.addRenderLayer(new Sm(this.manager.chunkManager,l,m));else if(l instanceof go)a.addRenderLayer(new ep(this.manager.chunkManager,l,m));else{let y=new Mb(this.manager.chunkManager,l,m);a.addRenderLayer(new ip(y.addRef())),a.addRenderLayer(new Cm(y))}},this.displayState.segmentationGroupState.value):c!==void 0?r?(a.activate(()=>{}),t.push(c)):a.deactivate("Not supported on non-root linked segmentation layers"):d!==void 0?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=d,a.activate(m=>{this.graphConnection=m.registerDisposer(d.connect(this.displayState.segmentationGroupState.value));let y={...this.displayState,transform:a.getRenderLayerTransform()},v=this.graphConnection.createRenderLayers(this.manager.chunkManager,y,this.localPosition);for(let b of v)a.addRenderLayer(b)})):a.deactivate("Not supported on non-root linked segmentation layers"):p===fi.equivalences?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=this.displayState.originalSegmentationGroupState.localGraph,a.activate(m=>{this.graphConnection=m.registerDisposer(i.connect(this.displayState.segmentationGroupState.value)),m.registerDisposer(()=>{this.graphConnection=void 0})})):a.deactivate("Not supported on non-root linked segmentation layers"):a.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=dI(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=i}getLegacyDataSourceSpecifications(e,t,r,i){let a=super.getLegacyDataSourceSpecifications(e,t,r,i),o=le(t,yJ,c=>c===null?null:ee(c)),l=le(t,vJ,c=>c===null?null:ee(c));if(o!==void 0||l!==void 0)for(let c of a)c.enableDefaultSubsources=!1,c.subsources=new Map([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return o!=null&&a.push(bl(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:o,type:"mesh"}))),l!=null&&a.push(bl(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:l,type:"skeletons"}))),t[dy]!==void 0&&i.find(c=>c.url===Xh)===void 0&&a.push({url:Xh,enableDefaultSubsources:!0,transform:{outputSpace:Vi,sourceRank:0,transform:void 0,inputSpace:Vi},subsources:new Map}),a}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[h0]),this.displayState.saturation.restoreState(e[y0]),this.displayState.notSelectedAlpha.restoreState(e[m0]),this.displayState.objectAlpha.restoreState(e[g0]),this.displayState.baseSegmentColoring.restoreState(e[S0]),this.displayState.silhouetteRendering.restoreState(e[T0]),this.displayState.ignoreNullVisibleSet.restoreState(e[b0]);let{skeletonRenderingOptions:t}=this.displayState;t.restoreState(e[py]);let r=e[SJ];r!==void 0&&t.shader.restoreState(r),this.displayState.renderScaleTarget.restoreState(e[C0]),this.anchorSegment.restoreState(e[RO]),this.sliceViewRenderScaleTarget.restoreState(e[w0]);let i=le(e,IO,ee);i!==void 0&&this.displayState.linkedSegmentationGroup.linkByName(i);let a=le(e,MO,o=>o===!1?void 0:ee(o),i);a!==void 0&&this.displayState.linkedSegmentationColorGroup.linkByName(a),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){var i;let e=super.toJSON();e[h0]=this.displayState.selectedAlpha.toJSON(),e[m0]=this.displayState.notSelectedAlpha.toJSON(),e[y0]=this.displayState.saturation.toJSON(),e[g0]=this.displayState.objectAlpha.toJSON(),e[S0]=this.displayState.baseSegmentColoring.toJSON(),e[b0]=this.displayState.ignoreNullVisibleSet.toJSON(),e[T0]=this.displayState.silhouetteRendering.toJSON(),e[RO]=this.anchorSegment.toJSON(),e[py]=this.displayState.skeletonRenderingOptions.toJSON(),e[C0]=this.displayState.renderScaleTarget.toJSON(),e[w0]=this.sliceViewRenderScaleTarget.toJSON();let{linkedSegmentationGroup:t,linkedSegmentationColorGroup:r}=this.displayState;return e[IO]=t.toJSON(),r.root.value!==t.root.value&&(e[MO]=(i=r.toJSON())!=null?i:!1),e[dy]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),t.root.value===this&&Object.assign(e,this.displayState.segmentationGroupState.value.toJSON()),r.root.value===this&&Object.assign(e,this.displayState.segmentationColorGroupState.value.toJSON()),e}transformPickedValue(e){return e==null?e:bb(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":{this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break}case"clear-segments":{if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break}case"select":{if(!this.pick.value)break;let{segmentSelectionState:r}=this.displayState;if(r.hasSelectedSegment){let i=r.selectedSegment,{visibleSegments:a}=this.displayState.segmentationGroupState.value,o=!a.has(i);(o||t.segmentationToggleSegmentState===void 0)&&(t.segmentationToggleSegmentState=o),t.defer(()=>{t.segmentationToggleSegmentState===o&&a.set(i,o)})}break}case"copy-segment-id":{if(!this.pick.value)break;let{segmentSelectionState:r}=this.displayState;if(r.hasSelectedSegment){let i=r.selectedSegment;this.copiedSegments=[i.clone()];let a=i.toString();en(a)&&Ce.showTemporaryMessage(a+" copied to clipboard")}break}case"add-copy-segment-id":{if(!this.pick.value)break;let{segmentSelectionState:r}=this.displayState;if(r.hasSelectedSegment){let i=r.selectedSegment;this.copiedSegments.push(i.clone());let a=this.copiedSegments.map(o=>o.toString()).join(",");en(a)&&Ce.showTemporaryMessage(a+" copied to clipboard")}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);let r=new X,{value:i}=e;typeof i=="number"&&(i=i.toString()),typeof i!="string"||!r.tryParseString(i)?e.value=void 0:e.value=r}selectionStateToJson(e,t){let r=super.selectionStateToJson(e,t),{value:i}=e;return i instanceof ji?t?r.value={key:i.key.toString(),value:i.value?i.value.toString():void 0,label:i.label}:r.value=(i.value||i.key).toString():i instanceof X&&(r.value=i.toString()),r}displaySegmentationSelection(e,t,r){let{value:i}=e,a;if((typeof i=="number"||typeof i=="string")&&(a=new X,!a.tryParseString(i.toString())))return!1;if(i instanceof X)a=i.clone();else if(i instanceof ji)a=i.key.clone();else return!1;let{displayState:o}=this,l=is(o,a),{segmentEquivalences:c,segmentPropertyMap:{value:d}}=this.displayState.segmentationGroupState.value,p=c.get(a),m=Xd(this.displayState,l);if(os(o,r,r.redraw),r.registerDisposer(as(o,m)),m.classList.add("neuroglancer-selection-details-segment"),t.appendChild(m),d!==void 0){let{inlineProperties:y}=d.segmentPropertyMap;if(y!==void 0){let v=d.getSegmentInlineIndex(p);if(v!==-1){for(let b of y.properties)if(b.type!=="label"){if(b.type==="description"){let x=b.values[v];if(!x)continue;let C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-description"),C.textContent=x,t.appendChild(C)}else if(b.type==="number"||b.type==="string"){let x=b.values[v];if(b.type==="number"?isNaN(x):!x)continue;let C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-property");let k=document.createElement("div");k.classList.add("neuroglancer-selection-details-segment-property-name"),k.textContent=b.id,b.description&&(k.title=b.description);let D=document.createElement("div");D.classList.add("neuroglancer-selection-details-segment-property-value"),D.textContent=x.toString(),C.appendChild(k),C.appendChild(D),t.appendChild(C)}}}}}return!0}displaySelectionState(e,t,r){let i=this.displaySegmentationSelection(e,t,r);return super.displaySelectionState(e,t,r)&&(i=!0),i}moveToSegment(e){for(let r of this.renderLayers){if(!(r instanceof ep))continue;let i=r.getObjectPosition(e);if(i!==void 0){this.setLayerPosition(r.displayState.transform.value,i);return}}let t=!1;for(let r of this.renderLayers)if(r instanceof Zp){let i=r.multiscaleSource;i.getSegmentPosition&&(t=!0,i.getSegmentPosition(e).then(a=>{this.setLayerPosition(null,a)}).catch(a=>{Ce.showTemporaryMessage(`Failed to retrieve position for segment ${e}: ${a}`)}))}t||Ce.showTemporaryMessage(`No position information loaded for segment ${e}`)}};Tn.type="segmentation",Tn.typeAbbreviation="seg",Tn.supportsPickOption=!0;var xJ=10;function NO(n){return[{label:`Skeleton mode (${n})`,toolJson:`${py}.mode${n}`,isValid:e=>e.hasSkeletonsLayer,...ny(e=>e.displayState.skeletonRenderingOptions[`params${n}`].mode)},{label:`Line width (${n})`,toolJson:`${py}.lineWidth${n}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${n})`,title:`Skeleton line width (${n})`,...Zi(e=>({value:e.displayState.skeletonRenderingOptions[`params${n}`].lineWidth,options:{min:1,max:40,step:1}}))}]}var f0=[{label:"Color seed",title:"Color segments based on a hash of their id",toolJson:x0,...LO()},{label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:k0,...EO()},{label:"Saturation",toolJson:y0,title:"Saturation of segment colors",...Zi(n=>({value:n.displayState.saturation}))},{label:"Opacity (on)",toolJson:h0,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are selected",...Zi(n=>({value:n.displayState.selectedAlpha}))},{label:"Opacity (off)",toolJson:m0,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are not selected",...Zi(n=>({value:n.displayState.notSelectedAlpha}))},{label:"Resolution (slice)",toolJson:w0,isValid:n=>n.has2dLayer,...hu(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))},{label:"Resolution (mesh)",toolJson:C0,isValid:n=>n.has3dLayer,...hu(n=>({histogram:n.displayState.renderScaleHistogram,target:n.displayState.renderScaleTarget}))},{label:"Opacity (3d)",toolJson:g0,isValid:n=>n.has3dLayer,title:"Opacity of meshes and skeletons",...Zi(n=>({value:n.displayState.objectAlpha}))},{label:"Silhouette (3d)",toolJson:T0,isValid:n=>n.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction",...Zi(n=>({value:n.displayState.silhouetteRendering,options:{min:0,max:xJ,step:.1}}))},{label:"Hide segment ID 0",toolJson:v0,title:"Disallow selection and display of segment id 0",...bs(n=>n.displayState.hideSegmentZero)},{label:"Base segment coloring",toolJson:S0,title:"Color base segments individually",...bs(n=>n.displayState.baseSegmentColoring)},{label:"Show all by default",title:"Show all segments if none are selected",toolJson:b0,...bs(n=>n.displayState.ignoreNullVisibleSet)},...NO("2d"),...NO("3d")];for(let n of f0)ty(Tn,n);Qi(Tn);zg(dt.SEGMENTATION,Tn);gs(n=>{if(n.mesh!==void 0)return{layerConstructor:Tn,priority:1}});Cs(Tn,n=>({shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState}),p0);pO();hO();var BO="shader",UO="shaderControls",gu=class extends Ti{constructor(e){super(e);this.managedLayer=e;this.displayState=new wx;this.vertexAttributes=new Re(void 0);this.registerDisposer(this.displayState.shaderControlState.changed.add(this.specificationChanged.dispatch)),this.registerDisposer(this.displayState.fragmentMain.changed.add(this.specificationChanged.dispatch)),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new zO(this)}),this.tabs.default="rendering"}restoreState(e){super.restoreState(e),this.displayState.fragmentMain.restoreState(e[BO]),this.displayState.shaderControlState.restoreState(e[UO])}activateDataSubsources(e){let t=!1;for(let r of e){let{subsourceEntry:i}=r,{subsource:a}=i,{singleMesh:o}=a;if(o!==void 0){if(t){r.deactivate("Only one single-mesh source supported");continue}t=!0,r.activate(l=>{r.addRenderLayer(new Lx(o,this.displayState,r.getRenderLayerTransform())),this.vertexAttributes.value=o.info.vertexAttributes,l.registerDisposer(()=>{this.vertexAttributes.value=void 0})});continue}r.deactivate("Not compatible with image layer")}}toJSON(){let e=super.toJSON();return e[BO]=this.displayState.fragmentMain.toJSON(),e[UO]=this.displayState.shaderControlState.toJSON(),e}};gu.type="mesh",gu.typeAbbreviation="mesh";function FO(n){return new ko({fragmentMain:n.displayState.fragmentMain,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.shaderControlState})}var GO=class extends j{constructor(e){super();this.attributes=e;this.element=document.createElement("div");this.element.className="neuroglancer-single-mesh-attribute-widget",this.updateView(),this.registerDisposer(e.changed.add(()=>{this.updateView()}))}updateView(){let{element:e}=this,t=this.attributes.value;if(t===void 0){_e(e);return}let r=kx(t.map(a=>a.name)),i=t.length;for(let a=0;a<i;++a){let o=t[a],l=document.createElement("div");l.className="neuroglancer-single-mesh-attribute";let c=document.createElement("div");c.className="neuroglancer-single-mesh-attribute-type",c.textContent=Tx(o);let d=document.createElement("div");if(d.className="neuroglancer-single-mesh-attribute-name",d.textContent=r[a],l.appendChild(c),l.appendChild(d),o.min!==void 0&&o.max!==void 0){let p=document.createElement("neuroglancer-single-mesh-attribute-minmax");p.className="neuroglancer-single-mesh-attribute-range",p.textContent=`[${o.min.toPrecision(6)}, ${o.max.toPrecision(6)}]`,l.appendChild(p)}e.appendChild(l)}}disposed(){Xe(this.element)}};function WO(n){return new GO(n.vertexAttributes)}var zO=class extends sn{constructor(e){super();this.layer=e;this.attributeWidget=this.registerDisposer(WO(this.layer));this.codeWidget=this.registerDisposer(FO(this.layer));let{element:t}=this;t.classList.add("neuroglancer-single-mesh-dropdown");let r=document.createElement("div");r.className="neuroglancer-single-mesh-dropdown-top-row";let i=document.createElement("div");i.style.flex="1",r.appendChild(i),r.appendChild(xs({title:"Show larger editor view",onClick:()=>{new HO(this.layer)}})),r.appendChild(Ss({title:"Documentation on single mesh layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(r),t.appendChild(this.attributeWidget.element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new Lo(e.displayState.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}},HO=class extends Xi{constructor(e){super();this.layer=e;this.attributeWidget=this.registerDisposer(WO(this.layer));this.codeWidget=this.registerDisposer(FO(this.layer));this.content.classList.add("neuroglancer-single-mesh-layer-shader-overlay"),this.content.appendChild(this.attributeWidget.element),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};Qi(gu);gs(n=>{if(n.singleMesh!==void 0)return{layerConstructor:gu,priority:2}});Cs(gu,n=>({shaderControlState:n.displayState.shaderControlState}));var $O=at(It());var E0=class extends j{constructor(e){super();this.ref=e;this.element=document.createElement("label");this.selectElement=document.createElement("select");this.registerDisposer(e);let{element:t,selectElement:r}=this;t.appendChild(r),this.updateView(),this.registerEventListener(r,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add((0,$O.default)(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){let{selectElement:e,ref:t}=this,{filter:r}=t;_e(e);let i=document.createElement("option");e.appendChild(i);for(let a of this.ref.layerManager.managedLayers)if(r(a)){let o=document.createElement("option"),{name:l}=a;o.textContent=l,o.value=l,e.appendChild(o)}e.value=t.layerName||""}};var CJ="points",P0="annotations",jO="annotationProperties",qO="annotationRelationships",JO="crossSectionAnnotationSpacing",KO="projectionAnnotationSpacing",YO="shader",XO="shaderControls";function wJ(n,e){e!==void 0&&ye(e,(t,r)=>{n.add({type:be.POINT,id:""+r,point:yE(t),properties:[]})})}function TJ(n){let e=n.layer;return e===null||e instanceof Tn}function kJ(n){if(n===void 0)return null;let e=n.layer;return e===null||!(e instanceof Tn)?null:e.displayState}var QO="linkedSegmentationLayer",ZO="filterBySegmentation",eN="ignoreNullSegmentFilter",tN=class extends j{constructor(e,t,r){super();this.layerManager=e;this.annotationStates=t;this.annotationDisplayState=r;this.changed=new ae;this.curGeneration=-1;this.wasLoading=void 0;this.map=new Map;this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){let e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;let{map:r}=this,i=!1;for(let a of this.annotationStates.relationships){let o=r.get(a);o===void 0&&(o=this.addRelationship(a),i=!0),o.seenGeneration=e}if(!t)for(let[a,o]of r)o.seenGeneration!==e&&(r.delete(a),i=!0);i&&this.changed.dispatch()}addRelationship(e){let t=this.annotationDisplayState.relationshipStates.get(e),r=new vw(this.layerManager.addRef(),TJ);r.registerDisposer(r.changed.add(()=>{t.segmentationState.value=r.layerName===void 0?void 0:kJ(r.layer)}));let{showMatches:i}=t,a={layerRef:r,showMatches:i,seenGeneration:-1};return r.changed.add(this.changed.dispatch),i.changed.add(this.changed.dispatch),this.map.set(e,a),a}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(let e of this.map.values())e.showMatches.reset()}toJSON(){let{map:e}=this;if(e.size===0)return{};let t,r=[];for(let[i,a]of e){a.showMatches.value&&r.push(i);let{layerName:o}=a.layerRef;o!==void 0&&((t=t||{})[i]=o)}return r.sort(),{[QO]:t,[ZO]:r.length===0?void 0:r}}restoreState(e){let{isLoading:t}=this.annotationStates;le(e,QO,r=>{typeof r=="string"&&(r={segments:r}),Q(r);for(let i of Object.keys(r)){let a=ee(r[i]),o=this.map.get(i);if(o===void 0){if(!t)continue;o=this.addRelationship(i)}o.layerRef.layerName=a}for(let[i,a]of this.map)Object.prototype.hasOwnProperty.call(r,i)||(a.layerRef.layerName=void 0)}),le(e,ZO,r=>{typeof r=="boolean"&&(r=r===!0?["segments"]:[]);for(let i of jt(r)){let a=this.map.get(i);if(a===void 0){if(!t)continue;a=this.addRelationship(i)}a.showMatches.value=!0}})}disposed(){let{map:e}=this;for(let t of e.values())this.unbind(t);e.clear(),super.disposed()}},nN=class extends j{constructor(e,t){super();this.relationship=e;this.state=t;this.element=document.createElement("label");this.seenGeneration=-1;let{element:r}=this,i=this.registerDisposer(new br(t.showMatches)),a=new E0(t.layerRef);r.appendChild(i.element),r.appendChild(document.createTextNode(e)),r.appendChild(a.element)}},rN=class extends j{constructor(e){super();this.linkedSegmentationLayers=e;this.widgets=new Map;this.element=document.createElement("div");this.element.style.display="contents";let t=this.registerCancellable(Ge(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){let{linkedSegmentationLayers:e}=this,{annotationStates:t}=e,r=t.changed.count,{widgets:i}=this;function*a(){for(let o of t.relationships){let l=i.get(o);l===void 0&&(l=new nN(o,e.get(o))),l.seenGeneration=r,yield l.element}}for(let[o,l]of i)l.seenGeneration!==r&&(l.dispose(),i.delete(o));qn(this.element,a.call(this))}disposed(){super.disposed();for(let e of this.widgets.values())e.dispose()}},LJ=pu(Ti),ks=class extends LJ{constructor(e){super(e);this.annotationProperties=new Re(void 0);this.localAnnotationsJson=void 0;this.pointAnnotationsJson=void 0;this.linkedSegmentationLayers=this.registerDisposer(new tN(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState));this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new oN(this)}),this.tabs.default="annotations",this.allowingRefresh=!0}disposed(){let{localAnnotations:e}=this;e!==void 0&&e.dispose(),super.disposed()}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[P0],this.localAnnotationProperties=le(e,jO,lh),this.localAnnotationRelationships=le(e,qO,jt,["segments"]),this.pointAnnotationsJson=e[CJ],this.annotationCrossSectionRenderScaleTarget.restoreState(e[JO]),this.annotationProjectionRenderScaleTarget.restoreState(e[KO]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[eN]),this.annotationDisplayState.shader.restoreState(e[YO]),this.annotationDisplayState.shaderControls.restoreState(e[XO])}getLegacyDataSourceSpecifications(e,t,r,i){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,r,i);let a=le(t,"voxelSize",l=>He(new Float64Array(3),l,c=>St(c)/1e9)),o=["m","m","m"];if(a!==void 0){let l=Ne({rank:3,units:o,scales:a,names:["x","y","z"]});r===void 0?r={outputSpace:l,sourceRank:3,transform:void 0,inputSpace:l}:r={...r,inputSpace:l}}return[{url:QS,transform:r,enableDefaultSubsources:!0,subsources:new Map}]}activateDataSubsources(e){var a;let t=!1,r;for(let o of e){let{subsourceEntry:l}=o,{local:c}=l.subsource,d=m=>r!==void 0&&Hn(m)!==Hn(r)?(o.deactivate("Annotation properties are not compatible"),!1):(r=m,!0);if(c===fi.annotations){if(t){o.deactivate("Only one local annotations source per layer is supported");continue}if(t=!0,!d((a=this.localAnnotationProperties)!=null?a:[]))continue;o.activate(m=>{var b;let y=this.localAnnotations=new Jv(o.loadedDataSource.transform,(b=this.localAnnotationProperties)!=null?b:[],this.localAnnotationRelationships);try{y.restoreState(this.localAnnotationsJson)}catch{}m.registerDisposer(()=>{y.dispose(),this.localAnnotations=void 0}),m.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{wJ(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;let v=new lu({localPosition:this.localPosition,transform:m.registerDisposer(Ah(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,o.loadedDataSource.transform,void 0)),source:y.addRef(),displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:or.ANNOTATION});this.addAnnotationLayerState(v,o)});continue}let{annotation:p}=l.subsource;if(p!==void 0){if(!d(p.properties))continue;o.activate(()=>{let m=new lu({localPosition:this.localPosition,transform:o.getRenderLayerTransform(),source:p,displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:or.ANNOTATION});this.addAnnotationLayerState(m,o)});continue}o.deactivate("Not compatible with annotation layer")}let i=this.annotationProperties.value;Hn(i)!==Hn(r)&&(this.annotationProperties.value=r)}initializeAnnotationLayerViewTab(e){let t=e.registerDisposer(Pn(i=>i.some(a=>a.source instanceof vn),this.annotationStates)),r=e.registerDisposer(new Kn(t,(i,a,o)=>{if(!!i){{let l=o.registerDisposer(new Yp(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));l.label.textContent="Spacing (cross section)",a.appendChild(l.element)}{let l=o.registerDisposer(new Yp(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));l.label.textContent="Spacing (projection)",a.appendChild(l.element)}}}));e.element.insertBefore(r.element,e.element.firstChild);{let i=e.registerDisposer(new br(this.annotationDisplayState.ignoreNullSegmentFilter)),a=document.createElement("label");a.appendChild(document.createTextNode("Ignore null related segment filter")),a.title="Display all annotations if filtering by related segments is enabled but no segments are selected",a.appendChild(i.element),e.element.appendChild(a)}e.element.appendChild(e.registerDisposer(new rN(this.linkedSegmentationLayers)).element)}toJSON(){let e=super.toJSON();e[JO]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[KO]=this.annotationProjectionRenderScaleTarget.toJSON(),this.localAnnotations!==void 0?e[P0]=this.localAnnotations.toJSON():this.localAnnotationsJson!==void 0&&(e[P0]=this.localAnnotationsJson),e[jO]=AE(this.localAnnotationProperties);let{localAnnotationRelationships:t}=this;return e[qO]=t&&t.length===1&&t[0]==="segments"?void 0:t,e[eN]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[YO]=this.annotationDisplayState.shader.toJSON(),e[XO]=this.annotationDisplayState.shaderControls.toJSON(),Object.assign(e,this.linkedSegmentationLayers.toJSON()),e}};ks.type="annotation",ks.typeAbbreviation="ann";function iN(n){return new ko({shaderError:n.annotationDisplayState.shaderError,fragmentMain:n.annotationDisplayState.shader,shaderControlState:n.annotationDisplayState.shaderControls})}var aN=class extends Xi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(iN(this.layer));this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}},oN=class extends sn{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(iN(this.layer));let{element:t}=this;t.classList.add("neuroglancer-annotation-rendering-tab"),t.appendChild(this.registerDisposer(new Kn(e.annotationProperties,(a,o)=>{if(a===void 0||a.length===0)return;let l=document.createElement("div");o.appendChild(l),l.classList.add("neuroglancer-annotation-shader-property-list");for(let c of a){let d=document.createElement("div");d.classList.add("neuroglancer-annotation-shader-property");let p=document.createElement("span");p.classList.add("neuroglancer-annotation-shader-property-type"),p.textContent=c.type;let m=document.createElement("span");m.classList.add("neuroglancer-annotation-shader-property-identifier"),m.textContent=`prop_${c.identifier}`,d.appendChild(p),d.appendChild(m);let{description:y}=c;y!==void 0&&(d.title=y),l.appendChild(d)}})).element);let r=document.createElement("div");r.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let i=document.createElement("div");i.style.flex="1",i.textContent="Annotation shader:",r.appendChild(i),r.appendChild(xs({title:"Show larger editor view",onClick:()=>{new aN(this.layer)}})),r.appendChild(Ss({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/annotation/rendering.md"})),t.appendChild(r),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new Lo(e.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}};Qi(ks);Qi(ks,"pointAnnotation");gs(n=>{if(n.local===fi.annotations)return{layerConstructor:ks,priority:100};if(n.annotation!==void 0)return{layerConstructor:ks,priority:1}});Cs(ks,n=>({shaderControlState:n.annotationDisplayState.shaderControls}));function sN(n){n.registerEventListener(document,"copy",e=>{if(Jd(e.target))return;let t=document.getSelection();if(t!==null&&t.type==="Range")return;let r=hl(n.state).value,{clipboardData:i}=e;i!==null&&i.setData("text/plain",JSON.stringify(r,void 0,"  ")),e.preventDefault()})}function EJ(n,e){let t=String.raw`^[\[\]{}()\s,]*`;for(let a=0;a<e;++a)a!==0&&(t+=String.raw`[,\s]+`),t+=String.raw`(\d+(?:\.\d+)?)`;t+=String.raw`[\[\]{}()\s,]*$`;let r=n.match(t);if(r===null)return;let i=new Float32Array(e);for(let a=0;a<e;++a){let o=Number(r[a+1]);if(!Number.isFinite(o))return;i[a]=o}return i}function lN(n){n.registerEventListener(document,"paste",e=>{if(Jd(e.target))return;let{clipboardData:t}=e;if(t!==null){let r=t.getData("text/plain"),i=EJ(r,n.coordinateSpace.value.rank);i!==void 0&&(n.navigationState.position.value=i)}e.preventDefault()})}function cN(){return En(document,"contextmenu",n=>{n.preventDefault()})}function uN(){return En(document,"wheel",n=>{n.ctrlKey&&n.preventDefault()},{passive:!1})}var dN=Symbol("SingleTextureVolumeChunk.textureUnit"),fy=Symbol("SingleTextureVolumeChunk.textureLayout"),ef=class extends j{constructor(e,t){super();this.shaderKey=e;this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",dN)}beginDrawing(e,t){let r=t.textureUnit(dN);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),t[fy]=null}endDrawing(e,t){e.bindTexture(Nh[this.shaderSamplerType],null),t[fy]=null}bindChunk(e,t,r,i,a,o,l){let c=r.textureLayout;(t[fy]!==c||l)&&(t[fy]=c,this.setupTextureLayout(e,t,c,i,a,o)),e.bindTexture(Nh[this.shaderSamplerType],r.texture)}beginSource(e,t){}},tf=class extends _b{constructor(e,t){super(e,t);this.texture=null;this.data=t.data}copyToGPU(e){super.copyToGPU(e);let t=this.texture=e.createTexture(),r=Nh[this.chunkFormat.shaderSamplerType];e.bindTexture(r,t),this.setTextureData(e),e.bindTexture(r,null)}freeGPUMemory(e){super.freeGPUMemory(e),e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null}};var hy=class extends j{constructor(e,t,r){super();this.chunkDataSize=t;this.textureDims=r;this.textureShape=new Uint32Array(this.textureDims);let i=t.length,a=0;for(let m of t)m!==1&&++a;let o=this.strides=new Uint32Array(i*r),l=r===3?e.max3dTextureSize:e.maxTextureSize,c=0,d=1,{textureShape:p}=this;p.fill(1);for(let m=0;m<i;++m){let y=t[m];if(y===1)continue;let v=y*d,b;v>l||d!==1&&c+a<r?(++c,d=y,b=1):(b=d,d=v),o[r*m+c]=b,p[c]=d}}static get(e,t,r){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${r}`,()=>new hy(e,t,r))}},D0=new Uint32Array(3*5),my=class extends ef{constructor(e,t,r,i){super(r,t);this.textureDims=i;gi(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${i}D`,this.textureAccessHelper=new nb("chunkData",i)}static get(e,t,r){let i=`sliceview.UncompressedChunkFormat:${t}:${r}`;return e.memoize.get(i,()=>new my(e,t,i,r))}defineShader(e,t){super.defineShader(e,t);let{textureDims:r}=this,i=`ivec${this.textureDims}`,{textureAccessHelper:a}=this,o=(4+t)*r;D0.length<o&&(D0=new Uint32Array(o)),e.addUniform(`highp ${i}`,"uVolumeChunkStrides",4+t),e.addFragmentCode(a.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType));let c=`
${Vt(this.dataType)} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)c+=`, highp int channelIndex${d}`;c+=`) {
  highp ${i} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)c+=`
  offset += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;c+=`
  return readVolumeData(offset);
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,a,o){let l=D0,c=o.length,{strides:d}=r,p=i.length,{textureDims:m}=this;for(let v=0;v<m;++v){let b=0;for(let x=0;x<p;++x)b+=i[x]*d[x*m+v];l[v]=b}for(let v=0;v<3;++v){let b=a[v];if(!(b>=p))for(let x=0;x<m;++x)l[(v+1)*m+x]=d[b*m+x]}for(let v=0;v<c;++v){let b=o[v];if(b===-1)l.fill(0,(4+v)*m,(4+v+1)*m);else for(let x=0;x<m;++x)l[(4+v)*m+x]=d[b*m+x]}let y=(4+c)*m;m===3?e.uniform3iv(t.uniform("uVolumeChunkStrides"),l,0,y):e.uniform2iv(t.uniform("uVolumeChunkStrides"),l,0,y)}getTextureLayout(e,t){return hy.get(e,t,this.textureDims)}setTextureData(e,t,r){let{textureShape:i}=t;(this.textureDims===3?d1:u1)(e,this,r,i[0],i[1],i[2])}},pN=class extends tf{setTextureData(e){let{source:t}=this,{chunkFormatHandler:r}=t,{chunkFormat:i}=r,a;this.chunkDataSize===t.spec.chunkDataSize?this.textureLayout=a=r.textureLayout.addRef():this.textureLayout=a=i.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,a,this.data)}getValueAt(e){let{chunkFormat:t}=this,{chunkDataSize:r}=this,i=0,a=1,o=e.length;for(let d=0;d<o;++d)i+=a*e[d],a*=r[d];let l=t.dataType,c=this.data;switch(l){case H.UINT8:case H.INT8:case H.FLOAT32:case H.UINT16:case H.INT16:case H.UINT32:case H.INT32:return c[i];case H.UINT64:{let d=i*2;return new X(c[d],c[d+1])}}}},fN=class extends j{constructor(e,t){super();let r=0;for(let i of t.chunkDataSize)i>1&&++r;this.chunkFormat=this.registerDisposer(my.get(e,t.dataType,r>=3?3:2)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize))}getChunk(e,t){return new pN(e,t)}};km((n,e)=>e.compressedSegmentationBlockSize==null?new fN(n,e):null);function gy(n,e,t,r,i,a){let o=0,l=0,c=1,d=1;for(let x=0;x<3;++x){let C=i[x],k=r[x],D=Math.floor(C/k),P=C%k;o+=D*c,c*=Math.ceil(t[x]/k),l+=P*d,d*=k}let p=e+o*2,m=n[p],y=n[p+1],v=m&16777215,b=m>>24&255;if(b>0){let C=(e+y&16777215)+Math.floor(l*b/32),k=n[C],D=l*b%32,P=k>>D&(1<<b)-1;v+=a*P}return v}function hN(n,e,t,r,i){let a=gy(n,e,t,r,i,1)+e;return n[a]}function mN(n,e,t,r,i,a){let o=gy(e,t,r,i,a,2)+t;return n.low=e[o],n.high=e[o+1],n}var yy=class extends j{constructor(e,t){super();this.chunkDataSize=e;this.subchunkSize=t;let r=this.subchunkGridSize=J.create();for(let i=0;i<3;++i)r[i]=Math.ceil(e[i]/t[i])}static get(e,t,r){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${Fo(t)},${Fo(r)}`,()=>new yy(t,r))}},PJ=gi(new $i,H.UINT32),A0=new Uint32Array(4*4),vy=class extends ef{constructor(e,t,r,i){super(i,e);this.subchunkSize=t;this.numChannels=r;this.textureAccessHelper=new mo("chunkData")}static get(e,t,r,i){let a=`sliceview.CompressedSegmentationChunkFormat:${t}:${i}`,o=`${a}:${Fo(r)}`;return e.memoize.get(o,()=>new vy(t,r,i,a))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);let r=4*(4+t);A0.length<r&&(A0=new Uint32Array(r));let{textureAccessHelper:i}=this;i.defineShader(e);let a=d=>"compressedSegmentationChunkFormat_"+d;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(QP);let{dataType:o}=this,l=Vt(o);o===H.UINT64?e.addFragmentCode(Dt):e.addFragmentCode(Ys),e.addFragmentCode(i.getAccessor(a("readTextureValue"),"uVolumeChunkSampler",H.UINT32,1));let c=`
uint ${a("getChannelOffset")}(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return ${a("readTextureValue")}(uint(channelIndex)).value;
}
${l} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)c+=`, highp int channelIndex${d}`;c+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)c+=`
  chunkPositionFull += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;c+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(${a("getChannelOffset")}(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = ${a("readTextureValue")}(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = ${a("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = ${a("readTextureValue")}(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===H.UINT64?"2u":"1u"};
  }
  ${l} result;
`,o===H.UINT64?c+=`
  result.value[0] = ${a("readTextureValue")}(outputValueOffset).value;
  result.value[1] = ${a("readTextureValue")}(outputValueOffset+1u).value;
`:c+=`
  result.value = ${a("readTextureValue")}(outputValueOffset).value;
`,c+=`
  return result;
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,a,o){let{subchunkGridSize:l}=r;e.uniform3i(t.uniform("uSubchunkGridSize"),l[0],l[1],l[2]);let c=A0,d=o.length;c.fill(0);for(let p=0;p<3;++p){c[p]=i[p];let m=a[p];m!==-1&&(c[4*(p+1)+m]=1)}for(let p=0;p<d;++p){let m=o[p];m!==-1&&(c[4*(4+p)+m]=1)}e.uniform4iv(t.uniform("uVolumeChunkStrides"),c,0,(d+4)*4)}setTextureData(e,t,r){ns(e,PJ,r)}getTextureLayout(e,t){return yy.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);let{subchunkSize:r}=this;e.uniform3i(t.uniform("uSubchunkSize"),r[0],r[1],r[2])}},gN=class extends tf{setTextureData(e){let{data:t}=this,{chunkFormat:r}=this,i=this.textureLayout=r.getTextureLayout(e,this.chunkDataSize);r.setTextureData(e,i,t)}getValueAt(e){let{chunkDataSize:t,chunkFormat:r}=this,{data:i}=this,a=i[e[3]||0];if(r.dataType===H.UINT64){let o=new X;return mN(o,i,a,t,r.subchunkSize,e),o}else return hN(i,a,t,r.subchunkSize,e)}},yN=class extends j{constructor(e,t){super();let{dataType:r}=t;if(r!==H.UINT64&&r!==H.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${H[r]}`);this.chunkFormat=this.registerDisposer(vy.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1))}getChunk(e,t){return new gN(e,t)}};km((n,e)=>e.compressedSegmentationBlockSize!=null?new yN(n,e):null);function vN(n,e=document.getElementById("neuroglancer-container")){try{let t=new Xv(e);return new uw(t,n)}catch(t){throw Ce.showMessage(`Error: ${t.message}`),t}}function SN(n){return cN(),uN(),vN(n)}function bN(n){let e=Ge(()=>{var i;let r=(i=n.value)==null?void 0:i.trim();r?document.title=`${r} - neuroglancer`:document.title="neuroglancer"}),t=n.changed.add(e);return e(),e.flush(),()=>{t(),e.cancel()}}function xN(){let n=window.viewer=SN();b1(n.inputEventBindings);let e=n.registerDisposer(new cw(n.state,n.dataSourceProvider.credentialsManager,{defaultFragment:typeof NEUROGLANCER_DEFAULT_STATE_FRAGMENT!="undefined"?NEUROGLANCER_DEFAULT_STATE_FRAGMENT:void 0}));return n.registerDisposer(e.parseError.changed.add(()=>{let{value:t}=e.parseError;t!==void 0&&(new Ce().setErrorMessage(`Error parsing state: ${t.message}`),console.log("Error parsing state",t)),e.parseError})),e.updateFromUrlHash(),n.registerDisposer(bN(n.title)),sN(n),lN(n),n}window.addEventListener("DOMContentLoaded",()=>{xN()});})();
/**
 * /**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2021 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017-2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2018 The Neuroglancer Authors
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 The Neuroglancer Authors
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
//# sourceMappingURL=main.bundle.js.map
